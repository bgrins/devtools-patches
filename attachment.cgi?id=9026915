# HG changeset patch
# User Victor Porof <vporof@mozilla.com>
# Date 1542880699 -3600
#      Thu Nov 22 10:58:19 2018 +0100
# Node ID 24f8e59023088ff518d2f5fe56f9a4aae6f06c53
# Parent  ad8114bf526cfa7c4e878bc6cb48dc582dc3363d
Bug 1503824 - Migrate the treecols binding into a custom element, r=bgrins

diff --git a/toolkit/content/widgets/tree.js b/toolkit/content/widgets/tree.js
--- a/toolkit/content/widgets/tree.js
+++ b/toolkit/content/widgets/tree.js
@@ -411,4 +411,30 @@
 
   customElements.define("treecol", MozTreecol);
 
+  class MozTreecols extends MozElements.BaseControl {
+    connectedCallback() {
+      if (this.delayConnectedCallback()) {
+        return;
+      }
+
+      if (!this.querySelector("treecolpicker")) {
+        this.appendChild(MozXULElement.parseXULToFragment(`
+          <treecolpicker class="treecol-image" fixed="true"></treecolpicker>
+        `));
+      }
+
+      let treecolpicker = this.querySelector("treecolpicker");
+      this.inheritAttribute(treecolpicker, "tooltiptext=pickertooltiptext");
+
+      // Set resizeafter="farthest" on the splitters if nothing else has been
+      // specified.
+      Array.forEach(this.getElementsByTagName("splitter"), function(splitter) {
+        if (!splitter.hasAttribute("resizeafter"))
+          splitter.setAttribute("resizeafter", "farthest");
+      });
+    }
+  }
+
+  customElements.define("treecols", MozTreecols);
+
 }
diff --git a/toolkit/content/widgets/tree.xml b/toolkit/content/widgets/tree.xml
--- a/toolkit/content/widgets/tree.xml
+++ b/toolkit/content/widgets/tree.xml
@@ -907,25 +907,6 @@
     </handlers>
   </binding>
 
-  <binding id="treecols">
-    <content orient="horizontal">
-      <xul:hbox class="tree-scrollable-columns" flex="1">
-        <children includes="treecol|splitter"/>
-      </xul:hbox>
-      <xul:treecolpicker class="treecol-image" fixed="true" xbl:inherits="tooltiptext=pickertooltiptext"/>
-    </content>
-    <implementation>
-      <constructor><![CDATA[
-        // Set resizeafter="farthest" on the splitters if nothing else has been
-        // specified.
-        Array.forEach(this.getElementsByTagName("splitter"), function(splitter) {
-          if (!splitter.hasAttribute("resizeafter"))
-            splitter.setAttribute("resizeafter", "farthest");
-        });
-      ]]></constructor>
-    </implementation>
-  </binding>
-
   <binding id="treerows" extends="chrome://global/content/bindings/general.xml#basecontrol">
     <content>
       <xul:hbox flex="1" class="tree-bodybox">
@@ -1031,6 +1012,7 @@
             var menuitem = document.getAnonymousElementByAttribute(this, "anonid", "menuitem");
             if (event.originalTarget == menuitem) {
               tree.columns.restoreNaturalOrder();
+              this.removeAttribute("ordinal");
               tree._ensureColumnOrder();
             } else {
               var colindex = event.originalTarget.getAttribute("colindex");
diff --git a/toolkit/content/xul.css b/toolkit/content/xul.css
--- a/toolkit/content/xul.css
+++ b/toolkit/content/xul.css
@@ -438,11 +438,7 @@ tree {
   -moz-binding: url("chrome://global/content/bindings/tree.xml#tree");
 }
 
-treecols {
-  -moz-binding: url("chrome://global/content/bindings/tree.xml#treecols");
-}
-
-treecol {
+treecolpicker {
   -moz-box-ordinal-group: 2147483646;
 }
 
@@ -481,11 +477,6 @@ treecol[hidden="true"] {
   display: -moz-box;
 }
 
-.tree-scrollable-columns {
-  /* Yes, Virginia, this makes it scrollable */
-  overflow: hidden;
-}
-
 /* ::::: lines connecting cells ::::: */
 tree:not([treelines="true"]) > treechildren::-moz-tree-line {
   visibility: hidden;
