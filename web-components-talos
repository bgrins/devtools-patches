# HG changeset patch
# User Brian Grinstead <bgrinstead@mozilla.com>
# Parent  79e136decfe30a5b9ad7aecf3f3d55d743f02964
Bug 1387125 - Create a talos test to measure Custom Element and XBL performance

diff --git a/testing/talos/talos.json b/testing/talos/talos.json
--- a/testing/talos/talos.json
+++ b/testing/talos/talos.json
@@ -10,21 +10,21 @@
         "dromaeojs-e10s": {
             "tests": ["dromaeo_css", "kraken"]
         },
         "dromaeojs-stylo-disabled-e10s": {
             "talos_options": ["--disable-stylo"],
             "tests": ["dromaeo_css", "kraken"]
         },
         "other-e10s": {
-            "tests": ["a11yr", "ts_paint", "tpaint", "sessionrestore", "sessionrestore_many_windows", "sessionrestore_no_auto_restore", "tabpaint", "cpstartup"]
+            "tests": ["a11yr", "ts_paint", "tpaint", "sessionrestore", "sessionrestore_many_windows", "sessionrestore_no_auto_restore", "tabpaint", "cpstartup", "webcomponents"]
         },
         "other-stylo-disabled-e10s": {
             "talos_options": ["--disable-stylo"],
-            "tests": ["a11yr", "ts_paint", "tpaint", "sessionrestore", "sessionrestore_many_windows", "sessionrestore_no_auto_restore", "tabpaint", "cpstartup"]
+            "tests": ["a11yr", "ts_paint", "tpaint", "sessionrestore", "sessionrestore_many_windows", "sessionrestore_no_auto_restore", "tabpaint", "cpstartup", "webcomponents"]
         },
         "g1-e10s": {
             "tests": ["tp5o_scroll", "glterrain"],
             "pagesets_name": "tp5n.zip"
         },
         "g1-stylo-disabled-e10s": {
             "tests": ["tp5o_scroll", "glterrain"],
             "talos_options": ["--disable-stylo"],
diff --git a/testing/talos/talos/test.py b/testing/talos/talos/test.py
--- a/testing/talos/talos/test.py
+++ b/testing/talos/talos/test.py
@@ -311,16 +311,34 @@ class cpstartup(PageloaderTest):
         # See http://kb.mozillazine.org/Browser.link.open_newwindow
         # and http://kb.mozillazine.org/Browser.link.open_newwindow.restriction
         'browser.link.open_newwindow': 3,
         'browser.link.open_newwindow.restriction': 2,
     }
 
 
 @register_test()
+class webcomponents(PageloaderTest):
+    """
+
+    """
+    extensions = '${talos}/tests/webcomponents'
+    tpmanifest = '${talos}/tests/webcomponents/webcomponents.manifest'
+    tppagecycles = 20
+    gecko_profile_entries = 1000000
+    tploadnocache = True
+    unit = 'ms'
+    preferences = {
+        'dom.webcomponents.customelements.enabled': True,
+        'browser.link.open_newwindow': 3,
+        'browser.link.open_newwindow.restriction': 2,
+    }
+
+
+@register_test()
 class tabpaint(PageloaderTest):
     """
     Tests the amount of time it takes to open new tabs, triggered from
     both the parent process and the content process.
     """
     extensions = '${talos}/tests/tabpaint'
     tpmanifest = '${talos}/tests/tabpaint/tabpaint.manifest'
     tppagecycles = 20
diff --git a/testing/talos/talos/tests/webcomponents/bootstrap.js b/testing/talos/talos/tests/webcomponents/bootstrap.js
new file mode 100644
diff --git a/testing/talos/talos/tests/webcomponents/chrome.manifest b/testing/talos/talos/tests/webcomponents/chrome.manifest
new file mode 100644
--- /dev/null
+++ b/testing/talos/talos/tests/webcomponents/chrome.manifest
@@ -0,0 +1,1 @@
+content cpstartup content/
\ No newline at end of file
diff --git a/testing/talos/talos/tests/webcomponents/content/cpstartup.html b/testing/talos/talos/tests/webcomponents/content/cpstartup.html
new file mode 100644
--- /dev/null
+++ b/testing/talos/talos/tests/webcomponents/content/cpstartup.html
@@ -0,0 +1,31 @@
+<html>
+  <head>
+    <script>
+      const { classes: Cc, interfaces: Ci, utils: Cu } = Components;
+
+      function init() {
+        if (document.location.hash.indexOf("#auto") == 0) {
+          let mm = window.QueryInterface(Ci.nsIInterfaceRequestor)
+                         .getInterface(Ci.nsIWebNavigation)
+                         .QueryInterface(Ci.nsIInterfaceRequestor)
+                         .getInterface(Ci.nsIContentFrameMessageManager);
+
+          mm.addMessageListener("CPStartup:FinalResults", function onResults(msg) {
+            mm.removeMessageListener("CPStartup:FinalResults", onResults);
+            let results = msg.data;
+
+            tpRecordTime(results, 0, "content-process-startup");
+          });
+
+          mm.sendAsyncMessage("CPStartup:Go");
+        }
+      }
+
+    </script>
+  </head>
+  <body onload="init();">
+    Hello, Talos!
+
+    <a href="#" id="target" target="_blank">I'll open a new tab</a>
+  </body>
+</html>
diff --git a/testing/talos/talos/tests/webcomponents/content/target.html b/testing/talos/talos/tests/webcomponents/content/target.html
new file mode 100644
--- /dev/null
+++ b/testing/talos/talos/tests/webcomponents/content/target.html
@@ -0,0 +1,9 @@
+<html>
+<head>
+<title>Content Process Startup</title>
+<meta http-equiv="Content-Type" content="text/html;charset=utf-8"></meta>
+</head>
+<body>
+<p>Content Process Startup</p>
+</body>
+</html>
diff --git a/testing/talos/talos/tests/webcomponents/content/util.js b/testing/talos/talos/tests/webcomponents/content/util.js
new file mode 100644
--- /dev/null
+++ b/testing/talos/talos/tests/webcomponents/content/util.js
@@ -0,0 +1,50 @@
+var perf_data = {
+  start: null,
+  end: null,
+}
+
+const NUM_ELEMENTS = 1000;
+const NUM_ITERATIONS = 5;
+
+function perf_start() {
+  if (perf_data.start !== null) {
+    throw "already started timing!";
+  }
+
+  perf_data.start = performance.now();
+}
+
+function perf_finish() {
+  var end = performance.now();
+
+  if (perf_data.start === null) {
+    throw "haven't started timing!";
+  }
+
+  if (perf_data.end !== null) {
+    throw "already finished timing!";
+  }
+
+  var start = perf_data.start;
+  perf_data.end = end;
+
+  // when running in talos report results; when running outside talos just alert
+  if (window.tpRecordTime) {
+    // Running in talos.
+    window.tpRecordTime(end - start, start);
+  } else if (window.parent && window.parent.report_perf_reftest_time) {
+    // Running in the perf-reftest runner.
+    window.parent.report_perf_reftest_time({ type: "time", value: end - start });
+  } else {
+    // Running standalone; just alert.
+    console.log(end);
+    console.log(start);
+    console.log("Result: " + (end - start).toFixed(2) + " (ms)");
+  }
+}
+
+if (window.parent.report_perf_reftest_time) {
+  window.addEventListener("error", function(e) {
+    window.parent.report_perf_reftest_time({ type: "error", value: e.message });
+  });
+}
diff --git a/testing/talos/talos/tests/webcomponents/content/xbl-bindings.xml b/testing/talos/talos/tests/webcomponents/content/xbl-bindings.xml
new file mode 100644
--- /dev/null
+++ b/testing/talos/talos/tests/webcomponents/content/xbl-bindings.xml
@@ -0,0 +1,14 @@
+<?xml version="1.0"?>
+<!-- This Source Code Form is subject to the terms of the Mozilla Public
+   - License, v. 2.0. If a copy of the MPL was not distributed with this
+   - file, You can obtain one at http://mozilla.org/MPL/2.0/. -->
+<bindings xmlns="http://www.mozilla.org/xbl"
+          xmlns:html="http://www.w3.org/1999/xhtml"
+          xmlns:xul="http://www.mozilla.org/keymaster/gatekeeper/there.is.only.xul"
+          xmlns:xbl="http://www.mozilla.org/xbl">
+    <binding id="test">
+      <content>
+        <label>fOo</label>
+      </content>
+    </binding>
+</bindings>
diff --git a/testing/talos/talos/tests/webcomponents/content/xbl-creation.xul b/testing/talos/talos/tests/webcomponents/content/xbl-creation.xul
new file mode 100644
--- /dev/null
+++ b/testing/talos/talos/tests/webcomponents/content/xbl-creation.xul
@@ -0,0 +1,29 @@
+<?xml version="1.0"?>
+<window xmlns="http://www.mozilla.org/keymaster/gatekeeper/there.is.only.xul"
+        onload="run()">
+  <style xmlns="http://www.w3.org/1999/xhtml">
+  foo {
+    -moz-binding: url("xbl-bindings.xml#test");
+  }
+  </style>
+  <script type="application/javascript" src="util.js"/>
+  <script type="application/javascript"><![CDATA[
+  console.log("HI");
+  function run() {
+    console.log("HUH");
+    let container = document.getElementById("element-container");
+    perf_start();
+
+    for (var i = 0; i < NUM_ITERATIONS; i++) {
+      for (var j = 0; j < NUM_ELEMENTS; j++) {
+        var element = document.createElement("foo");
+        container.appendChild(element);
+        container.innerHTML = '';
+      }
+    }
+
+    perf_finish();
+  }
+  ]]></script>
+  <box id="element-container"></box>
+</window>
diff --git a/testing/talos/talos/tests/webcomponents/customelement-creation.html b/testing/talos/talos/tests/webcomponents/customelement-creation.html
new file mode 100644
--- /dev/null
+++ b/testing/talos/talos/tests/webcomponents/customelement-creation.html
@@ -0,0 +1,43 @@
+<!DOCTYPE html>
+<html>
+  <head>
+    <script src="content/util.js"></script>
+    <script>
+      // https://html.spec.whatwg.org/multipage/scripting.html#custom-elements-autonomous-example
+      class TestCustomElement extends HTMLElement {
+        constructor() {
+          super();
+        }
+
+        connectedCallback() {
+          this.innerHTML = "foo";
+          // Not including any content since with XBL all content is anonymous, and we want
+          // an apples to apples comparison. When we have access to Shadow DOM we can set up a
+          // comparison with content.
+        }
+      }
+
+      customElements.define("test-custom-element", TestCustomElement);
+    </script>
+    <script>
+
+    window.onload = function() {
+      let container = document.getElementById("element-container");
+      let iterationTimes = [];
+      perf_start();
+
+      for (var i = 0; i < NUM_ITERATIONS; i++) {
+        for (var j = 0; j < NUM_ELEMENTS; j++) {
+          var element = document.createElement("test-custom-element");
+          container.appendChild(element);
+          container.innerHTML = '';
+        }
+      }
+      perf_finish();
+    }
+    </script>
+  </head>
+  <body>
+    <div id="element-container"></div>
+  </body>
+</html>
diff --git a/testing/talos/talos/tests/webcomponents/install.rdf b/testing/talos/talos/tests/webcomponents/install.rdf
new file mode 100644
--- /dev/null
+++ b/testing/talos/talos/tests/webcomponents/install.rdf
@@ -0,0 +1,24 @@
+<?xml version="1.0"?>
+<RDF xmlns="http://www.w3.org/1999/02/22-rdf-syntax-ns#" xmlns:em="http://www.mozilla.org/2004/em-rdf#">
+  <Description about="urn:mozilla:install-manifest">
+    <em:id>webcomponents-test@mozilla.org</em:id>
+    <em:type>2</em:type>
+    <em:name>webcomponents test</em:name>
+    <em:version>1.0.0</em:version>
+    <em:bootstrap>false</em:bootstrap>
+    <em:description>Measures the performance various webcomponents measurements</em:description>
+    <em:creator>bgrins</em:creator>
+    <em:multiprocessCompatible>true</em:multiprocessCompatible>
+
+    <!-- Desktop -->
+    <em:targetApplication>
+      <Description>
+        <em:id>{ec8030f7-c20a-464f-9b0e-13a3a9e97384}</em:id>
+        <em:minVersion>55.0</em:minVersion>
+        <em:maxVersion>*</em:maxVersion>
+      </Description>
+    </em:targetApplication>
+  </Description>
+  <em:description>https://wiki.mozilla.org/Buildbot/Talos/Tests</em:description>
+  <em:homepageURL>https://wiki.mozilla.org/Buildbot/Talos/Tests</em:homepageURL>
+</RDF>
diff --git a/testing/talos/talos/tests/webcomponents/webcomponents.manifest b/testing/talos/talos/tests/webcomponents/webcomponents.manifest
new file mode 100644
--- /dev/null
+++ b/testing/talos/talos/tests/webcomponents/webcomponents.manifest
@@ -0,0 +1,3 @@
+
+% http://localhost/tests/webcomponents/customelement-creation.html
+% chrome://cpstartup/content/xbl-creation.xul
diff --git a/testing/talos/talos/tests/webcomponents/webcomponents.manifest.develop b/testing/talos/talos/tests/webcomponents/webcomponents.manifest.develop
new file mode 100644
--- /dev/null
+++ b/testing/talos/talos/tests/webcomponents/webcomponents.manifest.develop
@@ -0,0 +1,3 @@
+
+% http://localhost:63409/tests/webcomponents/customelement-creation.html
+% chrome://cpstartup/content/xbl-creation.xul
