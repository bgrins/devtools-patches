# HG changeset patch
# Parent a18a6e8344e7775836a2868053b983dc312c57ea
# User Brian Grinstead <bgrinstead@mozilla.com>
Bug 862558 - Web Console should always be available / visible

diff --git a/browser/devtools/debugger/debugger-panes.js b/browser/devtools/debugger/debugger-panes.js
--- a/browser/devtools/debugger/debugger-panes.js
+++ b/browser/devtools/debugger/debugger-panes.js
@@ -1510,16 +1510,17 @@ WatchExpressionsView.prototype = Heritag
   /**
    * The keypress listener for a watch expression's textbox.
    */
   _onKeyPress: function(e) {
     switch(e.keyCode) {
       case e.DOM_VK_RETURN:
       case e.DOM_VK_ENTER:
       case e.DOM_VK_ESCAPE:
+        e.stopPropagation();
         DebuggerView.editor.focus();
         return;
     }
   }
 });
 
 /**
  * Functions handling the event listeners UI.
diff --git a/browser/devtools/framework/toolbox.js b/browser/devtools/framework/toolbox.js
--- a/browser/devtools/framework/toolbox.js
+++ b/browser/devtools/framework/toolbox.js
@@ -62,16 +62,17 @@ loader.lazyGetter(this, "Requisition", (
 function Toolbox(target, selectedTool, hostType, hostOptions) {
   this._target = target;
   this._toolPanels = new Map();
   this._telemetry = new Telemetry();
 
   this._toolRegistered = this._toolRegistered.bind(this);
   this._toolUnregistered = this._toolUnregistered.bind(this);
   this._refreshHostTitle = this._refreshHostTitle.bind(this);
+  this._splitConsoleOnKeypress = this._splitConsoleOnKeypress.bind(this)
   this.destroy = this.destroy.bind(this);
 
   this._target.on("close", this.destroy);
 
   if (!hostType) {
     hostType = Services.prefs.getCharPref(this._prefs.LAST_HOST);
   }
   if (!selectedTool) {
@@ -224,21 +225,65 @@ Toolbox.prototype = {
 
   _buildOptions: function() {
     let key = this.doc.getElementById("toolbox-options-key");
     key.addEventListener("command", () => {
       this.selectTool("options");
     }, true);
   },
 
+  _splitConsoleOnKeypress: function(e) {
+    if (e.keyCode === e.DOM_VK_ESCAPE) {
+      this.toggleSplitConsole();
+    }
+  },
+
   _addToolSwitchingKeys: function() {
     let nextKey = this.doc.getElementById("toolbox-next-tool-key");
     nextKey.addEventListener("command", this.selectNextTool.bind(this), true);
     let prevKey = this.doc.getElementById("toolbox-previous-tool-key");
     prevKey.addEventListener("command", this.selectPreviousTool.bind(this), true);
+
+    // Split console uses keypress instead of command so the event can be
+    // cancelled with stopPropagation on the keypress, and not preventDefault.
+    this.doc.addEventListener("keypress", this._splitConsoleOnKeypress, false);
+  },
+
+  /**
+   * Make sure that the console is showing up properly based on all the
+   * possible conditions.
+   *   1) If the console tab is selected, then regardless of split state
+   *      it should take up the full height of the deck, and we should
+   *      hide the deck and splitter.
+   *   2) If the console tab is not selected and it is split, then we should
+   *      show the splitter, deck, and console.
+   *   3) If the console tab is not selected and it is *not* split,
+   *      then we should hide the console and splitter, and show the deck
+   *      at full height.
+   */
+  _refreshConsoleDisplay: function() {
+    let deck = this.doc.getElementById("toolbox-deck");
+    let webconsolePanel = this.doc.getElementById("toolbox-panel-webconsole");
+    let splitter = this.doc.getElementById("toolbox-console-splitter");
+    let openedConsolePanel = this.currentToolId === "webconsole";
+
+    if (openedConsolePanel) {
+      deck.setAttribute("collapsed", "true");
+      splitter.removeAttribute("hidden");
+      webconsolePanel.removeAttribute("collapsed");
+    } else {
+      deck.removeAttribute("collapsed");
+      if (this._splitConsole) {
+        webconsolePanel.removeAttribute("collapsed");
+        splitter.removeAttribute("hidden");
+      } else {
+        splitter.setAttribute("hidden", "true");
+        webconsolePanel.setAttribute("collapsed", "true");
+      }
+    }
   },
 
   /**
    * Wire up the listeners for the zoom keys.
    */
   _addZoomKeys: function() {
     let inKey = this.doc.getElementById("toolbox-zoom-in-key");
     inKey.addEventListener("command", this.zoomIn.bind(this), true);
@@ -494,18 +539,21 @@ Toolbox.prototype = {
       label.setAttribute("crop", "end");
       label.setAttribute("flex", "1");
       radio.appendChild(label);
       radio.setAttribute("flex", "1");
     }
 
     let vbox = this.doc.createElement("vbox");
     vbox.className = "toolbox-panel";
-    vbox.id = "toolbox-panel-" + id;
 
+    // There is already a container for the frame for the webconsole.
+    if (!this.doc.getElementById("toolbox-panel-" + id)) {
+      vbox.id = "toolbox-panel-" + id;
+    }
 
     // If there is no tab yet, or the ordinal to be added is the largest one.
     if (tabs.childNodes.length == 0 ||
         +tabs.lastChild.getAttribute("ordinal") <= toolDefinition.ordinal) {
       tabs.appendChild(radio);
       deck.appendChild(vbox);
     } else {
       // else, iterate over all the tabs to get the correct location.
@@ -601,17 +649,16 @@ Toolbox.prototype = {
     let selected = this.doc.querySelector(".devtools-tab[selected]");
     if (selected) {
       selected.removeAttribute("selected");
     }
 
     let tab = this.doc.getElementById("toolbox-tab-" + id);
     tab.setAttribute("selected", "true");
 
-
     if (this.currentToolId == id) {
       // re-focus tool to get key events again
       this.focusTool(id);
 
       // Return the existing panel in order to have a consistent return value.
       return promise.resolve(this._toolPanels.get(id));
     }
 
@@ -644,16 +691,17 @@ Toolbox.prototype = {
     }
     tabstrip.selectedItem = tab;
 
     // and select the right iframe
     let deck = this.doc.getElementById("toolbox-deck");
     deck.selectedIndex = index;
 
     this.currentToolId = id;
+    this._refreshConsoleDisplay();
     if (id != "options") {
       Services.prefs.setCharPref(this._prefs.LAST_TOOL, id);
     }
 
     return this.loadTool(id).then(panel => {
       // focus the tool's frame to start receiving key events
       this.focusTool(id);
 
@@ -669,16 +717,38 @@ Toolbox.prototype = {
    *         The id of tool to focus
    */
   focusTool: function(id) {
     let iframe = this.doc.getElementById("toolbox-panel-iframe-" + id);
     iframe.focus();
   },
 
   /**
+   * Toggles the state of the console being split.  If the console panel
+   * is already selected, then this command is ignored.
+   */
+  toggleSplitConsole: function() {
+    let openedConsolePanel = this.currentToolId === "webconsole";
+
+    // Don't allow changes when console is open, since it could be confusing
+    if (!openedConsolePanel) {
+      this._splitConsole = !this._splitConsole;
+
+      if (this._splitConsole) {
+        this.loadTool("webconsole").then(() => {
+          // XXX: This doesn't seem to refocus after opening split console,
+          // clicking inside of other panel, then reopening.
+          this.focusTool("webconsole");
+        });
+      }
+      this._refreshConsoleDisplay();
+    }
+  },
+
+  /**
    * Loads the tool next to the currently selected tool.
    */
   selectNextTool: function() {
     let selected = this.doc.querySelector(".devtools-tab[selected]");
     let next = selected.nextSibling || selected.parentNode.firstChild;
     let tool = next.getAttribute("toolid");
     return this.selectTool(tool);
   },
@@ -874,16 +944,18 @@ Toolbox.prototype = {
    */
   destroy: function() {
     // If several things call destroy then we give them all the same
     // destruction promise so we're sure to destroy only once
     if (this._destroyer) {
       return this._destroyer;
     }
 
+    this.doc.removeEventListener("keypress",
+      this._splitConsoleOnKeypress, false);
     this._target.off("navigate", this._refreshHostTitle);
     this.off("select", this._refreshHostTitle);
     this.off("host-changed", this._refreshHostTitle);
 
     gDevTools.off("tool-registered", this._toolRegistered);
     gDevTools.off("tool-unregistered", this._toolUnregistered);
 
     // Revert docShell.allowJavascript back to its original value if it was
diff --git a/browser/devtools/framework/toolbox.xul b/browser/devtools/framework/toolbox.xul
--- a/browser/devtools/framework/toolbox.xul
+++ b/browser/devtools/framework/toolbox.xul
@@ -67,12 +67,15 @@
       <hbox id="toolbox-controls">
         <hbox id="toolbox-dock-buttons"/>
         <toolbarbutton id="toolbox-close"
                        class="devtools-closebutton"
                        tooltiptext="&toolboxCloseButton.tooltip;"/>
       </hbox>
 #endif
     </toolbar>
-    <deck id="toolbox-deck" flex="1">
-    </deck>
+    <vbox flex="1">
+      <deck id="toolbox-deck" flex="1" minheight="75" />
+      <splitter id="toolbox-console-splitter" class="devtools-horizontal-splitter" hidden="true" />
+      <box minheight="75" flex="1" id="toolbox-panel-webconsole" collapsed="true" />
+    </vbox>
   </notificationbox>
 </window>
diff --git a/browser/devtools/webconsole/test/browser.ini b/browser/devtools/webconsole/test/browser.ini
--- a/browser/devtools/webconsole/test/browser.ini
+++ b/browser/devtools/webconsole/test/browser.ini
@@ -231,11 +231,12 @@ skip-if = os == "linux"
 [browser_webconsole_message_node_id.js]
 [browser_webconsole_netlogging.js]
 [browser_webconsole_network_panel.js]
 [browser_webconsole_notifications.js]
 [browser_webconsole_output_copy_newlines.js]
 [browser_webconsole_output_order.js]
 [browser_webconsole_property_provider.js]
 [browser_webconsole_scratchpad_panel_link.js]
+[browser_webconsole_split.js]
 [browser_webconsole_view_source.js]
 [browser_webconsole_reflow.js]
 [browser_webconsole_log_file_filter.js]
diff --git a/browser/devtools/webconsole/test/browser_webconsole_split.js b/browser/devtools/webconsole/test/browser_webconsole_split.js
new file mode 100644
--- /dev/null
+++ b/browser/devtools/webconsole/test/browser_webconsole_split.js
@@ -0,0 +1,69 @@
+/* vim:set ts=2 sw=2 sts=2 et: */
+/* This Source Code Form is subject to the terms of the Mozilla Public
+ * License, v. 2.0. If a copy of the MPL was not distributed with this
+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */
+
+function test()
+{
+  addTab("data:text/html;charset=utf-8,Web Console test for splitting");
+
+
+  function openInspector(callback)
+  {
+    let target = TargetFactory.forTab(gBrowser.selectedTab);
+    gDevTools.showToolbox(target, "inspector").then(function(toolbox) {
+      callback(toolbox.getCurrentPanel(), toolbox);
+    }).then(null, console.error);
+  }
+
+
+  browser.addEventListener("load", function onLoad() {
+    browser.removeEventListener("load", onLoad, true);
+
+    openInspector((inspector, toolbox) => {
+      EventUtils.sendKey("ESCAPE", inspector.panelWin);
+
+      let win = toolbox.doc.defaultView;
+      let deck = toolbox.doc.getElementById("toolbox-deck");
+      let webconsolePanel = toolbox.doc.getElementById("toolbox-panel-webconsole");
+      let splitter = toolbox.doc.getElementById("toolbox-console-splitter");
+
+      let initialDeckHeight = parseInt(win.getComputedStyle(deck).getPropertyValue("height"));
+      let initialWebconsoleHeight = parseInt(win.getComputedStyle(webconsolePanel).getPropertyValue("height"));
+      let initialSplitterVisibility = !splitter.getAttribute("hidden");
+      let openedConsolePanel = toolbox.currentToolId === "webconsole";
+
+      ok (!initialSplitterVisibility, "Splitter is hidden by default");
+      ok (initialDeckHeight > 0, "Deck has a height > 0 by default");
+      is (initialWebconsoleHeight, 0, "Web console is collapsed by default");
+      ok (!openedConsolePanel, "The console panel is not the current tool.");
+
+      toolbox.toggleSplitConsole();
+
+      let splitDeckHeight = parseInt(win.getComputedStyle(deck).getPropertyValue("height"));
+      let splitWebconsoleHeight = parseInt(win.getComputedStyle(webconsolePanel).getPropertyValue("height"));
+      let splitSplitterVisibility = !splitter.getAttribute("hidden");
+      let openedConsolePanel = toolbox.currentToolId === "webconsole";
+
+      ok (splitSplitterVisibility, "Splitter is visible when console is split");
+      ok (splitDeckHeight > 0, "Deck has a height > 0 when console is split");
+      ok (splitWebconsoleHeight > 0, "Web console has a height > 0 when console is split");
+      ok (!openedConsolePanel, "The console panel is not the current tool.");
+
+      toolbox.toggleSplitConsole();
+
+      let finalDeckHeight = parseInt(win.getComputedStyle(deck).getPropertyValue("height"));
+      let finalWebconsoleHeight = parseInt(win.getComputedStyle(webconsolePanel).getPropertyValue("height"));
+      let finalSplitterVisibility = !splitter.getAttribute("hidden");
+      let openedConsolePanel = toolbox.currentToolId === "webconsole";
+
+      ok (!finalSplitterVisibility, "Splitter is hidden by default");
+      ok (finalDeckHeight > 0, "Deck has a height > 0 by default");
+      is (finalWebconsoleHeight, 0, "Web console is collapsed by default");
+      ok (!openedConsolePanel, "The console panel is not the current tool.");
+
+      finishTest();
+    });
+
+  }, true);
+}
