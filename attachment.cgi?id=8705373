# HG changeset patch
# User Lin Clark <lclark@mozilla.com>
# Parent  c4027a24ae838fab12cc95baf666d63e2e3ce877
Bug 1234287 - Refactor webconsole netlogging tests. r=bgrins

diff --git a/devtools/client/webconsole/test/browser.ini b/devtools/client/webconsole/test/browser.ini
--- a/devtools/client/webconsole/test/browser.ini
+++ b/devtools/client/webconsole/test/browser.ini
@@ -1,13 +1,14 @@
 [DEFAULT]
 tags = devtools
 subsuite = devtools
 support-files =
   head.js
+  help_netlogging.js
   test-bug-585956-console-trace.html
   test-bug-593003-iframe-wrong-hud-iframe.html
   test-bug-593003-iframe-wrong-hud.html
   test-bug-595934-canvas-css.html
   test-bug-595934-canvas-css.js
   test-bug-595934-css-loader.css
   test-bug-595934-css-loader.css^headers^
   test-bug-595934-css-loader.html
@@ -201,17 +202,16 @@ skip-if = e10s && debug && os == 'win'
 skip-if = buildapp == 'mulet'
 [browser_result_format_as_string.js]
 [browser_warn_user_about_replaced_api.js]
 [browser_webconsole_abbreviate_source_url.js]
 [browser_webconsole_allow_mixedcontent_securityerrors.js]
 tags = mcb
 skip-if = buildapp == 'mulet'
 [browser_webconsole_assert.js]
-[browser_webconsole_basic_net_logging.js]
 [browser_webconsole_block_mixedcontent_securityerrors.js]
 tags = mcb
 skip-if = buildapp == 'mulet'
 [browser_webconsole_bug_579412_input_focus.js]
 [browser_webconsole_bug_580001_closing_after_completion.js]
 [browser_webconsole_bug_580030_errors_after_page_reload.js]
 [browser_webconsole_bug_580454_timestamp_l10n.js]
 [browser_webconsole_bug_582201_duplicate_errors.js]
@@ -333,16 +333,18 @@ skip-if = buildapp == 'mulet' || e10s # 
 [browser_webconsole_inspect-parsed-documents.js]
 [browser_webconsole_js_input_expansion.js]
 [browser_webconsole_jsterm.js]
 skip-if = e10s # Bug 1042253 - webconsole e10s tests (Linux debug timeout)
 [browser_webconsole_live_filtering_of_message_types.js]
 [browser_webconsole_live_filtering_on_search_strings.js]
 [browser_webconsole_message_node_id.js]
 [browser_webconsole_netlogging.js]
+[browser_webconsole_netlogging_basic.js]
+[browser_webconsole_netlogging_panel.js]
 [browser_webconsole_netlogging_reset_filter.js]
 [browser_webconsole_notifications.js]
 [browser_webconsole_open-links-without-callback.js]
 [browser_webconsole_promise.js]
 [browser_webconsole_output_copy_newlines.js]
 [browser_webconsole_output_order.js]
 [browser_webconsole_property_provider.js]
 skip-if = e10s # Bug 1042253 - webconsole tests disabled with e10s
diff --git a/devtools/client/webconsole/test/browser_console_netlogging.js b/devtools/client/webconsole/test/browser_console_netlogging.js
--- a/devtools/client/webconsole/test/browser_console_netlogging.js
+++ b/devtools/client/webconsole/test/browser_console_netlogging.js
@@ -2,49 +2,33 @@
 /* This Source Code Form is subject to the terms of the Mozilla Public
  * License, v. 2.0. If a copy of the MPL was not distributed with this
  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */
 
 // Tests that network log messages bring up the network panel.
 
 "use strict";
 
-const TEST_URI = "data:text/html;charset=utf-8,Web Console network " +
-                 "logging tests";
-
 const TEST_NETWORK_REQUEST_URI =
   "http://example.com/browser/devtools/client/webconsole/test/" +
   "test-network-request.html";
 
-var hud;
+loadHelperScript("help_netlogging.js");
 
-function test() {
-  loadTab(TEST_URI).then((tab) => {
-    HUDService.openBrowserConsoleOrFocus().then(aHud => {
-      hud = aHud;
-      HUDService.lastFinishedRequest.callback = testResponse;
-      BrowserTestUtils.loadURI(gBrowser.selectedBrowser,
-                               TEST_NETWORK_REQUEST_URI);
-    });
-  });
-}
+add_task(function* () {
+  let request;
+  HUDService.lastFinishedRequest.callback = req => request = req;
+  const hud = yield loadTestNetworkPage("browserConsole");
 
-function testResponse(request) {
-  hud.ui.webConsoleClient.getResponseContent(request.actor,
-    function(contentPacket) {
-      hud.ui.webConsoleClient.getRequestPostData(request.actor,
-        function(postDataPacket) {
-          // Check if page load was logged correctly.
-          ok(request, "Page load was logged");
+  ok(request, "Page load was logged");
 
-          is(request.request.url, TEST_NETWORK_REQUEST_URI,
-            "Logged network entry is page load");
-          is(request.request.method, "GET", "Method is correct");
-          ok(!postDataPacket.postData.text, "No request body was stored");
-          ok(postDataPacket.postDataDiscarded, "Request body was discarded");
-          ok(!contentPacket.content.text, "No response body was stored");
-          ok(contentPacket.contentDiscarded || request.fromCache,
-             "Response body was discarded or response came from the cache");
+  const postData = yield getPostData(hud, request);
+  const responseContent = yield getResponseContent(hud, request);
 
-          executeSoon(finishTest);
-        });
-    });
-}
+  is(request.request.url, TEST_NETWORK_REQUEST_URI,
+    "Logged network entry is page load");
+  is(request.request.method, "GET", "Method is correct");
+  ok(!postData.postData.text, "No request body was stored");
+  ok(postData.postDataDiscarded, "Request body was discarded");
+  ok(!responseContent.content.text, "No response body was stored");
+  ok(responseContent.contentDiscarded || request.fromCache,
+     "Response body was discarded or response came from the cache");
+});
diff --git a/devtools/client/webconsole/test/browser_webconsole_netlogging.js b/devtools/client/webconsole/test/browser_webconsole_netlogging.js
--- a/devtools/client/webconsole/test/browser_webconsole_netlogging.js
+++ b/devtools/client/webconsole/test/browser_webconsole_netlogging.js
@@ -1,171 +1,112 @@
 /* vim:set ts=2 sw=2 sts=2 et: */
-/* ***** BEGIN LICENSE BLOCK *****
- * Any copyright is dedicated to the Public Domain.
- * http://creativecommons.org/publicdomain/zero/1.0/
- *
- * Contributor(s):
- *  Julian Viereck <jviereck@mozilla.com>
- *  Patrick Walton <pcwalton@mozilla.com>
- *  Mihai È˜ucan <mihai.sucan@gmail.com>
- *
- * ***** END LICENSE BLOCK ***** */
+/* This Source Code Form is subject to the terms of the Mozilla Public
+ * License, v. 2.0. If a copy of the MPL was not distributed with this
+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */
 
-// Tests that network log messages bring up the network panel.
+// Tests response logging for different request types.
 
 "use strict";
 
 const TEST_URI = "data:text/html;charset=utf-8,Web Console network " +
                  "logging tests";
 
 const TEST_NETWORK_REQUEST_URI =
   "http://example.com/browser/devtools/client/webconsole/test/" +
   "test-network-request.html";
 
-const TEST_IMG = "http://example.com/browser/devtools/client/webconsole/" +
-                 "test/test-image.png";
-
 const TEST_DATA_JSON_CONTENT =
   '{ id: "test JSON data", myArray: [ "foo", "bar", "baz", "biff" ] }';
 
-var lastRequest = null;
-var requestCallback = null;
-var browser, hud;
+loadHelperScript("help_netlogging.js");
 
-function test() {
-  loadTab(TEST_URI).then((tab) => {
-    browser = tab.browser;
+add_task(function* testPageLoad() {
+  let finishedRequest = finishRequest();
+  let hud = yield loadTestNetworkPage();
+  let request = yield finishedRequest;
 
-    openConsole().then((aHud) => {
-      hud = aHud;
+  ok(request, "Page load was logged");
 
-      HUDService.lastFinishedRequest.callback = requestCallbackWrapper;
+  const postData = yield getPostData(hud, request);
+  const responseContent = yield getResponseContent(hud, request);
 
-      executeSoon(testPageLoad);
-    });
-  });
+  is(request.request.url, TEST_NETWORK_REQUEST_URI,
+    "Logged network entry is page load");
+  is(request.request.method, "GET", "Method is correct");
+  ok(!postData.postData.text, "No request body was stored");
+  ok(!postData.postDataDiscarded,
+    "Request body was not discarded");
+  is(responseContent.content.text.indexOf("<!DOCTYPE HTML>"), 0,
+    "Response body's beginning is okay");
+});
+
+add_task(function* testXhrGet() {
+  let hud = yield loadTestNetworkPage();
+
+  let finishedRequest = finishRequest();
+  content.wrappedJSObject.testXhrGet();
+  let request = yield finishedRequest;
+
+  ok(request, "testXhrGet() was logged");
+
+  const postData = yield getPostData(hud, request);
+  const responseContent = yield getResponseContent(hud, request);
+
+  is(request.request.method, "GET", "Method is correct");
+  ok(!postData.postData.text, "No request body was sent");
+  ok(!postData.postDataDiscarded,
+    "Request body was not discarded");
+  is(responseContent.content.text, TEST_DATA_JSON_CONTENT,
+    "Response is correct");
+});
+
+add_task(function* testXhrPost() {
+  let hud = yield loadTestNetworkPage();
+
+  let finishedRequest = finishRequest();
+  content.wrappedJSObject.testXhrPost();
+  let request = yield finishedRequest;
+
+  ok(request, "testXhrPost() was logged");
+
+  const postData = yield getPostData(hud, request);
+  const responseContent = yield getResponseContent(hud, request);
+
+  is(request.request.method, "POST", "Method is correct");
+  is(postData.postData.text, "Hello world!", "Request body was logged");
+  is(responseContent.content.text, TEST_DATA_JSON_CONTENT,
+    "Response is correct");
+});
+
+add_task(function* testFormSubmission() {
+  let hud = yield loadTestNetworkPage();
+
+  let form = content.document.querySelector("form");
+
+  let finishedRequest = finishRequest();
+  form.submit();
+  let request = yield finishedRequest;
+
+  ok(request, "testFormSubmission() was logged");
+
+  const postData = yield getPostData(hud, request);
+  const responseContent = yield getResponseContent(hud, request);
+
+  is(request.request.method, "POST", "Method is correct");
+  isnot(postData.postData.text
+    .indexOf("Content-Type: application/x-www-form-urlencoded"), -1,
+    "Content-Type is correct");
+  isnot(postData.postData.text
+    .indexOf("Content-Length: 20"), -1, "Content-length is correct");
+  isnot(postData.postData.text
+    .indexOf("name=foo+bar&age=144"), -1, "Form data is correct");
+  is(responseContent.content.text.indexOf("<!DOCTYPE HTML>"), 0,
+    "Response body's beginning is okay");
+});
+
+function finishRequest() {
+  let deferred = promise.defer();
+  HUDService.lastFinishedRequest.callback = request => {
+    deferred.resolve(request);
+  };
+  return deferred.promise;
 }
-
-function requestCallbackWrapper(request) {
-  lastRequest = request;
-
-  hud.ui.webConsoleClient.getResponseContent(lastRequest.actor,
-    function(aResponse) {
-      lastRequest.response.content = aResponse.content;
-      lastRequest.discardResponseBody = aResponse.contentDiscarded;
-
-      hud.ui.webConsoleClient.getRequestPostData(lastRequest.actor,
-        function(response) {
-          lastRequest.request.postData = response.postData;
-          lastRequest.discardRequestBody = response.postDataDiscarded;
-
-          if (requestCallback) {
-            requestCallback();
-          }
-        });
-    });
-}
-
-function testPageLoad() {
-  requestCallback = function() {
-    // Check if page load was logged correctly.
-    ok(lastRequest, "Page load was logged");
-
-    is(lastRequest.request.url, TEST_NETWORK_REQUEST_URI,
-      "Logged network entry is page load");
-    is(lastRequest.request.method, "GET", "Method is correct");
-    ok(!lastRequest.request.postData.text, "No request body was stored");
-    ok(!lastRequest.discardRequestBody, "Request body was not discarded");
-    is(lastRequest.response.content.text.indexOf("<!DOCTYPE HTML>"), 0,
-      "Response body's beginning is okay");
-
-    lastRequest = null;
-    requestCallback = null;
-    executeSoon(testXhrGet);
-  };
-
-  content.location = TEST_NETWORK_REQUEST_URI;
-}
-
-function testXhrGet() {
-  requestCallback = function() {
-    ok(lastRequest, "testXhrGet() was logged");
-    is(lastRequest.request.method, "GET", "Method is correct");
-    ok(!lastRequest.request.postData.text, "No request body was sent");
-    ok(!lastRequest.discardRequestBody, "Request body was not discarded");
-    is(lastRequest.response.content.text, TEST_DATA_JSON_CONTENT,
-      "Response is correct");
-
-    lastRequest = null;
-    requestCallback = null;
-    executeSoon(testXhrPost);
-  };
-
-  // Start the XMLHttpRequest() GET test.
-  content.wrappedJSObject.testXhrGet();
-}
-
-function testXhrPost() {
-  requestCallback = function() {
-    ok(lastRequest, "testXhrPost() was logged");
-    is(lastRequest.request.method, "POST", "Method is correct");
-    is(lastRequest.request.postData.text, "Hello world!",
-      "Request body was logged");
-    is(lastRequest.response.content.text, TEST_DATA_JSON_CONTENT,
-      "Response is correct");
-
-    lastRequest = null;
-    requestCallback = null;
-    executeSoon(testFormSubmission);
-  };
-
-  // Start the XMLHttpRequest() POST test.
-  content.wrappedJSObject.testXhrPost();
-}
-
-function testFormSubmission() {
-  // Start the form submission test. As the form is submitted, the page is
-  // loaded again. Bind to the load event to catch when this is done.
-  requestCallback = function() {
-    ok(lastRequest, "testFormSubmission() was logged");
-    is(lastRequest.request.method, "POST", "Method is correct");
-    isnot(lastRequest.request.postData.text
-      .indexOf("Content-Type: application/x-www-form-urlencoded"), -1,
-      "Content-Type is correct");
-    isnot(lastRequest.request.postData.text
-      .indexOf("Content-Length: 20"), -1, "Content-length is correct");
-    isnot(lastRequest.request.postData.text
-      .indexOf("name=foo+bar&age=144"), -1, "Form data is correct");
-    is(lastRequest.response.content.text.indexOf("<!DOCTYPE HTML>"), 0,
-      "Response body's beginning is okay");
-
-    executeSoon(testNetworkPanel);
-  };
-  ContentTask.spawn(gBrowser.selectedBrowser, { }, `function()
-  {
-    let form = content.document.querySelector("form");
-    form.submit();
-  }`);
-}
-
-function testNetworkPanel() {
-  // Open the NetworkPanel. The functionality of the NetworkPanel is tested
-  // within separate test files.
-  hud.ui.openNetworkPanel(lastRequest.actor).then(() => {
-    let toolbox = gDevTools.getToolbox(hud.target);
-    is(toolbox.currentToolId, "netmonitor", "Network panel was opened");
-    let panel = toolbox.getCurrentPanel();
-    let selected = panel.panelWin.NetMonitorView.RequestsMenu.selectedItem;
-    is(selected.attachment.method, lastRequest.request.method,
-       "The correct request is selected");
-    is(selected.attachment.url, lastRequest.request.url,
-       "The correct request is definitely selected");
-
-    // All tests are done. Shutdown.
-    lastRequest = null;
-    HUDService.lastFinishedRequest.callback = null;
-    browser = requestCallback = hud = null;
-    executeSoon(finishTest);
-  }).then(null, error => {
-    ok(false, "Got an error: " + error.message + "\n" + error.stack);
-  });
-}
diff --git a/devtools/client/webconsole/test/browser_webconsole_basic_net_logging.js b/devtools/client/webconsole/test/browser_webconsole_netlogging_basic.js
rename from devtools/client/webconsole/test/browser_webconsole_basic_net_logging.js
rename to devtools/client/webconsole/test/browser_webconsole_netlogging_basic.js
--- a/devtools/client/webconsole/test/browser_webconsole_basic_net_logging.js
+++ b/devtools/client/webconsole/test/browser_webconsole_netlogging_basic.js
@@ -12,17 +12,17 @@ const TEST_NETWORK_URI = "http://example
                          "webconsole/test/test-network.html" + "?_date=" +
                          Date.now();
 
 add_task(function* () {
   yield loadTab("data:text/html;charset=utf-8,Web Console basic network " +
                 "logging test");
   let hud = yield openConsole();
 
-  content.location = TEST_NETWORK_URI;
+  yield BrowserTestUtils.loadURI(gBrowser.selectedBrowser, TEST_NETWORK_URI);
 
   yield waitForMessages({
     webconsole: hud,
     messages: [{
       text: "running network console",
       category: CATEGORY_WEBDEV,
       severity: SEVERITY_LOG,
     },
diff --git a/devtools/client/webconsole/test/browser_webconsole_netlogging_panel.js b/devtools/client/webconsole/test/browser_webconsole_netlogging_panel.js
new file mode 100644
--- /dev/null
+++ b/devtools/client/webconsole/test/browser_webconsole_netlogging_panel.js
@@ -0,0 +1,26 @@
+/* vim:set ts=2 sw=2 sts=2 et: */
+/* This Source Code Form is subject to the terms of the Mozilla Public
+ * License, v. 2.0. If a copy of the MPL was not distributed with this
+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */
+
+// Tests that network log messages bring up the network panel.
+
+"use strict";
+
+loadHelperScript("help_netlogging.js");
+
+add_task(function* () {
+  let request;
+  HUDService.lastFinishedRequest.callback = req => request = req;
+  const hud = yield loadTestNetworkPage();
+
+  yield hud.ui.openNetworkPanel(request.actor);
+  let toolbox = gDevTools.getToolbox(hud.target);
+  is(toolbox.currentToolId, "netmonitor", "Network panel was opened");
+  let panel = toolbox.getCurrentPanel();
+  let selected = panel.panelWin.NetMonitorView.RequestsMenu.selectedItem;
+  is(selected.attachment.method, request.request.method,
+     "The correct request is selected");
+  is(selected.attachment.url, request.request.url,
+     "The correct request is definitely selected");
+});
diff --git a/devtools/client/webconsole/test/help_netlogging.js b/devtools/client/webconsole/test/help_netlogging.js
new file mode 100644
--- /dev/null
+++ b/devtools/client/webconsole/test/help_netlogging.js
@@ -0,0 +1,77 @@
+/* vim: set ts=2 et sw=2 tw=80: */
+/* Any copyright is dedicated to the Public Domain.
+ http://creativecommons.org/publicdomain/zero/1.0/ */
+
+"use strict";
+
+/**
+ * Load test-network-request.html
+ *
+ * @param string consoleType
+ *   The console type, either "browserConsole" or "webConsole"
+ * @return object
+ *   The HUD associated with the console
+ */
+function* loadTestNetworkPage(consoleType) {
+  const TEST_URI = "data:text/html;charset=utf-8,Web Console network " +
+                   "logging tests";
+
+  const TEST_NETWORK_REQUEST_URI =
+    "http://example.com/browser/devtools/client/webconsole/test/" +
+    "test-network-request.html";
+
+  let { browser } = yield loadTab(TEST_URI);
+
+  let hud;
+  if (consoleType === "browserConsole") {
+    hud = yield HUDService.openBrowserConsoleOrFocus();
+  } else {
+    hud = yield openConsole();
+  }
+
+  ok(hud, "Console was opened");
+
+  let loaded = loadBrowser(browser);
+  yield BrowserTestUtils.loadURI(gBrowser.selectedBrowser,
+                                 TEST_NETWORK_REQUEST_URI);
+  yield loaded;
+
+  yield waitForMessages({
+    webconsole: hud,
+    messages: [{
+      text: "test-network-request.html",
+      category: CATEGORY_NETWORK,
+      severity: SEVERITY_LOG,
+    }],
+  });
+
+  return hud;
+}
+
+/**
+ * Get the response content packet for a request.
+ *
+ * @param object hud
+ * @param object request
+ */
+function getResponseContent(hud, request) {
+  let deferred = promise.defer();
+  hud.ui.webConsoleClient.getResponseContent(request.actor, contentPacket => {
+    deferred.resolve(contentPacket);
+  });
+  return deferred.promise;
+}
+
+/**
+ * Get the post data packet for a request.
+ *
+ * @param object hud
+ * @param object request
+ */
+function getPostData(hud, request) {
+  let deferred = promise.defer();
+  hud.ui.webConsoleClient.getRequestPostData(request.actor, postDataPacket => {
+    deferred.resolve(postDataPacket);
+  });
+  return deferred.promise;
+}
