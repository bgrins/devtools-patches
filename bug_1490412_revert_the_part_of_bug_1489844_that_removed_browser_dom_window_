# HG changeset patch
# User Brian Grinstead <bgrinstead@mozilla.com>
# Date 1536698240 25200
#      Tue Sep 11 13:37:20 2018 -0700
# Node ID 0acc123cf48988cb4ab13839eca9b4c975c23683
# Parent  2a59b432d2bd9b15ceec6b9435f60c785a820ef2
Bug 1490412 - Revert the part of Bug 1489844 that removed browser.dom.window.dump.enabled from all.js;r=Ehsan

Moving this to C++ caused browser.dom.window.dump.enabled to become false in artifact
builds, since MOZILLA_OFFICIAL is true for the binaries used in that case. Restoring
the preference in all.js fixes this, since that file is built locally with artifact builds.

Differential Revision: https://phabricator.services.mozilla.com/D5586

diff --git a/modules/libpref/init/StaticPrefList.h b/modules/libpref/init/StaticPrefList.h
--- a/modules/libpref/init/StaticPrefList.h
+++ b/modules/libpref/init/StaticPrefList.h
@@ -349,16 +349,19 @@ VARCACHE_PREF(
 #ifdef JS_BUILD_BINAST
 VARCACHE_PREF(
   "dom.script_loader.binast_encoding.enabled",
    dom_script_loader_binast_encoding_enabled,
   RelaxedAtomicBool, false
 )
 #endif
 
+// IMPORTANT: Keep this in condition in sync with all.js. The value
+// of MOZILLA_OFFICIAL is different between full and artifact builds, so without
+// it being specified there, dump is disabled in artifact builds (see Bug 1490412).
 #ifdef MOZILLA_OFFICIAL
 # define PREF_VALUE false
 #else
 # define PREF_VALUE true
 #endif
 VARCACHE_PREF(
   "browser.dom.window.dump.enabled",
    browser_dom_window_dump_enabled,
diff --git a/modules/libpref/init/all.js b/modules/libpref/init/all.js
--- a/modules/libpref/init/all.js
+++ b/modules/libpref/init/all.js
@@ -1054,16 +1054,26 @@ pref("toolkit.asyncshutdown.crash_timeou
 #else
 // MOZ_ASAN builds can be considerably slower. Extending the grace period
 // of both asyncshutdown and the terminator.
 pref("toolkit.asyncshutdown.crash_timeout", 180000); // 3 minutes
 #endif // MOZ_ASAN
 // Extra logging for AsyncShutdown barriers and phases
 pref("toolkit.asyncshutdown.log", false);
 
+// Enable JS dump() function.
+// IMPORTANT: Keep this in condition in sync with StaticPrefList.h. The value
+// of MOZILLA_OFFICIAL is different between full and artifact builds, so without
+// it being specified, dump is disabled in artifact builds (see Bug 1490412).
+#ifdef MOZILLA_OFFICIAL
+pref("browser.dom.window.dump.enabled", false, sticky);
+#else
+pref("browser.dom.window.dump.enabled", true, sticky);
+#endif
+
 // Controls whether EventEmitter module throws dump message on each emit
 pref("toolkit.dump.emit", false);
 
 // Enable recording/replaying executions.
 #if defined(XP_MACOSX) && defined(NIGHTLY_BUILD)
 pref("devtools.recordreplay.enabled", false);
 pref("devtools.recordreplay.enableRewinding", true);
 #endif
