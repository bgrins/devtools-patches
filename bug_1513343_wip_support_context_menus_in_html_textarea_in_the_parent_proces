# HG changeset patch
# User Brian Grinstead <bgrinstead@mozilla.com>
# Date 1551133551 28800
#      Mon Feb 25 14:25:51 2019 -0800
# Node ID d6c77bcf08cd1c7e35d8c58e5d81b0dc4acde426
# Parent  a223717d5204d1baad80a6462f6618aec815c830
Bug 1513343 - WIP Support context menus in html:textarea in the parent process

Differential Revision: https://phabricator.services.mozilla.com/D21092

diff --git a/toolkit/content/editMenuOverlay.js b/toolkit/content/editMenuOverlay.js
--- a/toolkit/content/editMenuOverlay.js
+++ b/toolkit/content/editMenuOverlay.js
@@ -29,8 +29,85 @@ function goUpdateUndoEditMenuItems() {
   goUpdateCommand("cmd_undo");
   goUpdateCommand("cmd_redo");
 }
 
 // update menu items that depend on clipboard contents
 function goUpdatePasteMenuItems() {
   goUpdateCommand("cmd_paste");
 }
+
+window.addEventListener("DOMContentLoaded", () => {
+  document.documentElement.appendChild(MozXULElement.parseXULToFragment(`
+  <commandset id="editMenuCommands">
+    <commandset id="editMenuCommandSetAll" commandupdater="true" events="focus,select"
+                oncommandupdate="goUpdateGlobalEditMenuItems()"/>
+    <commandset id="editMenuCommandSetUndo" commandupdater="true" events="undo"
+                oncommandupdate="goUpdateUndoEditMenuItems()"/>
+    <commandset id="editMenuCommandSetPaste" commandupdater="true" events="clipboard"
+                oncommandupdate="goUpdatePasteMenuItems()"/>
+    <command id="cmd_undo" oncommand="goDoCommand('cmd_undo')"/>
+    <command id="cmd_redo" oncommand="goDoCommand('cmd_redo')"/>
+    <command id="cmd_cut" oncommand="goDoCommand('cmd_cut')"/>
+    <command id="cmd_copy" oncommand="goDoCommand('cmd_copy')"/>
+    <command id="cmd_paste" oncommand="goDoCommand('cmd_paste')"/>
+    <command id="cmd_delete" oncommand="goDoCommand('cmd_delete')"/>
+    <command id="cmd_selectAll" oncommand="goDoCommand('cmd_selectAll')"/>
+    <command id="cmd_switchTextDirection" oncommand="goDoCommand('cmd_switchTextDirection');"/>
+  </commandset>
+  `));
+}, { once: true });
+
+// Support context menus on html textareas in the parent process:
+window.addEventListener("contextmenu", (e) => {
+  if (e.target.ownerDocument != document || e.target.localName != "textarea") {
+    return;
+  }
+
+  let popup = document.getElementById("textbox-contextmenu");
+  if (!popup) {
+    let popupset = document.querySelector("popupset");
+    if (!popupset) {
+      popupset = document.createXULElement("popupset");
+      document.documentElement.appendChild(popupset);
+    }
+    MozXULElement.insertFTLIfNeeded("toolkit/main-window/editmenu.ftl");
+    popupset.appendChild(MozXULElement.parseXULToFragment(`
+      <menupopup id="textbox-contextmenu" class="textbox-contextmenu">
+        <menuitem data-l10n-id="editmenu-undo" cmd="cmd_undo"></menuitem>
+        <menuseparator></menuseparator>
+        <menuitem data-l10n-id="editmenu-cut" cmd="cmd_cut"></menuitem>
+        <menuitem data-l10n-id="editmenu-copy" cmd="cmd_copy"></menuitem>
+        <menuitem data-l10n-id="editmenu-paste" cmd="cmd_paste"></menuitem>
+        <menuitem data-l10n-id="editmenu-delete" cmd="cmd_delete"></menuitem>
+        <menuseparator></menuseparator>
+        <menuitem data-l10n-id="editmenu-select-all" cmd="cmd_selectAll"></menuitem>
+      </menupopup>
+    `));
+
+    popup = popupset.lastElementChild;
+    popup.addEventListener("popupshowing", (event) => {
+      let children = event.target.children;
+      for (let i = 0; i < children.length; i++) {
+        let command = children[i].getAttribute("cmd");
+        if (command) {
+          let controller = document.commandDispatcher.getControllerForCommand(command);
+          let enabled = controller.isCommandEnabled(command);
+          if (enabled)
+            children[i].removeAttribute("disabled");
+          else
+            children[i].setAttribute("disabled", "true");
+        }
+      }
+    });
+
+    popup.addEventListener("command", event => {
+      var cmd = event.originalTarget.getAttribute("cmd");
+      if (cmd) {
+        window.docShell.doCommand(cmd);
+        event.stopPropagation();
+      }
+    });
+  }
+
+  popup.openPopupAtScreen(e.screenX, e.screenY, true);
+});
+
