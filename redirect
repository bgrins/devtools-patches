# HG changeset patch
# User Brian Grinstead <bgrinstead@mozilla.com>
# Parent  281117771736a414087da02d430013e2b2d78019
Bug 1105470 - contentLocation in webconsole.js isn't updated after a redirect

diff --git a/devtools/client/webconsole/webconsole.js b/devtools/client/webconsole/webconsole.js
--- a/devtools/client/webconsole/webconsole.js
+++ b/devtools/client/webconsole/webconsole.js
@@ -1871,16 +1871,17 @@ WebConsoleFrame.prototype = {
    * Handler for page location changes.
    *
    * @param string uri
    *        New page location.
    * @param string title
    *        New page title.
    */
   onLocationChange: function(uri, title) {
+    dump("onLocationChange " + uri + "\n");
     this.contentLocation = uri;
     if (this.owner.onLocationChange) {
       this.owner.onLocationChange(uri, title);
     }
   },
 
   /**
    * Handler for the tabNavigated notification.
@@ -1895,16 +1896,17 @@ WebConsoleFrame.prototype = {
       if (this.persistLog) {
         let marker = new Messages.NavigationMarker(packet, Date.now());
         this.output.addMessage(marker);
       } else {
         this.jsterm.clearOutput();
       }
     }
 
+    dump("tab navigated " + Object.keys(packet) + "\n");
     if (packet.url) {
       this.onLocationChange(packet.url, packet.title);
     }
 
     if (event == "navigate" && !packet.nativeConsoleAPI) {
       this.logWarningAboutReplacedAPI();
     }
   },
diff --git a/devtools/shared/webconsole/utils.js b/devtools/shared/webconsole/utils.js
--- a/devtools/shared/webconsole/utils.js
+++ b/devtools/shared/webconsole/utils.js
@@ -3,16 +3,17 @@
 /* This Source Code Form is subject to the terms of the Mozilla Public
  * License, v. 2.0. If a copy of the MPL was not distributed with this
  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */
 
 "use strict";
 
 const {Cc, Ci, Cu, components} = require("chrome");
 const {isWindowIncluded} = require("devtools/shared/layout/utils");
+const { NetUtil } = require("resource://gre/modules/NetUtil.jsm", { });
 
 Cu.import("resource://gre/modules/XPCOMUtils.jsm");
 
 loader.lazyImporter(this, "Services", "resource://gre/modules/Services.jsm");
 
 // TODO: Bug 842672 - browser/ imports modules from toolkit/.
 // Note that these are only used in WebConsoleCommands, see $0 and pprint().
 loader.lazyImporter(this, "VariablesView", "resource://devtools/client/shared/widgets/VariablesView.jsm");
@@ -442,16 +443,23 @@ var WebConsoleUtils = {
    * @return boolean
    *         True if the content is mixed, false if not.
    */
   isMixedHTTPSRequest: function WCU_isMixedHTTPSRequest(aRequest, aLocation)
   {
     try {
       let requestURI = Services.io.newURI(aRequest, null, null);
       let contentURI = Services.io.newURI(aLocation, null, null);
+
+      dump(requestURI.spec + " " + Ci.nsIProtocolHandler.URI_SAFE_TO_LOAD_IN_SECURE_CONTEXT + "\n\n");
+      // dump(NetUtil.URIChainHasFlags(requestURI, Ci.nsIProtocolHandler.URI_SAFE_TO_LOAD_IN_SECURE_CONTEXT) + "\n\n");
+      // dump("Checking isMixedHTTPSRequest: " +
+      //   netutil.URIChainHasFlags(requestURI, Ci.nsIProtocolHandler.URI_SAFE_TO_LOAD_IN_SECURE_CONTEXT) + " " +
+      //   netutil.URIChainHasFlags(contentURI, Ci.nsIProtocolHandler.URI_SAFE_TO_LOAD_IN_SECURE_CONTEXT) + "\n"
+      // );
       return (contentURI.scheme == "https" && requestURI.scheme != "https");
     }
     catch (ex) {
       return false;
     }
   },
 
   /**
