# HG changeset patch
# User Brian Grinstead <bgrinstead@mozilla.com>
# Parent  70158e4e215d784d1391db5e517b18727f4b3683
Bug 1387125 - Create a performance test to compare XBL with Custom Elements in XUL Documents

MozReview-Commit-ID: FXhDUc9LfiE

diff --git a/dom/base/test/chrome/chrome.ini b/dom/base/test/chrome/chrome.ini
--- a/dom/base/test/chrome/chrome.ini
+++ b/dom/base/test/chrome/chrome.ini
@@ -70,8 +70,16 @@ support-files = ../file_bug357450.js
 [test_nsITextInputProcessor.xul]
 [test_range_getClientRectsAndTexts.html]
 [test_title.xul]
 support-files = file_title.xul
 [test_windowroot.xul]
 [test_swapFrameLoaders.xul]
 [test_groupedSHistory.xul]
 [test_bug1339722.html]
+[test_perf_xbl_vs_customelement.xul]
+skip-if = true # only run this when manually invoked
+support-files =
+  file_perf_customelement.html
+  file_perf_customelement.xul
+  file_perf_customelement_polyfill_xul.js
+  file_perf_xbl.xul
+  file_perf_xbl_bindings.xml
diff --git a/dom/base/test/chrome/file_perf_customelement.html b/dom/base/test/chrome/file_perf_customelement.html
new file mode 100644
--- /dev/null
+++ b/dom/base/test/chrome/file_perf_customelement.html
@@ -0,0 +1,49 @@
+<!DOCTYPE HTML>
+<html>
+<head>
+  <meta charset="utf-8">
+  <script>
+    // https://html.spec.whatwg.org/multipage/scripting.html#custom-elements-autonomous-example
+
+    class TestCustomElement extends HTMLElement {
+      constructor() {
+        super();
+      }
+
+      connectedCallback() {
+        // Not including any content since with XBL all content is anonymous, and we want
+        // an apples to apples comparison. When we have access to Shadow DOM we can set up a
+        // comparison with content.
+      }
+    }
+
+    customElements.define("test-custom-element", TestCustomElement);
+  </script>
+  <script type="application/javascript">
+  const openerWin = opener.wrappedJSObject;
+  const ok = openerWin.ok.bind(openerWin);
+  const NUM_ITERATIONS = openerWin.NUM_ITERATIONS;
+  const NUM_ELEMENTS = openerWin.NUM_ELEMENTS;
+
+  function run() {
+    let container = document.getElementById("element-container");
+    let iterationTimes = [];
+
+    for (var i = 0; i < NUM_ITERATIONS; i++) {
+      const measure = openerWin.startMeasure("custom elements");
+      for (var j = 0; j < NUM_ELEMENTS; j++) {
+        var element = document.createElement("test-custom-element");
+        container.appendChild(element);
+      }
+      const {duration} = measure.stop();
+      iterationTimes.push(duration);
+      container.innerHTML = '';
+    }
+
+    openerWin.customElementHTMLDone(iterationTimes);
+  }
+  </script>
+  <body onload="run()">
+    <div id="element-container"></div>
+  </body>
+</head>
\ No newline at end of file
diff --git a/dom/base/test/chrome/file_perf_customelement.xul b/dom/base/test/chrome/file_perf_customelement.xul
new file mode 100644
--- /dev/null
+++ b/dom/base/test/chrome/file_perf_customelement.xul
@@ -0,0 +1,55 @@
+<?xml version="1.0"?>
+<?xml-stylesheet href="chrome://global/skin" type="text/css"?>
+<?xml-stylesheet href="chrome://mochikit/content/tests/SimpleTest/test.css"
+                 type="text/css"?>
+<!--
+https://bugzilla.mozilla.org/show_bug.cgi?id=1209621
+-->
+<window title="Mozilla Bug 1209621"
+  xmlns="http://www.mozilla.org/keymaster/gatekeeper/there.is.only.xul"
+  onload="run()">
+  <label value="Mozilla Bug 1209621"/>
+  <script type="application/javascript" src="file_perf_customelement_polyfill_xul.js"></script>
+  <script type="application/javascript">
+  // https://html.spec.whatwg.org/multipage/scripting.html#custom-elements-autonomous-example
+
+  class TestCustomElement extends XULElement {
+    constructor() {
+      super();
+    }
+
+    connectedCallback() {
+      // Not including any content since with XBL all content is anonymous, and we want
+      // an apples to apples comparison. When we have access to Shadow DOM we can set up a
+      // comparison with content.
+    }
+  }
+
+  customElements.define("test-custom-element", TestCustomElement);
+  </script>
+  <script type="application/javascript"><![CDATA[
+  const openerWin = opener.wrappedJSObject;
+  const ok = openerWin.ok.bind(openerWin);
+  const NUM_ITERATIONS = openerWin.NUM_ITERATIONS;
+  const NUM_ELEMENTS = openerWin.NUM_ELEMENTS;
+
+  function run() {
+    let container = document.getElementById("element-container");
+    let iterationTimes = [];
+
+    for (var i = 0; i < NUM_ITERATIONS; i++) {
+      const measure = openerWin.startMeasure("custom elements");
+      for (var j = 0; j < NUM_ELEMENTS; j++) {
+        var element = document.createElement("test-custom-element");
+        container.appendChild(element);
+      }
+      const {duration} = measure.stop();
+      iterationTimes.push(duration);
+      container.innerHTML = '';
+    }
+
+    openerWin.customElementXULDone(iterationTimes);
+  }
+  ]]></script>
+  <box id="element-container"></box>
+</window>
\ No newline at end of file
diff --git a/dom/base/test/chrome/file_perf_customelement_polyfill_xul.js b/dom/base/test/chrome/file_perf_customelement_polyfill_xul.js
new file mode 100644
--- /dev/null
+++ b/dom/base/test/chrome/file_perf_customelement_polyfill_xul.js
@@ -0,0 +1,49 @@
+(function(){
+'use strict';var g={},h=new function(){};g.default=h;var k={},l=new Set("annotation-xml color-profile font-face font-face-src font-face-uri font-face-format font-face-name missing-glyph".split(" "));function m(b,a){for(;a&&a!==b&&!a.nextSibling;)a=a.parentNode;return a&&a!==b?a.nextSibling:null}
+function r(b,a,f){f=void 0===f?new Set:f;for(var c=b;c;){if(c.nodeType===Node.ELEMENT_NODE){var d=c;a(d);var e=d.localName;if("link"===e&&"import"===d.getAttribute("rel")){c=d.import;if(c instanceof Node&&!f.has(c))for(f.add(c),c=c.firstChild;c;c=c.nextSibling)r(c,a,f);c=m(b,d);continue}else if("template"===e){c=m(b,d);continue}if(d=d.__CE_shadowRoot)for(d=d.firstChild;d;d=d.nextSibling)r(d,a,f)}c=c.firstChild?c.firstChild:m(b,c)}}
+k.isValidCustomElementName=function(b){var a=l.has(b);b=/^[a-z][.0-9_a-z]*-[\-.0-9_a-z]*$/.test(b);return!a&&b};k.isConnected=function(b){var a=b.isConnected;if(void 0!==a)return a;for(;b&&!(b.__CE_isImportDocument||b instanceof Document);)b=b.parentNode||(window.ShadowRoot&&b instanceof ShadowRoot?b.host:void 0);return!(!b||!(b.__CE_isImportDocument||b instanceof Document))};k.walkDeepDescendantElements=r;k.setPropertyUnchecked=function(b,a,f){b[a]=f};var t={default:{custom:1,failed:2}};var u={};function v(){this._localNameToDefinition=new Map;this._constructorToDefinition=new Map;this._patches=[];this._hasPatches=!1}v.prototype.setDefinition=function(b,a){this._localNameToDefinition.set(b,a);this._constructorToDefinition.set(a.constructor,a)};v.prototype.localNameToDefinition=function(b){return this._localNameToDefinition.get(b)};v.prototype.constructorToDefinition=function(b){return this._constructorToDefinition.get(b)};v.prototype.addPatch=function(b){this._hasPatches=!0;this._patches.push(b)};
+v.prototype.patchTree=function(b){var a=this;this._hasPatches&&k.walkDeepDescendantElements(b,function(b){return a.patch(b)})};v.prototype.patch=function(b){if(this._hasPatches&&!b.__CE_patched){b.__CE_patched=!0;for(var a=0;a<this._patches.length;a++)this._patches[a](b)}};v.prototype.connectTree=function(b){var a=[];k.walkDeepDescendantElements(b,function(b){return a.push(b)});for(b=0;b<a.length;b++){var f=a[b];f.__CE_state===t.default.custom?this.connectedCallback(f):this.upgradeElement(f)}};
+v.prototype.disconnectTree=function(b){var a=[];k.walkDeepDescendantElements(b,function(b){return a.push(b)});for(b=0;b<a.length;b++){var f=a[b];f.__CE_state===t.default.custom&&this.disconnectedCallback(f)}};
+v.prototype.patchAndUpgradeTree=function(b,a){a=void 0===a?{}:a;var f=this,c=a.visitedImports||new Set,d=a.upgrade||function(b){return f.upgradeElement(b)},e=[];k.walkDeepDescendantElements(b,function(b){if("link"===b.localName&&"import"===b.getAttribute("rel")){var a=b.import;a instanceof Node&&"complete"===a.readyState?(a.__CE_isImportDocument=!0,a.__CE_hasRegistry=!0):b.addEventListener("load",function(){var a=b.import;a.__CE_documentLoadHandled||(a.__CE_documentLoadHandled=!0,a.__CE_isImportDocument=
+!0,a.__CE_hasRegistry=!0,new Set(c),c.delete(a),f.patchAndUpgradeTree(a,{visitedImports:c,upgrade:d}))})}else e.push(b)},c);if(this._hasPatches)for(b=0;b<e.length;b++)this.patch(e[b]);for(b=0;b<e.length;b++)d(e[b])};
+v.prototype.upgradeElement=function(b){if(void 0===b.__CE_state){var a=this.localNameToDefinition(b.localName);if(a){a.constructionStack.push(b);var f=a.constructor;try{try{if(new f!==b)throw Error("The custom element constructor did not produce the element being upgraded.");}finally{a.constructionStack.pop()}}catch(e){throw b.__CE_state=t.default.failed,e;}b.__CE_state=t.default.custom;b.__CE_definition=a;if(a.attributeChangedCallback)for(a=a.observedAttributes,f=0;f<a.length;f++){var c=a[f],d=b.getAttribute(c);
+null!==d&&this.attributeChangedCallback(b,c,null,d,null)}k.isConnected(b)&&this.connectedCallback(b)}}};v.prototype.connectedCallback=function(b){var a=b.__CE_definition;a.connectedCallback&&a.connectedCallback.call(b)};v.prototype.disconnectedCallback=function(b){var a=b.__CE_definition;a.disconnectedCallback&&a.disconnectedCallback.call(b)};
+v.prototype.attributeChangedCallback=function(b,a,f,c,d){var e=b.__CE_definition;e.attributeChangedCallback&&-1<e.observedAttributes.indexOf(a)&&e.attributeChangedCallback.call(b,a,f,c,d)};u.default=v;var w={};function x(b,a){this._internals=b;this._document=a;this._observer=void 0;this._internals.patchAndUpgradeTree(this._document);"loading"===this._document.readyState&&(this._observer=new MutationObserver(this._handleMutations.bind(this)),this._observer.observe(this._document,{childList:!0,subtree:!0}))}x.prototype.disconnect=function(){this._observer&&this._observer.disconnect()};
+x.prototype._handleMutations=function(b){var a=this._document.readyState;"interactive"!==a&&"complete"!==a||this.disconnect();for(a=0;a<b.length;a++)for(var f=b[a].addedNodes,c=0;c<f.length;c++)this._internals.patchAndUpgradeTree(f[c])};w.default=x;var y={};function z(){var b=this;this._resolve=this._value=void 0;this._promise=new Promise(function(a){b._resolve=a;b._value&&a(b._value)})}z.prototype.resolve=function(b){if(this._value)throw Error("Already resolved.");this._value=b;this._resolve&&this._resolve(b)};z.prototype.toPromise=function(){return this._promise};y.default=z;var A={};function B(b){this._elementDefinitionIsRunning=!1;this._internals=b;this._whenDefinedDeferred=new Map;this._flushCallback=function(b){return b()};this._flushPending=!1;this._pendingDefinitions=[];this._documentConstructionObserver=new w.default(b,document)}
+B.prototype.define=function(b,a){var f=this;if(!(a instanceof Function))throw new TypeError("Custom element constructors must be functions.");if(!k.isValidCustomElementName(b))throw new SyntaxError("The element name '"+b+"' is not valid.");if(this._internals.localNameToDefinition(b))throw Error("A custom element with name '"+b+"' has already been defined.");if(this._elementDefinitionIsRunning)throw Error("A custom element is already being defined.");this._elementDefinitionIsRunning=!0;var c,d,e,n,
+p;try{var q=function(b){var a=D[b];if(void 0!==a&&!(a instanceof Function))throw Error("The '"+b+"' callback must be a function.");return a},D=a.prototype;if(!(D instanceof Object))throw new TypeError("The custom element constructor's prototype is not an object.");c=q("connectedCallback");d=q("disconnectedCallback");e=q("adoptedCallback");n=q("attributeChangedCallback");p=a.observedAttributes||[]}catch(N){return}finally{this._elementDefinitionIsRunning=!1}this._pendingDefinitions.push({localName:b,
+constructor:a,connectedCallback:c,disconnectedCallback:d,adoptedCallback:e,attributeChangedCallback:n,observedAttributes:p,constructionStack:[]});this._flushPending||(this._flushPending=!0,this._flushCallback(function(){return f._flush()}))};
+B.prototype._flush=function(){var b=this;if(!1!==this._flushPending){this._flushPending=!1;for(var a=this._pendingDefinitions,f=new Map,c=0;c<a.length;c++)f.set(a[c].localName,[]);for(this._internals.patchAndUpgradeTree(document,{upgrade:function(a){b._internals.upgradeElement(a);if(void 0===a.__CE_state){var d=f.get(a.localName);d&&d.push(a)}}});0<a.length;){var d=a.shift(),c=d.localName;this._internals.setDefinition(c,d);for(var d=f.get(d.localName),e=0;e<d.length;e++)this._internals.upgradeElement(d[e]);
+(c=this._whenDefinedDeferred.get(c))&&c.resolve(void 0)}}};B.prototype.get=function(b){if(b=this._internals.localNameToDefinition(b))return b.constructor};
+B.prototype.whenDefined=function(b){if(!k.isValidCustomElementName(b))return Promise.reject(new SyntaxError("'"+b+"' is not a valid custom element name."));var a=this._whenDefinedDeferred.get(b);if(a)return a.toPromise();a=new y.default;this._whenDefinedDeferred.set(b,a);this._internals.localNameToDefinition(b)&&!this._pendingDefinitions.some(function(a){return a.localName===b})&&a.resolve(void 0);return a.toPromise()};
+B.prototype.polyfillWrapFlushCallback=function(b){this._documentConstructionObserver.disconnect();var a=this._flushCallback;this._flushCallback=function(f){return b(function(){return a(f)})}};window.CustomElementRegistry=B;B.prototype.define=B.prototype.define;B.prototype.get=B.prototype.get;B.prototype.whenDefined=B.prototype.whenDefined;B.prototype.polyfillWrapFlushCallback=B.prototype.polyfillWrapFlushCallback;A.default=B;var C={},E={Document_createElement:window.Document.prototype.createElement,Document_createElementNS:window.Document.prototype.createElementNS,Document_importNode:window.Document.prototype.importNode,Document_prepend:window.Document.prototype.prepend,Document_append:window.Document.prototype.append,Node_cloneNode:window.Node.prototype.cloneNode,Node_appendChild:window.Node.prototype.appendChild,Node_insertBefore:window.Node.prototype.insertBefore,Node_removeChild:window.Node.prototype.removeChild,
+Node_replaceChild:window.Node.prototype.replaceChild,Node_textContent:Object.getOwnPropertyDescriptor(window.Node.prototype,"textContent"),Element_attachShadow:window.Element.prototype.attachShadow,Element_innerHTML:Object.getOwnPropertyDescriptor(window.Element.prototype,"innerHTML"),Element_getAttribute:window.Element.prototype.getAttribute,Element_setAttribute:window.Element.prototype.setAttribute,Element_removeAttribute:window.Element.prototype.removeAttribute,Element_getAttributeNS:window.Element.prototype.getAttributeNS,
+Element_setAttributeNS:window.Element.prototype.setAttributeNS,Element_removeAttributeNS:window.Element.prototype.removeAttributeNS,Element_insertAdjacentElement:window.Element.prototype.insertAdjacentElement,Element_prepend:window.Element.prototype.prepend,Element_append:window.Element.prototype.append,Element_before:window.Element.prototype.before,Element_after:window.Element.prototype.after,Element_replaceWith:window.Element.prototype.replaceWith,Element_remove:window.Element.prototype.remove,
+XULElement:window.XULElement,XULElement_innerHTML:Object.getOwnPropertyDescriptor(window.XULElement.prototype,"innerHTML"),XULElement_insertAdjacentElement:window.XULElement.prototype.insertAdjacentElement};C.default=E;var F={default:function(b){window.XULElement=function(){function a(){var a=this.constructor,c=b.constructorToDefinition(a);if(!c)throw Error("The custom element being constructed was not registered with `customElements`.");var d=c.constructionStack;if(0===d.length)return d=C.default.Document_createElement.call(document,c.localName),Object.setPrototypeOf(d,a.prototype),d.__CE_state=t.default.custom,d.__CE_definition=c,b.patch(d),d;var c=d.length-1,e=d[c];if(e===g.default)throw Error("The XULElement constructor was either called reentrantly for this constructor or called multiple times.");
+d[c]=g.default;Object.setPrototypeOf(e,a.prototype);b.patch(e);return e}a.prototype=C.default.XULElement.prototype;return a}()}};var G={default:function(b,a,f){a.prepend=function(a){for(var d=[],e=0;e<arguments.length;++e)d[e-0]=arguments[e];e=d.filter(function(b){return b instanceof Node&&k.isConnected(b)});f.prepend.apply(this,d);for(var c=0;c<e.length;c++)b.disconnectTree(e[c]);if(k.isConnected(this))for(e=0;e<d.length;e++)c=d[e],c instanceof Element&&b.connectTree(c)};a.append=function(a){for(var d=[],e=0;e<arguments.length;++e)d[e-0]=arguments[e];e=d.filter(function(b){return b instanceof Node&&k.isConnected(b)});f.append.apply(this,
+d);for(var c=0;c<e.length;c++)b.disconnectTree(e[c]);if(k.isConnected(this))for(e=0;e<d.length;e++)c=d[e],c instanceof Element&&b.connectTree(c)}}};var H={default:function(b){k.setPropertyUnchecked(Document.prototype,"createElement",function(a){if(this.__CE_hasRegistry){var f=b.localNameToDefinition(a);if(f)return new f.constructor}a=C.default.Document_createElement.call(this,a);b.patch(a);return a});k.setPropertyUnchecked(Document.prototype,"importNode",function(a,f){a=C.default.Document_importNode.call(this,a,f);this.__CE_hasRegistry?b.patchAndUpgradeTree(a):b.patchTree(a);return a});k.setPropertyUnchecked(Document.prototype,"createElementNS",
+function(a,f){if(this.__CE_hasRegistry&&(null===a||"http://www.w3.org/1999/xhtml"===a)){var c=b.localNameToDefinition(f);if(c)return new c.constructor}a=C.default.Document_createElementNS.call(this,a,f);b.patch(a);return a});G.default(b,Document.prototype,{prepend:C.default.Document_prepend,append:C.default.Document_append})}};var I={default:function(b){function a(a,c){Object.defineProperty(a,"textContent",{enumerable:c.enumerable,configurable:!0,get:c.get,set:function(a){if(this.nodeType===Node.TEXT_NODE)c.set.call(this,a);else{var d=void 0;if(this.firstChild){var f=this.childNodes,p=f.length;if(0<p&&k.isConnected(this))for(var d=Array(p),q=0;q<p;q++)d[q]=f[q]}c.set.call(this,a);if(d)for(a=0;a<d.length;a++)b.disconnectTree(d[a])}}})}k.setPropertyUnchecked(Node.prototype,"insertBefore",function(a,c){if(a instanceof DocumentFragment){var d=
+Array.prototype.slice.apply(a.childNodes);a=C.default.Node_insertBefore.call(this,a,c);if(k.isConnected(this))for(c=0;c<d.length;c++)b.connectTree(d[c]);return a}d=k.isConnected(a);c=C.default.Node_insertBefore.call(this,a,c);d&&b.disconnectTree(a);k.isConnected(this)&&b.connectTree(a);return c});k.setPropertyUnchecked(Node.prototype,"appendChild",function(a){if(a instanceof DocumentFragment){var c=Array.prototype.slice.apply(a.childNodes);a=C.default.Node_appendChild.call(this,a);if(k.isConnected(this))for(var d=
+0;d<c.length;d++)b.connectTree(c[d]);return a}c=k.isConnected(a);d=C.default.Node_appendChild.call(this,a);c&&b.disconnectTree(a);k.isConnected(this)&&b.connectTree(a);return d});k.setPropertyUnchecked(Node.prototype,"cloneNode",function(a){a=C.default.Node_cloneNode.call(this,a);this.ownerDocument.__CE_hasRegistry?b.patchAndUpgradeTree(a):b.patchTree(a);return a});k.setPropertyUnchecked(Node.prototype,"removeChild",function(a){var c=k.isConnected(a),d=C.default.Node_removeChild.call(this,a);c&&b.disconnectTree(a);
+return d});k.setPropertyUnchecked(Node.prototype,"replaceChild",function(a,c){if(a instanceof DocumentFragment){var d=Array.prototype.slice.apply(a.childNodes);a=C.default.Node_replaceChild.call(this,a,c);if(k.isConnected(this))for(b.disconnectTree(c),c=0;c<d.length;c++)b.connectTree(d[c]);return a}var d=k.isConnected(a),e=C.default.Node_replaceChild.call(this,a,c),f=k.isConnected(this);f&&b.disconnectTree(c);d&&b.disconnectTree(a);f&&b.connectTree(a);return e});C.default.Node_textContent&&C.default.Node_textContent.get?
+a(Node.prototype,C.default.Node_textContent):b.addPatch(function(b){a(b,{enumerable:!0,configurable:!0,get:function(){for(var a=[],b=0;b<this.childNodes.length;b++)a.push(this.childNodes[b].textContent);return a.join("")},set:function(a){for(;this.firstChild;)C.default.Node_removeChild.call(this,this.firstChild);C.default.Node_appendChild.call(this,document.createTextNode(a))}})})}};var J={default:function(b,a,f){a.before=function(a){for(var d=[],e=0;e<arguments.length;++e)d[e-0]=arguments[e];e=d.filter(function(a){return a instanceof Node&&k.isConnected(a)});f.before.apply(this,d);for(var c=0;c<e.length;c++)b.disconnectTree(e[c]);if(k.isConnected(this))for(e=0;e<d.length;e++)c=d[e],c instanceof Element&&b.connectTree(c)};a.after=function(a){for(var d=[],e=0;e<arguments.length;++e)d[e-0]=arguments[e];e=d.filter(function(a){return a instanceof Node&&k.isConnected(a)});f.after.apply(this,
+d);for(var c=0;c<e.length;c++)b.disconnectTree(e[c]);if(k.isConnected(this))for(e=0;e<d.length;e++)c=d[e],c instanceof Element&&b.connectTree(c)};a.replaceWith=function(a){for(var d=[],c=0;c<arguments.length;++c)d[c-0]=arguments[c];var c=d.filter(function(a){return a instanceof Node&&k.isConnected(a)}),n=k.isConnected(this);f.replaceWith.apply(this,d);for(var p=0;p<c.length;p++)b.disconnectTree(c[p]);if(n)for(b.disconnectTree(this),c=0;c<d.length;c++)n=d[c],n instanceof Element&&b.connectTree(n)};
+a.remove=function(){var a=k.isConnected(this);f.remove.call(this);a&&b.disconnectTree(this)}}};var K={default:function(b){function a(a,c){Object.defineProperty(a,"innerHTML",{enumerable:c.enumerable,configurable:!0,get:c.get,set:function(a){var d=this,e=void 0;k.isConnected(this)&&(e=[],k.walkDeepDescendantElements(this,function(a){a!==d&&e.push(a)}));c.set.call(this,a);if(e)for(var f=0;f<e.length;f++){var n=e[f];n.__CE_state===t.default.custom&&b.disconnectedCallback(n)}this.ownerDocument.__CE_hasRegistry?b.patchAndUpgradeTree(this):b.patchTree(this);return a}})}function f(a,c){k.setPropertyUnchecked(a,
+"insertAdjacentElement",function(a,d){var e=k.isConnected(d);a=c.call(this,a,d);e&&b.disconnectTree(d);k.isConnected(a)&&b.connectTree(d);return a})}C.default.Element_attachShadow?k.setPropertyUnchecked(Element.prototype,"attachShadow",function(a){return this.__CE_shadowRoot=a=C.default.Element_attachShadow.call(this,a)}):console.warn("Custom Elements: `Element#attachShadow` was not patched.");if(C.default.Element_innerHTML&&C.default.Element_innerHTML.get)a(Element.prototype,C.default.Element_innerHTML);
+else if(C.default.XULElement_innerHTML&&C.default.XULElement_innerHTML.get)a(XULElement.prototype,C.default.XULElement_innerHTML);else{var c=C.default.Document_createElement.call(document,"div");b.addPatch(function(b){a(b,{enumerable:!0,configurable:!0,get:function(){return C.default.Node_cloneNode.call(this,!0).innerHTML},set:function(a){var b="template"===this.localName?this.content:this;for(c.innerHTML=a;0<b.childNodes.length;)C.default.Node_removeChild.call(b,b.childNodes[0]);for(;0<c.childNodes.length;)C.default.Node_appendChild.call(b,
+c.childNodes[0])}})})}k.setPropertyUnchecked(Element.prototype,"setAttribute",function(a,c){if(this.__CE_state!==t.default.custom)return C.default.Element_setAttribute.call(this,a,c);var d=C.default.Element_getAttribute.call(this,a);C.default.Element_setAttribute.call(this,a,c);c=C.default.Element_getAttribute.call(this,a);b.attributeChangedCallback(this,a,d,c,null)});k.setPropertyUnchecked(Element.prototype,"setAttributeNS",function(a,c,f){if(this.__CE_state!==t.default.custom)return C.default.Element_setAttributeNS.call(this,
+a,c,f);var d=C.default.Element_getAttributeNS.call(this,a,c);C.default.Element_setAttributeNS.call(this,a,c,f);f=C.default.Element_getAttributeNS.call(this,a,c);b.attributeChangedCallback(this,c,d,f,a)});k.setPropertyUnchecked(Element.prototype,"removeAttribute",function(a){if(this.__CE_state!==t.default.custom)return C.default.Element_removeAttribute.call(this,a);var c=C.default.Element_getAttribute.call(this,a);C.default.Element_removeAttribute.call(this,a);null!==c&&b.attributeChangedCallback(this,
+a,c,null,null)});k.setPropertyUnchecked(Element.prototype,"removeAttributeNS",function(a,c){if(this.__CE_state!==t.default.custom)return C.default.Element_removeAttributeNS.call(this,a,c);var d=C.default.Element_getAttributeNS.call(this,a,c);C.default.Element_removeAttributeNS.call(this,a,c);var e=C.default.Element_getAttributeNS.call(this,a,c);d!==e&&b.attributeChangedCallback(this,c,d,e,a)});C.default.XULElement_insertAdjacentElement?f(XULElement.prototype,C.default.XULElement_insertAdjacentElement):
+C.default.Element_insertAdjacentElement?f(Element.prototype,C.default.Element_insertAdjacentElement):console.warn("Custom Elements: `Element#insertAdjacentElement` was not patched.");G.default(b,Element.prototype,{prepend:C.default.Element_prepend,append:C.default.Element_append});J.default(b,Element.prototype,{before:C.default.Element_before,after:C.default.Element_after,replaceWith:C.default.Element_replaceWith,remove:C.default.Element_remove})}};/*
+
+ Copyright (c) 2016 The Polymer Project Authors. All rights reserved.
+ This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
+ The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
+ The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
+ Code distributed by Google as part of the polymer project is also
+ subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
+*/
+var L=window.customElements;if(!L||L.forcePolyfill||"function"!=typeof L.define||"function"!=typeof L.get){var M=new u.default;F.default(M);H.default(M);I.default(M);K.default(M);document.__CE_hasRegistry=!0;var customElements=new A.default(M);Object.defineProperty(window,"customElements",{configurable:!0,enumerable:!0,value:customElements})};
+}).call(self);
+
+//# sourceMappingURL=custom-elements.min.js.map
diff --git a/dom/base/test/chrome/file_perf_xbl.xul b/dom/base/test/chrome/file_perf_xbl.xul
new file mode 100644
--- /dev/null
+++ b/dom/base/test/chrome/file_perf_xbl.xul
@@ -0,0 +1,43 @@
+<?xml version="1.0"?>
+<?xml-stylesheet href="chrome://global/skin" type="text/css"?>
+<?xml-stylesheet href="chrome://mochikit/content/tests/SimpleTest/test.css"
+                 type="text/css"?>
+<!--
+https://bugzilla.mozilla.org/show_bug.cgi?id=1209621
+-->
+<window title="Mozilla Bug 1209621"
+  xmlns="http://www.mozilla.org/keymaster/gatekeeper/there.is.only.xul"
+  onload="run()">
+  <label value="Mozilla Bug 1209621"/>
+  <style xmlns="http://www.w3.org/1999/xhtml">
+  foo {
+    -moz-binding: url("file_perf_xbl_bindings.xml#test");
+  }
+  </style>
+  <script type="application/javascript"><![CDATA[
+  const openerWin = opener.wrappedJSObject;
+  const ok = openerWin.ok.bind(openerWin);
+  const NUM_ITERATIONS = openerWin.NUM_ITERATIONS;
+  const NUM_ELEMENTS = openerWin.NUM_ELEMENTS;
+
+  function run() {
+    let container = document.getElementById("element-container");
+      let iterationTimes = [];
+
+    for (var i = 0; i < NUM_ITERATIONS; i++) {
+      const measure = openerWin.startMeasure("xbl elements");
+      for (var j = 0; j < NUM_ELEMENTS; j++) {
+        var element = document.createElement("foo");
+        container.appendChild(element);
+      }
+      const {duration} = measure.stop();
+      iterationTimes.push(duration);
+      container.innerHTML = '';
+    }
+
+    openerWin.xblDone(iterationTimes);
+  }
+  ]]></script>
+  <box id="element-container"></box>
+
+</window>
diff --git a/dom/base/test/chrome/file_perf_xbl_bindings.xml b/dom/base/test/chrome/file_perf_xbl_bindings.xml
new file mode 100644
--- /dev/null
+++ b/dom/base/test/chrome/file_perf_xbl_bindings.xml
@@ -0,0 +1,11 @@
+<?xml version="1.0"?>
+<!-- This Source Code Form is subject to the terms of the Mozilla Public
+   - License, v. 2.0. If a copy of the MPL was not distributed with this
+   - file, You can obtain one at http://mozilla.org/MPL/2.0/. -->
+<bindings xmlns="http://www.mozilla.org/xbl"
+          xmlns:html="http://www.w3.org/1999/xhtml"
+          xmlns:xul="http://www.mozilla.org/keymaster/gatekeeper/there.is.only.xul"
+          xmlns:xbl="http://www.mozilla.org/xbl">
+    <binding id="test">
+    </binding>
+</bindings>
diff --git a/dom/base/test/chrome/test_perf_xbl_vs_customelement.xul b/dom/base/test/chrome/test_perf_xbl_vs_customelement.xul
new file mode 100644
--- /dev/null
+++ b/dom/base/test/chrome/test_perf_xbl_vs_customelement.xul
@@ -0,0 +1,161 @@
+<?xml version="1.0"?>
+<?xml-stylesheet type="text/css" href="chrome://global/skin"?>
+<?xml-stylesheet type="text/css" href="chrome://mochikit/content/tests/SimpleTest/test.css"?>
+<!--
+https://bugzilla.mozilla.org/show_bug.cgi?id=1387125
+-->
+<window title="Mozilla Bug 1387125"
+        xmlns="http://www.mozilla.org/keymaster/gatekeeper/there.is.only.xul">
+  <script type="application/javascript" src="chrome://mochikit/content/tests/SimpleTest/SimpleTest.js"/>
+
+  <!-- test results are displayed in the html:body -->
+  <body xmlns="http://www.w3.org/1999/xhtml">
+  <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1387125"
+     target="_blank">Mozilla Bug 1387125</a>
+  </body>
+
+  <!-- test code goes here -->
+  <script type="application/javascript">
+  <![CDATA[
+  /** Test for Bug 1387125 **/
+
+  Components.utils.import("resource://gre/modules/FileUtils.jsm");
+  Components.utils.import("resource://gre/modules/Services.jsm");
+  window.NUM_ELEMENTS = 1000;
+  window.NUM_ITERATIONS = 5;
+
+  let xblWindow;
+  let customElementXULWindow;
+  let customElementHTMLWindow;
+  let xblTimes;
+  let customElementXULTimes;
+  let customElementHTMLTimes;
+
+  SimpleTest.waitForExplicitFinish();
+
+  function startMeasure(label) {
+    const startLabel = label + "start";
+    performance.mark(startLabel);
+    return {
+      stop: (clear = true) => {
+        performance.measure(label, startLabel);
+        const entries = performance.getEntriesByName(label);
+        if (clear) {
+          performance.clearMeasures(label);
+        }
+        return entries[entries.length - 1];
+      }
+    };
+  }
+
+  function getTimes(times) {
+    times = times.sort();
+    let totalTime = times.reduce((sum, t) => sum + t);
+    let min = times[0];
+    let max = times[times.length - 1];
+    let avg = totalTime / times.length;
+    let median = times.length % 2 !== 0
+      ? times[Math.floor(times.length / 2)]
+      : (times[(times.length / 2) - 1] + times[times.length / 2]) / 2;
+
+    return {
+      avg: Math.round(avg * 100) / 100,
+      median: Math.round(median * 100) / 100,
+      min: Math.round(min * 100) / 100,
+      max: Math.round(max * 100) / 100,
+    };
+  }
+
+  function printTimes(label, times) {
+    let {avg, median, min, max} = times;
+    let avgPerElement = Math.round(avg / NUM_ELEMENTS * 1000) / 1000;
+
+    info(`${label}: On average, it took ${avg} ms to create ${NUM_ELEMENTS} elements (median ${median} ms, max ${max} ms, min ${min} ms, per element ${avgPerElement} ms)`);
+  }
+
+  function wait(time) {
+    return new Promise(resolve => setTimeout(resolve, time));
+  }
+
+  async function xblDone(times) {
+    xblTimes = getTimes(times);
+    xblWindow.close();
+    done();
+  }
+  async function customElementHTMLDone(times) {
+    customElementHTMLTimes = getTimes(times);
+    customElementHTMLWindow.close();
+
+    await SpecialPowers.pushPrefEnv({ set: [
+      [ "dom.webcomponents.customelements.enabled", false ],
+      [ "dom.webcomponents.enabled", false ],
+    ]});
+
+    await wait(500);
+    customElementXULWindow = window.open("file_perf_customelement.xul", "", "chrome,width=600,height=400");
+  }
+  async function customElementXULDone(times) {
+    customElementXULTimes = getTimes(times);
+    customElementXULWindow.close();
+    await wait(500);
+    xblWindow = window.open("file_perf_xbl.xul", "", "chrome,width=600,height=400");
+  }
+  addLoadEvent(async function() {
+    await SpecialPowers.pushPrefEnv({ set: [
+      [ "dom.webcomponents.customelements.enabled", true ],
+      [ "dom.webcomponents.enabled", true ],
+    ]});
+
+    // From https://github.com/devtools-html/perf.html/blob/b73eb73df04c7df51464fa50eeadef3dc7f5d4e2/docs/gecko-profile-format.md#L21
+    const settings = {
+      entries: 100000000,
+      interval: 1,
+      features: ["js", "stackwalk", "threads", "leaf"],
+      threads: ["GeckoMain", "Compositor"]
+    };
+    Services.profiler.StartProfiler(
+      settings.entries,
+      settings.interval,
+      settings.features,
+      settings.features.length,
+      settings.threads,
+      settings.threads.length
+    );
+
+    info("Profiler has started");
+    await wait(500);
+
+    customElementHTMLWindow = window.open("file_perf_customelement.html", "", "chrome,width=600,height=400");
+  });
+
+  async function done() {
+    ok(true, "done");
+
+    printTimes("XBL", xblTimes);
+    printTimes("CUSTOM ELEMENTS (XUL)", customElementXULTimes);
+    printTimes("CUSTOM ELEMENTS (HTML)", customElementHTMLTimes);
+
+    let file = FileUtils.getFile("TmpD", [`test_perf_xbl_vs_customelement_${Date.now()}.json`]);
+    // Use dumpProfileToFileAsync once https://bugzilla.mozilla.org/show_bug.cgi?id=1387155 is done
+    await Services.profiler.dumpProfileToFileAsync(file.path);
+    Services.profiler.StopProfiler();
+
+info(`
+
+SAVING PROFILE: ${file.path}
+
+To upload the profile, run the following commands:
+
+  gzip ${file.path}
+  curl 'https://profile-store.appspot.com/compressed-store' --compressed --data-binary @${file.path}.gz | awk '{print "Hosted at: https://perf-html.io/public/"$1}'
+
+
+`);
+
+
+    SimpleTest.finish();
+  }
+
+  ]]>
+  </script>
+</window>
