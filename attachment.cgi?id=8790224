# HG changeset patch
# User Christoph Kerschbaumer <ckerschb@christophkerschbaumer.com>
# Date 1473673831 -7200
#      Mon Sep 12 11:50:31 2016 +0200
# Node ID afc76b293b6ecec9b52296980b85c86b27c42aed
# Parent  cfdb7af3af2e92e95f71ca2f1672bf5433beeb89
Bug 1296027 - CSP: Include 'Source' within error message when logging to the console. r=freddyb

diff --git a/dom/security/nsCSPUtils.cpp b/dom/security/nsCSPUtils.cpp
--- a/dom/security/nsCSPUtils.cpp
+++ b/dom/security/nsCSPUtils.cpp
@@ -139,16 +139,28 @@ CSP_LogMessage(const nsAString& aMessage
     return;
   }
 
   // Prepending CSP to the outgoing console message
   nsString cspMsg;
   cspMsg.Append(NS_LITERAL_STRING("Content Security Policy: "));
   cspMsg.Append(aMessage);
 
+  // Currently 'aSourceLine' is not logged to the console, because similar
+  // information is already included within the source link of the message.
+  // For inline violations however, the line and column number are 0 and
+  // information contained within 'aSourceLine' can be really useful for devs.
+  // E.g. 'aSourceLine' might be: 'onclick attribute on DIV element'.
+  // In such cases we append 'aSourceLine' directly to the error message.
+  if (!aSourceLine.IsEmpty()) {
+    cspMsg.AppendASCII(" Source: ");
+    cspMsg.Append(aSourceLine);
+    cspMsg.AppendASCII(".");
+  }
+
   nsresult rv;
   if (aInnerWindowID > 0) {
     nsCString catStr;
     catStr.AssignASCII(aCategory);
     rv = error->InitWithWindowID(cspMsg, aSourceName,
                                  aSourceLine, aLineNumber,
                                  aColumnNumber, aFlags,
                                  catStr, aInnerWindowID);
