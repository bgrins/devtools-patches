# HG changeset patch
# User Brian Grinstead <bgrinstead@mozilla.com>
# Date 1557934746 25200
#      Wed May 15 08:39:06 2019 -0700
# Node ID 1493b89c5e708100fa53ab3e6da0729fd165b82c
# Parent  db99095ae0b53c30927add34be3dc20a7bdcb52e
Bug 1551412 - Workaround popupshowing event not being captured outside of Shadow DOM for rendering <menuitem>

Just in case we don't come up with a more robust fix before the merge, this fixes
the saved logins and edit bookmark textbox context menus.

Differential Revision: https://phabricator.services.mozilla.com/D31271

diff --git a/toolkit/content/widgets/textbox.js b/toolkit/content/widgets/textbox.js
--- a/toolkit/content/widgets/textbox.js
+++ b/toolkit/content/widgets/textbox.js
@@ -76,16 +76,20 @@ class MozInputBox extends MozXULElement 
     }
 
     this.setAttribute("context", "_child");
     this.appendChild(this.spellcheck ? cachedFragments.spellcheck.cloneNode(true) :
                                        cachedFragments.normal.cloneNode(true));
     this.menupopup = this.querySelector(".textbox-contextmenu");
 
     this.menupopup.addEventListener("popupshowing", event => {
+      // Bug 1551412 - Workaround popupshowing event not being captured outside of Shadow DOM (for trees).
+      for (let el of this.menupopup.querySelectorAll("menuitem")) {
+        el.render();
+      }
       var input = this.getElementsByAttribute("anonid", "input")[0];
       if (document.commandDispatcher.focusedElement != input)
         input.focus();
       this._doPopupItemEnabling(event.target);
     });
 
     if (this.spellcheck) {
       this.menupopup.addEventListener("popuphiding", event => {
