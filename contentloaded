# HG changeset patch
# User Brian Grinstead <bgrinstead@mozilla.com>
# Parent  c6662967ed2a655f1a9df189265584cd978bfaff
Bug 1482448 - Listen to DOMContentLoaded in xhtml

diff --git a/browser/base/content/browser.js b/browser/base/content/browser.js
--- a/browser/base/content/browser.js
+++ b/browser/base/content/browser.js
@@ -1139,19 +1139,25 @@ function RedirectLoad({ target: browser,
       }
     };
     Services.obs.addObserver(delayedStartupFinished,
                              "browser-delayed-startup-finished");
   }
 }
 
 if (document.documentElement.getAttribute("windowtype") == "navigator:browser") {
-  window.addEventListener("MozBeforeInitialXULLayout", () => {
-    gBrowserInit.onBeforeInitialXULLayout();
-  }, { once: true });
+  // In browser.xhtml, MozBeforeInitialXULLayout doesn't fire, and even if it did
+  // it would happen before this script runs.
+  let onBeforeInitialXULLayout = () => { gBrowserInit.onBeforeInitialXULLayout(); };
+  if (document.contentType == "application/xhtml+xml") {
+    window.addEventListener("DOMContentLoaded", onBeforeInitialXULLayout, { once: true });
+  } else {
+    window.addEventListener("MozBeforeInitialXULLayout", onBeforeInitialXULLayout, { once: true });
+  }
+
   // The listener of DOMContentLoaded must be set on window, rather than
   // document, because the window can go away before the event is fired.
   // In that case, we don't want to initialize anything, otherwise we
   // may be leaking things because they will never be destroyed after.
   window.addEventListener("DOMContentLoaded", () => {
     gBrowserInit.onDOMContentLoaded();
   }, { once: true });
 }
