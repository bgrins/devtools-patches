# HG changeset patch
# Parent f2dd17bf7498e7e8774121530eb567843e452488
# User Brian Grinstead <bgrinstead@mozilla.com>
asdf

diff --git a/browser/base/content/browser.xul b/browser/base/content/browser.xul
--- a/browser/base/content/browser.xul
+++ b/browser/base/content/browser.xul
@@ -716,17 +716,17 @@
                      enablehistory="true"
                      maxrows="6"
                      newlines="stripsurroundingwhitespace"
                      oninput="gBrowser.userTypedValue = this.value;"
                      ontextentered="this.handleCommand(param);"
                      ontextreverted="return this.handleRevert();"
                      pageproxystate="invalid"
                      onfocus="document.getElementById('identity-box').style.MozUserFocus= 'normal'"
-                     onblur="setTimeout(() => { document.getElementById('identity-box').style.MozUserFocus = ''; }, 0);">
+                     onblur="">
               <box id="notification-popup-box" hidden="true" align="center">
                 <image id="default-notification-icon" class="notification-anchor-icon" role="button"/>
                 <image id="identity-notification-icon" class="notification-anchor-icon" role="button"/>
                 <image id="geo-notification-icon" class="notification-anchor-icon" role="button"/>
                 <image id="addons-notification-icon" class="notification-anchor-icon" role="button"/>
                 <image id="indexedDB-notification-icon" class="notification-anchor-icon" role="button"/>
                 <image id="password-notification-icon" class="notification-anchor-icon" role="button"/>
                 <image id="webapps-notification-icon" class="notification-anchor-icon" role="button"/>
diff --git a/browser/components/search/content/search.xml b/browser/components/search/content/search.xml
--- a/browser/components/search/content/search.xml
+++ b/browser/components/search/content/search.xml
@@ -25,16 +25,17 @@
       <xul:stringbundle src="chrome://browser/locale/search.properties"
                         anonid="searchbar-stringbundle"/>
       <!--
       There is a dependency between "maxrows" attribute and
       "SuggestAutoComplete._historyLimit" (nsSearchSuggestions.js). Changing
       one of them requires changing the other one.
       -->
       <xul:textbox class="searchbar-textbox"
+                   id="searchbar-textbox"
                    anonid="searchbar-textbox"
                    type="autocomplete"
                    flex="1"
                    autocompletepopup="PopupAutoComplete"
                    autocompletesearch="search-autocomplete"
                    autocompletesearchparam="searchbar-history"
                    maxrows="10"
                    completeselectedindex="true"
@@ -324,22 +325,22 @@
           // if needed.
           if (this._needToBuildPopup)
             this.rebuildPopup();
 
           var popup = this._popup;
           // Clear any addengine menuitems, including addengine-item entries and
           // the addengine-separator.  Work backward to avoid invalidating the
           // indexes as items are removed.
-          var items = popup.childNodes;
-          for (var i = items.length - 1; i >= 0; i--) {
-            if (items[i].classList.contains("addengine-item") ||
-                items[i].classList.contains("addengine-separator"))
-              popup.removeChild(items[i]);
-          }
+          //var items = popup.childNodes;
+          //for (var i = items.length - 1; i >= 0; i--) {
+          //  if (items[i].classList.contains("addengine-item") ||
+          //      items[i].classList.contains("addengine-separator"))
+          //    popup.removeChild(items[i]);
+          //}
 
           var addengines = getBrowser().mCurrentBrowser.engines;
           if (addengines && addengines.length > 0) {
             const kXULNS =
                "http://www.mozilla.org/keymaster/gatekeeper/there.is.only.xul";
 
             // Find the (first) separator in the remaining menu, or the first item
             // if no separators are present.
diff --git a/toolkit/components/autocomplete/nsAutoCompleteController.cpp b/toolkit/components/autocomplete/nsAutoCompleteController.cpp
--- a/toolkit/components/autocomplete/nsAutoCompleteController.cpp
+++ b/toolkit/components/autocomplete/nsAutoCompleteController.cpp
@@ -984,16 +984,17 @@ nsAutoCompleteController::OpenPopup()
   }
 
   return NS_OK;
 }
 
 nsresult
 nsAutoCompleteController::ClosePopup()
 {
+  return NS_OK;
   if (!mInput) {
     return NS_OK;
   }
 
   nsCOMPtr<nsIAutoCompleteInput> input(mInput);
 
   bool isOpen = false;
   input->GetPopupOpen(&isOpen);
diff --git a/toolkit/content/widgets/autocomplete.xml b/toolkit/content/widgets/autocomplete.xml
--- a/toolkit/content/widgets/autocomplete.xml
+++ b/toolkit/content/widgets/autocomplete.xml
@@ -84,16 +84,18 @@
             popup = document.createElement("panel");
             popup.setAttribute("type", "autocomplete");
             popup.setAttribute("noautofocus", "true");
 
             let popupset = document.getAnonymousElementByAttribute(this, "anonid", "popupset");
             popupset.appendChild(popup);
           }
           popup.mInput = this;
+          popup.setAttribute("fooSelector", this.id);
+          //popup.setAttribute("noautohide", "true");
           popup;
         }
       ]]></field>
 
       <property name="controller" onget="return this.mController;" readonly="true"/>
 
       <property name="popupOpen"
                 onget="return this.popup.popupOpen;"
