# HG changeset patch
# User Brian Grinstead <bgrinstead@mozilla.com>
# Parent  9f6550c5c988855efe285c1499e1834fca902c69

diff --git a/browser/components/search/content/searchbar.js b/browser/components/search/content/searchbar.js
--- a/browser/components/search/content/searchbar.js
+++ b/browser/components/search/content/searchbar.js
@@ -437,31 +437,31 @@ class MozSearchbar extends MozXULElement
       // textbox, that will be taken care of in the click handler.
       if (Services.focus.getLastFocusMethod(window) & Services.focus.FLAG_BYMOUSE)
         return;
 
       this.openSuggestionsPanel();
     }, true);
 
     this.addEventListener("mousedown", (event) => {
-      if (event.originalTarget.classList.contains(".searchbar-search-button")) {
+      if (event.originalTarget.closest("searchbar-search-button")) {
         this._clickClosedPopup = this._textbox.popup._isHiding;
       }
     }, true);
 
     this.addEventListener("mousedown", (event) => {
       // Ignore clicks on the search go button.
       if (event.originalTarget.classList.contains("search-go-button")) {
         return;
       }
 
       let isIconClick = event.originalTarget.classList.contains("searchbar-search-button");
-
+      // console.log(this._textbox.popup.state, this._textbox.popup._isHiding, this._clickClosedPopup);
       // Ignore clicks on the icon if they were made to close the popup
-      if (isIconClick && this._clickClosedPopup) {
+      if (isIconClick && (this._textbox.popup._isHiding || this._clickClosedPopup)) {
         return;
       }
 
       // Open the suggestions whenever clicking on the search icon or if there
       // is text in the textbox.
       if (isIconClick || this._textbox.value) {
         this.openSuggestionsPanel(true);
       }
diff --git a/browser/components/search/test/browser_searchbar_openpopup.js b/browser/components/search/test/browser_searchbar_openpopup.js
--- a/browser/components/search/test/browser_searchbar_openpopup.js
+++ b/browser/components/search/test/browser_searchbar_openpopup.js
@@ -128,16 +128,17 @@ add_no_popup_task(async function open_ic
   await promise;
 });
 
 // With no text in the search box left clicking the icon should open the popup.
 // Clicking the icon again should hide the popup and not show it again.
 add_task(async function open_empty() {
   gURLBar.focus();
 
+
   let promise = promiseEvent(searchPopup, "popupshown");
   info("Clicking icon");
   EventUtils.synthesizeMouseAtCenter(searchIcon, {});
   await promise;
   is(searchPopup.getAttribute("showonlysettings"), "true", "Should only show the settings");
   is(textbox.mController.searchString, "", "Should be an empty search string");
 
   // By giving the textbox some text any next attempt to open the search popup
