# HG changeset patch
# User Brian Grinstead <bgrinstead@mozilla.com>
# Parent  7894e641adfa9f527b58b91ad2d194bd73ab18e5
Bug 1213932 - Service Worker logs in webconsole show up in all tabs (even ones that aren't on the same origin as the worker)

diff --git a/devtools/shared/webconsole/utils.js b/devtools/shared/webconsole/utils.js
--- a/devtools/shared/webconsole/utils.js
+++ b/devtools/shared/webconsole/utils.js
@@ -937,16 +937,26 @@ ConsoleAPIListener.prototype =
     let apiMessage = aMessage.wrappedJSObject;
     if (this.window && CONSOLE_WORKER_IDS.indexOf(apiMessage.innerID) == -1) {
       let msgWindow = Services.wm.getCurrentInnerWindowWithId(apiMessage.innerID);
       if (!msgWindow || !isWindowIncluded(this.window, msgWindow)) {
         // Not the same window!
         return;
       }
     }
+
+    if (this.window && apiMessage.innerID === "ServiceWorker") {
+      let swController = this.window &&
+                         this.window.navigator.serviceWorker.controller;
+     console.log("RECEIVED SW MESSAGE", swController && swController.scriptURL, apiMessage.ID)
+      if (!swController || apiMessage.ID !== swController.scriptURL) {
+        return;
+      }
+    }
+    // if (http://localhost/devtools-demos/worker/push-service-worker.js)
     if (this.consoleID && apiMessage.consoleID != this.consoleID) {
       return;
     }
 
     this.owner.onConsoleAPICall(apiMessage);
   },
 
   /**
@@ -971,17 +981,27 @@ ConsoleAPIListener.prototype =
     } else {
       let ids = WebConsoleUtils.getInnerWindowIDsForFrames(this.window);
       ids.forEach((id) => {
         messages = messages.concat(ConsoleAPIStorage.getEvents(id));
       });
     }
 
     CONSOLE_WORKER_IDS.forEach((id) => {
-      messages = messages.concat(ConsoleAPIStorage.getEvents(id));
+      let forWindow = ConsoleAPIStorage.getEvents(id).filter(m => {
+        // For messages from Service Workers, message.ID is the
+        // script URL for the worker.
+        if (id === "ServiceWorker") {
+          let swController = this.window &&
+                             this.window.navigator.serviceWorker.controller;
+          return swController && m.ID === swController.scriptURL;
+        }
+        return true;
+      });
+      messages = messages.concat(forWindow);
     });
 
     if (this.consoleID) {
       messages = messages.filter((m) => m.consoleID == this.consoleID);
     }
 
     if (aIncludePrivate) {
       return messages;
