Date:   Wed May 7 15:15:30 2014 +0200

Bug 987089 - Land Itchpad in browser/devtools part 2 - fxide support

diff --git a/browser/devtools/fxide/content/fxide.js b/browser/devtools/fxide/content/fxide.js
--- a/browser/devtools/fxide/content/fxide.js
+++ b/browser/devtools/fxide/content/fxide.js
@@ -10,16 +10,17 @@ Cu.import("resource:///modules/devtools/
 Cu.import("resource://gre/modules/Promise.jsm");
 
 const {devtools} = Cu.import("resource://gre/modules/devtools/Loader.jsm", {});
 const {require} = devtools;
 const {Services} = Cu.import("resource://gre/modules/Services.jsm");
 const {AppProjects} = require("devtools/app-manager/app-projects");
 const {Connection} = require("devtools/client/connection-manager");
 const {AppManager} = require("devtools/app-manager");
+const Itchpad = require("itchpad/itchpad");
 
 const Strings = Services.strings.createBundle("chrome://fxide/locale/fxide.properties");
 
 const HTML = "http://www.w3.org/1999/xhtml";
 
 window.addEventListener("load", function onLoad() {
   window.removeEventListener("load", onLoad);
   UI.init();
@@ -259,32 +260,68 @@ let UI = {
       buttonNode.classList.remove("no-project");
       labelNode.setAttribute("value", project.name);
       imageNode.setAttribute("src", project.icon);
     }
   },
 
   // details.xhtml
 
+  getItchpad: function() {
+    if (this.itchpad) {
+      return this.itchpad.loaded;
+    }
+
+    let itchpadIframe = document.querySelector("#itchpad");
+    this.itchpad = Itchpad.Itchpad(itchpadIframe);
+    this.itchpad.on("onEditorSave", (editor, resource) => {
+      AppManager.validateProject(AppManager.selectedProject);
+    });
+    return this.itchpad.loaded;
+  },
+
   openProject: function() {
-    let details = document.querySelector("#details");
+    let detailsIframe = document.querySelector("#details");
+    let itchpadIframe = document.querySelector("#itchpad");
+
     let project = AppManager.selectedProject;
 
     if (!project) {
-      details.setAttribute("hidden", "true");
+      detailsIframe.setAttribute("hidden", "true");
+      itchpadIframe.setAttribute("hidden", "true");
+      document.commandDispatcher.focusedElement = document.documentElement;
       return;
     }
 
     if (project.location) {
       Services.prefs.setCharPref("devtools.fxide.lastprojectlocation", project.location);
     }
 
-    details.removeAttribute("hidden");
+    if (project.type != "packaged") {
+      detailsIframe.removeAttribute("hidden");
+      itchpadIframe.setAttribute("hidden", "true");
+      document.commandDispatcher.focusedElement = document.documentElement;
+      return;
+    }
+
+    detailsIframe.setAttribute("hidden", "true");
+    itchpadIframe.removeAttribute("hidden");
+
+    this.getItchpad().then((itchpad) => {
+      itchpad.setProjectToSinglePath(project.location, {
+        name: project.name,
+        iconUrl: project.icon,
+        projectOverviewURL: "chrome://fxide/content/details.xhtml"
+      }).then(() => {
+        console.log("All resources have been loaded", [...itchpad.project.allResources()]);
+      });
+    }, UI.console.error);
   },
 
+
   /********** COMMANDS **********/
 
   updateCommands: function() {
 
     if (document.querySelector("window").classList.contains("busy")) {
       document.querySelector("#cmd_newApp").setAttribute("disabled", "true");
       document.querySelector("#cmd_importPackagedApp").setAttribute("disabled", "true");
       document.querySelector("#cmd_importHostedApp").setAttribute("disabled", "true");
diff --git a/browser/devtools/fxide/content/fxide.xul b/browser/devtools/fxide/content/fxide.xul
--- a/browser/devtools/fxide/content/fxide.xul
+++ b/browser/devtools/fxide/content/fxide.xul
@@ -146,16 +146,17 @@
         </vbox>
       </vbox>
     </panel>
 
   </popupset>
 
   <vbox flex="1" id="body">
     <iframe id="details" flex="1" hidden="true" src="details.xhtml"/>
+    <iframe id="itchpad" flex="1" hidden="true"/>
   </vbox>
 
   <splitter hidden="true" class="devtools-horizontal-splitter" orient="vertical"/>
 
   <!-- toolbox iframe will be inserted here -->
 
   <html:div id="logs-container">
     <html:pre id="logs"></html:pre>
