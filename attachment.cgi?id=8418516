# HG changeset patch
# User Gorman Ho <gormanchi@gmail.com>
# Date 1398571183 21600
#      Sat Apr 26 21:59:43 2014 -0600
# Node ID a447f6668aa15d5f1e82d39665a5899caa4f8176
# Parent 35c124cab3a89562af2e173ef17ed981625fa907
Bug 993416 - Adding "Paste Outer HTML" to the inspector context menu; r=bgrins

diff --git a/browser/devtools/inspector/inspector-panel.js b/browser/devtools/inspector/inspector-panel.js
--- a/browser/devtools/inspector/inspector-panel.js
+++ b/browser/devtools/inspector/inspector-panel.js
@@ -6,16 +6,17 @@
 
 const {Cc, Ci, Cu, Cr} = require("chrome");
 
 Cu.import("resource://gre/modules/Services.jsm");
 
 let promise = require("devtools/toolkit/deprecated-sync-thenables");
 let EventEmitter = require("devtools/toolkit/event-emitter");
 let {CssLogic} = require("devtools/styleinspector/css-logic");
+let clipboard = require("sdk/clipboard");
 
 loader.lazyGetter(this, "MarkupView", () => require("devtools/markupview/markup-view").MarkupView);
 loader.lazyGetter(this, "HTMLBreadcrumbs", () => require("devtools/inspector/breadcrumbs").HTMLBreadcrumbs);
 loader.lazyGetter(this, "ToolSidebar", () => require("devtools/framework/sidebar").ToolSidebar);
 loader.lazyGetter(this, "SelectorSearch", () => require("devtools/inspector/selector-search").SelectorSearch);
 
 const LAYOUT_CHANGE_TIMER = 250;
 
@@ -539,16 +540,32 @@ InspectorPanel.prototype = {
     this.nodemenu.openPopup(aButton, aPosition, 0, 0, true, false);
   },
 
   hideNodeMenu: function InspectorPanel_hideNodeMenu() {
     this.nodemenu.hidePopup();
   },
 
   /**
+   * Returns the clipboard content if it is appropriate for pasting
+   * into the current node's outer HTML, otherwise returns null.
+   */
+  _getClipboardContentForOuterHTML: function Inspector_getClipboardContentForOuterHTML() {
+    let flavors = clipboard.currentFlavors;
+    if (flavors.indexOf("text") != -1 ||
+        (flavors.indexOf("html") != -1 && flavors.indexOf("image") == -1)) {
+      let content = clipboard.get();
+      if (content && content.trim().length > 0) {
+        return content;
+      }
+    }
+    return null;
+  },
+
+  /**
    * Disable the delete item if needed. Update the pseudo classes.
    */
   _setupNodeMenu: function InspectorPanel_setupNodeMenu() {
     let isSelectionElement = this.selection.isElementNode();
 
     // Set the pseudo classes
     for (let name of ["hover", "active", "focus"]) {
       let menu = this.panelDoc.getElementById("node-menu-pseudo-" + name);
@@ -589,16 +606,27 @@ InspectorPanel.prototype = {
     // actor has the appropriate trait (isOuterHTMLEditable)
     let editHTML = this.panelDoc.getElementById("node-menu-edithtml");
     if (this.isOuterHTMLEditable && isSelectionElement) {
       editHTML.removeAttribute("disabled");
     } else {
       editHTML.setAttribute("disabled", "true");
     }
 
+    // Enable the "paste outer HTML" item if the selection is an element and
+    // the root actor has the appropriate trait (isOuterHTMLEditable) and if
+    // the clipbard content is appropriate.
+    let pasteOuterHTML = this.panelDoc.getElementById("node-menu-pasteouterhtml");
+    if (this.isOuterHTMLEditable && isSelectionElement &&
+        this._getClipboardContentForOuterHTML()) {
+      pasteOuterHTML.removeAttribute("disabled");
+    } else {
+      pasteOuterHTML.setAttribute("disabled", "true");
+    }
+
     // Enable the "copy image data-uri" item if the selection is previewable
     // which essentially checks if it's an image or canvas tag
     let copyImageData = this.panelDoc.getElementById("node-menu-copyimagedatauri");
     let markupContainer = this.markup.getContainer(this.selection.nodeFront);
     if (markupContainer && markupContainer.isPreviewable()) {
       copyImageData.removeAttribute("disabled");
     } else {
       copyImageData.setAttribute("disabled", "true");
@@ -706,16 +734,30 @@ InspectorPanel.prototype = {
       return;
     }
     if (this.markup) {
       this.markup.beginEditingOuterHTML(this.selection.nodeFront);
     }
   },
 
   /**
+   * Paste the contents of the clipboard into the selected Node's outer HTML.
+   */
+  pasteOuterHTML: function InspectorPanel_pasteOuterHTML()
+  {
+    let content = this._getClipboardContentForOuterHTML();
+    if (content) {
+      let node = this.selection.nodeFront;
+      this.markup.getNodeOuterHTML(node).then((oldContent) => {
+        this.markup.updateNodeOuterHTML(node, content, oldContent);
+      });
+    }
+  },
+
+  /**
    * Copy the innerHTML of the selected Node to the clipboard.
    */
   copyInnerHTML: function InspectorPanel_copyInnerHTML()
   {
     if (!this.selection.isNode()) {
       return;
     }
     this._copyLongStr(this.walker.innerHTML(this.selection.nodeFront));
diff --git a/browser/devtools/inspector/inspector.xul b/browser/devtools/inspector/inspector.xul
--- a/browser/devtools/inspector/inspector.xul
+++ b/browser/devtools/inspector/inspector.xul
@@ -51,16 +51,21 @@
       <menuitem id="node-menu-copyuniqueselector"
         label="&inspectorCopyUniqueSelector.label;"
         accesskey="&inspectorCopyUniqueSelector.accesskey;"
         oncommand="inspector.copyUniqueSelector()"/>
       <menuitem id="node-menu-copyimagedatauri"
         label="&inspectorCopyImageDataUri.label;"
         oncommand="inspector.copyImageDataUri()"/>
       <menuseparator/>
+      <menuitem id="node-menu-pasteouterhtml"
+        label="&inspectorHTMLPasteOuter.label;"
+        accesskey="&inspectorHTMLPasteOuter.accesskey;"
+        oncommand="inspector.pasteOuterHTML()"/>
+      <menuseparator/>
       <menuitem id="node-menu-delete"
         label="&inspectorHTMLDelete.label;"
         accesskey="&inspectorHTMLDelete.accesskey;"
         oncommand="inspector.deleteNode()"/>
       <menuseparator/>
       <menuitem id="node-menu-pseudo-hover"
         label=":hover" type="checkbox"
         oncommand="inspector.togglePseudoClass(':hover')"/>
diff --git a/browser/devtools/inspector/test/browser_inspector_menu.js b/browser/devtools/inspector/test/browser_inspector_menu.js
--- a/browser/devtools/inspector/test/browser_inspector_menu.js
+++ b/browser/devtools/inspector/test/browser_inspector_menu.js
@@ -1,14 +1,16 @@
 /* Any copyright is dedicated to the Public Domain.
 http://creativecommons.org/publicdomain/zero/1.0/ */
 
 
 function test() {
 
+  let clipboard = require("sdk/clipboard");
+
   waitForExplicitFinish();
 
   let doc;
   let inspector;
 
   gBrowser.selectedTab = gBrowser.addTab();
   gBrowser.selectedBrowser.addEventListener("load", function onload() {
     gBrowser.selectedBrowser.removeEventListener("load", onload, true);
@@ -36,16 +38,17 @@ function test() {
 
       // Right-click doctype tag
       contextMenuClick(docTypeNode);
 
       checkDisabled("node-menu-copyinner");
       checkDisabled("node-menu-copyouter");
       checkDisabled("node-menu-copyuniqueselector");
       checkDisabled("node-menu-delete");
+      checkDisabled("node-menu-pasteouterhtml");
 
       for (let name of ["hover", "active", "focus"]) {
         checkDisabled("node-menu-pseudo-" + name);
       }
 
       checkElementMenuItems();
     });
   }
@@ -63,20 +66,71 @@ function test() {
       checkEnabled("node-menu-copyouter");
       checkEnabled("node-menu-copyuniqueselector");
       checkEnabled("node-menu-delete");
 
       for (let name of ["hover", "active", "focus"]) {
         checkEnabled("node-menu-pseudo-" + name);
       }
 
-      testCopyInnerMenu();
+      checkElementPasteOuterHTMLMenuItemForText();
     });
   }
 
+  function checkPasteOuterHTMLMenuItem(data, type, check, next) {
+    clipboard.set(data, type);
+    inspector.selection.setNode(doc.querySelector("p"));
+    inspector.once("inspector-updated", () => {
+      contextMenuClick(getMarkupTagNodeContaining("p"));
+      check("node-menu-pasteouterhtml");
+      next();
+    });
+  }
+
+  function checkElementPasteOuterHTMLMenuItemForText() {
+    checkPasteOuterHTMLMenuItem(
+      "some text",
+      undefined,
+      checkEnabled,
+      checkElementPasteOuterHTMLMenuItemForImage);
+  }
+
+  function checkElementPasteOuterHTMLMenuItemForImage() {
+    checkPasteOuterHTMLMenuItem(
+      "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABC" +
+      "AAAAAA6fptVAAAACklEQVQYV2P4DwABAQEAWk1v8QAAAABJRU5ErkJggg==",
+      undefined,
+      checkDisabled,
+      checkElementPasteOuterHTMLMenuItemForHTML);
+  }
+
+  function checkElementPasteOuterHTMLMenuItemForHTML() {
+    checkPasteOuterHTMLMenuItem(
+      "<p>some text</p>",
+      "html",
+      checkEnabled,
+      checkElementPasteOuterHTMLMenuItemForEmptyString);
+  }
+
+  function checkElementPasteOuterHTMLMenuItemForEmptyString() {
+    checkPasteOuterHTMLMenuItem(
+      "",
+      undefined,
+      checkDisabled,
+      checkElementPasteOuterHTMLMenuItemForWhitespaceOnly);
+  }
+
+  function checkElementPasteOuterHTMLMenuItemForWhitespaceOnly() {
+    checkPasteOuterHTMLMenuItem(
+      " \n\n\t\n\n  \n",
+      undefined,
+      checkDisabled,
+      testCopyInnerMenu);
+  }
+
   function testCopyInnerMenu() {
     let copyInner = inspector.panelDoc.getElementById("node-menu-copyinner");
     ok(copyInner, "the popup menu has a copy inner html menu item");
 
     waitForClipboard("This is some example text",
                      function() { copyInner.doCommand(); },
                      testCopyOuterMenu, testCopyOuterMenu);
   }
@@ -91,17 +145,36 @@ function test() {
   }
 
   function testCopyUniqueSelectorMenu() {
     let copyUniqueSelector = inspector.panelDoc.getElementById("node-menu-copyuniqueselector");
     ok(copyUniqueSelector, "the popup menu has a copy unique selector menu item");
 
     waitForClipboard("body > div:nth-child(1) > p:nth-child(2)",
                      function() { copyUniqueSelector.doCommand(); },
-                     testDeleteNode, testDeleteNode);
+                     testPasteOuterHTMLMenu, testPasteOuterHTMLMenu);
+  }
+
+  function testPasteOuterHTMLMenu() {
+    clipboard.set("this was pasted");
+    inspector.selection.setNode(doc.querySelector("h1"));
+    inspector.once("inspector-updated", () => {
+      contextMenuClick(getMarkupTagNodeContaining("h1"));
+      let menu = inspector.panelDoc.getElementById("node-menu-pasteouterhtml");
+      let event = document.createEvent("XULCommandEvent");
+      event.initCommandEvent("command", true, true, window, 0, false, false,
+                             false, false, null);
+      menu.dispatchEvent(event);
+      inspector.selection.once("new-node", (event, oldNode, newNode) => {
+        ok(doc.body.outerHTML.contains(clipboard.get()),
+           "Clipboard content was pasted into the node's outer HTML.");
+        ok(!doc.querySelector("h1"), "The original node was removed.");
+        testDeleteNode();
+      });
+    });
   }
 
   function testDeleteNode() {
     let deleteNode = inspector.panelDoc.getElementById("node-menu-delete");
     ok(deleteNode, "the popup menu has a delete menu item");
 
     inspector.once("inspector-updated", deleteTest);
 
diff --git a/browser/locales/en-US/chrome/browser/devtools/inspector.dtd b/browser/locales/en-US/chrome/browser/devtools/inspector.dtd
--- a/browser/locales/en-US/chrome/browser/devtools/inspector.dtd
+++ b/browser/locales/en-US/chrome/browser/devtools/inspector.dtd
@@ -5,16 +5,19 @@
 <!ENTITY inspectorHTMLCopyInner.accesskey   "I">
 
 <!ENTITY inspectorHTMLCopyOuter.label       "Copy Outer HTML">
 <!ENTITY inspectorHTMLCopyOuter.accesskey   "O">
 
 <!ENTITY inspectorCopyUniqueSelector.label       "Copy Unique Selector">
 <!ENTITY inspectorCopyUniqueSelector.accesskey   "U">
 
+<!ENTITY inspectorHTMLPasteOuter.label      "Paste Outer HTML">
+<!ENTITY inspectorHTMLPasteOuter.accesskey  "P">
+
 <!ENTITY inspectorHTMLDelete.label          "Delete Node">
 <!ENTITY inspectorHTMLDelete.accesskey      "D">
 
 <!ENTITY inspector.selectButton.tooltip     "Select element with mouse">
 
 <!ENTITY inspectorSearchHTML.label          "Search HTML">
 <!ENTITY inspectorSearchHTML.key            "F">
 
