# HG changeset patch
# User Brian Grinstead <bgrinstead@mozilla.com>
# Date 1557768279 25200
#      Mon May 13 10:24:39 2019 -0700
# Node ID fc18e7966ff8a57fd961c7df9a03ef725a658ce3
# Parent  cb5734727c0a9d88e3e236a3e4a741a051509e0e
Bug 1521280 - Support non-anonymous html:input inside of xul:textbox in nsFocusManager::GetRedirectedFocus

There's a special case for the old about:config search field for SessionStore (CollectFromXULTextbox)
that calls into nsFocusManager::GetRedirectedFocus. Since we are going to make this input field
non-anonymous for xul:textbox[type=search], we need to add support for this case.

Differential Revision: https://phabricator.services.mozilla.com/D30949

diff --git a/dom/base/nsFocusManager.cpp b/dom/base/nsFocusManager.cpp
--- a/dom/base/nsFocusManager.cpp
+++ b/dom/base/nsFocusManager.cpp
@@ -332,16 +332,24 @@ Element* nsFocusManager::GetRedirectedFo
         return textControl;
       }
     }
   }
 
 #ifdef MOZ_XUL
   if (aContent->IsXULElement()) {
     if (aContent->IsXULElement(nsGkAtoms::textbox)) {
+      // Support [type=search] which has a non-anonyomus html:input, along with
+      // the XBL textboxes which have an anonymous html:input.
+      ErrorResult rv;
+      Element* nonAnonInput = aContent->AsElement()->QuerySelector(
+          NS_LITERAL_STRING(".textbox-input"), rv);
+      if (nonAnonInput) {
+        return nonAnonInput;
+      }
       return aContent->OwnerDoc()->GetAnonymousElementByAttribute(
           aContent, nsGkAtoms::anonid, NS_LITERAL_STRING("input"));
     } else {
       nsCOMPtr<nsIDOMXULMenuListElement> menulist =
           aContent->AsElement()->AsXULMenuList();
       if (menulist) {
         RefPtr<Element> inputField;
         menulist->GetInputField(getter_AddRefs(inputField));
