# HG changeset patch
# User Brian Grinstead <bgrinstead@mozilla.com>
# Parent  a92f1dd74ec093dc87923097f60756c252cfc4db
1200551- test case for console failure

diff --git a/dom/base/Console.cpp b/dom/base/Console.cpp
--- a/dom/base/Console.cpp
+++ b/dom/base/Console.cpp
@@ -1502,16 +1502,22 @@ Console::ProcessArguments(JSContext* aCx
           return false;
         }
 
         break;
       }
 
       case 'c':
       {
+        // If there isn't any output but there's already a style, then
+        // discard the previous style and use the next one instead.
+        // if (output.IsEmpty() && !aStyles.IsEmpty()) {
+        //   aStyles.TruncateLength(aStyles.Length() - 1);
+        // }
+
         if (!FlushOutput(aCx, aSequence, output)) {
           return false;
         }
 
         if (index < aData.Length()) {
           JS::Rooted<JS::Value> v(aCx, aData[index++]);
           JS::Rooted<JSString*> jsString(aCx, JS::ToString(aCx, v));
           if (!jsString) {
diff --git a/dom/base/test/chrome.ini b/dom/base/test/chrome.ini
--- a/dom/base/test/chrome.ini
+++ b/dom/base/test/chrome.ini
@@ -8,16 +8,17 @@ support-files =
   file_bug1008126_worker.js
 
 [test_anonymousContent_xul_window.xul]
 [test_bug715041.xul]
 [test_bug715041_removal.xul]
 [test_domrequesthelper.xul]
 [test_url.xul]
 [test_console.xul]
+[test_console_formatting.xul]
 [test_navigator_resolve_identity_xrays.xul]
 [test_sendQueryContentAndSelectionSetEvent.html]
 [test_bug1016960.html]
 [test_bug357450.js]
 [test_copypaste.xul]
 [test_messagemanager_principal.html]
 [test_messagemanager_send_principal.html]
 skip-if = buildapp == 'mulet'
diff --git a/dom/base/test/mochitest.ini b/dom/base/test/mochitest.ini
--- a/dom/base/test/mochitest.ini
+++ b/dom/base/test/mochitest.ini
@@ -716,16 +716,17 @@ support-files = referrerHelper.js
 [test_classList.html]
 # This test fails on the Mac for some reason
 [test_copyimage.html]
 skip-if = (buildapp == 'b2g' && toolkit != 'gonk') || (toolkit != 'cocoa' && toolkit != 'gonk' && toolkit != 'gtk2' && toolkit != 'gtk3' && toolkit != 'windows') || e10s #b2g-desktop(Bug 931116, b2g desktop specific, initial triage)
 [test_copypaste.html]
 skip-if = buildapp == 'b2g' || toolkit == 'android' || e10s #bug 904183 # b2g(clipboard undefined) b2g-debug(clipboard undefined) b2g-desktop(clipboard undefined)
 [test_copypaste.xhtml]
 skip-if = buildapp == 'b2g' || toolkit == 'android' #bug 904183 # b2g(bug 904183) b2g-debug(bug 904183) b2g-desktop(bug 904183)
+[test_console_styling.html]
 [test_createHTMLDocument.html]
 [test_declare_stylesheet_obsolete.html]
 [test_document_constructor.html]
 [test_document_importNode_document.html]
 [test_domparser_null_char.html]
 [test_domparsing.html]
 [test_elementTraversal.html]
 [test_element_closest.html]
diff --git a/dom/base/test/test_console_formatting.xul b/dom/base/test/test_console_formatting.xul
new file mode 100644
--- /dev/null
+++ b/dom/base/test/test_console_formatting.xul
@@ -0,0 +1,34 @@
+<?xml version="1.0"?>
+<?xml-stylesheet type="text/css" href="chrome://global/skin"?>
+<?xml-stylesheet type="text/css" href="chrome://mochikit/content/tests/SimpleTest/test.css"?>
+<window title="Test for URL API"
+        xmlns="http://www.mozilla.org/keymaster/gatekeeper/there.is.only.xul">
+  <script type="application/javascript" src="chrome://mochikit/content/tests/SimpleTest/SimpleTest.js"/>
+
+  <!-- test results are displayed in the html:body -->
+  <body xmlns="http://www.w3.org/1999/xhtml">
+    <iframe id="iframe" />
+  </body>
+
+  <!-- test code goes here -->
+  <script type="application/javascript"><![CDATA[
+  SimpleTest.waitForExplicitFinish();
+  SimpleTest.monitorConsole(SimpleTest.finish,
+  	[{message: "Styled output"}]);
+	console.log("%c%cStyled output", "color: red", "background: red");
+
+
+	function finish() {
+	  SimpleTest.endMonitorConsole();
+	}
+
+// SimpleTest.expectConsoleMessages(
+//   () => {
+//   	console.log("%c%cStyle", "color: red", "background: red");
+//   },
+//   [{ message: /Style/ }],
+//   () => {
+//   }
+// );
+  ]]></script>
+</window>
\ No newline at end of file
diff --git a/dom/base/test/test_console_styling.html b/dom/base/test/test_console_styling.html
new file mode 100644
--- /dev/null
+++ b/dom/base/test/test_console_styling.html
@@ -0,0 +1,35 @@
+<!doctype html>
+<html>
+<!--
+https://bugzilla.mozilla.org/show_bug.cgi?id=1200551
+-->
+<head>
+  <meta charset="utf-8">
+  <title>Test for Bug 1200551</title>
+  <script src="/tests/SimpleTest/SimpleTest.js"></script>
+  <link rel="stylesheet" href="/tests/SimpleTest/test.css">
+</head>
+<body>
+<a target="_blank"
+   href="https://bugzilla.mozilla.org/show_bug.cgi?id=1200551"
+   >Mozilla Bug 1200551</a>
+<script>
+/** Test for Bug 1200551 **/
+
+SimpleTest.waitForExplicitFinish();
+SimpleTest.monitorConsole(SimpleTest.finish, [
+  { message: "Styled output" }
+]);
+
+window.onload = function() {
+  ok(true);
+  window.console.log("Styled output");
+  // window.console.log("%c%cStyled output", "color: red", "background: red");
+}
+
+function finish() {
+  SimpleTest.endMonitorConsole();
+}
+</script>
+</body>
+</html>
diff --git a/testing/mochitest/tests/SimpleTest/SimpleTest.js b/testing/mochitest/tests/SimpleTest/SimpleTest.js
--- a/testing/mochitest/tests/SimpleTest/SimpleTest.js
+++ b/testing/mochitest/tests/SimpleTest/SimpleTest.js
@@ -1120,16 +1120,17 @@ SimpleTest.finish = function() {
  * SimpleTest.waitForExplicitFinish.
  */
 SimpleTest.monitorConsole = function (continuation, msgs, forbidUnexpectedMsgs) {
   if (SimpleTest._stopOnLoad) {
     ok(false, "Console monitoring requires use of waitForExplicitFinish.");
   }
 
   function msgMatches(msg, pat) {
+    debugger;
     for (k in pat) {
       if (!(k in msg)) {
         return false;
       }
       if (pat[k] instanceof RegExp && typeof(msg[k]) === 'string') {
         if (!pat[k].test(msg[k])) {
           return false;
         }
diff --git a/testing/specialpowers/content/specialpowersAPI.js b/testing/specialpowers/content/specialpowersAPI.js
--- a/testing/specialpowers/content/specialpowersAPI.js
+++ b/testing/specialpowers/content/specialpowersAPI.js
@@ -406,16 +406,17 @@ SpecialPowersHandler.prototype.enumerate
 // have their properties exposed in detail.  It also auto-unregisters
 // itself when it receives a "sentinel" message.
 function SPConsoleListener(callback) {
   this.callback = callback;
 }
 
 SPConsoleListener.prototype = {
   observe: function(msg) {
+    debugger;
     let m = { message: msg.message,
               errorMessage: null,
               sourceName: null,
               sourceLine: null,
               lineNumber: null,
               columnNumber: null,
               category: null,
               windowID: null,
