# HG changeset patch
# User Brian Grinstead <bgrinstead@mozilla.com>
# Parent  78dec2028dd2565cd386c6b1f57921060f300a67
Bug 1216569 - Handle search clear button in CSS and get rid of padding on style inspector search boxes when there's no text;r=pbrosset

diff --git a/devtools/client/styleinspector/computed-view.js b/devtools/client/styleinspector/computed-view.js
--- a/devtools/client/styleinspector/computed-view.js
+++ b/devtools/client/styleinspector/computed-view.js
@@ -173,18 +173,16 @@ function CssComputedView(inspector, docu
   this.searchField.addEventListener("input", this._onFilterStyles);
   this.searchField.addEventListener("keypress", this._onFilterKeyPress);
   this.searchField.addEventListener("contextmenu",
                                     this._onFilterTextboxContextMenu);
   this.searchClearButton.addEventListener("click", this._onClearSearch);
   this.includeBrowserStylesCheckbox.addEventListener("command",
     this._onIncludeBrowserStyles);
 
-  this.searchClearButton.hidden = true;
-
   // No results text.
   this.noResults = this.styleDocument.getElementById("noResults");
 
   // Refresh panel when color unit changed.
   this._handlePrefChange = this._handlePrefChange.bind(this);
   gDevTools.on("pref-changed", this._handlePrefChange);
 
   // Refresh panel when pref for showing original sources changes
@@ -528,25 +526,23 @@ CssComputedView.prototype = {
    */
   _onFilterStyles: function() {
     if (this._filterChangedTimeout) {
       clearTimeout(this._filterChangedTimeout);
     }
 
     let filterTimeout = (this.searchField.value.length > 0)
       ? FILTER_CHANGED_TIMEOUT : 0;
-    this.searchClearButton.hidden = this.searchField.value.length === 0;
+    if (this.searchField.value.length > 0) {
+      this.searchField.setAttribute("filled", true);
+    } else {
+      this.searchField.removeAttribute("filled");
+    }
 
     this._filterChangedTimeout = setTimeout(() => {
-      if (this.searchField.value.length > 0) {
-        this.searchField.setAttribute("filled", true);
-      } else {
-        this.searchField.removeAttribute("filled");
-      }
-
       this.refreshPanel();
       this._filterChangeTimeout = null;
     }, filterTimeout);
   },
 
   /**
    * Handle the search box's keypress event. If the escape key is pressed,
    * clear the search box field.
diff --git a/devtools/client/styleinspector/rule-view.js b/devtools/client/styleinspector/rule-view.js
--- a/devtools/client/styleinspector/rule-view.js
+++ b/devtools/client/styleinspector/rule-view.js
@@ -1336,18 +1336,16 @@ function CssRuleView(inspector, document
   this.searchField = doc.getElementById("ruleview-searchbox");
   this.searchClearButton = doc.getElementById("ruleview-searchinput-clear");
   this.pseudoClassPanel = doc.getElementById("pseudo-class-panel");
   this.pseudoClassToggle = doc.getElementById("pseudo-class-panel-toggle");
   this.hoverCheckbox = doc.getElementById("pseudo-hover-toggle");
   this.activeCheckbox = doc.getElementById("pseudo-active-toggle");
   this.focusCheckbox = doc.getElementById("pseudo-focus-toggle");
 
-  this.searchClearButton.hidden = true;
-
   this.styleDocument.addEventListener("keydown", this._onKeydown);
   this.styleDocument.addEventListener("keypress", this._onKeypress);
   this.element.addEventListener("copy", this._onCopy);
   this.element.addEventListener("contextmenu", this._onContextMenu);
   this.addRuleButton.addEventListener("click", this._onAddRule);
   this.searchField.addEventListener("input", this._onFilterStyles);
   this.searchField.addEventListener("keypress", this._onFilterKeyPress);
   this.searchField.addEventListener("contextmenu",
@@ -1775,25 +1773,23 @@ CssRuleView.prototype = {
    */
   _onFilterStyles: function() {
     if (this._filterChangedTimeout) {
       clearTimeout(this._filterChangedTimeout);
     }
 
     let filterTimeout = (this.searchValue.length > 0) ?
                         FILTER_CHANGED_TIMEOUT : 0;
-    this.searchClearButton.hidden = this.searchValue.length === 0;
+    if (this.searchField.value.length > 0) {
+      this.searchField.setAttribute("filled", true);
+    } else {
+      this.searchField.removeAttribute("filled");
+    }
 
     this._filterChangedTimeout = setTimeout(() => {
-      if (this.searchField.value.length > 0) {
-        this.searchField.setAttribute("filled", true);
-      } else {
-        this.searchField.removeAttribute("filled");
-      }
-
       this.searchData = {
         searchPropertyMatch: FILTER_PROP_RE.exec(this.searchValue),
         searchPropertyName: this.searchValue,
         searchPropertyValue: this.searchValue,
         strictSearchValue: "",
         strictSearchPropertyName: false,
         strictSearchPropertyValue: false,
         strictSearchAllValues: false
diff --git a/devtools/client/styleinspector/test/browser_computedview_search-filter_clear.js b/devtools/client/styleinspector/test/browser_computedview_search-filter_clear.js
--- a/devtools/client/styleinspector/test/browser_computedview_search-filter_clear.js
+++ b/devtools/client/styleinspector/test/browser_computedview_search-filter_clear.js
@@ -24,16 +24,17 @@ add_task(function*() {
 });
 
 function* testAddTextInFilter(inspector, computedView) {
   info("Setting filter text to \"background-color\"");
 
   let win = computedView.styleWindow;
   let propertyViews = computedView.propertyViews;
   let searchField = computedView.searchField;
+  let searchClearButton = computedView.searchClearButton;
   let checkbox = computedView.includeBrowserStylesCheckbox;
 
   info("Include browser styles");
   checkbox.click();
   yield inspector.once("computed-view-refreshed");
 
   searchField.focus();
   synthesizeKeys("background-color", win);
@@ -41,16 +42,20 @@ function* testAddTextInFilter(inspector,
 
   info("Check that the correct properties are visible");
 
   propertyViews.forEach((propView) => {
     let name = propView.name;
     is(propView.visible, name.indexOf("background-color") > -1,
       "span " + name + " property visibility check");
   });
+
+  ok(searchField.hasAttribute("filled"), "Search filter is filled.");
+  is(searchClearButton.ownerDocument.defaultView.getComputedStyle(searchClearButton).display,
+     "block", "Search clear button is visible.");
 }
 
 function* testClearSearchFilter(inspector, computedView) {
   info("Clearing the search filter");
 
   let win = computedView.styleWindow;
   let propertyViews = computedView.propertyViews;
   let searchField = computedView.searchField;
@@ -63,9 +68,13 @@ function* testClearSearchFilter(inspecto
   info("Check that the correct properties are visible");
 
   ok(!searchField.value, "Search filter is cleared");
   propertyViews.forEach((propView) => {
     let name = propView.name;
     is(propView.visible, true,
       "span " + name + " property is visible");
   });
+
+  ok(!searchField.hasAttribute("filled"), "Search filter is filled.");
+  is(searchClearButton.ownerDocument.defaultView.getComputedStyle(searchClearButton).display,
+     "none", "Search clear button is visible.");
 }
diff --git a/devtools/client/styleinspector/test/browser_ruleview_strict-search-filter_01.js b/devtools/client/styleinspector/test/browser_ruleview_strict-search-filter_01.js
--- a/devtools/client/styleinspector/test/browser_ruleview_strict-search-filter_01.js
+++ b/devtools/client/styleinspector/test/browser_ruleview_strict-search-filter_01.js
@@ -86,16 +86,22 @@ function* testAddTextInFilter(inspector,
 
 function* checkRules(view, data) {
   info("Check that the correct rules are visible");
   is(view.element.children.length, data.ruleCount,
     "Should have " + data.ruleCount + " rules.");
   is(getRuleViewRuleEditor(view, 0).rule.selectorText, "element",
     "First rule is inline element.");
 
+  let searchField = view.searchField;
+  let searchClearButton = view.searchClearButton;
+  ok(searchField.hasAttribute("filled"), "Search filter is filled.");
+  is(searchClearButton.ownerDocument.defaultView.getComputedStyle(searchClearButton).display,
+     "block", "Search clear button is visible.");
+
   let rule = getRuleViewRuleEditor(view, 1).rule;
 
   is(rule.selectorText, "#testid", "Second rule is #testid.");
   ok(rule.textProps[data.propertyIndex].editor.container.classList
     .contains("ruleview-highlight"),
     "Text property is correctly highlighted.");
 
   if (data.ruleCount > 2) {
@@ -117,9 +123,13 @@ function* clearSearchAndCheckRules(view)
   EventUtils.synthesizeMouseAtCenter(searchClearButton, {}, win);
   yield view.inspector.once("ruleview-filtered");
 
   info("Check the search filter is cleared and no rules are highlighted");
   is(view.element.children.length, 3, "Should have 3 rules.");
   ok(!searchField.value, "Search filter is cleared.");
   ok(!doc.querySelectorAll(".ruleview-highlight").length,
     "No rules are higlighted.");
+
+  ok(!searchField.hasAttribute("filled"), "Search filter is filled.");
+  is(searchClearButton.ownerDocument.defaultView.getComputedStyle(searchClearButton).display,
+     "none", "Search clear button is visible.");
 }
diff --git a/devtools/client/themes/toolbars.inc.css b/devtools/client/themes/toolbars.inc.css
--- a/devtools/client/themes/toolbars.inc.css
+++ b/devtools/client/themes/toolbars.inc.css
@@ -371,24 +371,28 @@
 .devtools-searchbox {
   display: flex;
   flex: 1;
   position: relative;
 }
 
 .devtools-rule-searchbox {
   -moz-box-flex: 1;
-  padding-right: 23px;
   width: 100%;
   font: inherit;
 }
 
 .devtools-rule-searchbox[filled] {
   background-color: var(--searchbox-background-color);
   border-color: var(--searchbox-border-color);
+  padding-right: 23px;
+}
+
+.devtools-rule-searchbox:not([filled]) + .devtools-searchinput-clear {
+  display: none;
 }
 
 .devtools-style-searchbox-no-match {
   background-color: var(--searcbox-no-match-background-color) !important;
   border-color: var(--searcbox-no-match-border-color) !important;
 }
 
 .devtools-no-search-result {
