# HG changeset patch
# User Brian Grinstead <bgrinstead@mozilla.com>
# Date 1538068097 25200
#      Thu Sep 27 10:08:17 2018 -0700
# Node ID 3a0f42902e90dc2745ba4d8e93dfb3fe2ed52ec3
# Parent  ba2b3ed1eb96065af623415366a7729cac877350
Bug 1481949 - Don't load Custom Element script files for dummy.xul windows;r=kmag

They are unnecessary for most every element, and we load multiple dummy.xul
documents even in clean profiles.

Differential Revision: https://phabricator.services.mozilla.com/D7112

diff --git a/toolkit/content/customElements.js b/toolkit/content/customElements.js
--- a/toolkit/content/customElements.js
+++ b/toolkit/content/customElements.js
@@ -154,28 +154,35 @@ function getInterfaceProxy(obj) {
   }
 
   return obj._customInterfaceProxy;
 }
 
 // Attach the base class to the window so other scripts can use it:
 window.MozXULElement = MozXULElement;
 
-for (let script of [
-  "chrome://global/content/elements/general.js",
-  "chrome://global/content/elements/textbox.js",
-  "chrome://global/content/elements/tabbox.js",
-]) {
-  Services.scriptloader.loadSubScript(script, window);
-}
+// For now, don't load any elements in the extension dummy document.
+// We will want to load <browser> when that's migrated (bug 1441935).
+const isDummyDocument = document.documentURI == "chrome://extensions/content/dummy.xul";
+if (!isDummyDocument) {
 
-for (let [tag, script] of [
-  ["findbar", "chrome://global/content/elements/findbar.js"],
-  ["stringbundle", "chrome://global/content/elements/stringbundle.js"],
-  ["printpreview-toolbar", "chrome://global/content/printPreviewToolbar.js"],
-  ["editor", "chrome://global/content/elements/editor.js"],
-]) {
-  customElements.setElementCreationCallback(tag, () => {
+  for (let script of [
+    "chrome://global/content/elements/general.js",
+    "chrome://global/content/elements/textbox.js",
+    "chrome://global/content/elements/tabbox.js",
+  ]) {
     Services.scriptloader.loadSubScript(script, window);
-  });
+  }
+
+  for (let [tag, script] of [
+    ["findbar", "chrome://global/content/elements/findbar.js"],
+    ["stringbundle", "chrome://global/content/elements/stringbundle.js"],
+    ["printpreview-toolbar", "chrome://global/content/printPreviewToolbar.js"],
+    ["editor", "chrome://global/content/elements/editor.js"],
+  ]) {
+    customElements.setElementCreationCallback(tag, () => {
+      Services.scriptloader.loadSubScript(script, window);
+    });
+  }
+
 }
 
 }
