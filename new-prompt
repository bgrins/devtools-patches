# HG changeset patch
# Parent 3391c2e2a00c0408e62f841cbf7c2dcfd40c6d09
# User Brian Grinstead <bgrinstead@mozilla.com>
Bug 1045075 - Can't create new folders in WebIDE

diff --git a/browser/devtools/projecteditor/lib/plugins/new/new.js b/browser/devtools/projecteditor/lib/plugins/new/new.js
--- a/browser/devtools/projecteditor/lib/plugins/new/new.js
+++ b/browser/devtools/projecteditor/lib/plugins/new/new.js
@@ -8,68 +8,92 @@ const { Class } = require("sdk/core/heri
 const { registerPlugin, Plugin } = require("projecteditor/plugins/core");
 const { getLocalizedString } = require("projecteditor/helpers/l10n");
 
 // Handles the new command.
 var NewFile = Class({
   extends: Plugin,
 
   init: function() {
-    this.command = this.host.addCommand(this, {
-      id: "cmd-new",
-      key: getLocalizedString("projecteditor.new.commandkey"),
+    this.commandNewFile = this.host.addCommand(this, {
+      id: "cmd-new-file",
+      key: getLocalizedString("projecteditor.newFile.commandkey"),
       modifiers: "accel"
     });
+    this.commandNewFolder = this.host.addCommand(this, {
+      id: "cmd-new-folder",
+    });
     this.host.createMenuItem({
       parent: this.host.fileMenuPopup,
-      label: getLocalizedString("projecteditor.newLabel"),
-      command: "cmd-new",
-      key: "key_cmd-new"
+      label: getLocalizedString("projecteditor.newFileLabel"),
+      command: "cmd-new-file",
+      key: "key_cmd-new-file"
     });
     this.host.createMenuItem({
       parent: this.host.contextMenuPopup,
-      label: getLocalizedString("projecteditor.newLabel"),
-      command: "cmd-new"
+      label: getLocalizedString("projecteditor.newFileLabel"),
+      command: "cmd-new-file"
+    });
+    this.host.createMenuItem({
+      parent: this.host.contextMenuPopup,
+      label: getLocalizedString("projecteditor.newFolderLabel"),
+      command: "cmd-new-folder"
     });
   },
 
   onCommand: function(cmd) {
-    if (cmd === "cmd-new") {
-      let tree = this.host.projectTree;
-      let resource = tree.getSelectedResource();
-      parent = resource.isDir ? resource : resource.parent;
-      sibling = resource.isDir ? null : resource;
+    let tree = this.host.projectTree;
+    let resource = tree.getSelectedResource();
+    let parent = resource.isDir ? resource : resource.parent;
+    let sibling = resource.isDir ? null : resource;
 
-      if (!("createChild" in parent)) {
-        return;
-      }
+    if (cmd === "cmd-new-folder") {
+      let template = "folder";
+      let name = this.suggestName(parent, template);
+      tree.promptNew(name, parent, sibling).then(name => {
+
+        // XXX: sanitize bad file names.
+
+        name = this.ensureUniqueName(parent, name, template);
+
+        return parent.createChild(name);
+      }).then(resource => {
+        tree.selectResource(resource);
+        this.host.currentEditor.focus();
+      }).then(null, console.error);
+    }
+    if (cmd === "cmd-new-file") {
 
       let extension = sibling ? sibling.contentCategory : parent.store.defaultCategory;
       let template = "untitled{1}." + extension;
       let name = this.suggestName(parent, template);
 
       tree.promptNew(name, parent, sibling).then(name => {
 
         // XXX: sanitize bad file names.
 
-        // If the name is already taken, just add/increment a number.
-        if (this.hasChild(parent, name)) {
-          let matches = name.match(/([^\d.]*)(\d*)([^.]*)(.*)/);
-          template = matches[1] + "{1}" + matches[3] + matches[4];
-          name = this.suggestName(parent, template, parseInt(matches[2]) || 2);
-        }
+        name = this.ensureUniqueName(parent, name, template);
 
         return parent.createChild(name);
       }).then(resource => {
         tree.selectResource(resource);
         this.host.currentEditor.focus();
       }).then(null, console.error);
     }
   },
 
+  ensureUniqueName: function(parent, name, template) {
+    if (this.hasChild(parent, name)) {
+      let matches = name.match(/([^\d.]*)(\d*)([^.]*)(.*)/);
+      template = matches[1] + "{1}" + matches[3] + matches[4];
+      name = this.suggestName(parent, template, parseInt(matches[2]) || 2);
+    }
+    return name;
+  },
+
   suggestName: function(parent, template, start=1) {
     let i = start;
     let name;
     do {
       name = template.replace("\{1\}", i === 1 ? "" : i);
       i++;
     } while (this.hasChild(parent, name));
 
diff --git a/browser/devtools/projecteditor/test/browser_projecteditor_menubar_02.js b/browser/devtools/projecteditor/test/browser_projecteditor_menubar_02.js
--- a/browser/devtools/projecteditor/test/browser_projecteditor_menubar_02.js
+++ b/browser/devtools/projecteditor/test/browser_projecteditor_menubar_02.js
@@ -15,17 +15,17 @@ let test = asyncTest(function*() {
   // let projecteditor = yield addProjectEditorTabForTempDirectory();
   ok(projecteditor, "ProjectEditor has loaded");
 
   let fileMenu = menubar.querySelector("#file-menu");
   let editMenu = menubar.querySelector("#edit-menu");
   ok (fileMenu, "The menu has loaded in the projecteditor document");
   ok (editMenu, "The menu has loaded in the projecteditor document");
 
-  let cmdNew = fileMenu.querySelector("[command=cmd-new]");
+  let cmdNew = fileMenu.querySelector("[command=cmd-new-file]");
   let cmdSave = fileMenu.querySelector("[command=cmd-save]");
   let cmdSaveas = fileMenu.querySelector("[command=cmd-saveas]");
 
   let cmdUndo = editMenu.querySelector("[command=cmd_undo]");
   let cmdRedo = editMenu.querySelector("[command=cmd_redo]");
   let cmdCut = editMenu.querySelector("[command=cmd_cut]");
   let cmdCopy = editMenu.querySelector("[command=cmd_copy]");
   let cmdPaste = editMenu.querySelector("[command=cmd_paste]");
diff --git a/browser/locales/en-US/chrome/browser/devtools/projecteditor.properties b/browser/locales/en-US/chrome/browser/devtools/projecteditor.properties
--- a/browser/locales/en-US/chrome/browser/devtools/projecteditor.properties
+++ b/browser/locales/en-US/chrome/browser/devtools/projecteditor.properties
@@ -26,20 +26,25 @@ projecteditor.deletePromptTitle=Delete
 # to make sure if a folder should be removed.
 projecteditor.deleteFolderPromptMessage=Are you sure you want to delete this folder?
 
 # LOCALIZATION NOTE (projecteditor.deleteFilePromptMessage):
 # This string is displayed as as the message of the confirm prompt that checks
 # to make sure if a file should be removed.
 projecteditor.deleteFilePromptMessage=Are you sure you want to delete this file?
 
-# LOCALIZATION NOTE (projecteditor.newLabel):
+# LOCALIZATION NOTE (projecteditor.newFileLabel):
 # This string is displayed as a menu item for adding a new file to
 # the directory.
-projecteditor.newLabel=New…
+projecteditor.newFileLabel=New File…
+
+# LOCALIZATION NOTE (projecteditor.newFolderLabel):
+# This string is displayed as a menu item for adding a new folder to
+# the directory.
+projecteditor.newFolderLabel=New Folder…
 
 # LOCALIZATION NOTE (projecteditor.saveLabel):
 # This string is displayed as a menu item for saving the current file.
 projecteditor.saveLabel=Save
 
 # LOCALIZATION NOTE (projecteditor.saveAsLabel):
 # This string is displayed as a menu item for saving the current file
 # with a new name.
@@ -62,12 +67,12 @@ projecteditor.openFileLabel=Open a File
 # text in the files.
 projecteditor.find.commandkey=F
 
 # LOCALIZATION NOTE  (projecteditor.save.commandkey): This is the key to use in
 # conjunction with accel (Command on Mac or Ctrl on other platforms) to
 # save the file.  It is used with accel+shift to "save as".
 projecteditor.save.commandkey=S
 
-# LOCALIZATION NOTE  (projecteditor.new.commandkey): This is the key to use in
+# LOCALIZATION NOTE  (projecteditor.newFile.commandkey): This is the key to use in
 # conjunction with accel (Command on Mac or Ctrl on other platforms) to
 # create a new file.
-projecteditor.new.commandkey=N
+projecteditor.newFile.commandkey=N
