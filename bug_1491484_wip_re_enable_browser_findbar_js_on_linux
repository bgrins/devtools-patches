# HG changeset patch
# User Brian Grinstead <bgrinstead@mozilla.com>
# Date 1537484594 25200
#      Thu Sep 20 16:03:14 2018 -0700
# Node ID d2d1ae0ba06c4713e2c53792292ee1d8b99790c9
# Parent  095ec59a8800360154df6668394803e5a84d031c
Bug 1491484 - WIP Re-enable browser_findbar.js on linux

Differential Revision: https://phabricator.services.mozilla.com/D6443

diff --git a/toolkit/content/tests/browser/browser.ini b/toolkit/content/tests/browser/browser.ini
--- a/toolkit/content/tests/browser/browser.ini
+++ b/toolkit/content/tests/browser/browser.ini
@@ -89,17 +89,16 @@ skip-if = !e10s || !crashreporter
 [browser_crash_previous_frameloader.js]
 run-if = e10s && crashreporter
 [browser_datetime_datepicker.js]
 uses-unsafe-cpows = true
 [browser_default_image_filename.js]
 [browser_default_image_filename_redirect.js]
 [browser_f7_caret_browsing.js]
 [browser_findbar.js]
-skip-if = os == "linux" && !debug # Bug 1491484
 [browser_findbar_disabled_manual.js]
 [browser_isSynthetic.js]
 [browser_keyevents_during_autoscrolling.js]
 [browser_label_textlink.js]
 [browser_mediaPlayback.js]
 tags = audiochannel
 [browser_mediaPlayback_mute.js]
 tags = audiochannel
diff --git a/toolkit/content/tests/browser/browser_findbar.js b/toolkit/content/tests/browser/browser_findbar.js
--- a/toolkit/content/tests/browser/browser_findbar.js
+++ b/toolkit/content/tests/browser/browser_findbar.js
@@ -1,16 +1,18 @@
 /* eslint-disable mozilla/no-arbitrary-setTimeout */
 ChromeUtils.import("resource://gre/modules/Timer.jsm", this);
 
 const TEST_PAGE_URI = "data:text/html;charset=utf-8,The letter s.";
 // Using 'javascript' schema to bypass E10SUtils.canLoadURIInProcess, because
 // it does not allow 'data:' URI to be loaded in the parent process.
 const E10S_PARENT_TEST_PAGE_URI = "javascript:document.write('The letter s.');";
 
+SimpleTest.requestCompleteLog();
+
 /**
  * Makes sure that the findbar hotkeys (' and /) event listeners
  * are added to the system event group and do not get blocked
  * by calling stopPropagation on a keypress event on a page.
  */
 add_task(async function test_hotkey_event_propagation() {
   info("Ensure hotkeys are not affected by stopPropagation.");
 
diff --git a/toolkit/content/widgets/findbar.js b/toolkit/content/widgets/findbar.js
--- a/toolkit/content/widgets/findbar.js
+++ b/toolkit/content/widgets/findbar.js
@@ -252,17 +252,17 @@ class MozFindbar extends XULElement {
       this.browser.finder.enableSelection();
     });
 
     this._findField.addEventListener("focus", (event) => {
       if (/Mac/.test(navigator.platform)) {
         this._onFindFieldFocus();
       }
       this._updateBrowserWithState();
-    });
+    }, { mozSystemGroup: true });
 
     this._findField.addEventListener("compositionstart", (event) => {
       // Don't close the find toolbar while IME is composing.
       let findbar = this;
       findbar._isIMEComposing = true;
       if (findbar._quickFindTimeout) {
         clearTimeout(findbar._quickFindTimeout);
         findbar._quickFindTimeout = null;
diff --git a/toolkit/modules/ActorManagerParent.jsm b/toolkit/modules/ActorManagerParent.jsm
--- a/toolkit/modules/ActorManagerParent.jsm
+++ b/toolkit/modules/ActorManagerParent.jsm
@@ -165,17 +165,17 @@ let ACTORS = {
       ],
     },
   },
 
   FindBar: {
     child: {
       module: "resource://gre/actors/FindBarChild.jsm",
       events: {
-        "keypress": {mozSystemGroup: true},
+        "keypress": {mozSystemGroup: true, capture: true},
       },
     },
   },
 
   Finder: {
     child: {
       module: "resource://gre/actors/FinderChild.jsm",
       messages: [
