# HG changeset patch
# User Brian Grinstead <bgrinstead@mozilla.com>
# Parent  1cf358aab01b00bd6e04c492c1a604548063ea19
Bug ??? - ContentTask.spawn seems to fail with unicode char in a file

diff --git a/devtools/client/framework/test/browser.ini b/devtools/client/framework/test/browser.ini
--- a/devtools/client/framework/test/browser.ini
+++ b/devtools/client/framework/test/browser.ini
@@ -11,16 +11,18 @@ support-files =
   shared-head.js
   helper_disable_cache.js
   doc_theme.css
   doc_viewsource.html
   browser_toolbox_options_enable_serviceworkers_testing_frame_script.js
   browser_toolbox_options_enable_serviceworkers_testing.html
   serviceworker.js
 
+[browser_contenttask_fails.js]
+[browser_contenttask_works.js]
 [browser_devtools_api.js]
 [browser_devtools_api_destroy.js]
 [browser_dynamic_tool_enabling.js]
 [browser_ignore_toolbox_network_requests.js]
 [browser_keybindings_01.js]
 [browser_keybindings_02.js]
 [browser_keybindings_03.js]
 [browser_new_activation_workflow.js]
diff --git a/devtools/client/framework/test/browser_contenttask_fails.js b/devtools/client/framework/test/browser_contenttask_fails.js
new file mode 100644
--- /dev/null
+++ b/devtools/client/framework/test/browser_contenttask_fails.js
@@ -0,0 +1,14 @@
+/* If this character is removed then the function is stringified properly: È˜ */
+
+console.log("BAD: Function as string", (function*() {
+
+}).toString());
+
+add_task(function *() {
+
+  yield ContentTask.spawn(gBrowser.selectedBrowser, {}, function*() {
+
+  });
+
+  ok(true);
+});
\ No newline at end of file
diff --git a/devtools/client/framework/test/browser_contenttask_works.js b/devtools/client/framework/test/browser_contenttask_works.js
new file mode 100644
--- /dev/null
+++ b/devtools/client/framework/test/browser_contenttask_works.js
@@ -0,0 +1,11 @@
+
+console.log("GOOD: Function as string", (function*() {
+
+}).toString());
+
+add_task(function *() {
+  yield ContentTask.spawn(gBrowser.selectedBrowser, {}, function*() {
+
+  });
+  ok(true);
+});
\ No newline at end of file
diff --git a/testing/mochitest/BrowserTestUtils/ContentTask.jsm b/testing/mochitest/BrowserTestUtils/ContentTask.jsm
--- a/testing/mochitest/BrowserTestUtils/ContentTask.jsm
+++ b/testing/mochitest/BrowserTestUtils/ContentTask.jsm
@@ -8,16 +8,17 @@
 
 this.EXPORTED_SYMBOLS = [
   "ContentTask"
 ];
 
 const { classes: Cc, interfaces: Ci, utils: Cu } = Components;
 Cu.import("resource://gre/modules/Promise.jsm");
 Cu.import("resource://gre/modules/Services.jsm");
+const {console} = Cu.import("resource://gre/modules/Console.jsm", {});
 
 const FRAME_SCRIPT = "chrome://mochikit/content/tests/BrowserTestUtils/content-task.js";
 
 /**
  * Keeps track of whether the frame script was already loaded.
  */
 var gFrameScriptLoaded = false;
 
@@ -73,16 +74,17 @@ this.ContentTask = {
     deferred.promise = new Promise((resolve, reject) => {
       deferred.resolve = resolve;
       deferred.reject = reject;
     });
 
     let id = gMessageID++;
     gPromises.set(id, deferred);
 
+    console.log("task.toString()", task.toString());
     browser.messageManager.sendAsyncMessage(
       "content-task:spawn",
       {
         id: id,
         runnable: task.toString(),
         arg: arg,
       });
 
