# HG changeset patch
# Parent 075a42c831f60a8fd152f461c696aa33b9e68e16
# User Brian Grinstead <bgrinstead@mozilla.com>
Bug 938616 - webconsole UI updates while in split mode with other panels

diff --git a/browser/app/profile/firefox.js b/browser/app/profile/firefox.js
--- a/browser/app/profile/firefox.js
+++ b/browser/app/profile/firefox.js
@@ -1092,17 +1092,17 @@ pref("devtools.appmanager.enabled", true
 pref("devtools.appmanager.lastTab", "help");
 pref("devtools.appmanager.manifestEditor.enabled", false);
 
 // Toolbox preferences
 pref("devtools.toolbox.footer.height", 250);
 pref("devtools.toolbox.sidebar.width", 500);
 pref("devtools.toolbox.host", "bottom");
 pref("devtools.toolbox.selectedTool", "webconsole");
-pref("devtools.toolbox.toolbarSpec", '["paintflashing toggle","tilt toggle","scratchpad","resize toggle"]');
+pref("devtools.toolbox.toolbarSpec", '["splitconsole toggle", "paintflashing toggle","tilt toggle","scratchpad","resize toggle"]');
 pref("devtools.toolbox.sideEnabled", true);
 pref("devtools.toolbox.zoomValue", "1");
 
 // Enable the Inspector
 pref("devtools.inspector.enabled", true);
 pref("devtools.inspector.activeSidebar", "ruleview");
 pref("devtools.inspector.markupPreview", false);
 pref("devtools.inspector.remote", false);
diff --git a/browser/devtools/commandline/BuiltinCommands.jsm b/browser/devtools/commandline/BuiltinCommands.jsm
--- a/browser/devtools/commandline/BuiltinCommands.jsm
+++ b/browser/devtools/commandline/BuiltinCommands.jsm
@@ -2267,8 +2267,94 @@ gcli.addCommand({
     manual: gcli.lookup("mediaEmulateManual"),
     exec: function(args, context) {
       let markupDocumentViewer = context.environment.chromeWindow
                                         .gBrowser.markupDocumentViewer;
       markupDocumentViewer.stopEmulatingMedium();
     }
   });
 }(this));
+
+/* CmdSplitConsole ------------------------------------------------------- */
+
+(function(module) {
+  /**
+   * 'splitconsole' command
+   */
+  gcli.addCommand({
+    name: 'splitconsole',
+    description: gcli.lookup('splitconsoleDesc')
+  });
+
+  gcli.addCommand({
+    name: 'splitconsole on',
+    description: gcli.lookup('splitconsoleOnDesc'),
+    manual: gcli.lookup('splitconsoleManual'),
+    exec: function(args, context) {
+      toggleSplitConsole(context, true);
+    }
+  });
+
+  gcli.addCommand({
+    name: 'splitconsole off',
+    description: gcli.lookup('splitconsoleOffDesc'),
+    manual: gcli.lookup('splitconsoleManual'),
+    exec: function(args, context) {
+      toggleSplitConsole(context, false);
+    }
+  });
+
+  gcli.addCommand({
+    name: 'splitconsole toggle',
+    buttonId: "command-button-console",
+    buttonClass: "command-button",
+    state: {
+      isChecked: function(aTarget) {
+        let toolbox = gDevTools.getToolbox(aTarget);
+        return toolbox &&
+          toolbox._splitConsole &&
+          toolbox.currentToolId !== "webconsole";
+      },
+      onChange: function(aTarget, aChangeHandler) {
+        eventEmitter.on("changed", aChangeHandler);
+      },
+      offChange: function(aTarget, aChangeHandler) {
+        eventEmitter.off("changed", aChangeHandler);
+      },
+    },
+    tooltipText: gcli.lookup("splitconsoleTooltip"),
+    description: gcli.lookup('splitconsoleToggleDesc'),
+    manual: gcli.lookup('splitconsoleManual'),
+    exec: function(args, context) {
+      toggleSplitConsole(context);
+    }
+  });
+
+  function toggleSplitConsole(context, enabled) {
+    let gBrowser = context.environment.chromeDocument.defaultView.gBrowser;
+    let target = devtools.TargetFactory.forTab(gBrowser.selectedTab);
+    let toolbox = gDevTools.getToolbox(target);
+
+    if (!toolbox) {
+      gDevTools.showToolbox(target, "inspector").then((toolbox) => {
+        toolbox.toggleSplitConsole(enabled);
+      });
+    } else {
+      toolbox.toggleSplitConsole(enabled);
+    }
+  }
+
+  let eventEmitter = new EventEmitter();
+  function fireChange(tab) {
+    eventEmitter.emit("changed", tab);
+  }
+
+  gDevTools.on("toolbox-ready", (e, toolbox) => {
+    let fireChangeForTab = fireChange.bind(this, toolbox.target.tab);
+    toolbox.on("split-console", fireChangeForTab);
+    toolbox.on("select", fireChangeForTab);
+    toolbox.once("destroyed", () => {
+      toolbox.off("split-console", fireChangeForTab);
+      toolbox.off("select", fireChangeForTab);
+    });
+  });
+
+}(this));
diff --git a/browser/devtools/framework/toolbox.js b/browser/devtools/framework/toolbox.js
--- a/browser/devtools/framework/toolbox.js
+++ b/browser/devtools/framework/toolbox.js
@@ -726,22 +726,29 @@ Toolbox.prototype = {
   focusTool: function(id) {
     let iframe = this.doc.getElementById("toolbox-panel-iframe-" + id);
     iframe.focus();
   },
 
   /**
    * Toggles the split state of the webconsole.  If the webconsole panel
    * is already selected, then this command is ignored.
+   * @param  {bool} enabled
+   *         If set, request that the split console be enabled or disabled.
+   *         If undefined, this will toggle the current state.
    */
-  toggleSplitConsole: function() {
+  toggleSplitConsole: function(enabled) {
     let openedConsolePanel = this.currentToolId === "webconsole";
+    let newState = !this._splitConsole;
+    if (enabled === false || enabled === true) {
+      newState = enabled;
+    }
 
     // Don't allow changes when console is open, since it could be confusing
-    if (!openedConsolePanel) {
+    if (!openedConsolePanel && newState !== this._splitConsole) {
       this._splitConsole = !this._splitConsole;
       this._refreshConsoleDisplay();
       this.emit("split-console");
 
       if (this._splitConsole) {
         this.loadTool("webconsole").then(() => {
           this.focusTool("webconsole");
         });
diff --git a/browser/locales/en-US/chrome/browser/devtools/gclicommands.properties b/browser/locales/en-US/chrome/browser/devtools/gclicommands.properties
--- a/browser/locales/en-US/chrome/browser/devtools/gclicommands.properties
+++ b/browser/locales/en-US/chrome/browser/devtools/gclicommands.properties
@@ -1182,19 +1182,43 @@ paintflashingChromeDesc=chrome frames
 # LOCALIZATION NOTE (paintflashingManual) A longer description describing the
 # set of commands that control paint flashing.
 paintflashingManual=Draw repainted areas in different colors
 
 # LOCALIZATION NOTE (paintflashingTooltip) A string displayed as the
 # tooltip of button in devtools toolbox which toggles paint flashing.
 paintflashingTooltip=Highlight painted area
 
-# LOCALIZATION NOTE (paintflashingOnDesc) A very short string used to describe the
+# LOCALIZATION NOTE (paintflashingToggleDesc) A very short string used to describe the
+# function of the "paintflashing toggle" command.
+paintflashingToggleDesc=Toggle paint flashing
+
+# LOCALIZATION NOTE (splitconsoleDesc) A very short string used to describe the
+# function of the "splitconsole" command
+splitconsoleDesc=Shows the console alongside the current panel
+
+# LOCALIZATION NOTE (splitconsoleOnDesc) A very short string used to describe the
+# function of the "splitconsole on" command.
+splitconsoleOnDesc=Open split console
+
+# LOCALIZATION NOTE (splitconsoleOffDesc) A very short string used to describe the
+# function of the "splitconsole off" command.
+splitconsoleOffDesc=Close split console
+
+# LOCALIZATION NOTE (splitconsoleManual) A longer description describing the
+# set of commands that control splitconsole.
+splitconsoleManual=Shows the console alongside the current panel
+
+# LOCALIZATION NOTE (splitconsoleTooltip) A string displayed as the
+# tooltip of button in devtools toolbox which toggles split console.
+splitconsoleTooltip=Open split console
+
+# LOCALIZATION NOTE (splitconsoleToggleDesc) A very short string used to describe the
 # function of the "paintflashing on" command.
-paintflashingToggleDesc=Toggle paint flashing
+splitconsoleToggleDesc=Toggle split console
 
 # LOCALIZATION NOTE (appCacheDesc) A very short string used to describe the
 # function of the "appcache" command
 appCacheDesc=Application cache utilities
 
 # LOCALIZATION NOTE (appCacheValidateDesc) A very short string used to describe
 # the function of the "appcache validate" command.
 appCacheValidateDesc=Validate cache manifest
diff --git a/browser/themes/linux/devtools/command-console.png b/browser/themes/linux/devtools/command-console.png
new file mode 100644
index 0000000000000000000000000000000000000000..265ab5c7b1968f393fb91c99d85bd1868e790685
GIT binary patch
literal 695
zc$@*Z0!aOdP)<h;3K|Lk000e1NJLTq002M$000mO1^@s6rssJn0000PbVXQnQ*UN;
zcVTj606}DLVr3vnZDD6+Qe|Oed2z{QJOBU!SxH1eRCwBA`Tzev!%zn5p))Ab&jKRY
zx%tR8;OEy*1FB!as|!Sl0kJNWCKkK`;>#>B-p3E`=a6bSzkpy0lKyjK=r=;r|A`F!
zu#nT`Hdo(6s{XGhZ@RD`@&5n~EG1Sm(81kkLVtn!ok-BX4^8MFP`@k*`X3{4#lC#~
z&hYc_k#pZaJibdvFQ<U4GP|vf5hG9^asd1T;?E=m;6E(<0n^X;?;it)pj;0SFDF88
zB*VXd%Rme!JPsnq1C;3hOQL>M_5Vn;9;$vA1ptZKq3Q=y0Q@0QKZ<(Bzoco0sUJQm
z;4g{Vq3T(v<^am|Q<egNNgCLsb0$)+GgLiF0Q>`1ExqJA0IGi<B`E-?|2Fw4;12_z
zns73Zl}wE0FJHf5qySJo+yG*{c>XMuU|q_|sfwi@4+Jq@zIahdNIwS$y9s)L0`;4N
zn`kdz^bpd|&dzR&ny3FVyg7IM=AWOR-*PJ|=@HV;#Kq2oQ3e2GpaxVIOGrvBXJlmh
zj}K!j1AzM1g7k|^NHjAsG5*7caioCbApK(E5(P|5On>oVY_))>p0YZZuyXsi`wzA;
zGc*3hhq2ZIz!+$Owz5K@4kU!pQ$R3Oe>sr)PXPbJ(vq}<>hC1NZj5%o>q~cU0$EO?
zI$HJ&|A1ED#s4s~0MOzJm}7uRl;m0fsDCAt{hy7EjU4@lVQf}bR#No80<{Fiv=r1q
z9mF3$elW1GGvhD7{(!=d@f8bF$D)UU0szz>Nuhpw3bbE-adgK5W)41XqD#;ppT3G{
ddR_(yFaXq#Q#&@V%y|F+002ovPDHLkV1i|uIRO9w

diff --git a/browser/themes/linux/jar.mn b/browser/themes/linux/jar.mn
--- a/browser/themes/linux/jar.mn
+++ b/browser/themes/linux/jar.mn
@@ -151,16 +151,17 @@ browser.jar:
   skin/classic/browser/devtools/light-theme.css       (../shared/devtools/light-theme.css)
   skin/classic/browser/devtools/controls.png          (../shared/devtools/controls.png)
 * skin/classic/browser/devtools/widgets.css           (devtools/widgets.css)
   skin/classic/browser/devtools/commandline-icon.png  (devtools/commandline-icon.png)
   skin/classic/browser/devtools/command-paintflashing.png  (devtools/command-paintflashing.png)
   skin/classic/browser/devtools/command-responsivemode.png (devtools/command-responsivemode.png)
   skin/classic/browser/devtools/command-scratchpad.png (devtools/command-scratchpad.png)
   skin/classic/browser/devtools/command-tilt.png      (devtools/command-tilt.png)
+  skin/classic/browser/devtools/command-console.png   (devtools/command-console.png)
   skin/classic/browser/devtools/alerticon-warning.png (devtools/alerticon-warning.png)
   skin/classic/browser/devtools/ruleview.css          (devtools/ruleview.css)
 * skin/classic/browser/devtools/webconsole.css                  (devtools/webconsole.css)
   skin/classic/browser/devtools/webconsole_networkpanel.css     (devtools/webconsole_networkpanel.css)
   skin/classic/browser/devtools/webconsole.png                  (devtools/webconsole.png)
   skin/classic/browser/devtools/commandline.css              (devtools/commandline.css)
   skin/classic/browser/devtools/markup-view.css       (../shared/devtools/markup-view.css)
   skin/classic/browser/devtools/editor-error.png       (devtools/editor-error.png)
diff --git a/browser/themes/osx/devtools/command-console.png b/browser/themes/osx/devtools/command-console.png
new file mode 100644
index 0000000000000000000000000000000000000000..265ab5c7b1968f393fb91c99d85bd1868e790685
GIT binary patch
literal 695
zc$@*Z0!aOdP)<h;3K|Lk000e1NJLTq002M$000mO1^@s6rssJn0000PbVXQnQ*UN;
zcVTj606}DLVr3vnZDD6+Qe|Oed2z{QJOBU!SxH1eRCwBA`Tzev!%zn5p))Ab&jKRY
zx%tR8;OEy*1FB!as|!Sl0kJNWCKkK`;>#>B-p3E`=a6bSzkpy0lKyjK=r=;r|A`F!
zu#nT`Hdo(6s{XGhZ@RD`@&5n~EG1Sm(81kkLVtn!ok-BX4^8MFP`@k*`X3{4#lC#~
z&hYc_k#pZaJibdvFQ<U4GP|vf5hG9^asd1T;?E=m;6E(<0n^X;?;it)pj;0SFDF88
zB*VXd%Rme!JPsnq1C;3hOQL>M_5Vn;9;$vA1ptZKq3Q=y0Q@0QKZ<(Bzoco0sUJQm
z;4g{Vq3T(v<^am|Q<egNNgCLsb0$)+GgLiF0Q>`1ExqJA0IGi<B`E-?|2Fw4;12_z
zns73Zl}wE0FJHf5qySJo+yG*{c>XMuU|q_|sfwi@4+Jq@zIahdNIwS$y9s)L0`;4N
zn`kdz^bpd|&dzR&ny3FVyg7IM=AWOR-*PJ|=@HV;#Kq2oQ3e2GpaxVIOGrvBXJlmh
zj}K!j1AzM1g7k|^NHjAsG5*7caioCbApK(E5(P|5On>oVY_))>p0YZZuyXsi`wzA;
zGc*3hhq2ZIz!+$Owz5K@4kU!pQ$R3Oe>sr)PXPbJ(vq}<>hC1NZj5%o>q~cU0$EO?
zI$HJ&|A1ED#s4s~0MOzJm}7uRl;m0fsDCAt{hy7EjU4@lVQf}bR#No80<{Fiv=r1q
z9mF3$elW1GGvhD7{(!=d@f8bF$D)UU0szz>Nuhpw3bbE-adgK5W)41XqD#;ppT3G{
ddR_(yFaXq#Q#&@V%y|F+002ovPDHLkV1i|uIRO9w

diff --git a/browser/themes/osx/devtools/toolbox.css b/browser/themes/osx/devtools/toolbox.css
--- a/browser/themes/osx/devtools/toolbox.css
+++ b/browser/themes/osx/devtools/toolbox.css
@@ -92,16 +92,32 @@
 #command-button-tilt:hover:active {
   -moz-image-region: rect(0px, 48px, 16px, 32px);
 }
 
 #command-button-tilt[checked=true] {
   -moz-image-region: rect(0px, 64px, 16px, 48px);
 }
 
+#command-button-console {
+  list-style-image: url("chrome://browser/skin/devtools/command-console.png");
+  -moz-image-region: rect(0px, 16px, 16px, 0px);
+}
+#command-button-console:hover {
+  -moz-image-region: rect(0px, 32px, 16px, 16px);
+}
+
+#command-button-console:hover:active {
+  -moz-image-region: rect(0px, 48px, 16px, 32px);
+}
+
+#command-button-console[checked=true] {
+  -moz-image-region: rect(0px, 64px, 16px, 48px);
+}
+
 #command-button-scratchpad {
   list-style-image: url("chrome://browser/skin/devtools/command-scratchpad.png");
   -moz-image-region: rect(0px, 16px, 16px, 0px);
 }
 
 #command-button-scratchpad:hover {
   -moz-image-region: rect(0px, 32px, 16px, 16px);
 }
diff --git a/browser/themes/osx/jar.mn b/browser/themes/osx/jar.mn
--- a/browser/themes/osx/jar.mn
+++ b/browser/themes/osx/jar.mn
@@ -253,16 +253,17 @@ browser.jar:
   skin/classic/browser/devtools/light-theme.css             (../shared/devtools/light-theme.css)
   skin/classic/browser/devtools/controls.png                (../shared/devtools/controls.png)
 * skin/classic/browser/devtools/widgets.css                 (devtools/widgets.css)
   skin/classic/browser/devtools/commandline-icon.png        (devtools/commandline-icon.png)
   skin/classic/browser/devtools/command-paintflashing.png   (devtools/command-paintflashing.png)
   skin/classic/browser/devtools/command-responsivemode.png  (devtools/command-responsivemode.png)
   skin/classic/browser/devtools/command-scratchpad.png      (devtools/command-scratchpad.png)
   skin/classic/browser/devtools/command-tilt.png            (devtools/command-tilt.png)
+  skin/classic/browser/devtools/command-console.png         (devtools/command-console.png)
   skin/classic/browser/devtools/alerticon-warning.png       (devtools/alerticon-warning.png)
   skin/classic/browser/devtools/ruleview.css                (devtools/ruleview.css)
   skin/classic/browser/devtools/commandline.css             (devtools/commandline.css)
   skin/classic/browser/devtools/markup-view.css             (../shared/devtools/markup-view.css)
   skin/classic/browser/devtools/editor-error.png             (devtools/editor-error.png)
   skin/classic/browser/devtools/editor-breakpoint.png        (devtools/editor-breakpoint.png)
   skin/classic/browser/devtools/editor-debug-location.png    (devtools/editor-debug-location.png)
 * skin/classic/browser/devtools/webconsole.css                  (devtools/webconsole.css)
diff --git a/browser/themes/windows/devtools/command-console.png b/browser/themes/windows/devtools/command-console.png
new file mode 100644
index 0000000000000000000000000000000000000000..265ab5c7b1968f393fb91c99d85bd1868e790685
GIT binary patch
literal 695
zc$@*Z0!aOdP)<h;3K|Lk000e1NJLTq002M$000mO1^@s6rssJn0000PbVXQnQ*UN;
zcVTj606}DLVr3vnZDD6+Qe|Oed2z{QJOBU!SxH1eRCwBA`Tzev!%zn5p))Ab&jKRY
zx%tR8;OEy*1FB!as|!Sl0kJNWCKkK`;>#>B-p3E`=a6bSzkpy0lKyjK=r=;r|A`F!
zu#nT`Hdo(6s{XGhZ@RD`@&5n~EG1Sm(81kkLVtn!ok-BX4^8MFP`@k*`X3{4#lC#~
z&hYc_k#pZaJibdvFQ<U4GP|vf5hG9^asd1T;?E=m;6E(<0n^X;?;it)pj;0SFDF88
zB*VXd%Rme!JPsnq1C;3hOQL>M_5Vn;9;$vA1ptZKq3Q=y0Q@0QKZ<(Bzoco0sUJQm
z;4g{Vq3T(v<^am|Q<egNNgCLsb0$)+GgLiF0Q>`1ExqJA0IGi<B`E-?|2Fw4;12_z
zns73Zl}wE0FJHf5qySJo+yG*{c>XMuU|q_|sfwi@4+Jq@zIahdNIwS$y9s)L0`;4N
zn`kdz^bpd|&dzR&ny3FVyg7IM=AWOR-*PJ|=@HV;#Kq2oQ3e2GpaxVIOGrvBXJlmh
zj}K!j1AzM1g7k|^NHjAsG5*7caioCbApK(E5(P|5On>oVY_))>p0YZZuyXsi`wzA;
zGc*3hhq2ZIz!+$Owz5K@4kU!pQ$R3Oe>sr)PXPbJ(vq}<>hC1NZj5%o>q~cU0$EO?
zI$HJ&|A1ED#s4s~0MOzJm}7uRl;m0fsDCAt{hy7EjU4@lVQf}bR#No80<{Fiv=r1q
z9mF3$elW1GGvhD7{(!=d@f8bF$D)UU0szz>Nuhpw3bbE-adgK5W)41XqD#;ppT3G{
ddR_(yFaXq#Q#&@V%y|F+002ovPDHLkV1i|uIRO9w

diff --git a/browser/themes/windows/jar.mn b/browser/themes/windows/jar.mn
--- a/browser/themes/windows/jar.mn
+++ b/browser/themes/windows/jar.mn
@@ -178,16 +178,17 @@ browser.jar:
         skin/classic/browser/devtools/commandline-icon.png          (devtools/commandline-icon.png)
         skin/classic/browser/devtools/alerticon-warning.png         (devtools/alerticon-warning.png)
         skin/classic/browser/devtools/ruleview.css                  (devtools/ruleview.css)
         skin/classic/browser/devtools/commandline.css               (devtools/commandline.css)
         skin/classic/browser/devtools/command-paintflashing.png     (devtools/command-paintflashing.png)
         skin/classic/browser/devtools/command-responsivemode.png    (devtools/command-responsivemode.png)
         skin/classic/browser/devtools/command-scratchpad.png        (devtools/command-scratchpad.png)
         skin/classic/browser/devtools/command-tilt.png              (devtools/command-tilt.png)
+        skin/classic/browser/devtools/command-console.png           (devtools/command-console.png)
         skin/classic/browser/devtools/markup-view.css               (../shared/devtools/markup-view.css)
         skin/classic/browser/devtools/editor-error.png               (devtools/editor-error.png)
         skin/classic/browser/devtools/editor-breakpoint.png          (devtools/editor-breakpoint.png)
         skin/classic/browser/devtools/editor-debug-location.png      (devtools/editor-debug-location.png)
 *       skin/classic/browser/devtools/webconsole.css                  (devtools/webconsole.css)
         skin/classic/browser/devtools/webconsole_networkpanel.css     (devtools/webconsole_networkpanel.css)
         skin/classic/browser/devtools/webconsole.png                  (devtools/webconsole.png)
         skin/classic/browser/devtools/breadcrumbs-scrollbutton.png                 (devtools/breadcrumbs-scrollbutton.png)
@@ -468,16 +469,17 @@ browser.jar:
         skin/classic/aero/browser/devtools/light-theme.css           (../shared/devtools/light-theme.css)
         skin/classic/aero/browser/devtools/controls.png              (../shared/devtools/controls.png)
 *       skin/classic/aero/browser/devtools/widgets.css               (devtools/widgets.css)
         skin/classic/aero/browser/devtools/commandline-icon.png      (devtools/commandline-icon.png)
         skin/classic/aero/browser/devtools/command-paintflashing.png  (devtools/command-paintflashing.png)
         skin/classic/aero/browser/devtools/command-responsivemode.png (devtools/command-responsivemode.png)
         skin/classic/aero/browser/devtools/command-scratchpad.png    (devtools/command-scratchpad.png)
         skin/classic/aero/browser/devtools/command-tilt.png          (devtools/command-tilt.png)
+        skin/classic/aero/browser/devtools/command-console.png       (devtools/command-console.png)
         skin/classic/aero/browser/devtools/alerticon-warning.png     (devtools/alerticon-warning.png)
         skin/classic/aero/browser/devtools/ruleview.css              (devtools/ruleview.css)
         skin/classic/aero/browser/devtools/commandline.css           (devtools/commandline.css)
         skin/classic/aero/browser/devtools/markup-view.css           (../shared/devtools/markup-view.css)
         skin/classic/aero/browser/devtools/editor-error.png           (devtools/editor-error.png)
         skin/classic/aero/browser/devtools/editor-breakpoint.png      (devtools/editor-breakpoint.png)
         skin/classic/aero/browser/devtools/editor-debug-location.png  (devtools/editor-debug-location.png)
 *       skin/classic/aero/browser/devtools/webconsole.css                  (devtools/webconsole.css)
