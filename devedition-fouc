# HG changeset patch
# User Brian Grinstead <bgrinstead@mozilla.com>
# Parent  721522e6eeb38250908ab4c59470b7acbd047436
Bug 1141326 - DevEdition theme has flash of unstyled content

diff --git a/browser/base/content/browser-devedition.js b/browser/base/content/browser-devedition.js
--- a/browser/base/content/browser-devedition.js
+++ b/browser/base/content/browser-devedition.js
@@ -32,16 +32,25 @@ let DevEdition = {
     Services.obs.addObserver(this, "lightweight-theme-styling-update", false);
     this._updateDevtoolsThemeAttribute();
 
     if (this.isThemeCurrentlyApplied) {
       this._toggleStyleSheet(true);
     }
   },
 
+  createStyleSheet: function() {
+    let styleSheetAttr = `href="${this.styleSheetLocation}" type="text/css"`;
+    this.styleSheet = document.createProcessingInstruction(
+      'xml-stylesheet', styleSheetAttr);
+    this.styleSheet.disabled = true;
+    this.styleSheet.addEventListener("load", this);
+    document.insertBefore(this.styleSheet, document.documentElement);
+  },
+
   observe: function (subject, topic, data) {
     if (topic == "lightweight-theme-styling-update") {
       let newTheme = JSON.parse(data);
       if (newTheme && newTheme.id == "devedition") {
         this._toggleStyleSheet(true);
       } else {
         this._toggleStyleSheet(false);
       }
@@ -50,17 +59,17 @@ let DevEdition = {
     if (topic == "nsPref:changed" && data == this._devtoolsThemePrefName) {
       this._updateDevtoolsThemeAttribute();
     }
   },
 
   _inferBrightness: function() {
     ToolbarIconColor.inferFromText();
     // Get an inverted full screen button if the dark theme is applied.
-    if (this.styleSheet &&
+    if (this.styleSheet.disabled &&
         document.documentElement.getAttribute("devtoolstheme") == "dark") {
       document.documentElement.setAttribute("brighttitlebarforeground", "true");
     } else {
       document.documentElement.removeAttribute("brighttitlebarforeground");
     }
   },
 
   _updateDevtoolsThemeAttribute: function() {
@@ -70,36 +79,37 @@ let DevEdition = {
     if (devtoolsTheme != "dark") {
       devtoolsTheme = "light";
     }
     document.documentElement.setAttribute("devtoolstheme", devtoolsTheme);
     this._inferBrightness();
   },
 
   handleEvent: function(e) {
-    if (e.type === "load") {
-      this.styleSheet.removeEventListener("load", this);
+    if (e.type === "load" && gBrowser) {
       gBrowser.tabContainer._positionPinnedTabs();
       this._inferBrightness();
     }
   },
 
   _toggleStyleSheet: function(deveditionThemeEnabled) {
-    if (deveditionThemeEnabled && !this.styleSheet) {
-      let styleSheetAttr = `href="${this.styleSheetLocation}" type="text/css"`;
-      this.styleSheet = document.createProcessingInstruction(
-        'xml-stylesheet', styleSheetAttr);
-      this.styleSheet.addEventListener("load", this);
-      document.insertBefore(this.styleSheet, document.documentElement);
+      console.log("ENABLING?", deveditionThemeEnabled);
+    if (deveditionThemeEnabled && this.styleSheet.disabled) {
+      this.styleSheet.disabled = false;
+
+      console.log("ENABLING!!!");
+      // XXX: what if load hasn't fired yet?
+      gBrowser.tabContainer._positionPinnedTabs();
+      this._inferBrightness();
+
       // NB: we'll notify observers once the stylesheet has fully loaded, see
       // handleEvent above.
-    } else if (!deveditionThemeEnabled && this.styleSheet) {
-      this.styleSheet.removeEventListener("load", this);
-      this.styleSheet.remove();
-      this.styleSheet = null;
+    } else if (!deveditionThemeEnabled && !this.styleSheet.disabled) {
+      console.log("DISABLING!!");
+      this.styleSheet.disabled = true;
       gBrowser.tabContainer._positionPinnedTabs();
       this._inferBrightness();
     }
   },
 
   uninit: function () {
     Services.prefs.removeObserver(this._devtoolsThemePrefName, this);
     Services.obs.removeObserver(this, "lightweight-theme-styling-update", false);
diff --git a/browser/base/content/browser.js b/browser/base/content/browser.js
--- a/browser/base/content/browser.js
+++ b/browser/base/content/browser.js
@@ -7735,8 +7735,11 @@ let PanicButtonNotifier = {
       Cu.reportError(ex);
     }
   },
   close: function() {
     let popup = document.getElementById("panic-button-success-notification");
     popup.hidePopup();
   },
 };
+
+
+DevEdition.createStyleSheet();
