# HG changeset patch
# User Brian Grinstead <bgrinstead@mozilla.com>
# Parent  de7fab8a48f3328275ed45aa3fe216c83a8ab414
Bug 1207107 - to be applied on top of attachment 8678259

diff --git a/browser/base/content/aboutcerterror/aboutCertError.xhtml b/browser/base/content/aboutcerterror/aboutCertError.xhtml
--- a/browser/base/content/aboutcerterror/aboutCertError.xhtml
+++ b/browser/base/content/aboutcerterror/aboutCertError.xhtml
@@ -252,20 +252,22 @@
         if (err == "nssBadCert") {
           // Remove the "Try again" button for security exceptions, since it's
           // almost certainly useless.
           document.getElementById("errorTryAgain").style.display = "none";
           document.getElementById("errorPageContainer").setAttribute("class", "certerror");
           addDomainErrorLink();
         }
         else {
+          // XXX: this element doesn't exist on the page.
+
           // Remove the override block for non-certificate errors.  CSS-hiding
           // isn't good enough here, because of bug 39098
-          var secOverride = document.getElementById("securityOverrideDiv");
-          secOverride.parentNode.removeChild(secOverride);
+          // var secOverride = document.getElementById("securityOverrideDiv");
+          // secOverride.parentNode.removeChild(secOverride);
         }
       }
 
       function showSecuritySection() {
         // Swap link out, content in
         document.getElementById('securityOverrideContent').style.display = '';
         document.getElementById('securityOverrideLink').style.display = 'none';
       }
@@ -442,32 +444,16 @@
         <div id="errorShortDesc">
           <p><a href="https://support.mozilla.org/kb/tls-error-reports" id="learnMoreLink" target="new">&errorReporting.learnMore;</a></p>
         </div>
 
         <!-- Go Back Button -->
         <button id="goBack" class="returnButton" autocomplete="off" onclick="goBack(this);" autofocus="true" style="margin-left: 0;">&certerror.returnToPreviousPage.label;</button>
         <button id="advanced" class="advancedButton" autocomplete="off" onclick="toggleVisibility(document.getElementById('certificateErrorReportingPanel'));" autofocus="true">&weakCryptoAdvanced.title;</button>
 
-        <script>
-          // Only do autofocus if we're the toplevel frame; otherwise we
-          // don't want to call attention to ourselves!  The key part is
-          // that autofocus happens on insertion into the tree, so we
-          // can remove the button, add @autofocus, and reinsert the
-          // button.
-          if (window.top == window) {
-              var button = document.getElementById("errorTryAgain");
-              var nextSibling = button.nextSibling;
-              var parent = button.parentNode;
-              parent.removeChild(button);
-              button.setAttribute("autofocus", "true");
-              parent.insertBefore(button, nextSibling);
-          }
-        </script>
-
         <div id="errorShortDesc">
           <p>
             <input type="checkbox" id="automaticallyReportInFuture" checked="true" />
             <label for="automaticallyReportInFuture" id="automaticallyReportInFuture">&certerror.reportError.label;</label>
           </p>
         </div>
 
         <!-- UI for option to report certificate errors to Mozilla. Removed on
@@ -475,16 +461,31 @@
 
         <div id="certificateErrorReportingPanel" style="display: block; visibility: hidden;">
           <div id="certificateErrorReportingDescription">
             <p id="technicalContentText"/>
             <p id="errorTryAgain"><a href="#" onclick="retryThis(this);" class="fade">&certerror.override;</a></p>
           </div>
         </div>
 
+        <script>
+          // Only do autofocus if we're the toplevel frame; otherwise we
+          // don't want to call attention to ourselves!  The key part is
+          // that autofocus happens on insertion into the tree, so we
+          // can remove the button, add @autofocus, and reinsert the
+          // button.
+          if (window.top == window) {
+              var button = document.getElementById("errorTryAgain");
+              var nextSibling = button.nextSibling;
+              var parent = button.parentNode;
+              parent.removeChild(button);
+              button.setAttribute("autofocus", "true");
+              parent.insertBefore(button, nextSibling);
+          }
+        </script>
       </div>
 
     </div>
 
     <!--
     - Note: It is important to run the script this way, instead of using
     - an onload handler. This is because error pages are loaded as
     - LOAD_BACKGROUND, which means that onload handlers will not be executed.
diff --git a/browser/base/content/content.js b/browser/base/content/content.js
--- a/browser/base/content/content.js
+++ b/browser/base/content/content.js
@@ -211,16 +211,19 @@ var AboutNetErrorListener = {
   init: function(chromeGlobal) {
     chromeGlobal.addEventListener('AboutNetErrorLoad', this, false, true);
     chromeGlobal.addEventListener('AboutNetErrorSetAutomatic', this, false, true);
     chromeGlobal.addEventListener('AboutNetErrorSendReport', this, false, true);
     chromeGlobal.addEventListener('AboutNetErrorUIExpanded', this, false, true);
     chromeGlobal.addEventListener('AboutNetErrorOverride', this, false, true);
   },
 
+// XXX: If we want reporting from about:certerror we'll need to change this (and
+// possibly rename AboutNetErrorListener to something more generic).  I'm not sure
+// if we want all of the functionality to be available to about:certerror too.
   get isAboutNetError() {
     return content.document.documentURI.startsWith("about:neterror");
   },
 
   handleEvent: function(aEvent) {
     if (!this.isAboutNetError) {
       return;
     }
diff --git a/browser/base/content/test/general/browser.ini b/browser/base/content/test/general/browser.ini
--- a/browser/base/content/test/general/browser.ini
+++ b/browser/base/content/test/general/browser.ini
@@ -117,16 +117,17 @@ support-files =
   file_bug1045809_2.html
 
 [browser_URLBarSetURI.js]
 skip-if = (os == "linux" || os == "mac") && debug # bug 970052, bug 970053
 [browser_aboutAccounts.js]
 skip-if = os == "linux" # Bug 958026
 support-files =
   content_aboutAccounts.js
+[browser_aboutCertError.js]
 [browser_aboutSupport_newtab_security_state.js]
 [browser_aboutHealthReport.js]
 skip-if = os == "linux" # Bug 924307
 [browser_aboutHome.js]
 skip-if = e10s # Bug 1093153 - no about:home support yet
 [browser_action_keyword.js]
 [browser_action_keyword_override.js]
 [browser_action_searchengine.js]
diff --git a/browser/base/content/test/general/browser_aboutCertError.js b/browser/base/content/test/general/browser_aboutCertError.js
new file mode 100644
--- /dev/null
+++ b/browser/base/content/test/general/browser_aboutCertError.js
@@ -0,0 +1,30 @@
+/* Any copyright is dedicated to the Public Domain.
+ * http://creativecommons.org/publicdomain/zero/1.0/ */
+
+add_task(function* checkReturnToPreviousPage() {
+  let tab = yield BrowserTestUtils.openNewForegroundTab(gBrowser, "http://example.com");
+  let browser = gBrowser.selectedBrowser;
+  yield BrowserTestUtils.loadURI(browser, "about:certerror");
+  yield BrowserTestUtils.browserLoaded(browser);
+
+  is(browser.webNavigation.canGoBack, true, "webNavigation.canGoBack");
+  is(browser.webNavigation.canGoForward, false, "!webNavigation.canGoForward");
+
+  let pageshowPromise = promiseWaitForEvent(browser, "pageshow");
+
+  info("Clicking the go back button on about:certerror");
+  yield ContentTask.spawn(browser, null, function* () {
+    let doc = content.document;
+    let goBack = doc.getElementById("goBack");
+    goBack.click();
+  });
+
+  yield pageshowPromise;
+
+  is(browser.webNavigation.canGoBack, false, "!webNavigation.canGoBack");
+  is(browser.webNavigation.canGoForward, true, "webNavigation.canGoForward");
+  is(gBrowser.currentURI.spec, "http://example.com/", "Went back");
+
+  gBrowser.removeCurrentTab();
+});
+
diff --git a/browser/themes/shared/aboutCertError.css b/browser/themes/shared/aboutCertError.css
--- a/browser/themes/shared/aboutCertError.css
+++ b/browser/themes/shared/aboutCertError.css
@@ -130,17 +130,17 @@ div#certificateErrorReportingPanel {
   display: flex;
   flex-direction: row;
   flex-wrap: wrap;
   justify-content: space-between;
   align-content: space-between;
   align-items: flex-start;
 }
 
-span#hostname {
+span.hostname {
   font-weight: bold;
 }
 
 #automaticallyReportInFuture {
   cursor: pointer;
 }
 
 #reportCertificateError {
@@ -177,25 +177,26 @@ span#hostname {
   font-family: monospace;
   white-space: pre-wrap;
 }
 
 .returnButton {
   background-color: var(--in-content-primary-button-background);
   border: none;
   color: var(--in-content-selected-text);
-  min-width: 250px !important;
+  min-width: 250px;
 }
 .returnButton:hover {
   background-color: var(--in-content-primary-button-background-hover) !important;
 }
 .returnButton:hover:active {
   background-color: var(--in-content-primary-button-background-active) !important;
 }
 
 .advancedButton {
-  float: right !important;
+  float: right;
+  min-width: 150px;
 }
 
 .fade {
   color: var(--in-content-text-color) !important;
   opacity: 0.5;
 }
