# HG changeset patch
# User Brian Grinstead <bgrinstead@mozilla.com>
# Date 1551299837 28800
#      Wed Feb 27 12:37:17 2019 -0800
# Node ID 30c2948beb8899988c8837fd516bd3e8157cf32e
# Parent  198cd4a81bf2afa7cc79360f90da7bc91218b76d
Bug 1513343 - WIP Support context menus in html:textarea in the parent process

Differential Revision: https://phabricator.services.mozilla.com/D21092

diff --git a/security/manager/pki/resources/content/certViewer.xul b/security/manager/pki/resources/content/certViewer.xul
--- a/security/manager/pki/resources/content/certViewer.xul
+++ b/security/manager/pki/resources/content/certViewer.xul
@@ -17,16 +17,17 @@
   onload="setWindowName();">
 
 
 <linkset>
   <html:link rel="localization" href="security/certificates/certManager.ftl"/>
 </linkset>
 
 <script type="application/javascript" src="chrome://pippki/content/pippki.js"/>
+<script type="application/javascript" src="chrome://global/content/globalOverlay.js"/>
 <script type="application/javascript"
         src="chrome://pippki/content/certViewer.js"/>
 <html:style>
   table {
     border-spacing: 0.5ch 2px;
   }
   td > textbox {
     width: 100%;
@@ -35,16 +36,18 @@
     vertical-align: top;
     text-align: start;
   }
   th[scope="row"] {
     font-weight: normal;
   }
 </html:style>
 
+#include ../../../../../toolkit/content/editMenuCommands.inc.xul
+
   <tabbox flex="1">
     <tabs>
       <tab id="general_tab" data-l10n-id="certmgr-detail-general-tab-title"/>
       <tab id="prettyprint_tab" data-l10n-id="certmgr-detail-pretty-print-tab-title"/>
     </tabs>
     <tabpanels flex="1">
       <vbox class="box-padded" id="general_info">
         <vbox id="verify_info_box">
diff --git a/security/manager/pki/resources/content/clientauthask.xul b/security/manager/pki/resources/content/clientauthask.xul
--- a/security/manager/pki/resources/content/clientauthask.xul
+++ b/security/manager/pki/resources/content/clientauthask.xul
@@ -19,16 +19,19 @@
   onload="onLoad();">
 
 <stringbundleset id="stringbundleset">
   <stringbundle id="pippki_bundle" src="chrome://pippki/locale/pippki.properties"/>
 </stringbundleset>
 
 <script type="application/javascript" src="chrome://pippki/content/pippki.js"/>
 <script type="application/javascript" src="chrome://pippki/content/clientauthask.js"/>
+<script type="application/javascript" src="chrome://global/content/globalOverlay.js"/>
+
+#include ../../../../../toolkit/content/editMenuCommands.inc.xul
 
 <description style="font-weight: bold;">&clientAuthAsk.message1;</description>
 <description id="hostname"/>
 <description id="organization"/>
 <description id="issuer"/>
 
 <description style="font-weight: bold;">&clientAuthAsk.message2;</description>
 <!-- The items in this menulist must never be sorted,
diff --git a/security/manager/pki/resources/jar.mn b/security/manager/pki/resources/jar.mn
--- a/security/manager/pki/resources/jar.mn
+++ b/security/manager/pki/resources/jar.mn
@@ -2,23 +2,23 @@
 # License, v. 2.0. If a copy of the MPL was not distributed with this
 # file, You can obtain one at http://mozilla.org/MPL/2.0/.
 
 pippki.jar:
 % content pippki %content/pippki/
     content/pippki/certManager.js            (content/certManager.js)
     content/pippki/certManager.xul           (content/certManager.xul)
     content/pippki/certViewer.js             (content/certViewer.js)
-    content/pippki/certViewer.xul            (content/certViewer.xul)
+*   content/pippki/certViewer.xul            (content/certViewer.xul)
     content/pippki/changepassword.js         (content/changepassword.js)
     content/pippki/changepassword.xul        (content/changepassword.xul)
     content/pippki/choosetoken.js            (content/choosetoken.js)
     content/pippki/choosetoken.xul           (content/choosetoken.xul)
     content/pippki/clientauthask.js          (content/clientauthask.js)
-    content/pippki/clientauthask.xul         (content/clientauthask.xul)
+*   content/pippki/clientauthask.xul         (content/clientauthask.xul)
     content/pippki/createCertInfo.js         (content/createCertInfo.js)
     content/pippki/createCertInfo.xul        (content/createCertInfo.xul)
     content/pippki/deletecert.js             (content/deletecert.js)
     content/pippki/deletecert.xul            (content/deletecert.xul)
     content/pippki/device_manager.js         (content/device_manager.js)
     content/pippki/device_manager.xul        (content/device_manager.xul)
     content/pippki/downloadcert.js           (content/downloadcert.js)
     content/pippki/downloadcert.xul          (content/downloadcert.xul)
diff --git a/toolkit/content/editMenuOverlay.js b/toolkit/content/editMenuOverlay.js
--- a/toolkit/content/editMenuOverlay.js
+++ b/toolkit/content/editMenuOverlay.js
@@ -1,22 +1,22 @@
 // -*- indent-tabs-mode: nil; js-indent-level: 2 -*-
 
 /* This Source Code Form is subject to the terms of the Mozilla Public
  * License, v. 2.0. If a copy of the MPL was not distributed with this
  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */
 
 // update menu items that rely on focus or on the current selection
-function goUpdateGlobalEditMenuItems() {
+function goUpdateGlobalEditMenuItems(force) {
   // Don't bother updating the edit commands if they aren't visible in any way
   // (i.e. the Edit menu isn't open, nor is the context menu open, nor have the
   // cut, copy, and paste buttons been added to the toolbars) for performance.
   // This only works in applications/on platforms that set the gEditUIVisible
   // flag, so we check to see if that flag is defined before using it.
-  if (typeof gEditUIVisible != "undefined" && !gEditUIVisible)
+  if (!force && (typeof gEditUIVisible != "undefined" && !gEditUIVisible))
     return;
 
   goUpdateCommand("cmd_undo");
   goUpdateCommand("cmd_redo");
   goUpdateCommand("cmd_cut");
   goUpdateCommand("cmd_copy");
   goUpdateCommand("cmd_paste");
   goUpdateCommand("cmd_selectAll");
@@ -29,8 +29,43 @@ function goUpdateUndoEditMenuItems() {
   goUpdateCommand("cmd_undo");
   goUpdateCommand("cmd_redo");
 }
 
 // update menu items that depend on clipboard contents
 function goUpdatePasteMenuItems() {
   goUpdateCommand("cmd_paste");
 }
+
+// Support context menus on html textareas in the parent process:
+window.addEventListener("contextmenu", (e) => {
+  if (e.target.ownerDocument != document ||
+      e.target.localName != "textarea" || e.target.namespaceURI != "http://www.w3.org/1999/xhtml") {
+    return;
+  }
+
+  let popup = document.getElementById("textbox-contextmenu");
+  if (!popup) {
+    let popupset = document.querySelector("popupset");
+    if (!popupset) {
+      popupset = document.createXULElement("popupset");
+      document.documentElement.appendChild(popupset);
+    }
+    MozXULElement.insertFTLIfNeeded("toolkit/main-window/editmenu.ftl");
+    popupset.appendChild(MozXULElement.parseXULToFragment(`
+      <menupopup id="textbox-contextmenu" class="textbox-contextmenu">
+        <menuitem data-l10n-id="editmenu-undo" command="cmd_undo"></menuitem>
+        <menuseparator></menuseparator>
+        <menuitem data-l10n-id="editmenu-cut" command="cmd_cut"></menuitem>
+        <menuitem data-l10n-id="editmenu-copy" command="cmd_copy"></menuitem>
+        <menuitem data-l10n-id="editmenu-paste" command="cmd_paste"></menuitem>
+        <menuitem data-l10n-id="editmenu-delete" command="cmd_delete"></menuitem>
+        <menuseparator></menuseparator>
+        <menuitem data-l10n-id="editmenu-select-all" command="cmd_selectAll"></menuitem>
+      </menupopup>
+    `));
+
+    popup = popupset.lastElementChild;
+  }
+
+  goUpdateGlobalEditMenuItems(true);
+  popup.openPopupAtScreen(e.screenX, e.screenY, true);
+});
diff --git a/toolkit/content/tests/chrome/chrome.ini b/toolkit/content/tests/chrome/chrome.ini
--- a/toolkit/content/tests/chrome/chrome.ini
+++ b/toolkit/content/tests/chrome/chrome.ini
@@ -10,16 +10,17 @@ support-files =
   bug360437_window.xul
   bug366992_window.xul
   bug409624_window.xul
   bug429723_window.xul
   bug624329_window.xul
   dialog_dialogfocus.xul
   dialog_dialogfocus2.xul
   file_empty.xhtml
+  file_edit_contextmenu.xul
   file_about_networking_wsh.py
   file_autocomplete_with_composition.js
   file_editor_with_autocomplete.js
   findbar_entireword_window.xul
   findbar_events_window.xul
   findbar_window.xul
   frame_popup_anchor.xul
   frame_popupremoving_frame.xul
@@ -103,16 +104,17 @@ skip-if = (os == 'mac' && os_version == 
 skip-if = toolkit == "cocoa"
 [test_button.xul]
 [test_closemenu_attribute.xul]
 [test_contextmenu_list.xul]
 [test_custom_element_base.xul]
 [test_custom_element_delay_connection.xul]
 [test_deck.xul]
 [test_dialogfocus.xul]
+[test_edit-contextmenu.html]
 [test_editor_for_input_with_autocomplete.html]
 [test_editor_for_textbox_with_autocomplete.xul]
 [test_findbar.xul]
 subsuite = clipboard
 [test_findbar_entireword.xul]
 [test_findbar_events.xul]
 [test_focus_anons.xul]
 [test_frames.xul]
diff --git a/toolkit/content/tests/chrome/file_edit_contextmenu.xul b/toolkit/content/tests/chrome/file_edit_contextmenu.xul
new file mode 100644
--- /dev/null
+++ b/toolkit/content/tests/chrome/file_edit_contextmenu.xul
@@ -0,0 +1,28 @@
+<?xml version="1.0" encoding="UTF-8"?>
+<?xml-stylesheet href="chrome://global/skin/global.css"?>
+<window xmlns="http://www.mozilla.org/keymaster/gatekeeper/there.is.only.xul"
+	      xmlns:html="http://www.w3.org/1999/xhtml">
+
+<script type="application/javascript" src="chrome://global/content/globalOverlay.js"/>
+<!-- Copied from toolkit/content/editMenuCommands.inc.xul -->
+<script type="application/javascript" src="chrome://global/content/editMenuOverlay.js"/>
+<commandset id="editMenuCommands">
+  <commandset id="editMenuCommandSetAll" commandupdater="true" events="focus,select"
+              oncommandupdate="goUpdateGlobalEditMenuItems()"/>
+  <commandset id="editMenuCommandSetUndo" commandupdater="true" events="undo"
+              oncommandupdate="goUpdateUndoEditMenuItems()"/>
+  <commandset id="editMenuCommandSetPaste" commandupdater="true" events="clipboard"
+              oncommandupdate="goUpdatePasteMenuItems()"/>
+  <command id="cmd_undo" oncommand="goDoCommand('cmd_undo')"/>
+  <command id="cmd_redo" oncommand="goDoCommand('cmd_redo')"/>
+  <command id="cmd_cut" oncommand="goDoCommand('cmd_cut')"/>
+  <command id="cmd_copy" oncommand="goDoCommand('cmd_copy')"/>
+  <command id="cmd_paste" oncommand="goDoCommand('cmd_paste')"/>
+  <command id="cmd_delete" oncommand="goDoCommand('cmd_delete')"/>
+  <command id="cmd_selectAll" oncommand="goDoCommand('cmd_selectAll')"/>
+  <command id="cmd_switchTextDirection" oncommand="goDoCommand('cmd_switchTextDirection');"/>
+</commandset>
+
+<html:textarea />
+
+</window>
\ No newline at end of file
diff --git a/toolkit/content/tests/chrome/test_edit-contextmenu.html b/toolkit/content/tests/chrome/test_edit-contextmenu.html
new file mode 100644
--- /dev/null
+++ b/toolkit/content/tests/chrome/test_edit-contextmenu.html
@@ -0,0 +1,61 @@
+<!DOCTYPE HTML>
+<html>
+<!--
+https://bugzilla.mozilla.org/show_bug.cgi?id=1513343
+-->
+<head>
+  <meta charset="utf-8">
+  <title>Test for Bug 1513343</title>
+  <script type="application/javascript" src="chrome://mochikit/content/tests/SimpleTest/SimpleTest.js"></script>
+  <script type="application/javascript" src="chrome://mochikit/content/tests/SimpleTest/EventUtils.js"></script>
+  <link rel="stylesheet" type="text/css" href="chrome://global/skin"/>
+  <link rel="stylesheet" type="text/css" href="chrome://mochikit/content/tests/SimpleTest/test.css"/>
+  <script type="application/javascript">
+    const {Services} = ChromeUtils.import("resource://gre/modules/Services.jsm");
+    SimpleTest.waitForExplicitFinish();
+
+
+    async function runTest() {
+      let win = window.open("file_edit_contextmenu.xul", "context-menu", "chrome,width=600,height=600");
+      await new Promise(r => win.addEventListener("load", r, { once: true}));
+      ok(!win.document.getElementById("textbox-contextmenu"), "context menu doesn't exist yet");
+
+      let textarea = win.document.querySelector("textarea");
+      ok(textarea, "textarea exists");
+
+      info("Synthesizing a key so 'Undo' will be enabled");
+      textarea.focus();
+      synthesizeKey("x", {}, win);
+      is(textarea.value, "x", "initial value");
+
+      let popupshown = new Promise(r=>win.addEventListener("popupshown", r, { once: true }));
+      synthesizeMouseAtCenter(textarea, {type: "contextmenu"}, win);
+      let contextmenu = win.document.getElementById("textbox-contextmenu");
+      ok(contextmenu, "context menu exists after right click");
+      await popupshown;
+
+      ok(!contextmenu.querySelector("[command=cmd_undo]").hasAttribute("disabled"), "undo enabled");
+      ok(contextmenu.querySelector("[command=cmd_cut]").hasAttribute("disabled"), "cut disabled");
+      ok(contextmenu.querySelector("[command=cmd_copy]").hasAttribute("disabled"), "copy disabled");
+      ok(!contextmenu.querySelector("[command=cmd_paste]").hasAttribute("disabled"), "paste enabled");
+      ok(contextmenu.querySelector("[command=cmd_delete]").hasAttribute("disabled"), "delete disabled");
+      ok(!contextmenu.querySelector("[command=cmd_selectAll]").hasAttribute("disabled"), "select all enabled");
+
+      contextmenu.querySelector("[command=cmd_undo]").click();
+      is(textarea.value, "", "undo worked");
+
+      SimpleTest.finish();
+    }
+
+  </script>
+</head>
+<body onload="runTest()">
+<a target="_blank" href="https://bugzilla.mozilla.org/show_bug.cgi?id=1513343">Mozilla Bug 1513343</a>
+<p id="display"></p>
+<div id="content" style="display: none">
+
+</div>
+<pre id="test">
+</pre>
+</body>
+</html>
\ No newline at end of file
diff --git a/toolkit/mozapps/update/content/updates.xul b/toolkit/mozapps/update/content/updates.xul
--- a/toolkit/mozapps/update/content/updates.xul
+++ b/toolkit/mozapps/update/content/updates.xul
@@ -27,21 +27,24 @@
         onwizardfinish="gUpdates.onWizardFinish();"
         onwizardcancel="gUpdates.onWizardCancel();"
         onwizardnext="gUpdates.onWizardNext();"
         onload="gUpdates.onLoad();"
         onunload="gUpdates.onUnload();">
 
   <script type="application/javascript" src="chrome://global/content/contentAreaUtils.js"/>
   <script type="application/javascript" src="chrome://mozapps/content/update/updates.js"/>
+  <script type="application/javascript" src="chrome://global/content/globalOverlay.js"/>
 
 #if defined(XP_MACOSX) && MOZ_BUILD_APP == browser
 #include ../../../../browser/base/content/macWindow.inc.xul
 #endif
 
+#include ../../../../toolkit/content/editMenuCommands.inc.xul
+
   <stringbundleset id="updateSet">
     <stringbundle id="brandStrings" src="chrome://branding/locale/brand.properties"/>
     <stringbundle id="updateStrings" src="chrome://mozapps/locale/update/updates.properties"/>
   </stringbundleset>
 
   <wizardpage id="dummy" pageid="dummy" firstpage="true"/>
 
   <wizardpage id="checking" pageid="checking" next="noupdatesfound"
