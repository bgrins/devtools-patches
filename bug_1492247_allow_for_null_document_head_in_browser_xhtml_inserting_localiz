# HG changeset patch
# User Brian Grinstead <bgrinstead@mozilla.com>
# Date 1537300680 25200
#      Tue Sep 18 12:58:00 2018 -0700
# Node ID e62caca177f368cbcafc31ecc875d2f0d0df71f7
# Parent  b7f409bd51c8ae7260c1675785c698a9cb061244
Bug 1492247 - Allow for null document.head in browser.xhtml inserting localization links;r=zbraniecki

This prevents an exception in browser.xhtml when there's no head, since
it's currently sharing the markup with browser.xul.

Differential Revision: https://phabricator.services.mozilla.com/D6194

diff --git a/toolkit/content/customElements.js b/toolkit/content/customElements.js
--- a/toolkit/content/customElements.js
+++ b/toolkit/content/customElements.js
@@ -6,16 +6,17 @@
 
 "use strict";
 
 // This is loaded into all XUL windows. Wrap in a block to prevent
 // leaking to window scope.
 {
 
 ChromeUtils.import("resource://gre/modules/Services.jsm");
+ChromeUtils.import("resource://gre/modules/AppConstants.jsm");
 
 const gXULDOMParser = new DOMParser();
 gXULDOMParser.forceEnableXULXBL();
 
 class MozXULElement extends XULElement {
   /**
    * Allows eager deterministic construction of XUL elements with XBL attached, by
    * parsing an element tree and returning a DOM fragment to be inserted in the
@@ -78,21 +79,26 @@ class MozXULElement extends XULElement {
    * present in the markup.
    *
    * @param path
    *        The path to the FTL file
    */
   static insertFTLIfNeeded(path) {
     let container = document.head || document.querySelector("linkset");
     if (!container) {
-      if (document.contentType != "application/vnd.mozilla.xul+xml") {
+      if (document.contentType == "application/vnd.mozilla.xul+xml") {
+        container = document.createXULElement("linkset");
+        document.documentElement.appendChild(container);
+      } else if (document.documentURI == AppConstants.BROWSER_CHROME_URL) {
+        // Special case for browser.xhtml. Here `document.head` is null, so
+        // just insert the link at the end of the window.
+        container = document.documentElement;
+      } else {
         throw new Error("Attempt to inject localization link before document.head is available");
       }
-      container = document.createXULElement("linkset");
-      document.documentElement.appendChild(container);
     }
 
     for (let link of container.querySelectorAll("link")) {
       if (link.getAttribute("href") == path) {
         return;
       }
     }
 
