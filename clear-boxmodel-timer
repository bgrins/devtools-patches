# HG changeset patch
# User Brian Grinstead <bgrinstead@mozilla.com>
# Parent  1ce926882513cc01fdbc5913c3cfdfd77e62b276
Bug 1147325 - Clear box model timer on markup view destroy;r=pbrosset

Prevents 'this._inspector.toolbox is null' spam in mochitest-dt

diff --git a/browser/devtools/markupview/markup-view.js b/browser/devtools/markupview/markup-view.js
--- a/browser/devtools/markupview/markup-view.js
+++ b/browser/devtools/markupview/markup-view.js
@@ -312,24 +312,26 @@ MarkupView.prototype = {
    * hidden, taking into account that there could already be highlighter requests
    * queued up
    */
   _hideBoxModel: function(forceHide) {
     return this._inspector.toolbox.highlighterUtils.unhighlight(forceHide);
   },
 
   _briefBoxModelTimer: null,
-  _brieflyShowBoxModel: function(nodeFront) {
-    let win = this._frame.contentWindow;
-
+
+  _clearBriefBoxModelTimer: function() {
     if (this._briefBoxModelTimer) {
       clearTimeout(this._briefBoxModelTimer);
       this._briefBoxModelTimer = null;
     }
-
+  },
+
+  _brieflyShowBoxModel: function(nodeFront) {
+    this._clearBriefBoxModelTimer();
     this._showBoxModel(nodeFront);
 
     this._briefBoxModelTimer = setTimeout(() => {
       this._hideBoxModel();
     }, NEW_SELECTION_HIGHLIGHTER_TIMER);
   },
 
   template: function(aName, aDest, aOptions={stack: "markup-view.xhtml"}) {
@@ -1374,16 +1376,17 @@ MarkupView.prototype = {
 
     this._destroyer = promise.resolve();
 
     // Note that if the toolbox is closed, this will work fine, but will fail
     // in case the browser is closed and will trigger a noSuchActor message.
     // We ignore the promise that |_hideBoxModel| returns, since we should still
     // proceed with the rest of destruction if it fails.
     this._hideBoxModel();
+    this._clearBriefBoxModelTimer();
 
     this._elt.removeEventListener("click", this._onMouseClick, false);
 
     this._hoveredNode = null;
     this._inspector.toolbox.off("picker-node-hovered", this._onToolboxPickerHover);
 
     this.htmlEditor.destroy();
     this.htmlEditor = null;
