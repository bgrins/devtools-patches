
# HG changeset patch
# User Brendan Dahl <bdahl@mozilla.com>
# Date 1558494173 0
# Node ID edba72c0c8c6ca88aa62634931c16b247a7e4a11
# Parent  ce28e766055d3719434f980394e5bd1ca5529dcd
Bug 1551320 - Don't allow CreateElement in XUL documents. r=bzbarsky

Soon XUL documents will be loaded as XHTML and createElement will create HTML
elements instead of XUL element by default. This restriction can be removed
once we migrate everything.

Differential Revision: https://phabricator.services.mozilla.com/D31294

diff --git a/dom/base/Document.cpp b/dom/base/Document.cpp
--- a/dom/base/Document.cpp
+++ b/dom/base/Document.cpp
@@ -5518,16 +5518,27 @@ static PseudoStyleType GetPseudoElementT
 already_AddRefed<Element> Document::CreateElement(
     const nsAString& aTagName, const ElementCreationOptionsOrString& aOptions,
     ErrorResult& rv) {
   rv = nsContentUtils::CheckQName(aTagName, false);
   if (rv.Failed()) {
     return nullptr;
   }
 
+  // Temporary check until XULDocument has been removed.
+  if (IsXULDocument()) {
+#if DEBUG
+    xpc_DumpJSStack(true, true, false);
+#endif
+    MOZ_DIAGNOSTIC_ASSERT(false,
+                          "CreateElement() not allowed in XUL document.");
+    rv.Throw(NS_ERROR_FAILURE);
+    return nullptr;
+  }
+
   bool needsLowercase = IsHTMLDocument() && !IsLowercaseASCII(aTagName);
   nsAutoString lcTagName;
   if (needsLowercase) {
     nsContentUtils::ASCIIToLower(aTagName, lcTagName);
   }
 
   const nsString* is = nullptr;
   PseudoStyleType pseudoType = PseudoStyleType::NotPseudo;

