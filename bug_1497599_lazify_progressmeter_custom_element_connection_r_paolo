# HG changeset patch
# User Brian Grinstead <bgrinstead@mozilla.com>
# Date 1539143845 25200
#      Tue Oct 09 20:57:25 2018 -0700
# Node ID 7e5e4298a03fe4555dee596fff34033ad8a3b694
# Parent  7d36ef327268a0c78af2621c7835c4a14d9dc17f
Bug 1497599 - Lazify progressmeter Custom Element connection;r=paolo

Summary:
As outlined by MozXULElement, we:
 - delay connectedCallback logic until after parse
 - wait for isConnectedAndReady before running attributeChangedCallbacks;r=paolo

Reviewers: paolo

Bug #: 1497599

Differential Revision: https://phabricator.services.mozilla.com/D8150

diff --git a/toolkit/content/widgets/progressmeter.js b/toolkit/content/widgets/progressmeter.js
--- a/toolkit/content/widgets/progressmeter.js
+++ b/toolkit/content/widgets/progressmeter.js
@@ -64,28 +64,35 @@ class MozProgressmeter extends MozXULEle
     return val;
   }
 
   isUndetermined() {
     return this.getAttribute("mode") == "undetermined";
   }
 
   connectedCallback() {
+    if (this.delayConnectedCallback()) {
+      return;
+    }
     this._initUI();
   }
 
   disconnectedCallback() {
     this.runAnimation = false;
   }
 
   static get observedAttributes() {
     return [ "mode" ];
   }
 
   attributeChangedCallback(name, oldValue, newValue) {
+    if (!this.isConnectedAndReady) {
+      return;
+    }
+
     if (name === "mode" && oldValue != newValue) {
       this._initUI();
     }
   }
 
   _initUI() {
     let isUndetermined = this.isUndetermined();
     let content = isUndetermined ?
