# HG changeset patch
# Parent 01e2fbcd6455eeceac93360591f3ad034159dd68
# User Brian Grinstead <bgrinstead@mozilla.com>
Bug 1042825 - Project Editor: Prevent undo from undo clearing out the file content;r=jryans


diff --git a/browser/devtools/projecteditor/lib/editors.js b/browser/devtools/projecteditor/lib/editors.js
--- a/browser/devtools/projecteditor/lib/editors.js
+++ b/browser/devtools/projecteditor/lib/editors.js
@@ -208,16 +208,17 @@ var TextEditor = Class({
     return promise.all([
       resource.load(),
       this.appended
     ]).then(([resourceContents])=> {
       if (!this.editor) {
         return;
       }
       this.editor.setText(resourceContents);
+      this.editor.clearHistory();
       this.editor.setClean();
       this.emit("load");
     }, console.error);
   },
 
   /**
    * Save the resource based on the current state of the editor
    *
diff --git a/browser/devtools/projecteditor/test/browser_projecteditor_editing_01.js b/browser/devtools/projecteditor/test/browser_projecteditor_editing_01.js
--- a/browser/devtools/projecteditor/test/browser_projecteditor_editing_01.js
+++ b/browser/devtools/projecteditor/test/browser_projecteditor_editing_01.js
@@ -33,16 +33,20 @@ function testEditFile(projecteditor, fil
   let viewContainer= projecteditor.projectTree.getViewContainer(resource);
   let originalTreeLabel = viewContainer.label.textContent;
 
   is (resource.path, filePath, "Resource path is set correctly");
   is (editor.editor.getText(), initialData, "Editor is loaded with correct file contents");
 
   info ("Setting text in the editor and doing checks before saving");
 
+  editor.editor.undo();
+  editor.editor.undo();
+  is (editor.editor.getText(), initialData, "Editor is still loaded with correct contents after undo");
+
   editor.editor.setText(newData);
   is (editor.editor.getText(), newData, "Editor has been filled with new data");
   is (viewContainer.label.textContent, "*" + originalTreeLabel, "Label is marked as changed");
 
   info ("Saving the editor and checking to make sure the file gets saved on disk");
 
   editor.save(resource);
 
