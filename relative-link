# HG changeset patch
# Parent d8a36b893b2bb9a87e3dde853be3aec2eefeaabb
# User Brian Grinstead <bgrinstead@mozilla.com>
Bug 988887 - [rule view] Relative image URL link is resolving to chrome://browser/content/devtools/;r=pbrosset

diff --git a/browser/devtools/styleinspector/rule-view.js b/browser/devtools/styleinspector/rule-view.js
--- a/browser/devtools/styleinspector/rule-view.js
+++ b/browser/devtools/styleinspector/rule-view.js
@@ -1922,22 +1922,16 @@ function TextPropertyEditor(aRuleEditor,
   this.ruleEditor = aRuleEditor;
   this.doc = this.ruleEditor.doc;
   this.popup = this.ruleEditor.ruleView.popup;
   this.prop = aProperty;
   this.prop.editor = this;
   this.browserWindow = this.doc.defaultView.top;
   this.removeOnRevert = this.prop.value === "";
 
-  let domRule = this.prop.rule.domRule;
-  let href = domRule ? domRule.href : null;
-  if (href) {
-    this.sheetURI = IOService.newURI(href, null, null);
-  }
-
   this._onEnableClicked = this._onEnableClicked.bind(this);
   this._onExpandClicked = this._onExpandClicked.bind(this);
   this._onStartEditing = this._onStartEditing.bind(this);
   this._onNameDone = this._onNameDone.bind(this);
   this._onValueDone = this._onValueDone.bind(this);
   this._onValidate = throttle(this._livePreview, 10, this);
   this.update = this.update.bind(this);
 
@@ -2075,16 +2069,47 @@ TextPropertyEditor.prototype = {
       advanceChars: ';',
       contentType: InplaceEditor.CONTENT_TYPES.CSS_VALUE,
       property: this.prop,
       popup: this.popup
     });
   },
 
   /**
+   * Get the path from which to resolve requests for this
+   * rule's stylesheet.
+   * @return {string} the stylesheet's href
+   */
+  get sheetHref() {
+    let domRule = this.prop.rule.domRule;
+    let href;
+    if (domRule) {
+      href = domRule.href || domRule.nodeHref;
+    }
+    return href;
+  },
+
+  /**
+   * Get the URI from which to resolve relative requests for
+   * this rule's stylesheet.
+   * @return {nsIURI} the stylesheet's URI
+   */
+  get sheetURI() {
+    if (this._sheetURI === undefined) {
+      if (this.sheetHref) {
+        this._sheetURI = IOService.newURI(this.sheetHref, null, null);
+      } else {
+        this._sheetURI = null;
+      }
+    }
+
+    return this._sheetURI;
+  },
+
+  /**
    * Resolve a URI based on the rule stylesheet
    * @param {string} relativePath the path to resolve
    * @return {string} the resolved path.
    */
   resolveURI: function(relativePath) {
     if (this.sheetURI) {
       relativePath = this.sheetURI.resolve(relativePath);
     }
diff --git a/browser/devtools/styleinspector/test/browser_styleinspector_bug_677930_urls_clickable.html b/browser/devtools/styleinspector/test/browser_styleinspector_bug_677930_urls_clickable.html
--- a/browser/devtools/styleinspector/test/browser_styleinspector_bug_677930_urls_clickable.html
+++ b/browser/devtools/styleinspector/test/browser_styleinspector_bug_677930_urls_clickable.html
@@ -1,19 +1,26 @@
 <!-- Any copyright is dedicated to the Public Domain.
      http://creativecommons.org/publicdomain/zero/1.0/ -->
 <html>
   <head>
 
     <link href="./browser_styleinspector_bug_677930_urls_clickable/browser_styleinspector_bug_677930_urls_clickable.css" rel="stylesheet" type="text/css">
 
+    <style>
+    .relative2 {
+        background-image: url(test-image.png);
+    }
+    </style>
   </head>
   <body>
 
-    <div class="relative">Background image with relative path (loaded from external css)</div>
+    <div class="relative1">Background image #1 with relative path (loaded from external css)</div>
+
+    <div class="relative2">Background image #2 with relative path (loaded from style tag)</div>
 
     <div class="absolute">Background image with absolute path (loaded from external css)</div>
 
     <div class="base64">Background image with base64 url (loaded from external css)</div>
 
     <div class="inline" style="background: url(test-image.png);">Background image with relative path (loaded from style attribute)</div>
 
     <div class="inline-resolved" style="background-image: url(./test-image.png)">Background image with resolved relative path (loaded from style attribute)</div>
diff --git a/browser/devtools/styleinspector/test/browser_styleinspector_bug_677930_urls_clickable.js b/browser/devtools/styleinspector/test/browser_styleinspector_bug_677930_urls_clickable.js
--- a/browser/devtools/styleinspector/test/browser_styleinspector_bug_677930_urls_clickable.js
+++ b/browser/devtools/styleinspector/test/browser_styleinspector_bug_677930_urls_clickable.js
@@ -10,82 +10,90 @@ let inspector;
 
 const BASE_URL = "http://example.com/browser/browser/" +
                  "devtools/styleinspector/test/";
 const TEST_URI = BASE_URL +
                  "browser_styleinspector_bug_677930_urls_clickable.html";
 const TEST_IMAGE = BASE_URL + "test-image.png";
 const BASE_64_URL = "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAUAAAAFCAYAAACNbyblAAAAHElEQVQI12P4//8/w38GIAXDIBKE0DHxgljNBAAO9TXL0Y4OHwAAAABJRU5ErkJggg==";
 
-function selectNode(aInspector, aRuleView)
+function setNode(node, inspector)
+{
+  let updated = inspector.once("inspector-updated");
+  inspector.selection.setNode(node);
+  return updated;
+}
+
+function selectNodes(aInspector, aRuleView)
 {
   inspector = aInspector;
   let sidebar = inspector.sidebar;
   let contentDoc = aRuleView.doc;
 
-  let relative = doc.querySelector(".relative");
+  let relative1 = doc.querySelector(".relative1");
+  let relative2 = doc.querySelector(".relative2");
   let absolute = doc.querySelector(".absolute");
   let inline = doc.querySelector(".inline");
   let base64 = doc.querySelector(".base64");
   let noimage = doc.querySelector(".noimage");
   let inlineresolved = doc.querySelector(".inline-resolved");
 
-  ok(relative, "captain, we have the relative div");
+  ok(relative1, "captain, we have the relative1 div");
+  ok(relative2, "captain, we have the relative2 div");
   ok(absolute, "captain, we have the absolute div");
   ok(inline, "captain, we have the inline div");
   ok(base64, "captain, we have the base64 div");
   ok(noimage, "captain, we have the noimage div");
   ok(inlineresolved, "captain, we have the inlineresolved div");
 
-  inspector.selection.setNode(relative);
-  inspector.once("inspector-updated", () => {
-    is(inspector.selection.node, relative, "selection matches the relative element");
+
+  Task.spawn(function*() {
+
+    yield setNode(relative1, inspector);
+    is(inspector.selection.node, relative1, "selection matches the relative1 element");
     let relativeLink = contentDoc.querySelector(".ruleview-propertycontainer a");
-    ok (relativeLink, "Link exists for relative node");
-    ok (relativeLink.getAttribute("href"), TEST_IMAGE);
+    ok (relativeLink, "Link exists for relative1 node");
+    is (relativeLink.getAttribute("href"), TEST_IMAGE, "href matches");
 
-    inspector.selection.setNode(absolute);
-    inspector.once("inspector-updated", () => {
-      is(inspector.selection.node, absolute, "selection matches the absolute element");
-      let absoluteLink = contentDoc.querySelector(".ruleview-propertycontainer a");
-      ok (absoluteLink, "Link exists for absolute node");
-      ok (absoluteLink.getAttribute("href"), TEST_IMAGE);
+    yield setNode(relative2, inspector);
+    is(inspector.selection.node, relative2, "selection matches the relative2 element");
+    let relativeLink = contentDoc.querySelector(".ruleview-propertycontainer a");
+    ok (relativeLink, "Link exists for relative2 node");
+    is (relativeLink.getAttribute("href"), TEST_IMAGE, "href matches");
 
-      inspector.selection.setNode(inline);
-      inspector.once("inspector-updated", () => {
-        is(inspector.selection.node, inline, "selection matches the inline element");
-        let inlineLink = contentDoc.querySelector(".ruleview-propertycontainer a");
-        ok (inlineLink, "Link exists for inline node");
-        ok (inlineLink.getAttribute("href"), TEST_IMAGE);
+    yield setNode(absolute, inspector);
+    is(inspector.selection.node, absolute, "selection matches the absolute element");
+    let absoluteLink = contentDoc.querySelector(".ruleview-propertycontainer a");
+    ok (absoluteLink, "Link exists for absolute node");
+    is (absoluteLink.getAttribute("href"), TEST_IMAGE, "href matches");
 
-        inspector.selection.setNode(base64);
-        inspector.once("inspector-updated", () => {
-          is(inspector.selection.node, base64, "selection matches the base64 element");
-          let base64Link = contentDoc.querySelector(".ruleview-propertycontainer a");
-          ok (base64Link, "Link exists for base64 node");
-          ok (base64Link.getAttribute("href"), BASE_64_URL);
+    yield setNode(inline, inspector);
+    is(inspector.selection.node, inline, "selection matches the inline element");
+    let inlineLink = contentDoc.querySelector(".ruleview-propertycontainer a");
+    ok (inlineLink, "Link exists for inline node");
+    is (inlineLink.getAttribute("href"), TEST_IMAGE, "href matches");
 
-          inspector.selection.setNode(inlineresolved);
-          inspector.once("inspector-updated", () => {
-            is(inspector.selection.node, inlineresolved, "selection matches the style tag element");
-            let inlineResolvedLink = contentDoc.querySelector(".ruleview-propertycontainer a");
-            ok (inlineResolvedLink, "Link exists for style tag node");
-            ok (inlineResolvedLink.getAttribute("href"), TEST_IMAGE);
+    yield setNode(base64, inspector);
+    is(inspector.selection.node, base64, "selection matches the base64 element");
+    let base64Link = contentDoc.querySelector(".ruleview-propertycontainer a");
+    ok (base64Link, "Link exists for base64 node");
+    is (base64Link.getAttribute("href"), BASE_64_URL, "href matches");
 
-            inspector.selection.setNode(noimage);
-            inspector.once("inspector-updated", () => {
-              is(inspector.selection.node, noimage, "selection matches the inline element");
-              let noimageLink = contentDoc.querySelector(".ruleview-propertycontainer a");
-              ok (!noimageLink, "There is no link for the node with no background image");
-              finishUp();
-            });
-          });
-        });
-      });
-    });
+    yield setNode(inlineresolved, inspector);
+    is(inspector.selection.node, inlineresolved, "selection matches the style tag element");
+    let inlineResolvedLink = contentDoc.querySelector(".ruleview-propertycontainer a");
+    ok (inlineResolvedLink, "Link exists for style tag node");
+    is (inlineResolvedLink.getAttribute("href"), TEST_IMAGE, "href matches");
+
+    yield setNode(noimage, inspector);
+    is(inspector.selection.node, noimage, "selection matches the inline element");
+    let noimageLink = contentDoc.querySelector(".ruleview-propertycontainer a");
+    ok (!noimageLink, "There is no link for the node with no background image");
+
+    finishUp();
   });
 }
 
 function finishUp()
 {
   doc = computedView = inspector = null;
   gBrowser.removeCurrentTab();
   finish();
@@ -93,13 +101,13 @@ function finishUp()
 
 function test()
 {
   waitForExplicitFinish();
   gBrowser.selectedTab = gBrowser.addTab();
   gBrowser.selectedBrowser.addEventListener("load", function onLoad(evt) {
     gBrowser.selectedBrowser.removeEventListener(evt.type, onLoad, true);
     doc = content.document;
-    waitForFocus(() => openRuleView(selectNode), content);
+    waitForFocus(() => openRuleView(selectNodes), content);
   }, true);
 
   content.location = TEST_URI;
 }
diff --git a/browser/devtools/styleinspector/test/browser_styleinspector_bug_677930_urls_clickable/browser_styleinspector_bug_677930_urls_clickable.css b/browser/devtools/styleinspector/test/browser_styleinspector_bug_677930_urls_clickable/browser_styleinspector_bug_677930_urls_clickable.css
--- a/browser/devtools/styleinspector/test/browser_styleinspector_bug_677930_urls_clickable/browser_styleinspector_bug_677930_urls_clickable.css
+++ b/browser/devtools/styleinspector/test/browser_styleinspector_bug_677930_urls_clickable/browser_styleinspector_bug_677930_urls_clickable.css
@@ -1,9 +1,9 @@
-.relative {
+.relative1 {
     background-image: url(../test-image.png);
 }
 .absolute {
     background: url("http://example.com/browser/browser/devtools/styleinspector/test/test-image.png");
 }
 .base64 {
     background: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAUAAAAFCAYAAACNbyblAAAAHElEQVQI12P4//8/w38GIAXDIBKE0DHxgljNBAAO9TXL0Y4OHwAAAABJRU5ErkJggg==');
 }
\ No newline at end of file
