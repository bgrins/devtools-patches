# HG changeset patch
# User Jennifer Fong <jen@ednapiranha.com>
Bug 901250 - Scroll selector into view. r=bgrins


diff --git a/browser/devtools/inspector/inspector-panel.js b/browser/devtools/inspector/inspector-panel.js
index 7d187a7..c55bbaa 100644
--- a/browser/devtools/inspector/inspector-panel.js
+++ b/browser/devtools/inspector/inspector-panel.js
@@ -110,16 +110,20 @@ InspectorPanel.prototype = {
   get hasUrlToImageDataResolver() {
     return this._target.client.traits.urlToImageDataResolver;
   },
 
   get canGetUniqueSelector() {
     return this._target.client.traits.getUniqueSelector;
   },
 
+  get canScrollIntoView() {
+    return this._target.client.traits.scrollIntoView;
+  },
+
   get canGetUsedFontFaces() {
     return this._target.client.traits.getUsedFontFaces;
   },
 
   get canPasteInnerOrAdjacentHTML() {
     return this._target.client.traits.pasteHTML;
   },
 
@@ -664,29 +668,36 @@ InspectorPanel.prototype = {
     // Disable delete item if needed
     let deleteNode = this.panelDoc.getElementById("node-menu-delete");
     if (isEditableElement) {
       deleteNode.removeAttribute("disabled");
     } else {
       deleteNode.setAttribute("disabled", "true");
     }
 
-    // Disable / enable "Copy Unique Selector", "Copy inner HTML" &
-    // "Copy outer HTML" as appropriate
+    // Disable / enable "Copy Unique Selector", "Copy inner HTML",
+    // "Copy outer HTML" & "Scroll Into View" as appropriate
     let unique = this.panelDoc.getElementById("node-menu-copyuniqueselector");
     let copyInnerHTML = this.panelDoc.getElementById("node-menu-copyinner");
     let copyOuterHTML = this.panelDoc.getElementById("node-menu-copyouter");
+    let scrollIntoView = this.panelDoc.getElementById("node-menu-scrolltoselector");
+
     if (isSelectionElement) {
       unique.removeAttribute("disabled");
       copyInnerHTML.removeAttribute("disabled");
       copyOuterHTML.removeAttribute("disabled");
+
+      if (this.canScrollIntoView) {
+        scrollIntoView.removeAttribute("disabled");
+      }
     } else {
       unique.setAttribute("disabled", "true");
       copyInnerHTML.setAttribute("disabled", "true");
       copyOuterHTML.setAttribute("disabled", "true");
+      scrollIntoView.setAttribute("disabled", "true");
     }
     if (!this.canGetUniqueSelector) {
       unique.hidden = true;
     }
 
     // Enable the "edit HTML" item if the selection is an element and the root
     // actor has the appropriate trait (isOuterHTMLEditable)
     let editHTML = this.panelDoc.getElementById("node-menu-edithtml");
@@ -991,16 +1002,28 @@ InspectorPanel.prototype = {
     }
 
     this.selection.nodeFront.getUniqueSelector().then((selector) => {
       clipboardHelper.copyString(selector);
     }).then(null, console.error);
   },
 
   /**
+   * Scroll the selector into view.
+   */
+  scrollToSelector: function InspectorPanel_scrollToUniqueSelector()
+  {
+    if (!this.selection.isNode()) {
+      return;
+    }
+
+    this.selection.nodeFront.scrollIntoView();
+  },
+
+  /**
    * Delete the selected node.
    */
   deleteNode: function IUI_deleteNode() {
     if (!this.selection.isNode() ||
          this.selection.isRoot()) {
       return;
     }
 
diff --git a/browser/devtools/inspector/inspector.xul b/browser/devtools/inspector/inspector.xul
index 92c4ab0..380e0aa 100644
--- a/browser/devtools/inspector/inspector.xul
+++ b/browser/devtools/inspector/inspector.xul
@@ -85,16 +85,21 @@
             oncommand="inspector.pasteAdjacentHTML('afterBegin')"/>
           <menuitem id="node-menu-pastelastchild"
             label="&inspectorHTMLPasteLastChild.label;"
             accesskey="&inspectorHTMLPasteLastChild.accesskey;"
             oncommand="inspector.pasteAdjacentHTML('beforeEnd')"/>
         </menupopup>
       </menu>
       <menuseparator/>
+      <menuitem id="node-menu-scrolltoselector"
+        label="&inspectorScrollToSelector.label;"
+        accesskey="&inspectorScrollToSelector.accesskey;"
+        oncommand="inspector.scrollToSelector()"/>
+      <menuseparator/>
       <menuitem id="node-menu-delete"
         label="&inspectorHTMLDelete.label;"
         accesskey="&inspectorHTMLDelete.accesskey;"
         oncommand="inspector.deleteNode()"/>
       <menuseparator/>
       <menuitem id="node-menu-pseudo-hover"
         label=":hover" type="checkbox"
         oncommand="inspector.togglePseudoClass(':hover')"/>
diff --git a/browser/devtools/inspector/test/browser_inspector_menu-01-sensitivity.js b/browser/devtools/inspector/test/browser_inspector_menu-01-sensitivity.js
index 8781765..25e228e 100644
--- a/browser/devtools/inspector/test/browser_inspector_menu-01-sensitivity.js
+++ b/browser/devtools/inspector/test/browser_inspector_menu-01-sensitivity.js
@@ -21,17 +21,18 @@ const ALL_MENU_ITEMS = [
   "node-menu-copyinner",
   "node-menu-copyouter",
   "node-menu-copyuniqueselector",
   "node-menu-copyimagedatauri",
   "node-menu-showdomproperties",
   "node-menu-delete",
   "node-menu-pseudo-hover",
   "node-menu-pseudo-active",
-  "node-menu-pseudo-focus"
+  "node-menu-pseudo-focus",
+  "node-menu-scrolltoselector"
 ].concat(PASTE_MENU_ITEMS);
 
 const ITEMS_WITHOUT_SHOWDOMPROPS =
   ALL_MENU_ITEMS.filter(item => item != "node-menu-showdomproperties");
 
 const TEST_CASES = [
   {
     desc: "doctype node with empty clipboard",
diff --git a/browser/devtools/inspector/test/browser_inspector_menu-04-other.js b/browser/devtools/inspector/test/browser_inspector_menu-04-other.js
index 1f54aa7..6ee6205 100644
--- a/browser/devtools/inspector/test/browser_inspector_menu-04-other.js
+++ b/browser/devtools/inspector/test/browser_inspector_menu-04-other.js
@@ -8,16 +8,17 @@ http://creativecommons.org/publicdomain/zero/1.0/ */
 const TEST_URL = TEST_URL_ROOT + "doc_inspector_menu.html";
 
 add_task(function* () {
   let { inspector, toolbox } = yield openInspectorForURL(TEST_URL);
 
   yield testShowDOMProperties();
   yield testDeleteNode();
   yield testDeleteRootNode();
+  yield testScrollIntoView();
 
   function* testShowDOMProperties() {
     info("Testing 'Show DOM Properties' menu item.");
     let showDOMPropertiesNode = inspector.panelDoc.getElementById("node-menu-showdomproperties");
     ok(showDOMPropertiesNode, "the popup menu has a show dom properties item");
 
     let consoleOpened = toolbox.once("webconsole-ready");
 
@@ -58,16 +59,46 @@ add_task(function* () {
     let deleteNode = inspector.panelDoc.getElementById("node-menu-delete");
     dispatchCommandEvent(deleteNode);
 
     executeSoon(() => {
       ok(content.document.documentElement, "Document element still alive.");
     });
   }
 
+  function* testScrollIntoView() {
+    info("Testing 'Scroll Into View' menu item for normal elements.");
+
+    yield selectNode("#scroll-view", inspector);
+    let showScrollIntoView = inspector.panelDoc.getElementById("node-menu-scrolltoselector");
+    ok(showScrollIntoView, "the popup menu has a scroll into view item");
+
+    let scrollNode = content.document.querySelector("#scroll-view");
+    scrollNode.style.marginTop = "1000px";
+
+    let updated = inspector.once("inspector-updated");
+
+    let rect = scrollNode.getBoundingClientRect();
+    let x = rect.x;
+    let y = rect.y;
+
+    let { data } = yield executeInContent("Test:IsElementInViewport", { x, y });
+    is(data, false, "Element is not in viewport.");
+
+    dispatchCommandEvent(showScrollIntoView);
+    yield updated;
+
+    rect = scrollNode.getBoundingClientRect();
+    x = rect.x;
+    y = rect.y;
+
+    ({ data }) = yield executeInContent("Test:IsElementInViewport", { x, y });
+    is(data, true, "Element is in viewport.");
+  }
+
   function dispatchCommandEvent(node) {
     info("Dispatching command event on " + node);
     let commandEvent = document.createEvent("XULCommandEvent");
     commandEvent.initCommandEvent("command", true, true, window, 0, false, false,
                                   false, false, null);
     node.dispatchEvent(commandEvent);
   }
 });
diff --git a/browser/devtools/inspector/test/doc_frame_script.js b/browser/devtools/inspector/test/doc_frame_script.js
index 9c7a501..95b104a 100644
--- a/browser/devtools/inspector/test/doc_frame_script.js
+++ b/browser/devtools/inspector/test/doc_frame_script.js
@@ -321,16 +321,41 @@ addMessageListener("Test:ScrollWindow", function(msg) {
     let data = {x: content.scrollX, y: content.scrollY};
     sendAsyncMessage("Test:ScrollWindow", data);
   });
 
   content[relative ? "scrollBy" : "scrollTo"](x, y);
 });
 
 /**
+ * Check to see if an element is within the viewport.
+ *
+ * @param {Object} data
+ * - {Number} x
+ * - {Number} y
+ *
+ * @return {Boolean}
+ */
+addMessageListener("Test:IsElementInViewport", function(msg) {
+  let {x, y} = msg.data;
+
+  if (isNaN(x) || isNaN(y)) {
+    sendAsyncMessage("Test:IsElementInViewport", false);
+    return;
+  }
+
+  let inViewport = x >= 0 &&
+                   y >= 0 &&
+                   y <= content.innerHeight &&
+                   x <= content.innerWidth;
+
+  sendAsyncMessage("Test:IsElementInViewport", inViewport);
+});
+
+/**
  * Like document.querySelector but can go into iframes too.
  * ".container iframe || .sub-container div" will first try to find the node
  * matched by ".container iframe" in the root document, then try to get the
  * content document inside it, and then try to match ".sub-container div" inside
  * this document.
  * Any selector coming before the || separator *MUST* match a frame node.
  * @param {String} superSelector.
  * @return {DOMNode} The node, or null if not found.
diff --git a/browser/devtools/inspector/test/doc_inspector_menu.html b/browser/devtools/inspector/test/doc_inspector_menu.html
index 13dbed3..493ac23 100644
--- a/browser/devtools/inspector/test/doc_inspector_menu.html
+++ b/browser/devtools/inspector/test/doc_inspector_menu.html
@@ -11,12 +11,13 @@
         <p class="inner">Unset</p>
         <p class="adjacent">
           <span class="ref">3</span>
         </p>
       </div>
       <p data-id="copy">Paragraph for testing copy</p>
       <p id="sensitivity">Paragraph for sensitivity</p>
       <p id="delete">This has to be deleted</p>
+      <p id="scroll-view">Paragraph for scroll to view</p>
       <img id="copyimage" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAAAAAA6fptVAAAACklEQVQYV2P4DwABAQEAWk1v8QAAAABJRU5ErkJggg==" />
     </div>
   </body>
 </html>
diff --git a/browser/locales/en-US/chrome/browser/devtools/inspector.dtd b/browser/locales/en-US/chrome/browser/devtools/inspector.dtd
index 9d39bef..274c5e7 100644
--- a/browser/locales/en-US/chrome/browser/devtools/inspector.dtd
+++ b/browser/locales/en-US/chrome/browser/devtools/inspector.dtd
@@ -63,16 +63,21 @@
 <!ENTITY inspectorHTMLPasteFirstChild.accesskey  "F">
 
 <!-- LOCALIZATION NOTE (inspectorHTMLPasteLastChild.label): This is the label
      shown in the inspector contextual-menu for the item that lets users paste
      the HTML as the last child the current node -->
 <!ENTITY inspectorHTMLPasteLastChild.label       "As Last Child">
 <!ENTITY inspectorHTMLPasteLastChild.accesskey   "L">
 
+<!-- LOCALIZATION NOTE (inspectorScrollToSelector.label): This is the label
+     shown in the inspector contextual-menu for the item that lets users scroll
+     the current node into view -->
+<!ENTITY inspectorScrollToSelector.label       "Scroll Into View">
+<!ENTITY inspectorScrollToSelector.accesskey   "S">
 
 <!-- LOCALIZATION NOTE (inspectorHTMLDelete.label): This is the label shown in
      the inspector contextual-menu for the item that lets users delete the
      current node -->
 <!ENTITY inspectorHTMLDelete.label          "Delete Node">
 <!ENTITY inspectorHTMLDelete.accesskey      "D">
 
 <!ENTITY inspector.selectButton.tooltip     "Select element with mouse">
diff --git a/toolkit/devtools/server/actors/inspector.js b/toolkit/devtools/server/actors/inspector.js
index b4bc4d3..9ac5dca 100644
--- a/toolkit/devtools/server/actors/inspector.js
+++ b/toolkit/devtools/server/actors/inspector.js
@@ -577,16 +577,26 @@ var NodeActor = exports.NodeActor = protocol.ActorClass({
   }, {
     request: {},
     response: {
       value: RetVal("string")
     }
   }),
 
   /**
+   * Scroll the selected node into view.
+   */
+  scrollIntoView: method(function() {
+    this.rawNode.scrollIntoView(true);
+  }, {
+    request: {},
+    response: {}
+  }),
+
+  /**
    * Get the node's image data if any (for canvas and img nodes).
    * Returns an imageData object with the actual data being a LongStringActor
    * and a size json object.
    * The image data is transmitted as a base64 encoded png data-uri.
    * The method rejects if the node isn't an image or if the image is missing
    *
    * Accepts a maxDim request parameter to resize images that are larger. This
    * is important as the resizing occurs server-side so that image-data being
diff --git a/toolkit/devtools/server/actors/root.js b/toolkit/devtools/server/actors/root.js
index 8de849e..2757447 100644
--- a/toolkit/devtools/server/actors/root.js
+++ b/toolkit/devtools/server/actors/root.js
@@ -137,16 +137,18 @@ RootActor.prototype = {
     // Whether the style rule actor implements the modifySelector method
     // that modifies the rule's selector
     selectorEditable: true,
     // Whether the page style actor implements the addNewRule method that
     // adds new rules to the page
     addNewRule: true,
     // Whether the dom node actor implements the getUniqueSelector method
     getUniqueSelector: true,
+    // Whether the dom node actor implements the scrollIntoView method
+    scrollIntoView: true,
     // Whether the director scripts are supported
     directorScripts: true,
     // Whether the debugger server supports
     // blackboxing/pretty-printing (not supported in Fever Dream yet)
     noBlackBoxing: false,
     noPrettyPrinting: false,
     // Whether the page style actor implements the getUsedFontFaces method
     // that returns the font faces used on a node
diff --git a/toolkit/devtools/server/tests/mochitest/chrome.ini b/toolkit/devtools/server/tests/mochitest/chrome.ini
index b16c4b5..86e9c01 100644
--- a/toolkit/devtools/server/tests/mochitest/chrome.ini
+++ b/toolkit/devtools/server/tests/mochitest/chrome.ini
@@ -47,16 +47,17 @@ skip-if = buildapp == 'mulet'
 [test_inspector-mutations-childlist.html]
 [test_inspector-mutations-frameload.html]
 [test_inspector-mutations-value.html]
 [test_inspector-pseudoclass-lock.html]
 [test_inspector-release.html]
 [test_inspector-reload.html]
 [test_inspector-remove.html]
 [test_inspector-retain.html]
+[test_inspector-scroll-into-view.html]
 [test_inspector-traversal.html]
 [test_makeGlobalObjectReference.html]
 [test_styles-applied.html]
 [test_styles-computed.html]
 [test_styles-matched.html]
 [test_styles-modify.html]
 [test_styles-svg.html]
 [test_unsafeDereference.html]
diff --git a/toolkit/devtools/server/tests/mochitest/test_inspector-scroll-into-view.html b/toolkit/devtools/server/tests/mochitest/test_inspector-scroll-into-view.html
new file mode 100644
index 0000000..3f855cf
--- /dev/null
+++ b/toolkit/devtools/server/tests/mochitest/test_inspector-scroll-into-view.html
@@ -0,0 +1,80 @@
+<!DOCTYPE HTML>
+<html>
+<!--
+https://bugzilla.mozilla.org/show_bug.cgi?id=
+-->
+<head>
+  <meta charset="utf-8">
+  <title>Test for Bug</title>
+
+  <script type="application/javascript" src="chrome://mochikit/content/tests/SimpleTest/SimpleTest.js"></script>
+  <link rel="stylesheet" type="text/css" href="chrome://mochikit/content/tests/SimpleTest/test.css">
+  <script type="application/javascript;version=1.8" src="inspector-helpers.js"></script>
+  <script type="application/javascript;version=1.8">
+Components.utils.import("resource://gre/modules/devtools/Loader.jsm");
+const {Promise: promise} = Components.utils.import("resource://gre/modules/Promise.jsm", {});
+const Ci = Components.interfaces;
+const inspector = devtools.require("devtools/server/actors/inspector");
+
+window.onload = function() {
+  SimpleTest.waitForExplicitFinish();
+  runNextTest();
+}
+
+var gInspectee = null;
+var gClient = null;
+var gWalker = null;
+
+function assertOwnership() {
+  assertOwnershipTrees(gWalker);
+}
+
+addTest(function setup() {
+  let url = document.getElementById("inspectorContent").href;
+  attachURL(url, function(err, client, tab, doc) {
+    gInspectee = doc;
+    let {InspectorFront} = devtools.require("devtools/server/actors/inspector");
+    let inspector = InspectorFront(client, tab);
+    promiseDone(inspector.getWalker().then(walker => {
+      ok(walker, "getWalker() should return an actor.");
+      gClient = client;
+      gWalker = walker;
+    }).then(runNextTest));
+  });
+});
+
+addTest(function testScrollIntoView() {
+  let rect = gInspectee.querySelector("#a").getBoundingClientRect();
+  let nodeFront;
+  promiseDone(gWalker.querySelector(gWalker.rootNode, "#a").then(front => {
+    nodeFront = front;
+    nodeFront.scrollIntoView();
+
+    let inViewport = rect.x >= 0 &&
+                     rect.y >= 0 &&
+                     rect.y <= window.innerHeight &&
+                     rect.x <= window.innerWidth;
+
+    ok(inViewport, "Element is in viewport.");
+  }).then(runNextTest));
+});
+
+addTest(function cleanup() {
+  delete gWalker;
+  delete gInspectee;
+  delete gClient;
+  runNextTest();
+});
+  </script>
+</head>
+<body>
+<a target="_blank" href="https://bugzilla.mozilla.org/show_bug.cgi?id=">Mozilla Bug</a>
+<a id="inspectorContent" target="_blank" href="inspector-traversal-data.html">Test Document</a>
+<p id="display"></p>
+<div id="content" style="display: none">
+
+</div>
+<pre id="test">
+</pre>
+</body>
+</html>
