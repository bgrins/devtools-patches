# HG changeset patch
# User Brian Grinstead <bgrinstead@mozilla.com>
# Parent  18a5781a6b93190d103867948be84227a9895da6
Bug 1150780 - Refactor ruleview tests and add 'empty value' inplace editor test;r=pbrosset

diff --git a/browser/devtools/styleinspector/test/browser.ini b/browser/devtools/styleinspector/test/browser.ini
--- a/browser/devtools/styleinspector/test/browser.ini
+++ b/browser/devtools/styleinspector/test/browser.ini
@@ -75,16 +75,17 @@ skip-if = e10s # Bug 1039528: "inspect e
 [browser_ruleview_cubicbezier-appears-on-swatch-click.js]
 [browser_ruleview_cubicbezier-commit-on-ENTER.js]
 [browser_ruleview_cubicbezier-revert-on-ESC.js]
 [browser_ruleview_edit-property-commit.js]
 [browser_ruleview_edit-property-increments.js]
 [browser_ruleview_edit-property-order.js]
 [browser_ruleview_edit-property_01.js]
 [browser_ruleview_edit-property_02.js]
+[browser_ruleview_edit-property_03.js]
 [browser_ruleview_edit-selector-commit.js]
 [browser_ruleview_edit-selector_01.js]
 [browser_ruleview_edit-selector_02.js]
 [browser_ruleview_eyedropper.js]
 [browser_ruleview_filtereditor-appears-on-swatch-click.js]
 [browser_ruleview_filtereditor-commit-on-ENTER.js]
 [browser_ruleview_filtereditor-revert-on-ESC.js]
 skip-if = (os == "win" && debug) || e10s # bug 963492: win. bug 1040653: e10s.
diff --git a/browser/devtools/styleinspector/test/browser_ruleview_edit-property_01.js b/browser/devtools/styleinspector/test/browser_ruleview_edit-property_01.js
--- a/browser/devtools/styleinspector/test/browser_ruleview_edit-property_01.js
+++ b/browser/devtools/styleinspector/test/browser_ruleview_edit-property_01.js
@@ -1,84 +1,97 @@
 /* vim: set ft=javascript ts=2 et sw=2 tw=80: */
 /* Any copyright is dedicated to the Public Domain.
  http://creativecommons.org/publicdomain/zero/1.0/ */
 
 "use strict";
 
-// Testing various inplace-editor behaviors in the rule-view
-// FIXME: To be split in several test files, and some of the inplace-editor
-// focus/blur/commit/revert stuff should be factored out in head.js
+// Testing adding new properties via the inplace-editors in the rule
+// view.
+// FIXME: some of the inplace-editor focus/blur/commit/revert stuff
+// should be factored out in head.js
 
-let TEST_URL = 'url("' + TEST_URL_ROOT + 'doc_test_image.png")';
-let PAGE_CONTENT = [
+let BACKGROUND_IMAGE_URL = 'url("' + TEST_URL_ROOT + 'doc_test_image.png")';
+let TEST_URI = [
   '<style type="text/css">',
-  '  #testid {',
-  '    background-color: blue;',
-  '  }',
-  '  .testclass {',
-  '    background-color: green;',
-  '  }',
+  '#testid {',
+  '  color: red;',
+  '  background-color: blue;',
+  '}',
+  '.testclass, .unmatched {',
+  '  background-color: green;',
+  '}',
   '</style>',
-  '<div id="testid" class="testclass">Styled Node</div>'
+  '<div id="testid" class="testclass">Styled Node</div>',
+  '<div id="testid2">Styled Node</div>'
 ].join("\n");
 
+let TEST_DATA = [
+  { name: "border-color", value: "red", isValid: true },
+  { name: "background-image", value: BACKGROUND_IMAGE_URL, isValid: true },
+  { name: "border", value: "solid 1px foo", isValid: false },
+];
+
 add_task(function*() {
-  let tab = yield addTab("data:text/html;charset=utf-8,test rule view user changes");
-
-  info("Creating the test document");
-  content.document.body.innerHTML = PAGE_CONTENT;
+  let tab = yield addTab("data:text/html;charset=utf-8," + encodeURIComponent(TEST_URI));
 
   info("Opening the rule-view");
   let {toolbox, inspector, view} = yield openRuleView();
 
   info("Selecting the test element");
   yield selectNode("#testid", inspector);
 
-  yield testEditProperty(view, "border-color", "red", tab.linkedBrowser);
-  yield testEditProperty(view, "background-image", TEST_URL, tab.linkedBrowser);
+  let ruleEditor = getRuleViewRuleEditor(view, 1);
+  for (let {name, value, isValid} of TEST_DATA) {
+    yield testEditProperty(ruleEditor, name, value, isValid);
+  }
 });
 
-function* testEditProperty(view, name, value, browser) {
+function* testEditProperty(ruleEditor, name, value, isValid) {
   info("Test editing existing property name/value fields");
 
-  let idRuleEditor = getRuleViewRuleEditor(view, 1);
-  let propEditor = idRuleEditor.rule.textProps[0].editor;
+  let doc = ruleEditor.doc;
+  let propEditor = ruleEditor.rule.textProps[0].editor;
 
   info("Focusing an existing property name in the rule-view");
   let editor = yield focusEditableField(propEditor.nameSpan, 32, 1);
 
   is(inplaceEditor(propEditor.nameSpan), editor, "The property name editor got focused");
   let input = editor.input;
 
   info("Entering a new property name, including : to commit and focus the value");
-  let onValueFocus = once(idRuleEditor.element, "focus", true);
-  let onModifications = idRuleEditor.rule._applyingModifications;
+  let onValueFocus = once(ruleEditor.element, "focus", true);
+  let onModifications = ruleEditor.rule._applyingModifications;
   for (let ch of name + ":") {
-    EventUtils.sendChar(ch, view.doc.defaultView);
+    EventUtils.sendChar(ch, doc.defaultView);
   }
   yield onValueFocus;
   yield onModifications;
 
   // Getting the value editor after focus
-  editor = inplaceEditor(view.doc.activeElement);
+  editor = inplaceEditor(doc.activeElement);
   input = editor.input;
   is(inplaceEditor(propEditor.valueSpan), editor, "Focus moved to the value.");
 
   info("Entering a new value, including ; to commit and blur the value");
   let onBlur = once(input, "blur");
-  onModifications = idRuleEditor.rule._applyingModifications;
+  onModifications = ruleEditor.rule._applyingModifications;
   for (let ch of value + ";") {
-    EventUtils.sendChar(ch, view.doc.defaultView);
+    EventUtils.sendChar(ch, doc.defaultView);
   }
   yield onBlur;
   yield onModifications;
 
-  is(propEditor.isValid(), true, value + " is a valid entry");
+  is(propEditor.isValid(), isValid, value + " is " + isValid ? "valid" : "invalid");
 
   info("Checking that the style property was changed on the content page");
   let propValue = yield executeInContent("Test:GetRulePropertyValue", {
     styleSheetIndex: 0,
     ruleIndex: 0,
     name
   });
-  is(propValue, value, name + " should have been set.");
-}
+
+  if (isValid) {
+    is(propValue, value, name + " should have been set.");
+  } else {
+    isnot(propValue, value, name + " shouldn't have been set.");
+  }
+}
\ No newline at end of file
diff --git a/browser/devtools/styleinspector/test/browser_ruleview_edit-property_02.js b/browser/devtools/styleinspector/test/browser_ruleview_edit-property_02.js
--- a/browser/devtools/styleinspector/test/browser_ruleview_edit-property_02.js
+++ b/browser/devtools/styleinspector/test/browser_ruleview_edit-property_02.js
@@ -1,38 +1,38 @@
 /* vim: set ft=javascript ts=2 et sw=2 tw=80: */
 /* Any copyright is dedicated to the Public Domain.
  http://creativecommons.org/publicdomain/zero/1.0/ */
 
 "use strict";
 
 // Test several types of rule-view property edition
 
+let TEST_URI = [
+  '<style type="text/css">',
+  '#testid {',
+  '  background-color: blue;',
+  '}',
+  '.testclass, .unmatched {',
+  '  background-color: green;',
+  '}',
+  '</style>',
+  '<div id="testid" class="testclass">Styled Node</div>',
+  '<div id="testid2">Styled Node</div>'
+].join("\n");
+
 add_task(function*() {
-  yield addTab("data:text/html;charset=utf-8,browser_ruleview_ui.js");
+  let tab = yield addTab("data:text/html;charset=utf-8," + encodeURIComponent(TEST_URI));
+
   let {toolbox, inspector, view} = yield openRuleView();
 
-  info("Creating the test document");
-  let style = "" +
-    "#testid {" +
-    "  background-color: blue;" +
-    "}" +
-    ".testclass, .unmatched {" +
-    "  background-color: green;" +
-    "}";
-  let styleNode = addStyle(content.document, style);
-  content.document.body.innerHTML = "<div id='testid' class='testclass'>Styled Node</div>" +
-                                    "<div id='testid2'>Styled Node</div>";
-
   yield selectNode("#testid", inspector);
   yield testEditProperty(inspector, view);
   yield testDisableProperty(inspector, view);
   yield testPropertyStillMarkedDirty(inspector, view);
-
-  gBrowser.removeCurrentTab();
 });
 
 function* testEditProperty(inspector, ruleView) {
   let idRuleEditor = getRuleViewRuleEditor(ruleView, 1);
   let propEditor = idRuleEditor.rule.textProps[0].editor;
 
   let editor = yield focusEditableField(propEditor.nameSpan);
   let input = editor.input;
diff --git a/browser/devtools/styleinspector/test/browser_ruleview_edit-property_03.js b/browser/devtools/styleinspector/test/browser_ruleview_edit-property_03.js
new file mode 100644
--- /dev/null
+++ b/browser/devtools/styleinspector/test/browser_ruleview_edit-property_03.js
@@ -0,0 +1,162 @@
+/* vim: set ft=javascript ts=2 et sw=2 tw=80: */
+/* Any copyright is dedicated to the Public Domain.
+ http://creativecommons.org/publicdomain/zero/1.0/ */
+
+"use strict";
+
+// Tests that emptying out an existing value removes the property and
+// doesn't cause any other issues.
+// See also Bug 1150780.
+
+let TEST_URI = [
+  '<style type="text/css">',
+  '#testid {',
+  '  color: red;',
+  '  background-color: blue;',
+  '  font-size: 12px;',
+  '}',
+  '.testclass, .unmatched {',
+  '  background-color: green;',
+  '}',
+  '</style>',
+  '<div id="testid" class="testclass">Styled Node</div>',
+  '<div id="testid2">Styled Node</div>'
+].join("\n");
+
+add_task(function*() {
+  let tab = yield addTab("data:text/html;charset=utf-8," + encodeURIComponent(TEST_URI));
+
+  info("Opening the rule-view");
+  let {toolbox, inspector, view} = yield openRuleView();
+
+  info("Selecting the test element");
+  yield selectNode("#testid", inspector);
+
+  let ruleEditor = getRuleViewRuleEditor(view, 1);
+  let doc = ruleEditor.doc;
+
+  let propEditor = ruleEditor.rule.textProps[1].editor;
+  let editor = yield focusEditableField(propEditor.valueSpan);
+  let onValueFocus = once(ruleEditor.element, "focus", true);
+  for (let ch of ["VK_DELETE", "VK_RETURN"]) {
+    EventUtils.sendChar(ch, doc.defaultView);
+  }
+  yield ruleEditor.rule._applyingModifications;
+  yield onValueFocus;
+
+  // editor = inplaceEditor(doc.activeElement);
+
+
+  // info("Entering a new value, including ; to commit and blur the value");
+  let onBlur = once(doc.activeElement, "blur");
+  onValueFocus = once(ruleEditor.element, "focus", true);
+  // onModifications = ruleEditor.rule._applyingModifications;
+  EventUtils.sendChar("VK_RETURN", doc.defaultView);
+  // for (let ch of value + ";") {
+  //   EventUtils.sendChar(ch, doc.defaultView);
+  // }
+  yield onValueFocus;
+  onValueFocus = once(ruleEditor.element, "focus", true);
+  EventUtils.sendChar("VK_RETURN", doc.defaultView);
+  yield onValueFocus;
+  onValueFocus = once(ruleEditor.element, "focus", true);
+  EventUtils.sendChar("VK_RETURN", doc.defaultView);
+  yield onValueFocus;
+  yield ruleEditor.rule._applyingModifications;
+
+  is (ruleEditor.rule.textProps[1].editor.nameSpan.style.display, "block", "huh");
+  console.log("WaT");
+  // yield promise.defer().promise;
+  yield ruleEditor.rule._applyingModifications;
+  // yield onModifications;
+
+
+//   let input = editor.input;
+//   is(inplaceEditor(ruleEditor.rule.textProps[1].editor.nameSpan), editor, "Focus moved to the value.");
+
+//   onModifications = ruleEditor.rule._applyingModifications;
+//   console.log(doc.activeElement.outerHTML);
+//   for (let ch of ["VK_ESCAPE"]) {
+//     EventUtils.sendChar(ch, doc.defaultView);
+//   }
+
+//   doc.defaultView.setTimeout(() => {
+//   doc.activeElement.blur();
+
+// }, 100);
+//   yield onModifications;
+//   yield promise.defer().promise;
+  // editor.input.blur();
+  // let onBlur = once(editor.input, "blur");
+  // onModifications = ruleEditor.rule._applyingModifications;
+  // for (let ch of ["VK_RETURN"]) {
+  //   EventUtils.sendChar(ch, doc.defaultView);
+  // }
+  // yield onBlur;
+  // yield onModifications;
+
+
+  // let propEditor = ruleEditor.rule.textProps[0].editor;
+  // let editor = yield focusEditableField(propEditor.valueSpan);
+  // let onModifications = ruleEditor.rule._applyingModifications;
+  // yield editFieldAndWaitForBlur(propEditor.valueSpan, ["VK_DELETE", "VK_RETURN"]);
+  // info ("Waiting for modifications to be applied");
+  // yield onModifications;
+
+  // let wait = promise.defer();
+  // setTimeout(wait.resolve, 1000);
+
+  // onModifications = ruleEditor.rule._applyingModifications;
+  // yield wait.promise;
+  // yield editFieldAndWaitForBlur(ruleEditor.doc.activeElement, ["VK_RETURN"]);
+
+  // info ("Waiting for modifications to be applied");
+  // yield onModifications;
+
+  is (ruleEditor.rule.textProps.length, 2, "Correct number of props");
+  // is (inplaceEditor(doc.activeElement), inplaceEditor(ruleEditor.rule.textProps[0].editor.valueSpan),
+      // "Correct element is focused");
+  yield promise.defer().promise;
+
+
+
+
+  // Check to make sure that emptying out an existing value doesn't
+  // create a second inplace editor (Bug 1150780)
+  // let propEditor = ruleEditor.rule.textProps[0].editor;
+  // let onModifications = ruleEditor.rule._applyingModifications;
+  // yield editFieldAndWaitForBlur(propEditor.valueSpan, ["VK_DELETE", "VK_RETURN"]);
+  // info ("Waiting for modifications to be applied");
+  // yield onModifications;
+
+  // let wait = promise.defer();
+  // setTimeout(wait.resolve, 1000);
+
+  // onModifications = ruleEditor.rule._applyingModifications;
+  // yield wait.promise;
+  // yield editFieldAndWaitForBlur(ruleEditor.doc.activeElement, ["VK_RETURN"]);
+
+  // info ("Waiting for modifications to be applied");
+  // yield onModifications;
+
+  // is (ruleEditor.rule.textProps.length, 2, "Correct number of props");
+  // is (inplaceEditor(doc.activeElement), inplaceEditor(ruleEditor.rule.textProps[0].editor.valueSpan),
+  //     "Correct element is focused");
+  // yield promise.defer().promise;
+
+});
+
+function* editFieldAndWaitForBlur(element, chars) {
+  let editor = yield focusEditableField(element);
+  let input = editor.input;
+
+  is(inplaceEditor(element), editor, "The correct field got focused");
+
+  let onBlur = once(input, "blur");
+  for (let ch of chars) {
+    EventUtils.sendChar(ch, element.ownerDocument.defaultView);
+  }
+
+  info ("Waiting for blur");
+  yield onBlur;
+}
diff --git a/browser/devtools/styleinspector/test/head.js b/browser/devtools/styleinspector/test/head.js
--- a/browser/devtools/styleinspector/test/head.js
+++ b/browser/devtools/styleinspector/test/head.js
@@ -408,23 +408,24 @@ function* waitForComputedStyleProperty(s
 }
 
 /**
  * Given an inplace editable element, click to switch it to edit mode, wait for
  * focus
  * @return a promise that resolves to the inplace-editor element when ready
  */
 let focusEditableField = Task.async(function*(editable, xOffset=1, yOffset=1, options={}) {
-  let onFocus = once(editable.parentNode, "focus", true);
+  if (editable.ownerDocument.activeElement !== editable) {
+    let onFocus = once(editable.parentNode, "focus", true);
 
-  info("Clicking on editable field to turn to edit mode");
-  EventUtils.synthesizeMouse(editable, xOffset, yOffset, options,
-    editable.ownerDocument.defaultView);
-  let event = yield onFocus;
-
+    info("Clicking on editable field to turn to edit mode");
+    EventUtils.synthesizeMouse(editable, xOffset, yOffset, options,
+      editable.ownerDocument.defaultView);
+    let event = yield onFocus;
+  }
   info("Editable field gained focus, returning the input field now");
   return inplaceEditor(editable.ownerDocument.activeElement);
 });
 
 /**
  * Given a tooltip object instance (see Tooltip.js), checks if it is set to
  * toggle and hover and if so, checks if the given target is a valid hover target.
  * This won't actually show the tooltip (the less we interact with XUL panels
