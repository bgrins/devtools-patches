
# HG changeset patch
# User Julian Descottes <jdescottes@mozilla.com>
# Date 1462367183 -7200
# Node ID 11adf45730cdb9ca3b27fbd5e368062275215841
# Parent  09874a1e6f2c942a1f9de827fedd14da7e67a6e5
Bug 1259834 - example: Use HTML tooltips to display markupview image previews;f=bgrins

MozReview-Commit-ID: DNsi215ndAU

diff --git a/devtools/client/inspector/markup/markup.js b/devtools/client/inspector/markup/markup.js
--- a/devtools/client/inspector/markup/markup.js
+++ b/devtools/client/inspector/markup/markup.js
@@ -35,6 +35,9 @@
 const promise = require("promise");
 const Services = require("Services");
 const {Tooltip} = require("devtools/client/shared/widgets/Tooltip");
+const {HTMLTooltip} = require("devtools/client/shared/widgets/HTMLTooltip");
+const {getImageTooltipContent} = require("devtools/client/shared/widgets/ImageTooltipHelper");
+
 const EventEmitter = require("devtools/shared/event-emitter");
 const Heritage = require("sdk/core/heritage");
 const {setTimeout, clearTimeout, setInterval, clearInterval} =
@@ -169,6 +172,7 @@
 
   _initTooltips: function () {
     this.tooltip = new Tooltip(this._inspector.panelDoc);
+    this.htmlTooltip = new HTMLTooltip(this._inspector.toolbox);
     this._makeTooltipPersistent(false);
   },
 
@@ -176,8 +180,8 @@
     if (state) {
       this.tooltip.stopTogglingOnHover();
     } else {
-      this.tooltip.startTogglingOnHover(this._elt,
-        this._isImagePreviewTarget.bind(this));
+      // this.tooltip.startTogglingOnHover(this._elt,
+      //   this._isImagePreviewTarget.bind(this));
     }
   },
 
@@ -279,9 +283,29 @@
       // With the newly found container, delegate the tooltip content creation
       // and decision to show or not the tooltip
       container._buildEventTooltipContent(event.target, this.tooltip);
+      this._maybeShowImageTooltip(container, event.target);
     }
   },
 
+  _maybeShowImageTooltip: function (container, target) {
+    if (!container.isPreviewable()) {
+      return;
+    }
+    let src = container.editor.getAttributeElement("src");
+    let expected = src ? src.querySelector(".link") : container.editor.tag;
+    if (target !== expected) {
+      return;
+    }
+
+    Task.spawn(function* () {
+      let {data, size} = yield container._getPreview();
+      let tooltipInfo = getImageTooltipContent(this.doc, data, size);
+      let {content, width, height} = tooltipInfo;
+      yield this.htmlTooltip.setContent(content, width, height);
+      this.htmlTooltip.show(src.querySelector(".link"));
+    }.bind(this));
+  },
+
   _onMouseUp: function () {
     this.indicateDropTarget(null);
     this.indicateDragTarget(null);
diff --git a/devtools/client/shared/widgets/ImageTooltipHelper.js b/devtools/client/shared/widgets/ImageTooltipHelper.js
new file mode 100644
--- /dev/null
+++ b/devtools/client/shared/widgets/ImageTooltipHelper.js
@@ -0,0 +1,48 @@
+/* -*- indent-tabs-mode: nil; js-indent-level: 2 -*- */
+/* vim: set ft=javascript ts=2 et sw=2 tw=80: */
+/* This Source Code Form is subject to the terms of the Mozilla Public
+ * License, v. 2.0. If a copy of the MPL was not distributed with this
+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */
+
+"use strict";
+
+const XHTML_NS = "http://www.w3.org/1999/xhtml";
+// The image preview should not exceed 200x200px
+const MAX_DIMENSION = 200;
+
+exports.getImageTooltipContent = function (doc, imageUrl, options) {
+  let div = doc.createElementNS(XHTML_NS, "div");
+  div.style.cssText = `
+    box-sizing: border-box;
+    height: 100%;
+    display: flex;
+    flex-direction: column;
+    text-align: center;
+    background: rgba(245, 245, 245, 0.9);
+    border: 3px solid rgb(215, 225, 233);
+    border-radius: 5px;
+  `;
+
+  let {naturalWidth, naturalHeight} = options;
+  let scale = MAX_DIMENSION / Math.max(naturalHeight, naturalWidth);
+  scale = Math.min(scale, 1);
+  // Preferred image preview height
+  let imgHeight = scale * naturalHeight;
+  let imgWidth = scale * naturalWidth;
+  let label = naturalWidth + " \u00D7 " + naturalHeight;
+
+  div.innerHTML = `
+    <div style="flex: 1; min-height: 1px; padding: 3px">
+      <img style="height: ${imgHeight}px; max-height: 100%;" src="${imageUrl}"/>
+    </div>
+    <div style="height: 16px; text-align: center;">
+      <span class="theme-comment devtools-tooltip-caption">${label}</span>
+    </div>`;
+
+  // Add 6px for the border, 6px for the image padding, 16px for the label
+  let height = imgHeight + 6 + 6 + 16;
+  // Add 6px for the border, 6px for the image padding
+  let width = imgWidth + 6 + 6;
+
+  return {content: div, width, height};
+};
diff --git a/devtools/client/shared/widgets/moz.build b/devtools/client/shared/widgets/moz.build
--- a/devtools/client/shared/widgets/moz.build
+++ b/devtools/client/shared/widgets/moz.build
@@ -17,6 +17,7 @@
     'Graphs.js',
     'GraphsWorker.js',
     'HTMLTooltip.js',
+    'ImageTooltipHelper.js',
     'LineGraphWidget.js',
     'MdnDocsWidget.js',
     'MountainGraphWidget.js',
diff --git a/devtools/client/themes/common.css b/devtools/client/themes/common.css
--- a/devtools/client/themes/common.css
+++ b/devtools/client/themes/common.css
@@ -238,6 +238,9 @@
   display: none;
   position: fixed;
   z-index: 9999;
+
+  border-radius: 5px;
+  box-shadow: 1px 1px 4px 0 rgba(0, 0, 0, 0.5);
 }
 
 /* links to source code, like displaying `myfile.js:45` */

