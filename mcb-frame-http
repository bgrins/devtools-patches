# HG changeset patch
# User Brian Grinstead <bgrinstead@mozilla.com>
# Parent  ed330384b899edd297e60867425e70b0a5520f0f
Bug 1192162 - Show not-secure icon in Control Center for http pages that have https frames with MCB;r=tanvi

diff --git a/browser/base/content/test/general/browser_mixedContentFramesOnHttp.js b/browser/base/content/test/general/browser_mixedContentFramesOnHttp.js
--- a/browser/base/content/test/general/browser_mixedContentFramesOnHttp.js
+++ b/browser/base/content/test/general/browser_mixedContentFramesOnHttp.js
@@ -35,16 +35,17 @@ function SecStateTests() {
   whenLoaded(gTestBrowser, SecStateTest1);
   gTestBrowser.contentWindow.location = url;
 }
 
 // The http page loads an https frame with an http image.
 function SecStateTest1() {
   // check security state is insecure
   isSecurityState("insecure");
+  assertMixedContentBlockingState(gTestBrowser, {activeLoaded: false, activeBlocked: false, passiveLoaded: true});
 
   SecStateTestsCompleted();
 }
 
 function whenLoaded(aElement, aCallback) {
   aElement.addEventListener("load", function onLoad() {
     aElement.removeEventListener("load", onLoad, true);
     executeSoon(aCallback);
diff --git a/browser/base/content/test/general/head.js b/browser/base/content/test/general/head.js
--- a/browser/base/content/test/general/head.js
+++ b/browser/base/content/test/general/head.js
@@ -810,16 +810,35 @@ function assertMixedContentBlockingState
   is(bodyAttr.contains("active-blocked"), activeBlocked,
       "securityView-body has expected attr for activeBlocked");
 
   is(popupAttr.contains("passive-loaded"), passiveLoaded,
       "identity-popup has expected attr for passiveLoaded");
   is(bodyAttr.contains("passive-loaded"), passiveLoaded,
       "securityView-body has expected attr for passiveLoaded");
 
+  let securityView = doc.getElementById("identity-popup-securityView");
+  let securityContent = doc.getElementById("identity-popup-security-content");
+
+  let securityViewBG = tabbrowser.ownerGlobal.getComputedStyle(securityView, "").getPropertyValue("background-image");
+  let securityContentBG = tabbrowser.ownerGlobal.getComputedStyle(securityView, "").getPropertyValue("background-image");
+
+  if (activeBlocked) {
+    is(securityViewBG, "chrome://browser/skin/controlcenter/conn-not-secure.svg", "Using active blocked icon");
+    is(securityContentBG, "chrome://browser/skin/controlcenter/conn-not-secure.svg", "Using active blocked icon");
+  } else if (activeLoaded) {
+    is(securityViewBG, "chrome://browser/skin/controlcenter/mcb-disabled.svg", "Using active loaded icon");
+    is(securityContentBG, "chrome://browser/skin/controlcenter/mcb-disabled.svg", "Using active loaded icon");
+  } else if (passiveLoaded) {
+    is(securityViewBG, "chrome://browser/skin/controlcenter/conn-degraded.svg", "Using active loaded icon");
+    is(securityContentBG, "chrome://browser/skin/controlcenter/conn-degraded.svg", "Using active loaded icon");
+  }
+
+  is(securityViewBG, "chrome://browser/skin/controlcenter/conn-not-secure.svg", "what");
+
   gIdentityHandler._identityPopup.hidden = true;
 }
 
 function makeActionURI(action, params) {
   let url = "moz-action:" + action + "," + JSON.stringify(params);
   return NetUtil.newURI(url);
 }
 
diff --git a/browser/themes/shared/controlcenter/panel.inc.css b/browser/themes/shared/controlcenter/panel.inc.css
--- a/browser/themes/shared/controlcenter/panel.inc.css
+++ b/browser/themes/shared/controlcenter/panel.inc.css
@@ -217,16 +217,23 @@
   background-image: url(chrome://browser/skin/controlcenter/conn-degraded.svg);
 }
 
 #identity-popup[mixedcontent~=active-loaded] #identity-popup-securityView,
 #identity-popup[mixedcontent~=active-loaded] #identity-popup-security-content {
   background-image: url(chrome://browser/skin/controlcenter/mcb-disabled.svg);
 }
 
+/* Make sure that non-secure connections always show the correct icon. Works
+   around case where there is an https iframe with MCB inside an http page. */
+#identity-popup[connection=not-secure] #identity-popup-securityView,
+#identity-popup[connection=not-secure] #identity-popup-security-content {
+  background-image: url(chrome://browser/skin/controlcenter/conn-not-secure.svg);
+}
+
 #identity-popup-security-descriptions > description {
   margin-top: 6px;
   color: Graytext;
 }
 
 #identity-popup-securityView-header {
   border-bottom: 1px solid var(--panel-separator-color);
   padding-bottom: 1em;
