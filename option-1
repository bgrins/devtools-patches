# HG changeset patch
# User Brian Grinstead <bgrinstead@mozilla.com>
# Parent  a15ba287ac6fd84643d248ace00bf18c18382ada
Bug 1584641 - Investigation - can we use an html element with content: <url> instead of <xul:image>?

diff --git a/browser/base/content/browser.xhtml b/browser/base/content/browser.xhtml
--- a/browser/base/content/browser.xhtml
+++ b/browser/base/content/browser.xhtml
@@ -869,19 +869,19 @@
               <box id="tracking-protection-icon-container" align="center"
                    role="button"
                    onclick="gProtectionsHandler.handleProtectionsButtonEvent(event);"
                    onkeypress="gProtectionsHandler.handleProtectionsButtonEvent(event);"
                    onmouseover="gProtectionsHandler.onTrackingProtectionIconHoveredOrFocused();"
                    onfocus="gProtectionsHandler.onTrackingProtectionIconHoveredOrFocused();">
                 <box id="tracking-protection-icon-box" animationsenabled="true"
                      tooltip="tracking-protection-icon-tooltip">
-                  <image id="tracking-protection-icon"/>
+                  <html:moz-image id="tracking-protection-icon"/>
                   <box id="tracking-protection-icon-animatable-box" flex="1">
-                    <image id="tracking-protection-icon-animatable-image" flex="1"/>
+                    <html:moz-image id="tracking-protection-icon-animatable-image" flex="1"/>
                   </box>
                 </box>
                 <tooltip id="tracking-protection-icon-tooltip">
                   <description id="tracking-protection-icon-tooltip-label" class="tooltip-label"/>
                 </tooltip>
               </box>
               <box id="identity-box" role="button"
                    align="center"
diff --git a/browser/themes/shared/identity-block/identity-block.inc.css b/browser/themes/shared/identity-block/identity-block.inc.css
--- a/browser/themes/shared/identity-block/identity-block.inc.css
+++ b/browser/themes/shared/identity-block/identity-block.inc.css
@@ -295,21 +295,21 @@
   animation-name: tp-icon-animation-rtl;
 }
 
 #tracking-protection-icon-tooltip {
   max-width: 500px;
 }
 
 #urlbar-input-container[pageproxystate="valid"] > #tracking-protection-icon-container > #tracking-protection-icon-box > #tracking-protection-icon {
-  list-style-image: url(chrome://browser/skin/tracking-protection.svg);
+  content: url(chrome://browser/skin/tracking-protection.svg);
 }
 
 #urlbar-input-container[pageproxystate="valid"] > #tracking-protection-icon-container > #tracking-protection-icon-box[hasException] > #tracking-protection-icon {
-  list-style-image: url(chrome://browser/skin/tracking-protection-disabled.svg);
+  content: url(chrome://browser/skin/tracking-protection-disabled.svg);
 }
 
 #urlbar-input-container[pageproxystate="valid"] > #tracking-protection-icon-container > #tracking-protection-icon-box > #tracking-protection-icon:-moz-locale-dir(rtl) {
   transform: scaleX(-1);
 }
 
 #urlbar-input-container[pageproxystate="invalid"] > #tracking-protection-icon-container {
   visibility: collapse;
diff --git a/toolkit/content/widgets/general.js b/toolkit/content/widgets/general.js
--- a/toolkit/content/widgets/general.js
+++ b/toolkit/content/widgets/general.js
@@ -2,16 +2,62 @@
  * License, v. 2.0. If a copy of the MPL was not distributed with this
  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */
 
 "use strict";
 
 // This is loaded into chrome windows with the subscript loader. Wrap in
 // a block to prevent accidentally leaking globals onto `window`.
 {
+  class MozImage extends HTMLElement {
+    connectedCallback() {
+      if (this.hasAttribute("src")) {
+        this.src = this.getAttribute("src");
+      }
+
+      // Debugging for missed consumers
+      let listStyleImage = window
+        .getComputedStyle(this)
+        .getPropertyValue("list-style-image");
+      if (listStyleImage) {
+        let el = this;
+        let id = this.closest("[id]") && this.closest("[id]").id;
+        while (!id && el.getRootNode()) {
+          let host = el.getRootNode().host;
+          el = host;
+          id = host.closest("[id]") && host.closest("[id]").id;
+        }
+        console.log(
+          `Need to migrate list-style-image (${listStyleImage})`,
+          el,
+          `id: ${id}`
+        );
+      }
+    }
+
+    set src(val) {
+      // TODO: Set/remove content: <url> as inline style
+    }
+
+    removeAttribute(name) {
+      if (name == "src") {
+        this.src = null;
+      }
+      super.removeAttribute(name);
+    }
+    setAttribute(name, val) {
+      if (name == "src") {
+        this.src = val;
+        console.log("Src set");
+      }
+      super.setAttribute(name, val);
+    }
+  }
+  customElements.define("moz-image", MozImage);
+
   class MozDeck extends MozXULElement {
     set selectedIndex(val) {
       if (this.selectedIndex == val) {
         return val;
       }
       this.setAttribute("selectedIndex", val);
       var event = document.createEvent("Events");
       event.initEvent("select", true, true);
diff --git a/toolkit/content/widgets/toolbarbutton.js b/toolkit/content/widgets/toolbarbutton.js
--- a/toolkit/content/widgets/toolbarbutton.js
+++ b/toolkit/content/widgets/toolbarbutton.js
@@ -41,31 +41,31 @@
 
         ".toolbarbutton-badge": "value=badge,style=badgeStyle",
       };
     }
 
     static get fragment() {
       let frag = document.importNode(
         MozXULElement.parseXULToFragment(`
-        <image class="toolbarbutton-icon"></image>
+        <html:moz-image class="toolbarbutton-icon" />
         <label class="toolbarbutton-text" crop="right" flex="1"></label>
         <label class="toolbarbutton-multiline-text" flex="1"></label>
         <dropmarker type="menu" class="toolbarbutton-menu-dropmarker"></dropmarker>`),
         true
       );
       Object.defineProperty(this, "fragment", { value: frag });
       return frag;
     }
 
     static get badgedFragment() {
       let frag = document.importNode(
         MozXULElement.parseXULToFragment(`
         <stack class="toolbarbutton-badge-stack">
-          <image class="toolbarbutton-icon"/>
+          <html:moz-image class="toolbarbutton-icon"/>
           <label class="toolbarbutton-badge" top="0" end="0" crop="none"/>
         </stack>
         <label class="toolbarbutton-text" crop="right" flex="1"/>
         <label class="toolbarbutton-multiline-text" flex="1"/>
         <dropmarker anonid="dropmarker" type="menu"
                     class="toolbarbutton-menu-dropmarker"/>`),
         true
       );
