# HG changeset patch
# User Brian Grinstead <bgrinstead@mozilla.com>
# Parent  1ad52513bd33132510afca31ca04df3d3fc8a9ec
Bug 1237368 - CSS tricks to make webconsole output scroll faster

diff --git a/devtools/client/themes/webconsole.css b/devtools/client/themes/webconsole.css
--- a/devtools/client/themes/webconsole.css
+++ b/devtools/client/themes/webconsole.css
@@ -132,21 +132,19 @@ a {
 }
 
 #output-wrapper {
   direction: ltr;
   overflow: auto;
 }
 
 #output-container {
+  /* XXX: Set this to a hardcoded px width in webconsole.js */
+  width: 100vw;
   -moz-user-select: text;
-  -moz-box-flex: 1;
-  display: flex;
-  flex-direction: column;
-  align-items: flex-start;
 }
 
 #output-container.hideTimestamps > .message {
   -moz-padding-start: 0;
   -moz-margin-start: 7px;
   width: calc(100% - 7px);
 }
 
diff --git a/devtools/client/webconsole/webconsole.js b/devtools/client/webconsole/webconsole.js
--- a/devtools/client/webconsole/webconsole.js
+++ b/devtools/client/webconsole/webconsole.js
@@ -27,16 +27,17 @@ loader.lazyRequireGetter(this, "system",
 loader.lazyRequireGetter(this, "Timers", "sdk/timers");
 loader.lazyImporter(this, "VariablesView", "resource://devtools/client/shared/widgets/VariablesView.jsm");
 loader.lazyImporter(this, "VariablesViewController", "resource://devtools/client/shared/widgets/VariablesViewController.jsm");
 loader.lazyImporter(this, "PluralForm", "resource://gre/modules/PluralForm.jsm");
 loader.lazyImporter(this, "gDevTools", "resource://devtools/client/framework/gDevTools.jsm");
 
 const STRINGS_URI = "chrome://devtools/locale/webconsole.properties";
 var l10n = new WebConsoleUtils.l10n(STRINGS_URI);
+let avgTime = 0;
 
 const XHTML_NS = "http://www.w3.org/1999/xhtml";
 
 const MIXED_CONTENT_LEARN_MORE = "https://developer.mozilla.org/docs/Security/MixedContent";
 
 const TRACKING_PROTECTION_LEARN_MORE = "https://developer.mozilla.org/Firefox/Privacy/Tracking_Protection";
 
 const INSECURE_PASSWORDS_LEARN_MORE = "https://developer.mozilla.org/docs/Security/InsecurePasswords";
@@ -498,16 +499,19 @@ WebConsoleFrame.prototype = {
     if (system.constants.platform === "macosx") {
       doc.querySelector("#key_clearOSX").removeAttribute("disabled");
     } else {
       doc.querySelector("#key_clear").removeAttribute("disabled");
     }
 
     this.filterBox = doc.querySelector(".hud-filter-box");
     this.outputNode = doc.getElementById("output-container");
+    // this.outputWrapper = doc.getElementById("output-wrapper");
+    // console.log(this.outputWrapper);
+    // this.outputNode.style.width = this.outputWrapper.clientWidth + "px";
     this.completeNode = doc.querySelector(".jsterm-complete-node");
     this.inputNode = doc.querySelector(".jsterm-input-node");
 
     this._setFilterTextBoxEvents();
     this._initFilterButtons();
 
     let fontSize = this.owner._browserConsole ?
                    Services.prefs.getIntPref("devtools.webconsole.fontSize") : 0;
@@ -2078,17 +2082,22 @@ WebConsoleFrame.prototype = {
     let isInputOutput = lastVisibleNode &&
                         (lastVisibleNode.category == CATEGORY_INPUT ||
                          lastVisibleNode.category == CATEGORY_OUTPUT);
 
     // Scroll to the new node if it is not filtered, and if the output node is
     // scrolled at the bottom or if the new node is a jsterm input/output
     // message.
     if (lastVisibleNode && (scrolledToBottom || isInputOutput)) {
+      let start = new Date();
       Utils.scrollToVisible(lastVisibleNode);
+      // scrollNode.scrollTop = 100000000;
+      var time = ((new Date()) - start);
+      avgTime = avgTime * .9 + time * .1;
+      dump("Scrolling to bottom" + time + " avg: " + avgTime + " num elements: " + this.outputNode.childElementCount + "\n");
     }
     else if (!scrolledToBottom && removedNodes > 0 &&
              oldScrollHeight != scrollNode.scrollHeight) {
       // If there were pruned messages and if scroll is not at the bottom, then
       // we need to adjust the scroll location.
       scrollNode.scrollTop -= oldScrollHeight - scrollNode.scrollHeight;
     }
 
diff --git a/devtools/client/webconsole/webconsole.xul b/devtools/client/webconsole/webconsole.xul
--- a/devtools/client/webconsole/webconsole.xul
+++ b/devtools/client/webconsole/webconsole.xul
@@ -197,18 +197,23 @@ function goUpdateConsoleCommands() {
 
         <spacer flex="1"/>
 
         <textbox class="compact hud-filter-box devtools-searchinput" type="search"
                  placeholder="&filterOutput.placeholder;" tabindex="2"/>
       </toolbar>
 
       <hbox id="output-wrapper" flex="1" context="output-contextmenu" tooltip="aHTMLTooltip">
-        <div xmlns="http://www.w3.org/1999/xhtml" id="output-container"
-             tabindex="0" role="document" aria-live="polite" />
+        <!-- Hack to make scrolling in output-container much faster.
+             Don't fully understand, but getting rid of this block parent
+             makes scrolling 10x slower. -->
+        <div xmlns="http://www.w3.org/1999/xhtml">
+          <div xmlns="http://www.w3.org/1999/xhtml" id="output-container"
+               tabindex="0" role="document" aria-live="polite" />
+        </div>
       </hbox>
       <notificationbox id="webconsole-notificationbox">
         <hbox class="jsterm-input-container" style="direction:ltr">
           <stack class="jsterm-stack-node" flex="1">
             <textbox class="jsterm-complete-node devtools-monospace"
                      multiline="true" rows="1" tabindex="-1"/>
             <textbox class="jsterm-input-node devtools-monospace"
                      multiline="true" rows="1" tabindex="0"
