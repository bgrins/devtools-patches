# HG changeset patch
# User Brian Grinstead <bgrinstead@mozilla.com>
# Parent  75df995ccf81dfed7c8d8eda716482f70cb0a75a
Bug 1497975 - Prevent layouts during parse of browser.xhtml

By hiding the documentElement in a script at the top of the page and then
showing it again in a script at the bottom, we can avoid inadvertently
constructing XBL bindings as a result scripts running during parse (like
Custom Element connectedCallback).

This more closely matches XUL document behavior, where the initial
layout doesn't happen until everything is parsed and loaded. It also
lets us call gBrowserInit.onBeforeInitialXULLayout actually before
layout happens.

diff --git a/browser/base/content/browser.xul b/browser/base/content/browser.xul
--- a/browser/base/content/browser.xul
+++ b/browser/base/content/browser.xul
@@ -77,26 +77,26 @@
 # that they can be shared with macWindow.inc.xul.
 #include global-scripts.inc
 
 <script type="application/javascript"
 #ifdef BROWSER_XHTML
 xmlns="http://www.w3.org/1999/xhtml"
 #endif
 >
+#ifdef BROWSER_XHTML
+  document.documentElement.style.display = "none";
+#endif
   Services.scriptloader.loadSubScript("chrome://global/content/contentAreaUtils.js", this);
   Services.scriptloader.loadSubScript("chrome://browser/content/tabbrowser.js", this);
 
   window.onload = gBrowserInit.onLoad.bind(gBrowserInit);
   window.onunload = gBrowserInit.onUnload.bind(gBrowserInit);
   window.onclose = WindowIsClosing;
-#ifdef BROWSER_XHTML
-  window.addEventListener("DOMContentLoaded",
-    gBrowserInit.onBeforeInitialXULLayout.bind(gBrowserInit), { once: true });
-#else
+#ifndef BROWSER_XHTML
   window.addEventListener("MozBeforeInitialXULLayout",
     gBrowserInit.onBeforeInitialXULLayout.bind(gBrowserInit), { once: true });
 #endif
   // The listener of DOMContentLoaded must be set on window, rather than
   // document, because the window can go away before the event is fired.
   // In that case, we don't want to initialize anything, otherwise we
   // may be leaking things because they will never be destroyed after.
   window.addEventListener("DOMContentLoaded",
@@ -753,17 +753,16 @@ xmlns="http://www.w3.org/1999/xhtml"
              class="browser-toolbar titlebar-color"
              fullscreentoolbar="true"
              customizable="true"
              mode="icons"
              aria-label="&tabsToolbar.label;"
              context="toolbar-context-menu">
       <hbox class="titlebar-placeholder" type="pre-tabs"
             skipintoolbarset="true"/>
-
       <tabs id="tabbrowser-tabs"
             flex="1"
             setfocus="false"
             tooltip="tabbrowser-tab-tooltip"
             stopwatchid="FX_TAB_CLICK_MS">
         <tab class="tabbrowser-tab" selected="true" visuallyselected="true" fadein="true"/>
       </tabs>
 
@@ -1365,9 +1364,16 @@ xmlns="http://www.w3.org/1999/xhtml"
       &pointerlockWarning.generic.label;
     </html:div>
   </html:div>
 
   <vbox id="browser-bottombox" layer="true">
     <notificationbox id="global-notificationbox" notificationside="bottom"/>
   </vbox>
 
+#ifdef BROWSER_XHTML
+<script type="application/javascript" xmlns="http://www.w3.org/1999/xhtml">
+gBrowserInit.onBeforeInitialXULLayout();
+document.documentElement.style.display = "-moz-box";
+</script>
+#endif
+
 </window>
