# HG changeset patch
# User Brian Grinstead <bgrinstead@mozilla.com>
# Parent  e83e691af84f6ad6051d1bcf334f711575a933a4
Bug 1521280 - Support non-anonymous html:input inside of xul:textbox in nsFocusManager::GetRedirectedFocus

There's a special case for the old about:config search field for SessionStore (CollectFromXULTextbox)
that calls into nsFocusManager::GetRedirectedFocus. Since we are going to make this input field
non-anonymous for xul:textbox[type=search], we need to add support for this case.

diff --git a/dom/base/nsFocusManager.cpp b/dom/base/nsFocusManager.cpp
--- a/dom/base/nsFocusManager.cpp
+++ b/dom/base/nsFocusManager.cpp
@@ -332,16 +332,23 @@ Element* nsFocusManager::GetRedirectedFo
         return textControl;
       }
     }
   }
 
 #ifdef MOZ_XUL
   if (aContent->IsXULElement()) {
     if (aContent->IsXULElement(nsGkAtoms::textbox)) {
+      // Support [type=search] which has a non-anonyomus html:input, along with the XBL
+      // textboxes which have an anonymous html:input.
+      ErrorResult rv;
+      Element* nonAnonInput = aContent->AsElement()->QuerySelector(NS_LITERAL_STRING(".textbox-input"), rv);
+      if (nonAnonInput) {
+        return nonAnonInput;
+      }
       return aContent->OwnerDoc()->GetAnonymousElementByAttribute(
           aContent, nsGkAtoms::anonid, NS_LITERAL_STRING("input"));
     } else {
       nsCOMPtr<nsIDOMXULMenuListElement> menulist =
           aContent->AsElement()->AsXULMenuList();
       if (menulist) {
         RefPtr<Element> inputField;
         menulist->GetInputField(getter_AddRefs(inputField));
