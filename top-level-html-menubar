# HG changeset patch
# User Brian Grinstead <bgrinstead@mozilla.com>
# Parent  17db33b6a124422d43a9f518bea1bc62a698126b
Run with: ./mach run --temp-profile --chrome chrome://browser/content/menu-tester.html --jsconsole

MozReview-Commit-ID: BDZZrOONWyy

diff --git a/browser/base/content/menu-tester.html b/browser/base/content/menu-tester.html
new file mode 100644
--- /dev/null
+++ b/browser/base/content/menu-tester.html
@@ -0,0 +1,257 @@
+<!-- This Source Code Form is subject to the terms of the Mozilla Public
+   - License, v. 2.0. If a copy of the MPL was not distributed with this
+   - file, You can obtain one at http://mozilla.org/MPL/2.0/. -->
+<!DOCTYPE html>
+<html dir=""
+      windowtype="navigator:browser"
+      width="900" height="350"
+      onload="gBrowserInit.onLoad()"
+      onunload="gBrowserInit.onUnload()"
+      onclose="return WindowIsClosing();"
+      >
+<head>
+  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
+  <link rel="stylesheet" href="chrome://global/content/xul.css" />
+</head>
+<body role="application">
+  <div id="content"></div>
+
+  <script>
+  Components.utils.import("resource://gre/modules/Services.jsm");
+
+  function parseXULDOM(str) {
+    const d = new DOMParser();
+    d.forceEnableXULXBL();
+    const doc = d.parseFromString(
+      `<box xmlns="http://www.mozilla.org/keymaster/gatekeeper/there.is.only.xul">${str}</box>`,
+      "application/xml");
+    const range = doc.createRange();
+    range.selectNodeContents(doc.firstChild);
+    return range.extractContents();
+  }
+
+  const XUL_NS = "http://www.mozilla.org/keymaster/gatekeeper/there.is.only.xul";
+  const content = document.querySelector("#content");
+
+// This actually seems to work for a top-level menu!
+// Try it with:
+// ./mach run --temp-profile --chrome chrome://browser/content/menu-tester.html --jsconsole
+  content.appendChild(parseXULDOM(`
+<command id="cmd_newNavigatorTab" oncommand="alert('command worked??');"/>
+<toolbox id="navigator-toolbox">
+  <toolbar type="menubar" id="toolbar-menubar"
+           class="chromeclass-menubar titlebar-color"
+           customizable="true"
+           mode="icons"
+           context="toolbar-context-menu">
+    <toolbaritem id="menubar-items" align="center">
+     <menubar id="main-menubar">
+      <menu id="file-menu" label="fileMenu.label;">
+        <menupopup id="menu_FilePopup">
+          <menuitem id="menu_newNavigatorTab"
+                    label="tabCmd.label;"
+                    command="cmd_newNavigatorTab"
+                    key="key_newNavigatorTab"/>
+        </menupopup>
+      </menu>
+     </menubar>
+    </toolbaritem>
+  </toolbar>
+</toolbox>
+  `));
+
+
+/* Some markup to try for figuring out context menus:
+<popupset>
+<menupopup id="toolbar-context-menu">
+  <menuitem oncommand="gCustomizeMode.addToPanel(document.popupNode)"
+            accesskey="customizeMenu.pinToOverflowMenu.accesskey;"
+            label="customizeMenu.pinToOverflowMenu.label;"
+            contexttype="toolbaritem"
+            class="customize-context-moveToPanel"/>
+  <menuitem oncommand="onDownloadsAutoHideChange(event)"
+            type="checkbox"
+            accesskey="customizeMenu.autoHideDownloadsButton.accesskey;"
+            label="customizeMenu.autoHideDownloadsButton.label;"
+            contexttype="toolbaritem"
+            class="customize-context-autoHide"/>
+  <menuitem oncommand="gCustomizeMode.removeFromArea(document.popupNode)"
+            accesskey="customizeMenu.removeFromToolbar.accesskey;"
+            label="customizeMenu.removeFromToolbar.label;"
+            contexttype="toolbaritem"
+            class="customize-context-removeFromToolbar"/>
+  <menuitem id="toolbar-context-reloadAllTabs"
+            class="toolbaritem-tabsmenu"
+            contexttype="tabbar"
+            oncommand="gBrowser.reloadAllTabs();"
+            label="toolbarContextMenu.reloadAllTabs.label;"
+            accesskey="toolbarContextMenu.reloadAllTabs.accesskey;"/>
+  <menuitem id="toolbar-context-bookmarkAllTabs"
+            class="toolbaritem-tabsmenu"
+            contexttype="tabbar"
+            command="Browser:BookmarkAllTabs"
+            label="toolbarContextMenu.bookmarkAllTabs.label;"
+            accesskey="toolbarContextMenu.bookmarkAllTabs.accesskey;"/>
+  <menuitem id="toolbar-context-undoCloseTab"
+            class="toolbaritem-tabsmenu"
+            contexttype="tabbar"
+            label="toolbarContextMenu.undoCloseTab.label;"
+            accesskey="toolbarContextMenu.undoCloseTab.accesskey;"
+            observes="History:UndoCloseTab"/>
+  <menuseparator/>
+  <menuseparator id="viewToolbarsMenuSeparator"/>
+  <menuitem oncommand="gCustomizeMode.enter()"
+            observes="cmd_CustomizeToolbars"
+            class="viewCustomizeToolbar"
+            label="viewCustomizeToolbar.label;"
+            accesskey="viewCustomizeToolbar.accesskey;"/>
+</menupopup>
+
+<menupopup id="placesContext"
+           onpopupshowing="this._view = PlacesUIUtils.getViewForNode(document.popupNode);
+                           if (!PlacesUIUtils.openInTabClosesMenu) {
+                             document.getElementById ('placesContext_open:newtab')
+                             .setAttribute('closemenu', 'single');
+                           }
+                           return this._view.buildContextMenu(this);"
+           onpopuphiding="this._view.destroyContextMenu();">
+  <menuitem id="placesContext_open"
+            command="placesCmd_open"
+            label="cmd.open.label;"
+            accesskey="cmd.open.accesskey;"
+            default="true"
+            selectiontype="single"
+            selection="link"/>
+  <menuitem id="placesContext_open:newtab"
+            command="placesCmd_open:tab"
+            label="cmd.open_tab.label;"
+            accesskey="cmd.open_tab.accesskey;"
+            selectiontype="single"
+            selection="link"/>
+  <menuitem id="placesContext_openContainer:tabs"
+            oncommand="var view = PlacesUIUtils.getViewForNode(document.popupNode);
+                       view.controller.openSelectionInTabs(event);"
+            onclick="checkForMiddleClick(this, event);"
+            label="cmd.open_all_in_tabs.label;"
+            accesskey="cmd.open_all_in_tabs.accesskey;"
+            selectiontype="single|none"
+            selection="folder|host|query"/>
+  <menuitem id="placesContext_openLinks:tabs"
+            oncommand="var view = PlacesUIUtils.getViewForNode(document.popupNode);
+                       view.controller.openSelectionInTabs(event);"
+            onclick="checkForMiddleClick(this, event);"
+            label="cmd.open_all_in_tabs.label;"
+            accesskey="cmd.open_all_in_tabs.accesskey;"
+            selectiontype="multiple"
+            selection="link"/>
+  <menuitem id="placesContext_open:newwindow"
+            command="placesCmd_open:window"
+            label="cmd.open_window.label;"
+            accesskey="cmd.open_window.accesskey;"
+            selectiontype="single"
+            selection="link"/>
+  <menuitem id="placesContext_open:newprivatewindow"
+            command="placesCmd_open:privatewindow"
+            label="cmd.open_private_window.label;"
+            accesskey="cmd.open_private_window.accesskey;"
+            selectiontype="single"
+            selection="link"
+            hideifprivatebrowsing="true"/>
+  <menuseparator id="placesContext_openSeparator"/>
+  <menuitem id="placesContext_new:bookmark"
+            command="placesCmd_new:bookmark"
+            label="cmd.new_bookmark.label;"
+            accesskey="cmd.new_bookmark.accesskey;"
+            selectiontype="any"
+            hideifnoinsertionpoint="true"/>
+  <menuitem id="placesContext_new:folder"
+            command="placesCmd_new:folder"
+            label="cmd.new_folder.label;"
+            accesskey="cmd.context_new_folder.accesskey;"
+            selectiontype="any"
+            hideifnoinsertionpoint="true"/>
+  <menuitem id="placesContext_new:separator"
+            command="placesCmd_new:separator"
+            label="cmd.new_separator.label;"
+            accesskey="cmd.new_separator.accesskey;"
+            closemenu="single"
+            selectiontype="any"
+            hideifnoinsertionpoint="true"/>
+  <menuseparator id="placesContext_newSeparator"/>
+  <menuitem id="placesContext_createBookmark"
+            command="placesCmd_createBookmark"
+            selection="link"
+            forcehideselection="bookmark|tagChild"/>
+  <menuitem id="placesContext_cut"
+            command="placesCmd_cut"
+            label="cutCmd.label;"
+            accesskey="cutCmd.accesskey;"
+            closemenu="single"
+            selection="bookmark|folder|separator|query"
+            forcehideselection="tagChild|livemarkChild"/>
+  <menuitem id="placesContext_copy"
+            command="placesCmd_copy"
+            label="copyCmd.label;"
+            closemenu="single"
+            accesskey="copyCmd.accesskey;"
+            selection="any"/>
+  <menuitem id="placesContext_paste"
+            command="placesCmd_paste"
+            label="pasteCmd.label;"
+            closemenu="single"
+            accesskey="pasteCmd.accesskey;"
+            selectiontype="any"
+            hideifnoinsertionpoint="true"/>
+  <menuseparator id="placesContext_editSeparator"/>
+  <menuitem id="placesContext_delete"
+            command="placesCmd_delete"
+            label="deleteCmd.label;"
+            accesskey="deleteCmd.accesskey;"
+            closemenu="single"
+            selection="bookmark|tagChild|folder|query|dynamiccontainer|separator|host"/>
+  <menuitem id="placesContext_delete_history"
+            command="placesCmd_delete"
+            closemenu="single"
+            selection="link"
+            forcehideselection="bookmark"/>
+  <menuitem id="placesContext_deleteHost"
+            command="placesCmd_deleteDataHost"
+            label="cmd.deleteDomainData.label;"
+            accesskey="cmd.deleteDomainData.accesskey;"
+            closemenu="single"
+            selection="link|host"
+            selectiontype="single"
+            forcehideselection="bookmark"/>
+  <menuseparator id="placesContext_deleteSeparator"/>
+  <menuitem id="placesContext_sortBy:name"
+            command="placesCmd_sortBy:name"
+            label="cmd.sortby_name.label;"
+            accesskey="cmd.context_sortby_name.accesskey;"
+            closemenu="single"
+            selection="folder"/>
+  <menuitem id="placesContext_reload"
+            command="placesCmd_reload"
+            label="cmd.reloadLivebookmark.label;"
+            accesskey="cmd.reloadLivebookmark.accesskey;"
+            closemenu="single"
+            selection="livemark"/>
+  <menuseparator id="placesContext_sortSeparator"/>
+  <menuitem id="placesContext_show:info"
+            command="placesCmd_show:info"
+            label="cmd.properties.label;"
+            accesskey="cmd.properties.accesskey;"
+            selection="bookmark|folder|query"
+            forcehideselection="livemarkChild"/>
+</menupopup>
+
+<menupopup id="menu_ToolsPopup"></menupopup>
+<menupopup id="tabContextMenu"></menupopup>
+</popupset>
+
+
+<box context="toolbar-context-menu">Right click</box>
+
+*/
+  </script>
+</body>
+</html>
\ No newline at end of file
diff --git a/browser/base/jar.mn b/browser/base/jar.mn
--- a/browser/base/jar.mn
+++ b/browser/base/jar.mn
@@ -91,16 +91,17 @@ browser.jar:
         content/browser/defaultthemes/4.header.png    (content/defaultthemes/4.header.png)
         content/browser/defaultthemes/4.icon.png      (content/defaultthemes/4.icon.png)
         content/browser/defaultthemes/4.preview.png   (content/defaultthemes/4.preview.png)
         content/browser/defaultthemes/5.header.png    (content/defaultthemes/5.header.png)
         content/browser/defaultthemes/5.icon.jpg      (content/defaultthemes/5.icon.jpg)
         content/browser/defaultthemes/5.preview.jpg   (content/defaultthemes/5.preview.jpg)
         content/browser/defaultthemes/dark.icon.svg   (content/defaultthemes/dark.icon.svg)
         content/browser/defaultthemes/light.icon.svg  (content/defaultthemes/light.icon.svg)
+        content/browser/menu-tester.html              (content/menu-tester.html)
 *       content/browser/pageinfo/pageInfo.xul         (content/pageinfo/pageInfo.xul)
         content/browser/pageinfo/pageInfo.js          (content/pageinfo/pageInfo.js)
         content/browser/pageinfo/pageInfo.css         (content/pageinfo/pageInfo.css)
         content/browser/pageinfo/feeds.js             (content/pageinfo/feeds.js)
         content/browser/pageinfo/permissions.js       (content/pageinfo/permissions.js)
         content/browser/pageinfo/security.js          (content/pageinfo/security.js)
         content/browser/robot.ico                     (content/robot.ico)
         content/browser/static-robot.png              (content/static-robot.png)
