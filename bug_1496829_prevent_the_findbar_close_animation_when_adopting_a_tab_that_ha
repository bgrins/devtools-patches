# HG changeset patch
# User Brian Grinstead <bgrinstead@mozilla.com>
# Date 1538773061 25200
#      Fri Oct 05 13:57:41 2018 -0700
# Node ID a77c76721b1359612a6d99dd3ff9a96934e9b874
# Parent  97208b5251d7e86cb4051711609b6236a944981e
Bug 1496829 - Prevent the findbar close animation when adopting a tab that has a previously-closed findbar

The connectedCallback fires after it's already in the DOM. By setting hidden before it's appended
we can avoid the CSS animation.

Differential Revision: https://phabricator.services.mozilla.com/D7930

diff --git a/browser/base/content/tabbrowser.js b/browser/base/content/tabbrowser.js
--- a/browser/base/content/tabbrowser.js
+++ b/browser/base/content/tabbrowser.js
@@ -513,16 +513,20 @@ window._gBrowser = {
 
   /**
    * Create a findbar instance.
    * @param aTab the tab to create the find bar for.
    * @return the created findbar, or null if the window or tab is closed/closing.
    */
   async _createFindBar(aTab) {
     let findBar = document.createXULElement("findbar");
+    // The findbar is hidden until it gets requested to open.
+    // By setting the attribute before appending we avoid the close animation
+    // in case it will never get opened (i.e. when adopting a tab into a new window).
+    findBar.hidden = true;
     let browser = this.getBrowserForTab(aTab);
     let browserContainer = this.getBrowserContainer(browser);
     browserContainer.appendChild(findBar);
 
     await new Promise(r => requestAnimationFrame(r));
     delete aTab._pendingFindBar;
     if (window.closed || aTab.closing) {
       return null;
diff --git a/toolkit/content/widgets/findbar.js b/toolkit/content/widgets/findbar.js
--- a/toolkit/content/widgets/findbar.js
+++ b/toolkit/content/widgets/findbar.js
@@ -45,18 +45,16 @@ class MozFindbar extends XULElement {
       </hbox>
       <toolbarbutton anonid="find-closebutton" class="findbar-closebutton close-icon" data-l10n-id="findbar-find-button-close" oncommand="close();" />
     `);
   }
 
   connectedCallback() {
     this.appendChild(document.importNode(this.content, true));
 
-    this.hidden = true;
-
     /**
      * Please keep in sync with toolkit/modules/FindBarChild.jsm
      */
     this.FIND_NORMAL = 0;
 
     this.FIND_TYPEAHEAD = 1;
 
     this.FIND_LINKS = 2;
