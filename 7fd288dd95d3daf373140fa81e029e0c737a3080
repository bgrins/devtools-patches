
# HG changeset patch
# User Brendan Dahl <bdahl@mozilla.com>
# Date 1543448113 28800
# Node ID 7fd288dd95d3daf373140fa81e029e0c737a3080
# Parent  54d66e9fd30d5871d87a58c6bb78518bf48ffdcf
Delay frame loader initialization.


diff --git a/dom/html/nsHTMLDocument.cpp b/dom/html/nsHTMLDocument.cpp
--- a/dom/html/nsHTMLDocument.cpp
+++ b/dom/html/nsHTMLDocument.cpp
@@ -607,16 +607,17 @@ nsHTMLDocument::StartDocumentLoad(const 
     } else {
       mParser->MarkAsNotScriptCreated(aCommand);
     }
   } else {
     nsCOMPtr<nsIURI> url;
     aChannel->GetOriginalURI(getter_AddRefs(url));
     if (nsXULPrototypeCache::GetInstance()->IsCached(url)) {
       printf(">>> Creating cached parser url=%s\n", url->GetSpecOrDefault().get());
+      mDelayFrameLoaderInitialization = true;
       mParser = new mozilla::parser::CacheParser(url);
     } else {
       mParser = do_CreateInstance(kCParserCID, &rv);
       NS_ENSURE_SUCCESS(rv, rv);
     }
   }
 
   // Look for the parent document.  Note that at this point we don't have our
@@ -842,16 +843,20 @@ nsHTMLDocument::BeginLoad()
     EditingStateChanged();
   }
   nsDocument::BeginLoad();
 }
 
 void
 nsHTMLDocument::EndLoad()
 {
+  if (mDelayFrameLoaderInitialization) {
+    mDelayFrameLoaderInitialization = false;
+    MaybeInitializeFinalizeFrameLoaders();
+  }
   bool turnOnEditing =
     mParser && (HasFlag(NODE_IS_EDITABLE) || mContentEditableCount > 0);
   // Note: nsDocument::EndLoad nulls out mParser.
   nsDocument::EndLoad();
   if (turnOnEditing) {
     EditingStateChanged();
   }
 }

