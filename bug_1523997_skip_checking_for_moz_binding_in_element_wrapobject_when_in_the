# HG changeset patch
# User Brian Grinstead <bgrinstead@mozilla.com>
# Date 1548879327 28800
#      Wed Jan 30 12:15:27 2019 -0800
# Node ID a941c92c4491e22b6a2c4a31f0d1098ae51905b7
# Parent  4440fbf71c72e13cfcb6257bbae6024052ffd46d
Bug 1523997 - Skip checking for -moz-binding in Element::WrapObject when in the content process

Differential Revision: https://phabricator.services.mozilla.com/D18124

diff --git a/dom/base/Element.cpp b/dom/base/Element.cpp
--- a/dom/base/Element.cpp
+++ b/dom/base/Element.cpp
@@ -539,16 +539,21 @@ bool Element::GetBindingURL(Document* aD
 
 JSObject* Element::WrapObject(JSContext* aCx,
                               JS::Handle<JSObject*> aGivenProto) {
   JS::Rooted<JSObject*> obj(aCx, nsINode::WrapObject(aCx, aGivenProto));
   if (!obj) {
     return nullptr;
   }
 
+  if (XRE_IsContentProcess() && !NodePrincipal()->IsSystemPrincipal()) {
+    // We don't use XBL in content privileged content processes.
+    return obj;
+  }
+
   Document* doc = GetComposedDoc();
   if (!doc) {
     // There's no baseclass that cares about this call so we just
     // return here.
     return obj;
   }
 
   // We must ensure that the XBL Binding is installed before we hand
