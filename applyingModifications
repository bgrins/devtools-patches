# HG changeset patch
# User Brian Grinstead <bgrinstead@mozilla.com>
# Parent  e3a0544d600f76781241a94743711e12ab43331e
Bug 1123948 - Wait for _applyingModifications to finish before checking computed style in livepreview test;r=pbrosset

diff --git a/browser/devtools/styleinspector/test/browser_ruleview_livepreview.js b/browser/devtools/styleinspector/test/browser_ruleview_livepreview.js
--- a/browser/devtools/styleinspector/test/browser_ruleview_livepreview.js
+++ b/browser/devtools/styleinspector/test/browser_ruleview_livepreview.js
@@ -32,17 +32,16 @@ add_task(function*() {
   let {toolbox, inspector, view} = yield openRuleView();
   yield selectNode("#testid", inspector);
 
   for (let data of TEST_DATA) {
     yield testLivePreviewData(data, view, "#testid");
   }
 });
 
-
 function* testLivePreviewData(data, ruleView, selector) {
   let testElement = getNode(selector);
   let idRuleEditor = getRuleViewRuleEditor(ruleView, 1);
   let propEditor = idRuleEditor.rule.textProps[0].editor;
 
   info("Focusing the property value inplace-editor");
   let editor = yield focusEditableField(propEditor.valueSpan);
   is(inplaceEditor(propEditor.valueSpan), editor, "The focused editor is the value");
@@ -52,18 +51,21 @@ function* testLivePreviewData(data, rule
     EventUtils.sendChar(ch, ruleView.doc.defaultView);
   }
   if (data.escape) {
     EventUtils.synthesizeKey("VK_ESCAPE", {});
   } else {
     EventUtils.synthesizeKey("VK_RETURN", {});
   }
 
-  // This wait is an orange waiting to happen, but it might take a few event
-  // loop spins in either the client or parent process before we see the
-  // updated value.
-  yield wait(1);
+  // Wait for the modifyproperties request to complete before
+  // checking the computed style.
+  for (let rule of ruleView._elementStyle.rules) {
+    if (rule._applyingModifications) {
+      yield rule._applyingModifications;
+    }
+  }
 
   // While the editor is still focused in, the display should have changed already
   is((yield getComputedStyleProperty(selector, null, "display")),
     data.expected,
     "Element should be previewed as " + data.expected);
 }
