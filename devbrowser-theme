# HG changeset patch
# Parent 611fa34ae0863337fae33b00ad4b83949b288fb9
# User Brian Grinstead <bgrinstead@mozilla.com>
Bug 1053434 - Add listeners for devedition prefs in browser.js and stub CSS files;r=Gijs

diff --git a/browser/app/profile/firefox.js b/browser/app/profile/firefox.js
--- a/browser/app/profile/firefox.js
+++ b/browser/app/profile/firefox.js
@@ -1287,16 +1287,18 @@ pref("services.sync.prefs.sync.security.
 pref("services.sync.prefs.sync.security.default_personal_cert", true);
 pref("services.sync.prefs.sync.security.tls.version.min", true);
 pref("services.sync.prefs.sync.security.tls.version.max", true);
 pref("services.sync.prefs.sync.signon.rememberSignons", true);
 pref("services.sync.prefs.sync.spellchecker.dictionary", true);
 pref("services.sync.prefs.sync.xpinstall.whitelist.required", true);
 #endif
 
+pref("devbrowser.theme.enabled", true);
+
 // Disable the error console
 pref("devtools.errorconsole.enabled", false);
 
 // Developer toolbar and GCLI preferences
 pref("devtools.toolbar.enabled", true);
 pref("devtools.toolbar.visible", false);
 pref("devtools.commands.dir", "");
 
diff --git a/browser/base/content/browser-devbrowser.js b/browser/base/content/browser-devbrowser.js
new file mode 100644
--- /dev/null
+++ b/browser/base/content/browser-devbrowser.js
@@ -0,0 +1,82 @@
+/*
+#ifdef 0
+ * This Source Code Form is subject to the terms of the Mozilla Public
+ * License, v. 2.0. If a copy of the MPL was not distributed with this
+ * file, You can obtain one at http://mozilla.org/MPL/2.0/.
+#endif
+ */
+
+/**
+ * Listeners for the DevBrowser theme.  This adds an extra stylesheet
+ * to browser.xul if a pref is set.  But it will only happen
+ * in a MOZ_DEVELOPER_EDITION build when no other themes are applied.
+ */
+let DevBrowser = {
+  _prefName: "devbrowser.theme.enabled",
+  _themePrefName: "general.skins.selectedSkin",
+  _lwThemePrefName: "lightweightThemes.isThemeSelected",
+  _devtoolsThemePrefName: "devtools.theme",
+
+  styleSheet: null,
+
+  init: function () {
+#ifdef MOZ_DEVELOPER_EDITION
+    this._readPref();
+    Services.prefs.addObserver(this._prefName, this, false);
+    Services.prefs.addObserver(this._lwThemePrefName, this, false);
+    Services.prefs.addObserver(this._themePrefName, this, false);
+    Services.prefs.addObserver(this._devtoolsThemePrefName, this, false);
+#endif MOZ_DEVELOPER_EDITION
+  },
+
+  observe: function (subject, topic, data) {
+    if (topic == "nsPref:changed")
+      this._readPref();
+  },
+
+  _readPref: function() {
+
+    // Only try to apply the devBrowser theme if:
+    //  1) It is preffed on.
+    //  2) There are no lightweight themes applied.
+    //  3) There are no complete themes applied.
+    let devbrowserThemeEnabled =
+        Services.prefs.getBoolPref(this._prefName, true) &&
+        !Services.prefs.getBoolPref(this._lwThemePrefName, true) &&
+        Services.prefs.getCharPref(this._themePrefName, true) == "classic/1.0";
+
+    let devtoolsIsDark =
+     Services.prefs.getCharPref(this._devtoolsThemePrefName, true) === "dark";
+
+    if (devbrowserThemeEnabled && !this.styleSheet) {
+      let styleSheet = this.styleSheet = document.createProcessingInstruction('xml-stylesheet',
+        'href="chrome://browser/skin/devbrowser.css" type="text/css"');
+      this.styleSheet.addEventListener("load", function onLoad() {
+        styleSheet.removeEventListener("load", onLoad);
+        ToolbarIconColor.inferFromText();
+      });
+      document.insertBefore(this.styleSheet, document.lastChild);
+    } else if (!devbrowserThemeEnabled && this.styleSheet) {
+      this.styleSheet.remove();
+      this.styleSheet = null;
+      document.documentElement.classList.remove("devtools-light");
+      document.documentElement.classList.remove("devtools-dark");
+      ToolbarIconColor.inferFromText();
+    }
+
+    // Set a class name based on the devtools toolbox theme applied,
+    // which allows specific styling based on this theme.
+    if (devbrowserThemeEnabled) {
+      document.documentElement.classList.toggle("devtools-light", !devtoolsIsDark);
+      document.documentElement.classList.toggle("devtools-dark", devtoolsIsDark);
+      ToolbarIconColor.inferFromText();
+    }
+  },
+
+  uninit: function () {
+    Services.prefs.removeObserver(this._prefName, this);
+    Services.prefs.removeObserver(this._lwThemePrefName, this);
+    Services.prefs.removeObserver(this._themePrefName, this);
+    this.styleSheet = null;
+  }
+};
diff --git a/browser/base/content/browser.js b/browser/base/content/browser.js
--- a/browser/base/content/browser.js
+++ b/browser/base/content/browser.js
@@ -194,16 +194,17 @@ let gInitialPages = [
   "about:home",
   "about:privatebrowsing",
   "about:welcomeback",
   "about:sessionrestore"
 ];
 
 #include browser-addons.js
 #include browser-customization.js
+#include browser-devbrowser.js
 #include browser-feeds.js
 #include browser-fullScreen.js
 #include browser-fullZoom.js
 #include browser-loop.js
 #include browser-places.js
 #include browser-plugins.js
 #include browser-safebrowsing.js
 #include browser-social.js
@@ -829,16 +830,17 @@ var gBrowserInit = {
     // These routines add message listeners. They must run before
     // loading the frame script to ensure that we don't miss any
     // message sent between when the frame script is loaded and when
     // the listener is registered.
     DOMLinkHandler.init();
     gPageStyleMenu.init();
     LanguageDetectionListener.init();
     BrowserOnClick.init();
+    DevBrowser.init();
 
     let mm = window.getGroupMessageManager("browsers");
     mm.loadFrameScript("chrome://browser/content/content.js", true);
 
     // initialize observers and listeners
     // and give C++ access to gBrowser
     XULBrowserWindow.init();
     window.QueryInterface(Ci.nsIInterfaceRequestor)
@@ -1386,16 +1388,18 @@ var gBrowserInit = {
     BookmarkingUI.uninit();
 
     TabsInTitlebar.uninit();
 
     ToolbarIconColor.uninit();
 
     BrowserOnClick.uninit();
 
+    DevBrowser.uninit();
+
     var enumerator = Services.wm.getEnumerator(null);
     enumerator.getNext();
     if (!enumerator.hasMoreElements()) {
       document.persist("sidebar-box", "sidebarcommand");
       document.persist("sidebar-box", "width");
       document.persist("sidebar-box", "src");
       document.persist("sidebar-title", "value");
     }
diff --git a/browser/themes/linux/devbrowser.css b/browser/themes/linux/devbrowser.css
new file mode 100644
--- /dev/null
+++ b/browser/themes/linux/devbrowser.css
@@ -0,0 +1,5 @@
+/* This Source Code Form is subject to the terms of the Mozilla Public
+ * License, v. 2.0. If a copy of the MPL was not distributed with this
+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */
+
+%include ../shared/devbrowser.inc.css
diff --git a/browser/themes/linux/jar.mn b/browser/themes/linux/jar.mn
--- a/browser/themes/linux/jar.mn
+++ b/browser/themes/linux/jar.mn
@@ -17,16 +17,17 @@ browser.jar:
   skin/classic/browser/aboutNetError_info.svg                   (../shared/aboutNetError_info.svg)
   skin/classic/browser/aboutSocialError.css
 #ifdef MOZ_SERVICES_SYNC
   skin/classic/browser/aboutSyncTabs.css
 #endif
   skin/classic/browser/aboutTabCrashed.css
   skin/classic/browser/actionicon-tab.png
 * skin/classic/browser/browser.css
+* skin/classic/browser/devbrowser.css
 * skin/classic/browser/browser-lightweightTheme.css
   skin/classic/browser/click-to-play-warning-stripes.png
 * skin/classic/browser/content-contextmenu.svg
 * skin/classic/browser/engineManager.css
   skin/classic/browser/fullscreen-darknoise.png
   skin/classic/browser/Geolocation-16.png
   skin/classic/browser/Geolocation-64.png
   skin/classic/browser/identity.png
diff --git a/browser/themes/osx/devbrowser.css b/browser/themes/osx/devbrowser.css
new file mode 100644
--- /dev/null
+++ b/browser/themes/osx/devbrowser.css
@@ -0,0 +1,5 @@
+/* This Source Code Form is subject to the terms of the Mozilla Public
+ * License, v. 2.0. If a copy of the MPL was not distributed with this
+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */
+
+%include ../shared/devbrowser.inc.css
diff --git a/browser/themes/osx/jar.mn b/browser/themes/osx/jar.mn
--- a/browser/themes/osx/jar.mn
+++ b/browser/themes/osx/jar.mn
@@ -17,16 +17,17 @@ browser.jar:
   skin/classic/browser/aboutSocialError.css
 #ifdef MOZ_SERVICES_SYNC
   skin/classic/browser/aboutSyncTabs.css
 #endif
   skin/classic/browser/aboutTabCrashed.css
   skin/classic/browser/actionicon-tab.png
   skin/classic/browser/actionicon-tab@2x.png
 * skin/classic/browser/browser.css                          (browser.css)
+* skin/classic/browser/devbrowser.css                       (devbrowser.css)
 * skin/classic/browser/browser-lightweightTheme.css
   skin/classic/browser/click-to-play-warning-stripes.png
 * skin/classic/browser/content-contextmenu.svg
 * skin/classic/browser/engineManager.css                    (engineManager.css)
   skin/classic/browser/fullscreen-darknoise.png
   skin/classic/browser/Geolocation-16.png
   skin/classic/browser/Geolocation-16@2x.png
   skin/classic/browser/Geolocation-64.png
diff --git a/browser/themes/shared/devbrowser.inc.css b/browser/themes/shared/devbrowser.inc.css
new file mode 100644
--- /dev/null
+++ b/browser/themes/shared/devbrowser.inc.css
@@ -0,0 +1,3 @@
+/* This Source Code Form is subject to the terms of the Mozilla Public
+ * License, v. 2.0. If a copy of the MPL was not distributed with this
+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */
diff --git a/browser/themes/windows/devbrowser-aero.css b/browser/themes/windows/devbrowser-aero.css
new file mode 100644
--- /dev/null
+++ b/browser/themes/windows/devbrowser-aero.css
@@ -0,0 +1,5 @@
+/* This Source Code Form is subject to the terms of the Mozilla Public
+ * License, v. 2.0. If a copy of the MPL was not distributed with this
+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */
+
+%include ../shared/devbrowser.inc.css
diff --git a/browser/themes/windows/devbrowser.css b/browser/themes/windows/devbrowser.css
new file mode 100644
--- /dev/null
+++ b/browser/themes/windows/devbrowser.css
@@ -0,0 +1,5 @@
+/* This Source Code Form is subject to the terms of the Mozilla Public
+ * License, v. 2.0. If a copy of the MPL was not distributed with this
+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */
+
+%include ../shared/devbrowser.inc.css
diff --git a/browser/themes/windows/jar.mn b/browser/themes/windows/jar.mn
--- a/browser/themes/windows/jar.mn
+++ b/browser/themes/windows/jar.mn
@@ -19,16 +19,17 @@ browser.jar:
         skin/classic/browser/aboutNetError_info.svg                  (../shared/aboutNetError_info.svg)
         skin/classic/browser/aboutSocialError.css
 #ifdef MOZ_SERVICES_SYNC
         skin/classic/browser/aboutSyncTabs.css
 #endif
         skin/classic/browser/aboutTabCrashed.css
         skin/classic/browser/actionicon-tab.png
 *       skin/classic/browser/browser.css
+*       skin/classic/browser/devbrowser.css
 *       skin/classic/browser/browser-lightweightTheme.css
         skin/classic/browser/click-to-play-warning-stripes.png
 *       skin/classic/browser/content-contextmenu.svg
 *       skin/classic/browser/engineManager.css
         skin/classic/browser/fullscreen-darknoise.png
         skin/classic/browser/Geolocation-16.png
         skin/classic/browser/Geolocation-64.png
         skin/classic/browser/Info.png
@@ -441,16 +442,17 @@ browser.jar:
         skin/classic/aero/browser/aboutSocialError.css
 #ifdef MOZ_SERVICES_SYNC
         skin/classic/aero/browser/aboutSyncTabs.css
 #endif
         skin/classic/aero/browser/aboutTabCrashed.css
         skin/classic/aero/browser/aboutWelcomeBack.css               (../shared/aboutWelcomeBack.css)
         skin/classic/aero/browser/actionicon-tab.png
 *       skin/classic/aero/browser/browser.css                        (browser-aero.css)
+*       skin/classic/aero/browser/devbrowser.css                     (devbrowser-aero.css)
 *       skin/classic/aero/browser/browser-lightweightTheme.css
         skin/classic/aero/browser/click-to-play-warning-stripes.png
 *       skin/classic/aero/browser/content-contextmenu.svg
 *       skin/classic/aero/browser/engineManager.css
         skin/classic/aero/browser/fullscreen-darknoise.png
         skin/classic/aero/browser/Geolocation-16.png
         skin/classic/aero/browser/Geolocation-64.png
         skin/classic/aero/browser/Info.png                           (Info-aero.png)
