# HG changeset patch
# User Brian Grinstead <bgrinstead@mozilla.com>
# Parent  50502a58fdbefdb709c71c0fe762b3149338d24d
Bug XXX: Dont use dom node from new-message in damp

diff --git a/testing/talos/talos/tests/devtools/addon/content/damp.js b/testing/talos/talos/tests/devtools/addon/content/damp.js
--- a/testing/talos/talos/tests/devtools/addon/content/damp.js
+++ b/testing/talos/talos/tests/devtools/addon/content/damp.js
@@ -112,30 +112,30 @@ Damp.prototype = {
       name: label + ".readHeapSnapshot",
       value: end - start
     });
     return Promise.resolve();
   },
 
   _consoleBulkLoggingTest: Task.async(function*() {
     let TOTAL_MESSAGES = 10;
+    let numMessages = 0;
     let tab = yield this.testSetup(SIMPLE_URL);
     let messageManager = tab.linkedBrowser.messageManager;
     let {toolbox} = yield this.openToolbox("webconsole");
     let webconsole = toolbox.getPanel("webconsole");
 
     // Resolve once the last message has been received.
     let allMessagesReceived = new Promise(resolve => {
       function receiveMessages(e, messages) {
-        for (let m of messages) {
-          if (m.node.textContent.includes("damp " + TOTAL_MESSAGES)) {
-            webconsole.hud.ui.off("new-messages", receiveMessages);
-            // Wait for the console to redraw
-            requestAnimationFrame(resolve);
-          }
+        numMessages += messages.size;
+        if (numMessages >= TOTAL_MESSAGES) {
+          webconsole.hud.ui.off("new-messages", receiveMessages);
+          // Wait for the console to redraw
+          requestAnimationFrame(resolve);
         }
       }
       webconsole.hud.ui.on("new-messages", receiveMessages);
     });
 
     // Load a frame script using a data URI so we can do logs
     // from the page.  So this is running in content.
     messageManager.loadFrameScript("data:,(" + encodeURIComponent(
