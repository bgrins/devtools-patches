# HG changeset patch
# User Brian Grinstead <bgrinstead@mozilla.com>
# Parent  dd8c914eb1f22ff9cccf1c1a1e46b7ad40ae00d4
Bug

diff --git a/browser/devtools/shared/inplace-editor.js b/browser/devtools/shared/inplace-editor.js
--- a/browser/devtools/shared/inplace-editor.js
+++ b/browser/devtools/shared/inplace-editor.js
@@ -249,16 +249,22 @@ function InplaceEditor(aOptions, aEvent)
   EventEmitter.decorate(this);
 }
 
 exports.InplaceEditor = InplaceEditor;
 
 InplaceEditor.CONTENT_TYPES = CONTENT_TYPES;
 
 InplaceEditor.prototype = {
+
+  get currentInputValue() {
+    let val = this.multiline ? this.input.value : this.input.value.trim();
+    return val;
+  },
+
   _createInput: function InplaceEditor_createEditor()
   {
     this.input =
       this.doc.createElementNS(HTML_NS, this.multiline ? "textarea" : "input");
     this.input.inplaceEditor = this;
     this.input.classList.add("styleinspector-propertyeditor");
     this.input.value = this.initial;
 
@@ -393,17 +399,17 @@ InplaceEditor.prototype = {
     }
 
     this.input.value = newValue.value;
     this.input.setSelectionRange(newValue.start, newValue.end);
     this._doValidation();
 
     // Call the user's change handler if available.
     if (this.change) {
-      this.change(this.input.value.trim());
+      this.change(this.currentInputValue);
     }
 
     return true;
   },
 
   /**
    * Increment the property value based on the property type.
    *
@@ -785,18 +791,18 @@ InplaceEditor.prototype = {
   {
     if (this._applied) {
       return;
     }
 
     this._applied = true;
 
     if (this.done) {
-      let val = this.input.value.trim();
-      return this.done(this.cancelled ? this.initial : val, !this.cancelled, direction);
+      let val = this.cancelled ? this.initial : this.currentInputValue;
+      return this.done(val, !this.cancelled, direction);
     }
 
     return null;
   },
 
   /**
    * Handle loss of focus by calling done if it hasn't been called yet.
    */
@@ -1029,17 +1035,17 @@ InplaceEditor.prototype = {
 
     // Update size if we're autosizing.
     if (this._measurement) {
       this._updateSize();
     }
 
     // Call the user's change handler if available.
     if (this.change) {
-      this.change(this.input.value.trim());
+      this.change(this.currentInputValue);
     }
   },
 
   /**
    * Fire validation callback with current input
    */
   _doValidation: function()
   {
diff --git a/browser/devtools/shared/test/browser.ini b/browser/devtools/shared/test/browser.ini
--- a/browser/devtools/shared/test/browser.ini
+++ b/browser/devtools/shared/test/browser.ini
@@ -65,17 +65,18 @@ support-files =
 [browser_graphs-09f.js]
 [browser_graphs-10a.js]
 [browser_graphs-10b.js]
 [browser_graphs-11a.js]
 [browser_graphs-11b.js]
 [browser_graphs-12.js]
 [browser_graphs-13.js]
 [browser_graphs-14.js]
-[browser_inplace-editor.js]
+[browser_inplace-editor-01.js]
+[browser_inplace-editor-02.js]
 [browser_layoutHelpers.js]
 skip-if = e10s # Layouthelpers test should not run in a content page.
 [browser_layoutHelpers-getBoxQuads.js]
 skip-if = e10s # Layouthelpers test should not run in a content page.
 [browser_mdn-docs-01.js]
 [browser_mdn-docs-02.js]
 [browser_num-l10n.js]
 [browser_observableobject.js]
diff --git a/browser/devtools/shared/test/browser_inplace-editor.js b/browser/devtools/shared/test/browser_inplace-editor-01.js
rename from browser/devtools/shared/test/browser_inplace-editor.js
rename to browser/devtools/shared/test/browser_inplace-editor-01.js
diff --git a/browser/devtools/shared/test/browser_inplace-editor-02.js b/browser/devtools/shared/test/browser_inplace-editor-02.js
new file mode 100644
--- /dev/null
+++ b/browser/devtools/shared/test/browser_inplace-editor-02.js
@@ -0,0 +1,178 @@
+/* vim: set ts=2 et sw=2 tw=80: */
+/* Any copyright is dedicated to the Public Domain.
+   http://creativecommons.org/publicdomain/zero/1.0/ */
+
+"use strict";
+
+let {Promise: promise} = Cu.import("resource://gre/modules/Promise.jsm", {});
+let {editableField, getInplaceEditorForSpan: inplaceEditor} = devtools.require("devtools/shared/inplace-editor");
+
+// Test that the multiline inplace editor and single line inplace editors
+// work correctly.s
+
+add_task(function*() {
+  yield promiseTab("data:text/html;charset=utf-8,inline editor tests");
+  let [host, win, doc] = yield createHost();
+
+  yield testMultiline(doc);
+  yield testSingleLine(doc);
+
+  host.destroy();
+  gBrowser.removeCurrentTab();
+});
+
+function* openEditorWithOptions(doc, text, options) {
+  doc.body.innerHTML = "";
+  let span = options.element = createSpan(doc);
+  span.textContent = text;
+
+  info("Creating multiple inplace-editor fields");
+  editableField(options);
+
+  info("Clicking on the inplace-editor field to turn to edit mode");
+  span.click();
+}
+
+let testMultiLineInitialization = Task.async(function*(doc) {
+  let done = promise.defer();
+
+  let text = "\nMultiple\nLines\n";
+  let options = {
+    multiline: true,
+    start: function(editor) {
+      is (editor.input.value, text, "Correct text in editor");
+      is (doc.querySelectorAll("pre.autosizer").length, 1, "There is an autosizer");
+      EventUtils.sendKey("return");
+    },
+    done: function(val) {
+      is (val, text, "The done value preserved trailing whitespace");
+      is (span.textContent, text, "The span's final text content preserved trailing whitespace");
+      done.resolve();
+    }
+  };
+
+  openEditorWithOptions(doc, text, options);
+
+  yield done.promise;
+});
+
+let testSingleLineInitialization = Task.async(function*(doc) {
+  let done = promise.defer();
+
+  let text = "\nSingle line\n";
+  let options = {
+    start: function(editor) {
+      is (editor.input.value, text, "Correct text in editor");
+      is (doc.querySelectorAll("span.autosizer").length, 1, "There is an autosizer");
+      EventUtils.sendKey("return");
+    },
+    done: function(val) {
+      is (val, text.trim(), "The done value preserved trailing whitespace");
+      is (span.textContent, text.trim(), "The span's final text content preserved trailing whitespace");
+      done.resolve();
+    }
+  };
+
+  openEditorWithOptions(doc, text, options);
+
+  yield done.promise;
+});
+
+function* testMultilineInitialization1(doc) {
+  let done = promise.defer();
+  doc.body.innerHTML = "";
+
+  let text = "\nMultiple\nLines\n";
+  let span = createSpan(doc);
+  span.textContent = text;
+
+  let options = {
+    element: span,
+    multiline: true,
+    start: function(editor) {
+      is (editor.input.value, text, "Correct text in editor");
+      is (doc.querySelectorAll("pre.autosizer").length, 1, "There is an autosizer");
+      EventUtils.sendKey("return");
+    },
+    done: function(val) {
+      is (val, text, "The done value preserved trailing whitespace");
+      is (span.textContent, text, "The span's final text content preserved trailing whitespace");
+      done.resolve();
+    }
+  };
+
+  info("Creating multiple inplace-editor fields");
+  editableField(options);
+
+  info("Clicking on the inplace-editor field to turn to edit mode");
+  span.click();
+
+  yield done.promise;
+}
+
+function testMultiline(doc) {
+  info("Testing the multiline=true option");
+  let def = promise.defer();
+
+  let initial = "\nMultiple\nLines\n";
+  let changed = "\nMultiple\nLines\n ";
+  createInplaceEditorAndClick({
+    multiline: true,
+    initial: initial,
+    start: function(editor) {
+      is(editor.input.value, initial, "Explicit initial value should be used.");
+      editor.input.value = changed;
+      EventUtils.sendKey("return");
+    },
+    done: onDone(changed, true, def)
+  }, doc);
+
+  return def.promise;
+}
+function testSingleLine(doc) {
+  info("Testing the multiline=false option (default value)");
+  let def = promise.defer();
+
+  let initial = "Single line";
+  let changed = " Single line ";
+  createInplaceEditorAndClick({
+    initial: initial,
+    start: function(editor) {
+      is(editor.input.value, initial, "Explicit initial value should be used.");
+      editor.input.value = changed;
+      EventUtils.sendKey("return");
+    },
+    done: onDone(changed.trim(), true, def)
+  }, doc);
+
+  return def.promise;
+}
+
+function onDone(value, isCommit, def) {
+  return function(actualValue, actualCommit) {
+    info("Inplace-editor's done callback executed, checking its state");
+    is(actualValue, value, "The value is correct");
+    is(actualCommit, isCommit, "The commit boolean is correct");
+    def.resolve();
+  }
+}
+
+function createInplaceEditorAndClick(options, doc) {
+  doc.body.innerHTML = "";
+  let span = options.element = createSpan(doc);
+
+  info("Creating an inplace-editor field");
+  editableField(options);
+
+  info("Clicking on the inplace-editor field to turn to edit mode");
+  span.click();
+}
+
+function createSpan(doc) {
+  info("Creating a new span element");
+  let span = doc.createElement("span");
+  span.setAttribute("tabindex", "0");
+  span.textContent = "Edit Me!";
+  doc.body.appendChild(span);
+  return span;
+}
