# HG changeset patch
# User Brian Grinstead <bgrinstead@mozilla.com>
# Parent  70b8d85a0fcc961da0852912a54b3b8c65ec2337
Bug 1164954 - Make sure the Dev Edition theme is installed on startup for new profiles in a Dev Edition build;r=dao

diff --git a/browser/app/profile/firefox.js b/browser/app/profile/firefox.js
--- a/browser/app/profile/firefox.js
+++ b/browser/app/profile/firefox.js
@@ -1338,16 +1338,18 @@ pref("services.sync.prefs.sync.xpinstall
 // Developer edition preferences
 #ifdef MOZ_DEV_EDITION
 sticky_pref("lightweightThemes.selectedThemeID", "firefox-devedition@mozilla.org");
 sticky_pref("browser.devedition.theme.enabled", true);
 #else
 sticky_pref("lightweightThemes.selectedThemeID", "");
 #endif
 
+pref("browser.devedition.theme.installed", false);
+
 // Developer edition promo preferences
 pref("devtools.devedition.promo.shown", false);
 pref("devtools.devedition.promo.url", "https://www.mozilla.org/firefox/developer/?utm_source=firefox-dev-tools&utm_medium=firefox-browser&utm_content=betadoorhanger");
 
 // Only potentially show in beta release
 #if MOZ_UPDATE_CHANNEL == beta
   pref("devtools.devedition.promo.enabled", true);
 #else
diff --git a/browser/components/nsBrowserGlue.js b/browser/components/nsBrowserGlue.js
--- a/browser/components/nsBrowserGlue.js
+++ b/browser/components/nsBrowserGlue.js
@@ -738,16 +738,33 @@ BrowserGlue.prototype = {
 
     LightweightThemeManager.addBuiltInTheme({
       id: "firefox-devedition@mozilla.org",
       name: themeName,
       headerURL: "resource:///chrome/browser/content/browser/defaultthemes/devedition.header.png",
       iconURL: "resource:///chrome/browser/content/browser/defaultthemes/devedition.icon.png",
       author: vendorShortName,
     });
+
+    let theme = LightweightThemeManager.currentTheme;
+    let hasBeenInstalled = false;
+    if (theme && theme.id == "firefox-devedition@mozilla.org") {
+      try {
+        hasBeenInstalled = Services.prefs.getBoolPref("browser.devedition.theme.installed");
+      } catch (e) { }
+
+      // Force the LightweightThemeManager to realize that this theme has been
+      // installed.  Since it could have been activated due to a default pref
+      // value and not via a user action, there's a chance the default theme
+      // still thinks that it's active.
+      if (!hasBeenInstalled) {
+        LightweightThemeManager.currentTheme = theme;
+        Services.prefs.setBoolPref("browser.devedition.theme.installed", true);
+      }
+    }
 #endif
 
 #ifdef MOZ_CRASHREPORTER
     TabCrashReporter.init();
     PluginCrashReporter.init();
 #endif
 
     Services.obs.notifyObservers(null, "browser-ui-startup-complete", "");
