# HG changeset patch
# User Brian Grinstead <bgrinstead@mozilla.com>
# Parent  d46b88805cf00b13d2dc5a507b2c03374f26e398
Bug 1223150 - Set dir attribute on body element for all HTML pages in theme-switching;r=jryans

diff --git a/devtools/client/shared/test/browser.ini b/devtools/client/shared/test/browser.ini
--- a/devtools/client/shared/test/browser.ini
+++ b/devtools/client/shared/test/browser.ini
@@ -4,16 +4,17 @@ subsuite = devtools
 support-files =
   browser_layoutHelpers.html
   browser_layoutHelpers-getBoxQuads.html
   browser_templater_basic.html
   browser_toolbar_basic.html
   browser_toolbar_webconsole_errors_count.html
   browser_devices.json
   doc_options-view.xul
+  doc_html-dir.xhtml
   head.js
   html-mdn-css-basic-testing.html
   html-mdn-css-no-summary.html
   html-mdn-css-no-summary-or-syntax.html
   html-mdn-css-no-syntax.html
   html-mdn-css-syntax-old-style.html
   leakhunt.js
   test-actor.js
diff --git a/devtools/client/shared/test/browser_theme_switching.js b/devtools/client/shared/test/browser_theme_switching.js
--- a/devtools/client/shared/test/browser_theme_switching.js
+++ b/devtools/client/shared/test/browser_theme_switching.js
@@ -1,27 +1,43 @@
 /* vim: set ts=2 et sw=2 tw=80: */
 /* Any copyright is dedicated to the Public Domain.
    http://creativecommons.org/publicdomain/zero/1.0/ */
 
 var toolbox;
+const XHTML_PAGE_URI = CHROME_URL_ROOT + "doc_html-dir.xhtml";
+
 
 add_task(function*() {
   let target = TargetFactory.forTab(gBrowser.selectedTab);
   let toolbox = yield gDevTools.showToolbox(target);
   let root = toolbox.frame.contentDocument.documentElement;
 
   let platform = root.getAttribute("platform");
   let expectedPlatform = getPlatform();
   is(platform, expectedPlatform, ":root[platform] is correct");
 
   let theme = Services.prefs.getCharPref("devtools.theme");
   let className = "theme-" + theme;
   ok(root.classList.contains(className), ":root has " + className + " class (current theme)");
 
+  yield new Promise(resolve => {
+    let frame = root.ownerDocument.createElement("iframe");
+    frame.addEventListener("load", function() {
+      let dirAttr = frame.contentDocument.documentElement.getAttribute("dir");
+      ok(dirAttr, "'dir' attribute exists (" + dirAttr + ")");
+      is(dirAttr, frame.contentDocument.body.getAttribute("dir"),
+         "Correct dir attribute set");
+      frame.remove();
+      resolve();
+    }, true);
+    frame.setAttribute("src", XHTML_PAGE_URI);
+    root.appendChild(frame);
+  })
+
   yield toolbox.destroy();
 });
 
 function getPlatform() {
   let {OS} = Services.appinfo;
   if (OS == "WINNT") {
     return "win";
   } else if (OS == "Darwin") {
diff --git a/devtools/client/shared/test/doc_html-dir.xhtml b/devtools/client/shared/test/doc_html-dir.xhtml
new file mode 100644
--- /dev/null
+++ b/devtools/client/shared/test/doc_html-dir.xhtml
@@ -0,0 +1,18 @@
+<?xml version="1.0" encoding="UTF-8"?>
+
+<!DOCTYPE html [
+  <!ENTITY % globalDTD
+    SYSTEM "chrome://global/locale/global.dtd">
+  %globalDTD;
+]>
+
+<html xmlns="http://www.w3.org/1999/xhtml">
+  <head>
+    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
+    <title></title>
+    <script type="application/javascript;version=1.8" src="chrome://devtools/content/shared/theme-switching.js"/>
+  </head>
+
+  <body dir="&locale.dir;">
+  </body>
+</html>
diff --git a/devtools/client/shared/test/head.js b/devtools/client/shared/test/head.js
--- a/devtools/client/shared/test/head.js
+++ b/devtools/client/shared/test/head.js
@@ -14,16 +14,19 @@ const DevToolsUtils = require("devtools/
 DevToolsUtils.testing = true;
 SimpleTest.registerCleanupFunction(() => {
   DevToolsUtils.testing = false;
 });
 
 const TEST_URI_ROOT = "http://example.com/browser/devtools/client/shared/test/";
 const OPTIONS_VIEW_URL = TEST_URI_ROOT + "doc_options-view.xul";
 
+const TEST_DIR = gTestPath.substr(0, gTestPath.lastIndexOf("/"));
+const CHROME_URL_ROOT = TEST_DIR + "/";
+
 /**
  * Open a new tab at a URL and call a callback on load
  */
 function addTab(aURL, aCallback)
 {
   waitForExplicitFinish();
 
   gBrowser.selectedTab = gBrowser.addTab();
diff --git a/devtools/client/shared/theme-switching.js b/devtools/client/shared/theme-switching.js
--- a/devtools/client/shared/theme-switching.js
+++ b/devtools/client/shared/theme-switching.js
@@ -113,16 +113,26 @@
     os = "win";
   } else if (platform.startsWith("Mac")) {
     os = "mac";
   } else {
     os = "linux";
   }
   documentElement.setAttribute("platform", os);
 
+  // Set dir attribute for :-moz-dir(rtl) support in HTML documents.
+  // XUL docs can use :-moz-locale-dir.
+  if (documentElement.nodeName === "html" &&
+      !documentElement.hasAttribute("dir")) {
+    let chromeReg = Cc["@mozilla.org/chrome/chrome-registry;1"]
+                    .getService(Ci.nsIXULChromeRegistry);
+    let dir = chromeReg.isLocaleRTL("global");
+    documentElement.setAttribute("dir", dir ? "rtl" : "ltr");
+  }
+
   if (documentElement.hasAttribute("force-theme")) {
     switchTheme(documentElement.getAttribute("force-theme"));
   } else {
     switchTheme(Services.prefs.getCharPref("devtools.theme"));
 
     gDevTools.on("pref-changed", handlePrefChange);
     window.addEventListener("unload", function() {
       gDevTools.off("pref-changed", handlePrefChange);
