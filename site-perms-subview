# HG changeset patch
# User Brian Grinstead <bgrinstead@mozilla.com>
# Parent  527c66668f401a60895bf448d6f515479e382295
Bug 1193158 - Create a basic site permissions subview;r=ttaubert

diff --git a/browser/base/content/browser.js b/browser/base/content/browser.js
--- a/browser/base/content/browser.js
+++ b/browser/base/content/browser.js
@@ -6788,16 +6788,20 @@ var gIdentityHandler = {
   get _permissionsContainer () {
     delete this._permissionsContainer;
     return this._permissionsContainer = document.getElementById("identity-popup-permissions");
   },
   get _permissionList () {
     delete this._permissionList;
     return this._permissionList = document.getElementById("identity-popup-permission-list");
   },
+  get _permissionSubviewList () {
+    delete this._permissionSubviewList;
+    return this._permissionSubviewList = document.getElementById("identity-popup-permission-subview-list");
+  },
 
   /**
    * Rebuild cache of the elements that may or may not exist depending
    * on whether there's a location bar.
    */
   _cacheElements : function() {
     delete this._identityBox;
     delete this._identityIcons;
@@ -6808,16 +6812,17 @@ var gIdentityHandler = {
     delete this._permissionList;
     this._identityBox = document.getElementById("identity-box");
     this._identityIcons = document.getElementById("identity-icons");
     this._identityIconLabel = document.getElementById("identity-icon-label");
     this._identityIconCountryLabel = document.getElementById("identity-icon-country-label");
     this._identityIcon = document.getElementById("page-proxy-favicon");
     this._permissionsContainer = document.getElementById("identity-popup-permissions");
     this._permissionList = document.getElementById("identity-popup-permission-list");
+    this._permissionSubviewList = document.getElementById("identity-popup-permission-subview-list");
   },
 
   /**
    * Handler for mouseclicks on the "More Information" button in the
    * "identity-popup" panel.
    */
   handleMoreInfoClick : function(event) {
     displaySecurityInfo();
@@ -7281,26 +7286,33 @@ var gIdentityHandler = {
     dt.setData("text/html", htmlString);
     dt.setDragImage(gProxyFavIcon, 16, 16);
   },
 
   updateSitePermissions: function () {
     while (this._permissionList.hasChildNodes())
       this._permissionList.removeChild(this._permissionList.lastChild);
 
+    while (this._permissionSubviewList.hasChildNodes())
+      this._permissionSubviewList.removeChild(this._permissionSubviewList.lastChild);
+
     let uri = gBrowser.currentURI;
 
     for (let permission of SitePermissions.listPermissions()) {
       let state = SitePermissions.get(uri, permission);
-
-      if (state == SitePermissions.UNKNOWN)
-        continue;
-
       let item = this._createPermissionItem(permission, state);
-      this._permissionList.appendChild(item);
+
+      // Add to the main view only if there is a known / non-default
+      // value for the permission for this site.
+      if (state != SitePermissions.UNKNOWN) {
+        this._permissionList.appendChild(item.cloneNode(true));
+      }
+
+      // Add all permissions to the subview.
+      this._permissionSubviewList.appendChild(item);
     }
 
     this._permissionsContainer.hidden = !this._permissionList.hasChildNodes();
   },
 
   setPermission: function (aPermission, aState) {
     if (aState == SitePermissions.getDefault(aPermission))
       SitePermissions.remove(gBrowser.currentURI, aPermission);
@@ -7309,30 +7321,39 @@ var gIdentityHandler = {
   },
 
   _createPermissionItem: function (aPermission, aState) {
     let menulist = document.createElement("menulist");
     let menupopup = document.createElement("menupopup");
     for (let state of SitePermissions.getAvailableStates(aPermission)) {
       let menuitem = document.createElement("menuitem");
       menuitem.setAttribute("value", state);
-      menuitem.setAttribute("label", SitePermissions.getStateLabel(aPermission, state));
+      let label = SitePermissions.getStateLabel(aPermission, state);
+      menuitem.setAttribute("label", label);
+      menuitem.setAttribute("tooltiptext", label);
       menupopup.appendChild(menuitem);
     }
     menulist.appendChild(menupopup);
-    menulist.setAttribute("value", aState);
+    let value = aState;
+    if (aState == SitePermissions.UNKNOWN) {
+      value = SitePermissions.getDefault(aPermission);
+    }
+    menulist.setAttribute("value", value);
     menulist.setAttribute("oncommand", "gIdentityHandler.setPermission('" +
                                        aPermission + "', this.value)");
     menulist.setAttribute("id", "identity-popup-permission:" + aPermission);
 
     let label = document.createElement("label");
+    let labelText = SitePermissions.getPermissionLabel(aPermission);
     label.setAttribute("flex", "1");
     label.setAttribute("class", "identity-popup-permission-label");
     label.setAttribute("control", menulist.getAttribute("id"));
-    label.setAttribute("value", SitePermissions.getPermissionLabel(aPermission));
+    label.setAttribute("crop", "end");
+    label.setAttribute("value", labelText);
+    label.setAttribute("tooltiptext", labelText);
 
     let container = document.createElement("hbox");
     container.setAttribute("align", "center");
     container.appendChild(label);
     container.appendChild(menulist);
     return container;
   }
 };
diff --git a/browser/base/content/test/general/browser.ini b/browser/base/content/test/general/browser.ini
--- a/browser/base/content/test/general/browser.ini
+++ b/browser/base/content/test/general/browser.ini
@@ -344,16 +344,19 @@ skip-if = buildapp == 'mulet' || e10s # 
 skip-if = buildapp == 'mulet' || e10s # Bug 1093603 - test breaks with PopupNotifications.panel.firstElementChild is null
 [browser_overflowScroll.js]
 [browser_pageInfo.js]
 skip-if = buildapp == 'mulet'
 [browser_page_style_menu.js]
 [browser_parsable_css.js]
 [browser_parsable_script.js]
 skip-if = asan || (os == 'linux' && !debug && (bits == 32)) # disabled on asan because of timeouts, and bug 1172468 for the linux 32-bit pgo issue.
+[browser_permissions.js]
+support-files =
+  permissions.html
 [browser_pinnedTabs.js]
 [browser_plainTextLinks.js]
 [browser_popupUI.js]
 skip-if = buildapp == 'mulet'
 [browser_popup_blocker.js]
 skip-if = (os == 'linux') || (e10s && debug) # Frequent bug 1081925 and bug 1125520 failures
 [browser_printpreview.js]
 skip-if = buildapp == 'mulet' || e10s # Bug 1101973 - breaks the next test in e10s, and may be responsible for later timeout after logging "Error: Channel closing: too late to send/recv, messages will be lost"
diff --git a/browser/base/content/test/general/browser_permissions.js b/browser/base/content/test/general/browser_permissions.js
new file mode 100644
--- /dev/null
+++ b/browser/base/content/test/general/browser_permissions.js
@@ -0,0 +1,66 @@
+/*
+ * Test the Permissions section in the Control Center.
+ */
+
+const {classes: Cc, interfaces: Ci, utils: Cu, results: Cr} = Components;
+const PERMISSIONS_PAGE = "http://example.com/browser/browser/base/content/test/general/permissions.html";
+let {SitePermissions} = Cu.import("resource:///modules/SitePermissions.jsm", {});
+
+registerCleanupFunction(function() {
+  SitePermissions.remove(gBrowser.currentURI, "install");
+  while (gBrowser.tabs.length > 1) {
+    gBrowser.removeCurrentTab();
+  }
+});
+
+add_task(function* testMainViewVisible() {
+  let {gIdentityHandler} = gBrowser.ownerGlobal;
+  let tab = gBrowser.selectedTab = gBrowser.addTab();
+  yield promiseTabLoadEvent(tab, PERMISSIONS_PAGE);
+
+  gIdentityHandler._identityBox.click();
+  ok(is_hidden(gIdentityHandler._permissionsContainer), "The container is hidden");
+  gIdentityHandler._identityPopup.hidden = true;
+
+  gIdentityHandler.setPermission("install", 1);
+
+  gIdentityHandler._identityBox.click();
+  ok(!is_hidden(gIdentityHandler._permissionsContainer), "The container is visible");
+  let menulists = gIdentityHandler._permissionsContainer.querySelectorAll("menulist");
+  is(menulists.length, 1, "One permission visible in main view");
+  is(menulists[0].id, "identity-popup-permission:install", "Install permission visible");
+  is(menulists[0].value, "1", "Correct value on install menulist");
+  gIdentityHandler._identityPopup.hidden = true;
+
+  gIdentityHandler.setPermission("install", SitePermissions.getDefault("install"));
+
+  gIdentityHandler._identityBox.click();
+  ok(is_hidden(gIdentityHandler._permissionsContainer), "The container is hidden");
+  gIdentityHandler._identityPopup.hidden = true;
+});
+
+add_task(function* testSubviewListing() {
+  let {gIdentityHandler} = gBrowser.ownerGlobal;
+  gIdentityHandler.setPermission("install", 1);
+
+  info("Opening control center and expanding permissions subview");
+  gIdentityHandler._identityBox.click();
+
+  let menulists = gIdentityHandler._permissionSubviewList.querySelectorAll("menulist");
+  let perms = SitePermissions.listPermissions();
+
+  is(menulists.length, perms.length, "One menulist for each permission");
+
+  for (let i = 0; i < menulists.length; i++) {
+    let menulist = menulists[i];
+    let perm = perms[i];
+    let expectedValue = SitePermissions.get(gBrowser.currentURI, perm);
+    if (expectedValue == SitePermissions.UNKNOWN) {
+      expectedValue = SitePermissions.getDefault(perm);
+    }
+
+    is(menulist.id, "identity-popup-permission:" + perm, "Correct id for menulist: " + perm);
+    is(menulist.value, expectedValue, "Correct value on menulist: " + perm);
+  }
+  gIdentityHandler._identityPopup.hidden = true;
+});
diff --git a/browser/base/content/test/general/permissions.html b/browser/base/content/test/general/permissions.html
new file mode 100644
--- /dev/null
+++ b/browser/base/content/test/general/permissions.html
@@ -0,0 +1,13 @@
+<!DOCTYPE HTML>
+<!-- This Source Code Form is subject to the terms of the Mozilla Public
+   - License, v. 2.0. If a copy of the MPL was not distributed with this
+   - file, You can obtain one at http://mozilla.org/MPL/2.0/. -->
+<html dir="ltr" xml:lang="en-US" lang="en-US">
+  <head>
+    <meta charset="utf8">
+  </head>
+  <body>
+	<!-- This page could eventually request permissions from content
+	     and make sure that chrome responds appropriately -->
+  </body>
+</html>
diff --git a/browser/components/controlcenter/content/panel.inc.xul b/browser/components/controlcenter/content/panel.inc.xul
--- a/browser/components/controlcenter/content/panel.inc.xul
+++ b/browser/components/controlcenter/content/panel.inc.xul
@@ -82,16 +82,22 @@
 
       <!-- Permissions Section -->
       <hbox id="identity-popup-permissions" class="identity-popup-section">
         <vbox id="identity-popup-permissions-content" flex="1">
           <label class="identity-popup-headline"
                  value="&identity.permissions;"/>
           <vbox id="identity-popup-permission-list"/>
         </vbox>
+        <button id="identity-popup-permissions-expander"
+                class="identity-popup-expander"
+#ifndef NIGHTLY_BUILD
+                hidden="true"
+#endif
+                oncommand="gIdentityHandler.toggleSubView('permissions', this)"/>
       </hbox>
     </panelview>
 
     <!-- Security SubView -->
     <panelview id="identity-popup-securityView" flex="1">
       <vbox id="identity-popup-securityView-header">
         <label observes="identity-popup-content-host"/>
         <description class="identity-popup-connection-not-secure"
@@ -151,10 +157,23 @@
                 oncommand="gIdentityHandler.disableMixedContentProtection()"/>
         <button when-mixedcontent="active-loaded"
                 label="&identity.enableMixedContentBlocking.label;"
                 accesskey="&identity.enableMixedContentBlocking.accesskey;"
                 oncommand="gIdentityHandler.enableMixedContentProtection()"/>
       </vbox>
 
     </panelview>
+
+    <!-- Permissions SubView -->
+    <panelview id="identity-popup-permissionsView" flex="1">
+      <vbox id="identity-popup-permissionsView-header">
+        <label class="identity-popup-headline"
+               value="&identity.permissions;"
+               crop="end"/>
+      </vbox>
+
+      <vbox id="identity-popup-permissionsView-body">
+        <vbox id="identity-popup-permission-subview-list"/>
+      </vbox>
+    </panelview>
   </panelmultiview>
 </panel>
diff --git a/browser/themes/shared/controlcenter/panel.inc.css b/browser/themes/shared/controlcenter/panel.inc.css
--- a/browser/themes/shared/controlcenter/panel.inc.css
+++ b/browser/themes/shared/controlcenter/panel.inc.css
@@ -283,16 +283,25 @@ description#identity-popup-content-verif
 }
 
 /* PERMISSIONS */
 
 #identity-popup-permissions-content {
   background-image: url(chrome://browser/skin/controlcenter/permissions.svg);
 }
 
-#identity-popup-permission-list {
+#identity-popup-permissionsView {
+  padding: 0.5em 1em;
+}
+
+#identity-popup-permission-list,
+#identity-popup-permission-subview-list {
   margin-top: 5px;
 }
 
+#identity-popup-permission-list menulist,
+#identity-popup-permission-subview-list menulist {
+  max-width: 100px;
+}
+
 .identity-popup-permission-label {
   -moz-margin-start: 0;
 }
-
