# HG changeset patch
# User Brian Grinstead <bgrinstead@mozilla.com>
# Parent  a3e675a3b10a0ea289c301bedc31866f3daf7875
Bug 1386410 - Force the new console frontend to work around

diff --git a/devtools/client/framework/test/browser_toolbox_custom_host.js b/devtools/client/framework/test/browser_toolbox_custom_host.js
--- a/devtools/client/framework/test/browser_toolbox_custom_host.js
+++ b/devtools/client/framework/test/browser_toolbox_custom_host.js
@@ -1,15 +1,23 @@
 /* -*- indent-tabs-mode: nil; js-indent-level: 2 -*- */
 /* vim: set ft=javascript ts=2 et sw=2 tw=80: */
 /* Any copyright is dedicated to the Public Domain.
  * http://creativecommons.org/publicdomain/zero/1.0/ */
 
 const TEST_URL = "data:text/html,test custom host";
 
+
+// Use the new webconsole since the old one is triggering a race in toolbox close
+// See bug 1386410.
+Services.prefs.setBoolPref("devtools.webconsole.new-frontend-enabled", true);
+registerCleanupFunction(function* () {
+  Services.prefs.clearUserPref("devtools.webconsole.new-frontend-enabled");
+});
+
 function test() {
   let {Toolbox} = require("devtools/client/framework/toolbox");
 
   let toolbox, iframe, target;
 
   window.addEventListener("message", onMessage);
 
   iframe = document.createElement("iframe");
@@ -25,17 +33,17 @@ function test() {
 
   function onMessage(event) {
     if (typeof(event.data) !== "string") {
       return;
     }
     info("onMessage: " + event.data);
     let json = JSON.parse(event.data);
     if (json.name == "toolbox-close") {
-      ok("Got the `toolbox-close` message");
+      ok(true, "Got the `toolbox-close` message");
       window.removeEventListener("message", onMessage);
       cleanup();
     }
   }
 
   function testCustomHost(t) {
     toolbox = t;
     is(toolbox.win.top, window, "Toolbox is included in browser.xul");
diff --git a/devtools/client/preferences/devtools.js b/devtools/client/preferences/devtools.js
--- a/devtools/client/preferences/devtools.js
+++ b/devtools/client/preferences/devtools.js
@@ -309,17 +309,17 @@ pref("devtools.webconsole.persistlog", f
 pref("devtools.webconsole.timestampMessages", false);
 
 // Web Console automatic multiline mode: |true| if you want incomplete statements
 // to automatically trigger multiline editing (equivalent to shift + enter).
 pref("devtools.webconsole.autoMultiline", true);
 
 // Enable the new webconsole frontend
 #if defined(NIGHTLY_BUILD) || defined(MOZ_DEV_EDITION)
-pref("devtools.webconsole.new-frontend-enabled", true);
+pref("devtools.webconsole.new-frontend-enabled", false);
 #else
 pref("devtools.webconsole.new-frontend-enabled", false);
 #endif
 
 // Enable client-side mapping service for source maps
 pref("devtools.source-map.client-service.enabled", true);
 
 // The number of lines that are displayed in the web console.
