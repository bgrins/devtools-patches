# HG changeset patch
# User Brian Grinstead <bgrinstead@mozilla.com>
# Date 1548440533 28800
#      Fri Jan 25 10:22:13 2019 -0800
# Node ID 560b7ae8507e4d76392d44593ce314c64617017a
# Parent  2c5eb9d8b8e2680e7ff3d8fe2714bfd78ef0c7d0
Bug 1522916 - Add --jsconsole argument to `mochitest`

Differential Revision: https://phabricator.services.mozilla.com/D17669

diff --git a/testing/mochitest/browser-test.js b/testing/mochitest/browser-test.js
--- a/testing/mochitest/browser-test.js
+++ b/testing/mochitest/browser-test.js
@@ -580,19 +580,20 @@ Tester.prototype = {
       });
       gBrowser.removeTab(gBrowser.selectedTab, { skipPermitUnload: true });
       gBrowser.stop();
     }
 
     // Remove stale windows
     this.structuredLogger.info("checking window state");
     for (let win of Services.wm.getEnumerator(null)) {
+      let type = win.document.documentElement.getAttribute("windowtype");
       if (win != window && !win.closed &&
-          win.document.documentElement.getAttribute("id") != "browserTestHarness") {
-        let type = win.document.documentElement.getAttribute("windowtype");
+          win.document.documentElement.getAttribute("id") != "browserTestHarness" &&
+          type != "devtools:webconsole") {
         switch (type) {
         case "navigator:browser":
           type = "browser window";
           break;
         case "mail:3pane":
           type = "mail window";
           break;
         case null:
diff --git a/testing/mochitest/mochitest_options.py b/testing/mochitest/mochitest_options.py
--- a/testing/mochitest/mochitest_options.py
+++ b/testing/mochitest/mochitest_options.py
@@ -378,16 +378,21 @@ class MochitestArguments(ArgumentContain
           }],
         [["--setpref"],
          {"action": "append",
           "metavar": "PREF=VALUE",
           "default": [],
           "dest": "extraPrefs",
           "help": "Defines an extra user preference.",
           }],
+        [["--jsconsole"],
+         {"action": "store_true",
+          "default": False,
+          "help": "Open the Browser Console.",
+          }],
         [["--jsdebugger"],
          {"action": "store_true",
           "default": False,
           "help": "Start the browser JS debugger before running the test. Implies --no-autorun.",
           }],
         [["--debug-on-failure"],
          {"action": "store_true",
           "default": False,
diff --git a/testing/mochitest/runtests.py b/testing/mochitest/runtests.py
--- a/testing/mochitest/runtests.py
+++ b/testing/mochitest/runtests.py
@@ -2680,16 +2680,19 @@ toolbar#nav-bar {
         if self.mozLogs:
             self.browserEnv["MOZ_LOG_FILE"] = "{}/moz-pid=%PID-uid={}.log".format(
                 self.browserEnv["MOZ_UPLOAD_DIR"], str(uuid.uuid4()))
 
         status = 0
         try:
             self.startServers(options, debuggerInfo)
 
+            if options.jsconsole:
+                options.browserArgs.extend(['--jsconsole'])
+
             if options.jsdebugger:
                 options.browserArgs.extend(['-jsdebugger', '-wait-for-jsdebugger'])
 
             if options.recordingPath:
                 options.browserArgs.extend(['--save-recordings', options.recordingPath])
 
             # Remove the leak detection file so it can't "leak" to the tests run.
             # The file is not there if leak logging was not enabled in the
