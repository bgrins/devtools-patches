# HG changeset patch
# User Paolo Amadini <paolo.mozmail@amadzone.org>
# Date 1527691387 -3600
#      Wed May 30 15:43:07 2018 +0100
# Node ID 757f402225397cae2dbda9a4288a37499b1bee06
# Parent  667d71e72f10bb21993de1f350f0c8dd9faa4259
Bug 1465457 - Part 2 - Load XUL reftests in a privileged context.

MozReview-Commit-ID: 92yRtpn7k2g

Differential Revision: https://phabricator.services.mozilla.com/D11573

diff --git a/layout/reftests/reftest-xul.list b/layout/reftests/reftest-xul.list
new file mode 100644
--- /dev/null
+++ b/layout/reftests/reftest-xul.list
@@ -0,0 +1,3 @@
+
+# theme (osx)
+include ../../toolkit/themes/osx/reftests/reftest.list
diff --git a/layout/tools/reftest/manifest.jsm b/layout/tools/reftest/manifest.jsm
--- a/layout/tools/reftest/manifest.jsm
+++ b/layout/tools/reftest/manifest.jsm
@@ -637,32 +637,43 @@ function ServeTestBase(aURL, depth) {
     // Give the testbase URI access to XUL and XBL
     Services.perms.add(testbase, "allowXULXBL", Services.perms.ALLOW_ACTION);
     return testbase;
 }
 
 function CreateUrls(test) {
     let secMan = Cc[NS_SCRIPTSECURITYMANAGER_CONTRACTID]
                     .getService(Ci.nsIScriptSecurityManager);
+    let chromeReg = Cc["@mozilla.org/chrome/chrome-registry;1"]
+                      .getService(Ci.nsIChromeRegistry);
 
     let manifestURL = g.ioService.newURI(test.manifest);
     let principal = secMan.createCodebasePrincipal(manifestURL, {});
 
     let testbase = manifestURL;
     if (test.runHttp)
         testbase = ServeTestBase(manifestURL, test.httpDepth)
 
     function FileToURI(file)
     {
         if (file === null)
             return file;
 
         var testURI = g.ioService.newURI(file, null, testbase);
         secMan.checkLoadURIWithPrincipal(principal, testURI,
                                          Ci.nsIScriptSecurityManager.DISALLOW_SCRIPT);
+
+        // Load XUL files from "chrome:" URIs to run them with privileges.
+        if (testURI.spec.endsWith(".xul")) {
+          let chromeURI = g.ioService.newURI("chrome://reftest-file/content" +
+                                             testURI.pathQueryRef);
+          chromeReg.registerChromeURLOverrideForTest(chromeURI, testURI);
+          return chromeURI;
+        }
+
         return testURI;
     }
 
     let files = [test.url1, test.url2];
     [test.url1, test.url2] = files.map(FileToURI);
 
     return test;
 }
diff --git a/layout/tools/reftest/reftest-content.js b/layout/tools/reftest/reftest-content.js
--- a/layout/tools/reftest/reftest-content.js
+++ b/layout/tools/reftest/reftest-content.js
@@ -1075,16 +1075,28 @@ function DoAssertionCheck()
         numAsserts = newAssertionCount - gAssertionCount;
         gAssertionCount = newAssertionCount;
     }
     SendAssertionCount(numAsserts);
 }
 
 function LoadURI(uri)
 {
+    if (uri.startsWith("chrome:")) {
+        // Register the override in the content process too.
+        let chromeReg = Cc["@mozilla.org/chrome/chrome-registry;1"]
+                          .getService(Ci.nsIChromeRegistry);
+        let ioService = Cc["@mozilla.org/network/io-service;1"]
+                         .getService(Ci.nsIIOService);
+        let chromeURI = ioService.newURI(uri);
+        let testURI = ioService.newURI("file://" +
+                      chromeURI.pathQueryRef.replace("/content/", "/"));
+        chromeReg.registerChromeURLOverrideForTest(chromeURI, testURI);
+    }
+
     let loadURIOptions = {
       triggeringPrincipal: Services.scriptSecurityManager.getSystemPrincipal(),
     };
     webNavigation().loadURI(uri, loadURIOptions);
 }
 
 function LogWarning(str)
 {
diff --git a/python/mozbuild/mozbuild/test/frontend/data/test-manifest-keys-extracted/moz.build b/python/mozbuild/mozbuild/test/frontend/data/test-manifest-keys-extracted/moz.build
--- a/python/mozbuild/mozbuild/test/frontend/data/test-manifest-keys-extracted/moz.build
+++ b/python/mozbuild/mozbuild/test/frontend/data/test-manifest-keys-extracted/moz.build
@@ -3,10 +3,11 @@
 
 A11Y_MANIFESTS += ['a11y.ini']
 BROWSER_CHROME_MANIFESTS += ['browser.ini']
 METRO_CHROME_MANIFESTS += ['metro.ini']
 MOCHITEST_MANIFESTS += ['mochitest.ini']
 MOCHITEST_CHROME_MANIFESTS += ['chrome.ini']
 XPCSHELL_TESTS_MANIFESTS += ['xpcshell.ini']
 REFTEST_MANIFESTS += ['reftest.list']
+REFTEST_MANIFESTS += ['reftest-xul.list']
 CRASHTEST_MANIFESTS += ['crashtest.list']
 PYTHON_UNITTEST_MANIFESTS += ['python.ini']
diff --git a/taskcluster/ci/test/reftest.yml b/taskcluster/ci/test/reftest.yml
--- a/taskcluster/ci/test/reftest.yml
+++ b/taskcluster/ci/test/reftest.yml
@@ -122,16 +122,33 @@ reftest:
     mozharness:
         chunked:
             by-test-platform:
                 android-em.*: false
                 macosx64/opt: false
                 windows10-64.*/opt: false
                 default: true
 
+reftest-xul:
+    description: "Reftest XUL run"
+    suite: reftest/xul
+    treeherder-symbol: R(x)
+    run-on-projects: built-projects
+    instance-size:
+        by-test-platform:
+            android-em.*: xlarge
+            default: default
+    virtualization: virtual-with-gpu
+    e10s: false
+    chunks: 1
+    max-run-time:
+        by-test-platform:
+            android-em.*: 7200
+            default: 3600
+
 reftest-gpu:
     description: "Reftest GPU run"
     suite: reftest/reftest-gpu
     treeherder-symbol: R(Rg)
     chunks:
         by-test-platform:
             windows.*/opt: 2
             default: 4
diff --git a/taskcluster/ci/test/test-sets.yml b/taskcluster/ci/test/test-sets.yml
--- a/taskcluster/ci/test/test-sets.yml
+++ b/taskcluster/ci/test/test-sets.yml
@@ -31,16 +31,17 @@ common-tests:
     - mochitest-chrome
     - mochitest-clipboard
     - mochitest-devtools-chrome
     - mochitest-gpu
     - mochitest-media
     - mochitest-webgl1-core
     - mochitest-webgl1-ext
     - reftest
+    - reftest-xul
     - reftest-no-accel
     - telemetry-tests-client
     - test-verify
     - test-verify-gpu
     - test-verify-wpt
     - xpcshell
 
 web-platform-tests:
diff --git a/taskcluster/taskgraph/try_option_syntax.py b/taskcluster/taskgraph/try_option_syntax.py
--- a/taskcluster/taskgraph/try_option_syntax.py
+++ b/taskcluster/taskgraph/try_option_syntax.py
@@ -93,16 +93,17 @@ UNITTEST_ALIASES = {
     'mochitest-media': alias_prefix('mochitest-media'),
     'mochitest-media-e10s': alias_prefix('mochitest-media-e10s'),
     'mochitest-vg': alias_prefix('mochitest-valgrind'),
     'reftest': alias_matches(r'^(plain-)?reftest.*$'),
     'reftest-no-accel': alias_matches(r'^(plain-)?reftest-no-accel.*$'),
     'reftests': alias_matches(r'^(plain-)?reftest.*$'),
     'reftests-e10s': alias_matches(r'^(plain-)?reftest-e10s.*$'),
     'reftest-gpu': alias_matches(r'^(plain-)?reftest-gpu.*$'),
+    'reftest-xul': alias_matches(r'^(plain-)?reftest-xul.*$'),
     'robocop': alias_prefix('robocop'),
     'web-platform-test': alias_prefix('web-platform-tests'),
     'web-platform-tests': alias_prefix('web-platform-tests'),
     'web-platform-tests-e10s': alias_prefix('web-platform-tests-e10s'),
     'web-platform-tests-reftests': alias_prefix('web-platform-tests-reftests'),
     'web-platform-tests-reftests-e10s': alias_prefix('web-platform-tests-reftests-e10s'),
     'web-platform-tests-wdspec': alias_prefix('web-platform-tests-wdspec'),
     'web-platform-tests-wdspec-e10s': alias_prefix('web-platform-tests-wdspec-e10s'),
diff --git a/testing/mozharness/configs/unittests/linux_unittest.py b/testing/mozharness/configs/unittests/linux_unittest.py
--- a/testing/mozharness/configs/unittests/linux_unittest.py
+++ b/testing/mozharness/configs/unittests/linux_unittest.py
@@ -199,16 +199,20 @@ config = {
                         "--setpref=layers.acceleration.force-enabled=true"],
             "tests": ["tests/reftest/tests/layout/reftests/reftest.list"]
         },
         "reftest-no-accel": {
             "options": ["--suite=reftest",
                         "--setpref=layers.acceleration.disabled=true"],
             "tests": ["tests/reftest/tests/layout/reftests/reftest.list"]
         },
+        "reftest-xul": {
+            'options': ["--suite=xul"],
+            'tests': ["tests/reftest/tests/layout/reftests/reftest-xul.list"]
+        },
     },
     "all_xpcshell_suites": {
         "xpcshell": {
             "options": ["--xpcshell=%(abs_app_dir)s/" + XPCSHELL_NAME,
                         "--manifest=tests/xpcshell/tests/xpcshell.ini"],
             "tests": []
         },
         "xpcshell-addons": {
diff --git a/testing/mozharness/configs/unittests/win_taskcluster_unittest.py b/testing/mozharness/configs/unittests/win_taskcluster_unittest.py
--- a/testing/mozharness/configs/unittests/win_taskcluster_unittest.py
+++ b/testing/mozharness/configs/unittests/win_taskcluster_unittest.py
@@ -184,16 +184,20 @@ config = {
             'options': ["--suite=reftest"],
             'tests': ["tests/reftest/tests/layout/reftests/reftest.list"]
         },
         "reftest-gpu": {
             'options': ["--suite=reftest",
                         "--setpref=layers.gpu-process.force-enabled=true"],
             'tests': ["tests/reftest/tests/layout/reftests/reftest.list"]
         },
+        "reftest-xul": {
+            'options': ["--suite=xul"],
+            'tests': ["tests/reftest/tests/layout/reftests/reftest-xul.list"]
+        },
         "reftest-no-accel": {
             "options": ["--suite=reftest",
                         "--setpref=layers.acceleration.disabled=true"],
             "tests": ["tests/reftest/tests/layout/reftests/reftest.list"]
         },
     },
     "all_xpcshell_suites": {
         "xpcshell": {
diff --git a/testing/mozharness/configs/unittests/win_unittest.py b/testing/mozharness/configs/unittests/win_unittest.py
--- a/testing/mozharness/configs/unittests/win_unittest.py
+++ b/testing/mozharness/configs/unittests/win_unittest.py
@@ -182,16 +182,20 @@ config = {
                         "--setpref=layers.acceleration.disabled=true"],
             "tests": ["tests/reftest/tests/layout/reftests/reftest.list"]
         },
         "reftest-qr": {
             "options": ["--suite=reftest",
                         "--setpref=gfx.webrender.enabled=true"],
             "tests": ["tests/reftest/tests/layout/reftests/reftest.list"]
         },
+        "reftest-xul": {
+            'options': ["--suite=xul"],
+            'tests': ["tests/reftest/tests/layout/reftests/reftest-xul.list"]
+        },
     },
     "all_xpcshell_suites": {
         "xpcshell": {
             'options': ["--xpcshell=%(abs_app_dir)s/" + XPCSHELL_NAME,
                         "--manifest=tests/xpcshell/tests/xpcshell.ini"],
             'tests': []
         },
         "xpcshell-addons": {
diff --git a/testing/mozharness/mach_commands.py b/testing/mozharness/mach_commands.py
--- a/testing/mozharness/mach_commands.py
+++ b/testing/mozharness/mach_commands.py
@@ -87,16 +87,21 @@ class MozharnessRunner(MozbuildObject):
                 "config": desktop_unittest_config + [
                     "--reftest-suite", "jsreftest"]
             },
             "reftest": {
                 "script": "desktop_unittest.py",
                 "config": desktop_unittest_config + [
                     "--reftest-suite", "reftest"]
             },
+            "reftest-xul": {
+                "script": "desktop_unittest.py",
+                "config": desktop_unittest_config + [
+                    "--reftest-suite", "xul"]
+            },
             "reftest-no-accel": {
                 "script": "desktop_unittest.py",
                 "config": desktop_unittest_config + [
                     "--reftest-suite", "reftest-no-accel"]
             },
             "cppunittest": {
                 "script": "desktop_unittest.py",
                 "config": desktop_unittest_config + [
diff --git a/testing/mozharness/scripts/desktop_unittest.py b/testing/mozharness/scripts/desktop_unittest.py
--- a/testing/mozharness/scripts/desktop_unittest.py
+++ b/testing/mozharness/scripts/desktop_unittest.py
@@ -58,17 +58,17 @@ class DesktopUnittest(TestingMixin, Merc
                     "Examples: 'all', 'plain1', 'plain5', 'chrome', or 'a11y'"}
          ],
         [['--reftest-suite', ], {
             "action": "extend",
             "dest": "specified_reftest_suites",
             "type": "string",
             "help": "Specify which reftest suite to run. "
                     "Suites are defined in the config file.\n"
-                    "Examples: 'all', 'crashplan', or 'jsreftest'"}
+                    "Examples: 'all', 'crashplan', 'jsreftest', or 'xul'"}
          ],
         [['--xpcshell-suite', ], {
             "action": "extend",
             "dest": "specified_xpcshell_suites",
             "type": "string",
             "help": "Specify which xpcshell suite to run. "
                     "Suites are defined in the config file\n."
                     "Examples: 'xpcshell'"}
