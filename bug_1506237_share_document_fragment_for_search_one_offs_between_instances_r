# HG changeset patch
# User Brian Grinstead <bgrinstead@mozilla.com>
# Date 1541795812 28800
#      Fri Nov 09 12:36:52 2018 -0800
# Node ID 5387a6deb19be79a4643fcd4482d5c0584a5707b
# Parent  a64bf8603f349ddece4cfabd98495e5fa84e04fe
Bug 1506237 - Share document fragment for search-one-offs between instances;r=dao

This avoids the cost to parse the markup for subsequent connections.

Differential Revision: https://phabricator.services.mozilla.com/D11521

diff --git a/browser/components/search/content/search-one-offs.js b/browser/components/search/content/search-one-offs.js
--- a/browser/components/search/content/search-one-offs.js
+++ b/browser/components/search/content/search-one-offs.js
@@ -3,16 +3,48 @@
  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */
 
 "use strict";
 
 /* eslint-env mozilla/browser-window */
 
 {
 
+let sharedFragment;
+function getFragment() {
+  if (!sharedFragment) {
+    sharedFragment = MozXULElement.parseXULToFragment(`
+    <deck class="search-panel-one-offs-header search-panel-header search-panel-current-input">
+      <label class="searchbar-oneoffheader-search" value="&searchWithHeader.label;"></label>
+      <hbox class="search-panel-searchforwith search-panel-current-input">
+        <label value="&searchFor.label;"></label>
+        <label class="searchbar-oneoffheader-searchtext search-panel-input-value" flex="1" crop="end"></label>
+        <label flex="10000" value="&searchWith.label;"></label>
+      </hbox>
+      <hbox class="search-panel-searchonengine search-panel-current-input">
+        <label value="&search.label;"></label>
+        <label class="searchbar-oneoffheader-engine search-panel-input-value" flex="1" crop="end"></label>
+        <label flex="10000" value="&searchAfter.label;"></label>
+      </hbox>
+    </deck>
+    <description role="group" class="search-panel-one-offs">
+      <button oncommand="showSettings();" class="searchbar-engine-one-off-item search-setting-button-compact" tooltiptext="&changeSearchSettings.tooltip;"></button>
+    </description>
+    <vbox class="search-add-engines"></vbox>
+    <button oncommand="showSettings();" class="search-setting-button search-panel-header" label="&changeSearchSettings.button;"></button>
+    <menupopup class="search-one-offs-context-menu">
+      <menuitem class="search-one-offs-context-open-in-new-tab" label="&searchInNewTab.label;" accesskey="&searchInNewTab.accesskey;"></menuitem>
+      <menuitem class="search-one-offs-context-set-default" label="&searchSetAsDefault.label;" accesskey="&searchSetAsDefault.accesskey;"></menuitem>
+    </menupopup>
+    `, ["chrome://browser/locale/browser.dtd"]);
+  }
+
+  return document.importNode(sharedFragment, true);
+}
+
 class MozSearchOneOffs extends MozXULElement {
   constructor() {
     super();
 
     this.addEventListener("mousedown", event => {
       let target = event.originalTarget;
       if (target.classList.contains("addengine-menu-button")) {
         return;
@@ -182,41 +214,17 @@ class MozSearchOneOffs extends MozXULEle
     });
   }
 
   connectedCallback() {
     if (this.delayConnectedCallback()) {
       return;
     }
 
-    this.appendChild(MozXULElement.parseXULToFragment(`
-      <deck class="search-panel-one-offs-header search-panel-header search-panel-current-input">
-        <label class="searchbar-oneoffheader-search" value="&searchWithHeader.label;"></label>
-        <hbox class="search-panel-searchforwith search-panel-current-input">
-          <label value="&searchFor.label;"></label>
-          <label class="searchbar-oneoffheader-searchtext search-panel-input-value" flex="1" crop="end"></label>
-          <label flex="10000" value="&searchWith.label;"></label>
-        </hbox>
-        <hbox class="search-panel-searchonengine search-panel-current-input">
-          <label value="&search.label;"></label>
-          <label class="searchbar-oneoffheader-engine search-panel-input-value" flex="1" crop="end"></label>
-          <label flex="10000" value="&searchAfter.label;"></label>
-        </hbox>
-      </deck>
-      <description role="group" class="search-panel-one-offs">
-        <button oncommand="showSettings();" class="searchbar-engine-one-off-item search-setting-button-compact" tooltiptext="&changeSearchSettings.tooltip;"></button>
-      </description>
-      <vbox class="search-add-engines"></vbox>
-      <button oncommand="showSettings();" class="search-setting-button search-panel-header" label="&changeSearchSettings.button;"></button>
-      <menupopup class="search-one-offs-context-menu">
-        <menuitem class="search-one-offs-context-open-in-new-tab" label="&searchInNewTab.label;" accesskey="&searchInNewTab.accesskey;"></menuitem>
-        <menuitem class="search-one-offs-context-set-default" label="&searchSetAsDefault.label;" accesskey="&searchSetAsDefault.accesskey;"></menuitem>
-      </menupopup>
-      `, ["chrome://browser/locale/browser.dtd"])
-    );
+    this.appendChild(getFragment());
 
     this._popup = null;
 
     this._textbox = null;
 
     this._textboxWidth = 0;
 
     /**
