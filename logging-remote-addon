# HG changeset patch
# User Brian Grinstead <bgrinstead@mozilla.com>
# Parent  892c8916ba32b7733e06bfbfdd4083ffae3ca028

diff --git a/browser/base/content/test/newtab/browser_newtab_1188015.js b/browser/base/content/test/newtab/browser_newtab_1188015.js
--- a/browser/base/content/test/newtab/browser_newtab_1188015.js
+++ b/browser/base/content/test/newtab/browser_newtab_1188015.js
@@ -7,16 +7,17 @@ gDirectorySource = "data:application/jso
     enhancedImageURI: "data:image/png;base64,helloWORLD2",
     title: "title1",
     type: "affiliate",
     titleBgColor: "green"
   }]
 });
 
 add_task(async function() {
+  dump("Test logging: " + gBrowser.currentURI.spec + "\n");
   await pushPrefs(["browser.newtab.preload", false]);
 
   // Make the page have a directory link
   await setLinks([]);
   await addNewTabPageTab();
 
   let color = await performOnCell(0, cell => {
     return cell.node.querySelector(".newtab-title").style.backgroundColor;
diff --git a/browser/base/content/test/newtab/head.js b/browser/base/content/test/newtab/head.js
--- a/browser/base/content/test/newtab/head.js
+++ b/browser/base/content/test/newtab/head.js
@@ -38,16 +38,20 @@ requiredSize.innerHeight =
   44 + 32 + // search bar + bottom margin
   (3 * (180 + 32)) + // 3 rows * (tile height + title and bottom margin)
   100; // breathing room
 requiredSize.innerWidth =
   (3 * (290 + 20)) + // 3 cols * (tile width + side margins)
   100; // breathing room
 
 var oldSize = {};
+
+debugger;
+gBrowser.contentWindow;
+dump("TEST URI: " + gBrowser.currentURI.spec + " " + gBrowser.contentWindow.location + "\n");
 Object.keys(requiredSize).forEach(prop => {
   info([prop, gBrowser.contentWindow[prop], requiredSize[prop]]);
   if (gBrowser.contentWindow[prop] < requiredSize[prop]) {
     oldSize[prop] = gBrowser.contentWindow[prop];
     info("Changing browser " + prop + " from " + oldSize[prop] + " to " +
          requiredSize[prop]);
     gBrowser.contentWindow[prop] = requiredSize[prop];
   }
diff --git a/toolkit/components/addoncompat/RemoteAddonsParent.jsm b/toolkit/components/addoncompat/RemoteAddonsParent.jsm
--- a/toolkit/components/addoncompat/RemoteAddonsParent.jsm
+++ b/toolkit/components/addoncompat/RemoteAddonsParent.jsm
@@ -433,16 +433,18 @@ var EventTargetParent = {
 
     if (target instanceof Ci.nsIDOMXULElement) {
       if (target.localName == "browser") {
         return target;
       } else if (target.localName == "tab") {
         return target.linkedBrowser;
       }
 
+      dump("redirectEventTarget " + target + " " + target.localName + "\n");
+
       // Check if |target| is somewhere on the patch from the
       // <tabbrowser> up to the root element.
       let window = target.ownerGlobal;
       if (window && target.contains(window.gBrowser)) {
         return window;
       }
     }
 
@@ -1083,16 +1085,17 @@ var RemoteAddonsParent = {
     register(Ci.nsIWebNavigation, RemoteWebNavigationInterposition);
 
     return result;
   },
 
   getTaggedInterpositions() {
     let result = {};
 
+    dump("\n\n\n\n\ngetTaggedInterpositions\n\n\n\n\n");
     function register(tag, interp) {
       result[tag] = interp;
     }
 
     register("EventTarget", EventTargetInterposition);
     register("ContentDocShellTreeItem", ContentDocShellTreeItemInterposition);
     register("ContentDocument", ContentDocumentInterposition);
     register("RemoteBrowserElement", RemoteBrowserElementInterposition);
diff --git a/toolkit/components/addoncompat/multiprocessShims.js b/toolkit/components/addoncompat/multiprocessShims.js
--- a/toolkit/components/addoncompat/multiprocessShims.js
+++ b/toolkit/components/addoncompat/multiprocessShims.js
@@ -89,16 +89,18 @@ function AddonInterpositionService() {
   wl = wl.filter(function(item) {
     if (nameSet.has(item))
       return true;
 
     nameSet.add(item);
     return true;
   });
 
+  dump("Entries: " + [...nameSet.keys()].join(", ") + "\n");
+
   this._whitelist = wl;
 }
 
 AddonInterpositionService.prototype = {
   classID: Components.ID("{1363d5f0-d95e-11e3-9c1a-0800200c9a66}"),
   QueryInterface: XPCOMUtils.generateQI([Ci.nsIAddonInterposition, Ci.nsISupportsWeakReference]),
 
   getWhitelist() {
@@ -107,39 +109,42 @@ AddonInterpositionService.prototype = {
 
   // When the interface is not known for a method call, this code
   // determines the type of the target object.
   getObjectTag(target) {
     if (Cu.isCrossProcessWrapper(target)) {
       return Cu.getCrossProcessWrapperTag(target);
     }
 
+    dump("\n\n\nLooking at target: " + target + " " + target.__tabbrowser + "\n\n\n");
+    if (target.__tabbrowser) {
+      debugger;
+      return "TabBrowserElement";
+    }
+
     if (target instanceof Ci.nsIDOMXULElement) {
       if (target.localName == "browser" && target.isRemoteBrowser) {
         return "RemoteBrowserElement";
       }
-
-      if (target.localName == "tabbrowser") {
-        return "TabBrowserElement";
-      }
     }
 
     if (target instanceof Ci.nsIDOMChromeWindow && target.gMultiProcessBrowser) {
       return "ChromeWindow";
     }
 
     if (target instanceof Ci.nsIDOMEventTarget) {
       return "EventTarget";
     }
 
     return "generic";
   },
 
   interposeProperty(addon, target, iid, prop) {
     let interp;
+    dump("interposeProperty " + addon + " " + target + " " + iid + " " + prop + "\n\n\n");
     if (iid) {
       interp = this._interfaceInterpositions[iid];
     } else {
       try {
         interp = this._taggedInterpositions[this.getObjectTag(target)];
       } catch (e) {
         Cu.reportError(new Components.Exception("Failed to interpose object", e.result, Components.stack.caller));
       }
@@ -168,13 +173,14 @@ AddonInterpositionService.prototype = {
       return desc;
     }
 
     return Prefetcher.lookupInCache(addon, target, prop);
   },
 
   interposeCall(addonId, originalFunc, originalThis, args) {
     args.splice(0, 0, addonId);
+    dump("interposeCall " + addonId + " " + originalFunc + " " + originalThis + " " + args + "\n");
     return originalFunc.apply(originalThis, args);
   },
 };
 
 this.NSGetFactory = XPCOMUtils.generateNSGetFactory([AddonInterpositionService]);
