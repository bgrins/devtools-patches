# HG changeset patch
# Parent 3cc0b4b7911d583ab5ae66272ad5aac8905cff12
# User Brian Grinstead <bgrinstead@mozilla.com>
pairing with project editor

diff --git a/browser/devtools/projecteditor/chrome/content/projecteditor-loader.js b/browser/devtools/projecteditor/chrome/content/projecteditor-loader.js
--- a/browser/devtools/projecteditor/chrome/content/projecteditor-loader.js
+++ b/browser/devtools/projecteditor/chrome/content/projecteditor-loader.js
@@ -1,19 +1,22 @@
 const Cu = Components.utils;
 const {devtools} = Cu.import("resource://gre/modules/devtools/Loader.jsm", {});
 const {FileUtils} = Cu.import("resource://gre/modules/FileUtils.jsm", {});
 const {NetUtil} = Cu.import("resource://gre/modules/NetUtil.jsm", {});
 const require = devtools.require;
 const promise = require("projecteditor/helpers/promise");
 const ProjectEditor = require("projecteditor/projecteditor");
+const TargetFactory = require("devtools/framework/target").TargetFactory;
+const tabs = require("sdk/tabs");
+Cu.import("resource://gre/modules/Services.jsm");
+
 
 const SAMPLE_PATH = buildTempDirectoryStructure();
 const SAMPLE_NAME = "DevTools Content Application Name";
-const SAMPLE_PROJECT_URL = "http://mozilla.org";
 const SAMPLE_ICON = "chrome://browser/skin/devtools/tool-debugger.svg";
 
 /**
  * Create a workspace for working on projecteditor, available at
  * chrome://browser/content/devtools/projecteditor-loader.xul.
  * This emulates the integration points that the app manager uses.
  */
 document.addEventListener("DOMContentLoaded", function onDOMReady(e) {
@@ -47,25 +50,39 @@ document.addEventListener("DOMContentLoa
   });
   projecteditor.on("onEditorCursorActivity", (editor) => {
     console.log("editor cursor activity: " + editor);
   });
   projecteditor.on("onCommand", (cmd) => {
     console.log("Command: " + cmd);
   });
 
+
+  let topWindow = Services.wm.getMostRecentWindow("navigator:browser");
+  let gBrowser = topWindow.gBrowser;
+
+console.log(gBrowser.mCurrentTab);
   projecteditor.loaded.then(() => {
     projecteditor.setProjectToAppPath(SAMPLE_PATH, {
       name: SAMPLE_NAME,
       iconUrl: SAMPLE_ICON,
-      projectOverviewURL: SAMPLE_PROJECT_URL,
+      projectOverviewURL: "file://" + FileUtils.getFile("TmpD", ["ProjectEditor", "index.html"]).path,
       validationStatus: "valid"
     }).then(() => {
+      let root = projecteditor.project.allResources()[0];
+      let win = projecteditor.editorFor(root).iframe.contentWindow;
       let allResources = projecteditor.project.allResources();
-      console.log("All resources have been loaded", allResources, allResources.map(r=>r.basename).join("|"));
+      let tab = gBrowser.mCurrentTab;
+      let target = TargetFactory.forTab(tab);
+      target.makeRemote().then(() => {
+        console.log("Making remote", target);
+        projecteditor.setTarget(target, win);
+      });
+
+      console.log("All resources have been loaded", allResources.map(r=>r.basename).join("|"));
     });
 
   });
 
 }, false);
 
 /**
  * Build a temporary directory as a workspace for this loader
@@ -87,21 +104,41 @@ function buildTempDirectoryStructure() {
 
   let htmlFile = FileUtils.getFile("TmpD", ["ProjectEditor", "index.html"]);
   htmlFile.createUnique(Components.interfaces.nsIFile.NORMAL_FILE_TYPE, FileUtils.PERMS_FILE);
   writeToFile(htmlFile, [
     '<!DOCTYPE html>',
     '<html lang="en">',
     ' <head>',
     '   <meta charset="utf-8" />',
-    '   <title>ProjectEditor Temp File</title>',
-    '   <link rel="stylesheet" href="style.css" />',
+    '   <title>ProjectEditor Home Page</title>',
+    '   <link rel="stylesheet" href="css/styles.css" />',
     ' </head>',
     ' <body id="home">',
-    '   <p>ProjectEditor Temp File</p>',
+    '   <p>ProjectEditor Home Page</p>',
+    '   <button onclick="window.location.reload()">Reload Page</button>',
+    '   <a href="sample.html">Navigate to sample.html</a>',
+    ' </body>',
+    '</html>'].join("\n")
+  );
+
+  let htmlFile2 = FileUtils.getFile("TmpD", ["ProjectEditor", "sample.html"]);
+  htmlFile2.createUnique(Components.interfaces.nsIFile.NORMAL_FILE_TYPE, FileUtils.PERMS_FILE);
+  writeToFile(htmlFile2, [
+    '<!DOCTYPE html>',
+    '<html lang="en">',
+    ' <head>',
+    '   <meta charset="utf-8" />',
+    '   <title>ProjectEditor Sample Page</title>',
+    '   <link rel="stylesheet" href="css/styles.css" />',
+    ' </head>',
+    ' <body id="home">',
+    '   <p>ProjectEditor Sample Page</p>',
+    '   <button onclick="window.location.reload()">Reload Page</button>',
+    '   <a href="index.html">Navigate to index.html</a>',
     ' </body>',
     '</html>'].join("\n")
   );
 
   let readmeFile = FileUtils.getFile("TmpD", ["ProjectEditor", "README.md"]);
   readmeFile.createUnique(Components.interfaces.nsIFile.NORMAL_FILE_TYPE, FileUtils.PERMS_FILE);
   writeToFile(readmeFile, [
     '## Readme'
@@ -116,17 +153,20 @@ function buildTempDirectoryStructure() {
    ' * file, You can obtain one at http://mozilla.org/MPL/2.0/. */'
     ].join("\n")
   );
 
   let cssFile = FileUtils.getFile("TmpD", ["ProjectEditor", "css", "styles.css"]);
   cssFile.createUnique(Components.interfaces.nsIFile.NORMAL_FILE_TYPE, FileUtils.PERMS_FILE);
   writeToFile(cssFile, [
     'body {',
-    ' background: red;',
+    '  background: #fee;',
+    '}',
+    'p {',
+    '  padding: 10px',
     '}'
     ].join("\n")
   );
 
   FileUtils.getFile("TmpD", ["ProjectEditor", "js", "script.js"]).createUnique(Components.interfaces.nsIFile.NORMAL_FILE_TYPE, FileUtils.PERMS_FILE);
 
   FileUtils.getFile("TmpD", ["ProjectEditor", "img", "fake.png"]).createUnique(Components.interfaces.nsIFile.NORMAL_FILE_TYPE, FileUtils.PERMS_FILE);
   FileUtils.getFile("TmpD", ["ProjectEditor", "img", "icons", "16x16.png"]).createUnique(Components.interfaces.nsIFile.NORMAL_FILE_TYPE, FileUtils.PERMS_FILE);
diff --git a/browser/devtools/projecteditor/lib/editors.js b/browser/devtools/projecteditor/lib/editors.js
--- a/browser/devtools/projecteditor/lib/editors.js
+++ b/browser/devtools/projecteditor/lib/editors.js
@@ -142,20 +142,20 @@ var TextEditor = Class({
       lineNumbers: true,
       extraKeys: this.extraKeys,
       themeSwitching: false,
       autocomplete: true
     });
 
     // Trigger editor specific events on `this`
     this.editor.on("change", (...args) => {
-      this.emit("change", ...args);
+      this.emit("change", this.editor.getText());
     });
     this.editor.on("cursorActivity", (...args) => {
-      this.emit("cursorActivity", ...args);
+      this.emit("cursorActivity", this.editor.getText());
     });
 
     this.appended = this.editor.appendTo(this.elt);
     this.appended.then(() => {
       if (this.editor) {
         this.editor.setupAutoCompletion();
       }
     });
@@ -197,19 +197,20 @@ var TextEditor = Class({
    *
    * @param Resource resource
    *        The single file / item to be saved
    * @returns Promise
    *          A promise that is resolved once the resource has been
    *          saved.
    */
   save: function(resource) {
-    return resource.save(this.editor.getText()).then(() => {
+    let text = this.editor.getText();
+    return resource.save(text).then(() => {
       this.editor.setClean();
-      this.emit("save", resource);
+      this.emit("save", text);
     });
   },
 
   /**
    * Give focus to the code editor.
    *
    * @returns Promise
    *          A promise that is resolved once the editor has been focused.
diff --git a/browser/devtools/projecteditor/lib/plugins/pairing/page-asset.js b/browser/devtools/projecteditor/lib/plugins/pairing/page-asset.js
new file mode 100644
--- /dev/null
+++ b/browser/devtools/projecteditor/lib/plugins/pairing/page-asset.js
@@ -0,0 +1,58 @@
+/* -*- Mode: Javascript; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */
+/* vim: set ft=javascript ts=2 et sw=2 tw=80: */
+/* This Source Code Form is subject to the terms of the Mozilla Public
+ * License, v. 2.0. If a copy of the MPL was not distributed with this
+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */
+"use strict";
+
+const { Class } = require("sdk/core/heritage");
+const { emit } = require("sdk/event/core");
+const { EventTarget } = require("sdk/event/target");
+const { on, off, forget } = require("projecteditor/helpers/event");
+const { StyleSheetsFront } = require("devtools/server/actors/stylesheets");
+const { StyleEditorFront } = require("devtools/server/actors/styleeditor");
+
+// Maintains the list of pairs.
+var PageAsset = Class({
+  initialize: function(front) {
+    this.front = front;
+  },
+
+  get isStyleSheet () {
+    return this.front.typeName === "stylesheet" || this.front.typeName === "styleeditor"
+  },
+
+  get href () {
+    let path = null;
+    if (this.isStyleSheet) {
+      path = this.front.href;
+    }
+    return path;
+  },
+
+  get basename () {
+    let splitHref = this.href.split('/')
+    let basename = splitHref[splitHref.length - 1];
+
+    return basename;
+  },
+
+  update: function(text) {
+
+    if (this.isStyleSheet) {
+      this.front.update(text, false);
+    }
+  },
+
+  belongsToWindow: function(window) {
+    if (this.isStyleSheet) {
+      let location = window.location.toString();
+      if (this.front.nodeHref !== location) {
+        return false;
+      }
+    }
+    return true;
+  }
+});
+
+exports.PageAsset = PageAsset;
diff --git a/browser/devtools/projecteditor/lib/plugins/pairing/pairing.js b/browser/devtools/projecteditor/lib/plugins/pairing/pairing.js
new file mode 100644
--- /dev/null
+++ b/browser/devtools/projecteditor/lib/plugins/pairing/pairing.js
@@ -0,0 +1,104 @@
+/* -*- Mode: Javascript; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */
+/* vim: set ft=javascript ts=2 et sw=2 tw=80: */
+/* This Source Code Form is subject to the terms of the Mozilla Public
+ * License, v. 2.0. If a copy of the MPL was not distributed with this
+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */
+"use strict";
+
+const { Class } = require("sdk/core/heritage");
+const { registerPlugin, Plugin } = require("projecteditor/plugins/core");
+const { StyleSheetsFront } = require("devtools/server/actors/stylesheets");
+const { StyleEditorFront } = require("devtools/server/actors/styleeditor");
+const { CssLogic } = require("devtools/styleinspector/css-logic");
+const { ResourceMap } = require("projecteditor/plugins/pairing/resource-map");
+
+// Handles the new command.
+var Pairing = Class({
+  extends: Plugin,
+
+  init: function() {
+    this._onWillNavigate = this._onWillNavigate.bind(this);
+    this._onNavigate = this._onNavigate.bind(this);
+    this.resourceMap = new ResourceMap(this.host);
+  },
+
+  onEditorSave: function(host, resource, text) {
+    this.updatePageAssetsForResource(resource, text);
+  },
+  onEditorChange: function(host, resource, text) {
+    this.updatePageAssetsForResource(resource, text);
+  },
+  updatePageAssetsForResource: function (resource, text) {
+    let assets = this.resourceMap.getPageAssetsForResource(resource);
+    if (assets) {
+      assets.forEach(asset => {
+        asset.update(text, false);
+      });
+    }
+  },
+
+  get target() {
+    return this.host.target;
+  },
+
+  get targetWin() {
+    return this.host.targetWin;
+  },
+
+  newTarget: function(target, win) {
+    // XXX: Need to share style editor fronts with the style editor.
+    if (this.target.form.styleSheetsActor) {
+      this.debuggee = StyleSheetsFront(this.target.client, this.target.form);
+    } else {
+      // We're talking to a pre-firefox 29 server-side
+      this.debuggee = StyleEditorFront(this.target.client, this.target.form);
+    }
+    this.fetchStyleSheets(target);
+  },
+
+  fetchStyleSheets: function(target) {
+    if (!target) {
+      target = this.target;
+    }
+
+    this.debuggee.getStyleSheets().then(styleSheets => {
+      if (this.target !== target) {
+        return;
+      }
+
+      this.resourceMap.setSheets(styleSheets);
+      this.target.on("will-navigate", this._onWillNavigate);
+      this.target.on("navigate", this._onNavigate);
+    }).then(null, console.error);
+  },
+
+  _onWillNavigate: function() {
+    console.log("Pairing: _onWillNavigate");
+    this.resourceMap.clear();
+  },
+
+  _onNavigate: function() {
+    console.log("Pairing: _onNavigate");
+    this.fetchStyleSheets();
+  },
+
+  removeTarget: function(target) {
+    this.resourceMap.clear();
+
+    if (this.debuggee) {
+      this.debuggee.destroy();
+    }
+
+    if (this.target) {
+      this.target.off("will-navigate", this._onStyleSheetsCleared);
+      this.target.off("navigate", this._onNavigate);
+    }
+  },
+
+  destroy: function() {
+    this.removeTarget();
+  }
+});
+
+registerPlugin(Pairing);
+exports.Pairing = Pairing;
diff --git a/browser/devtools/projecteditor/lib/plugins/pairing/resource-map.js b/browser/devtools/projecteditor/lib/plugins/pairing/resource-map.js
new file mode 100644
--- /dev/null
+++ b/browser/devtools/projecteditor/lib/plugins/pairing/resource-map.js
@@ -0,0 +1,170 @@
+/* -*- Mode: Javascript; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */
+/* vim: set ft=javascript ts=2 et sw=2 tw=80: */
+/* This Source Code Form is subject to the terms of the Mozilla Public
+ * License, v. 2.0. If a copy of the MPL was not distributed with this
+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */
+"use strict";
+
+const { Class } = require("sdk/core/heritage");
+const { emit } = require("sdk/event/core");
+const { EventTarget } = require("sdk/event/target");
+const timers = require("sdk/timers");
+const { on, off, forget } = require("projecteditor/helpers/event");
+const { PageAsset } = require("projecteditor/plugins/pairing/page-asset");
+
+// Maintains the list of pairs.
+var ResourceMap = Class({
+  initialize: function(host) {
+    this.map = new Map();
+    this.styleSheetMap = new Map();
+    this.host = host;
+
+    this.scheduleRebuild = this.scheduleRebuild.bind(this);
+    this.rebuild = this.rebuild.bind(this)
+    this.watchCollection = this.watchCollection.bind(this);
+    this.unwatchCollection = this.unwatchCollection.bind(this);
+
+    [...this.host.project.allStores()].forEach(this.watchCollection);
+    on(this, this.host.project, "store-added", this.watchCollection);
+    on(this, this.host.project, "store-removed", this.unwatchCollection);
+  },
+
+  get target () {
+    return this.host.target;
+  },
+  get targetWin () {
+    return this.host.targetWin;
+  },
+  allResources: function() {
+    return this.host.project.allResources();
+  },
+  getPageAssetsForResource: function(resource) {
+    return this.map.get(resource);
+  },
+  clear: function() {
+    this.map.clear();
+  },
+  setSheets: function(styleSheets) {
+    this.styleSheetMap = new Map();
+    this.styleSheets = styleSheets;
+    styleSheets.forEach((sheet) => {
+      let sheetAsset = new PageAsset(sheet);
+      let processSheet = !!sheetAsset.href;
+      if (this.targetWin) {
+        processSheet = sheetAsset.belongsToWindow(this.targetWin);
+      }
+
+      if (processSheet) {
+        this.styleSheetMap.set(sheet.href, sheetAsset);
+      }
+    });
+    this.rebuild();
+  },
+
+  watchCollection: function(collection) {
+    on(this, collection, "resource-added", this.scheduleRebuild);
+    on(this, collection, "resource-removed", this.scheduleRebuild);
+  },
+
+  unwatchCollection: function(collection) {
+    forget(this, collection);
+  },
+
+  scheduleRebuild: function() {
+    if (this._scheduledRebuild) {
+      timers.clearTimeout(this._scheduledRebuild);
+    }
+    this._scheduledRebuild = timers.setTimeout(this.rebuild, 100);
+  },
+
+  /**
+  * Rebuild the project pairings.
+  */
+  rebuild: function() {
+    if (this._scheduledRebuild) {
+      timers.clearTimeout(this._scheduledRebuild);
+      this._scheduledRebuild = null;
+    }
+    let start = Date.now();
+    let newPairs = new Map();
+    this.clear();
+    for (let [path,stylesheet] of this.styleSheetMap.entries()) {
+      let resource = this._findBestResource(stylesheet);
+      if (resource) {
+        if (!this.map.get(resource)) {
+          this.map.set(resource, [stylesheet]);
+        }
+        if (this.map.get(resource).indexOf(stylesheet) === -1) {
+          needUpdate = true;
+          this.map.get(resource).push(stylesheet);
+        }
+      }
+    }
+
+    let end = Date.now();
+    console.log("Rebuilt project map in " + (end - start) + "ms");
+  },
+
+  /**
+  * Find the best resource for a page asset
+  *
+  * Right now we only have one strategy, but new strategies
+  * can be added here.
+  */
+  _findBestResource: function(asset) {
+    return this._fuzzyStrategy(asset.basename, asset.href);
+  },
+
+  /**
+  * The default fuzzy match strategy for finding a live pairing.
+  * Finds a project resources with the same basename, and chooses
+  * the one with the most path component matches.
+  */
+  _fuzzyStrategy: function(basename, path) {
+    let matches = this._findBasenameMatches(basename);
+    if (matches.length < 1) {
+      return null;
+    }
+
+    let searchPath = path.split('/').filter(item => !!item);
+    searchPath.reverse();
+
+    let bestMatch = null;
+    let bestMatchComponents = 0;
+    let bestMatchExtra = 1000;
+    for (let match of matches) {
+      let matchPath = path.split('/').filter(item => !!item);
+      matchPath.reverse();
+      let i;
+      for (i = 0; i < matchPath.length && i < searchPath.length; i++) {
+        if (matchPath[i] != searchPath[i]) {
+          break;
+        }
+      }
+
+      // In case of a tie in matched components, arbitrarily assume that
+      // resources closer to the project root are correct.
+      let remaining = matchPath.length - i;
+      if (i > bestMatchComponents ||
+          (i === bestMatchComponents && remaining < bestMatchExtra)) {
+        bestMatch = match;
+        bestMatchComponents = i;
+        bestMatchExtra = remaining;
+      }
+    }
+
+    return bestMatch;
+  },
+
+  _findBasenameMatches: function(basename) {
+    let matches = [];
+    for (let resource of this.allResources()) {
+      if (resource.basename == basename) {
+        matches.push(resource);
+      }
+    }
+    return matches;
+  }
+});
+
+exports.ResourceMap = ResourceMap;
diff --git a/browser/devtools/projecteditor/lib/projecteditor.js b/browser/devtools/projecteditor/lib/projecteditor.js
--- a/browser/devtools/projecteditor/lib/projecteditor.js
+++ b/browser/devtools/projecteditor/lib/projecteditor.js
@@ -24,16 +24,17 @@ const ITCHPAD_URL = "chrome://browser/co
 // Enabled Plugins
 require("projecteditor/plugins/dirty/dirty");
 require("projecteditor/plugins/delete/delete");
 require("projecteditor/plugins/new/new");
 require("projecteditor/plugins/save/save");
 require("projecteditor/plugins/image-view/plugin");
 require("projecteditor/plugins/app-manager/plugin");
 require("projecteditor/plugins/status-bar/plugin");
+require("projecteditor/plugins/pairing/pairing");
 
 // Uncomment to enable logging.
 // require("projecteditor/plugins/logging/logging");
 
 /**
  * This is the main class tying together an instance of the ProjectEditor.
  * The frontend is contained inside of this.iframe, which loads projecteditor.xul.
  *
@@ -282,16 +283,40 @@ var ProjectEditor = Class({
       let rootResource = this.project.localStores.get(path).root;
       emit(rootResource, "label-change", rootResource);
     }
 
     return this.project.refresh();
   },
 
   /**
+   * Set a TabTarget for pairing with the editor
+   *
+   * @param TabTarget target
+   *                  The target for pairing.
+   *                  If null, the current target will be removed.
+   * @param Window win
+   *               The window within the target that should be watched.
+   *               If null, all windows will be watched.
+   */
+  setTarget: function(target = null, win=null) {
+    if (!target) {
+      this.pluginDispatch("removeTarget", this.target);
+      this.target = this.targetWin = null;
+    } else if (target !== this.target) {
+      if (this.target) {
+        this.pluginDispatch("removeTarget", this.target, this.targetWin);
+      }
+      this.target = target;
+      this.targetWin = win;
+      this.pluginDispatch("newTarget", target, win);
+    }
+  },
+
+  /**
    * Open a resource in a particular shell.
    *
    * @param Resource resource
    *                 The file to be opened.
    */
   openResource: function(resource) {
     this.shells.open(resource);
     this.projectTree.selectResource(resource);
diff --git a/toolkit/devtools/server/actors/stylesheets.js b/toolkit/devtools/server/actors/stylesheets.js
--- a/toolkit/devtools/server/actors/stylesheets.js
+++ b/toolkit/devtools/server/actors/stylesheets.js
@@ -955,16 +955,20 @@ let StyleSheetActor = protocol.ActorClas
    */
   _onTransitionEnd: function()
   {
     if (--this._transitionRefCount == 0) {
       this.document.documentElement.classList.remove(TRANSITION_CLASS);
       this.rawSheet.deleteRule(this.rawSheet.cssRules.length - 1);
     }
 
+    this._notifyStyleApplied();
+  },
+
+  _notifyStyleApplied: function() {
     events.emit(this, "style-applied");
   }
 })
 
 /**
  * Find the line/column for a rule.
  * This is like DOMUtils.getRule[Line|Column] except for inline <style> sheets,
  * the line number returned here is relative to the <style> tag rather than the
