# HG changeset patch
# User Brian Grinstead <bgrinstead@mozilla.com>
# Parent  f148d84038400a368315d1d0391ed0ea498ca676
Bug 1304178 - collect between damp runs;r=jryans

diff --git a/testing/talos/talos/tests/devtools/addon/content/damp.js b/testing/talos/talos/tests/devtools/addon/content/damp.js
--- a/testing/talos/talos/tests/devtools/addon/content/damp.js
+++ b/testing/talos/talos/tests/devtools/addon/content/damp.js
@@ -339,16 +339,17 @@ Damp.prototype = {
       }
     }
 
     return sequenceArray;
   },
 
   testSetup: Task.async(function*(url) {
     let tab = yield this.addTab(url);
+    forceCollections();
     yield new Promise(resolve => {
       setTimeout(resolve, this._config.rest);
     });
     return tab;
   }),
 
   testTeardown: Task.async(function*(url) {
     this.closeCurrentTab();
@@ -452,8 +453,18 @@ Damp.prototype = {
       tests = tests.concat(this._consoleBulkLoggingTest);
     }
     if (config.subtests.indexOf("consoleStreamLogging") > -1) {
       tests = tests.concat(this._consoleStreamLoggingTest);
     }
     this._doSequence(tests, this._doneInternal);
   }
 }
+
+/**
+ * Forces GC, CC and Shrinking GC to get rid of disconnected docshells and
+ * windows.
+ */
+function forceCollections() {
+  Cu.forceGC();
+  Cu.forceCC();
+  Cu.forceShrinkingGC();
+}
