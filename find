# HG changeset patch
# Parent f2e8982acbf03ff2bba72bdd804913911f91b3fb
# User Brian Grinstead <bgrinstead@mozilla.com>
Bug 1026479 - Add a unified search across all tools in the toolbox

diff --git a/browser/devtools/debugger/debugger-panes.js b/browser/devtools/debugger/debugger-panes.js
--- a/browser/devtools/debugger/debugger-panes.js
+++ b/browser/devtools/debugger/debugger-panes.js
@@ -2801,17 +2801,17 @@ GlobalSearchView.prototype = Heritage.ex
       }
     }
 
     // Rebuild the results, then signal if there are any matches.
     if (globalResults.matchCount) {
       this.hidden = false;
       this._currentlyFocusedMatch = -1;
       this._createGlobalResultsUI(globalResults);
-      window.emit(EVENTS.GLOBAL_SEARCH_MATCH_FOUND);
+      window.emit(EVENTS.GLOBAL_SEARCH_MATCH_FOUND, globalResults);
     } else {
       window.emit(EVENTS.GLOBAL_SEARCH_MATCH_NOT_FOUND);
     }
   },
 
   /**
    * Creates global search results entries and adds them to this container.
    *
diff --git a/browser/devtools/framework/toolbox-find.js b/browser/devtools/framework/toolbox-find.js
new file mode 100644
--- /dev/null
+++ b/browser/devtools/framework/toolbox-find.js
@@ -0,0 +1,247 @@
+/* This Source Code Form is subject to the terms of the Mozilla Public
+ * License, v. 2.0. If a copy of the MPL was not distributed with this
+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */
+
+"use strict";
+
+const {Cu, Cc, Ci} = require("chrome");
+const Services = require("Services");
+const EventEmitter = require("devtools/toolkit/event-emitter");
+Cu.import("resource://gre/modules/XPCOMUtils.jsm");
+XPCOMUtils.defineLazyModuleGetter(this, "gDevTools", "resource:///modules/devtools/gDevTools.jsm");
+
+exports.FindPane = FindPane;
+
+/**
+ *
+ */
+function FindPane(toolbox) {
+  EventEmitter.decorate(this);
+  this.toolbox = toolbox;
+  this.isReady = false;
+
+  this._finding = false;
+
+  this.findAll = this.findAll.bind(this);
+  this.endFindAll = this.endFindAll.bind(this);
+  this.toggleFindAll = this.toggleFindAll.bind(this);
+  this._findTextBoxInput = this._findTextBoxInput.bind(this);
+  this._onFindKeyPress = this._onFindKeyPress.bind(this);
+  this._onFindBeforeNavigate = this._onFindBeforeNavigate.bind(this);
+  this._onResultClicked = this._onResultClicked.bind(this);
+
+  this._findPanel = this.doc.getElementById("toolbox-find");
+  this._findBoxContainer = this.doc.getElementById("toolbox-find-box-container");
+  this._findSplitter = this.doc.getElementById("toolbox-find-splitter");
+
+  this._findResultPanel = this.doc.getElementById("find-results");
+  this._findResultPanel.addEventListener("click", this._onResultClicked, false);
+
+  this._findAllKey = this.doc.getElementById("toolbox-find-all-key");
+  this._findAllKey.addEventListener("command", this.toggleFindAll, true);
+
+  this._findClose = this.doc.getElementById("find-close");
+  this._findClose.addEventListener("click", this.endFindAll, false);
+
+  this._findButton = this.doc.getElementById("find-go");
+  this._findButton.addEventListener("click", this.findAll, false);
+
+  this._findTextBox = this.doc.getElementById("find-box");
+  this._findTextBox.addEventListener("select", this._findTextBoxInput, false);
+  this._findTextBox.addEventListener("input", this._findTextBoxInput, false);
+  this._findTextBox.addEventListener("keypress", this._onFindKeyPress, false);
+  // this._findTextBox.addEventListener("blur", this._onBlur, false);
+  // this._findTextBox.addEventListener("click", this._onClick, false);
+
+  this.selectedFindTools = this.doc.getElementById("selected-find-tools");
+  this.getAllFindableTools().forEach(([id, toolDefinition]) => {
+    let check = this.doc.createElement("checkbox");
+    check.id = "find-selected-" + id;
+    check.setAttribute("label", id);
+    check.setAttribute("checked", "true");
+    this.selectedFindTools.appendChild(check);
+  });
+
+  this.toolbox.on("options-selected", this.endFindAll);
+
+
+  this.target.on("will-navigate", this._onFindBeforeNavigate);
+
+}
+
+FindPane.prototype = {
+
+  get doc() {
+    return this.toolbox.doc;
+  },
+
+  get target() {
+    return this.toolbox.target;
+  },
+
+  get finding() {
+    return this._finding;
+  },
+
+  destroy: function() {
+    this.toolbox.off("options-selected", this.endFindAll);
+    this.target.off("will-navigate", this._onFindBeforeNavigate);
+
+    this._findResultPanel.removeEventListener("click", this._onResultClicked, false);
+    this._findAllKey.removeEventListener("command", this.toggleFindAll, true);
+    this._findClose.removeEventListener("click", this.endFindAll, false);
+    this._findButton.removeEventListener("click", this.findAll, false);
+    this._findTextBox.removeEventListener("select", this._findTextBoxInput, false);
+    this._findTextBox.removeEventListener("input", this._findTextBoxInput, false);
+    this._findTextBox.removeEventListener("keypress", this._onFindKeyPress, false);
+  },
+
+  getAllFindableTools: function() {
+    let findableTools = [];
+    for (let [id, toolDefinition] of gDevTools.getToolDefinitionMap()) {
+      if (toolDefinition.searchable) {
+        findableTools.push([id, toolDefinition]);
+      }
+    }
+    return findableTools;
+  },
+
+  getSelectedFindableTools: function() {
+    let findableTools = this.getAllFindableTools();
+    return findableTools.filter(([id]) => {
+      return this.doc.getElementById("find-selected-" + id).getAttribute("checked") == "true";
+    })
+  },
+
+  openAllSelectedFindableTools: function() {
+    let findableTools = this.getSelectedFindableTools();
+    let toolLoaders = findableTools.map(([id, toolDefinition]) => {
+      return this.toolbox.loadTool(id);
+    });
+
+    return promise.all(toolLoaders).then(() => {
+      return findableTools;
+    });
+  },
+
+  toggleFindAll: function() {
+    if (this._finding) {
+      this.endFindAll();
+    } else {
+      this.beginFindAll();
+    }
+  },
+
+  beginFindAll: function(e) {
+    if (this._finding) {
+      return;
+    }
+    this._finding = true;
+    this.openAllSelectedFindableTools();
+
+    this._findBoxContainer.removeAttribute("collapsed");
+    this._findSplitter.removeAttribute("hidden");
+
+    this._findTextBox.focus();
+
+    if (this._findResultPanel.innerHTML != "") {
+      this._findResultPanel.removeAttribute("hidden");
+    }
+  },
+
+  endFindAll: function() {
+    if (!this._finding) {
+      return;
+    }
+    this._finding = false;
+    this._findPanel.setAttribute("collapsed", "true");
+    this._findBoxContainer.setAttribute("collapsed", "true");
+    this._findSplitter.setAttribute("hidden", "true");
+  },
+
+  findAll: function() {
+    this.openAllSelectedFindableTools().then((findableTools) => {
+      let value = this._findTextBox.value;
+
+      console.log("Searching for string " + value + " in " + findableTools.map(([id]) => {return id }).join(","));
+
+      this._findPanel.removeAttribute("collapsed");
+
+      this._findResultPanel.removeAttribute("hidden");
+      this._findResultPanel.innerHTML = "";
+
+      let results = [];
+      findableTools.forEach(([id, toolDefinition]) => {
+        let p = toolDefinition.onsearch(value, this.toolbox.getPanel(id), this);
+        if (!p || !p.then) {
+          return;
+        }
+        console.log("Waiting for " + id + " results");
+        p.then(r => {
+          if (!r) {
+            return;
+          }
+          console.log("Received " + r.length + " results for " + id);
+          r.forEach(result=> {
+            let node;
+            if (result.render) {
+              node = result.render();
+            } else {
+              node = result;
+            }
+            let clickableNode = this.doc.createElement("box");
+            clickableNode.classList.add("find-result");
+            clickableNode.appendChild(node);
+            this._findResultPanel.appendChild(clickableNode);
+          });
+        });
+      });
+
+
+      // for (let i = 0; i < 100; i++) {
+      //   let box = this.doc.createElement("box");
+      //   box.textContent = "Search result #" + i + ": " + value;
+      //   results.push(box);
+      // }
+
+      // results.forEach(result=> {
+      //   findResultPanel.appendChild(result);
+      // });
+    });
+  },
+
+  _onFindBeforeNavigate: function() {
+
+  },
+
+  _onResultClicked: function(e) {
+    console.log(e.target, e.originalTarget);
+    let el = closest(e.originalTarget, ".find-result");
+    if (el) {
+      console.log("BINGO");
+    }
+  },
+
+  _onFindKeyPress: function(e) {
+    if (e.keyCode === e.DOM_VK_RETURN) {
+      this.findAll();
+    }
+  },
+
+  _findTextBoxInput: function() {
+  },
+
+};
+
+function closest(elem, selector) {
+
+   var matchesSelector = elem.mozMatchesSelector;
+    while (elem) {
+        if (matchesSelector.bind(elem)(selector)) {
+            return elem;
+        } else {
+            elem = elem.parentElement;
+        }
+    }
+    return false;
+}
diff --git a/browser/devtools/framework/toolbox.js b/browser/devtools/framework/toolbox.js
--- a/browser/devtools/framework/toolbox.js
+++ b/browser/devtools/framework/toolbox.js
@@ -10,16 +10,17 @@ const MIN_ZOOM = 0.5;
 const MAX_ZOOM = 2;
 
 let {Cc, Ci, Cu} = require("chrome");
 let {Promise: promise} = require("resource://gre/modules/Promise.jsm");
 let EventEmitter = require("devtools/toolkit/event-emitter");
 let Telemetry = require("devtools/shared/telemetry");
 let {getHighlighterUtils} = require("devtools/framework/toolbox-highlighter-utils");
 let HUDService = require("devtools/webconsole/hudservice");
+let {FindPane} = require("devtools/framework/toolbox-find");
 
 Cu.import("resource://gre/modules/XPCOMUtils.jsm");
 Cu.import("resource://gre/modules/Services.jsm");
 Cu.import("resource:///modules/devtools/gDevTools.jsm");
 Cu.import("resource:///modules/devtools/scratchpad-manager.jsm");
 Cu.import("resource:///modules/devtools/DOMHelpers.jsm");
 Cu.import("resource://gre/modules/Task.jsm");
 
@@ -62,17 +63,17 @@ loader.lazyGetter(this, "InspectorFront"
 function Toolbox(target, selectedTool, hostType, hostOptions) {
   this._target = target;
   this._toolPanels = new Map();
   this._telemetry = new Telemetry();
 
   this._toolRegistered = this._toolRegistered.bind(this);
   this._toolUnregistered = this._toolUnregistered.bind(this);
   this._refreshHostTitle = this._refreshHostTitle.bind(this);
-  this._splitConsoleOnKeypress = this._splitConsoleOnKeypress.bind(this)
+  this._onDocKeypress = this._onDocKeypress.bind(this)
   this.destroy = this.destroy.bind(this);
   this.highlighterUtils = getHighlighterUtils(this);
   this._highlighterReady = this._highlighterReady.bind(this);
   this._highlighterHidden = this._highlighterHidden.bind(this);
 
   this._target.on("close", this.destroy);
 
   if (!hostType) {
@@ -245,16 +246,17 @@ Toolbox.prototype = {
         this._buildOptions();
         this._buildTabs();
         let buttonsPromise = this._buildButtons();
         this._addKeysToWindow();
         this._addReloadKeys();
         this._addToolSwitchingKeys();
         this._addZoomKeys();
         this._loadInitialZoom();
+        this.findPane = new FindPane(this);
 
         this._telemetry.toolOpened("toolbox");
 
         this.selectTool(this._defaultToolId).then(panel => {
           buttonsPromise.then(() => {
             this.emit("ready");
             deferred.resolve();
           }, deferred.reject);
@@ -285,19 +287,21 @@ Toolbox.prototype = {
       let tab = this.target.tab;
       let browserWindow = tab.ownerDocument.defaultView;
       let responsiveUIManager = browserWindow.ResponsiveUI.ResponsiveUIManager;
       responsiveModeActive = responsiveUIManager.isActiveForTab(tab);
     }
     return responsiveModeActive;
   },
 
-  _splitConsoleOnKeypress: function(e) {
+  _onDocKeypress: function(e) {
     let responsiveModeActive = this._isResponsiveModeActive();
-    if (e.keyCode === e.DOM_VK_ESCAPE && !responsiveModeActive) {
+    if (e.keyCode === e.DOM_VK_ESCAPE && this.findPane.finding) {
+      this.endFindAll();
+    } else if (e.keyCode === e.DOM_VK_ESCAPE && !responsiveModeActive) {
       this.toggleSplitConsole();
     }
   },
 
   _addReloadKeys: function() {
     [
       ["toolbox-reload-key", false],
       ["toolbox-reload-key2", false],
@@ -313,17 +317,17 @@ Toolbox.prototype = {
   _addToolSwitchingKeys: function() {
     let nextKey = this.doc.getElementById("toolbox-next-tool-key");
     nextKey.addEventListener("command", this.selectNextTool.bind(this), true);
     let prevKey = this.doc.getElementById("toolbox-previous-tool-key");
     prevKey.addEventListener("command", this.selectPreviousTool.bind(this), true);
 
     // Split console uses keypress instead of command so the event can be
     // cancelled with stopPropagation on the keypress, and not preventDefault.
-    this.doc.addEventListener("keypress", this._splitConsoleOnKeypress, false);
+    this.doc.addEventListener("keypress", this._onDocKeypress, false);
   },
 
   /**
    * Make sure that the console is showing up properly based on all the
    * possible conditions.
    *   1) If the console tab is selected, then regardless of split state
    *      it should take up the full height of the deck, and we should
    *      hide the deck and splitter.
@@ -1221,17 +1225,17 @@ Toolbox.prototype = {
 
   /**
    * Destroy the current host, and remove event listeners from its frame.
    *
    * @return {promise} to be resolved when the host is destroyed.
    */
   destroyHost: function() {
     this.doc.removeEventListener("keypress",
-      this._splitConsoleOnKeypress, false);
+      this._onDocKeypress, false);
     return this._host.destroy();
   },
 
   /**
    * Remove all UI elements, detach from target and clear up
    */
   destroy: function() {
     // If several things call destroy then we give them all the same
@@ -1242,16 +1246,18 @@ Toolbox.prototype = {
 
     this._target.off("navigate", this._refreshHostTitle);
     this.off("select", this._refreshHostTitle);
     this.off("host-changed", this._refreshHostTitle);
 
     gDevTools.off("tool-registered", this._toolRegistered);
     gDevTools.off("tool-unregistered", this._toolUnregistered);
 
+    this.findPane.destroy();
+
     let outstanding = [];
     for (let [id, panel] of this._toolPanels) {
       try {
         outstanding.push(panel.destroy());
       } catch (e) {
         // We don't want to stop here if any panel fail to close.
         console.error("Panel " + id + ":", e);
       }
diff --git a/browser/devtools/framework/toolbox.xul b/browser/devtools/framework/toolbox.xul
--- a/browser/devtools/framework/toolbox.xul
+++ b/browser/devtools/framework/toolbox.xul
@@ -58,16 +58,20 @@
     <key id="toolbox-reload-key2"
          keycode="VK_F5"
          oncommand="void(0);"
          modifiers=""/>
     <key id="toolbox-force-reload-key2"
          keycode="VK_F5"
          oncommand="void(0);"
          modifiers="accel"/>
+    <key id="toolbox-find-all-key"
+         key="&toolboxFindAll.key;"
+         oncommand="void(0);"
+         modifiers="accel alt"/>
   </keyset>
 
   <notificationbox id="toolbox-notificationbox" flex="1">
     <toolbar class="devtools-tabbar">
       <hbox id="toolbox-picker-container" />
       <hbox id="toolbox-tabs" flex="1" />
       <hbox id="toolbox-buttons" pack="end"/>
       <vbox id="toolbox-controls-separator" class="devtools-separator"/>
@@ -78,11 +82,37 @@
                        class="devtools-closebutton"
                        tooltiptext="&toolboxCloseButton.tooltip;"/>
       </hbox>
     </toolbar>
     <vbox flex="1">
       <deck id="toolbox-deck" flex="1" minheight="75" />
       <splitter id="toolbox-console-splitter" class="devtools-horizontal-splitter" hidden="true" />
       <box minheight="75" flex="1" id="toolbox-panel-webconsole" collapsed="true" />
+      <splitter id="toolbox-find-splitter" class="devtools-horizontal-splitter" hidden="true" />
+      <vbox id="toolbox-find"
+            collapsed="true"
+            flex="1"
+            class="theme-body"
+            style="overflow: auto; min-height: 20px;">
+        <scrollbox id="find-results"
+                   orient="vertical">
+        </scrollbox>
+      </vbox>
+      <toolbar id="toolbox-find-box-container"
+               collapsed="true"
+               class="devtools-toolbar"
+               style="max-height: 24px; min-height: 24px;">
+        <textbox id="find-box"
+                 class="devtools-searchinput" type="search"/>
+        <toolbarbutton id="find-go"
+                       label="Search"
+                       class="devtools-toolbarbutton" />
+        <hbox id="selected-find-tools">
+
+        </hbox>
+        <spacer flex="1" />
+        <toolbarbutton id="find-close"
+                       class="devtools-closebutton" />
+       </toolbar>
     </vbox>
   </notificationbox>
 </window>
diff --git a/browser/devtools/jar.mn b/browser/devtools/jar.mn
--- a/browser/devtools/jar.mn
+++ b/browser/devtools/jar.mn
@@ -95,16 +95,17 @@ browser.jar:
     content/browser/devtools/responsivedesign/resize-commands.js       (responsivedesign/resize-commands.js)
     content/browser/devtools/commandline.css                           (commandline/commandline.css)
     content/browser/devtools/commandlineoutput.xhtml                   (commandline/commandlineoutput.xhtml)
     content/browser/devtools/commandlinetooltip.xhtml                  (commandline/commandlinetooltip.xhtml)
     content/browser/devtools/commandline/commands-index.js             (commandline/commands-index.js)
     content/browser/devtools/framework/toolbox-window.xul              (framework/toolbox-window.xul)
     content/browser/devtools/framework/toolbox-options.xul             (framework/toolbox-options.xul)
     content/browser/devtools/framework/toolbox-options.js              (framework/toolbox-options.js)
+    content/browser/devtools/framework/toolbox-find.js                 (framework/toolbox-find.js)
     content/browser/devtools/framework/toolbox.xul                     (framework/toolbox.xul)
     content/browser/devtools/framework/options-panel.css               (framework/options-panel.css)
     content/browser/devtools/framework/toolbox-process-window.xul      (framework/toolbox-process-window.xul)
     content/browser/devtools/framework/toolbox-process-window.js       (framework/toolbox-process-window.js)
     content/browser/devtools/inspector/inspector.xul                   (inspector/inspector.xul)
     content/browser/devtools/inspector/inspector.css                   (inspector/inspector.css)
     content/browser/devtools/connect.xhtml                             (framework/connect/connect.xhtml)
     content/browser/devtools/connect.css                               (framework/connect/connect.css)
diff --git a/browser/devtools/main.js b/browser/devtools/main.js
--- a/browser/devtools/main.js
+++ b/browser/devtools/main.js
@@ -120,16 +120,31 @@ Tools.inspector = {
   ordinal: 1,
   modifiers: osString == "Darwin" ? "accel,alt" : "accel,shift",
   icon: "chrome://browser/skin/devtools/tool-inspector.svg",
   invertIconForLightTheme: true,
   url: "chrome://browser/content/devtools/inspector/inspector.xul",
   label: l10n("inspector.label", inspectorStrings),
   tooltip: l10n("inspector.tooltip", inspectorStrings),
   inMenu: true,
+  searchable: true,
+  onsearch: function(value, panel, toolbox) {
+    let def = promise.defer();
+    let result = { // new SearchResult();
+      label: "body",
+      render: function() {
+        let b = toolbox.doc.createElement("box");
+        b.textContent = this.label;
+        return b
+      }
+    }
+
+    def.resolve([result]);
+    return def.promise;
+  },
   commands: [
     "devtools/resize-commands",
     "devtools/inspector/inspector-commands",
     "devtools/eyedropper/commands.js"
   ],
 
   preventClosingOnKey: true,
   onkey: function(panel) {
@@ -155,16 +170,39 @@ Tools.jsdebugger = {
   icon: "chrome://browser/skin/devtools/tool-debugger.svg",
   invertIconForLightTheme: true,
   highlightedicon: "chrome://browser/skin/devtools/tool-debugger-paused.svg",
   url: "chrome://browser/content/devtools/debugger.xul",
   label: l10n("ToolboxDebugger.label", debuggerStrings),
   tooltip: l10n("ToolboxDebugger.tooltip", debuggerStrings),
   inMenu: true,
   commands: "devtools/debugger/debugger-commands",
+  searchable: true,
+  onsearch: function(value, panel, toolbox) {
+    let def = promise.defer();
+console.log("LISTENING FOR RESULTS");
+    panel.panelWin.on(panel.panelWin.EVENTS.GLOBAL_SEARCH_MATCH_FOUND, function(e, globalResults) {
+      let containers = [];
+      console.log("MATCHES FOUND", globalResults._store);
+      for (let lineResults of globalResults._store) {
+        let container = toolbox.doc.createElement("box");
+        lineResults.createView(container, {});
+        containers.push(container);
+      }
+      def.resolve(containers);
+    });
+
+    panel.panelWin.on(panel.panelWin.EVENTS.GLOBAL_SEARCH_MATCH_NOT_FOUND, () => {
+      console.log("NO MATCH FOUND");
+      def.resolve();
+    });
+
+    panel.panelWin.DebuggerView.GlobalSearch.scheduleSearch(value);
+    return def.promise;
+  },
 
   isTargetSupported: function(target) {
     return true;
   },
 
   build: function(iframeWindow, toolbox) {
     let panel = new DebuggerPanel(iframeWindow, toolbox);
     return panel.open();
diff --git a/browser/locales/en-US/chrome/browser/devtools/toolbox.dtd b/browser/locales/en-US/chrome/browser/devtools/toolbox.dtd
--- a/browser/locales/en-US/chrome/browser/devtools/toolbox.dtd
+++ b/browser/locales/en-US/chrome/browser/devtools/toolbox.dtd
@@ -13,16 +13,17 @@
 <!ENTITY toolboxPreviousTool.key       "[">
 
 <!ENTITY toolboxZoomIn.key             "+">
 <!ENTITY toolboxZoomIn.key2            "="> <!-- + is above this key on many keyboards -->
 <!ENTITY toolboxZoomOut.key            "-">
 <!ENTITY toolboxZoomReset.key          "0">
 
 <!ENTITY toolboxReload.key             "r">
+<!ENTITY toolboxFindAll.key            "f">
 
 <!-- LOCALIZATION NOTE (options.context.advancedSettings): This is the label for
   -  the heading of the advanced settings group in the options panel. -->
 <!ENTITY options.context.advancedSettings "Advanced settings">
 
 <!-- LOCALIZATION NOTE (options.context.inspector): This is the label for
   -  the heading of the Inspector group in the options panel. -->
 <!ENTITY options.context.inspector "Inspector">
diff --git a/browser/themes/shared/devtools/toolbars.inc.css b/browser/themes/shared/devtools/toolbars.inc.css
--- a/browser/themes/shared/devtools/toolbars.inc.css
+++ b/browser/themes/shared/devtools/toolbars.inc.css
@@ -33,16 +33,20 @@
   margin: 0;
   padding: 0;
 }
 .devtools-toolbar checkbox .checkbox-label-box .checkbox-label {
   margin: 0 6px !important; /* overrides .checkbox-label from checkbox.css */
   padding: 0;
 }
 
+#toolbox-find-box-container {
+  border-bottom-width: 0;
+}
+
 /* Toolbar buttons */
 .devtools-menulist,
 .devtools-toolbarbutton {
   -moz-appearance: none;
   -moz-box-align: center;
   background: transparent;
   min-width: 78px;
   min-height: 18px;
