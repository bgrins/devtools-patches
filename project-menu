# HG changeset patch
# Parent f0b6c8f60ecbf5138ace254c28d76b7a4e4d3a54
# User Brian Grinstead <bgrinstead@mozilla.com>
Bug 1021827 - Show menu items for project editor inside of App Manager;r=paul

diff --git a/browser/devtools/projecteditor/lib/plugins/new/new.js b/browser/devtools/projecteditor/lib/plugins/new/new.js
--- a/browser/devtools/projecteditor/lib/plugins/new/new.js
+++ b/browser/devtools/projecteditor/lib/plugins/new/new.js
@@ -7,19 +7,19 @@
 const { Class } = require("sdk/core/heritage");
 const { registerPlugin, Plugin } = require("projecteditor/plugins/core");
 const { getLocalizedString } = require("projecteditor/helpers/l10n");
 
 // Handles the new command.
 var NewFile = Class({
   extends: Plugin,
 
-  init: function(host) {
+  init: function() {
     this.host.createMenuItem({
-      parent: "#file-menu-popup",
+      parent: this.host.fileMenuPopup,
       label: getLocalizedString("projecteditor.newLabel"),
       command: "cmd-new",
       key: "key-new"
     });
     this.host.createMenuItem({
       parent: "#directory-menu-popup",
       label: getLocalizedString("projecteditor.newLabel"),
       command: "cmd-new"
diff --git a/browser/devtools/projecteditor/lib/projecteditor.js b/browser/devtools/projecteditor/lib/projecteditor.js
--- a/browser/devtools/projecteditor/lib/projecteditor.js
+++ b/browser/devtools/projecteditor/lib/projecteditor.js
@@ -71,24 +71,27 @@ var ProjectEditor = Class({
 
   /**
    * Initialize ProjectEditor, and load into an iframe if specified.
    *
    * @param Iframe iframe
    *        The iframe to inject the DOM into.  If this is not
    *        specified, then this.load(frame) will need to be called
    *        before accessing ProjectEditor.
+   * @param Object options
+   *         - menubar: a <menubar> element to inject menus into
    */
-  initialize: function(iframe) {
+  initialize: function(iframe, options = {}) {
     this._onTreeSelected = this._onTreeSelected.bind(this);
     this._onTreeResourceRemoved = this._onTreeResourceRemoved.bind(this);
     this._onEditorCreated = this._onEditorCreated.bind(this);
     this._onEditorActivated = this._onEditorActivated.bind(this);
     this._onEditorDeactivated = this._onEditorDeactivated.bind(this);
     this._updateEditorMenuItems = this._updateEditorMenuItems.bind(this);
+    this.menubar = options.menubar || null;
 
     if (iframe) {
       this.load(iframe);
     }
   },
 
   /**
    * Load the instance inside of a specified iframe.
@@ -138,32 +141,63 @@ var ProjectEditor = Class({
     this.shells = new ShellDeck(this, this.document);
     this.shells.on("editor-created", this._onEditorCreated);
     this.shells.on("editor-activated", this._onEditorActivated);
     this.shells.on("editor-deactivated", this._onEditorDeactivated);
 
     let shellContainer = this.document.querySelector("#shells-deck-container");
     shellContainer.appendChild(this.shells.elt);
 
-    let popup = this.document.querySelector("#edit-menu-popup");
-    popup.addEventListener("popupshowing", this.updateEditorMenuItems);
-
     // We are not allowing preset projects for now - rebuild a fresh one
     // each time.
     this.setProject(new Project({
       id: "",
       name: "",
       directories: [],
       openFiles: []
     }));
 
+    this._buildMenubar();
     this._initCommands();
     this._initPlugins();
   },
 
+  _buildMenubar: function() {
+
+    this.projectEditorCommandset = this.document.getElementById("projecteditor-commandset");
+    this.projectEditorKeyset = this.document.getElementById("projecteditor-keyset");
+
+    this.editorCommandset = this.document.getElementById("editMenuCommands");
+    this.editorKeyset = this.document.getElementById("editMenuKeys");
+
+    this.editMenu = this.document.getElementById("edit-menu");
+    this.fileMenu = this.document.getElementById("file-menu");
+
+    this.editMenuPopup = this.document.getElementById("edit-menu-popup");
+    this.fileMenuPopup = this.document.getElementById("file-menu-popup");
+
+    this.editMenu.addEventListener("popupshowing", this._updateEditorMenuItems);
+
+    if (this.menubar) {
+      this.menubar.ownerDocument.querySelector("window").appendChild(
+         this.projectEditorCommandset
+      );
+      this.menubar.ownerDocument.querySelector("window").appendChild(
+         this.projectEditorKeyset
+      );
+      this.menubar.ownerDocument.querySelector("window").appendChild(
+         this.editorCommandset
+      );
+      this.menubar.ownerDocument.querySelector("window").appendChild(
+         this.editorKeyset
+      );
+      this.menubar.appendChild(this.fileMenu);
+      this.menubar.appendChild(this.editMenu);
+    }
+  },
 
   /**
    * Create the project tree sidebar that lists files.
    */
   _buildSidebar: function() {
     this.projectTree = new ProjectTreeView(this.document, {
       resourceVisible: this.resourceVisible.bind(this),
       resourceFormatter: this.resourceFormatter.bind(this)
@@ -174,18 +208,17 @@ var ProjectEditor = Class({
     let sourcesBox = this.document.querySelector("#sources");
     sourcesBox.appendChild(this.projectTree.elt);
   },
 
   /**
    * Set up listeners for commands to dispatch to all of the plugins
    */
   _initCommands: function() {
-    this.commands = this.document.querySelector("#projecteditor-commandset");
-    this.commands.addEventListener("command", (evt) => {
+    this.projectEditorCommandset.addEventListener("command", (evt) => {
       evt.stopPropagation();
       evt.preventDefault();
       this.pluginDispatch("onCommand", evt.target.id, evt.target);
     });
   },
 
   /**
    * Initialize each plugin in registeredPlugins
@@ -203,34 +236,36 @@ var ProjectEditor = Class({
 
     this.pluginDispatch("lateInit");
   },
 
   /**
    * Enable / disable necessary menu items using globalOverlay.js.
    */
   _updateEditorMenuItems: function() {
-    this.window.goUpdateGlobalEditMenuItems();
-    this.window.goUpdateGlobalEditMenuItems();
+    let window = this.editMenu.ownerDocument.defaultView;
+    window.goUpdateGlobalEditMenuItems();
     let commands = ['cmd_undo', 'cmd_redo', 'cmd_delete', 'cmd_findAgain'];
     commands.forEach(this.window.goUpdateCommand);
   },
 
   /**
    * Destroy all objects on the iframe unload event.
    */
   destroy: function() {
     this._plugins.forEach(plugin => { plugin.destroy(); });
 
     forget(this, this.projectTree);
     this.projectTree.destroy();
     this.projectTree = null;
 
     this.shells.destroy();
 
+    this.editMenu.removeEventListener("popupshowing", this._updateEditorMenuItems);
+
     forget(this, this.project);
     this.project.destroy();
     this.project = null;
   },
 
   /**
    * Set the current project viewed by the projecteditor.
    *
@@ -394,20 +429,20 @@ var ProjectEditor = Class({
       let keyName = definition.key;
       if (keyName.startsWith("VK_")) {
         key.setAttribute("keycode", keyName);
       } else {
         key.setAttribute("key", keyName);
       }
       key.setAttribute("modifiers", definition.modifiers);
       key.setAttribute("command", definition.id);
-      this.document.getElementById("projecteditor-keyset").appendChild(key);
+      this.projectEditorCommandset.appendChild(key);
     }
     command.setAttribute("oncommand", "void(0);"); // needed. See bug 371900
-    this.document.getElementById("projecteditor-commandset").appendChild(command);
+    this.projectEditorCommandset.appendChild(command);
     return command;
   },
 
   /**
    * Get the instance of a plugin registered with a certain type.
    *
    * @param Type pluginType
    *             The type, such as SavePlugin
diff --git a/browser/devtools/webide/content/webide.js b/browser/devtools/webide/content/webide.js
--- a/browser/devtools/webide/content/webide.js
+++ b/browser/devtools/webide/content/webide.js
@@ -279,17 +279,19 @@ let UI = {
   // ProjectEditor & details screen
 
   getProjectEditor: function() {
     if (this.projecteditor) {
       return this.projecteditor.loaded;
     }
 
     let projecteditorIframe = document.querySelector("#projecteditor");
-    this.projecteditor = ProjectEditor.ProjectEditor(projecteditorIframe);
+    this.projecteditor = ProjectEditor.ProjectEditor(projecteditorIframe, {
+      menubar: document.querySelector("#main-menubar")
+    });
     this.projecteditor.on("onEditorSave", (editor, resource) => {
       AppManager.validateProject(AppManager.selectedProject);
     });
     return this.projecteditor.loaded;
   },
 
   updateProjectEditorHeader: function() {
     let project = AppManager.selectedProject;
diff --git a/browser/devtools/webide/content/webide.xul b/browser/devtools/webide/content/webide.xul
--- a/browser/devtools/webide/content/webide.xul
+++ b/browser/devtools/webide/content/webide.xul
@@ -4,30 +4,33 @@
    - License, v. 2.0. If a copy of the MPL was not distributed with this
    - file, You can obtain one at http://mozilla.org/MPL/2.0/. -->
 
 <!DOCTYPE window [
   <!ENTITY % webideDTD SYSTEM "chrome://webide/content/webide.dtd" >
   %webideDTD;
 ]>
 
+<?xul-overlay href="chrome://global/content/editMenuOverlay.xul"?>
+
 <?xml-stylesheet href="chrome://global/skin/global.css"?>
 <?xml-stylesheet href="chrome://webide/skin/webide.css"?>
 
 <window id="webide"
         xmlns="http://www.mozilla.org/keymaster/gatekeeper/there.is.only.xul"
         xmlns:html="http://www.w3.org/1999/xhtml"
         title="&windowTitle;"
         windowtype="devtools:webide"
         macanimationtype="document"
         fullscreenbutton="true"
         screenX="4" screenY="4"
         width="640" height="480"
         persist="screenX screenY width height">
 
+  <script type="application/javascript" src="chrome://global/content/globalOverlay.js"></script>
   <script type="application/javascript" src="webide.js"></script>
   <script type="application/javascript" src="cli.js"></script>
 
   <commandset id="mainCommandSet">
     <commandset id="editMenuCommands"/>
     <commandset id="webideCommands">
       <command id="cmd_quit" oncommand="Cmds.quit()"/>
       <command id="cmd_newApp" oncommand="Cmds.newApp()" label="&projectMenu_newApp_label;"/>
diff --git a/browser/themes/shared/devtools/projecteditor/projecteditor.css b/browser/themes/shared/devtools/projecteditor/projecteditor.css
--- a/browser/themes/shared/devtools/projecteditor/projecteditor.css
+++ b/browser/themes/shared/devtools/projecteditor/projecteditor.css
@@ -23,17 +23,17 @@
 
 .arrow[invisible] {
   visibility: hidden;
 }
 
 #projecteditor-menubar {
   /* XXX: Hide menu bar until we have option to add menu items
      to an existing one. */
-  display: none;
+  /*display: none;*/
 }
 
 #projecteditor-toolbar,
 #projecteditor-toolbar-bottom {
   display: none; /* For now don't show the status bars */
   min-height: 22px;
   height: 22px;
   background: rgb(237, 237, 237);
