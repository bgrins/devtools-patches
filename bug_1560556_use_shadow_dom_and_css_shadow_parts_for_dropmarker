# HG changeset patch
# User Brian Grinstead <bgrinstead@mozilla.com>
# Date 1561139365 25200
#      Fri Jun 21 10:49:25 2019 -0700
# Node ID a0d034ac839cc634588d69207ac023fca6d04b74
# Parent  516ca8e19a81cc9247188952f46b9dda59bb61a8
Bug 1560556 - Use Shadow DOM and CSS Shadow parts for <dropmarker>

Differential Revision: https://phabricator.services.mozilla.com/D35551

diff --git a/browser/base/content/urlbarBindings.xml b/browser/base/content/urlbarBindings.xml
--- a/browser/base/content/urlbarBindings.xml
+++ b/browser/base/content/urlbarBindings.xml
@@ -1747,17 +1747,17 @@ file, You can obtain one at http://mozil
           this._pressedNoActionKeys.delete(event.keyCode);
           if (this._pressedNoActionKeys.size == 0)
             this._clearNoActions();
         }
       ]]></handler>
 
       <handler event="mousedown"><![CDATA[
         if (event.button == 0) {
-          if (event.originalTarget.getAttribute("anonid") == "historydropmarker") {
+          if (event.target.getAttribute("anonid") == "historydropmarker") {
             this.toggleHistoryPopup();
           }
 
           // Eventually show the opt-out notification even if the location bar is
           // empty, focused, and the user clicks on it.
           if (this.focused && this.textValue == "") {
             this.maybeShowSearchSuggestionsNotificationOnFocus(true);
           }
diff --git a/browser/components/urlbar/UrlbarInput.jsm b/browser/components/urlbar/UrlbarInput.jsm
--- a/browser/components/urlbar/UrlbarInput.jsm
+++ b/browser/components/urlbar/UrlbarInput.jsm
@@ -1325,17 +1325,17 @@ class UrlbarInput {
         this.editor.selectAll();
         event.preventDefault();
       } else if (this.openViewOnFocus && !this.view.isOpen) {
         this.startQuery();
       }
       return;
     }
 
-    if (event.originalTarget.classList.contains("urlbar-history-dropmarker")) {
+    if (event.target.classList.contains("urlbar-history-dropmarker")) {
       if (this.view.isOpen) {
         this.view.close();
       } else {
         this.startQuery();
       }
     }
   }
 
diff --git a/browser/themes/windows/browser.css b/browser/themes/windows/browser.css
--- a/browser/themes/windows/browser.css
+++ b/browser/themes/windows/browser.css
@@ -821,17 +821,17 @@ notification[value="translation"] {
   notification[value="translation"] button[anonid="translate"]:active {
     background-color: #008ACB;
   }
 
   notification[value="translation"] button[type="menu"] > .button-box > .button-menu-dropmarker,
   notification[value="translation"] menulist > .menulist-dropmarker {
     list-style-image: url(chrome://global/skin/icons/arrow-dropdown-16.svg);
   }
-  notification[value="translation"] menulist > .menulist-dropmarker > .dropmarker-icon {
+  notification[value="translation"] menulist > .menulist-dropmarker::part(icon) {
     width: 11px;
     height: 11px;
   }
 
   notification[value="translation"] button > .button-box,
   notification[value="translation"] button[type="menu"] > .button-box > .button-menu-dropmarker {
     padding: 0;
     margin-inline-start: 3ch;
diff --git a/toolkit/content/widgets/general.js b/toolkit/content/widgets/general.js
--- a/toolkit/content/widgets/general.js
+++ b/toolkit/content/widgets/general.js
@@ -32,23 +32,22 @@ class MozDeck extends MozXULElement {
   get selectedPanel() {
     return this.children[this.selectedIndex];
   }
 }
 
 customElements.define("deck", MozDeck);
 
 class MozDropmarker extends MozXULElement {
-  connectedCallback() {
-    // Only create the image the first time we are connected
-    if (!this.firstElementChild) {
-      let image = document.createXULElement("image");
-      image.classList.add("dropmarker-icon");
-      this.appendChild(image);
-    }
+  constructor() {
+    super();
+    let shadowRoot = this.attachShadow({mode: "open"});
+    let image = document.createXULElement("image");
+    image.setAttribute("part", "icon");
+    shadowRoot.appendChild(image);
   }
 }
 
 customElements.define("dropmarker", MozDropmarker);
 
 class MozCommandSet extends MozXULElement {
   connectedCallback() {
     if (this.getAttribute("commandupdater") === "true") {
diff --git a/toolkit/content/xul.css b/toolkit/content/xul.css
--- a/toolkit/content/xul.css
+++ b/toolkit/content/xul.css
@@ -526,20 +526,16 @@ menulist > menupopup > .popup-internal-b
 menulist > menupopup > .popup-internal-box > .scrollbutton-down {
   display: none;
 }
 
 menulist > menupopup > .popup-internal-box > .arrowscrollbox-scrollbox {
   overflow: auto;
 }
 
-dropmarker > .dropmarker-icon {
-  pointer-events: none;
-}
-
 /********** splitter **********/
 
 .tree-splitter {
   width: 0px;
   max-width: 0px;
   min-width: 0% ! important;
   min-height: 0% ! important;
   -moz-box-ordinal-group: 2147483646;
diff --git a/toolkit/themes/shared/in-content/common.inc.css b/toolkit/themes/shared/in-content/common.inc.css
--- a/toolkit/themes/shared/in-content/common.inc.css
+++ b/toolkit/themes/shared/in-content/common.inc.css
@@ -374,17 +374,17 @@ xul|*.menulist-dropmarker {
   padding: 0;
   border: none;
   background-color: transparent;
   list-style-image: url("chrome://global/skin/icons/arrow-dropdown-12.svg");
   -moz-context-properties: fill;
   fill: currentColor;
 }
 
-xul|*.menulist-dropmarker > xul|*.dropmarker-icon {
+xul|*.menulist-dropmarker::part(icon) {
   width: 12px;
   height: 12px;
 }
 
 xul|menulist > xul|menupopup {
   -moz-appearance: none;
   border: 1px solid var(--in-content-box-border-color);
   border-radius: 2px;
diff --git a/toolkit/themes/shared/popupnotification.inc.css b/toolkit/themes/shared/popupnotification.inc.css
--- a/toolkit/themes/shared/popupnotification.inc.css
+++ b/toolkit/themes/shared/popupnotification.inc.css
@@ -80,17 +80,17 @@
 .popup-notification-dropmarker > .button-box > .button-menu-dropmarker {
   /* This is to override the linux !important */
   -moz-appearance: none !important;
   display: -moz-box;
   padding: 0;
   margin: 0;
 }
 
-.popup-notification-dropmarker > .button-box > .button-menu-dropmarker > .dropmarker-icon {
+.popup-notification-dropmarker > .button-box > .button-menu-dropmarker::part(icon) {
   width: 16px;
   height: 16px;
   list-style-image: url(chrome://global/skin/icons/arrow-dropdown-16.svg);
   -moz-context-properties: fill;
   fill: currentColor;
 }
 
 .popup-notification-warning {
