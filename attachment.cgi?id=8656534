# HG changeset patch
# User Lin Clark <lin.w.clark@gmail.com>
Bug 1154363 - Assign the selected node from the inspector to a temp variable for use in the console. r=bgrins


diff --git a/browser/devtools/inspector/inspector-panel.js b/browser/devtools/inspector/inspector-panel.js
index 322c5eb..d2ed9dc 100644
--- a/browser/devtools/inspector/inspector-panel.js
+++ b/browser/devtools/inspector/inspector-panel.js
@@ -972,16 +972,46 @@ InspectorPanel.prototype = {
       let jsterm = panel.hud.jsterm;
 
       jsterm.execute("inspect($0)");
       jsterm.inputNode.focus();
     });
   },
 
   /**
+   * Use in Console.
+   *
+   * Takes the currently selected node in the inspector and assigns it to a
+   * temp variable on the content window.  Also opens the split console and
+   * autofills it with the temp variable.
+   */
+  useInConsole: function() {
+    this._toolbox.openSplitConsole().then(() => {
+      let panel = this._toolbox.getPanel("webconsole");
+      let jsterm = panel.hud.jsterm;
+
+      let evalString = `let i = 0;
+        while (window.hasOwnProperty("temp" + i) && i < 1000) {
+          i++;
+        }
+        window["temp" + i] = $0;
+        "temp" + i;
+      `;
+
+      let options = {
+        selectedNodeActor: this.selection.nodeFront.actorID,
+      };
+      jsterm.requestEvaluation(evalString, options).then((res) => {
+        jsterm.setInputValue(res.result);
+        this.emit("console-var-ready");
+      });
+    });
+  },
+
+  /**
    * Clear any pseudo-class locks applied to the current hierarchy.
    */
   clearPseudoClasses: function() {
     if (!this.walker) {
       return;
     }
     return this.walker.clearPseudoClassLocks().then(null, console.error);
   },
diff --git a/browser/devtools/inspector/inspector.xul b/browser/devtools/inspector/inspector.xul
index d8715bc..52fe531 100644
--- a/browser/devtools/inspector/inspector.xul
+++ b/browser/devtools/inspector/inspector.xul
@@ -50,16 +50,19 @@
         accesskey="&inspectorCopyUniqueSelector.accesskey;"
         oncommand="inspector.copyUniqueSelector()"/>
       <menuitem id="node-menu-copyimagedatauri"
         label="&inspectorCopyImageDataUri.label;"
         oncommand="inspector.copyImageDataUri()"/>
       <menuitem id="node-menu-showdomproperties"
         label="&inspectorShowDOMProperties.label;"
         oncommand="inspector.showDOMProperties()"/>
+      <menuitem id="node-menu-useinconsole"
+        label="&inspectorUseInConsole.label;"
+        oncommand="inspector.useInConsole()"/>
       <menuitem id="node-menu-expand"
         label="&inspectorExpandNode.label;"
         oncommand="inspector.expandNode()"/>
       <menuitem id="node-menu-collapse"
         label="&inspectorCollapseNode.label;"
         oncommand="inspector.collapseNode()"/>
       <menuseparator/>
       <menuitem id="node-menu-pasteinnerhtml"
diff --git a/browser/devtools/inspector/test/browser.ini b/browser/devtools/inspector/test/browser.ini
index d8a95b7..230263c 100644
--- a/browser/devtools/inspector/test/browser.ini
+++ b/browser/devtools/inspector/test/browser.ini
@@ -77,17 +77,18 @@ skip-if = e10s # GCLI isn't e10s compatible. See bug 1128988.
 [browser_inspector_initialization.js]
 [browser_inspector_inspect-object-element.js]
 [browser_inspector_invalidate.js]
 [browser_inspector_keyboard-shortcuts-copy-outerhtml.js]
 [browser_inspector_keyboard-shortcuts.js]
 [browser_inspector_menu-01-sensitivity.js]
 [browser_inspector_menu-02-copy-items.js]
 [browser_inspector_menu-03-paste-items.js]
-[browser_inspector_menu-04-other.js]
+[browser_inspector_menu-04-use-in-console.js]
+[browser_inspector_menu-05-other.js]
 [browser_inspector_navigation.js]
 [browser_inspector_pane-toggle-01.js]
 [browser_inspector_pane-toggle-02.js]
 [browser_inspector_pane-toggle-03.js]
 [browser_inspector_picker-stop-on-destroy.js]
 [browser_inspector_picker-stop-on-tool-change.js]
 [browser_inspector_pseudoclass-lock.js]
 [browser_inspector_pseudoclass-menu.js]
diff --git a/browser/devtools/inspector/test/browser_inspector_menu-01-sensitivity.js b/browser/devtools/inspector/test/browser_inspector_menu-01-sensitivity.js
index 36ff654..c036cd4 100644
--- a/browser/devtools/inspector/test/browser_inspector_menu-01-sensitivity.js
+++ b/browser/devtools/inspector/test/browser_inspector_menu-01-sensitivity.js
@@ -11,46 +11,50 @@ const PASTE_MENU_ITEMS = [
   "node-menu-pasteinnerhtml",
   "node-menu-pasteouterhtml",
   "node-menu-pastebefore",
   "node-menu-pasteafter",
   "node-menu-pastefirstchild",
   "node-menu-pastelastchild",
 ];
 
+const ACTIVE_ON_DOCTYPE_ITEMS = [
+  "node-menu-showdomproperties",
+  "node-menu-useinconsole"
+];
+
 const ALL_MENU_ITEMS = [
   "node-menu-edithtml",
   "node-menu-copyinner",
   "node-menu-copyouter",
   "node-menu-copyuniqueselector",
   "node-menu-copyimagedatauri",
-  "node-menu-showdomproperties",
   "node-menu-delete",
   "node-menu-pseudo-hover",
   "node-menu-pseudo-active",
   "node-menu-pseudo-focus",
   "node-menu-scrollnodeintoview",
   "node-menu-screenshotnode"
-].concat(PASTE_MENU_ITEMS);
+].concat(PASTE_MENU_ITEMS, ACTIVE_ON_DOCTYPE_ITEMS);
 
-const ITEMS_WITHOUT_SHOWDOMPROPS =
-  ALL_MENU_ITEMS.filter(item => item != "node-menu-showdomproperties");
+const INACTIVE_ON_DOCTYPE_ITEMS =
+  ALL_MENU_ITEMS.filter(item => ACTIVE_ON_DOCTYPE_ITEMS.indexOf(item) === -1);
 
 const TEST_CASES = [
   {
     desc: "doctype node with empty clipboard",
     selector: null,
-    disabled: ITEMS_WITHOUT_SHOWDOMPROPS,
+    disabled: INACTIVE_ON_DOCTYPE_ITEMS,
   },
   {
     desc: "doctype node with html on clipboard",
     clipboardData: "<p>some text</p>",
     clipboardDataType: "html",
     selector: null,
-    disabled: ITEMS_WITHOUT_SHOWDOMPROPS,
+    disabled: INACTIVE_ON_DOCTYPE_ITEMS,
   },
   {
     desc: "element node HTML on the clipboard",
     clipboardData: "<p>some text</p>",
     clipboardDataType: "html",
     disabled: ["node-menu-copyimagedatauri"],
     selector: "#sensitivity",
   },
diff --git a/browser/devtools/inspector/test/browser_inspector_menu-04-use-in-console.js b/browser/devtools/inspector/test/browser_inspector_menu-04-use-in-console.js
new file mode 100644
index 0000000..2991bf7
--- /dev/null
+++ b/browser/devtools/inspector/test/browser_inspector_menu-04-use-in-console.js
@@ -0,0 +1,47 @@
+/* vim: set ts=2 et sw=2 tw=80: */
+/* Any copyright is dedicated to the Public Domain.
+http://creativecommons.org/publicdomain/zero/1.0/ */
+"use strict";
+
+// Tests "Use in Console" menu item
+
+const TEST_URL = TEST_URL_ROOT + "doc_inspector_menu.html";
+
+registerCleanupFunction(() => {
+  Services.prefs.clearUserPref("devtools.toolbox.splitconsoleEnabled");
+});
+
+add_task(function* () {
+  let { inspector, toolbox } = yield openInspectorForURL(TEST_URL);
+
+  yield testUseInConsole();
+
+  function* testUseInConsole() {
+    info("Testing 'Use in Console' menu item.");
+    let useInConsoleNode = inspector.panelDoc.getElementById("node-menu-useinconsole");
+
+    yield selectNode("#console-var", inspector);
+    dispatchCommandEvent(useInConsoleNode);
+    yield inspector.once("console-var-ready");
+
+    let hud = toolbox.getPanel("webconsole").hud;
+    let jsterm = hud.jsterm;
+
+    let jstermInput = jsterm.hud.document.querySelector(".jsterm-input-node");
+    ok(jstermInput.value === "temp0", "first console variable is named temp0");
+
+    let result = yield jsterm.execute();
+    isnot(result.textContent.indexOf('<p id="console-var">'), -1, "variable temp0 references correct node");
+
+    yield selectNode("#console-var-multi", inspector);
+    dispatchCommandEvent(useInConsoleNode);
+    yield inspector.once("console-var-ready");
+
+    ok(jstermInput.value === "temp1", "second console variable is named temp1");
+
+    result = yield jsterm.execute();
+    isnot(result.textContent.indexOf('<p id="console-var-multi">'), -1, "variable temp1 references correct node");
+
+    jsterm.clearHistory();
+  }
+});
diff --git a/browser/devtools/inspector/test/browser_inspector_menu-04-other.js b/browser/devtools/inspector/test/browser_inspector_menu-05-other.js
similarity index 88%
rename from browser/devtools/inspector/test/browser_inspector_menu-04-other.js
rename to browser/devtools/inspector/test/browser_inspector_menu-05-other.js
index 2cae279..056502e 100644
--- a/browser/devtools/inspector/test/browser_inspector_menu-04-other.js
+++ b/browser/devtools/inspector/test/browser_inspector_menu-05-other.js
@@ -66,17 +66,9 @@ add_task(function* () {
     ok((yield testActor.eval("!!content.document.documentElement")),
        "Document element still alive.");
   }
 
   function* testScrollIntoView() {
     // Follow up bug to add this test - https://bugzilla.mozilla.org/show_bug.cgi?id=1154107
     todo(false, "Verify that node is scrolled into the viewport.");
   }
-
-  function dispatchCommandEvent(node) {
-    info("Dispatching command event on " + node);
-    let commandEvent = document.createEvent("XULCommandEvent");
-    commandEvent.initCommandEvent("command", true, true, window, 0, false, false,
-                                  false, false, null);
-    node.dispatchEvent(commandEvent);
-  }
 });
diff --git a/browser/devtools/inspector/test/doc_inspector_menu.html b/browser/devtools/inspector/test/doc_inspector_menu.html
index 03ede6a..da5284c 100644
--- a/browser/devtools/inspector/test/doc_inspector_menu.html
+++ b/browser/devtools/inspector/test/doc_inspector_menu.html
@@ -15,11 +15,13 @@
       </div>
       <p data-id="copy">Paragraph for testing copy</p>
       <p id="sensitivity">Paragraph for sensitivity</p>
       <p id="delete">This has to be deleted</p>
       <img id="copyimage" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAAAAAA6fptVAAAACklEQVQYV2P4DwABAQEAWk1v8QAAAABJRU5ErkJggg==" />
       <div id="hiddenElement" style="display: none;">
         <p id="nestedHiddenElement">Visible element nested inside a non-visible element</p>
       </div>
+      <p id="console-var">Paragraph for testing console variables</p>
+      <p id="console-var-multi">Paragraph for testing multiple console variables</p>
     </div>
   </body>
 </html>
diff --git a/browser/devtools/inspector/test/head.js b/browser/devtools/inspector/test/head.js
index 5462f00..cf68fd4 100644
--- a/browser/devtools/inspector/test/head.js
+++ b/browser/devtools/inspector/test/head.js
@@ -463,8 +463,20 @@ function redoChange(inspector) {
   if (!canRedo) {
     return promise.reject();
   }
 
   let mutated = inspector.once("markupmutation");
   inspector.markup.undo.redo();
   return mutated;
 }
+
+/**
+ * Dispatch a command event on a node (e.g. click on a contextual menu item).
+ * @param {DOMNode} node
+ */
+function dispatchCommandEvent(node) {
+  info("Dispatching command event on " + node);
+  let commandEvent = document.createEvent("XULCommandEvent");
+  commandEvent.initCommandEvent("command", true, true, window, 0, false, false,
+                                false, false, null);
+  node.dispatchEvent(commandEvent);
+}
diff --git a/browser/locales/en-US/chrome/browser/devtools/inspector.dtd b/browser/locales/en-US/chrome/browser/devtools/inspector.dtd
index baf207f..925da81 100644
--- a/browser/locales/en-US/chrome/browser/devtools/inspector.dtd
+++ b/browser/locales/en-US/chrome/browser/devtools/inspector.dtd
@@ -100,16 +100,22 @@
 <!ENTITY inspectorCopyImageDataUri.label       "Copy Image Data-URL">
 
 <!-- LOCALIZATION NOTE (inspectorShowDOMProperties.label): This is the label
      shown in the inspector contextual-menu for the item that lets users see
      the DOM properties of the current node. When triggered, this item
      opens the split Console and displays the properties in its side panel. -->
 <!ENTITY inspectorShowDOMProperties.label       "Show DOM Properties">
 
+<!-- LOCALIZATION NOTE (inspectorUseInConsole.label): This is the label
+     shown in the inspector contextual-menu for the item that outputs a
+     variable for the current node to the console. When triggered,
+     this item opens the split Console. -->
+<!ENTITY inspectorUseInConsole.label       "Use in Console">
+
 <!-- LOCALIZATION NOTE (inspectorExpandNode.label): This is the label
      shown in the inspector contextual-menu for recursively expanding
      mark-up elements -->
 <!ENTITY inspectorExpandNode.label       "Expand All">
 
 <!-- LOCALIZATION NOTE (inspectorCollapseNode.label): This is the label
      shown in the inspector contextual-menu for recursively collapsing
      mark-up elements -->
