# HG changeset patch
# User Brian Grinstead <bgrinstead@mozilla.com>
# Parent  4be76ebe370f3c4a2eb5d460d1f270daea5e872f
Bug 1143224 - Optimize netmonitor zebra striping for common case of request being appended to the end of the list;r=jsantell

diff --git a/browser/devtools/netmonitor/netmonitor-view.js b/browser/devtools/netmonitor/netmonitor-view.js
--- a/browser/devtools/netmonitor/netmonitor-view.js
+++ b/browser/devtools/netmonitor/netmonitor-view.js
@@ -536,17 +536,17 @@ RequestsMenuView.prototype = Heritage.ex
         useCapture: true
       }]
     });
 
     $("#details-pane-toggle").disabled = false;
     $("#requests-menu-empty-notice").hidden = true;
 
     this.refreshSummary();
-    this.refreshZebra();
+    this.refreshZebra(true);
     this.refreshTooltip(requestItem);
 
     if (aId == this._preferredItemId) {
       this.selectedItem = requestItem;
     }
   },
 
   /**
@@ -659,16 +659,18 @@ RequestsMenuView.prototype = Heritage.ex
 
     // Append a network request item to this container.
     let newItem = this.push([menuView], {
       attachment: Object.create(selected, {
         isCustom: { value: true }
       })
     });
 
+    this.refreshZebra();
+
     // Immediately switch to new request pane.
     this.selectedItem = newItem;
   },
 
   /**
    * Send a new HTTP request using the data in the custom request form.
    */
   sendCustomRequest: function() {
@@ -1114,31 +1116,45 @@ RequestsMenuView.prototype = Heritage.ex
       .replace("#1", visibleRequestsCount)
       .replace("#2", L10N.numberWithDecimals((totalBytes || 0) / 1024, CONTENT_SIZE_DECIMALS))
       .replace("#3", L10N.numberWithDecimals((totalMillis || 0) / 1000, REQUEST_TIME_DECIMALS))
     );
   },
 
   /**
    * Adds odd/even attributes to all the visible items in this container.
+   *
+   * @param boolean lastElementOnly
+   *        Passing true will cause only the last visible element to be striped.
+   *        Use only if you know the element was pushed onto the end.
    */
-  refreshZebra: function() {
+  refreshZebra: function(lastElementOnly) {
     let visibleItems = this.visibleItems;
 
-    for (let i = 0, len = visibleItems.length; i < len; i++) {
+    // lastElementOnly is an optimization used when only pushing an element
+    // onto the end of the list.  In this case we only want to stripe the
+    // most recent item.  Don't try it if there is a sort applied.
+    lastElementOnly = lastElementOnly &&
+                      document.querySelectorAll(".requests-menu-header-button[sorted]").length == 0;
+
+    for (let i = visibleItems.length - 1; i >= 0; i--) {
       let requestItem = visibleItems[i];
       let requestTarget = requestItem.target;
 
       if (i % 2 == 0) {
         requestTarget.setAttribute("even", "");
         requestTarget.removeAttribute("odd");
       } else {
         requestTarget.setAttribute("odd", "");
         requestTarget.removeAttribute("even");
       }
+
+      if (lastElementOnly) {
+        break;
+      }
     }
   },
 
   /**
    * Refreshes the toggling anchor for the specified item's tooltip.
    *
    * @param object aItem
    *        The network request item in this container.
