# HG changeset patch
# Parent be7b6ad80a2a220ad8e4ef003304ff6f71979080
# User Brian Grinstead <bgrinstead@mozilla.com>
Bug 974550 - Add a preference to optionally persist split console state;r=msucan,jwalker

diff --git a/browser/app/profile/firefox.js b/browser/app/profile/firefox.js
--- a/browser/app/profile/firefox.js
+++ b/browser/app/profile/firefox.js
@@ -1286,16 +1286,17 @@ pref("devtools.webide.enabled", false);
 // Toolbox preferences
 pref("devtools.toolbox.footer.height", 250);
 pref("devtools.toolbox.sidebar.width", 500);
 pref("devtools.toolbox.host", "bottom");
 pref("devtools.toolbox.selectedTool", "webconsole");
 pref("devtools.toolbox.toolbarSpec", '["splitconsole", "paintflashing toggle","tilt toggle","scratchpad","resize toggle","eyedropper","screenshot --fullpage"]');
 pref("devtools.toolbox.sideEnabled", true);
 pref("devtools.toolbox.zoomValue", "1");
+pref("devtools.toolbox.splitconsoleEnabled", false);
 
 // Toolbox Button preferences
 pref("devtools.command-button-pick.enabled", true);
 pref("devtools.command-button-splitconsole.enabled", true);
 pref("devtools.command-button-paintflashing.enabled", false);
 pref("devtools.command-button-tilt.enabled", false);
 pref("devtools.command-button-scratchpad.enabled", false);
 pref("devtools.command-button-responsive.enabled", true);
diff --git a/browser/devtools/debugger/test/browser_dbg_split-console-paused-reload.js b/browser/devtools/debugger/test/browser_dbg_split-console-paused-reload.js
--- a/browser/devtools/debugger/test/browser_dbg_split-console-paused-reload.js
+++ b/browser/devtools/debugger/test/browser_dbg_split-console-paused-reload.js
@@ -28,13 +28,14 @@ function* runTests() {
     frames.selectedItem.target,
     dbgWin);
   info("The breadcrumb received focus.");
 
   // This is the meat of the test.
   let result = toolbox.once("webconsole-ready", () => {
     ok(toolbox.splitConsole, "Split console is shown.");
     is(dbgWin.gThreadClient.state, "paused", "Execution is still paused.");
+    Services.prefs.clearUserPref("devtools.toolbox.splitconsoleEnabled");
   });
   EventUtils.synthesizeKey("VK_ESCAPE", {}, dbgWin);
   yield result;
   yield resumeDebuggerThenCloseAndFinish(panel);
 }
diff --git a/browser/devtools/framework/gDevTools.jsm b/browser/devtools/framework/gDevTools.jsm
--- a/browser/devtools/framework/gDevTools.jsm
+++ b/browser/devtools/framework/gDevTools.jsm
@@ -276,32 +276,22 @@ DevTools.prototype = {
 
       this._toolboxes.set(target, toolbox);
 
       toolbox.once("destroyed", () => {
         this._toolboxes.delete(target);
         this.emit("toolbox-destroyed", target);
       });
 
-      // If we were asked for a specific tool then we need to wait for the
-      // tool to be ready and selected, otherwise we can just wait for the
-      // toolbox open promise.
-      if (toolId != null) {
-        toolbox.once(toolId + "-selected", (event, panel) => {
-          this.emit("toolbox-ready", toolbox);
-          deferred.resolve(toolbox);
-        });
-        toolbox.open();
-      }
-      else {
-        toolbox.open().then(() => {
-          deferred.resolve(toolbox);
-          this.emit("toolbox-ready", toolbox);
-        });
-      }
+      // If toolId was passed in, it will already be selected before the
+      // open promise resolves.
+      toolbox.open().then(() => {
+        deferred.resolve(toolbox);
+        this.emit("toolbox-ready", toolbox);
+      });
     }
 
     return deferred.promise;
   },
 
   /**
    * Return the toolbox for a given target.
    *
diff --git a/browser/devtools/framework/toolbox.js b/browser/devtools/framework/toolbox.js
--- a/browser/devtools/framework/toolbox.js
+++ b/browser/devtools/framework/toolbox.js
@@ -1,16 +1,17 @@
 /* This Source Code Form is subject to the terms of the Mozilla Public
  * License, v. 2.0. If a copy of the MPL was not distributed with this
  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */
 
 "use strict";
 
 const MAX_ORDINAL = 99;
 const ZOOM_PREF = "devtools.toolbox.zoomValue";
+const SPLITCONSOLE_ENABLED_PREF = "devtools.toolbox.splitconsoleEnabled";
 const MIN_ZOOM = 0.5;
 const MAX_ZOOM = 2;
 
 let {Cc, Ci, Cu} = require("chrome");
 let {Promise: promise} = require("resource://gre/modules/Promise.jsm");
 let EventEmitter = require("devtools/toolkit/event-emitter");
 let Telemetry = require("devtools/shared/telemetry");
 let {getHighlighterUtils} = require("devtools/framework/toolbox-highlighter-utils");
@@ -242,28 +243,37 @@ Toolbox.prototype = {
         let closeButton = this.doc.getElementById("toolbox-close");
         closeButton.addEventListener("command", this.destroy, true);
 
         gDevTools.on("pref-changed", this._prefChanged);
 
         this._buildDockButtons();
         this._buildOptions();
         this._buildTabs();
-        let buttonsPromise = this._buildButtons();
         this._applyCacheSettings();
         this._addKeysToWindow();
         this._addReloadKeys();
         this._addToolSwitchingKeys();
         this._addZoomKeys();
         this._loadInitialZoom();
 
+        let splitConsolePromise = promise.resolve();
+        if (Services.prefs.getBoolPref(SPLITCONSOLE_ENABLED_PREF)) {
+          // Force the split console on if pref is true.
+          splitConsolePromise = this.toggleSplitConsole(true);
+        }
+        let buttonsPromise = this._buildButtons();
+
         this._telemetry.toolOpened("toolbox");
 
         this.selectTool(this._defaultToolId).then(panel => {
-          buttonsPromise.then(() => {
+          promise.all([
+            splitConsolePromise,
+            buttonsPromise
+          ]).then(() => {
             this.emit("ready");
             deferred.resolve();
           }, deferred.reject);
         });
       };
 
       // Load the toolbox-level actor fronts and utilities now
       this._target.makeRemote().then(() => {
@@ -957,33 +967,45 @@ Toolbox.prototype = {
     let hud = this.getPanel("webconsole").hud;
     if (hud && hud.jsterm) {
       hud.jsterm.inputNode.focus();
     }
   },
 
   /**
    * Toggles the split state of the webconsole.  If the webconsole panel
-   * is already selected, then this command is ignored.
+   * is already selected and no forceToggle is not set, then this command
+   * is ignored.
+   *
+   * @param {bool} forceToggle
+   *        Should the console be toggled regardless of the selected panel.
+   *
+   * @returns {Promise} a promise that resolves once the tool has been
+   *          loaded and focused.
    */
-  toggleSplitConsole: function() {
+  toggleSplitConsole: function(forceToggle = false) {
     let openedConsolePanel = this.currentToolId === "webconsole";
+    let ret = promise.resolve();
 
     // Don't allow changes when console is open, since it could be confusing
-    if (!openedConsolePanel) {
+    if (!openedConsolePanel || forceToggle) {
       this._splitConsole = !this._splitConsole;
+      Services.prefs.setBoolPref(SPLITCONSOLE_ENABLED_PREF, this._splitConsole);
+
       this._refreshConsoleDisplay();
       this.emit("split-console");
 
       if (this._splitConsole) {
-        this.loadTool("webconsole").then(() => {
+        ret = this.loadTool("webconsole").then(() => {
           this.focusConsoleInput();
         });
       }
     }
+
+    return ret;
   },
 
   /**
    * Tells the target tab to reload.
    */
   reloadTarget: function(force) {
     this.target.activeTab.reload({ force: force });
   },
diff --git a/browser/devtools/responsivedesign/test/browser_responsiveruleview.js b/browser/devtools/responsivedesign/test/browser_responsiveruleview.js
--- a/browser/devtools/responsivedesign/test/browser_responsiveruleview.js
+++ b/browser/devtools/responsivedesign/test/browser_responsiveruleview.js
@@ -97,12 +97,13 @@ function test() {
   }
 
   function finishUp() {
     ok(inspector._toolbox._splitConsole, "Console is split after pressing escape.");
 
     // Menus are correctly updated?
     is(document.getElementById("Tools:ResponsiveUI").getAttribute("checked"), "false", "menu unchecked");
 
+    Services.prefs.clearUserPref("devtools.toolbox.splitconsoleEnabled");
     gBrowser.removeCurrentTab();
     finish();
   }
 }
diff --git a/browser/devtools/webconsole/test/browser.ini b/browser/devtools/webconsole/test/browser.ini
--- a/browser/devtools/webconsole/test/browser.ini
+++ b/browser/devtools/webconsole/test/browser.ini
@@ -276,16 +276,17 @@ skip-if = buildapp == 'mulet'
 [browser_webconsole_notifications.js]
 [browser_webconsole_open-links-without-callback.js]
 [browser_webconsole_output_copy_newlines.js]
 [browser_webconsole_output_order.js]
 [browser_webconsole_property_provider.js]
 [browser_webconsole_scratchpad_panel_link.js]
 [browser_webconsole_split.js]
 [browser_webconsole_split_escape_key.js]
+[browser_webconsole_split_persist.js]
 [browser_webconsole_view_source.js]
 [browser_webconsole_reflow.js]
 [browser_webconsole_log_file_filter.js]
 [browser_webconsole_expandable_timestamps.js]
 [browser_webconsole_autocomplete_in_debugger_stackframe.js]
 [browser_webconsole_autocomplete_popup_close_on_tab_switch.js]
 [browser_webconsole_autocomplete-properties-with-non-alphanumeric-names.js]
 [browser_console_hide_jsterm_when_devtools_chrome_enabled_false.js]
diff --git a/browser/devtools/webconsole/test/browser_webconsole_split_persist.js b/browser/devtools/webconsole/test/browser_webconsole_split_persist.js
new file mode 100644
--- /dev/null
+++ b/browser/devtools/webconsole/test/browser_webconsole_split_persist.js
@@ -0,0 +1,67 @@
+/*
+ * Any copyright is dedicated to the Public Domain.
+ * http://creativecommons.org/publicdomain/zero/1.0/
+ */
+
+function test() {
+  info("Test that the split console state is persisted");
+
+  let toolbox;
+  let TEST_URI = "data:text/html;charset=utf-8,<p>Web Console test for splitting</p>";
+
+  Task.spawn(runner).then(finish);
+
+  function* runner() {
+    info("Opening a tab while there is no user setting on split console pref");
+    let {tab} = yield loadTab(TEST_URI);
+    let target = TargetFactory.forTab(tab);
+    toolbox = yield gDevTools.showToolbox(target, "inspector");
+
+    ok(!toolbox.splitConsole, "Split console is hidden by default.");
+    yield toggleSplitConsoleWithEscape();
+    ok(toolbox.splitConsole, "Split console is now visible.");
+    ok(getPrefValue(), "Pref is true");
+
+    yield toolbox.destroy();
+
+    info("Opening a tab while there is a true user setting on split console pref");
+    let {tab} = yield loadTab(TEST_URI);
+    let target = TargetFactory.forTab(tab);
+    toolbox = yield gDevTools.showToolbox(target, "inspector");
+
+    ok(toolbox.splitConsole, "Split console is visible by default.");
+    yield toggleSplitConsoleWithEscape();
+    ok(!toolbox.splitConsole, "Split console is now hidden.");
+    ok(!getPrefValue(), "Pref is false");
+
+    yield toolbox.destroy();
+
+    info("Opening a tab while there is a false user setting on split console pref");
+    let {tab} = yield loadTab(TEST_URI);
+    let target = TargetFactory.forTab(tab);
+    toolbox = yield gDevTools.showToolbox(target, "inspector");
+
+    ok(!toolbox.splitConsole, "Split console is hidden by default.");
+    ok(!getPrefValue(), "Pref is false");
+
+    yield toolbox.destroy();
+  }
+
+  function getPrefValue() {
+    return Services.prefs.getBoolPref("devtools.toolbox.splitconsoleEnabled");
+  }
+
+  function toggleSplitConsoleWithEscape() {
+    let onceSplitConsole = toolbox.once("split-console");
+    let contentWindow = toolbox.frame.contentWindow;
+    contentWindow.focus();
+    EventUtils.sendKey("ESCAPE", contentWindow);
+    return onceSplitConsole;
+  }
+
+  function finish() {
+    toolbox = TEST_URI = null;
+    Services.prefs.clearUserPref("devtools.toolbox.splitconsoleEnabled");
+    finishTest();
+  }
+}
