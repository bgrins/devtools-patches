# HG changeset patch
# Parent f150e176a823ae8de5340a486e8efc3d57839e4b
# User Patrick Brosset <pbrosset@mozilla.com>
Bug 984880 - Display authored styles in the devtools rule-view; r=bgrins

diff --git a/browser/app/profile/firefox.js b/browser/app/profile/firefox.js
--- a/browser/app/profile/firefox.js
+++ b/browser/app/profile/firefox.js
@@ -1313,16 +1313,18 @@ pref("devtools.inspector.activeSidebar",
 pref("devtools.inspector.markupPreview", false);
 pref("devtools.inspector.remote", false);
 // Expand pseudo-elements by default in the rule-view
 pref("devtools.inspector.show_pseudo_elements", true);
 // The default size for image preview tooltips in the rule-view/computed-view/markup-view
 pref("devtools.inspector.imagePreviewTooltipSize", 300);
 // Enable user agent style inspection in rule-view
 pref("devtools.inspector.showUserAgentStyles", false);
+// Display styles as authored in the inspector's rule view
+pref("devtools.inspector.authoredStyles", false);
 
 // DevTools default color unit
 pref("devtools.defaultColorUnit", "hex");
 
 // Enable the Responsive UI tool
 pref("devtools.responsiveUI.no-reload-notification", false);
 
 // Enable the Debugger
diff --git a/browser/devtools/layoutview/view.js b/browser/devtools/layoutview/view.js
--- a/browser/devtools/layoutview/view.js
+++ b/browser/devtools/layoutview/view.js
@@ -12,17 +12,17 @@ const Cc = Components.classes;
 
 Cu.import("resource://gre/modules/Services.jsm");
 Cu.import("resource://gre/modules/Task.jsm");
 Cu.import("resource://gre/modules/devtools/Loader.jsm");
 Cu.import("resource://gre/modules/devtools/Console.jsm");
 
 const {Promise: promise} = Cu.import("resource://gre/modules/Promise.jsm", {});
 const {InplaceEditor, editableItem} = devtools.require("devtools/shared/inplace-editor");
-const {parseDeclarations} = devtools.require("devtools/styleinspector/css-parsing-utils");
+const {parseDeclarations} = devtools.require("devtools/css-parsing-utils");
 const {ReflowFront} = devtools.require("devtools/server/actors/layout");
 
 const NUMERIC = /^-?[\d\.]+$/;
 const LONG_TEXT_ROTATE_LIMIT = 3;
 
 /**
  * An instance of EditingSession tracks changes that have been made during the
  * modification of box model values. All of these changes can be reverted by
diff --git a/browser/devtools/sourceeditor/css-autocompleter.js b/browser/devtools/sourceeditor/css-autocompleter.js
--- a/browser/devtools/sourceeditor/css-autocompleter.js
+++ b/browser/devtools/sourceeditor/css-autocompleter.js
@@ -1,14 +1,14 @@
 /* This Source Code Form is subject to the terms of the Mozilla Public
  * License, v. 2.0. If a copy of the MPL was not distributed with this
  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */
 
 const { Cc, Ci, Cu } = require('chrome');
-const cssTokenizer  = require("devtools/sourceeditor/css-tokenizer");
+const cssTokenizer  = require("devtools/css-tokenizer");
 const promise = Cu.import("resource://gre/modules/Promise.jsm");
 
 /**
  * Here is what this file (+ ./css-tokenizer.js) do.
  *
  * The main objective here is to provide as much suggestions to the user editing
  * a stylesheet in Style Editor. The possible things that can be suggested are:
  *  - CSS property names
diff --git a/browser/devtools/sourceeditor/moz.build b/browser/devtools/sourceeditor/moz.build
--- a/browser/devtools/sourceeditor/moz.build
+++ b/browser/devtools/sourceeditor/moz.build
@@ -2,14 +2,13 @@
 # vim: set filetype=python:
 # This Source Code Form is subject to the terms of the Mozilla Public
 # License, v. 2.0. If a copy of the MPL was not distributed with this
 # file, You can obtain one at http://mozilla.org/MPL/2.0/.
 
 EXTRA_JS_MODULES.devtools.sourceeditor += [
     'autocomplete.js',
     'css-autocompleter.js',
-    'css-tokenizer.js',
     'debugger.js',
     'editor.js'
 ]
 
 BROWSER_CHROME_MANIFESTS += ['test/browser.ini']
diff --git a/browser/devtools/styleinspector/moz.build b/browser/devtools/styleinspector/moz.build
--- a/browser/devtools/styleinspector/moz.build
+++ b/browser/devtools/styleinspector/moz.build
@@ -1,16 +1,14 @@
 # -*- Mode: python; c-basic-offset: 4; indent-tabs-mode: nil; tab-width: 40 -*-
 # vim: set filetype=python:
 # This Source Code Form is subject to the terms of the Mozilla Public
 # License, v. 2.0. If a copy of the MPL was not distributed with this
 # file, You can obtain one at http://mozilla.org/MPL/2.0/.
 
 BROWSER_CHROME_MANIFESTS += ['test/browser.ini']
-XPCSHELL_TESTS_MANIFESTS += ['test/unit/xpcshell.ini']
 
 EXTRA_JS_MODULES.devtools.styleinspector += [
     'computed-view.js',
-    'css-parsing-utils.js',
     'rule-view.js',
     'style-inspector-overlays.js',
     'style-inspector.js',
 ]
diff --git a/browser/devtools/styleinspector/rule-view.js b/browser/devtools/styleinspector/rule-view.js
--- a/browser/devtools/styleinspector/rule-view.js
+++ b/browser/devtools/styleinspector/rule-view.js
@@ -9,25 +9,27 @@
 const {Cc, Ci, Cu} = require("chrome");
 const {Promise: promise} = Cu.import("resource://gre/modules/Promise.jsm", {});
 const {CssLogic} = require("devtools/styleinspector/css-logic");
 const {InplaceEditor, editableField, editableItem} = require("devtools/shared/inplace-editor");
 const {ELEMENT_STYLE, PSEUDO_ELEMENTS} = require("devtools/server/actors/styles");
 const {gDevTools} = Cu.import("resource:///modules/devtools/gDevTools.jsm", {});
 const {OutputParser} = require("devtools/output-parser");
 const {PrefObserver, PREF_ORIG_SOURCES} = require("devtools/styleeditor/utils");
-const {parseSingleValue, parseDeclarations} = require("devtools/styleinspector/css-parsing-utils");
+const {parseSingleValue, parseDeclarations} = require("devtools/css-parsing-utils");
 const overlays = require("devtools/styleinspector/style-inspector-overlays");
 
 Cu.import("resource://gre/modules/Services.jsm");
 Cu.import("resource://gre/modules/XPCOMUtils.jsm");
 
 const HTML_NS = "http://www.w3.org/1999/xhtml";
 const XUL_NS = "http://www.mozilla.org/keymaster/gatekeeper/there.is.only.xul";
 const PREF_UA_STYLES = "devtools.inspector.showUserAgentStyles";
+const PREF_AUTHORED_STYLES = "devtools.inspector.authoredStyles";
+const PREF_IMAGE_PREVIEW_SIZE = "devtools.inspector.imagePreviewTooltipSize";
 const PREF_DEFAULT_COLOR_UNIT = "devtools.defaultColorUnit";
 
 /**
  * These regular expressions are adapted from firebug's css.js, and are
  * used to parse CSSStyleDeclaration's cssText attribute.
  */
 
 // Used to split on css line separators
@@ -216,71 +218,66 @@ ElementStyle.prototype = {
         this._sortRulesForPseudoElement();
 
         // We're done with the previous list of rules.
         delete this._refreshRules;
 
         return null;
       });
     }).then(null, promiseWarn);
+
     this.populated = populated;
     return this.populated;
   },
 
   /**
    * Put pseudo elements in front of others.
    */
    _sortRulesForPseudoElement: function() {
       this.rules = this.rules.sort((a, b) => {
         return (a.pseudoElement || "z") > (b.pseudoElement || "z");
       });
    },
 
   /**
-   * Add a rule if it's one we care about.  Filters out duplicates and
-   * inherited styles with no inherited properties.
-   *
-   * @param {object} aOptions
-   *        Options for creating the Rule, see the Rule constructor.
-   *
-   * @return {bool} true if we added the rule.
+   * Add a rule if it's one we care about. Filters out duplicates and inherited
+   * styles with no inherited properties.
+   * @param {object} options Options for creating the Rule, see the Rule constructor.
    */
-  _maybeAddRule: function(aOptions) {
-    // If we've already included this domRule (for example, when a
-    // common selector is inherited), ignore it.
-    if (aOptions.rule &&
-        this.rules.some(function(rule) rule.domRule === aOptions.rule)) {
+  _maybeAddRule: function(options) {
+    // If we've already included this domRule (for example, when a common selector
+    // is inherited), ignore it
+    if (options.rule && this.rules.some(rule => rule.domRule === options.rule)) {
       return false;
     }
 
-    if (aOptions.system) {
+    if (options.system) {
       return false;
     }
 
     let rule = null;
 
-    // If we're refreshing and the rule previously existed, reuse the
-    // Rule object.
+    // If we're refreshing and the rule previously existed, reuse the Rule object
     if (this._refreshRules) {
       for (let r of this._refreshRules) {
-        if (r.matches(aOptions)) {
+        if (r.matches(options)) {
           rule = r;
-          rule.refresh(aOptions);
+          rule.refresh(options);
           break;
         }
       }
     }
 
     // If this is a new rule, create its Rule object.
     if (!rule) {
-      rule = new Rule(this, aOptions);
+      rule = new Rule(this, options);
     }
 
     // Ignore inherited rules with no properties.
-    if (aOptions.inherited && rule.textProps.length == 0) {
+    if (options.inherited && rule.textProps.length == 0) {
       return false;
     }
 
     this.rules.push(rule);
     return true;
   },
 
   /**
@@ -334,16 +331,28 @@ ElementStyle.prototype = {
     //   If the new property is a lower or equal priority, mark it as
     //   overridden.
     //
     // _overriddenDirty will be set on each prop, indicating whether its
     // dirty status changed during this pass.
     let taken = {};
     for (let computedProp of computedProps) {
       let earlier = taken[computedProp.name];
+
+      // XXX: prevent the -webkit-gradient from being selected after unchecking
+      // linear-gradient in this case:
+      //  -moz-linear-gradient: ...;
+      //  -webkit-linear-gradient: ...;
+      //  linear-gradient: ...;
+      // First of all, the isValid check should probably move to the prop instead of the textProp.editor
+      let isValidXXX = !computedProp.textProp.editor || computedProp.textProp.editor.isValid();
+      if (!isValidXXX) {
+        computedProp.overridden = true;
+        continue;
+      }
       let overridden;
       if (earlier &&
           computedProp.priority === "important" &&
           earlier.priority !== "important") {
         // New property is higher priority.  Mark the earlier property
         // overridden (which will reverse its dirty state).
         earlier._overriddenDirty = !earlier._overriddenDirty;
         earlier.overridden = true;
@@ -402,19 +411,19 @@ ElementStyle.prototype = {
 
 /**
  * A single style rule or declaration.
  *
  * @param {ElementStyle} aElementStyle
  *        The ElementStyle to which this rule belongs.
  * @param {object} aOptions
  *        The information used to construct this rule.  Properties include:
- *          rule: A StyleRuleActor
- *          inherited: An element this rule was inherited from.  If omitted,
- *            the rule applies directly to the current element.
+ *        - rule: A StyleRuleActor
+ *        - inherited: An element this rule was inherited from.  If omitted, the
+ *          rule applies directly to the current element.
  *          isSystem: Is this a user agent style?
  * @constructor
  */
 function Rule(aElementStyle, aOptions) {
   this.elementStyle = aElementStyle;
   this.domRule = aOptions.rule || null;
   this.style = aOptions.rule;
   this.matchedSelectors = aOptions.matchedSelectors || [];
@@ -741,16 +750,17 @@ Rule.prototype = {
   /**
    * Get the list of TextProperties from the style.  Needs
    * to parse the style's cssText.
    */
   _getTextProperties: function() {
     let textProps = [];
     let store = this.elementStyle.store;
     let props = parseDeclarations(this.style.cssText);
+
     for (let prop of props) {
       let name = prop.name;
       if (this.inherited && !domUtils.isInheritedProperty(name)) {
         continue;
       }
       let value = store.userProperties.getProperty(this.style, name, prop.value);
       let textProp = new TextProperty(this, name, value, prop.priority);
       textProps.push(textProp);
@@ -886,18 +896,29 @@ Rule.prototype = {
         match.prop = prop;
       } else if (rank) {
         // A previous match outranks us, disable ourself.
         prop.enabled = false;
         prop.updateEditor();
       }
     }
 
-    // If we found a match, update its value with the new text property
-    // value.
+    // If we found a match, update its value with the new text property value.
+
+    if (tooltipType === "transform") {
+      return this.previewTooltip.setCssTransformContent(target.textProperty.value,
+        this.pageStyle, this._viewedElement);
+    }
+    if (tooltipType === "image") {
+      let prop = target.parentNode.textProperty;
+      let dim = Services.prefs.getIntPref(PREF_IMAGE_PREVIEW_SIZE);
+      let uri = CssLogic.getBackgroundImageUriFromProperty(prop.value, prop.rule.domRule.href);
+      return this.previewTooltip.setRelativeImageContent(uri, this.inspector.inspector, dim);
+    }
+
     if (match.prop) {
       match.prop.set(aNewProp);
       return true;
     }
 
     return false;
   },
 
@@ -1445,17 +1466,17 @@ CssRuleView.prototype = {
   },
 
   _handlePrefChange: function(pref) {
     if (pref === PREF_UA_STYLES) {
       this.showUserAgentStyles = Services.prefs.getBoolPref(pref);
     }
 
     // Reselect the currently selected element
-    let refreshOnPrefs = [PREF_UA_STYLES, PREF_DEFAULT_COLOR_UNIT];
+    let refreshOnPrefs = [PREF_UA_STYLES, PREF_DEFAULT_COLOR_UNIT, PREF_AUTHORED_STYLES];
     if (refreshOnPrefs.indexOf(pref) > -1) {
       let element = this._viewedElement;
       this._viewedElement = null;
       this.highlight(element);
     }
   },
 
   _onSourcePrefChanged: function() {
diff --git a/browser/devtools/styleinspector/test/browser_ruleview_media-queries.js b/browser/devtools/styleinspector/test/browser_ruleview_media-queries.js
--- a/browser/devtools/styleinspector/test/browser_ruleview_media-queries.js
+++ b/browser/devtools/styleinspector/test/browser_ruleview_media-queries.js
@@ -20,12 +20,11 @@ let test = asyncTest(function*() {
   let _strings = Services.strings
     .createBundle("chrome://global/locale/devtools/styleinspector.properties");
 
   let inline = _strings.GetStringFromName("rule.sourceInline");
 
   is(elementStyle.rules.length, 3, "Should have 3 rules.");
   is(elementStyle.rules[0].title, inline, "check rule 0 title");
   is(elementStyle.rules[1].title, inline +
-    ":15 @media screen and (min-width: 1px)", "check rule 1 title");
-  is(elementStyle.rules[2].title, inline + ":8", "check rule 2 title");
+    ":9 @media screen and (min-width: 1px)", "check rule 1 title");
+  is(elementStyle.rules[2].title, inline + ":2", "check rule 2 title");
 });
-
diff --git a/browser/devtools/styleinspector/test/unit/test_parseDeclarations.js b/browser/devtools/styleinspector/test/unit/test_parseDeclarations.js
deleted file mode 100644
--- a/browser/devtools/styleinspector/test/unit/test_parseDeclarations.js
+++ /dev/null
@@ -1,206 +0,0 @@
-/* -*- indent-tabs-mode: nil; js-indent-level: 2 -*- */
-/* vim: set ts=2 et sw=2 tw=80: */
-/* Any copyright is dedicated to the Public Domain.
-   http://creativecommons.org/publicdomain/zero/1.0/ */
-
-const Cu = Components.utils;
-Cu.import("resource://gre/modules/devtools/Loader.jsm");
-const {parseDeclarations} = devtools.require("devtools/styleinspector/css-parsing-utils");
-
-const TEST_DATA = [
-  // Simple test
-  {
-    input: "p:v;",
-    expected: [{name: "p", value: "v", priority: ""}]
-  },
-  // Simple test
-  {
-    input: "this:is;a:test;",
-    expected: [
-      {name: "this", value: "is", priority: ""},
-      {name: "a", value: "test", priority: ""}
-    ]
-  },
-  // Test a single declaration with semi-colon
-  {
-    input: "name:value;",
-    expected: [{name: "name", value: "value", priority: ""}]
-  },
-  // Test a single declaration without semi-colon
-  {
-    input: "name:value",
-    expected: [{name: "name", value: "value", priority: ""}]
-  },
-  // Test multiple declarations separated by whitespaces and carriage returns and tabs
-  {
-    input: "p1 : v1 ; \t\t  \n p2:v2;   \n\n\n\n\t  p3    :   v3;",
-    expected: [
-      {name: "p1", value: "v1", priority: ""},
-      {name: "p2", value: "v2", priority: ""},
-      {name: "p3", value: "v3", priority: ""},
-    ]
-  },
-  // Test simple priority
-  {
-    input: "p1: v1; p2: v2 !important;",
-    expected: [
-      {name: "p1", value: "v1", priority: ""},
-      {name: "p2", value: "v2", priority: "important"}
-    ]
-  },
-  // Test simple priority
-  {
-    input: "p1: v1 !important; p2: v2",
-    expected: [
-      {name: "p1", value: "v1", priority: "important"},
-      {name: "p2", value: "v2", priority: ""}
-    ]
-  },
-  // Test simple priority
-  {
-    input: "p1: v1 !  important; p2: v2 ! important;",
-    expected: [
-      {name: "p1", value: "v1", priority: "important"},
-      {name: "p2", value: "v2", priority: "important"}
-    ]
-  },
-  // Test invalid priority
-  {
-    input: "p1: v1 important;",
-    expected: [
-      {name: "p1", value: "v1 important", priority: ""}
-    ]
-  },
-  // Test various types of background-image urls
-  {
-    input: "background-image: url(../../relative/image.png)",
-    expected: [{name: "background-image", value: "url(\"../../relative/image.png\")", priority: ""}]
-  },
-  {
-    input: "background-image: url(http://site.com/test.png)",
-    expected: [{name: "background-image", value: "url(\"http://site.com/test.png\")", priority: ""}]
-  },
-  {
-    input: "background-image: url(wow.gif)",
-    expected: [{name: "background-image", value: "url(\"wow.gif\")", priority: ""}]
-  },
-  // Test that urls with :;{} characters in them are parsed correctly
-  {
-    input: "background: red url(\"http://site.com/image{}:;.png?id=4#wat\") repeat top right",
-    expected: [
-      {name: "background", value: "red url(\"http://site.com/image{}:;.png?id=4#wat\") repeat top right", priority: ""}
-    ]
-  },
-  // Test that an empty string results in an empty array
-  {input: "", expected: []},
-  // Test that a string comprised only of whitespaces results in an empty array
-  {input: "       \n \n   \n   \n \t  \t\t\t  ", expected: []},
-  // Test that a null input throws an exception
-  {input: null, throws: true},
-  // Test that a undefined input throws an exception
-  {input: undefined, throws: true},
-  // Test that :;{} characters in quoted content are not parsed as multiple declarations
-  {
-    input: "content: \";color:red;}selector{color:yellow;\"",
-    expected: [
-      {name: "content", value: "\";color:red;}selector{color:yellow;\"", priority: ""}
-    ]
-  },
-  // Test that rules aren't parsed, just declarations. So { and } found after a
-  // property name should be part of the property name, same for values.
-  {
-    input: "body {color:red;} p {color: blue;}",
-    expected: [
-      {name: "body {color", value: "red", priority: ""},
-      {name: "} p {color", value: "blue", priority: ""},
-      {name: "}", value: "", priority: ""}
-    ]
-  },
-  // Test unbalanced : and ;
-  {
-    input: "color :red : font : arial;",
-    expected : [
-      {name: "color", value: "red : font : arial", priority: ""}
-    ]
-  },
-  {input: "background: red;;;;;", expected: [{name: "background", value: "red", priority: ""}]},
-  {input: "background:;", expected: [{name: "background", value: "", priority: ""}]},
-  {input: ";;;;;", expected: []},
-  {input: ":;:;", expected: []},
-  // Test name only
-  {input: "color", expected: [
-    {name: "color", value: "", priority: ""}
-  ]},
-  // Test trailing name without :
-  {input: "color:blue;font", expected: [
-    {name: "color", value: "blue", priority: ""},
-    {name: "font", value: "", priority: ""}
-  ]},
-  // Test trailing name with :
-  {input: "color:blue;font:", expected: [
-    {name: "color", value: "blue", priority: ""},
-    {name: "font", value: "", priority: ""}
-  ]},
-  // Test leading value
-  {input: "Arial;color:blue;", expected: [
-    {name: "", value: "Arial", priority: ""},
-    {name: "color", value: "blue", priority: ""}
-  ]},
-  // Test hex colors
-  {input: "color: #333", expected: [{name: "color", value: "#333", priority: ""}]},
-  {input: "color: #456789", expected: [{name: "color", value: "#456789", priority: ""}]},
-  {input: "wat: #XYZ", expected: [{name: "wat", value: "#XYZ", priority: ""}]},
-  // Test string/url quotes escaping
-  {input: "content: \"this is a 'string'\"", expected: [{name: "content", value: "\"this is a 'string'\"", priority: ""}]},
-  {input: 'content: "this is a \\"string\\""', expected: [{name: "content", value: '\'this is a "string"\'', priority: ""}]},
-  {input: "content: 'this is a \"string\"'", expected: [{name: "content", value: '\'this is a "string"\'', priority: ""}]},
-  {input: "content: 'this is a \\'string\\'", expected: [{name: "content", value: '"this is a \'string\'"', priority: ""}]},
-  {input: "content: 'this \\' is a \" really strange string'", expected: [{name: "content", value: '"this \' is a \" really strange string"', priority: ""}]},
-  {
-    input: "content: \"a not s\\\
-          o very long title\"",
-    expected: [
-      {name: "content", value: '"a not s\
-          o very long title"', priority: ""}
-    ]
-  }
-];
-
-function run_test() {
-  for (let test of TEST_DATA) {
-    do_print("Test input string " + test.input);
-    let output;
-    try {
-      output = parseDeclarations(test.input);
-    } catch (e) {
-      do_print("parseDeclarations threw an exception with the given input string");
-      if (test.throws) {
-        do_print("Exception expected");
-        do_check_true(true);
-      } else {
-        do_print("Exception unexpected\n" + e);
-        do_check_true(false);
-      }
-    }
-    if (output) {
-      assertOutput(output, test.expected);
-    }
-  }
-}
-
-function assertOutput(actual, expected) {
-  if (actual.length === expected.length) {
-    for (let i = 0; i < expected.length; i ++) {
-      do_check_true(!!actual[i]);
-      do_print("Check that the output item has the expected name, value and priority");
-      do_check_eq(expected[i].name, actual[i].name);
-      do_check_eq(expected[i].value, actual[i].value);
-      do_check_eq(expected[i].priority, actual[i].priority);
-    }
-  } else {
-    for (let prop of actual) {
-      do_print("Actual output contained: {name: "+prop.name+", value: "+prop.value+", priority: "+prop.priority+"}");
-    }
-    do_check_eq(actual.length, expected.length);
-  }
-}
diff --git a/browser/devtools/styleinspector/test/unit/test_parseSingleValue.js b/browser/devtools/styleinspector/test/unit/test_parseSingleValue.js
deleted file mode 100644
--- a/browser/devtools/styleinspector/test/unit/test_parseSingleValue.js
+++ /dev/null
@@ -1,76 +0,0 @@
-/* -*- indent-tabs-mode: nil; js-indent-level: 2 -*- */
-/* vim: set ts=2 et sw=2 tw=80: */
-/* Any copyright is dedicated to the Public Domain.
-   http://creativecommons.org/publicdomain/zero/1.0/ */
-
-const Cu = Components.utils;
-Cu.import("resource://gre/modules/devtools/Loader.jsm");
-const {parseSingleValue} = devtools.require("devtools/styleinspector/css-parsing-utils");
-
-const TEST_DATA = [
-  {input: null, throws: true},
-  {input: undefined, throws: true},
-  {input: "", expected: {value: "", priority: ""}},
-  {input: "  \t \t \n\n  ", expected: {value: "", priority: ""}},
-  {input: "blue", expected: {value: "blue", priority: ""}},
-  {input: "blue !important", expected: {value: "blue", priority: "important"}},
-  {input: "blue!important", expected: {value: "blue", priority: "important"}},
-  {input: "blue ! important", expected: {value: "blue", priority: "important"}},
-  {input: "blue !  important", expected: {value: "blue", priority: "important"}},
-  {input: "blue !", expected: {value: "blue", priority: ""}},
-  {input: "blue !mportant", expected: {value: "blue !mportant", priority: ""}},
-  {input: "  blue   !important ", expected: {value: "blue", priority: "important"}},
-  {
-    input: "url(\"http://url.com/whyWouldYouDoThat!important.png\") !important",
-    expected: {
-      value: "url(\"http://url.com/whyWouldYouDoThat!important.png\")",
-      priority: "important"
-    }
-  },
-  {
-    input: "url(\"http://url.com/whyWouldYouDoThat!important.png\")",
-    expected: {
-      value: "url(\"http://url.com/whyWouldYouDoThat!important.png\")",
-      priority: ""
-    }
-  },
-  {
-    input: "\"content!important\" !important",
-    expected: {
-      value: "\"content!important\"",
-      priority: "important"
-    }
-  },
-  {
-    input: "\"content!important\"",
-    expected: {
-      value: "\"content!important\"",
-      priority: ""
-    }
-  }
-];
-
-function run_test() {
-  for (let test of TEST_DATA) {
-    do_print("Test input value " + test.input);
-    try {
-      let output = parseSingleValue(test.input);
-      assertOutput(output, test.expected);
-    } catch (e) {
-      do_print("parseSingleValue threw an exception with the given input value");
-      if (test.throws) {
-        do_print("Exception expected");
-        do_check_true(true);
-      } else {
-        do_print("Exception unexpected\n" + e);
-        do_check_true(false);
-      }
-    }
-  }
-}
-
-function assertOutput(actual, expected) {
-  do_print("Check that the output has the expected value and priority");
-  do_check_eq(expected.value, actual.value);
-  do_check_eq(expected.priority, actual.priority);
-}
diff --git a/browser/devtools/styleinspector/test/unit/xpcshell.ini b/browser/devtools/styleinspector/test/unit/xpcshell.ini
deleted file mode 100644
--- a/browser/devtools/styleinspector/test/unit/xpcshell.ini
+++ /dev/null
@@ -1,7 +0,0 @@
-[DEFAULT]
-head =
-tail =
-firefox-appdir = browser
-
-[test_parseDeclarations.js]
-[test_parseSingleValue.js]
diff --git a/toolkit/devtools/Loader.jsm b/toolkit/devtools/Loader.jsm
--- a/toolkit/devtools/Loader.jsm
+++ b/toolkit/devtools/Loader.jsm
@@ -89,16 +89,18 @@ BuiltinProvider.prototype = {
         "devtools": "resource:///modules/devtools",
         "devtools/toolkit": "resource://gre/modules/devtools",
         "devtools/server": "resource://gre/modules/devtools/server",
         "devtools/toolkit/webconsole": "resource://gre/modules/devtools/toolkit/webconsole",
         "devtools/app-actor-front": "resource://gre/modules/devtools/app-actor-front.js",
         "devtools/styleinspector/css-logic": "resource://gre/modules/devtools/styleinspector/css-logic",
         "devtools/css-color": "resource://gre/modules/devtools/css-color",
         "devtools/output-parser": "resource://gre/modules/devtools/output-parser",
+        "devtools/css-parsing-utils": "resource://gre/modules/devtools/css-parsing-utils",
+        "devtools/css-tokenizer": "resource://gre/modules/devtools/css-tokenizer",
         "devtools/touch-events": "resource://gre/modules/devtools/touch-events",
         "devtools/client": "resource://gre/modules/devtools/client",
         "devtools/pretty-fast": "resource://gre/modules/devtools/pretty-fast.js",
         "devtools/jsbeautify": "resource://gre/modules/devtools/jsbeautify/beautify.js",
         "devtools/async-utils": "resource://gre/modules/devtools/async-utils",
         "devtools/content-observer": "resource://gre/modules/devtools/content-observer",
         "gcli": "resource://gre/modules/devtools/gcli",
         "projecteditor": "resource:///modules/devtools/projecteditor",
@@ -145,16 +147,18 @@ SrcdirProvider.prototype = {
     let devtoolsURI = this.fileURI(devtoolsDir);
     let toolkitURI = this.fileURI(toolkitDir);
     let serverURI = this.fileURI(OS.Path.join(toolkitDir, "server"));
     let webconsoleURI = this.fileURI(OS.Path.join(toolkitDir, "webconsole"));
     let appActorURI = this.fileURI(OS.Path.join(toolkitDir, "apps", "app-actor-front.js"));
     let cssLogicURI = this.fileURI(OS.Path.join(toolkitDir, "styleinspector", "css-logic"));
     let cssColorURI = this.fileURI(OS.Path.join(toolkitDir, "css-color"));
     let outputParserURI = this.fileURI(OS.Path.join(toolkitDir, "output-parser"));
+    let cssParsingUtilsURI = this.fileURI(OS.Path.join(toolkitDir, "css-parsing-utils"));
+    let cssTokenizerURI = this.fileURI(OS.Path.join(toolkitDir, "css-tokenizer"));
     let touchEventsURI = this.fileURI(OS.Path.join(toolkitDir, "touch-events"));
     let clientURI = this.fileURI(OS.Path.join(toolkitDir, "client"));
     let prettyFastURI = this.fileURI(OS.Path.join(toolkitDir), "pretty-fast.js");
     let jsBeautifyURI = this.fileURI(OS.Path.join(toolkitDir, "jsbeautify", "beautify.js"));
     let asyncUtilsURI = this.fileURI(OS.Path.join(toolkitDir), "async-utils.js");
     let contentObserverURI = this.fileURI(OS.Path.join(toolkitDir), "content-observer.js");
     let gcliURI = this.fileURI(OS.Path.join(toolkitDir, "gcli", "source", "lib", "gcli"));
     let projecteditorURI = this.fileURI(OS.Path.join(devtoolsDir, "projecteditor"));
@@ -171,16 +175,18 @@ SrcdirProvider.prototype = {
         "devtools": devtoolsURI,
         "devtools/toolkit": toolkitURI,
         "devtools/server": serverURI,
         "devtools/toolkit/webconsole": webconsoleURI,
         "devtools/app-actor-front": appActorURI,
         "devtools/styleinspector/css-logic": cssLogicURI,
         "devtools/css-color": cssColorURI,
         "devtools/output-parser": outputParserURI,
+        "devtools/css-parsing-utils": cssParsingUtilsURI,
+        "devtools/css-tokenizer": cssTokenizerURI,
         "devtools/touch-events": touchEventsURI,
         "devtools/client": clientURI,
         "devtools/pretty-fast": prettyFastURI,
         "devtools/jsbeautify": jsBeautifyURI,
         "devtools/async-utils": asyncUtilsURI,
         "devtools/content-observer": contentObserverURI,
         "gcli": gcliURI,
         "projecteditor": projecteditorURI,
diff --git a/browser/devtools/styleinspector/css-parsing-utils.js b/toolkit/devtools/css-parsing-utils.js
rename from browser/devtools/styleinspector/css-parsing-utils.js
rename to toolkit/devtools/css-parsing-utils.js
--- a/browser/devtools/styleinspector/css-parsing-utils.js
+++ b/toolkit/devtools/css-parsing-utils.js
@@ -1,17 +1,25 @@
 /* -*- indent-tabs-mode: nil; js-indent-level: 2 -*- */
 /* vim: set ts=2 et sw=2 tw=80: */
 /* This Source Code Form is subject to the terms of the Mozilla Public
  * License, v. 2.0. If a copy of the MPL was not distributed with this
  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */
 
 "use strict";
 
-const cssTokenizer  = require("devtools/sourceeditor/css-tokenizer");
+/**
+ * This module contains various devtools css parsing helper functions.
+ * Import it like so:
+ *
+ * const {devtools} = Cu.import("resource://gre/modules/devtools/Loader.jsm", {});
+ * const {parseDeclarations, parseSingleValue} = devtools.require("devtools/css-parsing-utils");
+ */
+
+const cssTokenizer = require("devtools/css-tokenizer");
 
 /**
  * Returns the string enclosed in quotes
  */
 function quoteString(string) {
   let hasDoubleQuotes = string.contains('"');
   let hasSingleQuotes = string.contains("'");
 
@@ -146,8 +154,91 @@ exports.parseDeclarations = parseDeclara
 function parseSingleValue(value) {
   let declaration = parseDeclarations("a: " + value + ";")[0];
   return {
     value: declaration ? declaration.value : "",
     priority: declaration ? declaration.priority : ""
   };
 };
 exports.parseSingleValue = parseSingleValue;
+
+/**
+ * Get the text content of a rule given some CSS text, a line and a column
+ * Consider the following example:
+ * body {
+ *  color: red;
+ * }
+ * p {
+ *  line-height: 2em;
+ *  color: blue;
+ * }
+ * Calling the function with the whole text above and line=3 and column=0 would
+ * return "line-height: 2em; color: blue;"
+ * @param {String} text
+ * @param {Number} line (1-indexed)
+ * @param {Number} column (1-indexed)
+ * @return {String} The text content of the rule
+ */
+function getRuleText(text, line, column) {
+  if (typeof line === "undefined" || typeof column === "undefined") {
+    throw "Location information is missing";
+  }
+  let {start, end} = getRuleRange(text, line, column);
+  return text.substring(start, end);
+}
+exports.getRuleText = getRuleText;
+
+/**
+ * Given some css text and the line/column pair that corresponds to the position
+ * of a rule, return the {start, end} index range for the rule's text
+ * @param {String} text
+ * @param {Number} line (1-indexed)
+ * @param {Number} column (1-indexed)
+ * @return {Object} A {start, end} position object
+ */
+function getRuleRange(text, line, column) {
+  let start = locationToPosition(text, line, column);
+  start = text.indexOf("{", start) + 1;
+  let end = getRuleEndPosition(text, start);
+  return {start: start, end: end};
+}
+
+/**
+ * Get the position that corresponds to a line/column pair in a string
+ * @param {String} text
+ * @param {Number} line (1-indexed)
+ * @param {Number} column (1-indexed)
+ * @return {Number} the index in text that corresponds to line and column
+ */
+function locationToPosition(text, line, column) {
+  let lines = text.split("\n");
+  let linesAfter = lines.splice(line - 1);
+  let textBefore = lines.join("\n");
+  if (lines.length) {
+    textBefore += "\n";
+  }
+
+  return textBefore.length + column;
+}
+
+/**
+ * Given some css text and a start position, return the position where the current
+ * rule closes
+ * @param {String} text
+ * @param {Number} startPosition
+ * @param {Number} The position where the rule closes
+ */
+function getRuleEndPosition(text, startPosition) {
+  text = text.substring(startPosition);
+  let tokens = cssTokenizer(text, {loc: true});
+  let endLoc;
+
+  for (let token of tokens) {
+    if (token.tokenType === "}" || token.tokenType === "EOF") {
+      endLoc = token.loc.start;
+      break;
+    }
+  }
+
+  // cssTokenizer returns 0-indexed location information
+  let endPosition = locationToPosition(text, endLoc.line + 1, endLoc.column + 1);
+  return startPosition + endPosition - 1;
+}
diff --git a/browser/devtools/sourceeditor/css-tokenizer.js b/toolkit/devtools/css-tokenizer.js
rename from browser/devtools/sourceeditor/css-tokenizer.js
rename to toolkit/devtools/css-tokenizer.js
diff --git a/toolkit/devtools/moz.build b/toolkit/devtools/moz.build
--- a/toolkit/devtools/moz.build
+++ b/toolkit/devtools/moz.build
@@ -24,16 +24,18 @@ DIRS += [
 
 MOCHITEST_CHROME_MANIFESTS += ['tests/mochitest/chrome.ini']
 XPCSHELL_TESTS_MANIFESTS += ['tests/unit/xpcshell.ini']
 
 EXTRA_JS_MODULES.devtools += [
     'async-utils.js',
     'content-observer.js',
     'css-color.js',
+    'css-parsing-utils.js',
+    'css-tokenizer.js',
     'deprecated-sync-thenables.js',
     'DevToolsUtils.js',
     'event-emitter.js',
     'output-parser.js',
     'touch-events.js',
     'worker-loader.js',
 ]
 
diff --git a/toolkit/devtools/server/actors/styles.js b/toolkit/devtools/server/actors/styles.js
--- a/toolkit/devtools/server/actors/styles.js
+++ b/toolkit/devtools/server/actors/styles.js
@@ -6,31 +6,35 @@
 
 const {Cc, Ci, Cu} = require("chrome");
 const Services = require("Services");
 const {Promise: promise} = Cu.import("resource://gre/modules/Promise.jsm", {});
 const protocol = require("devtools/server/protocol");
 const {Arg, Option, method, RetVal, types} = protocol;
 const events = require("sdk/event/core");
 const object = require("sdk/util/object");
-const { Class } = require("sdk/core/heritage");
-const { StyleSheetActor } = require("devtools/server/actors/stylesheets");
+const {Class} = require("sdk/core/heritage");
+const {StyleSheetActor} = require("devtools/server/actors/stylesheets");
+const {getRuleText} = require("devtools/css-parsing-utils");
 
 loader.lazyGetter(this, "CssLogic", () => require("devtools/styleinspector/css-logic").CssLogic);
 loader.lazyGetter(this, "DOMUtils", () => Cc["@mozilla.org/inspector/dom-utils;1"].getService(Ci.inIDOMUtils));
+loader.lazyImporter(this, "Task", "resource://gre/modules/Task.jsm");
 
 // The PageStyle actor flattens the DOM CSS objects a little bit, merging
 // Rules and their Styles into one actor.  For elements (which have a style
 // but no associated rule) we fake a rule with the following style id.
 const ELEMENT_STYLE = 100;
 exports.ELEMENT_STYLE = ELEMENT_STYLE;
 
 const PSEUDO_ELEMENTS = [":first-line", ":first-letter", ":before", ":after", ":-moz-selection"];
 exports.PSEUDO_ELEMENTS = PSEUDO_ELEMENTS;
 
+const PREF_AUTHORED_STYLES = "devtools.inspector.authoredStyles";
+
 // Predeclare the domnode actor type for use in requests.
 types.addActorType("domnode");
 
 // Predeclare the domstylerule actor type
 types.addActorType("domstylerule");
 
 /**
  * DOM Nodes returned by the style actor will be owned by the DOM walker
@@ -286,25 +290,25 @@ var PageStyleActor = protocol.ActorClass
       }
       result += ".style"
     }
     return result;
   },
 
   /**
    * Get the set of styles that apply to a given node.
-   * @param NodeActor node
-   * @param object options
-   *   `filter`: A string filter that affects the "matched" handling.
-   *     'user': Include properties from user style sheets.
-   *     'ua': Include properties from user and user-agent sheets.
-   *     Default value is 'ua'
-   *   `inherited`: Include styles inherited from parent nodes.
-   *   `matchedSeletors`: Include an array of specific selectors that
-   *     caused this rule to match its node.
+   * @param {NodeActor} node
+   * @param {Object} options, the following properties are accepted:
+   *        - filter: A string filter that affects the "matched" handling. One
+   *          of 'user' (includes properties from user style sheets) or 'ua'
+   *          (includes properties from user and user-agent sheets). Defaults
+   *          to 'ua',
+   *        - inherited: Include styles inherited from parent nodes,
+   *        - matchedSeletors: Include an array of specific selectors that
+   *          caused this rule to match its node,
    */
   getApplied: method(function(node, options) {
     let entries = [];
     this.addElementRules(node.rawNode, undefined, options, entries);
     return this.getAppliedProps(node, entries, options);
   }, {
     request: {
       node: Arg(0, "domnode"),
@@ -398,17 +402,17 @@ var PageStyleActor = protocol.ActorClass
    *   List of appliedstyle objects that lists the rules that apply to the
    *   node. If adding a new rule to the stylesheet, only the new rule entry
    *   is provided and only the style properties that apply to the new
    *   rule is fetched.
    * @returns Object containing the list of rule entries, rule actors and
    *   stylesheet actors that applies to the given node and its associated
    *   rules.
    */
-  getAppliedProps: function(node, entries, options) {
+  getAppliedProps: Task.async(function*(node, entries, options) {
     if (options.inherited) {
       let parent = this.walker.parentNode(node);
       while (parent && parent.rawNode.nodeType != Ci.nsIDOMNode.DOCUMENT_NODE) {
         this.addElementRules(parent.rawNode, parent, options, entries);
         parent = this.walker.parentNode(parent);
       }
     }
 
@@ -452,22 +456,27 @@ var PageStyleActor = protocol.ActorClass
       }
     }
 
     let rules = new Set;
     let sheets = new Set;
     entries.forEach(entry => rules.add(entry.rule));
     this.expandSets(rules, sheets);
 
+    for (let rule of rules) {
+      yield rule.setAuthoredCssTextMode(
+        Services.prefs.getBoolPref(PREF_AUTHORED_STYLES));
+    }
+
     return {
       entries: entries,
       rules: [...rules],
       sheets: [...sheets]
     }
-  },
+  }),
 
   /**
    * Expand Sets of rules and sheets to include all parent rules and sheets.
    */
   expandSets: function(ruleSet, sheetSet) {
     // Sets include new items in their iteration
     for (let rule of ruleSet) {
       if (rule.rawRule.parentRule) {
@@ -677,22 +686,28 @@ var StyleRuleActor = protocol.ActorClass
   initialize: function(pageStyle, item) {
     protocol.Actor.prototype.initialize.call(this, null);
     this.pageStyle = pageStyle;
     this.rawStyle = item.style;
 
     if (item instanceof (Ci.nsIDOMCSSRule)) {
       this.type = item.type;
       this.rawRule = item;
-      if ((this.rawRule instanceof Ci.nsIDOMCSSStyleRule ||
-           this.rawRule instanceof Ci.nsIDOMMozCSSKeyframeRule) &&
-           this.rawRule.parentStyleSheet) {
-        this.line = DOMUtils.getRuleLine(this.rawRule);
-        this.column = DOMUtils.getRuleColumn(this.rawRule);
-      }
+// <<<<<<<
+//       if ((this.rawRule instanceof Ci.nsIDOMCSSStyleRule ||
+//            this.rawRule instanceof Ci.nsIDOMMozCSSKeyframeRule) &&
+//            this.rawRule.parentStyleSheet) {
+//         this.line = DOMUtils.getRuleLine(this.rawRule);
+// |||||||
+//       if (this.rawRule instanceof Ci.nsIDOMCSSStyleRule && this.rawRule.parentStyleSheet) {
+//         this.line = DOMUtils.getRuleLine(this.rawRule);
+// =======
+//       this._getRuleLocation();
+// >>>>>>>
+      this._getRuleLocation();
     } else {
       // Fake a rule
       this.type = ELEMENT_STYLE;
       this.rawNode = item;
       this.rawRule = {
         style: item.style,
         toString: function() "[element rule " + this.style + "]"
       }
@@ -737,16 +752,19 @@ var StyleRuleActor = protocol.ActorClass
     if (this.rawRule.parentStyleSheet) {
       form.parentStyleSheet = this.pageStyle._sheetRef(this.rawRule.parentStyleSheet).actorID;
     }
 
     switch (this.type) {
       case Ci.nsIDOMCSSRule.STYLE_RULE:
         form.selectors = CssLogic.getSelectors(this.rawRule);
         form.cssText = this.rawStyle.cssText || "";
+        if (this._isAuthoredText && this.authoredText) {
+          form.cssText = this.authoredText;
+        }
         break;
       case ELEMENT_STYLE:
         // Elements don't have a parent stylesheet, and therefore
         // don't have an associated URI.  Provide a URI for
         // those.
         form.href = this.rawNode.ownerDocument.location.href;
         form.cssText = this.rawStyle.cssText || "";
         break;
@@ -771,17 +789,90 @@ var StyleRuleActor = protocol.ActorClass
         form.keyText = this.rawRule.keyText || "";
         break;
     }
 
     return form;
   },
 
   /**
-   * Modify a rule's properties.  Passed an array of modifications:
+   * If the rule is really a rule and is within a stylesheet, then retrieve its
+   * line/column location information and store it on the object.
+   * Note that for inline <style> sheets, the line returned by DOMUtils is the
+   * one relative to the container HTML document, so for now, we calculate the
+   * offset manually to get the line number relative to the <style> tag
+   */
+  _getRuleLocation: function() {
+    if (!(this.rawRule instanceof Ci.nsIDOMCSSStyleRule) ||
+        !this.rawRule.parentStyleSheet) {
+      return;
+    }
+
+    this.line = DOMUtils.getRuleLine(this.rawRule);
+    this.column = DOMUtils.getRuleColumn(this.rawRule);
+
+    let sheet = this.rawRule.parentStyleSheet;
+    if (sheet.ownerNode && sheet.ownerNode.localName === "style") {
+       // Inline sheet, line info is going to be wrong.
+       // Get the location of the first { to know the line nb of the first rule,
+       // relative to this sheet, to get the offset
+       let text = sheet.ownerNode.textContent;
+       // Hacky for now, because this will fail if { appears in a comment before
+       // but better than nothing, and faster than parsing the whole text
+       let start = text.substring(0, text.indexOf("{"));
+       let relativeStartLine = start.split("\n").length;
+       let absoluteStartLine = DOMUtils.getRuleLine(sheet.cssRules[0]);
+       let offset = absoluteStartLine - relativeStartLine;
+       this.line -= offset;
+    }
+  },
+
+  /**
+   * Set the authored mode. When 'on', this actor's form.cssText will contain
+   * the authored text rather than the applied css text
+   * @param {Boolean} mode
+   * @return a promise that resolves when done
+   */
+  setAuthoredCssTextMode: function(mode) {
+    this._isAuthoredText = mode;
+    if (mode) {
+      return this.getAuthoredCssText();
+    } else {
+      return promise.resolve();
+    }
+  },
+
+  /**
+   * While the actor form contains a cssText property that corresponds to the
+   * applied css declarations, this method returns the authored css declarations
+   * instead.
+   */
+  getAuthoredCssText: method(Task.async(function*() {
+    if (this.type !== Ci.nsIDOMCSSRule.STYLE_RULE || !this.rawRule.parentStyleSheet) {
+      return "";
+    }
+
+    if (this.authoredText) {
+      return this.authoredText;
+    }
+
+    let parentStyleSheet = this.pageStyle._sheetRef(this.rawRule.parentStyleSheet);
+    let {str: cssText} = yield parentStyleSheet.getText();
+    cssText = getRuleText(cssText, this.line, this.column);
+
+    // Cache the result on the rule actor to avoid pasing again next time
+    return this.authoredText = cssText.replace(/\n/g, "").trim();
+  }), {
+    response: {
+      text: RetVal("string")
+    }
+  }),
+
+  /**
+   * Modify a rule's properties. Passed an array of modifications:
    * {
    *   type: "set",
    *   name: <string>,
    *   value: <string>,
    *   priority: <optional string>
    * }
    *  or
    * {
@@ -1030,9 +1121,8 @@ var RuleModificationList = Class({
   },
   removeProperty: function(name) {
     this.modifications.push({
       type: "remove",
       name: name
     });
   }
 });
-
diff --git a/toolkit/devtools/tests/unit/test_getRuleText.js b/toolkit/devtools/tests/unit/test_getRuleText.js
new file mode 100644
--- /dev/null
+++ b/toolkit/devtools/tests/unit/test_getRuleText.js
@@ -0,0 +1,127 @@
+/* -*- Mode: Javascript; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */
+/* vim: set ts=2 et sw=2 tw=80: */
+/* Any copyright is dedicated to the Public Domain.
+   http://creativecommons.org/publicdomain/zero/1.0/ */
+
+const {devtools} = Cu.import("resource://gre/modules/devtools/Loader.jsm", {});
+const {getRuleText} = devtools.require("devtools/css-parsing-utils");
+
+const TEST_DATA = [
+  {
+    desc: "Empty input",
+    input: "",
+    line: 1,
+    column: 1,
+    expected: ""
+  },
+  {
+    desc: "Simplest test case",
+    input: "#id{color:red;background:yellow;}",
+    line: 1,
+    column: 1,
+    expected: "color:red;background:yellow;"
+  },
+  {
+    desc: "Multiple rules test case",
+    input: "#id{color:red;background:yellow;}.class-one .class-two { position:absolute; line-height: 45px}",
+    line: 1,
+    column: 34,
+    expected: " position:absolute; line-height: 45px"
+  },
+  {
+    desc: "Unclosed rule",
+    input: "#id{color:red;background:yellow;",
+    line: 1,
+    column: 1,
+    expected: "color:red;background:yellow;"
+  },
+  {
+    desc: "Null input",
+    input: null,
+    line: 1,
+    column: 1,
+    throws: true
+  },
+  {
+    desc: "Missing loc",
+    input: "#id{color:red;background:yellow;}",
+    throws: true
+  },
+  {
+    desc: "Multi-lines CSS",
+    input: [
+      "/* this is a multi line css */",
+      "body {",
+      "  color: green;",
+      "  background-repeat: no-repeat",
+      "}",
+      " /*something else here",
+      "* {",
+      "  color: purple;",
+      "}"
+    ].join("\n"),
+    line: 7,
+    column: 1,
+    expected: "\n  color: purple;\n"
+  },
+  {
+    desc: "Multi-lines CSS and multi-line rule",
+    input: [
+      "/* ",
+       "* some comments",
+       "*/",
+      "",
+      "body {",
+      "    margin: 0;",
+      "    padding: 15px 15px 2px 15px;",
+      "    color: red;",
+      "}",
+      "",
+      "#header .btn, #header .txt {",
+      "    font-size: 100%;",
+      "}",
+      "",
+      "#header #information {",
+      "    color: #dddddd;",
+      "    font-size: small;",
+      "}",
+    ].join("\n"),
+    line: 5,
+    column: 1,
+    expected: "\n    margin: 0;\n    padding: 15px 15px 2px 15px;\n    color: red;\n"
+  },
+  {
+    desc: "Content string containing a } character",
+    input: "   #id{border:1px solid red;content: '}';color:red;}",
+    line: 1,
+    column: 4,
+    expected: "border:1px solid red;content: '}';color:red;"
+  },
+];
+
+function run_test() {
+  for (let test of TEST_DATA) {
+    do_print("Starting test: " + test.desc);
+    do_print("Input string " + test.input);
+    let output;
+    try {
+      output = getRuleText(test.input, test.line, test.column);
+      if (test.throws) {
+        do_print("Test should have thrown");
+        do_check_true(false);
+      }
+    } catch (e) {
+      do_print("getRuleText threw an exception with the given input string");
+      if (test.throws) {
+        do_print("Exception expected");
+        do_check_true(true);
+      } else {
+        do_print("Exception unexpected\n" + e);
+        do_check_true(false);
+      }
+    }
+    if (output) {
+      do_check_eq(output, test.expected);
+    }
+  }
+}
diff --git a/toolkit/devtools/tests/unit/test_parseDeclarations.js b/toolkit/devtools/tests/unit/test_parseDeclarations.js
new file mode 100644
--- /dev/null
+++ b/toolkit/devtools/tests/unit/test_parseDeclarations.js
@@ -0,0 +1,205 @@
+/* -*- Mode: Javascript; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */
+/* vim: set ts=2 et sw=2 tw=80: */
+/* Any copyright is dedicated to the Public Domain.
+   http://creativecommons.org/publicdomain/zero/1.0/ */
+
+const {devtools} = Cu.import("resource://gre/modules/devtools/Loader.jsm", {});
+const {parseDeclarations} = devtools.require("devtools/css-parsing-utils");
+
+const TEST_DATA = [
+  // Simple test
+  {
+    input: "p:v;",
+    expected: [{name: "p", value: "v", priority: ""}]
+  },
+  // Simple test
+  {
+    input: "this:is;a:test;",
+    expected: [
+      {name: "this", value: "is", priority: ""},
+      {name: "a", value: "test", priority: ""}
+    ]
+  },
+  // Test a single declaration with semi-colon
+  {
+    input: "name:value;",
+    expected: [{name: "name", value: "value", priority: ""}]
+  },
+  // Test a single declaration without semi-colon
+  {
+    input: "name:value",
+    expected: [{name: "name", value: "value", priority: ""}]
+  },
+  // Test multiple declarations separated by whitespaces and carriage returns and tabs
+  {
+    input: "p1 : v1 ; \t\t  \n p2:v2;   \n\n\n\n\t  p3    :   v3;",
+    expected: [
+      {name: "p1", value: "v1", priority: ""},
+      {name: "p2", value: "v2", priority: ""},
+      {name: "p3", value: "v3", priority: ""},
+    ]
+  },
+  // Test simple priority
+  {
+    input: "p1: v1; p2: v2 !important;",
+    expected: [
+      {name: "p1", value: "v1", priority: ""},
+      {name: "p2", value: "v2", priority: "important"}
+    ]
+  },
+  // Test simple priority
+  {
+    input: "p1: v1 !important; p2: v2",
+    expected: [
+      {name: "p1", value: "v1", priority: "important"},
+      {name: "p2", value: "v2", priority: ""}
+    ]
+  },
+  // Test simple priority
+  {
+    input: "p1: v1 !  important; p2: v2 ! important;",
+    expected: [
+      {name: "p1", value: "v1", priority: "important"},
+      {name: "p2", value: "v2", priority: "important"}
+    ]
+  },
+  // Test invalid priority
+  {
+    input: "p1: v1 important;",
+    expected: [
+      {name: "p1", value: "v1 important", priority: ""}
+    ]
+  },
+  // Test various types of background-image urls
+  {
+    input: "background-image: url(../../relative/image.png)",
+    expected: [{name: "background-image", value: "url(\"../../relative/image.png\")", priority: ""}]
+  },
+  {
+    input: "background-image: url(http://site.com/test.png)",
+    expected: [{name: "background-image", value: "url(\"http://site.com/test.png\")", priority: ""}]
+  },
+  {
+    input: "background-image: url(wow.gif)",
+    expected: [{name: "background-image", value: "url(\"wow.gif\")", priority: ""}]
+  },
+  // Test that urls with :;{} characters in them are parsed correctly
+  {
+    input: "background: red url(\"http://site.com/image{}:;.png?id=4#wat\") repeat top right",
+    expected: [
+      {name: "background", value: "red url(\"http://site.com/image{}:;.png?id=4#wat\") repeat top right", priority: ""}
+    ]
+  },
+  // Test that an empty string results in an empty array
+  {input: "", expected: []},
+  // Test that a string comprised only of whitespaces results in an empty array
+  {input: "       \n \n   \n   \n \t  \t\t\t  ", expected: []},
+  // Test that a null input throws an exception
+  {input: null, throws: true},
+  // Test that a undefined input throws an exception
+  {input: undefined, throws: true},
+  // Test that :;{} characters in quoted content are not parsed as multiple declarations
+  {
+    input: "content: \";color:red;}selector{color:yellow;\"",
+    expected: [
+      {name: "content", value: "\";color:red;}selector{color:yellow;\"", priority: ""}
+    ]
+  },
+  // Test that rules aren't parsed, just declarations. So { and } found after a
+  // property name should be part of the property name, same for values.
+  {
+    input: "body {color:red;} p {color: blue;}",
+    expected: [
+      {name: "body {color", value: "red", priority: ""},
+      {name: "} p {color", value: "blue", priority: ""},
+      {name: "}", value: "", priority: ""}
+    ]
+  },
+  // Test unbalanced : and ;
+  {
+    input: "color :red : font : arial;",
+    expected : [
+      {name: "color", value: "red : font : arial", priority: ""}
+    ]
+  },
+  {input: "background: red;;;;;", expected: [{name: "background", value: "red", priority: ""}]},
+  {input: "background:;", expected: [{name: "background", value: "", priority: ""}]},
+  {input: ";;;;;", expected: []},
+  {input: ":;:;", expected: []},
+  // Test name only
+  {input: "color", expected: [
+    {name: "color", value: "", priority: ""}
+  ]},
+  // Test trailing name without :
+  {input: "color:blue;font", expected: [
+    {name: "color", value: "blue", priority: ""},
+    {name: "font", value: "", priority: ""}
+  ]},
+  // Test trailing name with :
+  {input: "color:blue;font:", expected: [
+    {name: "color", value: "blue", priority: ""},
+    {name: "font", value: "", priority: ""}
+  ]},
+  // Test leading value
+  {input: "Arial;color:blue;", expected: [
+    {name: "", value: "Arial", priority: ""},
+    {name: "color", value: "blue", priority: ""}
+  ]},
+  // Test hex colors
+  {input: "color: #333", expected: [{name: "color", value: "#333", priority: ""}]},
+  {input: "color: #456789", expected: [{name: "color", value: "#456789", priority: ""}]},
+  {input: "wat: #XYZ", expected: [{name: "wat", value: "#XYZ", priority: ""}]},
+  // Test string/url quotes escaping
+  {input: "content: \"this is a 'string'\"", expected: [{name: "content", value: "\"this is a 'string'\"", priority: ""}]},
+  {input: 'content: "this is a \\"string\\""', expected: [{name: "content", value: '\'this is a "string"\'', priority: ""}]},
+  {input: "content: 'this is a \"string\"'", expected: [{name: "content", value: '\'this is a "string"\'', priority: ""}]},
+  {input: "content: 'this is a \\'string\\'", expected: [{name: "content", value: '"this is a \'string\'"', priority: ""}]},
+  {input: "content: 'this \\' is a \" really strange string'", expected: [{name: "content", value: '"this \' is a \" really strange string"', priority: ""}]},
+  {
+    input: "content: \"a not s\\\
+          o very long title\"",
+    expected: [
+      {name: "content", value: '"a not s\
+          o very long title"', priority: ""}
+    ]
+  }
+];
+
+function run_test() {
+  for (let test of TEST_DATA) {
+    do_print("Test input string " + test.input);
+    let output;
+    try {
+      output = parseDeclarations(test.input);
+    } catch (e) {
+      do_print("parseDeclarations threw an exception with the given input string");
+      if (test.throws) {
+        do_print("Exception expected");
+        do_check_true(true);
+      } else {
+        do_print("Exception unexpected\n" + e);
+        do_check_true(false);
+      }
+    }
+    if (output) {
+      assertOutput(output, test.expected);
+    }
+  }
+}
+
+function assertOutput(actual, expected) {
+  if (actual.length === expected.length) {
+    for (let i = 0; i < expected.length; i ++) {
+      do_check_true(!!actual[i]);
+      do_print("Check that the output item has the expected name, value and priority");
+      do_check_eq(expected[i].name, actual[i].name);
+      do_check_eq(expected[i].value, actual[i].value);
+      do_check_eq(expected[i].priority, actual[i].priority);
+    }
+  } else {
+    for (let prop of actual) {
+      do_print("Actual output contained: {name: "+prop.name+", value: "+prop.value+", priority: "+prop.priority+"}");
+    }
+    do_check_eq(actual.length, expected.length);
+  }
+}
diff --git a/toolkit/devtools/tests/unit/test_parseSingleValue.js b/toolkit/devtools/tests/unit/test_parseSingleValue.js
new file mode 100644
--- /dev/null
+++ b/toolkit/devtools/tests/unit/test_parseSingleValue.js
@@ -0,0 +1,75 @@
+/* -*- Mode: Javascript; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */
+/* vim: set ts=2 et sw=2 tw=80: */
+/* Any copyright is dedicated to the Public Domain.
+   http://creativecommons.org/publicdomain/zero/1.0/ */
+
+const {devtools} = Cu.import("resource://gre/modules/devtools/Loader.jsm", {});
+const {parseSingleValue} = devtools.require("devtools/css-parsing-utils");
+
+const TEST_DATA = [
+  {input: null, throws: true},
+  {input: undefined, throws: true},
+  {input: "", expected: {value: "", priority: ""}},
+  {input: "  \t \t \n\n  ", expected: {value: "", priority: ""}},
+  {input: "blue", expected: {value: "blue", priority: ""}},
+  {input: "blue !important", expected: {value: "blue", priority: "important"}},
+  {input: "blue!important", expected: {value: "blue", priority: "important"}},
+  {input: "blue ! important", expected: {value: "blue", priority: "important"}},
+  {input: "blue !  important", expected: {value: "blue", priority: "important"}},
+  {input: "blue !", expected: {value: "blue", priority: ""}},
+  {input: "blue !mportant", expected: {value: "blue !mportant", priority: ""}},
+  {input: "  blue   !important ", expected: {value: "blue", priority: "important"}},
+  {
+    input: "url(\"http://url.com/whyWouldYouDoThat!important.png\") !important",
+    expected: {
+      value: "url(\"http://url.com/whyWouldYouDoThat!important.png\")",
+      priority: "important"
+    }
+  },
+  {
+    input: "url(\"http://url.com/whyWouldYouDoThat!important.png\")",
+    expected: {
+      value: "url(\"http://url.com/whyWouldYouDoThat!important.png\")",
+      priority: ""
+    }
+  },
+  {
+    input: "\"content!important\" !important",
+    expected: {
+      value: "\"content!important\"",
+      priority: "important"
+    }
+  },
+  {
+    input: "\"content!important\"",
+    expected: {
+      value: "\"content!important\"",
+      priority: ""
+    }
+  }
+];
+
+function run_test() {
+  for (let test of TEST_DATA) {
+    do_print("Test input value " + test.input);
+    try {
+      let output = parseSingleValue(test.input);
+      assertOutput(output, test.expected);
+    } catch (e) {
+      do_print("parseSingleValue threw an exception with the given input value");
+      if (test.throws) {
+        do_print("Exception expected");
+        do_check_true(true);
+      } else {
+        do_print("Exception unexpected\n" + e);
+        do_check_true(false);
+      }
+    }
+  }
+}
+
+function assertOutput(actual, expected) {
+  do_print("Check that the output has the expected value and priority");
+  do_check_eq(expected.value, actual.value);
+  do_check_eq(expected.priority, actual.priority);
+}
diff --git a/toolkit/devtools/tests/unit/xpcshell.ini b/toolkit/devtools/tests/unit/xpcshell.ini
--- a/toolkit/devtools/tests/unit/xpcshell.ini
+++ b/toolkit/devtools/tests/unit/xpcshell.ini
@@ -1,11 +1,14 @@
 [DEFAULT]
 head = head_devtools.js
 tail =
 
+[test_async-utils.js]
+[test_defineLazyPrototypeGetter.js]
+[test_getRuleText.js]
 [test_independent_loaders.js]
 [test_invisible_loader.js]
+[test_parseDeclarations.js]
+[test_parseSingleValue.js]
 [test_safeErrorString.js]
-[test_defineLazyPrototypeGetter.js]
-[test_async-utils.js]
 [test_consoleID.js]
 [test_require_lazy.js]
\ No newline at end of file
