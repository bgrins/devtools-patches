# vim: se ft=diff :
# HG changeset patch
# User Tim Taubert <ttaubert@mozilla.com>
# Date 2015-06-15 05:04
Bug 1170759 - PanelUI doesn't correctly remove 'transitionend' listeners when changing the viewContainer's height

diff --git a/browser/components/customizableui/content/panelUI.xml b/browser/components/customizableui/content/panelUI.xml
index cc39273..7d9f102 100644
--- a/browser/components/customizableui/content/panelUI.xml
+++ b/browser/components/customizableui/content/panelUI.xml
@@ -158,23 +158,17 @@
             evt.initCustomEvent("ViewHiding", true, true, viewNode);
             viewNode.dispatchEvent(evt);
 
             viewNode.removeAttribute("current");
             this._currentSubView = null;
 
             this._subViewObserver.disconnect();
 
-            this._transitioning = true;
-
-            this._viewContainer.addEventListener("transitionend", function trans() {
-              this._viewContainer.removeEventListener("transitionend", trans);
-              this._transitioning = false;
-            }.bind(this));
-            this._viewContainer.style.height = this._mainViewHeight + "px";
+            this._setViewContainerHeight(this._mainViewHeight);
 
             this.setAttribute("viewtype", "main");
           }
 
           this._shiftMainView();
         ]]></body>
       </method>
 
@@ -206,34 +200,44 @@
           //
           // All three of these actions make use of CSS transformations, so they
           // should all occur simultaneously.
           this.setAttribute("viewtype", "subview");
           this._shiftMainView(aAnchor);
 
           this._mainViewHeight = this._viewStack.clientHeight;
 
-          this._transitioning = true;
-          this._viewContainer.addEventListener("transitionend", function trans() {
-            this._viewContainer.removeEventListener("transitionend", trans);
-            this._transitioning = false;
-          }.bind(this));
-
           let newHeight = this._heightOfSubview(viewNode, this._subViews);
-          this._viewContainer.style.height = newHeight + "px";
+          this._setViewContainerHeight(newHeight);
 
           this._subViewObserver.observe(viewNode, {
             attributes: true,
             characterData: true,
             childList: true,
             subtree: true
           });
         ]]></body>
       </method>
 
+      <method name="_setViewContainerHeight">
+        <parameter name="aHeight"/>
+        <body><![CDATA[
+          let container = this._viewContainer;
+          this._transitioning = true;
+
+          let onTransitionEnd = () => {
+            container.removeEventListener("transitionend", onTransitionEnd);
+            this._transitioning = false;
+          };
+
+          container.addEventListener("transitionend", onTransitionEnd);
+          container.style.height = `${aHeight}px`;
+        ]]></body>
+      </method>
+
       <method name="_shiftMainView">
         <parameter name="aAnchor"/>
         <body><![CDATA[
           if (aAnchor) {
             // We need to find the edge of the anchor, relative to the main panel.
             // Then we need to add half the width of the anchor. This is the target
             // that we need to transition to.
             let anchorRect = aAnchor.getBoundingClientRect();
-- 
2.4.3

