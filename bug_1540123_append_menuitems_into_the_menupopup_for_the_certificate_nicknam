# HG changeset patch
# User Brian Grinstead <bgrinstead@mozilla.com>
# Date 1554230744 25200
#      Tue Apr 02 11:45:44 2019 -0700
# Node ID 26cada4e6693f9c2383315cd451eaffbe9f1a606
# Parent  e8b3c73b4e328be88aa90f31e1fa9772b537507d
Bug 1540123 - Append menuitems into the menupopup for the certificate nickname menulist in certificate selection dialog UI

Differential Revision: https://phabricator.services.mozilla.com/D25825

diff --git a/security/manager/pki/resources/content/choosetoken.js b/security/manager/pki/resources/content/choosetoken.js
--- a/security/manager/pki/resources/content/choosetoken.js
+++ b/security/manager/pki/resources/content/choosetoken.js
@@ -14,17 +14,17 @@ function onLoad() {
   dialogParams = window.arguments[0].QueryInterface(nsIDialogParamBlock);
   let selectElement = document.getElementById("tokens");
   let count = dialogParams.GetInt(0);
   for (let i = 0; i < count; i++) {
     let menuItemNode = document.createElement("menuitem");
     let token = dialogParams.GetString(i);
     menuItemNode.setAttribute("value", token);
     menuItemNode.setAttribute("label", token);
-    selectElement.firstChild.appendChild(menuItemNode);
+    selectElement.menupopup.appendChild(menuItemNode);
     if (i == 0) {
       selectElement.selectedItem = menuItemNode;
     }
   }
   document.addEventListener("dialogaccept", doOK);
   document.addEventListener("dialogcancel", doCancel);
 }
 
diff --git a/security/manager/pki/resources/content/clientauthask.js b/security/manager/pki/resources/content/clientauthask.js
--- a/security/manager/pki/resources/content/clientauthask.js
+++ b/security/manager/pki/resources/content/clientauthask.js
@@ -83,17 +83,17 @@ function onLoad() {
   for (let i = 0; i < certArray.length; i++) {
     let menuItemNode = document.createXULElement("menuitem");
     let cert = certArray.queryElementAt(i, Ci.nsIX509Cert);
     let nickAndSerial =
       bundle.getFormattedString("clientAuthNickAndSerial",
                                 [cert.displayName, cert.serialNumber]);
     menuItemNode.setAttribute("value", i);
     menuItemNode.setAttribute("label", nickAndSerial); // This is displayed.
-    selectElement.firstChild.appendChild(menuItemNode);
+    selectElement.menupopup.appendChild(menuItemNode);
     if (i == 0) {
       selectElement.selectedItem = menuItemNode;
     }
   }
 
   setDetails();
   document.addEventListener("dialogaccept", doOK);
   document.addEventListener("dialogcancel", doCancel);
diff --git a/security/manager/ssl/tests/mochitest/browser/browser_clientAuth_ui.js b/security/manager/ssl/tests/mochitest/browser/browser_clientAuth_ui.js
--- a/security/manager/ssl/tests/mochitest/browser/browser_clientAuth_ui.js
+++ b/security/manager/ssl/tests/mochitest/browser/browser_clientAuth_ui.js
@@ -65,16 +65,17 @@ function checkDialogContents(win, notBef
   Assert.equal(win.document.getElementById("issuer").textContent,
                `Issued Under: “${TEST_ISSUER_ORG}”`,
                "Actual and expected issuer organization should be equal");
 
   Assert.equal(win.document.getElementById("nicknames").label,
                "Mochitest client [03]",
                "Actual and expected selected cert nickname and serial should " +
                "be equal");
+  Assert.equal(win.document.getElementById("nicknames").itemCount, 1, "correct number of items");
 
   let [subject, serialNum, validity, issuer, tokenName] =
     win.document.getElementById("details").value.split("\n");
   Assert.equal(subject, "Issued to: CN=Mochitest client",
                "Actual and expected subject should be equal");
   Assert.equal(serialNum, "Serial number: 03",
                "Actual and expected serial number should be equal");
   Assert.equal(validity, `Valid from ${notBefore} to ${notAfter}`,
