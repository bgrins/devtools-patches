# HG changeset patch
# User Brian Grinstead <bgrinstead@mozilla.com>
# Parent  5eb877436886cd582b40b9c9bf8f0323ebffca10
Bug 1154874 - Scaffold for debugger stepping test

diff --git a/testing/talos/talos/tests/devtools/addon/content/damp.html b/testing/talos/talos/tests/devtools/addon/content/damp.html
--- a/testing/talos/talos/tests/devtools/addon/content/damp.html
+++ b/testing/talos/talos/tests/devtools/addon/content/damp.html
@@ -5,23 +5,24 @@
 
 <script type="application/x-javascript">
 // Empty subtests interpreted as all subtests, since otherwise meaningless.
 var config = {subtests: [], repeat: 1};
 var defaultConfig = {
   repeat: 1,
   rest: 100,
   subtests: {
-    webconsoleOpen: true,
-    inspectorOpen: true,
-    debuggerOpen: true,
-    styleEditorOpen: true,
-    performanceOpen: true,
-    netmonitorOpen: true,
-    saveAndReadHeapSnapshot: true,
+    webconsoleOpen: false,
+    inspectorOpen: false,
+    debuggerOpen: false,
+    styleEditorOpen: false,
+    performanceOpen: false,
+    netmonitorOpen: false,
+    saveAndReadHeapSnapshot: false,
+    debuggerStepping: true,
   }
 };
 
 var testsInfo = {
   webconsoleOpen: "Measure open/close toolbox on webconsole panel",
   inspectorOpen: "Measure open/close toolbox on inspector panel",
   debuggerOpen: "Measure open/close toolbox on debugger panel",
   styleEditorOpen: "Measure open/close toolbox on style editor panel",
@@ -53,16 +54,17 @@ function updateConfig() {
 <div id="hide-during-run">
    Visit <a href="https://wiki.mozilla.org/Buildbot/Talos/Tests#DAMP">talos/TART</a> for detailed info.<br/>
   <ul>
     <li><b>If you just opened the browser</b> - give Firefox few seconds to settle down before testing.</li>
   </ul>
 
 Utilities:
   <a href="pages/simple.html">simple page</a>&nbsp;&nbsp;&nbsp;
+  <a href="pages/stepping.html">stepping page</a>&nbsp;&nbsp;&nbsp;
   <a href="http://localhost/tests/tp5n/bild.de/www.bild.de/index.html">complicated page</a>&nbsp;&nbsp;&nbsp;
 <br/><br/>
 <b>Configure DAMP</b> (CTRL-F5 to reset to talos defaults) <button type="button" onclick="deselectAll()">Deselect all tests</button><br/>
 <script>
   for (var test in defaultConfig.subtests) {
     document.write('<input type="checkbox" id="subtest-' + test + '" ' + (defaultConfig.subtests[test] ? "" : "un") + 'checked>'
                   + test + '</input>'
                   + '<span style="color:grey">&nbsp;&nbsp;&nbsp;' + testsInfo[test] + '</span>'
diff --git a/testing/talos/talos/tests/devtools/addon/content/damp.js b/testing/talos/talos/tests/devtools/addon/content/damp.js
--- a/testing/talos/talos/tests/devtools/addon/content/damp.js
+++ b/testing/talos/talos/tests/devtools/addon/content/damp.js
@@ -7,16 +7,17 @@ const { getActiveTab } = devtools.requir
 const { getMostRecentBrowserWindow } = devtools.require("sdk/window/utils");
 const ThreadSafeChromeUtils = devtools.require("ThreadSafeChromeUtils");
 const {Task} = Cu.import("resource://gre/modules/Task.jsm", {});
 
 const webserver = Services.prefs.getCharPref("addon.test.damp.webserver");
 
 const SIMPLE_URL = "chrome://damp/content/pages/simple.html";
 const COMPLICATED_URL = webserver + "/tests/tp5n/bild.de/www.bild.de/index.html";
+const STEPPING_URL = "chrome://damp/content/pages/stepping.html"
 
 function Damp() {
   // Path to the temp file where the heap snapshot file is saved. Set by
   // saveHeapSnapshot and read by readHeapSnapshot.
   this._heapSnapshotFilePath = null;
   // HeapSnapshot instance. Set by readHeapSnapshot, used by takeCensus.
   this._snapshot = null;
 }
@@ -41,46 +42,54 @@ Damp.prototype = {
 
   reloadPage: function(name) {
     let startReloadTimestamp = performance.now();
     return new Promise((resolve, reject) => {
       let browser = gBrowser.selectedBrowser;
       let self = this;
       browser.addEventListener("load", function onload() {
         browser.removeEventListener("load", onload, true);
-        let stopReloadTimestamp = performance.now();
-        self._results.push({name: name + ".reload.DAMP", value: stopReloadTimestamp - startReloadTimestamp});
+        // Only record results if a name was passed
+        if (name) {
+          let stopReloadTimestamp = performance.now();
+          self._results.push({name: name + ".reload.DAMP", value: stopReloadTimestamp - startReloadTimestamp});
+        }
         resolve();
       }, true);
       browser.reload();
     });
   },
 
   openToolbox: function (name, tool = "webconsole") {
     let tab = getActiveTab(getMostRecentBrowserWindow());
     let target = devtools.TargetFactory.forTab(tab);
     let startRecordTimestamp = performance.now();
     let showPromise = gDevTools.showToolbox(target, tool);
 
     return showPromise.then(toolbox => {
-      let stopRecordTimestamp = performance.now();
-      this._results.push({name: name + ".open.DAMP", value: stopRecordTimestamp - startRecordTimestamp});
-
+      // Only record results if a name was passed
+      if (name) {
+        let stopRecordTimestamp = performance.now();
+        this._results.push({name: name + ".open.DAMP", value: stopRecordTimestamp - startRecordTimestamp});
+      }
       return toolbox;
     });
   },
 
   closeToolbox: function(name) {
     let tab = getActiveTab(getMostRecentBrowserWindow());
     let target = devtools.TargetFactory.forTab(tab);
     let startRecordTimestamp = performance.now();
     let closePromise = gDevTools.closeToolbox(target);
     return closePromise.then(() => {
-      let stopRecordTimestamp = performance.now();
-      this._results.push({name: name + ".close.DAMP", value: stopRecordTimestamp - startRecordTimestamp});
+      // Only record results if a name was passed
+      if (name) {
+        let stopRecordTimestamp = performance.now();
+        this._results.push({name: name + ".close.DAMP", value: stopRecordTimestamp - startRecordTimestamp});
+      }
     });
   },
 
   saveHeapSnapshot: function(label) {
     let tab = getActiveTab(getMostRecentBrowserWindow());
     let target = devtools.TargetFactory.forTab(tab);
     let toolbox = gDevTools.getToolbox(target);
     let panel = toolbox.getCurrentPanel();
@@ -139,16 +148,39 @@ Damp.prototype = {
     this._results.push({
       name: label + ".takeCensus",
       value: end - start
     });
 
     return Promise.resolve();
   },
 
+  _getDebuggerSteppingTest: function() {
+    return Task.async(function*() {
+      yield this.testSetup(STEPPING_URL);
+      let toolbox = yield this.openToolbox(null, "debugger");
+      let start = performance.now();
+
+      // TODO: IMPLEMENT STEPPING AND THEN RECORD A SINGLE MEASUREMENT
+      yield new Promise(resolve => {
+        resolve();
+      });
+
+      let end = performance.now();
+
+      this._results.push({
+        name: "debuggerstep",
+        value: end - start
+      });
+
+      yield this.closeToolbox(null);
+      yield this.testTeardown();
+    });
+  },
+
   _getToolLoadingTests: function(url, label) {
     let subtests = {
       webconsoleOpen: Task.async(function*() {
         yield this.testSetup(url);
         yield this.openToolbox(label + ".webconsole", "webconsole");
         yield this.reloadPage(label + ".webconsole");
         yield this.closeToolbox(label + ".webconsole");
         yield this.testTeardown();
@@ -321,11 +353,12 @@ Damp.prototype = {
     this._dampTab = this._win.gBrowser.selectedTab;
     this._win.gBrowser.selectedBrowser.focus(); // Unfocus the URL bar to avoid caret blink
 
     Profiler.mark("DAMP - start", true);
 
     let tests = [];
     tests = tests.concat(this._getToolLoadingTests(SIMPLE_URL, "simple"));
     tests = tests.concat(this._getToolLoadingTests(COMPLICATED_URL, "complicated"));
+    tests = tests.concat(this._getDebuggerSteppingTest());
     this._doSequence(tests, this._doneInternal);
   }
 }
diff --git a/testing/talos/talos/tests/devtools/addon/content/pages/stepping.html b/testing/talos/talos/tests/devtools/addon/content/pages/stepping.html
new file mode 100644
--- /dev/null
+++ b/testing/talos/talos/tests/devtools/addon/content/pages/stepping.html
@@ -0,0 +1,50 @@
+<!-- Any copyright is dedicated to the Public Domain.
+     http://creativecommons.org/publicdomain/zero/1.0/ -->
+<!doctype html>
+
+<html>
+  <head>
+    <meta charset="utf-8"/>
+    <title>Debugger test page</title>
+  </head>
+
+  <body>
+    <button id="start">Start!</button>
+
+    <script type="text/javascript">
+      function normal(aArg) {
+        debugger;
+        var r = 10;
+        var a = squareAndOne(r);
+        var b = squareUntil(r, 99999999999); //recurses 3 times, returns on 4th call
+        var c = addUntil(r, 5, 1050); // recurses 208 times and returns on the 209th call
+        return a + b + c;
+
+      }
+
+      function squareAndOne(arg){
+        return (arg * arg) + 1;
+      }
+      function squareUntil(arg, limit){
+        if(arg * arg >= limit){
+          return arg * arg;
+        }else{
+          return squareUntil(arg * arg, limit);
+        }
+      }
+
+      function addUntil(arg1, arg2, limit){
+        if(arg1 + arg2 > limit){
+          return arg1 + arg2;
+        }else{
+          return addUntil(arg1 + arg2, arg2, limit);
+        }
+      }
+
+      var normalBtn = document.getElementById("start");
+      normalBtn.addEventListener("click", normal, false);
+
+    </script>
+  </body>
+
+</html>
