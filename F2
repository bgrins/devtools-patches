# HG changeset patch
# Parent a3f771caf25dc2f5c829e78a0fa52556c573ff86
# User Brian Grinstead <bgrinstead@mozilla.com>
Bug 892275 - F2 should make the selected node and its children editable as html

diff --git a/browser/devtools/markupview/html-editor.js b/browser/devtools/markupview/html-editor.js
--- a/browser/devtools/markupview/html-editor.js
+++ b/browser/devtools/markupview/html-editor.js
@@ -55,16 +55,17 @@ function HTMLEditor(htmlDocument)
     mode: Editor.modes.html,
     lineWrapping: true,
     styleActiveLine: false,
     extraKeys: {},
     theme: "mozilla markup-view"
   };
 
   config.extraKeys[ctrl("Enter")] = this.hide;
+  config.extraKeys["F2"] = this.hide;
   config.extraKeys["Esc"] = this.hide.bind(this, false);
 
   this.container.addEventListener("click", this.hide, false);
   this.editorInner.addEventListener("click", stopPropagation, false);
   this.editor = new Editor(config);
 
   this.editor.appendTo(this.editorInner).then(() => {
     this.hide(false);
@@ -135,16 +136,18 @@ HTMLEditor.prototype = {
     this._originalValue = text;
     this.editor.setText(text);
     this._attach(element);
     this.container.style.display = "flex";
     this._visible = true;
 
     this.editor.refresh();
     this.editor.focus();
+
+    this.emit("popupshown");
   },
 
   /**
    * Hide the editor, optionally committing the changes
    *
    * @param bool shouldCommit
    *             A change will be committed by default.  If this param
    *             strictly equals false, no change will occur.
@@ -156,17 +159,17 @@ HTMLEditor.prototype = {
     }
 
     this.container.style.display = "none";
     this._detach();
 
     let newValue = this.editor.getText();
     let valueHasChanged = this._originalValue !== newValue;
     let preventCommit = shouldCommit === false || !valueHasChanged;
-    this.emit("popup-hidden", !preventCommit, newValue);
+    this.emit("popuphidden", !preventCommit, newValue);
     this._originalValue = undefined;
     this._visible = undefined;
   },
 
   /**
    * Destroy this object and unbind all event handlers
    */
   destroy: function()
diff --git a/browser/devtools/markupview/markup-view.js b/browser/devtools/markupview/markup-view.js
--- a/browser/devtools/markupview/markup-view.js
+++ b/browser/devtools/markupview/markup-view.js
@@ -293,16 +293,20 @@ MarkupView.prototype = {
           if (!next) {
             break;
           }
           selection = next.container;
         }
         this.navigate(selection);
         break;
       }
+      case Ci.nsIDOMKeyEvent.DOM_VK_F2: {
+        this.beginEditingOuterHTML(this._selectedContainer.node);
+        break;
+      }
       default:
         handled = false;
     }
     if (handled) {
       aEvent.stopPropagation();
       aEvent.preventDefault();
     }
   },
@@ -684,17 +688,21 @@ MarkupView.prototype = {
    */
   beginEditingOuterHTML: function(aNode) {
     this.getNodeOuterHTML(aNode).then((oldValue)=> {
       let container = this._containers.get(aNode);
       if (!container) {
         return;
       }
       this.htmlEditor.show(container.tagLine, oldValue);
-      this.htmlEditor.once("popup-hidden", (e, aCommit, aValue) => {
+      this.htmlEditor.once("popuphidden", (e, aCommit, aValue) => {
+        // Need to focus the <html> element instead of the frame / window
+        // in order to give keyboard focus back to doc (from editor).
+        this._frame.contentDocument.documentElement.focus();
+
         if (aCommit) {
           this.updateNodeOuterHTML(aNode, aValue, oldValue);
         }
       });
     });
   },
 
   /**
diff --git a/browser/devtools/markupview/test/browser_inspector_markup_edit_outerhtml.js b/browser/devtools/markupview/test/browser_inspector_markup_edit_outerhtml.js
--- a/browser/devtools/markupview/test/browser_inspector_markup_edit_outerhtml.js
+++ b/browser/devtools/markupview/test/browser_inspector_markup_edit_outerhtml.js
@@ -141,16 +141,17 @@ function test() {
       }
     }
   ];
   content.location = "data:text/html," +
     "<!DOCTYPE html>" +
     "<head><meta charset='utf-8' /></head>" +
     "<body>" +
     [outer.oldHTML for (outer of outerHTMLs) ].join("\n") +
+    "<div id=\"keyboard\"></div>" +
     "</body>" +
     "</html>";
 
   function setupTest() {
     var target = TargetFactory.forTab(gBrowser.selectedTab);
     gDevTools.showToolbox(target, "inspector").then(function(toolbox) {
       inspector = toolbox.getCurrentPanel();
       inspector.once("inspector-updated", startTests);
@@ -159,17 +160,17 @@ function test() {
 
   function startTests() {
     inspector.markup._frame.focus();
     nextStep(0);
   }
 
   function nextStep(cursor) {
     if (cursor >= outerHTMLs.length) {
-      testBody();
+      testKeyboardShortcuts();
       return;
     }
 
     let currentTestData = outerHTMLs[cursor];
     let selector = currentTestData.selector;
     let oldHTML = currentTestData.oldHTML;
     let newHTML = currentTestData.newHTML;
     let rawNode = doc.querySelector(selector);
@@ -218,16 +219,44 @@ function test() {
 
       is (inspector.selection.node, rawNode, "Selection is on the correct node");
       inspector.markup.updateNodeOuterHTML(inspector.selection.nodeFront, newHTML, oldHTML);
     });
 
     inspector.selection.setNode(rawNode);
   }
 
+  function testKeyboardShortcuts() {
+
+    let selector = "#keyboard";
+    let oldHTML = '<div id="keyboard"></div>';
+    let newHTML = '<div id="keyboard">Edited</div>'
+    let rawNode = doc.querySelector(selector);
+
+    function onPopupHidden() {
+      inspector.markup.htmlEditor.off("popuphidden", onPopupHidden);
+      ok (!inspector.markup.htmlEditor._visible, "HTML Editor is not visible");
+      ok (false, "Finish implementing this test");
+      testBody();
+    }
+
+    inspector.selection.once("new-node", () => {
+      inspector.markup.htmlEditor.once("popupshown", () => {
+
+        ok (inspector.markup.htmlEditor._visible, "HTML Editor is visible");
+
+        inspector.markup.htmlEditor.on("popuphidden", onPopupHidden);
+        EventUtils.sendKey("ESCAPE", inspector.markup.htmlEditor.doc.defaultView);
+      });
+      EventUtils.sendKey("F2", content);
+    });
+
+    inspector.selection.setNode(rawNode);
+  }
+
   function testBody() {
     let body = doc.querySelector("body");
     let bodyHTML = '<body id="updated"><p></p></body>';
     let bodyFront = inspector.markup.walker.frontForRawNode(body);
     inspector.once("markupmutation", (e, aMutations) => {
       is (doc.querySelector("body").outerHTML, bodyHTML, "<body> HTML has been updated");
       is (doc.querySelectorAll("head").length, 1, "no extra <head>s have been added");
       testHead();
