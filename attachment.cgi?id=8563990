# HG changeset patch
# User Gabriel Luong <gabriel.luong@gmail.com>
# Parent  9ef34ca40f791bcc64d56c04ee896c5226f7d6d4
Bug 1120616 - Part 1: Implement filter styles in rule view r=bgrins

diff --git a/browser/devtools/styleinspector/cssruleview.xhtml b/browser/devtools/styleinspector/cssruleview.xhtml
--- a/browser/devtools/styleinspector/cssruleview.xhtml
+++ b/browser/devtools/styleinspector/cssruleview.xhtml
@@ -30,9 +30,23 @@
       }
       window.onunload = function() {
         if (this.ruleview) {
           this.ruleview.destroy();
         }
       }
     </script>
   </head>
+  <body>
+
+    <div id="root" class="devtools-monospace">
+      <xul:hbox class="devtools-toolbar" flex="1" align="center">
+          <xul:textbox id="ruleview-searchbox"
+                       class="devtools-searchinput devtools-style-searchbox"
+                       type="search" placeholder="&userStylesSearch;" flex="1"/>
+      </xul:hbox>
+    </div>
+
+    <div id="ruleview-container" class="ruleview devtools-monospace">
+    </div>
+
+  </body>
 </html>
diff --git a/browser/devtools/styleinspector/rule-view.js b/browser/devtools/styleinspector/rule-view.js
--- a/browser/devtools/styleinspector/rule-view.js
+++ b/browser/devtools/styleinspector/rule-view.js
@@ -15,16 +15,17 @@
 const {OutputParser} = require("devtools/output-parser");
 const {PrefObserver, PREF_ORIG_SOURCES} = require("devtools/styleeditor/utils");
 const {parseSingleValue, parseDeclarations} = require("devtools/styleinspector/css-parsing-utils");
 const overlays = require("devtools/styleinspector/style-inspector-overlays");

 Cu.import("resource://gre/modules/Services.jsm");
 Cu.import("resource://gre/modules/XPCOMUtils.jsm");

+const FILTER_CHANGED_TIMEOUT = 300;
 const HTML_NS = "http://www.w3.org/1999/xhtml";
 const XUL_NS = "http://www.mozilla.org/keymaster/gatekeeper/there.is.only.xul";
 const PREF_UA_STYLES = "devtools.inspector.showUserAgentStyles";
 const PREF_DEFAULT_COLOR_UNIT = "devtools.defaultColorUnit";

 /**
  * These regular expressions are adapted from firebug's css.js, and are
  * used to parse CSSStyleDeclaration's cssText attribute.
@@ -1108,31 +1109,36 @@
  *        The PageStyleFront for communicating with the remote server.
  * @constructor
  */
 function CssRuleView(aInspector, aDoc, aStore, aPageStyle) {
   this.inspector = aInspector;
   this.doc = aDoc;
   this.store = aStore || {};
   this.pageStyle = aPageStyle;
-  this.element = this.doc.createElementNS(HTML_NS, "div");
-  this.element.className = "ruleview devtools-monospace";
-  this.element.flex = 1;
-
+
+  this._highlightedElements = [];
   this._outputParser = new OutputParser();

   this._buildContextMenu = this._buildContextMenu.bind(this);
+  this._onContextMenu = this._onContextMenu.bind(this);
   this._contextMenuUpdate = this._contextMenuUpdate.bind(this);
   this._onAddRule = this._onAddRule.bind(this);
   this._onSelectAll = this._onSelectAll.bind(this);
   this._onCopy = this._onCopy.bind(this);
   this._onCopyColor = this._onCopyColor.bind(this);
   this._onToggleOrigSources = this._onToggleOrigSources.bind(this);
-
-  this.element.addEventListener("copy", this._onCopy);
+  this._onFilterStyles = this._onFilterStyles.bind(this);
+
+  this.element = this.doc.getElementById("ruleview-container");
+  this.searchField = this.doc.getElementById("ruleview-searchbox");
+
+  this.doc.addEventListener("copy", this._onCopy);
+  this.doc.addEventListener("contextmenu", this._onContextMenu);
+  this.searchField.addEventListener("command", this._onFilterStyles);

   this._handlePrefChange = this._handlePrefChange.bind(this);
   this._onSourcePrefChanged = this._onSourcePrefChanged.bind(this);

   this._prefObserver = new PrefObserver("devtools.");
   this._prefObserver.on(PREF_ORIG_SOURCES, this._onSourcePrefChanged);
   this._prefObserver.on(PREF_UA_STYLES, this._handlePrefChange);
   this._prefObserver.on(PREF_DEFAULT_COLOR_UNIT, this._handlePrefChange);
@@ -1156,16 +1162,19 @@
 }

 exports.CssRuleView = CssRuleView;

 CssRuleView.prototype = {
   // The element that we're inspecting.
   _viewedElement: null,

+  // Used for cancelling timeouts in the style filter.
+  _filterChangedTimeout: null,
+
   /**
    * Build the context menu.
    */
   _buildContextMenu: function() {
     let doc = this.doc.defaultView.parent.document;

     this._contextmenu = doc.createElementNS(XUL_NS, "menupopup");
     this._contextmenu.addEventListener("popupshowing", this._contextMenuUpdate);
@@ -1330,16 +1339,31 @@
       }
     }

     this._colorToCopy = container.dataset["color"];
     return true;
   },

   /**
+   * Context menu handler.
+   */
+  _onContextMenu: function(event) {
+    try {
+      // In the sidebar we do not have this.doc.popupNode so we need to save
+      // the node ourselves.
+      this.doc.popupNode = event.explicitOriginalTarget;
+      this.doc.defaultView.focus();
+      this._contextmenu.openPopupAtScreen(event.screenX, event.screenY, true);
+    } catch(e) {
+      console.error(e);
+    }
+  },
+
+  /**
    * Select all text.
    */
   _onSelectAll: function() {
     let win = this.doc.defaultView;
     let selection = win.getSelection();

     selection.selectAllChildren(this.doc.documentElement);
   },
@@ -1476,31 +1500,55 @@
         if (rule.editor) {
           rule.editor.updateSourceLink();
         }
       }
       this.inspector.emit("rule-view-sourcelinks-updated");
     }
   },

+  /**
+   * Called when the user enters a search term in the filter style search box.
+   */
+  _onFilterStyles: function() {
+    if (this._filterChangedTimeout) {
+      clearTimeout(this._filterChangedTimeout);
+    }
+
+    this._filterChangedTimeout = setTimeout(() => {
+      if (this.searchField.value.length > 0) {
+        this.searchField.setAttribute("filled", true);
+      } else {
+        this.searchField.removeAttribute("filled");
+        this.searchField.classList.remove("devtools-style-searchbox-no-match");
+      }
+
+      this._clearRules();
+      this._createEditors();
+
+      let evt = this.doc.createEvent("Events");
+      evt.initEvent("CssRuleViewFiltered", true, false);
+      this.element.dispatchEvent(evt);
+
+      this._filterChangeTimeout = null;
+    }, FILTER_CHANGED_TIMEOUT);
+  },
+
   destroy: function() {
     this.isDestroyed = true;
     this.clear();

     gDummyPromise = null;

     this._prefObserver.off(PREF_ORIG_SOURCES, this._onSourcePrefChanged);
     this._prefObserver.off(PREF_UA_STYLES, this._handlePrefChange);
     this._prefObserver.off(PREF_DEFAULT_COLOR_UNIT, this._handlePrefChange);
     this._prefObserver.destroy();

-    this.element.removeEventListener("copy", this._onCopy);
-    this._onCopy = null;
-
-    this._outputParser = null;
+    this._outputParser = this._highlightedElements = null;

     // Remove context menu
     if (this._contextmenu) {
       // Destroy the Add Rule menuitem.
       this.menuitemAddRule.removeEventListener("command", this._onAddRule);
       this.menuitemAddRule = null;

       // Destroy the Select All menuitem.
@@ -1525,16 +1573,22 @@
     }

     // We manage the popupNode ourselves so we also need to destroy it.
     this.doc.popupNode = null;

     this.tooltips.destroy();
     this.highlighters.destroy();

+    // Remove bound listeners
+    this.doc.removeEventListener("contextmenu", this._onContextMenu);
+    this.doc.removeEventListener("copy", this._onCopy);
+    this.searchField.removeEventListener("command", this._onFilterStyles);
+    this.searchField = null;
+
     if (this.element.parentNode) {
       this.element.parentNode.removeChild(this.element);
     }

     if (this._elementStyle) {
       this._elementStyle.destroy();
     }

@@ -1766,27 +1820,49 @@
    */
   _createEditors: function() {
     // Run through the current list of rules, attaching
     // their editors in order.  Create editors if needed.
     let lastInheritedSource = "";
     let lastKeyframes = null;
     let seenPseudoElement = false;
     let seenNormalElement = false;
+    let seenSearchTerm = false;
+    let matchSearchTerm = false;
     let container = null;
+    let searchTerm = this.searchField.value.toLowerCase();

     if (!this._elementStyle.rules) {
       return;
     }

+    if (!searchTerm && this._highlightedElements.length > 0) {
+      this.clearHighlight();
+    }
+
     for (let rule of this._elementStyle.rules) {
       if (rule.domRule.system) {
         continue;
       }

+      if (!rule.editor) {
+        rule.editor = new RuleEditor(this, rule);
+      }
+
+      // Handle filter styles if there is a search input
+      if (searchTerm && rule.domRule.type !== ELEMENT_STYLE) {
+        matchSearchTerm = this.highlightRules(rule, searchTerm);
+
+        if (matchSearchTerm && !seenSearchTerm) {
+          seenSearchTerm = true;
+        } else if (!matchSearchTerm) {
+          continue;
+        }
+      }
+
       // Only print header for this element if there are pseudo elements
       if (seenPseudoElement && !seenNormalElement && !rule.pseudoElement) {
         seenNormalElement = true;
         let div = this.doc.createElementNS(HTML_NS, "div");
         div.className = this._getRuleViewHeaderClassName();
         div.textContent = this.selectedElementLabel;
         this.element.appendChild(div);
       }
@@ -1806,26 +1882,88 @@
       }

       let keyframes = rule.keyframes;
       if (keyframes && keyframes != lastKeyframes) {
         lastKeyframes = keyframes;
         container = this.createExpandableContainer(rule.keyframesName);
       }

-      if (!rule.editor) {
-        rule.editor = new RuleEditor(this, rule);
-      }
-
       if (container && (rule.pseudoElement || keyframes)) {
         container.appendChild(rule.editor.element);
       } else {
         this.element.appendChild(rule.editor.element);
       }
     }
+
+    if (searchTerm && !seenSearchTerm) {
+      this.searchField.classList.add("devtools-style-searchbox-no-match");
+    } else {
+      this.searchField.classList.remove("devtools-style-searchbox-no-match");
+    }
+  },
+
+  /**
+   * Highlight rules that matches the given search value and returns a boolean
+   * indicating whether or not rules were highlighted.
+   *
+   * @param {Rule} aRule
+   *        The rule object we're highlighting if its rule selectors or property
+   *        values match the search value.
+   * @param {String} aValue
+   *        The search value.
+   */
+  highlightRules: function(aRule, aValue) {
+    let isHighlighted = false;
+
+    // Highlight search matches in the rule selectors
+    if (aRule.domRule.type === Ci.nsIDOMCSSRule.KEYFRAME_RULE &&
+        aRule.editor.selectorText.textContent.toLowerCase().indexOf(aValue) != -1) {
+      aRule.editor.selectorText.setAttribute("selected", true);
+      this._highlightedElements.push(aRule.editor.selectorText);
+      isHighlighted = true;
+    } else if (aRule.domRule.type !== Ci.nsIDOMCSSRule.KEYFRAME_RULE) {
+      for (let selectorTextNode of aRule.editor.selectorText.childNodes) {
+        if (selectorTextNode.textContent.toLowerCase().indexOf(aValue) != -1) {
+          selectorTextNode.setAttribute("selected", true);
+          this._highlightedElements.push(selectorTextNode);
+          isHighlighted = true;
+        } else {
+          selectorTextNode.removeAttribute("selected");
+        }
+      }
+    }
+
+    // Highlight search matches in the rule properties
+    for (let textProp of aRule.textProps) {
+      // Get the actual property value displayed in the rule view
+      let propertyValue = textProp.editor.valueSpan.textContent;
+
+      if (textProp.name.toLowerCase().indexOf(aValue) != -1 ||
+          propertyValue.toLowerCase().indexOf(aValue) != -1) {
+        textProp.editor.element.setAttribute("selected", true);
+        this._highlightedElements.push(textProp.editor.element);
+        isHighlighted = true;
+      } else {
+        textProp.editor.element.removeAttribute("selected");
+      }
+    }
+
+    return isHighlighted;
+  },
+
+  /**
+   * Clear all search filter highlights in the panel.
+   */
+  clearHighlight: function() {
+    for (let element of this._highlightedElements) {
+      element.removeAttribute("selected");
+    }
+
+    this._highlightedElements = [];
   }
 };

 /**
  * Create a RuleEditor.
  *
  * @param {CssRuleView} aRuleView
  *        The CssRuleView containg the document holding this rule editor.
@@ -1935,32 +2073,16 @@
     this.populate();

     this.closeBrace = createChild(code, "div", {
       class: "ruleview-ruleclose",
       tabindex: this.isEditable ? "0" : "-1",
       textContent: "}"
     });

-    this.element.addEventListener("contextmenu", event => {
-      try {
-        // In the sidebar we do not have this.doc.popupNode so we need to save
-        // the node ourselves.
-        this.doc.popupNode = event.explicitOriginalTarget;
-        let win = this.doc.defaultView;
-        win.focus();
-
-        this.ruleView._contextmenu.openPopupAtScreen(
-          event.screenX, event.screenY, true);
-
-      } catch(e) {
-        console.error(e);
-      }
-    }, false);
-
     if (this.isEditable) {
       code.addEventListener("click", () => {
         let selection = this.doc.defaultView.getSelection();
         if (selection.isCollapsed) {
           this.newProperty();
         }
       }, false);

diff --git a/browser/devtools/styleinspector/ruleview.css b/browser/devtools/styleinspector/ruleview.css
--- a/browser/devtools/styleinspector/ruleview.css
+++ b/browser/devtools/styleinspector/ruleview.css
@@ -1,14 +1,36 @@
 /* This Source Code Form is subject to the terms of the Mozilla Public
  * License, v. 2.0. If a copy of the MPL was not distributed with this
  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */

-#root {
-  display: -moz-box;
+* {
+  box-sizing: border-box;
+}
+
+:root {
+  height: 100%;
+}
+
+body {
+  margin: 0;
+  display : flex;
+  flex-direction: column;
+  height: 100%;
+}
+
+#ruleview-container {
+  -moz-user-select: text;
+  overflow: auto;
+  min-height: 0;
+  flex: 1;
+}
+
+#root .devtools-toolbar {
+  width: 100%;
 }

 .ruleview {
   overflow: auto;
   -moz-user-select: text;
 }

 .ruleview-code {
diff --git a/browser/devtools/styleinspector/style-inspector.js b/browser/devtools/styleinspector/style-inspector.js
--- a/browser/devtools/styleinspector/style-inspector.js
+++ b/browser/devtools/styleinspector/style-inspector.js
@@ -19,17 +19,16 @@
 // This module doesn't currently export any symbols directly, it only
 // registers inspector tools.

 function RuleViewTool(inspector, window, iframe) {
   this.inspector = inspector;
   this.doc = window.document;

   this.view = new RuleView.CssRuleView(inspector, this.doc);
-  this.doc.documentElement.appendChild(this.view.element);

   this.onLinkClicked = this.onLinkClicked.bind(this);
   this.onSelected = this.onSelected.bind(this);
   this.refresh = this.refresh.bind(this);
   this.clearUserProperties = this.clearUserProperties.bind(this);
   this.onPropertyChanged = this.onPropertyChanged.bind(this);
   this.onViewRefreshed = this.onViewRefreshed.bind(this);
   this.onPanelSelected = this.onPanelSelected.bind(this);
@@ -148,18 +147,16 @@
     this.inspector.selection.off("new-node-front", this.onSelected);
     this.inspector.target.off("navigate", this.clearUserProperties);
     this.inspector.sidebar.off("ruleview-selected", this.onPanelSelected);

     this.view.element.removeEventListener("CssRuleViewCSSLinkClicked", this.onLinkClicked);
     this.view.element.removeEventListener("CssRuleViewChanged", this.onPropertyChanged);
     this.view.element.removeEventListener("CssRuleViewRefreshed", this.onViewRefreshed);

-    this.doc.documentElement.removeChild(this.view.element);
-
     this.view.destroy();

     this.view = this.doc = this.inspector = null;
   }
 };

 function ComputedViewTool(inspector, window, iframe) {
   this.inspector = inspector;
diff --git a/browser/devtools/styleinspector/test/browser.ini b/browser/devtools/styleinspector/test/browser.ini
--- a/browser/devtools/styleinspector/test/browser.ini
+++ b/browser/devtools/styleinspector/test/browser.ini
@@ -93,16 +93,20 @@
 [browser_ruleview_original-source-link.js]
 [browser_ruleview_override.js]
 [browser_ruleview_pseudo-element_01.js]
 [browser_ruleview_pseudo-element_02.js]
 skip-if = e10s # Bug 1090340
 [browser_ruleview_refresh-on-attribute-change_01.js]
 [browser_ruleview_refresh-on-attribute-change_02.js]
 [browser_ruleview_refresh-on-style-change.js]
+[browser_ruleview_search-filter_01.js]
+[browser_ruleview_search-filter_02.js]
+[browser_ruleview_search-filter_03.js]
+[browser_ruleview_search-filter_04.js]
 [browser_ruleview_select-and-copy-styles.js]
 [browser_ruleview_selector-highlighter_01.js]
 [browser_ruleview_selector-highlighter_02.js]
 [browser_ruleview_style-editor-link.js]
 skip-if = e10s # bug 1040670 Cannot open inline styles in viewSourceUtils
 [browser_ruleview_urls-clickable.js]
 [browser_ruleview_user-agent-styles.js]
 [browser_ruleview_user-agent-styles-uneditable.js]
diff --git a/browser/devtools/styleinspector/test/browser_ruleview_search-filter_01.js b/browser/devtools/styleinspector/test/browser_ruleview_search-filter_01.js
new file mode 100644
--- /dev/null
+++ b/browser/devtools/styleinspector/test/browser_ruleview_search-filter_01.js
@@ -0,0 +1,56 @@
+/* vim: set ft=javascript ts=2 et sw=2 tw=80: */
+/* Any copyright is dedicated to the Public Domain.
+ http://creativecommons.org/publicdomain/zero/1.0/ */
+
+"use strict";
+
+// Tests that the rule view search filter works properly for property values.
+
+let PAGE_CONTENT = [
+  '<style type="text/css">',
+  '  #testid {',
+  '    background-color: #00F;',
+  '  }',
+  '  .testclass {',
+  '    width: 100%;',
+  '  }',
+  '</style>',
+  '<div id="testid" class="testclass">Styled Node</div>'
+].join("\n");
+
+add_task(function*() {
+  yield addTab("data:text/html;charset=utf-8,test rule view search filter");
+
+  info("Creating the test document");
+  content.document.body.innerHTML = PAGE_CONTENT;
+
+  info("Opening the rule-view");
+  let {toolbox, inspector, view} = yield openRuleView();
+
+  info("Selecting the test node");
+  yield selectNode("#testid", inspector);
+
+  yield testAddTextInFilter(inspector, view);
+});
+
+function* testAddTextInFilter(inspector, ruleView) {
+  info("setting filter text to \"00F\"");
+
+  let searchField = ruleView.searchField;
+  let onRuleViewFiltered = once(ruleView.element, "CssRuleViewFiltered");
+  searchField.focus();
+
+  let win = ruleView.doc.defaultView;
+  EventUtils.synthesizeKey("0", {}, win);
+  EventUtils.synthesizeKey("0", {}, win);
+  EventUtils.synthesizeKey("F", {}, win);
+
+  yield onRuleViewFiltered;
+
+  info("check that the correct rules are visible");
+  is(ruleView.element.children.length, 2, "Should have 2 rules.");
+  is(ruleView.element.children[0]._ruleEditor.rule.selectorText, "element", "First rule is inline element.");
+  is(ruleView.element.children[1]._ruleEditor.rule.selectorText, "#testid", "Second rule is #testid.");
+  ok(ruleView.element.children[1]._ruleEditor.rule.textProps[0].editor.element.getAttribute("selected"),
+    "background-color text property is correctly highlighted.");
+}
diff --git a/browser/devtools/styleinspector/test/browser_ruleview_search-filter_02.js b/browser/devtools/styleinspector/test/browser_ruleview_search-filter_02.js
new file mode 100644
--- /dev/null
+++ b/browser/devtools/styleinspector/test/browser_ruleview_search-filter_02.js
@@ -0,0 +1,59 @@
+/* vim: set ft=javascript ts=2 et sw=2 tw=80: */
+/* Any copyright is dedicated to the Public Domain.
+ http://creativecommons.org/publicdomain/zero/1.0/ */
+
+"use strict";
+
+// Tests that the rule view search filter works properly for property names.
+
+let PAGE_CONTENT = [
+  '<style type="text/css">',
+  '  #testid {',
+  '    font-family: arial;',
+  '    background-color: #00F;',
+  '  }',
+  '  .testclass {',
+  '    width: 100%;',
+  '  }',
+  '</style>',
+  '<div id="testid" class="testclass">Styled Node</div>'
+].join("\n");
+
+add_task(function*() {
+  yield addTab("data:text/html;charset=utf-8,test rule view search filter");
+
+  info("Creating the test document");
+  content.document.body.innerHTML = PAGE_CONTENT;
+
+  info("Opening the rule-view");
+  let {toolbox, inspector, view} = yield openRuleView();
+
+  info("Selecting the test node");
+  yield selectNode("#testid", inspector);
+
+  yield testAddTextInFilter(inspector, view);
+});
+
+function* testAddTextInFilter(inspector, ruleView) {
+  info("setting filter text to \"color\"");
+
+  let searchField = ruleView.searchField;
+  let onRuleViewFiltered = once(ruleView.element, "CssRuleViewFiltered");
+  searchField.focus();
+
+  let win = ruleView.doc.defaultView;
+  EventUtils.synthesizeKey("c", {}, win);
+  EventUtils.synthesizeKey("o", {}, win);
+  EventUtils.synthesizeKey("l", {}, win);
+  EventUtils.synthesizeKey("o", {}, win);
+  EventUtils.synthesizeKey("r", {}, win);
+
+  yield onRuleViewFiltered;
+
+  info("check that the correct rules are visible");
+  is(ruleView.element.children.length, 2, "Should have 2 rules.");
+  is(ruleView.element.children[0]._ruleEditor.rule.selectorText, "element", "First rule is inline element.");
+  is(ruleView.element.children[1]._ruleEditor.rule.selectorText, "#testid", "Second rule is #testid.");
+  ok(ruleView.element.children[1]._ruleEditor.rule.textProps[1].editor.element.getAttribute("selected"),
+    "background-color text property is correctly highlighted.");
+}
diff --git a/browser/devtools/styleinspector/test/browser_ruleview_search-filter_03.js b/browser/devtools/styleinspector/test/browser_ruleview_search-filter_03.js
new file mode 100644
--- /dev/null
+++ b/browser/devtools/styleinspector/test/browser_ruleview_search-filter_03.js
@@ -0,0 +1,58 @@
+/* vim: set ft=javascript ts=2 et sw=2 tw=80: */
+/* Any copyright is dedicated to the Public Domain.
+ http://creativecommons.org/publicdomain/zero/1.0/ */
+
+"use strict";
+
+// Tests that the rule view search filter works properly for rule selectors.
+
+let PAGE_CONTENT = [
+  '<style type="text/css">',
+  '  #testid {',
+  '    background-color: #00F;',
+  '  }',
+  '  .testclass {',
+  '    width: 100%;',
+  '  }',
+  '</style>',
+  '<div id="testid" class="testclass">Styled Node</div>'
+].join("\n");
+
+add_task(function*() {
+  yield addTab("data:text/html;charset=utf-8,test rule view search filter");
+
+  info("Creating the test document");
+  content.document.body.innerHTML = PAGE_CONTENT;
+
+  info("Opening the rule-view");
+  let {toolbox, inspector, view} = yield openRuleView();
+
+  info("Selecting the test node");
+  yield selectNode("#testid", inspector);
+
+  yield testAddTextInFilter(inspector, view);
+});
+
+function* testAddTextInFilter(inspector, ruleView) {
+  info("setting filter text to \"#test\"");
+
+  let searchField = ruleView.searchField;
+  let onRuleViewFilter = once(ruleView.element, "CssRuleViewFiltered");
+  searchField.focus();
+
+  let win = ruleView.doc.defaultView;
+  EventUtils.synthesizeKey("#", {}, win);
+  EventUtils.synthesizeKey("t", {}, win);
+  EventUtils.synthesizeKey("e", {}, win);
+  EventUtils.synthesizeKey("s", {}, win);
+  EventUtils.synthesizeKey("t", {}, win);
+
+  yield onRuleViewFilter;
+
+  info("check that the correct rules are visible");
+  is(ruleView.element.children.length, 2, "Should have 2 rules.");
+  is(ruleView.element.children[0]._ruleEditor.rule.selectorText, "element", "First rule is inline element.");
+  is(ruleView.element.children[1]._ruleEditor.rule.selectorText, "#testid", "Second rule is #testid.");
+  ok(ruleView.element.children[1]._ruleEditor.selectorText.children[0].getAttribute("selected"),
+    "#testid selector is highlighted.")
+}
diff --git a/browser/devtools/styleinspector/test/browser_ruleview_search-filter_04.js b/browser/devtools/styleinspector/test/browser_ruleview_search-filter_04.js
new file mode 100644
--- /dev/null
+++ b/browser/devtools/styleinspector/test/browser_ruleview_search-filter_04.js
@@ -0,0 +1,42 @@
+/* vim: set ft=javascript ts=2 et sw=2 tw=80: */
+/* Any copyright is dedicated to the Public Domain.
+ http://creativecommons.org/publicdomain/zero/1.0/ */
+
+"use strict";
+
+// Tests that the rule view search filter works properly for keyframe rule selectors.
+
+const TEST_URI = TEST_URL_ROOT + "doc_keyframeanimation.html";
+
+add_task(function*() {
+  yield addTab(TEST_URI);
+
+  info("Opening the rule-view");
+  let {toolbox, inspector, view} = yield openRuleView();
+
+  info("Selecting the test node");
+  yield selectNode("#boxy", inspector);
+
+  yield testAddTextInFilter(inspector, view);
+});
+
+function* testAddTextInFilter(inspector, ruleView) {
+  info("setting filter text to \"20%\"");
+
+  let searchField = ruleView.searchField;
+  let onRuleViewFilter = once(ruleView.element, "CssRuleViewFiltered");
+  searchField.focus();
+
+  let win = ruleView.doc.defaultView;
+  EventUtils.synthesizeKey("2", {}, win);
+  EventUtils.synthesizeKey("0", {}, win);
+  EventUtils.synthesizeKey("%", {}, win);
+
+  yield onRuleViewFilter;
+
+  info("check that the correct rules are visible");
+  is(ruleView.element.children[0]._ruleEditor.rule.selectorText, "element", "First rule is inline element.");
+  is(ruleView.element.children[2].children[0]._ruleEditor.rule.domRule.keyText, "20%", "Second rule is 20%.");
+  ok(ruleView.element.children[2].children[0]._ruleEditor.selectorText.getAttribute("selected"),
+    "20% selector is highlighted.")
+}
diff --git a/browser/locales/en-US/chrome/browser/devtools/styleinspector.dtd b/browser/locales/en-US/chrome/browser/devtools/styleinspector.dtd
--- a/browser/locales/en-US/chrome/browser/devtools/styleinspector.dtd
+++ b/browser/locales/en-US/chrome/browser/devtools/styleinspector.dtd
@@ -10,17 +10,17 @@

 <!-- LOCALIZATION NOTE (browserStylesLabel): This is the label for the checkbox
   -  that specifies whether the styles that are not from the user's stylesheet
   -  should be displayed or not. -->
 <!ENTITY browserStylesLabel    "Browser styles">

 <!-- LOCALIZATION NOTE (userStylesSearch): This is the placeholder that goes in
   -  the search box when no search term has been entered. -->
-<!ENTITY userStylesSearch      "Search">
+<!ENTITY userStylesSearch      "Filter Styles">

 <!-- LOCALIZATION NOTE (selectedElementLabel): This is the label for the path of
   -  the highlighted element in the web page. This path is based on the document
   -  tree. -->
 <!ENTITY selectedElementLabel  "Selected element:">

 <!-- LOCALIZATION NOTE (noPropertiesFound): In the case where there are no CSS
   -  properties to display e.g. due to search criteria this message is
diff --git a/browser/themes/linux/jar.mn b/browser/themes/linux/jar.mn
--- a/browser/themes/linux/jar.mn
+++ b/browser/themes/linux/jar.mn
@@ -389,16 +389,28 @@
   skin/classic/browser/devtools/app-manager/error.svg                 (../shared/devtools/app-manager/images/error.svg)
   skin/classic/browser/devtools/app-manager/plus.svg                  (../shared/devtools/app-manager/images/plus.svg)
   skin/classic/browser/devtools/app-manager/remove.svg                (../shared/devtools/app-manager/images/remove.svg)
   skin/classic/browser/devtools/app-manager/add.svg                   (../shared/devtools/app-manager/images/add.svg)
   skin/classic/browser/devtools/app-manager/index-icons.svg           (../shared/devtools/app-manager/images/index-icons.svg)
   skin/classic/browser/devtools/app-manager/rocket.svg                (../shared/devtools/app-manager/images/rocket.svg)
   skin/classic/browser/devtools/app-manager/noise.png                 (../shared/devtools/app-manager/images/noise.png)
   skin/classic/browser/devtools/app-manager/default-app-icon.png      (../shared/devtools/app-manager/images/default-app-icon.png)
+  skin/classic/browser/devtools/search-clear-failed-small.png         (../shared/devtools/images/search-clear-failed-small.png)
+  skin/classic/browser/devtools/search-clear-failed-small@2x.png      (../shared/devtools/images/search-clear-failed-small@2x.png)
+  skin/classic/browser/devtools/search-clear-failed.png               (../shared/devtools/images/search-clear-failed.png)
+  skin/classic/browser/devtools/search-clear-failed@2x.png            (../shared/devtools/images/search-clear-failed@2x.png)
+  skin/classic/browser/devtools/search-clear-light-small.png          (../shared/devtools/images/search-clear-light-small.png)
+  skin/classic/browser/devtools/search-clear-light-small@2x.png       (../shared/devtools/images/search-clear-light-small@2x.png)
+  skin/classic/browser/devtools/search-clear-light.png                (../shared/devtools/images/search-clear-light.png)
+  skin/classic/browser/devtools/search-clear-light@2x.png             (../shared/devtools/images/search-clear-light@2x.png)
+  skin/classic/browser/devtools/search-clear-dark-small.png           (../shared/devtools/images/search-clear-dark-small.png)
+  skin/classic/browser/devtools/search-clear-dark-small@2x.png        (../shared/devtools/images/search-clear-dark-small@2x.png)
+  skin/classic/browser/devtools/search-clear-dark.png                 (../shared/devtools/images/search-clear-dark.png)
+  skin/classic/browser/devtools/search-clear-dark@2x.png              (../shared/devtools/images/search-clear-dark@2x.png)
 #ifdef MOZ_SERVICES_SYNC
   skin/classic/browser/sync-16.png
   skin/classic/browser/sync-32.png
   skin/classic/browser/sync-bg.png
   skin/classic/browser/sync-128.png
   skin/classic/browser/sync-desktopIcon.png
   skin/classic/browser/sync-horizontalbar.png
   skin/classic/browser/sync-mobileIcon.png
diff --git a/browser/themes/osx/jar.mn b/browser/themes/osx/jar.mn
--- a/browser/themes/osx/jar.mn
+++ b/browser/themes/osx/jar.mn
@@ -521,17 +521,28 @@
   skin/classic/browser/devtools/app-manager/error.svg                 (../shared/devtools/app-manager/images/error.svg)
   skin/classic/browser/devtools/app-manager/plus.svg                  (../shared/devtools/app-manager/images/plus.svg)
   skin/classic/browser/devtools/app-manager/remove.svg                (../shared/devtools/app-manager/images/remove.svg)
   skin/classic/browser/devtools/app-manager/add.svg                   (../shared/devtools/app-manager/images/add.svg)
   skin/classic/browser/devtools/app-manager/index-icons.svg           (../shared/devtools/app-manager/images/index-icons.svg)
   skin/classic/browser/devtools/app-manager/rocket.svg                (../shared/devtools/app-manager/images/rocket.svg)
   skin/classic/browser/devtools/app-manager/noise.png                 (../shared/devtools/app-manager/images/noise.png)
   skin/classic/browser/devtools/app-manager/default-app-icon.png      (../shared/devtools/app-manager/images/default-app-icon.png)
-
+  skin/classic/browser/devtools/search-clear-failed-small.png         (../shared/devtools/images/search-clear-failed-small.png)
+  skin/classic/browser/devtools/search-clear-failed-small@2x.png      (../shared/devtools/images/search-clear-failed-small@2x.png)
+  skin/classic/browser/devtools/search-clear-failed.png               (../shared/devtools/images/search-clear-failed.png)
+  skin/classic/browser/devtools/search-clear-failed@2x.png            (../shared/devtools/images/search-clear-failed@2x.png)
+  skin/classic/browser/devtools/search-clear-light-small.png          (../shared/devtools/images/search-clear-light-small.png)
+  skin/classic/browser/devtools/search-clear-light-small@2x.png       (../shared/devtools/images/search-clear-light-small@2x.png)
+  skin/classic/browser/devtools/search-clear-light.png                (../shared/devtools/images/search-clear-light.png)
+  skin/classic/browser/devtools/search-clear-light@2x.png             (../shared/devtools/images/search-clear-light@2x.png)
+  skin/classic/browser/devtools/search-clear-dark-small.png           (../shared/devtools/images/search-clear-dark-small.png)
+  skin/classic/browser/devtools/search-clear-dark-small@2x.png        (../shared/devtools/images/search-clear-dark-small@2x.png)
+  skin/classic/browser/devtools/search-clear-dark.png                 (../shared/devtools/images/search-clear-dark.png)
+  skin/classic/browser/devtools/search-clear-dark@2x.png              (../shared/devtools/images/search-clear-dark@2x.png)
 #ifdef MOZ_SERVICES_SYNC
   skin/classic/browser/sync-16.png
   skin/classic/browser/sync-32.png
   skin/classic/browser/sync-bg.png
   skin/classic/browser/sync-128.png
   skin/classic/browser/sync-desktopIcon.png
   skin/classic/browser/sync-horizontalbar.png
   skin/classic/browser/sync-horizontalbar@2x.png
diff --git a/browser/themes/shared/devtools/computedview.css b/browser/themes/shared/devtools/computedview.css
--- a/browser/themes/shared/devtools/computedview.css
+++ b/browser/themes/shared/devtools/computedview.css
@@ -148,17 +148,16 @@
 }

 .legendKey {
   margin: 0 5px;
 }

 #root .devtools-toolbar {
   width: 100%;
-  border-bottom-width: 0;
 }

 .link {
   padding: 0 3px;
   cursor: pointer;
   float: right;
 }

diff --git a/browser/themes/shared/devtools/images/search-clear-dark-small.png b/browser/themes/shared/devtools/images/search-clear-dark-small.png
new file mode 100644
index e69de29bb2d1d6434b8b29ae775ad8c2e48c5391..287316cc240731d9efcbad8fd6403e56e87a6d45
GIT binary patch
literal 307
zc$@(<0nGl1P)<h;3K|Lk000e1NJLTq000;O000aK1^@s6crbl+0002`Nkl<ZcmcK3
zF-ikb5CG7Z-R(rHAn^pEkU|XTS#0(iDkxU!9a3rG0jxZPu?cvDM7IpYK+vGV6rW(R
zzi?oRzq}b{2DSq*Uo1-u(8o5Q!5Gi@0)X3_>sG#Vae3wR?0gF+==nR|@PJt~Z|#ep
z=4FCkFbBW_BlN;lF?nlWVUXa*Shq%jdra|(BOF4Guh0kV25xYNGH@6BAZ(7WumjjY
z9k_wOH8ue~baH%wGzye!@6@bveSs<9Be`LBZT&f*$@K-sfY$`qkx?X!ajvg0!T|<Y
zVK2F19rzgUVdeP$|Iwmgh9RCX!7_3Z--e<&eg|spzX5y@eIvs^DMJ7N002ovPDHLk
FV1k%gfw%ww

diff --git a/browser/themes/shared/devtools/images/search-clear-dark-small@2x.png b/browser/themes/shared/devtools/images/search-clear-dark-small@2x.png
new file mode 100644
index e69de29bb2d1d6434b8b29ae775ad8c2e48c5391..9bc9788139c203d214f23fbfffc3b9a1fc326ed9
GIT binary patch
literal 589
zc$@)E0<!&yP)<h;3K|Lk000e1NJLTq001xm000;W1^@s6y#0RM0006MNkl<Zcmds*
zziSjx6h`L-NkBnG5Y$c-EH<eGu~67Tu}PI!YMIJHuu@U6Qd<lC8!R-9m1YZV)ZX1n
zK|2faM;3w*$d2d1U06PN-Wi?Sc;PTpEa%>DXXfpjP1PT2>(}-^4oh$p4#IAjz!-kQ
zXBfc`Xk8EP-}`5Ox_#$vrFH$r%`83#J(zRms9^{L*la#{2YwA;!=K==0t?Wlw&6Lv
zcZToKF98_-G=~e2;BTsim+-bQe20Ds!0?M4Rz?0D4meW%ObyRqD8mQ%Er8wgS708d
z_0H0+La!kI08ij7^yP9tf=wGf%s&l~B}*cIVQJ^2iOP2%S6`Y8;i&}(^Cy<d{hVB#
zxwPLb-2|+piO8)Itih3)OZ|}Ht4MziaK@IjO46+tn#>pE%WzUW0}Bx5&jBuRavZGO
zCaH<s>Z1h+^XCB9IN1x7+eAy{T4M_k=Fb6cak2|4zlkf?+95z4>30GY9w>eAoB)x2
zxrG|ZwaE%BI=4`mKL@zX$+3p=WK5bgv4=QC`gIxg<jb%C>rN9{M&taYAF{{JQdU|5
z*Wj@JkVX2ZTZxO3?o~$R&gwC{)6}g*n7_E0vj(qKUTAVk<hq#)^LyLrFLud_WuG|&
z$=Oba_#<9uHsDR*3yt~z$5%>usXq@rNDaP~5p1-4sqe(E0W^sI?Xd@PZNXRg)a~CY
b?ft(22@+`DKB^tR00000NkvXXu0mjfL01zo

diff --git a/browser/themes/shared/devtools/images/search-clear-dark.png b/browser/themes/shared/devtools/images/search-clear-dark.png
new file mode 100644
index e69de29bb2d1d6434b8b29ae775ad8c2e48c5391..a4c46fa5e17a96ed3d6a3e67c96263bfe8fa0f79
GIT binary patch
literal 406
zc$@*20crk;P)<h;3K|Lk000e1NJLTq001BW000mO1^@s6cL04^00049Nkl<Zcmd7T
zu}Z^09LMn_9ZS(_?E{Ezx(I@Apx`8R69kKcgAbrW#Yy`J4k{vU(n%D215w(=RdkP)
zx@e#h^?UF?IF3ZkWzZjd=q<nApCp&~o|V_AKf=!x#xV$$9`4b>6H?RM+s)MX8{0dc
z%EsnafuC7S!$(p+(Z&_tt&JV}GJtHpgi-t^k2pmvn>+XQ0P`|=mfYY{25|2C-191n
zH3ZN(K@CNyL^#7TbUv`p=3bt@8eopa40Kw!!!YUyaELA@un3)N8Nj)(23TiNF%JR`
z(1V!)tfB;+t_<MZR|7Oy6ztQ8BRoT;jJlM~#4><$KW%`>xNM$rIg2pUmlNRJPr3zf
zI7SFF6|7i)5;8!Lr=Ro?o}-N+DFnvloJ7rj2=ny6JBAA=8TYi6ehl6Fd0s@fxR4i-
zbN|m@#sA}DWQIYi@;Mzt88Ke)fDXbRKF68*UjZM;N@$MZ<NyEw07*qoM6N<$f)Gu!
A7ytkO

diff --git a/browser/themes/shared/devtools/images/search-clear-dark@2x.png b/browser/themes/shared/devtools/images/search-clear-dark@2x.png
new file mode 100644
index e69de29bb2d1d6434b8b29ae775ad8c2e48c5391..754e55694365eb2ac533d4bbeaf3d096eca8cf47
GIT binary patch
literal 724
zc$@*$0xSKAP)<h;3K|Lk000e1NJLTq002M$001Be1^@s6qMd$(0007;Nkl<ZcmeI1
zKa31f9LH~PyMn@<;$}rbqp=ziIYF`t(HsRrp>$U%C4%Hcg@W>~qLd(Vg${+2xa1ld
zS5Z(%ZWTKe&YxRzd?xu_^OE<Qw{GA5n*Ao9%t$6a?|t|7&Fs8nATUcmmn$50!%j$H
z2&z!zH++RAe1i9|3|-6ZTQ{TllgaBh)C;a$y*A9@Fw~&}r4ji8yoPLz6OZNB3t-|K
zI5glOtcU+e4)gF5{&YC;$bO{&`P9!s3f)K(9zzy5`N)2y0487Ka2~cmH}f4Hz+%bd
z<NJLD$R~dRHbaao!F|X)lkc%#3XsVUiadpw`2zQ#?M%M+ey4zA91cM*G6yf50u208
zfc)uS3|MV581BL~IZQz&lQ;9P7I2b(>;o<H@ElIV9?vx&;2|7=255N;Po)4ef5H=9
zm6J<QDUm;ezp&07gd@+PNJG#bR_-$S0ZV^TK%J8_;7bdpU<D-3ARM_QfeF|SzC4iv
z%=|?GCpg&;S{7i&Gl+^uJ{Iu*zL5gV{6zudoa_KK${-S5uI958VCF9hxXj5WP@@cj
z=yD}LqyRI2QNU#R?MEMkE?1LF0cQTN0+iKOS(t(gu=EFi1r)hEh*MCH@D+&SFJA<8
zc_OUngU}a2OMm%oP?wKE6=w87=(j;jf9QkIw05geZc!6ZD|-;K^oKqQ&kC+wTb)PY
zIQU+?w&9KxVCL`S$IvXia^;>u9Pr4MA44|&PJa$BLM`B$v_zi6G_<4uGk^bui1SKp
z97c>@i5d9&FGc&W#kGx*b1>4yKf6aAY>Y(qhi{D?g;B$;v55Zg&CzYLI`4%+2uT~>
z!5p;KxH%fZuN0sZvAR9I3sTq$8==TA_y$e*7;Sqzg8v`0<h4GrXQa6R0000<MNUMn
GLSTYrkVgmr

diff --git a/browser/themes/shared/devtools/images/search-clear-failed-small.png b/browser/themes/shared/devtools/images/search-clear-failed-small.png
new file mode 100644
index e69de29bb2d1d6434b8b29ae775ad8c2e48c5391..7c18a673cb12042126ddff82d55d9720844596b6
GIT binary patch
literal 365
zc$@)k0h0cSP)<h;3K|Lk000e1NJLTq000;O000aK1^@s6crbl+0003rNkl<Zcmbu<
zF-pWx7zE%43E9p{0^$KIQdz}jdlmH*VOa}fAyEhl?*@VhA|5Ek3L6h$6SP_jt)3H@
z2g45mLE!`W`JG=Tn|1N$bw1Cah7LB=ah8EI5-6d9mMYGYxEGgqVGUuznmdlRU<rQ0
zk~{p*84fQnNbn~-^Y<QRkVyC$G!lFRr*b464_rvNg8~MI?{oG5fxD%IJIJA7_zq`B
z+$kM<4h${iNDSYDckXoT*)uekBQbm%uDDZ;gC7X?hz+N2xC3vG*l@bF2ecNgE6~Oq
z&|0)EPpww;VQMMN5nIu<sU_DVT2akEeloRaUH9Cn<sqM#TC}c1eaJKD8SrR2A0+&Z
zyQzFkk4@)|gr7tD*B7n-&x;mia0x5;q7`RTUlj+ifR+}VC2{W;C?DtL<#uGT00000
LNkvXXu0mjfa!Zp-

diff --git a/browser/themes/shared/devtools/images/search-clear-failed-small@2x.png b/browser/themes/shared/devtools/images/search-clear-failed-small@2x.png
new file mode 100644
index e69de29bb2d1d6434b8b29ae775ad8c2e48c5391..ee99701960826cb599325ad8697de6822592d1f7
GIT binary patch
literal 657
zc$@)|0&e|@P)<h;3K|Lk000e1NJLTq001xm000;W1^@s6y#0RM00075Nkl<Zcmc)O
zzi!h|7>4l^Qn9AofLmBt$_^-%GP1x@BMKxdUHBV@Leyg40W;kp;RaB85ABQuBe?>y
z03tEZaFD83e0;|i5tV*f>_qSDemOo)_}kyf_I8FBIK~%z!yF$mjmIt`G}J*C0}OG1
z5gwu+k6l2pSO+q^!%tL>MLajF8GHw?P&$fuZYQ<CEqp~)(;RmZ9GCGDWlbYo@d`Y_
z0#!pxJVP*CMS-%R0@thpcd(Q|pHVsVoMrs1Aht9-9;0;VIR&<~K!&*ld5tx^M`iec
z^C+R?l*!DGB*+b%!)=s?`)H#F9jDIO0&k(=TL@@t2?-w}Eip!jb~OB%&({(fK15m~
z|6O21=Kd4b5F#ld;iDMnL{_H_tjp*;ilGA_B_zCj{sS4M^}x$MDltLZC}D+vgG%h9
zi&Erv2{Zgnl%gBr4XH{k;e=OH^iigkaKfv8;AMs?wS*I1%`ilnTEYphh9Pbbss<%m
zIC9?m9S11A5{co}p<h5}-u_}YEub?m-wD6KtY&yEF-aPs^zd3D_eSWrM)(%mHA+k|
zs1d#uL#LML%QEVQKf=T<;Vh%hQklCYWEtJm8<`#6U1Cq=Mz(3($gJ?*61(@O8(F|u
zu3TY<H%mOl(%4Gq)$7^ewS>8o&ArWBq2a9(5<Yb^*VFK32@S8CxoB5HR5B8lQ+eMK
zyD8gg841fC3f)ex@`2|0iXUjMukw-d-v4@}R2jyJ|BVI44Ib)q6p2?oPkN|V^0Uee
rKcX3q<FQNs@Mo37Xox||&nmwF-}9o}=_jh)00000NkvXXu0mjfA!aC;

diff --git a/browser/themes/shared/devtools/images/search-clear-failed.png b/browser/themes/shared/devtools/images/search-clear-failed.png
new file mode 100644
index e69de29bb2d1d6434b8b29ae775ad8c2e48c5391..a347eba43609596fb5c854b1632e4597b7456ce8
GIT binary patch
literal 444
zc$@*e0Ym<YP)<h;3K|Lk000e1NJLTq001BW000mO1^@s6cL04^0004lNkl<Zcmd7T
z!RiuG6vy!clF%wlon@dTMKi8iyAvF=2dEacYhkmKNszR80(GI#yF_o$QnD9tGvulk
z8OHQo+{N(YE)*B_htGvS_i*lE&OKMtzc0Ps6D+aEFXt<kZqI~jVt@qiowpdEsqy81
zs@UKU3NQBX5qDvtf+0R2^I{Lra7PQM;uDGseMVIde}(KquTd!%utjmD4a^xKyV4M5
zEFsR4ypJ4(b3|Wa&Il1;A<5fFkvUVeC1!!ZSXPqwB@7+pIN}iu&n0$+SQ2+(s3XM`
z4HzPcjg4h5NprMd;sFj4yGJ5PQ`BJM9wri-7|RKT$kBm0Ej`>hVUA3ssKcC^9`4M&
z1(ZL#w4)F|d<B$0yR;({GhYk7BZP^^S_F350=z>26Adi_W8Wow1H(fcq#Z9LcCD8X
zPhq%^iL|5ZyM&Q%45jC}ZwwK^JBHHp6y7ns<ssVM_z;c$`BVJg{1~YaYkb3R{KO7x
mL@=QO#7Hp53}eK;>G%tIvVi69xz4))0000<MNUMnLSTZdBEE(I

diff --git a/browser/themes/shared/devtools/images/search-clear-failed@2x.png b/browser/themes/shared/devtools/images/search-clear-failed@2x.png
new file mode 100644
index e69de29bb2d1d6434b8b29ae775ad8c2e48c5391..cfc478492f1293773856a8ee5cdb70a50b92f1c6
GIT binary patch
literal 809
zc$@(#1J?YBP)<h;3K|Lk000e1NJLTq002M$001Be1^@s6qMd$(0008;Nkl<ZcmeI%
zy-piT9ER~RHeV4mOGS<8Tv4S#qBxdL!MY+cQd$$BNR$Fon5>vGPLmdFE&y&I*I*<N
zp-pZ8OlzXxB9o_Bq-d4DW_D+7Qh@Z^YJ~K@@@T%4>)*xd>Ky7gLJzn28M{RfN2p^C
zDrZxuU>yxK@gdek1M8?@3d)7cpfb7`z&IM9i!zj_05!Cr9kozH;8Va1KH>o;qX)Dx
z1C>$<{~?0TC_)vbv;{2T3MMC4DSr(CcA#^zgTS?b72Lq&>;@}P7K_+}&e<LoZ3UFk
zhZ&K+<(Ckk2|XfB1X2OB_zE*(*O-M$n8XhBi0xwXZw0hr#-t6EP=y|oYO;VO3}Gz3
z=QL)Rm<j<RXp46_jfoKaSwI)Y;xkG(gAshe6f}&*2~?~GZSg-Q@CsV+8bz!@Thty4
zn8&~&d;tnYoIwh&0BZ>Y%wrlYhwud`#3hK~6<{r)g=xj74g<+Il%N2_C5YjH0xn=6
zsiOi7$y-c70f<Ww!vh7pfrg}__;g?_PEiy}kis9sSac9VTWp9W2;m+7Z>ae6U_465
z79QxK0qs#jw(vkh@wtQXC?Q*T;12uH9wlT859}+~!;V7<1#~hTmLh1s5;BAbqSOTl
zb6!{-@-IM`^YZH8P{3W5@PZ;v{ic9>c%g)iv{Rtx5x#(;M+rSNJi-?+;ZZ`vbs3bx
zcW~-aLI<Ho_z)W&C4_DpAtAiO5_y@+Mo0+nutaV<Y=oS)!iQpbxrF!l1tYjmu@znu
z!^<VS#38ic0Mn0yPhcz#li{Tjgz&zHp*1mlq68tlco<SBJ06EGUB)<sA7VMfad_Kh
zj6?Vc3r~3=^6B5Y5CLX!J*F$M7s8d;?$ca}Jzt7GUyCP|bDj>@86HM<bN<-}S)Rt)
z7{X*U^n4ntj_+wqwu~<BVI2Ly36`NeEue-2Xh#RAVZr%v)WIA!ag1~HF^u(bj$>?&
n_<20U7Mh4+O>7}d`#k;|YPuquebBwd00000NkvXXu0mjfr$Sj@

diff --git a/browser/themes/shared/devtools/images/search-clear-light-small.png b/browser/themes/shared/devtools/images/search-clear-light-small.png
new file mode 100644
index e69de29bb2d1d6434b8b29ae775ad8c2e48c5391..869fa500a8515d1f2e14a9c4d4702d455c73d1de
GIT binary patch
literal 350
zc$@)V0iphhP)<h;3K|Lk000e1NJLTq000;O000aK1^@s6crbl+0003cNkl<ZcmcK4
zK}y6>5CqT<`PsTr0x~$D3$LI@P%$}02vKo0L?I~r1B8KzClG?0fG%=DOQ?pTAxnh^
z(lpgWWirA3&dx70xPlsbsyWLbI1x%1V5WhyXnVGN1TCZ$Eq4MP!vU5R2k!8bGaM@D
zB={9dITFdjpJ9^VFL>hrBjkY<Sa^T}I)<Neb_<ESrGy9A!o=_k&KmBNfjuXN7IMVG
zPhiKLnmsQJ-O3RQ-@qq#hQGl(B!9$*(;NK2;*a=n`t}F37Og8$uLoQ$TGv9eR`lX(
zDfEc1$c1kh?vD)mkndeBTGtKuhy3Vj(Yk7V$WgwgcdqkJ!XLPs!^nWvbv{Y>2ju_t
wqK*2ZnGCL>fu0)9)_y7~*uzYF&Z6!80>doQ%yuq5HUIzs07*qoM6N<$f=Pv#qyPW_

diff --git a/browser/themes/shared/devtools/images/search-clear-light-small@2x.png b/browser/themes/shared/devtools/images/search-clear-light-small@2x.png
new file mode 100644
index e69de29bb2d1d6434b8b29ae775ad8c2e48c5391..adbd1ef11f31222e4ba2ecf16f6056de8e5cebf0
GIT binary patch
literal 634
zc$@)x0)_pFP)<h;3K|Lk000e1NJLTq001xm000;W1^@s6y#0RM0006(Nkl<ZcmdUz
zJ#Q017=$-Kf1z-op`d{VYCc4QOB#q!mLd>$h!mI<7LJ8QxV!uT(jn5|8cT`r{XwP}
zBsALF8=Isc($o07Z=PAbw;v9<zgxHO6yOOMfD!l%reFy6`0P3eE7AiI9D^U=49vkd
zQ1jW1T#dE|1=s;!K-EFX?-omnkHIg{bg<xedv1Wc;FBS)Ou>Ca{sH)Dh%0lj)fM0&
zXS7<85<JStzu=5EE3yFFZ2|5j<PQw#0}a7iLD)>lpBmDqi4dC_pa4@5c?Pb4R~h*?
z;40`R+NqG9pNq&_j-6!WD{u|GPP9|+?*Kaq`85zEL`pso4G}>gA5~uJPcrg>Xo&Hj
z0PE5^A6PUH2_f=?Lhq!N*1?9f&UYCrAw-_A{#R+Gjli|M5@K73jQn%0!`cxv!eLAO
zNk;yCqD~ClkSaffDGyk?28|oSl_z!J4qLe)TzN7AGtjspTzN7JJRVeD2w$EYfiuvU
zA+-LmW9+#TKzm-_iGK>9J+JSC6JX@aC;v&bTF95z`iEUDG+07@jYZuMd*IlYXMI0J
zonA)sOJ(#!a2fUGhm>_g#N<ZSCT}dU``$*DmN%Bzlhj5Q60_IO$frZdNmh;$W0|?#
zjC@;&ZJCI1*I}-ok(Ur6?;YlLGx8Eb<awAgj?-+3Jo}(Dj?-Hr0oW3GPGsDIwJz;K
z^Z1f4G%x?>E9KK=F7*+V=B&pRFZGKHztju*v&s<}fx!j;tTF@VWX8`TxS6Z*8?C5K
URlIi4i2wiq07*qoM6N<$f(wTrvj6}9

diff --git a/browser/themes/shared/devtools/images/search-clear-light.png b/browser/themes/shared/devtools/images/search-clear-light.png
new file mode 100644
index e69de29bb2d1d6434b8b29ae775ad8c2e48c5391..b94219124e1950f84e805019c8b8078617d00c13
GIT binary patch
literal 430
zc$@*Q0a5;mP)<h;3K|Lk000e1NJLTq001BW000mO1^@s6cL04^0004XNkl<Zcmd7T
zPs<Wf6vy!cKD7-~N3tBrMXLm%eJvfd*HD`g{4+b51WBKP=q1>+6$Up#qVop(E^aXV
z7(;PU!smi;IQMYRJ$Foh?bmM_7$Cw|XO00HFrnHAk>Z#010mWPU;I<S5RXWd^N5dl
z0uv9I;EY^3XUy?b3#i}|k}G{iMK=G2{7T>PP%L1C<VHi7Gev%*$)5r|Y$SOXF%oBq
zuEcEM!N*CG_mLrY_UKE@3BIuelDG#$4KbFe!|+yO1B8<J0}L%>*yAM(?<F=gmPnGu
zsKUfEEF?BUDoHamVWNSZ#HPlwMj~R=U`|yxch)!}7a3YGr>UDe$I=4i*o*B*#Hy?S
zIrd^Za&ahY!54TiQHK^WLkiv8hly9vBDQ6h@Er`#v5<E3uDFB&3@@;gcIYJ>UmQc}
zdHk0#?39h6^gO#ThMjvJqS2iX(e%H1ivQ`yNO=elVT~1L2;jkl@-fCw9C5%FV{|nB
YHyw+PyV4@FMF0Q*07*qoM6N<$g1@P^-v9sr

diff --git a/browser/themes/shared/devtools/images/search-clear-light@2x.png b/browser/themes/shared/devtools/images/search-clear-light@2x.png
new file mode 100644
index e69de29bb2d1d6434b8b29ae775ad8c2e48c5391..1d499d942b99a4ea24121afc02333a1fb466a5d1
GIT binary patch
literal 792
zc$@(k1LypSP)<h;3K|Lk000e1NJLTq002M$001Be1^@s6qMd$(0008tNkl<ZcmeI%
zKX21O7zXeQv}v=ZlPfVGB&L1<mY@zqVyMFs24EmaffB{ZR6A0Ng+D+LEtz1gJGBsr
z`+_{fgM?h&tJgj!9cZOr2kZP^o;PR5e~k9;!NbQ*IDjJ<LJXfM=C&h_X@aTQE_7fF
z3&`OY<=i&rm|bmM&7d~)U=EqmocpwE2p+%$uD~i?ai74a0bB44QphSwq03sPq$a$D
z71)YaFpyTH^sRq{tPZTzF8QsWgRRNAYc;qgKY^@fCz>S*kKh7q%`RA5Y(N`g$krt0
z9MU(RgI$vx0#^gJRm<Mr2(}%^{5P;`w&Ywl8qkGoL%LuJ24FX2P;5Y3dA6U{G$t(^
z3W4%$|D&ccD+vB=Ku__ZpTj+PDU5jo_u)`cuLp)EiVr<x?U^tpgDrTis5kxFfE}1C
z!Z*OUo51i4rD(#ObGH;1Im5#IGa<You?d{BWq9eD2_~G>5U>f3@YH}0Qf<!N0W0`^
zqc)r13QrCA3RciD_!lacYv0ubA-tw;2$5pBCXV@MLin+wZe+N;GLI%y3Qt2=fc0oX
zrSP;cESz~Xp;CBC;1aAy6DozLOH=-4hfVMdPicjlokW;FDtoh}Z-9KllYSli8z7wR
zg%hK?0f}$;!iVUu?+{>kdH$sAAu#j^-{7RmCU~3#8D2SmQsyKWdV~+5@6m)1B9HJ9
zBpywOR2M?7@QR<v<2o*cT;UZzk!P9<A<d=mp)0)5geUM>sCioAQuviCywHRf@LQ;P
z4XrXaLx)26ViOo%eKRx#t7t+YysHUvc$!wZ9X{5KQG`!nufpx{nP!Y4{0jE}=LaJ1
zT#v*?xBN(KxuHj5J9iI7>F%+(@M2_C>#{HZVq{tKvJa}f8tdNjtFggmUX982pa-Yg
z;2hiIzQ)r&OyIgi@SiZ{zD82^8##aw-a`y2#oQLI`Stiy7{eFHVMRH&jX6gBdi)RQ
W-%tq)Q@(!y0000<MNUMnLSTXvVQ&ur

diff --git a/browser/themes/shared/devtools/ruleview.css b/browser/themes/shared/devtools/ruleview.css
--- a/browser/themes/shared/devtools/ruleview.css
+++ b/browser/themes/shared/devtools/ruleview.css
@@ -210,16 +210,28 @@
 .ruleview-property  > * {
   vertical-align: middle;
 }

 .ruleview-property[dirty] {
   border-left-color: var(--theme-highlight-green);
 }

+.theme-light .ruleview-property[selected],
+.theme-light .ruleview-selector[selected],
+.theme-light .ruleview-selector > span[selected] {
+  background-color: #ffee99;
+}
+
+.theme-dark .ruleview-property[selected],
+.theme-dark .ruleview-selector[selected],
+.theme-dark .ruleview-selector > span[selected] {
+  background-color: #483d22;
+}
+
 .ruleview-namecontainer > .ruleview-propertyname,
 .ruleview-propertycontainer > .ruleview-propertyvalue {
   border-bottom: 1px dashed transparent;
 }

 .ruleview-namecontainer:hover > .ruleview-propertyname,
 .ruleview-propertycontainer:hover > .ruleview-propertyvalue {
   border-bottom-color: hsl(0,0%,50%);
diff --git a/browser/themes/shared/devtools/toolbars.inc.css b/browser/themes/shared/devtools/toolbars.inc.css
--- a/browser/themes/shared/devtools/toolbars.inc.css
+++ b/browser/themes/shared/devtools/toolbars.inc.css
@@ -322,53 +322,108 @@
   border-color: var(--theme-splitter-color);
 }

 .devtools-searchinput {
   margin-top: 1px;
   margin-bottom: 1px;
   padding: 0;
   -moz-padding-start: 22px;
-  -moz-padding-end: 12px;
+  -moz-padding-end: 4px;
   background-position: 8px center;
   background-size: 11px 11px;
   background-repeat: no-repeat;
   font-size: inherit;
 }

 .theme-dark .devtools-searchinput {
   background-image: url(magnifying-glass.png);
 }

 .theme-light .devtools-searchinput {
   background-image: url(magnifying-glass-light.png);
 }

+.devtools-searchinput:-moz-locale-dir(rtl) {
+  background-position: calc(100% - 8px) center;
+}
+
+.theme-dark .devtools-style-searchbox[filled] {
+  background-color: #483d22;
+  border-color: #d89b28;
+}
+
+.theme-light .devtools-style-searchbox[filled] {
+  background-color: #ffee99;
+  border-color: #ffbf00;
+}
+
+.theme-dark .devtools-searchinput > .textbox-input-box > .textbox-search-icons > .textbox-search-clear {
+  list-style-image: url("chrome://browser/skin/devtools/search-clear-dark.png");
+  -moz-image-region: rect(0, 16px, 16px, 0);
+}
+
+.theme-light .devtools-searchinput > .textbox-input-box > .textbox-search-icons > .textbox-search-clear {
+  list-style-image: url("chrome://browser/skin/devtools/search-clear-light.png");
+  -moz-image-region: rect(0, 16px, 16px, 0);
+}
+
+.devtools-style-searchbox-no-match > .textbox-input-box > .textbox-search-icons > .textbox-search-clear {
+  list-style-image: url("chrome://browser/skin/devtools/search-clear-failed.png") !important;
+  -moz-image-region: rect(0, 16px, 16px, 0);
+}
+
+.devtools-searchinput > .textbox-input-box > .textbox-search-icons > .textbox-search-clear:hover {
+  -moz-image-region: rect(0, 32px, 16px, 16px);
+}
+
+.theme-light .devtools-style-searchbox-no-match {
+  background-color: #fd919b !important;
+  border-color: #a45e64 !important;
+  color: #fff;
+}
+
+.theme-dark .devtools-style-searchbox-no-match {
+  background-color: #3c2124 !important;
+  border-color: #cc3d3d !important;
+  color: #fff;
+}
+
+.devtools-no-search-result {
+  border-color: var(--theme-highlight-red) !important;
+}
+
 @media (min-resolution: 2dppx) {
   .theme-dark .devtools-searchinput {
     background-image: url(magnifying-glass@2x.png);
   }

   .theme-light .devtools-searchinput {
     background-image: url(magnifying-glass-light@2x.png);
   }
+
+  .theme-dark .devtools-searchinput > .textbox-input-box > .textbox-search-icons > .textbox-search-clear {
+    list-style-image: url("chrome://browser/skin/devtools/search-clear-dark@2x.png");
+    -moz-image-region: rect(0, 32px, 32px, 0);
+  }
+
+  .theme-light .devtools-searchinput > .textbox-input-box > .textbox-search-icons > .textbox-search-clear {
+    list-style-image: url("chrome://browser/skin/devtools/search-clear-light@2x.png");
+    -moz-image-region: rect(0, 32px, 32px, 0);
+  }
+
+  .devtools-style-searchbox-no-match > .textbox-input-box > .textbox-search-icons > .textbox-search-clear {
+    list-style-image: url("chrome://browser/skin/devtools/search-clear-failed@2x.png") !important;
+    -moz-image-region: rect(0, 32px, 32px, 0);
+  }
+
+  .devtools-searchinput > .textbox-input-box > .textbox-search-icons > .textbox-search-clear:hover {
+    -moz-image-region: rect(0, 64px, 32px, 32px);
+  }
 }
-
-.devtools-searchinput:-moz-locale-dir(rtl) {
-  background-position: calc(100% - 8px) center;
-}
-
-.devtools-searchinput > .textbox-input-box > .textbox-search-icons {
-  display: none;
-}
-
-.devtools-no-search-result {
-  border-color: var(--theme-highlight-red) !important;
-}
-
 /* Close button */

 .devtools-closebutton {
   -moz-appearance: none;
   border: none;
   margin: 0 4px;
   min-width: 16px;
   width: 16px;
diff --git a/browser/themes/windows/jar.mn b/browser/themes/windows/jar.mn
--- a/browser/themes/windows/jar.mn
+++ b/browser/themes/windows/jar.mn
@@ -426,17 +426,28 @@
         skin/classic/browser/devtools/app-manager/error.svg                 (../shared/devtools/app-manager/images/error.svg)
         skin/classic/browser/devtools/app-manager/plus.svg                  (../shared/devtools/app-manager/images/plus.svg)
         skin/classic/browser/devtools/app-manager/remove.svg                (../shared/devtools/app-manager/images/remove.svg)
         skin/classic/browser/devtools/app-manager/add.svg                   (../shared/devtools/app-manager/images/add.svg)
         skin/classic/browser/devtools/app-manager/index-icons.svg           (../shared/devtools/app-manager/images/index-icons.svg)
         skin/classic/browser/devtools/app-manager/rocket.svg                (../shared/devtools/app-manager/images/rocket.svg)
         skin/classic/browser/devtools/app-manager/noise.png                 (../shared/devtools/app-manager/images/noise.png)
         skin/classic/browser/devtools/app-manager/default-app-icon.png      (../shared/devtools/app-manager/images/default-app-icon.png)
-
+        skin/classic/browser/devtools/search-clear-failed-small.png         (../shared/devtools/images/search-clear-failed-small.png)
+        skin/classic/browser/devtools/search-clear-failed-small@2x.png      (../shared/devtools/images/search-clear-failed-small@2x.png)
+        skin/classic/browser/devtools/search-clear-failed.png               (../shared/devtools/images/search-clear-failed.png)
+        skin/classic/browser/devtools/search-clear-failed@2x.png            (../shared/devtools/images/search-clear-failed@2x.png)
+        skin/classic/browser/devtools/search-clear-light-small.png          (../shared/devtools/images/search-clear-light-small.png)
+        skin/classic/browser/devtools/search-clear-light-small@2x.png       (../shared/devtools/images/search-clear-light-small@2x.png)
+        skin/classic/browser/devtools/search-clear-light.png                (../shared/devtools/images/search-clear-light.png)
+        skin/classic/browser/devtools/search-clear-light@2x.png             (../shared/devtools/images/search-clear-light@2x.png)
+        skin/classic/browser/devtools/search-clear-dark-small.png           (../shared/devtools/images/search-clear-dark-small.png)
+        skin/classic/browser/devtools/search-clear-dark-small@2x.png        (../shared/devtools/images/search-clear-dark-small@2x.png)
+        skin/classic/browser/devtools/search-clear-dark.png                 (../shared/devtools/images/search-clear-dark.png)
+        skin/classic/browser/devtools/search-clear-dark@2x.png              (../shared/devtools/images/search-clear-dark@2x.png)
 #ifdef MOZ_SERVICES_SYNC
         skin/classic/browser/sync-16.png
         skin/classic/browser/sync-32.png
         skin/classic/browser/sync-128.png
         skin/classic/browser/sync-bg.png
         skin/classic/browser/sync-desktopIcon.png
         skin/classic/browser/sync-horizontalbar.png
         skin/classic/browser/sync-horizontalbar-XPVista7.png
@@ -898,16 +909,28 @@
         skin/classic/aero/browser/devtools/app-manager/error.svg                 (../shared/devtools/app-manager/images/error.svg)
         skin/classic/aero/browser/devtools/app-manager/plus.svg                  (../shared/devtools/app-manager/images/plus.svg)
         skin/classic/aero/browser/devtools/app-manager/remove.svg                (../shared/devtools/app-manager/images/remove.svg)
         skin/classic/aero/browser/devtools/app-manager/add.svg                   (../shared/devtools/app-manager/images/add.svg)
         skin/classic/aero/browser/devtools/app-manager/index-icons.svg           (../shared/devtools/app-manager/images/index-icons.svg)
         skin/classic/aero/browser/devtools/app-manager/rocket.svg                (../shared/devtools/app-manager/images/rocket.svg)
         skin/classic/aero/browser/devtools/app-manager/noise.png                 (../shared/devtools/app-manager/images/noise.png)
         skin/classic/aero/browser/devtools/app-manager/default-app-icon.png      (../shared/devtools/app-manager/images/default-app-icon.png)
+        skin/classic/aero/browser/devtools/search-clear-failed-small.png         (../shared/devtools/images/search-clear-failed-small.png)
+        skin/classic/aero/browser/devtools/search-clear-failed-small@2x.png      (../shared/devtools/images/search-clear-failed-small@2x.png)
+        skin/classic/aero/browser/devtools/search-clear-failed.png               (../shared/devtools/images/search-clear-failed.png)
+        skin/classic/aero/browser/devtools/search-clear-failed@2x.png            (../shared/devtools/images/search-clear-failed@2x.png)
+        skin/classic/aero/browser/devtools/search-clear-light-small.png          (../shared/devtools/images/search-clear-light-small.png)
+        skin/classic/aero/browser/devtools/search-clear-light-small@2x.png       (../shared/devtools/images/search-clear-light-small@2x.png)
+        skin/classic/aero/browser/devtools/search-clear-light.png                (../shared/devtools/images/search-clear-light.png)
+        skin/classic/aero/browser/devtools/search-clear-light@2x.png             (../shared/devtools/images/search-clear-light@2x.png)
+        skin/classic/aero/browser/devtools/search-clear-dark-small.png           (../shared/devtools/images/search-clear-dark-small.png)
+        skin/classic/aero/browser/devtools/search-clear-dark-small@2x.png        (../shared/devtools/images/search-clear-dark-small@2x.png)
+        skin/classic/aero/browser/devtools/search-clear-dark.png                 (../shared/devtools/images/search-clear-dark.png)
+        skin/classic/aero/browser/devtools/search-clear-dark@2x.png              (../shared/devtools/images/search-clear-dark@2x.png)
 #ifdef MOZ_SERVICES_SYNC
         skin/classic/aero/browser/sync-16.png
         skin/classic/aero/browser/sync-32.png
         skin/classic/aero/browser/sync-128.png
         skin/classic/aero/browser/sync-bg.png
         skin/classic/aero/browser/sync-desktopIcon.png
         skin/classic/aero/browser/sync-horizontalbar.png
         skin/classic/aero/browser/sync-horizontalbar-XPVista7.png
