# HG changeset patch
# User Brian Grinstead <bgrinstead@mozilla.com>
# Date 1567028994 25200
#      Wed Aug 28 14:49:54 2019 -0700
# Node ID 7b7981d2d875f7e074ac34748a730399207c65f1
# Parent  6a0fa53322cc7c67fe5a7ffe39d021092f6c5357
Bug 1573158 - Share one fragment across all consumers of places-popup

This will avoid parsing the markup strings into fragments for every consumer.

Differential Revision: https://phabricator.services.mozilla.com/D43846

diff --git a/browser/components/places/content/places-menupopup.js b/browser/components/places/content/places-menupopup.js
--- a/browser/components/places/content/places-menupopup.js
+++ b/browser/components/places/content/places-menupopup.js
@@ -70,41 +70,42 @@
             padding-top: 4px;
           }
         `;
         default:
           return s;
       }
     }
 
-    get markup() {
-      return `
-      <html:link rel="stylesheet" href="chrome://global/skin/global.css" />
-      <html:style>${this.commonStyles}${this.styles}</html:style>
-      <hbox flex="1" part="innerbox">
-        <vbox part="drop-indicator-bar" hidden="true">
-          <image part="drop-indicator" mousethrough="always"></image>
-        </vbox>
-        <arrowscrollbox class="popup-internal-box" flex="1" orient="vertical"
-                        smoothscroll="false" part="popupbox">
-          <html:slot></html:slot>
-        </arrowscrollbox>
-      </hbox>
-    `;
+    get fragment() {
+      if (!this.constructor.hasOwnProperty("_fragment")) {
+        this.constructor._fragment = MozXULElement.parseXULToFragment(`
+        <html:link rel="stylesheet" href="chrome://global/skin/global.css" />
+        <html:style>${this.commonStyles}${this.styles}</html:style>
+        <hbox flex="1" part="innerbox">
+          <vbox part="drop-indicator-bar" hidden="true">
+            <image part="drop-indicator" mousethrough="always"></image>
+          </vbox>
+          <arrowscrollbox class="popup-internal-box" flex="1" orient="vertical"
+                          smoothscroll="false" part="popupbox">
+            <html:slot></html:slot>
+          </arrowscrollbox>
+        </hbox>
+      `);
+      }
+      return document.importNode(this.constructor._fragment, true);
     }
 
     connectedCallback() {
       if (this.delayConnectedCallback()) {
         return;
       }
 
       this.shadowRoot.textContent = "";
-      this.shadowRoot.appendChild(
-        MozXULElement.parseXULToFragment(this.markup)
-      );
+      this.shadowRoot.appendChild(this.fragment);
 
       this._indicatorBar = this.shadowRoot.querySelector(
         "[part=drop-indicator-bar]"
       );
       this._scrollBox = this.shadowRoot.querySelector(".popup-internal-box");
 
       /**
        * Sub-menus should be opened when the mouse drags over them, and closed
@@ -633,36 +634,40 @@
     static get inheritedAttributes() {
       return {
         ".panel-arrowcontainer": "side,panelopen",
         ".panel-arrow": "side",
         ".panel-arrowcontent": "side,align,dir,orient,pack",
       };
     }
 
-    get markup() {
-      return `
-      <html:link rel="stylesheet" href="chrome://global/skin/global.css" />
-      <html:style>${this.commonStyles}</html:style>
-      <vbox class="panel-arrowcontainer" flex="1">
-        <box class="panel-arrowbox">
-          <image class="panel-arrow"></image>
-        </box>
-        <box class="panel-arrowcontent" part="arrowcontent" flex="1">
-          <vbox part="drop-indicator-bar" hidden="true">
-            <image part="drop-indicator" mousethrough="always"></image>
-          </vbox>
-          <arrowscrollbox class="popup-internal-box" flex="1"
-                          orient="vertical" smoothscroll="false"
-                          part="popupbox">
-            <html:slot></html:slot>
-          </arrowscrollbox>
-        </box>
-      </vbox>
-    `;
+    get fragment() {
+      if (!this.constructor.hasOwnProperty("_fragment")) {
+        this.constructor._fragment = MozXULElement.parseXULToFragment(`
+        <html:link rel="stylesheet" href="chrome://global/skin/global.css" />
+        <html:style>${this.commonStyles}</html:style>
+        <vbox class="panel-arrowcontainer" flex="1">
+          <box class="panel-arrowbox">
+            <image class="panel-arrow"></image>
+          </box>
+          <box class="panel-arrowcontent" part="arrowcontent" flex="1">
+            <vbox part="drop-indicator-bar" hidden="true">
+              <image part="drop-indicator" mousethrough="always"></image>
+            </vbox>
+            <arrowscrollbox class="popup-internal-box" flex="1"
+                            orient="vertical" smoothscroll="false"
+                            part="popupbox">
+              <html:slot></html:slot>
+            </arrowscrollbox>
+          </box>
+        </vbox>
+      `);
+      }
+
+      return document.importNode(this.constructor._fragment, true);
     }
 
     connectedCallback() {
       if (this.delayConnectedCallback()) {
         return;
       }
 
       super.connectedCallback();
