# HG changeset patch
# User Brian Grinstead <bgrinstead@mozilla.com>
# Date 1567028994 25200
#      Wed Aug 28 14:49:54 2019 -0700
# Node ID 457898d79250904ca2b7e28aba95e4544d45ffe7
# Parent  b8f6e6b97c2edc0826539d3c8744ab0db6a6e866
Bug 1573158 - Share one fragment across all consumers of places-popup

This will avoid parsing the markup strings into fragments for every consumer.

Differential Revision: https://phabricator.services.mozilla.com/D43846

diff --git a/browser/components/places/content/places-menupopup.js b/browser/components/places/content/places-menupopup.js
--- a/browser/components/places/content/places-menupopup.js
+++ b/browser/components/places/content/places-menupopup.js
@@ -29,16 +29,25 @@
       ];
       for (let event_name of event_names) {
         this.addEventListener(event_name, ev => this[`on_${event_name}`](ev));
       }
 
       this.attachShadow({ mode: "open" });
     }
 
+    get fragment() {
+      if (!this.constructor.hasOwnProperty("_fragment")) {
+        this.constructor._fragment = MozXULElement.parseXULToFragment(
+          this.markup
+        );
+      }
+      return document.importNode(this.constructor._fragment, true);
+    }
+
     get markup() {
       return `
       <html:link rel="stylesheet" href="chrome://global/skin/global.css" />
       <hbox flex="1" part="innerbox">
         <vbox part="drop-indicator-bar" hidden="true">
           <image part="drop-indicator" mousethrough="always"></image>
         </vbox>
         <arrowscrollbox class="popup-internal-box" flex="1" orient="vertical"
@@ -50,19 +59,17 @@
     }
 
     connectedCallback() {
       if (this.delayConnectedCallback()) {
         return;
       }
 
       this.shadowRoot.textContent = "";
-      this.shadowRoot.appendChild(
-        MozXULElement.parseXULToFragment(this.markup)
-      );
+      this.shadowRoot.appendChild(this.fragment);
 
       this._indicatorBar = this.shadowRoot.querySelector(
         "[part=drop-indicator-bar]"
       );
       this._scrollBox = this.shadowRoot.querySelector(".popup-internal-box");
 
       /**
        * Sub-menus should be opened when the mouse drags over them, and closed
