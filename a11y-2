# HG changeset patch
# User Brian Grinstead <bgrinstead@mozilla.com>
# Parent  f3da8ae9d1a3e74cd273746da51a035ddc572bee

diff --git a/browser/base/content/browser.css b/browser/base/content/browser.css
--- a/browser/base/content/browser.css
+++ b/browser/base/content/browser.css
@@ -59,16 +59,23 @@ body {
 :root[customizing] {
   min-width: -moz-fit-content;
 }
 
 /* Prevent shrinking the page content to 0 height and width */
 .browserStack > browser {
   min-height: 25px;
   min-width: 25px;
+  width: 50%;
+  justify-self: end;
+}
+
+.browserStack > .a11ymode {
+  justify-self: start;
+  width: 50%;
 }
 
 body {
   display: -moz-box;
   -moz-box-orient: vertical;
   -moz-box-flex: 1;
 }
 
diff --git a/browser/base/content/tabbrowser.js b/browser/base/content/tabbrowser.js
--- a/browser/base/content/tabbrowser.js
+++ b/browser/base/content/tabbrowser.js
@@ -2077,32 +2077,52 @@
       remoteType,
       replayExecution,
       sameProcessAsFrameLoader,
       uriIsAboutBlank,
       userContextId,
       skipLoad,
     } = {}) {
       let b = document.createXULElement("browser");
+      // This will let us go from tab to a11ymode browser:
+
+      if (!isPreloadBrowser) {
+        b.a11ymodeBrowser = document.createXULElement("browser");
+        // This will let us go from a11ymode to tab:
+        b.a11ymodeBrowser.linkedBrowser = b;
+      }
+
       // Use the JSM global to create the permanentKey, so that if the
       // permanentKey is held by something after this window closes, it
       // doesn't keep the window alive.
       b.permanentKey = new (Cu.getGlobalForObject(Services)).Object();
 
       const defaultBrowserAttributes = {
         contextmenu: "contentAreaContextMenu",
         datetimepicker: "DateTimePickerPanel",
         message: "true",
         messagemanagergroup: "browsers",
         selectmenulist: "ContentSelectDropdown",
         tooltip: "aHTMLTooltip",
         type: "content",
       };
       for (let attribute in defaultBrowserAttributes) {
         b.setAttribute(attribute, defaultBrowserAttributes[attribute]);
+
+        if (
+          b.a11ymodeBrowser &&
+          attribute != "messagemanagergroup" &&
+          attribute != "message" &&
+          attribute != "type"
+        ) {
+          b.a11ymodeBrowser.setAttribute(
+            attribute,
+            defaultBrowserAttributes[attribute]
+          );
+        }
       }
 
       if (userContextId) {
         b.setAttribute("usercontextid", userContextId);
       }
 
       if (remoteType) {
         b.setAttribute("remoteType", remoteType);
@@ -2121,19 +2141,32 @@
         if (remoteType) {
           throw new Error("Cannot set opener window on a remote browser!");
         }
         b.presetOpenerWindow(openerWindow);
       }
 
       if (!isPreloadBrowser) {
         b.setAttribute("autocompletepopup", "PopupAutoComplete");
+        if (b.a11ymodeBrowser) {
+          b.a11ymodeBrowser.setAttribute(
+            "autocompletepopup",
+            "PopupAutoComplete"
+          );
+        }
       }
       if (this._autoScrollPopup) {
         b.setAttribute("autoscrollpopup", this._autoScrollPopup.id);
+
+        if (b.a11ymodeBrowser) {
+          b.a11ymodeBrowser.setAttribute(
+            "autoscrollpopup",
+            this._autoScrollPopup.id
+          );
+        }
       }
 
       /*
        * This attribute is meant to describe if the browser is the
        * preloaded browser. There are 2 defined states: "preloaded" or
        * "consumed". The order of events goes as follows:
        *   1. The preloaded browser is created and the 'preloadedState'
        *      attribute for that browser is set to "preloaded".
@@ -2155,16 +2188,20 @@
           throw new Error("Cannot have nextRemoteTabId without a remoteType");
         }
         // Gecko is going to read this attribute and use it.
         b.setAttribute("nextRemoteTabId", nextRemoteTabId.toString());
       }
 
       if (sameProcessAsFrameLoader) {
         b.sameProcessAsFrameLoader = sameProcessAsFrameLoader;
+
+        // if (b.a11ymodeBrowser) {
+        //   b.a11ymodeBrowser.sameProcessAsFrameLoader = sameProcessAsFrameLoader;
+        // }
       }
 
       // This will be used by gecko to control the name of the opened
       // window.
       if (name) {
         // XXX: The `name` property is special in HTML and XUL. Should
         // we use a different attribute name for this?
         b.setAttribute("name", name);
@@ -2179,16 +2216,29 @@
       // flex=0 it can't. When the toolbox is on the bottom it's a sibling of
       // browserStack, and when it's on the side it's a sibling of
       // browserContainer.
       let stack = document.createXULElement("stack");
       stack.className = "browserStack";
       stack.appendChild(b);
       stack.setAttribute("flex", "10000");
 
+      if (b.a11ymodeBrowser) {
+        b.a11ymodeBrowser.classList.add("a11ymode");
+        stack.appendChild(b.a11ymodeBrowser);
+      }
+
+      // try {
+      //   a11ymodeBrowser.loadURI("about:a11ymode", {
+      //     triggeringPrincipal: Services.scriptSecurityManager.getSystemPrincipal(),
+      //   });
+      // } catch (ex) {
+      //   Cu.reportError(ex);
+      // }
+
       let browserContainer = document.createXULElement("vbox");
       browserContainer.className = "browserContainer";
       browserContainer.appendChild(notificationbox);
       browserContainer.appendChild(stack);
       browserContainer.setAttribute("flex", "10000");
 
       let browserSidebarContainer = document.createXULElement("hbox");
       browserSidebarContainer.className = "browserSidebarContainer";
@@ -3779,16 +3829,19 @@
       if (this._switcher) {
         this._switcher.onTabRemoved(aTab);
       }
 
       // This will unload the document. An unload handler could remove
       // dependant tabs, so it's important that the tabbrowser is now in
       // a consistent state (tab removed, tab positions updated, etc.).
       browser.remove();
+      if (browser.a11ymodeBrowser) {
+        browser.a11ymodeBrowser.remove();
+      }
 
       // Release the browser in case something is erroneously holding a
       // reference to the tab after its removal.
       this._tabForBrowser.delete(aTab.linkedBrowser);
       aTab.linkedBrowser = null;
 
       panel.remove();
 
@@ -5160,17 +5213,16 @@
           openContextMenu(aMessage);
           break;
         }
         case "Browser:Init": {
           let tab = this.getTabForBrowser(browser);
           if (!tab) {
             return undefined;
           }
-
           this._outerWindowIDBrowserMap.set(browser.outerWindowID, browser);
           browser.sendMessageToActor(
             "Browser:AppTab",
             { isAppTab: tab.pinned },
             "BrowserTab"
           );
           break;
         }
diff --git a/devtools/client/accessibility/accessibility-view.js b/devtools/client/accessibility/accessibility-view.js
--- a/devtools/client/accessibility/accessibility-view.js
+++ b/devtools/client/accessibility/accessibility-view.js
@@ -91,81 +91,141 @@ AccessibilityView.prototype = {
     fluentBundles,
     toolbox,
     getAccessibilityTreeRoot,
     startListeningForAccessibilityEvents,
     stopListeningForAccessibilityEvents,
     audit,
     simulate,
   }) {
-    // Make sure state is reset every time accessibility panel is initialized.
-    await this.store.dispatch(reset(front, supports));
-    const container = document.getElementById("content");
-    const mainFrame = MainFrame({
-      accessibility: front,
-      fluentBundles,
-      toolbox,
-      getAccessibilityTreeRoot,
-      startListeningForAccessibilityEvents,
-      stopListeningForAccessibilityEvents,
-      audit,
-      simulate,
+    // const url = new URL(window.parent.location);
+    // const searchParams = new window.URLSearchParams(url.search);
+
+    // if (searchParams.get("id")) {
+    //   document.querySelector("#content").textContent = searchParams.get("id");
+    // }
+    // console.log(getAccessibilityTreeRoot());
+
+    function throttle(callback, limit) {
+      var wait = false;
+      return function() {
+        if (!wait) {
+          callback.apply(null, arguments);
+          wait = true;
+          setTimeout(function() {
+            wait = false;
+          }, limit);
+        }
+      };
+    }
+
+    async function renderFull() {
+      console.trace();
+      const walkerFront = getAccessibilityTreeRoot();
+      const children = await walkerFront.children();
+      const rootAccessibleFront = children[0];
+      const snapshot = await rootAccessibleFront.snapshot();
+
+      buildAccTree(snapshot);
+    }
+
+    const throttledRender = throttle(renderFull, 1000);
+    startListeningForAccessibilityEvents({
+      reorder: function() {
+        // console.trace(arguments);
+        throttledRender();
+      },
+      "name-change": function() {
+        // console.trace(arguments);
+        throttledRender();
+      },
+      "text-change": function() {
+        // console.trace(arguments);
+        throttledRender();
+      },
+      "document-ready": function() {
+        // console.trace(arguments);
+        throttledRender();
+      },
     });
-    // Render top level component
-    const provider = createElement(Provider, { store: this.store }, mainFrame);
-    this.mainFrame = ReactDOM.render(provider, container);
+    console.log(window.ROLE_MAP);
+
+    await renderFull();
+    // console.trace(
+    //   "Initializing a11y view",
+    //   walkerFront,
+    //   rootAccessibleFront,
+    //   snapshot
+    // );
+
+    // // Make sure state is reset every time accessibility panel is initialized.
+    // await this.store.dispatch(reset(front, supports));
+
+    // const container = document.getElementById("content");
+    // const mainFrame = MainFrame({
+    //   accessibility: front,
+    //   fluentBundles,
+    //   toolbox,
+    //   getAccessibilityTreeRoot,
+    //   startListeningForAccessibilityEvents,
+    //   stopListeningForAccessibilityEvents,
+    //   audit,
+    //   simulate,
+    // });
+
+    // // Render top level component
+    // const provider = createElement(Provider, { store: this.store }, mainFrame);
+    // this.mainFrame = ReactDOM.render(provider, container);
   },
 
   destroy() {
-    const container = document.getElementById("content");
-    ReactDOM.unmountComponentAtNode(container);
+    // document.body.innerHTML = "";
+    // const container = document.getElementById("content");
+    // ReactDOM.unmountComponentAtNode(container);
   },
 
   async selectAccessible(accessible) {
-    await this.store.dispatch(select(accessible));
-    window.emit(EVENTS.NEW_ACCESSIBLE_FRONT_INSPECTED);
+    // await this.store.dispatch(select(accessible));
+    // window.emit(EVENTS.NEW_ACCESSIBLE_FRONT_INSPECTED);
   },
 
   async highlightAccessible(accessible) {
-    await this.store.dispatch(highlight(accessible));
-    window.emit(EVENTS.NEW_ACCESSIBLE_FRONT_HIGHLIGHTED);
+    // await this.store.dispatch(highlight(accessible));
+    // window.emit(EVENTS.NEW_ACCESSIBLE_FRONT_HIGHLIGHTED);
   },
 
   async selectNodeAccessible(node) {
-    const accessibilityFront = await node.targetFront.getFront("accessibility");
-    const accessibleWalkerFront = await accessibilityFront.getWalker();
-    let accessible = await accessibleWalkerFront.getAccessibleFor(node);
-    if (accessible) {
-      await accessible.hydrate();
-    }
-
-    // If node does not have an accessible object, try to find node's child text node and
-    // try to retrieve an accessible object for that child instead. This is the best
-    // effort approach until there's accessibility API to retrieve accessible object at
-    // point.
-    if (!accessible || accessible.indexInParent < 0) {
-      const { nodes: children } = await node.walkerFront.children(node);
-      for (const child of children) {
-        if (child.nodeType === nodeConstants.TEXT_NODE) {
-          accessible = await accessibleWalkerFront.getAccessibleFor(child);
-          // indexInParent property is only available with additional request
-          // for data (hydration) about the accessible object.
-          if (accessible) {
-            await accessible.hydrate();
-          }
-
-          if (accessible.indexInParent >= 0) {
-            break;
-          }
-        }
-      }
-    }
-
-    await this.store.dispatch(select(accessible));
-    window.emit(EVENTS.NEW_ACCESSIBLE_FRONT_INSPECTED);
+    // const accessibilityFront = await node.targetFront.getFront("accessibility");
+    // const accessibleWalkerFront = await accessibilityFront.getWalker();
+    // let accessible = await accessibleWalkerFront.getAccessibleFor(node);
+    // if (accessible) {
+    //   await accessible.hydrate();
+    // }
+    // // If node does not have an accessible object, try to find node's child text node and
+    // // try to retrieve an accessible object for that child instead. This is the best
+    // // effort approach until there's accessibility API to retrieve accessible object at
+    // // point.
+    // if (!accessible || accessible.indexInParent < 0) {
+    //   const { nodes: children } = await node.walkerFront.children(node);
+    //   for (const child of children) {
+    //     if (child.nodeType === nodeConstants.TEXT_NODE) {
+    //       accessible = await accessibleWalkerFront.getAccessibleFor(child);
+    //       // indexInParent property is only available with additional request
+    //       // for data (hydration) about the accessible object.
+    //       if (accessible) {
+    //         await accessible.hydrate();
+    //       }
+    //       if (accessible.indexInParent >= 0) {
+    //         break;
+    //       }
+    //     }
+    //   }
+    // }
+    // await this.store.dispatch(select(accessible));
+    // window.emit(EVENTS.NEW_ACCESSIBLE_FRONT_INSPECTED);
   },
 
   /**
    * Process message from accessibility panel.
    *
    * @param {Object} event  message type and data.
    */
   onMessage(event) {
@@ -173,9 +233,65 @@ AccessibilityView.prototype = {
     const method = data.type;
 
     if (typeof this[method] === "function") {
       this[method](...data.args);
     }
   },
 };
 
+function isDebug() {
+  return false;
+  // return debugCheckbox.checked;
+}
+
+// let debugCheckbox = document.querySelector("#debug");
+// debugCheckbox.onchange = () => {
+//   buildAccTree(ACTIVE_ACC_TREE);
+// };
+
+function renderDebugContainer(treeItem, children) {
+  let details = document.createElement("details");
+  details.toggleAttribute("open");
+  details.setAttribute(
+    "title",
+    JSON.stringify(
+      Object.assign({}, treeItem, { children: undefined }),
+      null,
+      2
+    )
+  );
+  let summary = document.createElement("summary");
+  summary.textContent = `${treeItem.role}: ${treeItem.name}`;
+  details.append(summary, ...children);
+  return [details];
+}
+
+function buildAccTree(accTree) {
+  // document.querySelector("#content").textContent = buildAccTreeElement(accTree);
+  let content = document.querySelector("#content");
+  content.innerHTML = "";
+  let element = buildAccTreeElement(accTree);
+  content.append(...element);
+}
+
+function buildAccTreeElement(accTree) {
+  let children = accTree.children
+    .map(c => {
+      return buildAccTreeElement(c);
+    })
+    .flat();
+  let currentNode = accTree;
+  // console.log(currentNode.role, children);
+  let role = ROLE_MAP[currentNode.role];
+
+  if (!role) {
+    throw new Error(`Unknown role: ${currentNode.role}`);
+  }
+
+  if (isDebug()) {
+    return renderDebugContainer(currentNode, children);
+  }
+
+  return role.render(currentNode, children);
+}
+
 window.view = new AccessibilityView(store);
diff --git a/devtools/client/accessibility/accessibility.css b/devtools/client/accessibility/accessibility.css
--- a/devtools/client/accessibility/accessibility.css
+++ b/devtools/client/accessibility/accessibility.css
@@ -57,16 +57,28 @@ body {
 }
 
 @keyframes flash-out {
   from {
     background: var(--theme-contrast-background);
   }
 }
 
+body {
+  display: flex;
+}
+aside {
+  flex: 0;
+  display: none;
+}
+aside button {
+  display: block;
+}
+
+
 .accessible .tree .node .theme-twisty {
   width: var(--accessibility-horizontal-indent);
 }
 
 .accessible .tree .node .theme-twisty:not(.open):dir(rtl) {
   transform: rotate(-90deg);
 }
 
diff --git a/devtools/client/accessibility/index.html b/devtools/client/accessibility/index.html
--- a/devtools/client/accessibility/index.html
+++ b/devtools/client/accessibility/index.html
@@ -13,12 +13,18 @@
   <link href="resource://devtools/client/shared/components/splitter/SplitBox.css" rel="stylesheet" />
   <link href="resource://devtools/client/shared/components/Accordion.css" rel="stylesheet" />
   <link href="resource://devtools/client/shared/components/List.css" rel="stylesheet" />
   <link href="resource://devtools/client/shared/components/tree/TreeView.css" rel="stylesheet" />
 
   <script src="chrome://devtools/content/shared/theme-switching.js"></script>
 </head>
 <body class="theme-body devtools-monospace" role="application">
+  <aside>
+    <button>1</button>
+    <button>2</button>
+    <button>3</button>
+    <button>4</button>
+  </aside>
   <div id="content" role="presentation"></div>
   <script src="./main.js"></script>
 </body>
 </html>
diff --git a/devtools/client/accessibility/main.js b/devtools/client/accessibility/main.js
--- a/devtools/client/accessibility/main.js
+++ b/devtools/client/accessibility/main.js
@@ -10,9 +10,10 @@ const { BrowserLoader } = Cu.import(
 
 // Module Loader
 const require = BrowserLoader({
   baseURI: "resource://devtools/client/accessibility/",
   window,
 }).require;
 
 // Load accessibility panel content
+require("devtools/client/accessibility/roles.js");
 require("devtools/client/accessibility/accessibility-view.js");
diff --git a/devtools/client/accessibility/moz.build b/devtools/client/accessibility/moz.build
--- a/devtools/client/accessibility/moz.build
+++ b/devtools/client/accessibility/moz.build
@@ -15,12 +15,13 @@ DIRS += [
 DevToolsModules(
     'accessibility-startup.js',
     'accessibility-view.js',
     'accessibility.css',
     'constants.js',
     'panel.js',
     'picker.js',
     'provider.js',
+    'roles.js',
 )
 
 with Files('**'):
     BUG_COMPONENT = ('DevTools', 'Accessibility Tools')
diff --git a/devtools/client/accessibility/panel.js b/devtools/client/accessibility/panel.js
--- a/devtools/client/accessibility/panel.js
+++ b/devtools/client/accessibility/panel.js
@@ -1,15 +1,22 @@
 /* This Source Code Form is subject to the terms of the Mozilla Public
  * License, v. 2.0. If a copy of the MPL was not distributed with this
  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */
 "use strict";
 
 const Services = require("Services");
 const { L10nRegistry } = require("resource://gre/modules/L10nRegistry.jsm");
+const { Cc, Ci } = require("chrome");
+
+// This turns on accessibility automatically (see Services.appinfo.accessibilityEnabled)
+// See https://searchfox.org/mozilla-central/source/devtools/server/actors/accessibility/accessibility-parent.js#135 for more lifecycle
+const accService = Cc["@mozilla.org/accessibilityService;1"].getService(
+  Ci.nsIAccessibilityService
+);
 
 const EventEmitter = require("devtools/shared/event-emitter");
 
 const Telemetry = require("devtools/client/shared/telemetry");
 
 const { Picker } = require("devtools/client/accessibility/picker");
 const {
   A11Y_SERVICE_DURATION,
diff --git a/devtools/client/accessibility/roles.js b/devtools/client/accessibility/roles.js
new file mode 100644
--- /dev/null
+++ b/devtools/client/accessibility/roles.js
@@ -0,0 +1,1536 @@
+// Built from https://searchfox.org/mozilla-central/source/accessible/base/RoleMap.h
+// Copy in the contents of that file and then
+// VSCode: Find with regex ".*" and then alt+enter to select all
+"use strict";
+console.log("HERE");
+window.ROLE_MAP = {
+  nothing: {
+    render(treeItem, children) {
+      let container = document.createElement("div");
+      container.textContent = `${treeItem.role}: ${treeItem.name}`;
+      container.append(...children);
+      return [container];
+    },
+  },
+  titlebar: {
+    render(treeItem, children) {
+      let container = document.createElement("div");
+      container.textContent = `${treeItem.role}: ${treeItem.name}`;
+      container.append(...children);
+      return [container];
+    },
+  },
+  menubar: {
+    render(treeItem, children) {
+      let container = document.createElement("div");
+      container.textContent = `${treeItem.role}: ${treeItem.name}`;
+      container.append(...children);
+      return [container];
+    },
+  },
+  scrollbar: {
+    render(treeItem, children) {
+      let container = document.createElement("div");
+      container.textContent = `${treeItem.role}: ${treeItem.name}`;
+      container.append(...children);
+      return [container];
+    },
+  },
+  grip: {
+    render(treeItem, children) {
+      let container = document.createElement("div");
+      container.textContent = `${treeItem.role}: ${treeItem.name}`;
+      container.append(...children);
+      return [container];
+    },
+  },
+  sound: {
+    render(treeItem, children) {
+      let container = document.createElement("div");
+      container.textContent = `${treeItem.role}: ${treeItem.name}`;
+      container.append(...children);
+      return [container];
+    },
+  },
+  cursor: {
+    render(treeItem, children) {
+      let container = document.createElement("div");
+      container.textContent = `${treeItem.role}: ${treeItem.name}`;
+      container.append(...children);
+      return [container];
+    },
+  },
+  caret: {
+    render(treeItem, children) {
+      let container = document.createElement("div");
+      container.textContent = `${treeItem.role}: ${treeItem.name}`;
+      container.append(...children);
+      return [container];
+    },
+  },
+  alert: {
+    render(treeItem, children) {
+      let container = document.createElement("div");
+      container.textContent = `${treeItem.role}: ${treeItem.name}`;
+      container.append(...children);
+      return [container];
+    },
+  },
+  window: {
+    render(treeItem, children) {
+      let container = document.createElement("div");
+      container.textContent = `${treeItem.role}: ${treeItem.name}`;
+      container.append(...children);
+      return [container];
+    },
+  },
+  "internal frame": {
+    render(treeItem, children) {
+      let container = document.createElement("div");
+      container.textContent = `${treeItem.role}: ${treeItem.name}`;
+      container.append(...children);
+      return [container];
+    },
+  },
+  menupopup: {
+    render(treeItem, children) {
+      let container = document.createElement("div");
+      container.textContent = `${treeItem.role}: ${treeItem.name}`;
+      container.append(...children);
+      return [container];
+    },
+  },
+  menuitem: {
+    render(treeItem, children) {
+      let container = document.createElement("div");
+      container.textContent = `${treeItem.role}: ${treeItem.name}`;
+      container.append(...children);
+      return [container];
+    },
+  },
+  tooltip: {
+    render(treeItem, children) {
+      let container = document.createElement("div");
+      container.textContent = `${treeItem.role}: ${treeItem.name}`;
+      container.append(...children);
+      return [container];
+    },
+  },
+  AXHelpTag: {
+    render(treeItem, children) {
+      let container = document.createElement("div");
+      container.textContent = `${treeItem.role}: ${treeItem.name}`;
+      container.append(...children);
+      return [container];
+    },
+  },
+  application: {
+    render(treeItem, children) {
+      let container = document.createElement("div");
+      container.textContent = `${treeItem.role}: ${treeItem.name}`;
+      container.append(...children);
+      return [container];
+    },
+  },
+  document: {
+    render(treeItem, children) {
+      let container = document.createElement("h1");
+      container.textContent = `${treeItem.name}`;
+      return [container, ...children];
+    },
+  },
+  AXWebArea: {
+    render(treeItem, children) {
+      let container = document.createElement("div");
+      container.textContent = `${treeItem.role}: ${treeItem.name}`;
+      container.append(...children);
+      return [container];
+    },
+  },
+  pane: {
+    render(treeItem, children) {
+      let container = document.createElement("div");
+      container.textContent = `${treeItem.role}: ${treeItem.name}`;
+      container.append(...children);
+      return [container];
+    },
+  },
+  chart: {
+    render(treeItem, children) {
+      let container = document.createElement("div");
+      container.textContent = `${treeItem.role}: ${treeItem.name}`;
+      container.append(...children);
+      return [container];
+    },
+  },
+  dialog: {
+    render(treeItem, children) {
+      let container = document.createElement("div");
+      container.textContent = `${treeItem.role}: ${treeItem.name}`;
+      container.append(...children);
+      return [container];
+    },
+  },
+  border: {
+    render(treeItem, children) {
+      let container = document.createElement("div");
+      container.textContent = `${treeItem.role}: ${treeItem.name}`;
+      container.append(...children);
+      return [container];
+    },
+  },
+  grouping: {
+    render(treeItem, children) {
+      let container = document.createElement("div");
+      container.textContent = `${treeItem.role}: ${treeItem.name}`;
+      container.append(...children);
+      return [container];
+    },
+  },
+  separator: {
+    render(treeItem, children) {
+      let container = document.createElement("hr");
+      return [container];
+    },
+  },
+  toolbar: {
+    render(treeItem, children) {
+      let container = document.createElement("div");
+      container.textContent = `${treeItem.role}: ${treeItem.name}`;
+      container.append(...children);
+      return [container];
+    },
+  },
+  statusbar: {
+    render(treeItem, children) {
+      let container = document.createElement("div");
+      container.textContent = `${treeItem.role}: ${treeItem.name}`;
+      container.append(...children);
+      return [container];
+    },
+  },
+  table: {
+    render(treeItem, children) {
+      let container = document.createElement("table");
+      container.append(...children);
+      return [container];
+    },
+  },
+  columnheader: {
+    render(treeItem, children) {
+      let container = document.createElement("th");
+      container.append(...children);
+      return [container];
+    },
+  },
+  rowheader: {
+    render(treeItem, children) {
+      let container = document.createElement("th");
+      container.textContent = `${treeItem.role}: ${treeItem.name}`;
+      container.append(...children);
+      return [container];
+    },
+  },
+  column: {
+    render(treeItem, children) {
+      let container = document.createElement("div");
+      container.textContent = `${treeItem.role}: ${treeItem.name}`;
+      container.append(...children);
+      return [container];
+    },
+  },
+  row: {
+    render(treeItem, children) {
+      let container = document.createElement("tr");
+      container.append(...children);
+      return [container];
+    },
+  },
+  cell: {
+    render(treeItem, children) {
+      let container = document.createElement("td");
+      container.append(...children);
+      return [container];
+    },
+  },
+  link: {
+    render(treeItem, children) {
+      let container = document.createElement("a");
+      container.href = treeItem.value;
+      container.append(...children);
+      return [container, " "];
+    },
+  },
+  AXLink: {
+    render(treeItem, children) {
+      let container = document.createElement("div");
+      container.textContent = `${treeItem.role}: ${treeItem.name}`;
+      container.append(...children);
+      return [container];
+    },
+  },
+  helpballoon: {
+    render(treeItem, children) {
+      let container = document.createElement("div");
+      container.textContent = `${treeItem.role}: ${treeItem.name}`;
+      container.append(...children);
+      return [container];
+    },
+  },
+  AXHelpTag: {
+    render(treeItem, children) {
+      let container = document.createElement("div");
+      container.textContent = `${treeItem.role}: ${treeItem.name}`;
+      container.append(...children);
+      return [container];
+    },
+  },
+  character: {
+    render(treeItem, children) {
+      let container = document.createElement("div");
+      container.textContent = `${treeItem.role}: ${treeItem.name}`;
+      container.append(...children);
+      return [container];
+    },
+  },
+  list: {
+    render(treeItem, children) {
+      let tag = treeItem.attributes.tag == "ol" ? "ol" : "ul";
+      let container = document.createElement(tag);
+      container.append(...children);
+      return [container];
+    },
+  },
+  listitem: {
+    render(treeItem, children) {
+      let container = document.createElement("li");
+      container.append(...children);
+      return [container];
+    },
+  },
+  outline: {
+    render(treeItem, children) {
+      let container = document.createElement("div");
+      container.textContent = `${treeItem.role}: ${treeItem.name}`;
+      container.append(...children);
+      return [container];
+    },
+  },
+  outlineitem: {
+    render(treeItem, children) {
+      let container = document.createElement("div");
+      container.textContent = `${treeItem.role}: ${treeItem.name}`;
+      container.append(...children);
+      return [container];
+    },
+  },
+  pagetab: {
+    render(treeItem, children) {
+      let container = document.createElement("div");
+      container.textContent = `${treeItem.role}: ${treeItem.name}`;
+      container.append(...children);
+      return [container];
+    },
+  },
+  propertypage: {
+    render(treeItem, children) {
+      let container = document.createElement("div");
+      container.textContent = `${treeItem.role}: ${treeItem.name}`;
+      container.append(...children);
+      return [container];
+    },
+  },
+  indicator: {
+    render(treeItem, children) {
+      let container = document.createElement("div");
+      container.textContent = `${treeItem.role}: ${treeItem.name}`;
+      container.append(...children);
+      return [container];
+    },
+  },
+  graphic: {
+    render(treeItem, children) {
+      let container = document.createElement("div");
+      container.textContent = `${treeItem.role}: ${treeItem.name}`;
+      container.append(...children);
+      return [container];
+    },
+  },
+  statictext: {
+    render(treeItem, children) {
+      if (treeItem.name == "") {
+        return [];
+      }
+      return [treeItem.name];
+    },
+  },
+  "text leaf": {
+    render(treeItem, children) {
+      return [treeItem.name];
+      // Leafs will be rendered by parents via name. XXX is that always true?
+      // return [];
+    },
+  },
+  pushbutton: {
+    render(treeItem, children) {
+      let container = document.createElement("button");
+      container.append(...children);
+      return [container];
+    },
+  },
+  checkbutton: {
+    render(treeItem, children) {
+      let container = document.createElement("div");
+      container.textContent = `${treeItem.role}: ${treeItem.name}`;
+      container.append(...children);
+      return [container];
+    },
+  },
+  radiobutton: {
+    render(treeItem, children) {
+      let container = document.createElement("div");
+      container.textContent = `${treeItem.role}: ${treeItem.name}`;
+      container.append(...children);
+      return [container];
+    },
+  },
+  "1": {
+    render(treeItem, children) {
+      let container = document.createElement("div");
+      container.textContent = `${treeItem.role}: ${treeItem.name}`;
+      container.append(...children);
+      return [container];
+    },
+  },
+  combobox: {
+    render(treeItem, children) {
+      let container = document.createElement("label");
+      container.textContent = `${treeItem.name}`;
+      container.append(...children);
+      return [container];
+    },
+  },
+  droplist: {
+    render(treeItem, children) {
+      let container = document.createElement("div");
+      container.textContent = `${treeItem.role}: ${treeItem.name}`;
+      container.append(...children);
+      return [container];
+    },
+  },
+  progressbar: {
+    render(treeItem, children) {
+      let container = document.createElement("div");
+      container.textContent = `${treeItem.role}: ${treeItem.name}`;
+      container.append(...children);
+      return [container];
+    },
+  },
+  dial: {
+    render(treeItem, children) {
+      let container = document.createElement("div");
+      container.textContent = `${treeItem.role}: ${treeItem.name}`;
+      container.append(...children);
+      return [container];
+    },
+  },
+  hotkeyfield: {
+    render(treeItem, children) {
+      let container = document.createElement("div");
+      container.textContent = `${treeItem.role}: ${treeItem.name}`;
+      container.append(...children);
+      return [container];
+    },
+  },
+  slider: {
+    render(treeItem, children) {
+      let container = document.createElement("div");
+      container.textContent = `${treeItem.role}: ${treeItem.name}`;
+      container.append(...children);
+      return [container];
+    },
+  },
+  spinbutton: {
+    render(treeItem, children) {
+      let container = document.createElement("div");
+      container.textContent = `${treeItem.role}: ${treeItem.name}`;
+      container.append(...children);
+      return [container];
+    },
+  },
+  diagram: {
+    render(treeItem, children) {
+      let container = document.createElement("div");
+      container.textContent = `${treeItem.role}: ${treeItem.name}`;
+      container.append(...children);
+      return [container];
+    },
+  },
+  animation: {
+    render(treeItem, children) {
+      let container = document.createElement("div");
+      container.textContent = `${treeItem.role}: ${treeItem.name}`;
+      container.append(...children);
+      return [container];
+    },
+  },
+  equation: {
+    render(treeItem, children) {
+      let container = document.createElement("div");
+      container.textContent = `${treeItem.role}: ${treeItem.name}`;
+      container.append(...children);
+      return [container];
+    },
+  },
+  buttondropdown: {
+    render(treeItem, children) {
+      let container = document.createElement("div");
+      container.textContent = `${treeItem.role}: ${treeItem.name}`;
+      container.append(...children);
+      return [container];
+    },
+  },
+  buttonmenu: {
+    render(treeItem, children) {
+      // XXX copy over
+      let container = document.createElement("div");
+      container.textContent = `${treeItem.role}: ${treeItem.name}`;
+      container.append(...children);
+      return [container];
+    },
+  },
+  buttondropdowngrid: {
+    render(treeItem, children) {
+      let container = document.createElement("div");
+      container.textContent = `${treeItem.role}: ${treeItem.name}`;
+      container.append(...children);
+      return [container];
+    },
+  },
+  whitespace: {
+    render(treeItem, children) {
+      return [treeItem.name];
+    },
+  },
+  pagetablist: {
+    render(treeItem, children) {
+      let container = document.createElement("div");
+      container.textContent = `${treeItem.role}: ${treeItem.name}`;
+      container.append(...children);
+      return [container];
+    },
+  },
+  clock: {
+    render(treeItem, children) {
+      let container = document.createElement("div");
+      container.textContent = `${treeItem.role}: ${treeItem.name}`;
+      container.append(...children);
+      return [container];
+    },
+  },
+  splitbutton: {
+    render(treeItem, children) {
+      let container = document.createElement("div");
+      container.textContent = `${treeItem.role}: ${treeItem.name}`;
+      container.append(...children);
+      return [container];
+    },
+  },
+  ipaddress: {
+    render(treeItem, children) {
+      let container = document.createElement("div");
+      container.textContent = `${treeItem.role}: ${treeItem.name}`;
+      container.append(...children);
+      return [container];
+    },
+  },
+  "accel label": {
+    render(treeItem, children) {
+      let container = document.createElement("div");
+      container.textContent = `${treeItem.role}: ${treeItem.name}`;
+      container.append(...children);
+      return [container];
+    },
+  },
+  arrow: {
+    render(treeItem, children) {
+      let container = document.createElement("div");
+      container.textContent = `${treeItem.role}: ${treeItem.name}`;
+      container.append(...children);
+      return [container];
+    },
+  },
+  canvas: {
+    render(treeItem, children) {
+      let container = document.createElement("div");
+      container.textContent = `${treeItem.role}: ${treeItem.name}`;
+      container.append(...children);
+      return [container];
+    },
+  },
+  "check menu item": {
+    render(treeItem, children) {
+      let container = document.createElement("div");
+      container.textContent = `${treeItem.role}: ${treeItem.name}`;
+      container.append(...children);
+      return [container];
+    },
+  },
+  "color chooser": {
+    render(treeItem, children) {
+      let container = document.createElement("div");
+      container.textContent = `${treeItem.role}: ${treeItem.name}`;
+      container.append(...children);
+      return [container];
+    },
+  },
+  "date editor": {
+    render(treeItem, children) {
+      let container = document.createElement("div");
+      container.textContent = `${treeItem.role}: ${treeItem.name}`;
+      container.append(...children);
+      return [container];
+    },
+  },
+  "desktop icon": {
+    render(treeItem, children) {
+      let container = document.createElement("div");
+      container.textContent = `${treeItem.role}: ${treeItem.name}`;
+      container.append(...children);
+      return [container];
+    },
+  },
+  "desktop frame": {
+    render(treeItem, children) {
+      let container = document.createElement("div");
+      container.textContent = `${treeItem.role}: ${treeItem.name}`;
+      container.append(...children);
+      return [container];
+    },
+  },
+  "directory pane": {
+    render(treeItem, children) {
+      let container = document.createElement("div");
+      container.textContent = `${treeItem.role}: ${treeItem.name}`;
+      container.append(...children);
+      return [container];
+    },
+  },
+  "file chooser": {
+    render(treeItem, children) {
+      let container = document.createElement("div");
+      container.textContent = `${treeItem.role}: ${treeItem.name}`;
+      container.append(...children);
+      return [container];
+    },
+  },
+  "font chooser": {
+    render(treeItem, children) {
+      let container = document.createElement("div");
+      container.textContent = `${treeItem.role}: ${treeItem.name}`;
+      container.append(...children);
+      return [container];
+    },
+  },
+  "chrome window": {
+    render(treeItem, children) {
+      let container = document.createElement("div");
+      container.textContent = `${treeItem.role}: ${treeItem.name}`;
+      container.append(...children);
+      return [container];
+    },
+  },
+  "glass pane": {
+    render(treeItem, children) {
+      let container = document.createElement("div");
+      container.textContent = `${treeItem.role}: ${treeItem.name}`;
+      container.append(...children);
+      return [container];
+    },
+  },
+  "html container": {
+    render(treeItem, children) {
+      let container = document.createElement("div");
+      container.textContent = `${treeItem.role}: ${treeItem.name}`;
+      container.append(...children);
+      return [container];
+    },
+  },
+  icon: {
+    render(treeItem, children) {
+      let container = document.createElement("div");
+      container.textContent = `${treeItem.role}: ${treeItem.name}`;
+      container.append(...children);
+      return [container];
+    },
+  },
+  label: {
+    render(treeItem, children) {
+      let container = document.createElement("div");
+      container.textContent = `${treeItem.role}: ${treeItem.name}`;
+      container.append(...children);
+      return [container];
+    },
+  },
+  "layered pane": {
+    render(treeItem, children) {
+      let container = document.createElement("div");
+      container.textContent = `${treeItem.role}: ${treeItem.name}`;
+      container.append(...children);
+      return [container];
+    },
+  },
+  "option pane": {
+    render(treeItem, children) {
+      let container = document.createElement("div");
+      container.textContent = `${treeItem.role}: ${treeItem.name}`;
+      container.append(...children);
+      return [container];
+    },
+  },
+  "password text": {
+    render(treeItem, children) {
+      let container = document.createElement("div");
+      container.textContent = `${treeItem.role}: ${treeItem.name}`;
+      container.append(...children);
+      return [container];
+    },
+  },
+  "popup menu": {
+    render(treeItem, children) {
+      let container = document.createElement("div");
+      container.textContent = `${treeItem.role}: ${treeItem.name}`;
+      container.append(...children);
+      return [container];
+    },
+  },
+  "radio menu item": {
+    render(treeItem, children) {
+      let container = document.createElement("div");
+      container.textContent = `${treeItem.role}: ${treeItem.name}`;
+      container.append(...children);
+      return [container];
+    },
+  },
+  "root pane": {
+    render(treeItem, children) {
+      let container = document.createElement("div");
+      container.textContent = `${treeItem.role}: ${treeItem.name}`;
+      container.append(...children);
+      return [container];
+    },
+  },
+  "scroll pane": {
+    render(treeItem, children) {
+      let container = document.createElement("div");
+      container.textContent = `${treeItem.role}: ${treeItem.name}`;
+      container.append(...children);
+      return [container];
+    },
+  },
+  "split pane": {
+    render(treeItem, children) {
+      let container = document.createElement("div");
+      container.textContent = `${treeItem.role}: ${treeItem.name}`;
+      container.append(...children);
+      return [container];
+    },
+  },
+  "table column header": {
+    render(treeItem, children) {
+      let container = document.createElement("div");
+      container.textContent = `${treeItem.role}: ${treeItem.name}`;
+      container.append(...children);
+      return [container];
+    },
+  },
+  "table row header": {
+    render(treeItem, children) {
+      let container = document.createElement("div");
+      container.textContent = `${treeItem.role}: ${treeItem.name}`;
+      container.append(...children);
+      return [container];
+    },
+  },
+  "tear off menu item": {
+    render(treeItem, children) {
+      let container = document.createElement("div");
+      container.textContent = `${treeItem.role}: ${treeItem.name}`;
+      container.append(...children);
+      return [container];
+    },
+  },
+  terminal: {
+    render(treeItem, children) {
+      let container = document.createElement("div");
+      container.textContent = `${treeItem.role}: ${treeItem.name}`;
+      container.append(...children);
+      return [container];
+    },
+  },
+  "text container": {
+    render(treeItem, children) {
+      return [...children];
+    },
+  },
+  "toggle button": {
+    render(treeItem, children) {
+      let container = document.createElement("div");
+      container.textContent = `${treeItem.role}: ${treeItem.name}`;
+      container.append(...children);
+      return [container];
+    },
+  },
+  "tree table": {
+    render(treeItem, children) {
+      let container = document.createElement("div");
+      container.textContent = `${treeItem.role}: ${treeItem.name}`;
+      container.append(...children);
+      return [container];
+    },
+  },
+  viewport: {
+    render(treeItem, children) {
+      let container = document.createElement("div");
+      container.textContent = `${treeItem.role}: ${treeItem.name}`;
+      container.append(...children);
+      return [container];
+    },
+  },
+  header: {
+    render(treeItem, children) {
+      let container = document.createElement("div");
+      container.textContent = `${treeItem.role}: ${treeItem.name}`;
+      container.append(...children);
+      return [container];
+    },
+  },
+  footer: {
+    render(treeItem, children) {
+      let container = document.createElement("div");
+      container.textContent = `${treeItem.role}: ${treeItem.name}`;
+      container.append(...children);
+      return [container];
+    },
+  },
+  paragraph: {
+    render(treeItem, children) {
+      let container = document.createElement("p");
+      container.append(...children);
+      return [container];
+    },
+  },
+  ruler: {
+    render(treeItem, children) {
+      let container = document.createElement("div");
+      container.textContent = `${treeItem.role}: ${treeItem.name}`;
+      container.append(...children);
+      return [container];
+    },
+  },
+  AXRuler: {
+    render(treeItem, children) {
+      let container = document.createElement("div");
+      container.textContent = `${treeItem.role}: ${treeItem.name}`;
+      container.append(...children);
+      return [container];
+    },
+  },
+  autocomplete: {
+    render(treeItem, children) {
+      let container = document.createElement("div");
+      container.textContent = `${treeItem.role}: ${treeItem.name}`;
+      container.append(...children);
+      return [container];
+    },
+  },
+  editbar: {
+    render(treeItem, children) {
+      let container = document.createElement("div");
+      container.textContent = `${treeItem.role}: ${treeItem.name}`;
+      container.append(...children);
+      return [container];
+    },
+  },
+  entry: {
+    render(treeItem, children) {
+      // XXX: [relations] is missing from JSON export but would be needed to set up
+      // proper labeling on i.e. amazon.com.
+      let container = document.createElement("div");
+      container.textContent = `${treeItem.role}: ${treeItem.name}`;
+      container.append(...children);
+      return [container];
+    },
+  },
+  caption: {
+    render(treeItem, children) {
+      let container = document.createElement("div");
+      container.textContent = `${treeItem.role}: ${treeItem.name}`;
+      container.append(...children);
+      return [container];
+    },
+  },
+  "non-native document": {
+    render(treeItem, children) {
+      let container = document.createElement("div");
+      container.textContent = `${treeItem.role}: ${treeItem.name}`;
+      container.append(...children);
+      return [container];
+    },
+  },
+  heading: {
+    render(treeItem, children) {
+      let tag = treeItem.attributes.tag;
+      let container = document.createElement(tag); // XXX: make sure it's an h tag
+      container.append(...children);
+      return [container];
+    },
+  },
+  AXHeading: {
+    render(treeItem, children) {
+      let container = document.createElement("div");
+      container.textContent = `${treeItem.role}: ${treeItem.name}`;
+      container.append(...children);
+      return [container];
+    },
+  },
+  page: {
+    render(treeItem, children) {
+      let container = document.createElement("div");
+      container.textContent = `${treeItem.role}: ${treeItem.name}`;
+      container.append(...children);
+      return [container];
+    },
+  },
+  section: {
+    render(treeItem, children) {
+      // XXX: section with only another section child could be ignored
+      let container = document.createElement("div");
+      container.append(...children);
+      return [container];
+    },
+  },
+  "redundant object": {
+    render(treeItem, children) {
+      let container = document.createElement("div");
+      container.textContent = `${treeItem.role}: ${treeItem.name}`;
+      container.append(...children);
+      return [container];
+    },
+  },
+  form: {
+    render(treeItem, children) {
+      let container = document.createElement("div");
+      container.textContent = `${treeItem.role}: ${treeItem.name}`;
+      container.append(...children);
+      return [container];
+    },
+  },
+  ime: {
+    render(treeItem, children) {
+      let container = document.createElement("div");
+      container.textContent = `${treeItem.role}: ${treeItem.name}`;
+      container.append(...children);
+      return [container];
+    },
+  },
+  "app root": {
+    render(treeItem, children) {
+      let container = document.createElement("div");
+      container.textContent = `${treeItem.role}: ${treeItem.name}`;
+      container.append(...children);
+      return [container];
+    },
+  },
+  "parent menuitem": {
+    render(treeItem, children) {
+      let container = document.createElement("div");
+      container.textContent = `${treeItem.role}: ${treeItem.name}`;
+      container.append(...children);
+      return [container];
+    },
+  },
+  calendar: {
+    render(treeItem, children) {
+      let container = document.createElement("div");
+      container.textContent = `${treeItem.role}: ${treeItem.name}`;
+      container.append(...children);
+      return [container];
+    },
+  },
+  "combobox list": {
+    render(treeItem, children) {
+      let container = document.createElement("select");
+      container.append(...children);
+      return [container];
+    },
+  },
+  "combobox option": {
+    render(treeItem /*, children*/) {
+      let container = document.createElement("option");
+      container.textContent = `${treeItem.name}`;
+      return [container];
+    },
+  },
+  "image map": {
+    render(treeItem, children) {
+      let container = document.createElement("div");
+      container.textContent = `${treeItem.role}: ${treeItem.name}`;
+      container.append(...children);
+      return [container];
+    },
+  },
+  "listbox option": {
+    render(treeItem, children) {
+      let container = document.createElement("div");
+      container.textContent = `${treeItem.role}: ${treeItem.name}`;
+      container.append(...children);
+      return [container];
+    },
+  },
+  "listbox rich option": {
+    render(treeItem, children) {
+      let container = document.createElement("div");
+      container.textContent = `${treeItem.role}: ${treeItem.name}`;
+      container.append(...children);
+      return [container];
+    },
+  },
+  listbox: {
+    render(treeItem, children) {
+      let container = document.createElement("div");
+      container.textContent = `${treeItem.role}: ${treeItem.name}`;
+      container.append(...children);
+      return [container];
+    },
+  },
+  "flat equation": {
+    render(treeItem, children) {
+      let container = document.createElement("div");
+      container.textContent = `${treeItem.role}: ${treeItem.name}`;
+      container.append(...children);
+      return [container];
+    },
+  },
+  gridcell: {
+    render(treeItem, children) {
+      let container = document.createElement("div");
+      container.textContent = `${treeItem.role}: ${treeItem.name}`;
+      container.append(...children);
+      return [container];
+    },
+  },
+  "embedded object": {
+    render(treeItem, children) {
+      let container = document.createElement("div");
+      container.textContent = `${treeItem.role}: ${treeItem.name}`;
+      container.append(...children);
+      return [container];
+    },
+  },
+  note: {
+    render(treeItem, children) {
+      let container = document.createElement("div");
+      container.textContent = `${treeItem.role}: ${treeItem.name}`;
+      container.append(...children);
+      return [container];
+    },
+  },
+  figure: {
+    render(treeItem, children) {
+      let container = document.createElement("div");
+      container.textContent = `${treeItem.role}: ${treeItem.name}`;
+      container.append(...children);
+      return [container];
+    },
+  },
+  "check rich option": {
+    render(treeItem, children) {
+      let container = document.createElement("div");
+      container.textContent = `${treeItem.role}: ${treeItem.name}`;
+      container.append(...children);
+      return [container];
+    },
+  },
+  definitionlist: {
+    render(treeItem, children) {
+      let container = document.createElement("div");
+      container.textContent = `${treeItem.role}: ${treeItem.name}`;
+      container.append(...children);
+      return [container];
+    },
+  },
+  term: {
+    render(treeItem, children) {
+      let container = document.createElement("div");
+      container.textContent = `${treeItem.role}: ${treeItem.name}`;
+      container.append(...children);
+      return [container];
+    },
+  },
+  definition: {
+    render(treeItem, children) {
+      let container = document.createElement("div");
+      container.textContent = `${treeItem.role}: ${treeItem.name}`;
+      container.append(...children);
+      return [container];
+    },
+  },
+  key: {
+    render(treeItem, children) {
+      let container = document.createElement("div");
+      container.textContent = `${treeItem.role}: ${treeItem.name}`;
+      container.append(...children);
+      return [container];
+    },
+  },
+  switch: {
+    render(treeItem, children) {
+      let container = document.createElement("div");
+      container.textContent = `${treeItem.role}: ${treeItem.name}`;
+      container.append(...children);
+      return [container];
+    },
+  },
+  math: {
+    render(treeItem, children) {
+      let container = document.createElement("div");
+      container.textContent = `${treeItem.role}: ${treeItem.name}`;
+      container.append(...children);
+      return [container];
+    },
+  },
+  "mathml identifier": {
+    render(treeItem, children) {
+      let container = document.createElement("div");
+      container.textContent = `${treeItem.role}: ${treeItem.name}`;
+      container.append(...children);
+      return [container];
+    },
+  },
+  "mathml number": {
+    render(treeItem, children) {
+      let container = document.createElement("div");
+      container.textContent = `${treeItem.role}: ${treeItem.name}`;
+      container.append(...children);
+      return [container];
+    },
+  },
+  "mathml operator": {
+    render(treeItem, children) {
+      let container = document.createElement("div");
+      container.textContent = `${treeItem.role}: ${treeItem.name}`;
+      container.append(...children);
+      return [container];
+    },
+  },
+  "mathml text": {
+    render(treeItem, children) {
+      let container = document.createElement("div");
+      container.textContent = `${treeItem.role}: ${treeItem.name}`;
+      container.append(...children);
+      return [container];
+    },
+  },
+  "mathml string literal": {
+    render(treeItem, children) {
+      let container = document.createElement("div");
+      container.textContent = `${treeItem.role}: ${treeItem.name}`;
+      container.append(...children);
+      return [container];
+    },
+  },
+  "mathml glyph": {
+    render(treeItem, children) {
+      let container = document.createElement("div");
+      container.textContent = `${treeItem.role}: ${treeItem.name}`;
+      container.append(...children);
+      return [container];
+    },
+  },
+  "mathml row": {
+    render(treeItem, children) {
+      let container = document.createElement("div");
+      container.textContent = `${treeItem.role}: ${treeItem.name}`;
+      container.append(...children);
+      return [container];
+    },
+  },
+  "mathml fraction": {
+    render(treeItem, children) {
+      let container = document.createElement("div");
+      container.textContent = `${treeItem.role}: ${treeItem.name}`;
+      container.append(...children);
+      return [container];
+    },
+  },
+  "mathml square root": {
+    render(treeItem, children) {
+      let container = document.createElement("div");
+      container.textContent = `${treeItem.role}: ${treeItem.name}`;
+      container.append(...children);
+      return [container];
+    },
+  },
+  "mathml root": {
+    render(treeItem, children) {
+      let container = document.createElement("div");
+      container.textContent = `${treeItem.role}: ${treeItem.name}`;
+      container.append(...children);
+      return [container];
+    },
+  },
+  "mathml fenced": {
+    render(treeItem, children) {
+      let container = document.createElement("div");
+      container.textContent = `${treeItem.role}: ${treeItem.name}`;
+      container.append(...children);
+      return [container];
+    },
+  },
+  "mathml enclosed": {
+    render(treeItem, children) {
+      let container = document.createElement("div");
+      container.textContent = `${treeItem.role}: ${treeItem.name}`;
+      container.append(...children);
+      return [container];
+    },
+  },
+  "mathml style": {
+    render(treeItem, children) {
+      let container = document.createElement("div");
+      container.textContent = `${treeItem.role}: ${treeItem.name}`;
+      container.append(...children);
+      return [container];
+    },
+  },
+  "mathml sub": {
+    render(treeItem, children) {
+      let container = document.createElement("div");
+      container.textContent = `${treeItem.role}: ${treeItem.name}`;
+      container.append(...children);
+      return [container];
+    },
+  },
+  "mathml sup": {
+    render(treeItem, children) {
+      let container = document.createElement("div");
+      container.textContent = `${treeItem.role}: ${treeItem.name}`;
+      container.append(...children);
+      return [container];
+    },
+  },
+  "mathml sub sup": {
+    render(treeItem, children) {
+      let container = document.createElement("div");
+      container.textContent = `${treeItem.role}: ${treeItem.name}`;
+      container.append(...children);
+      return [container];
+    },
+  },
+  "mathml under": {
+    render(treeItem, children) {
+      let container = document.createElement("div");
+      container.textContent = `${treeItem.role}: ${treeItem.name}`;
+      container.append(...children);
+      return [container];
+    },
+  },
+  "mathml over": {
+    render(treeItem, children) {
+      let container = document.createElement("div");
+      container.textContent = `${treeItem.role}: ${treeItem.name}`;
+      container.append(...children);
+      return [container];
+    },
+  },
+  "mathml under over": {
+    render(treeItem, children) {
+      let container = document.createElement("div");
+      container.textContent = `${treeItem.role}: ${treeItem.name}`;
+      container.append(...children);
+      return [container];
+    },
+  },
+  "mathml multiscripts": {
+    render(treeItem, children) {
+      let container = document.createElement("div");
+      container.textContent = `${treeItem.role}: ${treeItem.name}`;
+      container.append(...children);
+      return [container];
+    },
+  },
+  "mathml table": {
+    render(treeItem, children) {
+      let container = document.createElement("div");
+      container.textContent = `${treeItem.role}: ${treeItem.name}`;
+      container.append(...children);
+      return [container];
+    },
+  },
+  "mathml labeled row": {
+    render(treeItem, children) {
+      let container = document.createElement("div");
+      container.textContent = `${treeItem.role}: ${treeItem.name}`;
+      container.append(...children);
+      return [container];
+    },
+  },
+  "mathml table row": {
+    render(treeItem, children) {
+      let container = document.createElement("div");
+      container.textContent = `${treeItem.role}: ${treeItem.name}`;
+      container.append(...children);
+      return [container];
+    },
+  },
+  "mathml cell": {
+    render(treeItem, children) {
+      let container = document.createElement("div");
+      container.textContent = `${treeItem.role}: ${treeItem.name}`;
+      container.append(...children);
+      return [container];
+    },
+  },
+  "mathml action": {
+    render(treeItem, children) {
+      let container = document.createElement("div");
+      container.textContent = `${treeItem.role}: ${treeItem.name}`;
+      container.append(...children);
+      return [container];
+    },
+  },
+  "mathml error": {
+    render(treeItem, children) {
+      let container = document.createElement("div");
+      container.textContent = `${treeItem.role}: ${treeItem.name}`;
+      container.append(...children);
+      return [container];
+    },
+  },
+  "mathml stack": {
+    render(treeItem, children) {
+      let container = document.createElement("div");
+      container.textContent = `${treeItem.role}: ${treeItem.name}`;
+      container.append(...children);
+      return [container];
+    },
+  },
+  "mathml long division": {
+    render(treeItem, children) {
+      let container = document.createElement("div");
+      container.textContent = `${treeItem.role}: ${treeItem.name}`;
+      container.append(...children);
+      return [container];
+    },
+  },
+  "mathml stack group": {
+    render(treeItem, children) {
+      let container = document.createElement("div");
+      container.textContent = `${treeItem.role}: ${treeItem.name}`;
+      container.append(...children);
+      return [container];
+    },
+  },
+  "mathml stack row": {
+    render(treeItem, children) {
+      let container = document.createElement("div");
+      container.textContent = `${treeItem.role}: ${treeItem.name}`;
+      container.append(...children);
+      return [container];
+    },
+  },
+  "mathml stack carries": {
+    render(treeItem, children) {
+      let container = document.createElement("div");
+      container.textContent = `${treeItem.role}: ${treeItem.name}`;
+      container.append(...children);
+      return [container];
+    },
+  },
+  "mathml stack carry": {
+    render(treeItem, children) {
+      let container = document.createElement("div");
+      container.textContent = `${treeItem.role}: ${treeItem.name}`;
+      container.append(...children);
+      return [container];
+    },
+  },
+  "mathml stack line": {
+    render(treeItem, children) {
+      let container = document.createElement("div");
+      container.textContent = `${treeItem.role}: ${treeItem.name}`;
+      container.append(...children);
+      return [container];
+    },
+  },
+  grouping: {
+    render(treeItem, children) {
+      let container = document.createElement("div");
+      container.textContent = `${treeItem.role}: ${treeItem.name}`;
+      container.append(...children);
+      return [container];
+    },
+  },
+  text: {
+    render(treeItem, children) {
+      return [...children];
+    },
+  },
+  details: {
+    render(treeItem, children) {
+      let container = document.createElement("div");
+      container.textContent = `${treeItem.role}: ${treeItem.name}`;
+      container.append(...children);
+      return [container];
+    },
+  },
+  summary: {
+    render(treeItem, children) {
+      let container = document.createElement("div");
+      container.textContent = `${treeItem.role}: ${treeItem.name}`;
+      container.append(...children);
+      return [container];
+    },
+  },
+  landmark: {
+    render(treeItem, children) {
+      let roles = treeItem.attributes["xml-roles"].split(" ");
+
+      /*
+    <article>
+    <aside>
+    <details>
+    <figcaption>
+    <figure>
+    <footer>
+    <header>
+    <main>
+    <mark>
+    <nav>
+    <section>
+    <summary>
+    <time>
+      */
+
+      let container;
+      if (roles.includes("banner")) {
+        container = document.createElement("div");
+        container.setAttribute("role", "banner");
+      }
+      if (roles.includes("navigation")) {
+        // (e.g., a menu)
+        container = document.createElement("nav");
+      }
+      if (roles.includes("main")) {
+        // (the main content of the page)
+        container = document.createElement("main");
+      }
+      if (roles.includes("complementary")) {
+        // (e.g., a sidebar)
+        container = document.createElement("aside");
+      }
+      if (roles.includes("contentinfo")) {
+        // (meta data about the page, e.g., a copyright statement)
+        container = document.createElement("div");
+        container.setAttribute("role", "contentinfo");
+      }
+      if (roles.includes("search")) {
+        container = document.createElement("form");
+        container.setAttribute("role", "search");
+      }
+      if (roles.includes("form")) {
+        container = document.createElement("form");
+      }
+      if (roles.includes("application")) {
+        // (a web application with its own keyboard interface)
+        container = document.createElement("div");
+        container.setAttribute("role", "application");
+      }
+
+      container.textContent = `${treeItem.role}: ${roles.join(" ")}`;
+      container.append(...children);
+      return [container];
+    },
+  },
+  navigation: {
+    render(treeItem, children) {
+      let container = document.createElement("div");
+      container.textContent = `${treeItem.role}: ${treeItem.name}`;
+      container.append(...children);
+      return [container];
+    },
+  },
+  footnote: {
+    render(treeItem, children) {
+      let container = document.createElement("div");
+      container.textContent = `${treeItem.role}: ${treeItem.name}`;
+      container.append(...children);
+      return [container];
+    },
+  },
+  article: {
+    render(treeItem, children) {
+      let container = document.createElement("article");
+      container.append(...children);
+      return [container];
+    },
+  },
+  region: {
+    render(treeItem, children) {
+      let container = document.createElement("div");
+      container.textContent = `${treeItem.role}: ${treeItem.name}`;
+      container.append(...children);
+      return [container];
+    },
+  },
+  editcombobox: {
+    render(treeItem, children) {
+      let container = document.createElement("label");
+      container.textContent = `${treeItem.name}`;
+      let input = document.createElement("input");
+      container.appendChild(input);
+      return [container];
+    },
+  },
+  blockquote: {
+    render(treeItem, children) {
+      let container = document.createElement("div");
+      container.textContent = `${treeItem.role}: ${treeItem.name}`;
+      container.append(...children);
+      return [container];
+    },
+  },
+  "content deletion": {
+    render(treeItem, children) {
+      let container = document.createElement("div");
+      container.textContent = `${treeItem.role}: ${treeItem.name}`;
+      container.append(...children);
+      return [container];
+    },
+  },
+  "content insertion": {
+    render(treeItem, children) {
+      let container = document.createElement("div");
+      container.textContent = `${treeItem.role}: ${treeItem.name}`;
+      container.append(...children);
+      return [container];
+    },
+  },
+  // form: { this is FORM_LANDMARK https://searchfox.org/mozilla-central/rev/96f1457323cc598a36f5701f8e67aedaf97acfcf/accessible/base/RoleMap.h#1625-1632
+  //   render(treeItem, children) {
+  //     let container = document.createElement("div");
+  //     container.textContent = `${treeItem.role}: ${treeItem.name}`;
+  //     container.append(...children);
+  //     return [container];
+  //   }
+  // },
+  mark: {
+    render(treeItem, children) {
+      let container = document.createElement("div");
+      container.textContent = `${treeItem.role}: ${treeItem.name}`;
+      container.append(...children);
+      return [container];
+    },
+  },
+};
diff --git a/devtools/client/framework/toolbox.js b/devtools/client/framework/toolbox.js
--- a/devtools/client/framework/toolbox.js
+++ b/devtools/client/framework/toolbox.js
@@ -820,16 +820,23 @@ Toolbox.prototype = {
       // The isTargetSupported check needs to happen after the target is
       // remoted, otherwise we could have done it in the toolbox constructor
       // (bug 1072764).
       const toolDef = gDevTools.getToolDefinition(this._defaultToolId);
       if (!toolDef || !toolDef.isTargetSupported(this.target)) {
         this._defaultToolId = "webconsole";
       }
 
+      const url = new URL(this.win.location);
+      const searchParams = new this.win.URLSearchParams(url.search);
+
+      if (searchParams.get("a11ymode")) {
+        this._defaultToolId = "accessibility";
+        this.doc.documentElement.classList.add("a11ymode");
+      }
       // Start rendering the toolbox toolbar before selecting the tool, as the tools
       // can take a few hundred milliseconds seconds to start up.
       //
       // Delay React rendering as Toolbox.open is synchronous.
       // Even if this involve promises, it is synchronous. Toolbox.open already loads
       // react modules and freeze the event loop for a significant time.
       // requestIdleCallback allows releasing it to allow user events to be processed.
       // Use 16ms maximum delay to allow one frame to be rendered at 60FPS
diff --git a/devtools/client/themes/toolbox.css b/devtools/client/themes/toolbox.css
--- a/devtools/client/themes/toolbox.css
+++ b/devtools/client/themes/toolbox.css
@@ -1,12 +1,16 @@
 /* This Source Code Form is subject to the terms of the Mozilla Public
  * License, v. 2.0. If a copy of the MPL was not distributed with this
  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */
 
+.a11ymode .debug-target-info,
+.a11ymode .devtools-tabbar {
+  display: none;
+}
 /*
  *  Debug Target Info layout
  *  +------------+--------------+------------------------+
  *  | connection | runtime info | target info icon + text |
  *  +------------+--------------+------------------------+
  */
 .debug-target-info {
   display: flex;
diff --git a/devtools/server/actors/accessibility/accessible.js b/devtools/server/actors/accessibility/accessible.js
--- a/devtools/server/actors/accessibility/accessible.js
+++ b/devtools/server/actors/accessibility/accessible.js
@@ -76,43 +76,46 @@ const CSS_TEXT_SELECTOR = "#text";
 function getNodeDescription(node) {
   if (!node || Cu.isDeadWrapper(node)) {
     return { nodeType: undefined, nodeCssSelector: "" };
   }
 
   const { nodeType } = node;
   return {
     nodeType,
-    // If node is a text node, we find a unique CSS selector for its parent and add a
-    // CSS_TEXT_SELECTOR postfix to indicate that it's a text node.
-    nodeCssSelector:
-      nodeType === Node.TEXT_NODE
-        ? `${findCssSelector(node.parentNode)}${CSS_TEXT_SELECTOR}`
-        : findCssSelector(node),
+    nodeCssSelector: null,
+    // // If node is a text node, we find a unique CSS selector for its parent and add a
+    // // CSS_TEXT_SELECTOR postfix to indicate that it's a text node.
+    // nodeCssSelector:
+    //   nodeType === Node.TEXT_NODE
+    //     ? `${findCssSelector(node.parentNode)}${CSS_TEXT_SELECTOR}`
+    //     : findCssSelector(node),
   };
 }
 
 /**
  * Get a snapshot of the nsIAccessible object including its subtree. None of the subtree
  * queried here is cached via accessible walker's refMap.
  * @param  {nsIAccessible} acc
  *         Accessible object to take a snapshot of.
  * @param  {nsIAccessibilityService} a11yService
  *         Accessibility service instance in the current process, used to get localized
  *         string representation of various accessible properties.
  * @return {JSON}
  *         JSON snapshot of the accessibility tree with root at current accessible.
  */
-function getSnapshot(acc, a11yService) {
+function getSnapshot(acc, a11yService, recurse) {
   if (isDefunct(acc)) {
     return {
       states: [a11yService.getStringStates(0, STATE_DEFUNCT)],
     };
   }
 
+  let time;
+  time = Date.now();
   const actions = [];
   for (let i = 0; i < acc.actionCount; i++) {
     actions.push(acc.getActionDescription(i));
   }
 
   const attributes = {};
   if (acc.attributes) {
     for (const { key, value } of acc.attributes.enumerate()) {
@@ -122,35 +125,43 @@ function getSnapshot(acc, a11yService) {
 
   const state = {};
   const extState = {};
   acc.getState(state, extState);
   const states = [...a11yService.getStringStates(state.value, extState.value)];
 
   const children = [];
   for (let child = acc.firstChild; child; child = child.nextSibling) {
-    children.push(getSnapshot(child, a11yService));
+    children.push(getSnapshot(child, a11yService, true));
   }
 
   const { nodeType, nodeCssSelector } = getNodeDescription(acc.DOMNode);
-  return {
+
+  let ret = {
     name: acc.name,
     role: a11yService.getStringRole(acc.role),
     actions,
     value: acc.value,
     nodeCssSelector,
     nodeType,
     description: acc.description,
     keyboardShortcut: acc.accessKey || acc.keyboardShortcut,
     childCount: acc.childCount,
     indexInParent: acc.indexInParent,
     states,
     children,
     attributes,
   };
+
+  if (!recurse) {
+    console.log("took", Date.now() - time, JSON.stringify(ret).length);
+    time = Date.now();
+  }
+
+  return ret;
 }
 
 /**
  * The AccessibleActor provides information about a given accessible object: its
  * role, name, states, etc.
  */
 const AccessibleActor = ActorClassWithSpec(accessibleSpec, {
   initialize(walker, rawAccessible) {
diff --git a/toolkit/content/widgets/browser-custom-element.js b/toolkit/content/widgets/browser-custom-element.js
--- a/toolkit/content/widgets/browser-custom-element.js
+++ b/toolkit/content/widgets/browser-custom-element.js
@@ -1397,16 +1397,33 @@
       if (!this.isRemoteBrowser) {
         return this._receiveMessage(aMessage);
       }
 
       let data = aMessage.data;
       switch (aMessage.name) {
         case "Browser:Init":
           this._outerWindowID = data.outerWindowID;
+          // XXX: move this
+          if (this.a11ymodeBrowser) {
+            console.trace(this, this.parentNode);
+            // setTimeout(() => {
+            // let tab = gBrowser._tabForBrowser.get(this);
+            // console.log(tab, tab.outerWindowID, this._outerWindowID);
+            this.a11ymodeBrowser.loadURI(
+              `about:devtools-toolbox?type=tab&id=${
+                this._outerWindowID
+              }&a11ymode=true`,
+              {
+                triggeringPrincipal: Services.scriptSecurityManager.getSystemPrincipal(),
+              }
+            );
+            // }, 10000);
+          }
+
           break;
         case "DOMTitleChanged":
           this._contentTitle = data.title;
           break;
         default:
           return this._receiveMessage(aMessage);
       }
       return undefined;
