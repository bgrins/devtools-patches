
# HG changeset patch
# User Brian Grinstead <bgrinstead@mozilla.com>
# Date 1516385371 28800
# Node ID 0accdd6e64c4cd2876aedb70eb0152bc847b855b
# Parent  329bfa4b804a69d67cd0018d70bbf4cc970f4a64
Bug 1432950 - Print out memory used by data url for testing with/without xbl handlers on scrollbar

Run with: ./mach run --profile $(mktemp -d) "data:text/html,<div style='height:px'</div>"

diff --git a/browser/base/content/browser.js b/browser/base/content/browser.js
--- a/browser/base/content/browser.js
+++ b/browser/base/content/browser.js
@@ -1551,16 +1551,29 @@ var gBrowserInit = {
 
     SessionStore.promiseAllWindowsRestored.then(() => {
       this._schedulePerWindowIdleTasks();
       document.documentElement.setAttribute("sessionrestored", "true");
     });
 
     Services.obs.notifyObservers(window, "browser-delayed-startup-finished");
     TelemetryTimestamps.add("delayedStartupFinished");
+
+    function printMemoryReport() {
+      var gMgr = Cc["@mozilla.org/memory-reporter-manager;1"].getService(Ci.nsIMemoryReporterManager);
+      var spanMem = 0;
+      function handleReport(aProcess, aUnsafePath, aKind, aUnits, aAmount, aDescription) {
+        if (aUnsafePath.includes("top(data:text\\html,<div") && aUnits === 0) {
+          spanMem += aAmount;
+        }
+      }
+      gMgr.minimizeMemoryUsage(() => gMgr.getReports(handleReport, null, () => { dump("\n\n\nTotal bytes:\n" + spanMem + "\n\n\n"); }, null, false))
+    }
+
+    setInterval(printMemoryReport, 2000);
   },
 
   _setInitialFocus() {
     let initiallyFocusedElement = document.commandDispatcher.focusedElement;
 
     let firstBrowserPaintDeferred = {};
     firstBrowserPaintDeferred.promise = new Promise(resolve => {
       firstBrowserPaintDeferred.resolve = resolve;
