# HG changeset patch
# User Brian Grinstead <bgrinstead@mozilla.com>
# Parent  b7f409bd51c8ae7260c1675785c698a9cb061244
Bug 1491484 - Immediately set `browser` in findbar connectedCallback

diff --git a/toolkit/content/tests/browser/browser_findbar.js b/toolkit/content/tests/browser/browser_findbar.js
--- a/toolkit/content/tests/browser/browser_findbar.js
+++ b/toolkit/content/tests/browser/browser_findbar.js
@@ -6,16 +6,17 @@ const TEST_PAGE_URI = "data:text/html;ch
 // it does not allow 'data:' URI to be loaded in the parent process.
 const E10S_PARENT_TEST_PAGE_URI = "javascript:document.write('The letter s.');";
 
 /**
  * Makes sure that the findbar hotkeys (' and /) event listeners
  * are added to the system event group and do not get blocked
  * by calling stopPropagation on a keypress event on a page.
  */
+
 add_task(async function test_hotkey_event_propagation() {
   info("Ensure hotkeys are not affected by stopPropagation.");
 
   // Opening new tab
   let tab = await BrowserTestUtils.openNewForegroundTab(gBrowser, TEST_PAGE_URI);
   let browser = gBrowser.getBrowserForTab(tab);
   let findbar = await gBrowser.getFindBar();
 
diff --git a/toolkit/content/widgets/findbar.js b/toolkit/content/widgets/findbar.js
--- a/toolkit/content/widgets/findbar.js
+++ b/toolkit/content/widgets/findbar.js
@@ -169,23 +169,16 @@ class MozFindbar extends XULElement {
 
     // Convenience
     this.nsITypeAheadFind = Ci.nsITypeAheadFind;
     this.nsISelectionController = Ci.nsISelectionController;
     this._findSelection = this.nsISelectionController.SELECTION_FIND;
 
     this._findResetTimeout = -1;
 
-    // Make sure the FAYT keypress listener is attached by initializing the
-    // browser property
-    if (this.getAttribute("browserid")) {
-      // eslint-disable-next-line no-self-assign
-      setTimeout(function(aSelf) { aSelf.browser = aSelf.browser; }, 0, this);
-    }
-
     window.addEventListener("unload", this.destroy);
 
     this._findField.addEventListener("input", (event) => {
       // We should do nothing during composition.  E.g., composing string
       // before converting may matches a forward word of expected word.
       // After that, even if user converts the composition string to the
       // expected word, it may find second or later searching word in the
       // document.
@@ -283,16 +276,23 @@ class MozFindbar extends XULElement {
 
     this._findField.addEventListener("drop", (event) => {
       let value = event.dataTransfer.getData("text/plain");
       this._findField.value = value;
       this._find(value);
       event.stopPropagation();
       event.preventDefault();
     });
+
+    // Make sure the FAYT keypress listener is attached by initializing the
+    // browser property
+    if (this.getAttribute("browserid")) {
+      // eslint-disable-next-line no-self-assign
+      this.browser = this.browser;
+    }
   }
 
   set _findMode(val) {
     this.__findMode = val;
     this._updateBrowserWithState();
     return val;
   }
 
