# HG changeset patch
# User Brian Grinstead <bgrinstead@mozilla.com>
# Parent  8bf46ba0297dfecfdbae08edc1166d8a10bbadf8
Simulating messages from worker

diff --git a/devtools/server/actors/webconsole.js b/devtools/server/actors/webconsole.js
--- a/devtools/server/actors/webconsole.js
+++ b/devtools/server/actors/webconsole.js
@@ -424,21 +424,28 @@ WebConsoleActor.prototype =
   makeDebuggeeValue: function WCA_makeDebuggeeValue(aValue, aUseObjectGlobal)
   {
     let global = this.window;
     if (aUseObjectGlobal && typeof aValue == "object") {
       try {
         global = Cu.getGlobalForObject(aValue);
       }
       catch (ex) {
+        dump("Expection " + ex + "\n")
         // The above can throw an exception if aValue is not an actual object.
       }
     }
-    let dbgGlobal = this.dbg.makeGlobalObjectReference(global);
-    return dbgGlobal.makeDebuggeeValue(aValue);
+    // let sbox = this.evalWindow;
+    let sbox = glob2;
+    let dbgGlobal = this.dbg.makeGlobalObjectReference(sbox);
+    /// XXX: Brian.. right here we need to get the global for the Worker
+    dump("Literally about to makeDebuggeeValue" + sbox + " " + this.dbg + " " + dbgGlobal + "\n\n")
+    try {
+      return dbgGlobal.makeDebuggeeValue(aValue);
+    }catch(e) { return {}}
   },
 
   /**
    * Create a grip for the given object.
    *
    * @param object aObject
    *        The object you want.
    * @param object aPool
@@ -541,17 +548,17 @@ WebConsoleActor.prototype =
    *        The JSON request object received from the Web Console client.
    * @return object
    *         The response object which holds the startedListeners array.
    */
   onStartListeners: function WCA_onStartListeners(aRequest)
   {
     // XXXworkers: Not handling the Console API yet for workers (Bug 1209353).
     if (isWorker) {
-       aRequest.listeners = [];
+       aRequest.listeners = ["ConsoleAPI"];
     }
 
     let startedListeners = [];
     let window = !this.parentActor.isRootActor ? this.window : null;
     let appId = null;
     let messageManager = null;
 
     if (this._parentIsContentActor) {
@@ -1346,16 +1353,17 @@ WebConsoleActor.prototype =
    */
   onConsoleAPICall: function WCA_onConsoleAPICall(aMessage)
   {
     let packet = {
       from: this.actorID,
       type: "consoleAPICall",
       message: this.prepareConsoleMessageForRemote(aMessage),
     };
+    dump(JSON.stringify(packet) + "\n\n");
     this.conn.send(packet);
   },
 
   /**
    * Handler for network events. This method is invoked when a new network event
    * is about to be recorded.
    *
    * @see NetworkEventActor
@@ -1527,26 +1535,30 @@ WebConsoleActor.prototype =
    *        If |true| the object global is determined and added as a debuggee,
    *        otherwise |this.window| is used when makeDebuggeeValue() is invoked.
    * @return object
    *         The object that can be sent to the remote client.
    */
   prepareConsoleMessageForRemote:
   function WCA_prepareConsoleMessageForRemote(aMessage, aUseObjectGlobal = true)
   {
+    if (aMessage.fake == true) {
+      return aMessage;
+    }
     let result = WebConsoleUtils.cloneObject(aMessage);
 
     result.workerType = WebConsoleUtils.getWorkerType(result) || "none";
 
     delete result.wrappedJSObject;
     delete result.ID;
     delete result.innerID;
     delete result.consoleID;
 
     result.arguments = Array.map(aMessage.arguments || [], (aObj) => {
+      dump("About to makeDebuggeeValue " + aObj + " " + aUseObjectGlobal + "\n\n");
       let dbgObj = this.makeDebuggeeValue(aObj, aUseObjectGlobal);
       return this.createValueGrip(dbgObj);
     });
 
     result.styles = Array.map(aMessage.styles || [], (aString) => {
       return this.createValueGrip(aString);
     });
 
diff --git a/devtools/shared/webconsole/worker-utils.js b/devtools/shared/webconsole/worker-utils.js
--- a/devtools/shared/webconsole/worker-utils.js
+++ b/devtools/shared/webconsole/worker-utils.js
@@ -1,12 +1,122 @@
 // XXXworkers This file is loaded on the server side for worker debugging.
 // Since the server is running in the worker thread, it doesn't
 // have access to Services / Components.  This functionality
 // is stubbed out to prevent errors, and will need to implemented
 // for Bug 1209353.
 
-exports.Utils = { l10n: function() {} };
+exports.Utils = {
+  l10n: function() {},
+
+  getWorkerType: function() {
+    return null;
+  },
+
+
+  /**
+   * Clone an object.
+   *
+   * @param object aObject
+   *        The object you want cloned.
+   * @param boolean aRecursive
+   *        Tells if you want to dig deeper into the object, to clone
+   *        recursively.
+   * @param function [aFilter]
+   *        Optional, filter function, called for every property. Three
+   *        arguments are passed: key, value and object. Return true if the
+   *        property should be added to the cloned object. Return false to skip
+   *        the property.
+   * @return object
+   *         The cloned object.
+   */
+  cloneObject: function WCU_cloneObject(aObject, aRecursive, aFilter)
+  {
+    return aObject;
+    if (typeof aObject != "object") {
+      return aObject;
+    }
+
+    let temp;
+
+    if (Array.isArray(aObject)) {
+      temp = [];
+      Array.forEach(aObject, function(aValue, aIndex) {
+        if (!aFilter || aFilter(aIndex, aValue, aObject)) {
+          temp.push(aRecursive ? WCU_cloneObject(aValue) : aValue);
+        }
+      });
+    }
+    else {
+      temp = {};
+      for (let key in aObject) {
+        let value = aObject[key];
+        if (aObject.hasOwnProperty(key) &&
+            (!aFilter || aFilter(key, value, aObject))) {
+          temp[key] = aRecursive ? WCU_cloneObject(value) : value;
+        }
+      }
+    }
+
+    return temp;
+  },
+
+
+};
 exports.ConsoleServiceListener = function() {};
-exports.ConsoleAPIListener = function() {};
+
+function ConsoleAPIListener(aWindow, aOwner, aConsoleID)
+{
+  this.window = aWindow;
+  this.owner = aOwner;
+  this.consoleID = aConsoleID;
+  dump("ConsoleAPIListener MADE " + isWorker + " test\n\n");
+}
+ConsoleAPIListener.prototype.init = function() { }
+ConsoleAPIListener.prototype.getCachedMessages = function() {
+
+  // setImmediate(() => {
+    // let packet = {
+    //   from: this.owner.actorID,
+    //   type: "consoleAPICall",
+    //   message: {
+    //     "arguments":["heyo"],
+    //     "columnNumber":1,
+    //     "counter":null,
+    //     "filename":"data:text/html,<script>console.log(\"heyo\")</script>",
+    //     "functionName":"",
+    //     "groupName":"",
+    //     "level":"log",
+    //     "lineNumber":1,
+    //     "private":false,
+    //     "styles":[],
+    //     "timeStamp":1447286288841,
+    //     "timer":null,
+    //     "workerType":"none",
+    //     "category":"webdev"
+    //   }
+    // };
+
+    // this.owner.conn.send(packet);
+  // });
+  return [
+  {
+        "arguments":["heyo", {brian: 1}],
+        "columnNumber":1,
+        "counter":null,
+        "filename":"data:text/html,<script>console.log(\"heyo\")</script>",
+        "functionName":"",
+        "groupName":"",
+        "level":"log",
+        "lineNumber":1,
+        "private":false,
+        "styles":[],
+        "timeStamp":1447286288841,
+        "timer":null,
+        "workerType":"none",
+        "category":"webdev"
+      }
+  ];
+}
+exports.ConsoleAPIListener = ConsoleAPIListener;
 exports.addWebConsoleCommands = function() {};
 exports.ConsoleReflowListener = function() {};
 exports.CONSOLE_WORKER_IDS = [];
diff --git a/devtools/shared/worker/loader.js b/devtools/shared/worker/loader.js
--- a/devtools/shared/worker/loader.js
+++ b/devtools/shared/worker/loader.js
@@ -466,33 +466,34 @@ var {
     return {
       Debugger: this.Debugger,
       createSandbox: this.createSandbox,
       dump: this.dump,
       rpc: this.rpc,
       loadSubScript: this.loadSubScript,
       reportError: this.reportError,
       setImmediate: this.setImmediate,
-      xpcInspector: xpcInspector
+      xpcInspector: xpcInspector,
     };
   }
 }).call(this);
 
 // Create the default instance of the worker loader, using the APIs we defined
 // above.
 
 this.worker = new WorkerDebuggerLoader({
   createSandbox: createSandbox,
   globals: {
+    "glob2": this,
     "isWorker": true,
     "dump": dump,
     "loader": loader,
     "reportError": reportError,
     "rpc": rpc,
-    "setImmediate": setImmediate
+    "setImmediate": setImmediate,
   },
   loadSubScript: loadSubScript,
   modules: {
     "Debugger": Debugger,
     "PromiseDebugging": PromiseDebugging,
     "Services": Object.create(null),
     "chrome": chrome,
     "xpcInspector": xpcInspector
