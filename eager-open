# HG changeset patch
# User Brian Grinstead <bgrinstead@mozilla.com>
# Parent  0160424142d14988f7b30595e03f156c31278a42
Bug 1545700 - Eagerly render <menu> inserted into already-opened menupopup

diff --git a/toolkit/content/widgets/menu.js b/toolkit/content/widgets/menu.js
--- a/toolkit/content/widgets/menu.js
+++ b/toolkit/content/widgets/menu.js
@@ -139,16 +139,17 @@ class MozMenuCaption extends MozMenuBase
 
 customElements.define("menucaption", MozMenuCaption);
 
 // In general, wait to render menus inside menupopups until they are going to be visible:
 window.addEventListener("popupshowing", (e) => {
   if (e.originalTarget.ownerDocument != document) {
     return;
   }
+  e.originalTarget.setAttribute("hasbeenopened", "true");
   for (let menu of e.originalTarget.querySelectorAll("menu")) {
     menu.render();
   }
 }, { capture: true });
 
 const isHiddenWindow = document.documentURI == "chrome://browser/content/hiddenWindow.xul";
 
 class MozMenu extends MozMenuBaseMixin(MozElements.MozElementMixin(XULMenuElement)) {
@@ -174,17 +175,17 @@ class MozMenu extends MozMenuBaseMixin(M
     return this.matches("menubar > menu");
   }
 
   get isSizingPopup() {
     return this.matches("[sizetopopup] menu") || this.matches("menulist menu");
   }
 
   get isInMenupopup() {
-    return this.matches("menupopup menu");
+    return this.matches("menupopup:not([hasbeenopened]) menu");
   }
 
   get isIconic() {
     return this.classList.contains("menu-iconic");
   }
 
   get fragment() {
     let {isMenubarChild, isIconic} = this;
