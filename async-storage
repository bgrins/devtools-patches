# HG changeset patch
# User Brian Grinstead <bgrinstead@mozilla.com>
# Parent  e755879c138c1a3ca96ba9da9f9244cb5bfd755f
Bug 1134265 - Add async-storage for a simple key value store in devtools;r=jryans

diff --git a/toolkit/devtools/Loader.jsm b/toolkit/devtools/Loader.jsm
--- a/toolkit/devtools/Loader.jsm
+++ b/toolkit/devtools/Loader.jsm
@@ -78,16 +78,17 @@ BuiltinProvider.prototype = {
         // When you add a line to this mapping, don't forget to make a
         // corresponding addition to the SrcdirProvider mapping below as well.
         "": "resource://gre/modules/commonjs/",
         "main": "resource:///modules/devtools/main.js",
         "devtools": "resource:///modules/devtools",
         "devtools/toolkit": "resource://gre/modules/devtools",
         "devtools/server": "resource://gre/modules/devtools/server",
         "devtools/toolkit/webconsole": "resource://gre/modules/devtools/toolkit/webconsole",
+        "devtools/toolkit/shared": "resource://gre/modules/devtools/toolkit/shared",
         "devtools/app-actor-front": "resource://gre/modules/devtools/app-actor-front.js",
         "devtools/styleinspector/css-logic": "resource://gre/modules/devtools/styleinspector/css-logic",
         "devtools/css-color": "resource://gre/modules/devtools/css-color",
         "devtools/output-parser": "resource://gre/modules/devtools/output-parser",
         "devtools/touch-events": "resource://gre/modules/devtools/touch-events",
         "devtools/client": "resource://gre/modules/devtools/client",
         "devtools/pretty-fast": "resource://gre/modules/devtools/pretty-fast.js",
         "devtools/jsbeautify": "resource://gre/modules/devtools/jsbeautify/beautify.js",
@@ -134,16 +135,17 @@ SrcdirProvider.prototype = {
     srcdir = OS.Path.normalize(srcdir.data.trim());
     let devtoolsDir = OS.Path.join(srcdir, "browser", "devtools");
     let toolkitDir = OS.Path.join(srcdir, "toolkit", "devtools");
     let mainURI = this.fileURI(OS.Path.join(devtoolsDir, "main.js"));
     let devtoolsURI = this.fileURI(devtoolsDir);
     let toolkitURI = this.fileURI(toolkitDir);
     let serverURI = this.fileURI(OS.Path.join(toolkitDir, "server"));
     let webconsoleURI = this.fileURI(OS.Path.join(toolkitDir, "webconsole"));
+    let sharedURI = this.fileURI(OS.Path.join(toolkitDir, "shared"));
     let appActorURI = this.fileURI(OS.Path.join(toolkitDir, "apps", "app-actor-front.js"));
     let cssLogicURI = this.fileURI(OS.Path.join(toolkitDir, "styleinspector", "css-logic"));
     let cssColorURI = this.fileURI(OS.Path.join(toolkitDir, "css-color"));
     let outputParserURI = this.fileURI(OS.Path.join(toolkitDir, "output-parser"));
     let touchEventsURI = this.fileURI(OS.Path.join(toolkitDir, "touch-events"));
     let clientURI = this.fileURI(OS.Path.join(toolkitDir, "client"));
     let prettyFastURI = this.fileURI(OS.Path.join(toolkitDir), "pretty-fast.js");
     let jsBeautifyURI = this.fileURI(OS.Path.join(toolkitDir, "jsbeautify", "beautify.js"));
@@ -160,16 +162,17 @@ SrcdirProvider.prototype = {
       modules: loaderModules,
       paths: {
         "": "resource://gre/modules/commonjs/",
         "main": mainURI,
         "devtools": devtoolsURI,
         "devtools/toolkit": toolkitURI,
         "devtools/server": serverURI,
         "devtools/toolkit/webconsole": webconsoleURI,
+        "devtools/toolkit/shared": sharedURI,
         "devtools/app-actor-front": appActorURI,
         "devtools/styleinspector/css-logic": cssLogicURI,
         "devtools/css-color": cssColorURI,
         "devtools/output-parser": outputParserURI,
         "devtools/touch-events": touchEventsURI,
         "devtools/client": clientURI,
         "devtools/pretty-fast": prettyFastURI,
         "devtools/jsbeautify": jsBeautifyURI,
diff --git a/toolkit/devtools/moz.build b/toolkit/devtools/moz.build
--- a/toolkit/devtools/moz.build
+++ b/toolkit/devtools/moz.build
@@ -11,16 +11,17 @@ DIRS += [
     'discovery',
     'gcli',
     'jsbeautify',
     'pretty-fast',
     'qrcode',
     'security',
     'server',
     'sourcemap',
+    'shared',
     'styleinspector',
     'tern',
     'transport',
     'webconsole',
 ]
 
 MOCHITEST_CHROME_MANIFESTS += ['tests/mochitest/chrome.ini']
 XPCSHELL_TESTS_MANIFESTS += ['tests/unit/xpcshell.ini']
diff --git a/toolkit/devtools/shared/async-storage.js b/toolkit/devtools/shared/async-storage.js
new file mode 100644
--- /dev/null
+++ b/toolkit/devtools/shared/async-storage.js
@@ -0,0 +1,198 @@
+/**
+ *
+ * Adapted from https://github.com/mozilla-b2g/gaia/blob/master/shared/js/async_storage.js
+ * (converted to use Promises instead of callbacks).
+ *
+ * This file defines an asynchronous version of the localStorage API, backed by
+ * an IndexedDB database.  It creates a global asyncStorage object that has
+ * methods like the localStorage object.
+ *
+ * To store a value use setItem:
+ *
+ *   asyncStorage.setItem("key", "value");
+ *
+ * This returns a promise in case you want confirmation that the value has been stored.
+ *
+ *  asyncStorage.setItem("key", "newvalue").then(function() {
+ *    console.log("new value stored");
+ *  });
+ *
+ * To read a value, call getItem(), but note that you must wait for a promise
+ * resolution for the value to be retrieved.
+ *
+ *  asyncStorage.getItem("key").then(function(value) {
+ *    console.log("The value of key is:", value);
+ *  });
+ *
+ * Note that unlike localStorage, asyncStorage does not allow you to store and
+ * retrieve values by setting and querying properties directly. You cannot just
+ * write asyncStorage.key; you have to explicitly call setItem() or getItem().
+ *
+ * removeItem(), clear(), length(), and key() are like the same-named methods of
+ * localStorage, and all return a promise.
+ *
+ * The asynchronous nature of getItem() makes it tricky to retrieve multiple
+ * values. But unlike localStorage, asyncStorage does not require the values you
+ * store to be strings.  So if you need to save multiple values and want to
+ * retrieve them together, in a single asynchronous operation, just group the
+ * values into a single object. The properties of this object may not include
+ * DOM elements, but they may include things like Blobs and typed arrays.
+ *
+ */
+
+const {Cc, Ci, Cu, Cr} = require("chrome");
+Cu.importGlobalProperties(["indexedDB"]);
+const {Promise} = Cu.import("resource://gre/modules/Promise.jsm", {});
+
+module.exports = (function() {
+  "use strict";
+
+  var DBNAME = "asyncStorage";
+  var DBVERSION = 1;
+  var STORENAME = "keyvaluepairs";
+  var db = null;
+
+  function withDatabase(f) {
+    if (db) {
+      f();
+    } else {
+      var openreq = indexedDB.open(DBNAME, DBVERSION);
+      openreq.onerror = function withStoreOnError() {
+        f();
+      };
+      openreq.onupgradeneeded = function withStoreOnUpgradeNeeded() {
+        // First time setup: create an empty object store
+        openreq.result.createObjectStore(STORENAME);
+      };
+      openreq.onsuccess = function withStoreOnSuccess() {
+        db = openreq.result;
+        f();
+      };
+    }
+  }
+
+  function withStore(type, callback, oncomplete) {
+    withDatabase(function() {
+      if (!db) {
+
+      }
+      var transaction = db.transaction(STORENAME, type);
+      if (oncomplete) {
+        transaction.oncomplete = oncomplete;
+      }
+      callback(transaction.objectStore(STORENAME));
+    });
+  }
+
+  function getItem(key) {
+    return new Promise((resolve, reject) => {
+      var req;
+      withStore("readonly", function getItemBody(store) {
+        req = store.get(key);
+        req.onerror = function getItemOnError() {
+          reject("Error in asyncStorage.getItem(): ", req.error.name);
+        };
+      }, function onComplete() {
+        var value = req.result;
+        if (value === undefined) {
+          value = null;
+        }
+        resolve(value);
+      });
+    });
+  }
+
+  function setItem(key, value) {
+    return new Promise((resolve, reject) => {
+      withStore("readwrite", function setItemBody(store) {
+        var req = store.put(value, key);
+        req.onerror = function setItemOnError() {
+          reject("Error in asyncStorage.setItem(): ", req.error.name);
+        };
+      }, resolve);
+    });
+  }
+
+  function removeItem(key) {
+    return new Promise((resolve, reject) => {
+      withStore("readwrite", function removeItemBody(store) {
+        var req = store.delete(key);
+        req.onerror = function removeItemOnError() {
+          reject("Error in asyncStorage.removeItem(): ", req.error.name);
+        };
+      }, resolve);
+    });
+  }
+
+  function clear() {
+    return new Promise((resolve, reject) => {
+      withStore("readwrite", function clearBody(store) {
+        var req = store.clear();
+        req.onerror = function clearOnError() {
+          reject("Error in asyncStorage.clear(): ", req.error.name);
+        };
+      }, resolve);
+    });
+  }
+
+  function length() {
+    return new Promise((resolve, reject) => {
+      var req;
+      withStore("readonly", function lengthBody(store) {
+        req = store.count();
+        req.onerror = function lengthOnError() {
+          reject("Error in asyncStorage.length(): ", req.error.name);
+        };
+      }, function onComplete() {
+        resolve(req.result);
+      });
+    });
+  }
+
+  function key(n) {
+    return new Promise((resolve, reject) => {
+      if (n < 0) {
+        resolve(null);
+        return;
+      }
+
+      var req;
+      withStore("readonly", function keyBody(store) {
+        var advanced = false;
+        req = store.openCursor();
+        req.onsuccess = function keyOnSuccess() {
+          var cursor = req.result;
+          if (!cursor) {
+            // this means there weren"t enough keys
+            return;
+          }
+          if (n === 0 || advanced) {
+            // Either 1) we have the first key, return it if that's what they
+            // wanted, or 2) we"ve got the nth key.
+            return;
+          }
+
+          // Otherwise, ask the cursor to skip ahead n records
+          advanced = true;
+          cursor.advance(n);
+        };
+        req.onerror = function keyOnError() {
+          reject("Error in asyncStorage.key(): ", req.error.name);
+        };
+      }, function onComplete() {
+        var cursor = req.result;
+        resolve(cursor ? cursor.key : null);
+      });
+    });
+  }
+
+  return {
+    getItem: getItem,
+    setItem: setItem,
+    removeItem: removeItem,
+    clear: clear,
+    length: length,
+    key: key
+  };
+}());
+
diff --git a/toolkit/devtools/shared/moz.build b/toolkit/devtools/shared/moz.build
new file mode 100644
--- /dev/null
+++ b/toolkit/devtools/shared/moz.build
@@ -0,0 +1,11 @@
+# -*- Mode: python; c-basic-offset: 4; indent-tabs-mode: nil; tab-width: 40 -*-
+# vim: set filetype=python:
+# This Source Code Form is subject to the terms of the Mozilla Public
+# License, v. 2.0. If a copy of the MPL was not distributed with this
+# file, You can obtain one at http://mozilla.org/MPL/2.0/.
+
+BROWSER_CHROME_MANIFESTS += ['tests/browser/browser.ini']
+
+EXTRA_JS_MODULES.devtools.toolkit.shared += [
+    'async-storage.js',
+]
diff --git a/toolkit/devtools/shared/tests/browser/browser.ini b/toolkit/devtools/shared/tests/browser/browser.ini
new file mode 100644
--- /dev/null
+++ b/toolkit/devtools/shared/tests/browser/browser.ini
@@ -0,0 +1,6 @@
+[DEFAULT]
+subsuite = devtools
+support-files =
+  ../../../server/tests/browser/head.js
+
+[browser_async_storage.js]
\ No newline at end of file
diff --git a/toolkit/devtools/shared/tests/browser/browser_async_storage.js b/toolkit/devtools/shared/tests/browser/browser_async_storage.js
new file mode 100644
--- /dev/null
+++ b/toolkit/devtools/shared/tests/browser/browser_async_storage.js
@@ -0,0 +1,77 @@
+/* vim: set ft=javascript ts=2 et sw=2 tw=80: */
+/* Any copyright is dedicated to the Public Domain.
+   http://creativecommons.org/publicdomain/zero/1.0/ */
+
+"use strict";
+
+// Test the basic functionality of async-storage.
+// Adapted from https://github.com/mozilla-b2g/gaia/blob/master/apps/sharedtest/test/unit/async_storage_test.js.
+
+const asyncStorage = require("devtools/toolkit/shared/async-storage");
+add_task(function*() {
+  is(typeof asyncStorage.length, 'function', "API exists.");
+  is(typeof asyncStorage.key, 'function', "API exists.");
+  is(typeof asyncStorage.getItem, 'function', "API exists.");
+  is(typeof asyncStorage.setItem, 'function', "API exists.");
+  is(typeof asyncStorage.removeItem, 'function', "API exists.");
+  is(typeof asyncStorage.clear, 'function', "API exists.");
+});
+
+add_task(function*() {
+  yield asyncStorage.setItem('foo', 'bar');
+  let value = yield asyncStorage.getItem('foo');
+  is(value, 'bar', 'value is correct');
+  yield asyncStorage.setItem('foo', 'overwritten');
+  value = yield asyncStorage.getItem('foo');
+  is(value, 'overwritten', 'value is correct');
+  yield asyncStorage.removeItem('foo');
+  value = yield asyncStorage.getItem('foo');
+  is(value, null, 'value is correct');
+});
+
+add_task(function*() {
+  var object = {
+    x: 1,
+    y: 'foo',
+    z: true
+  };
+
+  yield asyncStorage.setItem('myobj', object);
+  let value = yield asyncStorage.getItem('myobj');
+  is(object.x, value.x, 'value is correct');
+  is(object.y, value.y, 'value is correct');
+  is(object.z, value.z, 'value is correct');
+  yield asyncStorage.removeItem('myobj');
+  value = yield asyncStorage.getItem('myobj');
+  is(value, null, 'value is correct');
+});
+
+add_task(function*() {
+  yield asyncStorage.clear();
+  let len = yield asyncStorage.length();
+  is(len, 0, 'length is correct');
+  yield asyncStorage.setItem('key1', 'value1');
+  len = yield asyncStorage.length();
+  is(len, 1, 'length is correct');
+  yield asyncStorage.setItem('key2', 'value2');
+  len = yield asyncStorage.length();
+  is(len, 2, 'length is correct');
+  yield asyncStorage.setItem('key3', 'value3');
+  len = yield asyncStorage.length();
+  is(len, 3, 'length is correct');
+
+  let key = yield asyncStorage.key(0);
+  is(key, 'key1', 'key is correct');
+  key = yield asyncStorage.key(1);
+  is(key, 'key2', 'key is correct');
+  key = yield asyncStorage.key(2);
+  is(key, 'key3', 'key is correct');
+  key = yield asyncStorage.key(3);
+  is(key, null, 'key is correct');
+  yield asyncStorage.clear();
+  key = yield asyncStorage.key(0);
+  is(key, null, 'key is correct');
+
+  len = yield asyncStorage.length();
+  is(len, 0, 'length is correct');
+});
