# HG changeset patch
# User Brian Grinstead <bgrinstead@mozilla.com>
# Parent  33b92d9c40562dab3d7b602368c75619f1d793f7
Bug 1355324 - Create sidebar header switcher

MozReview-Commit-ID: HBwIfmtKybi

diff --git a/addon-sdk/source/test/test-ui-sidebar.js b/addon-sdk/source/test/test-ui-sidebar.js
--- a/addon-sdk/source/test/test-ui-sidebar.js
+++ b/addon-sdk/source/test/test-ui-sidebar.js
@@ -1239,17 +1239,17 @@ exports.testShowToOpenXToClose = functio
   assert.ok(!isChecked(menuitem), 'menuitem is not checked');
 
   sidebar.show();
 
   yield shown.promise;
 
   assert.ok(isChecked(menuitem), 'menuitem is checked');
 
-  let closeButton = window.document.querySelector('#sidebar-header > toolbarbutton.close-icon');
+  let closeButton = window.document.querySelector('#sidebar-close');
   simulateCommand(closeButton);
 
   yield hidden.promise;
 
   assert.ok(!isChecked(menuitem), 'menuitem is not checked');
 
   sidebar.destroy();
 }
diff --git a/browser/base/content/browser-sidebar.js b/browser/base/content/browser-sidebar.js
--- a/browser/base/content/browser-sidebar.js
+++ b/browser/base/content/browser-sidebar.js
@@ -26,30 +26,92 @@ var SidebarUI = {
   _title: null,
   _splitter: null,
 
   init() {
     this._box = document.getElementById("sidebar-box");
     this.browser = document.getElementById("sidebar");
     this._title = document.getElementById("sidebar-title");
     this._splitter = document.getElementById("sidebar-splitter");
+    this._icon = document.getElementById("sidebar-icon");
+    this._switcherPanel = document.getElementById("sidebarMenu-popup");
+    this._switcherTarget = document.getElementById("sidebar-switcher-target");
+    this._switcherArrow = document.getElementById("sidebar-switcher-arrow");
+
+    this._switcherTarget.addEventListener("click", () => {
+      this.toggleSwitcherPanel();
+    });
   },
 
   uninit() {
     let enumerator = Services.wm.getEnumerator(null);
     enumerator.getNext();
     if (!enumerator.hasMoreElements()) {
       document.persist("sidebar-box", "sidebarcommand");
       document.persist("sidebar-box", "width");
       document.persist("sidebar-box", "src");
       document.persist("sidebar-title", "value");
     }
   },
 
   /**
+   * Opens the switcher panel if it's closed, or closes it if it's open.
+   */
+  toggleSwitcherPanel() {
+    if (this._switcherPanel.state == "open") {
+      this._switcherPanel.hidePopup();
+    } else if (this._switcherPanel.state == "closed") {
+      this.showSwitcherPanel();
+    }
+  },
+
+  hideSwitcherPanel() {
+    return new Promise(resolve => {
+      this._switcherPanel.addEventListener("popuphidden", () => {
+        resolve();
+      }, {once: true});
+      this._switcherPanel.hidePopup();
+    });
+  },
+
+  showSwitcherPanel() {
+    this._ensureShortcutsShown();
+    return new Promise(resolve => {
+      if (this._switcherPanel.state == "open") {
+        resolve();
+        return;
+      }
+      this._switcherPanel.addEventListener("popuphidden", () => {
+        this._switcherPanel.hidden = true;
+      }, {once: true});
+      this._switcherPanel.hidden = false;
+      this._switcherPanel.openPopup(this._icon);
+      this._switcherPanel.addEventListener("popupshown", () => {
+        resolve();
+      }, {once: true});
+    });
+  },
+
+  _addedShortcuts: false,
+  _ensureShortcutsShown() {
+    if (this._addedShortcuts) {
+      return;
+    }
+    this._addedShortcuts = true;
+    for (let button of this._switcherPanel.querySelectorAll("toolbarbutton[key]")) {
+      let keyId = button.getAttribute("key");
+      let key = document.getElementById(keyId);
+      if (!key) {
+        continue;
+      }
+      button.setAttribute("shortcut", ShortcutUtils.prettifyShortcut(key));
+    }
+  },
+
+  /**
    * Try and adopt the status of the sidebar from another window.
    * @param {Window} sourceWindow - Window to use as a source for sidebar status.
    * @return true if we adopted the state, or false if the caller should
    * initialize the state itself.
    */
   adoptFromWindow(sourceWindow) {
     // If the opener had a sidebar, open the same sidebar in our window.
     // The opener can be the hidden window too, if we're coming from the state
@@ -217,16 +279,18 @@ var SidebarUI = {
         } else {
           sidebarBroadcaster.setAttribute("checked", "true");
         }
       }
 
       this._box.hidden = false;
       this._splitter.hidden = false;
 
+      this.hideSwitcherPanel();
+
       this._box.setAttribute("sidebarcommand", sidebarBroadcaster.id);
       this.lastOpenedId = sidebarBroadcaster.id;
 
       let title = sidebarBroadcaster.getAttribute("sidebartitle");
       if (!title) {
         title = sidebarBroadcaster.getAttribute("label");
       }
       this._title.value = title;
@@ -271,16 +335,18 @@ var SidebarUI = {
   /**
    * Hide the sidebar.
    */
   hide() {
     if (!this.isOpen) {
       return;
     }
 
+    this.hideSwitcherPanel();
+
     let commandID = this._box.getAttribute("sidebarcommand");
     let sidebarBroadcaster = document.getElementById(commandID);
 
     if (sidebarBroadcaster.getAttribute("checked") != "true") {
       return;
     }
 
     // Replace the document currently displayed in the sidebar with about:blank
diff --git a/browser/base/content/browser.xul b/browser/base/content/browser.xul
--- a/browser/base/content/browser.xul
+++ b/browser/base/content/browser.xul
@@ -1083,19 +1083,65 @@
 
   <hbox id="fullscr-toggler" hidden="true"/>
 
   <deck id="content-deck" flex="1">
     <hbox flex="1" id="browser">
       <vbox id="browser-border-start" hidden="true" layer="true"/>
       <vbox id="sidebar-box" hidden="true" class="chromeclass-extrachrome">
         <sidebarheader id="sidebar-header" align="center">
-          <label id="sidebar-title" persist="value" flex="1" crop="end" control="sidebar"/>
+          <panel id="sidebarMenu-popup"
+                 class="cui-widget-panel"
+                 role="group"
+                 type="arrow"
+                 hidden="true"
+                 flip="slide"
+                 position="bottomcenter topleft"
+                 noautofocus="true">
+            <panelmultiview id="sidebarMenu-multiView" mainViewId="sidebarMenu-mainView">
+              <panelview id="sidebarMenu-mainView" class="cui-widget-panelview PanelUI-subView">
+                <vbox class="panel-subview-body">
+                    <toolbarbutton id="sidebar-switcher-bookmarks"
+                                   class="subviewbutton subviewbutton-iconic"
+                                   key="viewBookmarksSidebarKb"
+                                   observes="viewBookmarksSidebar"
+                                   oncommand="SidebarUI.show('viewBookmarksSidebar');">
+                       <observes element="viewBookmarksSidebar" attribute="checked"/>
+                     </toolbarbutton>
+                    <toolbarbutton id="sidebar-switcher-history"
+                                   label="&historyButton.label;"
+                                   class="subviewbutton subviewbutton-iconic"
+                                   key="key_gotoHistory"
+                                   observes="viewHistorySidebar"
+                                   oncommand="SidebarUI.show('viewHistorySidebar');">
+                       <observes element="viewHistorySidebar" attribute="checked"/>
+                     </toolbarbutton>
+                    <toolbarbutton id="sidebar-switcher-tabs"
+                                   label="&syncedTabs.sidebar.label;"
+                                   class="subviewbutton subviewbutton-iconic"
+                                   observes="viewTabsSidebar"
+                                   oncommand="SidebarUI.show('viewTabsSidebar');">
+                       <observes element="viewTabsSidebar" attribute="checked"/>
+                     </toolbarbutton>
+                    <toolbarseparator/>
+                    <toolbarbutton label="&sidebarCloseButton.tooltip;"
+                                   class="subviewbutton"
+                                   oncommand="SidebarUI.hide()"/>
+                </vbox>
+              </panelview>
+            </panelmultiview>
+          </panel>
+          <box id="sidebar-switcher-target" flex="1">
+            <image id="sidebar-icon"/>
+            <label id="sidebar-title" persist="value" crop="end" control="sidebar"/>
+            <image id="sidebar-switcher-arrow"/>
+            <spacer flex="1"/>
+          </box>
           <image id="sidebar-throbber"/>
-          <toolbarbutton class="close-icon tabbable" tooltiptext="&sidebarCloseButton.tooltip;" oncommand="SidebarUI.hide();"/>
+          <toolbarbutton id="sidebar-close" class="tabbable" tooltiptext="&sidebarCloseButton.tooltip;" oncommand="SidebarUI.hide();"/>
         </sidebarheader>
         <browser id="sidebar" flex="1" autoscroll="false" disablehistory="true" disablefullscreen="true"
                   style="min-width: 14em; width: 18em; max-width: 36em;" tooltip="aHTMLTooltip"/>
       </vbox>
 
       <splitter id="sidebar-splitter" class="chromeclass-extrachrome sidebar-splitter" hidden="true"/>
       <vbox id="appcontent" flex="1">
         <notificationbox id="high-priority-global-notificationbox" notificationside="top"/>
diff --git a/browser/base/content/test/sidebar/browser.ini b/browser/base/content/test/sidebar/browser.ini
new file mode 100644
--- /dev/null
+++ b/browser/base/content/test/sidebar/browser.ini
@@ -0,0 +1,3 @@
+[DEFAULT]
+
+[browser_sidebar_switcher.js]
diff --git a/browser/base/content/test/sidebar/browser_sidebar_switcher.js b/browser/base/content/test/sidebar/browser_sidebar_switcher.js
new file mode 100644
--- /dev/null
+++ b/browser/base/content/test/sidebar/browser_sidebar_switcher.js
@@ -0,0 +1,40 @@
+
+add_task(function* () {
+  // If a sidebar is already open, close it.
+  if (!document.getElementById("sidebar-box").hidden) {
+    info("Unexpected sidebar found - a previous test failed to cleanup correctly");
+    SidebarUI.hide();
+  }
+
+  let sidebar = document.querySelector("#sidebar-box");
+  let sidebarPopup = document.querySelector("#sidebarMenu-popup");
+  let switcherPromise = null;
+  yield SidebarUI.show("viewBookmarksSidebar");
+
+  yield SidebarUI.showSwitcherPanel();
+  switcherPromise = Promise.all([
+    BrowserTestUtils.waitForEvent(window, "SidebarFocused"),
+    BrowserTestUtils.waitForEvent(sidebarPopup, "popuphidden"),
+  ]);
+  sidebar.querySelector("#sidebar-switcher-history").click();
+  yield switcherPromise;
+  is(sidebar.getAttribute("sidebarcommand"), "viewHistorySidebar", "History sidebar loaded");
+
+  yield SidebarUI.showSwitcherPanel();
+  switcherPromise = Promise.all([
+    BrowserTestUtils.waitForEvent(window, "SidebarFocused"),
+    BrowserTestUtils.waitForEvent(sidebarPopup, "popuphidden"),
+  ]);
+  sidebar.querySelector("#sidebar-switcher-tabs").click();
+  yield switcherPromise;
+  is(sidebar.getAttribute("sidebarcommand"), "viewTabsSidebar", "Tabs sidebar loaded");
+
+  yield SidebarUI.showSwitcherPanel();
+  switcherPromise = Promise.all([
+    BrowserTestUtils.waitForEvent(window, "SidebarFocused"),
+    BrowserTestUtils.waitForEvent(sidebarPopup, "popuphidden"),
+  ]);
+  sidebar.querySelector("#sidebar-switcher-bookmarks").click();
+  yield switcherPromise;
+  is(sidebar.getAttribute("sidebarcommand"), "viewBookmarksSidebar", "Bookmarks sidebar loaded");
+});
diff --git a/browser/base/moz.build b/browser/base/moz.build
--- a/browser/base/moz.build
+++ b/browser/base/moz.build
@@ -21,16 +21,17 @@ BROWSER_CHROME_MANIFESTS += [
     'content/test/general/browser.ini',
     'content/test/newtab/browser.ini',
     'content/test/pageinfo/browser.ini',
     'content/test/permissions/browser.ini',
     'content/test/plugins/browser.ini',
     'content/test/popupNotifications/browser.ini',
     'content/test/popups/browser.ini',
     'content/test/referrer/browser.ini',
+    'content/test/sidebar/browser.ini',
     'content/test/siteIdentity/browser.ini',
     'content/test/social/browser.ini',
     'content/test/static/browser.ini',
     'content/test/sync/browser.ini',
     'content/test/tabcrashed/browser.ini',
     'content/test/tabPrompts/browser.ini',
     'content/test/tabs/browser.ini',
     'content/test/urlbar/browser.ini',
diff --git a/browser/themes/linux/browser.css b/browser/themes/linux/browser.css
--- a/browser/themes/linux/browser.css
+++ b/browser/themes/linux/browser.css
@@ -982,23 +982,18 @@ html|span.ac-emphasize-text-url {
 }
 
 /* Implements editBookmarkPanel resizing on folderTree un-collapse. */
 #editBMPanel_folderTree {
   min-width: 27em;
 }
 
 /* Content area */
-#sidebar {
-  background-color: Window;
-}
 
-#sidebar-header > .close-icon:not(:hover):-moz-lwtheme-brighttext {
-  background-image: -moz-image-rect(url("chrome://global/skin/icons/close.svg"), 0, 80, 16, 64);
-}
+%include ../shared/sidebar.inc.css
 
 .browserContainer > findbar {
   background-color: -moz-dialog;
   color: -moz-DialogText;
   text-shadow: none;
 }
 
 /* Tabstrip */
@@ -1152,22 +1147,16 @@ html|span.ac-emphasize-text-url {
 .alltabs-item[selected="true"] {
   font-weight: bold;
 }
 
 .alltabs-item[busy] > .menu-iconic-left > .menu-iconic-icon {
   list-style-image: url("chrome://global/skin/icons/loading.png");
 }
 
-/* Sidebar */
-#sidebar-throbber[loading="true"] {
-  list-style-image: url("chrome://global/skin/icons/loading.png");
-  margin-inline-end: 4px;
-}
-
 toolbarbutton.chevron {
   list-style-image: url("chrome://global/skin/toolbar/chevron.gif") !important;
 }
 
 toolbar[brighttext] toolbarbutton.chevron {
   list-style-image: url("chrome://global/skin/toolbar/chevron-inverted.png") !important;
 }
 
diff --git a/browser/themes/osx/browser.css b/browser/themes/osx/browser.css
--- a/browser/themes/osx/browser.css
+++ b/browser/themes/osx/browser.css
@@ -1409,88 +1409,26 @@ html|span.ac-emphasize-text-url {
 #historySwipeAnimationNextPage {
   box-shadow: 0 3px 6px rgba(0, 0, 0, 0.6);
 }
 
 #historySwipeAnimationContainer {
   background: url("chrome://browser/skin/subtle-pattern.png") #B3B9C1;
 }
 
+
 /* ----- SIDEBAR ELEMENTS ----- */
 
+%include ../shared/sidebar.inc.css
+
 #sidebar-box {
   -moz-appearance: -moz-mac-source-list;
-  box-shadow: inset -2px 0 0 hsla(0,0%,100%,.2);
-}
-
-sidebarheader {
-  padding: 2px 2px 0;
-  text-shadow: 0 1px 0 hsla(0,0%,100%,.5);
-}
-
-.sidebar-splitter {
-  border-inline-start: none;
-  border-inline-end: 1px solid #b4b4b4;
-  min-width: 1px;
-  width: 3px;
-  background-image: none !important;
-  background-color: transparent;
-  margin-inline-start: -3px;
-  position: relative;
-}
-
-#appcontent ~ .sidebar-splitter {
-  border-inline-start: 1px solid #ccc;
-  border-inline-end: none;
-  margin-inline-start: 0;
-  margin-inline-end: -3px;
-}
-
-.sidebar-title,
-#sidebar-title {
-  color: #596c80;
-  font-weight: bold;
+  -moz-context-properties: fill;
 }
 
-.sidebar-title:-moz-window-inactive,
-#sidebar-title:-moz-window-inactive {
-  color: #868b92;
-}
-
-.sidebar-throbber[loading="true"],
-#sidebar-throbber[loading="true"] {
-  list-style-image: url("chrome://global/skin/icons/loading.png");
-}
-
-@media (min-resolution: 2dppx) {
-  .sidebar-throbber[loading="true"],
-  #sidebar-throbber[loading="true"] {
-    list-style-image: url("chrome://global/skin/icons/loading@2x.png");
-    width: 16px;
-  }
-}
-
-@media (-moz-mac-yosemite-theme) {
-  #sidebar-box {
-    box-shadow: none;
-  }
-
-  sidebarheader {
-    text-shadow: none;
-    font-weight: 500;
-  }
-
-  .sidebar-title,
-  #sidebar-title {
-    color: #636363;
-    font-weight: 500;
-  }
-}
-
-
 /* ----- CONTENT ----- */
 
 .browserContainer > findbar {
   background: @scopeBarBackground@;
   border-top: @scopeBarSeparatorBorder@;
   color: -moz-DialogText;
   text-shadow: none;
 }
diff --git a/browser/themes/shared/jar.inc.mn b/browser/themes/shared/jar.inc.mn
--- a/browser/themes/shared/jar.inc.mn
+++ b/browser/themes/shared/jar.inc.mn
@@ -43,16 +43,21 @@
   skin/classic/browser/customizableui/menuPanel-customizeFinish.png  (../shared/customizableui/menuPanel-customizeFinish.png)
   skin/classic/browser/customizableui/menuPanel-customizeFinish@2x.png  (../shared/customizableui/menuPanel-customizeFinish@2x.png)
   skin/classic/browser/customizableui/panelarrow-customizeTip.png  (../shared/customizableui/panelarrow-customizeTip.png)
   skin/classic/browser/customizableui/panelarrow-customizeTip@2x.png  (../shared/customizableui/panelarrow-customizeTip@2x.png)
   skin/classic/browser/customizableui/subView-arrow-back-inverted.png  (../shared/customizableui/subView-arrow-back-inverted.png)
   skin/classic/browser/customizableui/subView-arrow-back-inverted@2x.png  (../shared/customizableui/subView-arrow-back-inverted@2x.png)
   skin/classic/browser/customizableui/subView-arrow-back-inverted-rtl.png  (../shared/customizableui/subView-arrow-back-inverted-rtl.png)
   skin/classic/browser/customizableui/subView-arrow-back-inverted-rtl@2x.png  (../shared/customizableui/subView-arrow-back-inverted-rtl@2x.png)
+  skin/classic/browser/sidebar/arrow-dropdown-12.svg           (../shared/sidebar/arrow-dropdown-12.svg)
+  skin/classic/browser/sidebar/bookmark-16-outline.svg         (../shared/sidebar/bookmark-16-outline.svg)
+  skin/classic/browser/sidebar/close-16.svg                    (../shared/sidebar/close-16.svg)
+  skin/classic/browser/sidebar/history-16.svg                  (../shared/sidebar/history-16.svg)
+  skin/classic/browser/sidebar/sync-16.svg                     (../shared/sidebar/sync-16.svg)
   skin/classic/browser/customizableui/whimsy.png               (../shared/customizableui/whimsy.png)
   skin/classic/browser/customizableui/whimsy@2x.png            (../shared/customizableui/whimsy@2x.png)
   skin/classic/browser/downloads/contentAreaDownloadsView.css  (../shared/downloads/contentAreaDownloadsView.css)
   skin/classic/browser/downloads/download-blocked.svg          (../shared/downloads/download-blocked.svg)
   skin/classic/browser/downloads/download-summary.svg          (../shared/downloads/download-summary.svg)
   skin/classic/browser/drm-icon.svg                            (../shared/drm-icon.svg)
   skin/classic/browser/fullscreen/insecure.svg                 (../shared/fullscreen/insecure.svg)
   skin/classic/browser/fullscreen/secure.svg                   (../shared/fullscreen/secure.svg)
diff --git a/browser/themes/shared/sidebar.inc.css b/browser/themes/shared/sidebar.inc.css
new file mode 100644
--- /dev/null
+++ b/browser/themes/shared/sidebar.inc.css
@@ -0,0 +1,91 @@
+
+sidebarheader {
+  padding: 4px;
+  background-color: #F2F2F2;
+  text-shadow: none;
+}
+
+.sidebar-splitter {
+  -moz-appearance: none;
+  border: 0 solid #ccc;
+  border-inline-end-width: 1px;
+  min-width: 1px;
+  width: 3px;
+  background-image: none !important;
+  background-color: transparent;
+  margin-inline-start: -3px;
+  position: relative;
+}
+
+#appcontent ~ .sidebar-splitter {
+  border-inline-end-width: 0;
+  border-inline-start-width: 1px;
+  margin-inline-start: 0;
+  margin-inline-end: -3px;
+}
+
+/* TODO: Why both by ID and class? */
+.sidebar-title,
+#sidebar-title {
+  margin: 0;
+  padding: 0;
+  padding-inline-start: 8px;
+  padding-inline-end: 4px;
+  color: #051126;
+  font-size: 13px;
+  /* TODO: what's the correct full font stack? */
+  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
+}
+
+#sidebar-switcher-arrow {
+  list-style-image: url(chrome://browser/skin/sidebar/arrow-dropdown-12.svg);
+  width: 12px;
+  height: 12px;
+}
+
+#sidebar-close {
+  -moz-appearance: none;
+  list-style-image: url(chrome://browser/skin/sidebar/close-16.svg);
+  margin: 0;
+  padding: 4px;
+}
+
+#sidebar-switcher-target {
+  padding: 4px;
+  margin-inline-end: 4px;
+}
+
+#sidebar-box #sidebar-switcher-target:hover,
+#sidebar-box #sidebarMenu-popup[panelopen] ~ #sidebar-switcher-target,
+#sidebar-close:hover {
+  background: rgba(204, 204, 204, 0.6);
+}
+
+#sidebarMenu-popup .subviewbutton {
+  min-width: 190px;
+}
+
+%ifndef XP_MACOSX
+/* Allow room for the checkbox drawn as a background image at the start of the toolbarbutton */
+#sidebarMenu-popup .subviewbutton-iconic > .toolbarbutton-icon {
+  padding-inline-start: 16px;
+}
+#sidebarMenu-popup .subviewbutton-iconic > .toolbarbutton-text {
+  padding-inline-start: 0;
+}
+%endif
+
+#sidebar-switcher-bookmarks > .toolbarbutton-icon,
+#sidebar-box[sidebarcommand="viewBookmarksSidebar"] #sidebar-icon {
+  list-style-image: url(chrome://browser/skin/sidebar/bookmark-16-outline.svg);
+}
+
+#sidebar-switcher-history > .toolbarbutton-icon,
+#sidebar-box[sidebarcommand="viewHistorySidebar"] #sidebar-icon {
+  list-style-image: url(chrome://browser/skin/sidebar/history-16.svg);
+}
+
+#sidebar-switcher-tabs > .toolbarbutton-icon,
+#sidebar-box[sidebarcommand="viewTabsSidebar"] #sidebar-icon {
+  list-style-image: url(chrome://browser/skin/sidebar/sync-16.svg);
+}
\ No newline at end of file
diff --git a/browser/themes/shared/sidebar/bookmark-16-outline.svg b/browser/themes/shared/sidebar/bookmark-16-outline.svg
new file mode 100644
--- /dev/null
+++ b/browser/themes/shared/sidebar/bookmark-16-outline.svg
@@ -0,0 +1,3 @@
+<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 16 16">
+  <path fill="context-fill" d="M3.8 15.922a1.1 1.1 0 0 1-1.09-1.253l.609-4.36L.393 7.163a1.1 1.1 0 0 1 .616-1.833l4.08-.73L7.016.734a1.1 1.1 0 0 1 1.969 0L10.911 4.6 15 5.331a1.1 1.1 0 0 1 .611 1.833L12.68 10.31l.609 4.359a1.1 1.1 0 0 1-1.6 1.127L8 13.873 4.308 15.8a1.093 1.093 0 0 1-.508.122zm-.415-1.9zm9.228 0zM2.981 7.01l2.451 2.635-.5 3.572L8 11.618l3.067 1.6-.5-3.572 2.452-2.636-3.45-.616L8 3.244l-1.569 3.15zm11.659.29zm-13.278 0zm12.78-1.5zm-12.286 0z"/>
+</svg>
diff --git a/browser/themes/shared/sidebar/close-16.svg b/browser/themes/shared/sidebar/close-16.svg
new file mode 100644
--- /dev/null
+++ b/browser/themes/shared/sidebar/close-16.svg
@@ -0,0 +1,3 @@
+<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 16 16">
+  <path fill="context-fill" d="M9.061,8l3.47-3.47A.75.75,0,0,0,11.47,3.47L8,6.939,4.53,3.47A.75.75,0,0,0,3.47,4.53L6.939,8,3.47,11.47A.75.75,0,1,0,4.53,12.53L8,9.061l3.47,3.47A.75.75,0,0,0,12.53,11.47Z"/>
+</svg>
diff --git a/browser/themes/shared/sidebar/history-16.svg b/browser/themes/shared/sidebar/history-16.svg
new file mode 100644
--- /dev/null
+++ b/browser/themes/shared/sidebar/history-16.svg
@@ -0,0 +1,3 @@
+<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 16 16">
+  <path fill="context-fill" d="M8 0a8 8 0 1 0 8 8 8.009 8.009 0 0 0-8-8zm0 14a6 6 0 1 1 6-6 6.007 6.007 0 0 1-6 6zm3.5-6H8V4.5a.5.5 0 0 0-1 0v4a.5.5 0 0 0 .5.5h4a.5.5 0 0 0 0-1z"/>
+</svg>
diff --git a/browser/themes/shared/sidebar/sync-16.svg b/browser/themes/shared/sidebar/sync-16.svg
new file mode 100644
--- /dev/null
+++ b/browser/themes/shared/sidebar/sync-16.svg
@@ -0,0 +1,3 @@
+<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 16 16">
+  <path fill="context-fill" d="M14 1a1 1 0 0 0-1 1v1.146A6.948 6.948 0 0 0 1.227 6.307a1 1 0 1 0 1.94.484A4.983 4.983 0 0 1 8 3a4.919 4.919 0 0 1 3.967 2H10a1 1 0 0 0 0 2h4a1 1 0 0 0 1-1V2a1 1 0 0 0-1-1zm.046 7.481a1 1 0 0 0-1.213.728A4.983 4.983 0 0 1 8 13a4.919 4.919 0 0 1-3.967-2H6a1 1 0 0 0 0-2H2a1 1 0 0 0-1 1v4a1 1 0 0 0 2 0v-1.146a6.948 6.948 0 0 0 11.773-3.161 1 1 0 0 0-.727-1.212z"/>
+</svg>
diff --git a/browser/themes/windows/browser-aero.css b/browser/themes/windows/browser-aero.css
--- a/browser/themes/windows/browser-aero.css
+++ b/browser/themes/windows/browser-aero.css
@@ -14,54 +14,22 @@
 @media (-moz-windows-default-theme) {
   .sidebar-header,
   #sidebar-header {
     -moz-appearance: none;
     border-bottom: none;
     text-shadow: none;
   }
 
-  .sidebar-title,
-  #sidebar-title {
-    font-weight: bold;
-  }
-
-  .sidebar-splitter {
-    border: 0;
-    border-inline-end: 1px solid ThreeDLightShadow;
-    min-width: 0;
-    width: 3px;
-    background-color: transparent;
-    margin-inline-start: -3px;
-    position: relative;
-  }
-
-  #appcontent ~ .sidebar-splitter {
-    border-inline-start: 1px solid ThreeDLightShadow;
-    border-inline-end: none;
-    margin-inline-start: 0;
-    margin-inline-end: -3px;
-  }
-
   .menu-accel,
   .menu-iconic-accel {
     color: graytext;
   }
 
   @media (-moz-os-version: windows-win7) {
-    .sidebar-header:not(:-moz-lwtheme),
-    #sidebar-header:not(:-moz-lwtheme) {
-      background-color: #EEF3FA;
-    }
-
-    .sidebar-splitter,
-    #appcontent ~ .sidebar-splitter {
-      border-color: #A9B7C9;
-    }
-
     #navigator-toolbox > toolbar:not(#toolbar-menubar):not(#TabsToolbar):not(:-moz-lwtheme),
     #browser-bottombox:not(:-moz-lwtheme),
     .browserContainer > findbar {
       background-color: @customToolbarColor@;
     }
 
     .tab-background-middle[selected=true]:not(:-moz-lwtheme) {
       background-color: @customToolbarColor@;
diff --git a/browser/themes/windows/browser.css b/browser/themes/windows/browser.css
--- a/browser/themes/windows/browser.css
+++ b/browser/themes/windows/browser.css
@@ -1400,50 +1400,22 @@ html|span.ac-emphasize-text-url {
 
 /* Implements editBookmarkPanel resizing on folderTree un-collapse. */
 #editBMPanel_folderTree {
   min-width: 27em;
 }
 
 /* ::::: content area ::::: */
 
+%include ../shared/sidebar.inc.css
+
 #sidebar {
   background-color: Window;
 }
 
-#sidebar-title {
-  padding-inline-start: 0px;
-}
-
-#sidebar-header > .close-icon {
-  -moz-appearance: none;
-  padding: 2px;
-  margin: 0;
-  border: none;
-}
-
-@media not all and (min-resolution: 1.1dppx) {
-  #sidebar-header > .close-icon:-moz-lwtheme-brighttext {
-    list-style-image: url("chrome://global/skin/icons/close-inverted.png");
-  }
-}
-
-@media (min-resolution: 1.1dppx) {
-  #sidebar-header > .close-icon:-moz-lwtheme-brighttext {
-    list-style-image: url("chrome://global/skin/icons/close-inverted@2x.png");
-  }
-}
-
-@media (-moz-os-version: windows-win7) {
-  #sidebar-header > .close-icon {
-    padding-top: 4px;
-    padding-bottom: 4px;
-  }
-}
-
 .browserContainer > findbar {
   background-color: -moz-dialog;
   color: -moz-DialogText;
   text-shadow: none;
 }
 
 /* Tabstrip */
 
@@ -1626,28 +1598,16 @@ toolbarbutton.chevron > .toolbarbutton-t
 toolbarbutton.chevron > .toolbarbutton-menu-dropmarker {
   display: none;
 }
 
 toolbarbutton.chevron > .toolbarbutton-icon {
   margin: 0;
 }
 
-#sidebar-throbber[loading="true"] {
-  list-style-image: url("chrome://global/skin/icons/loading.png");
-  margin-inline-end: 4px;
-}
-
-@media (min-resolution: 1.1dppx) {
-  #sidebar-throbber[loading="true"] {
-    list-style-image: url("chrome://global/skin/icons/loading@2x.png");
-    width: 16px;
-  }
-}
-
 /* Bookmarks toolbar */
 #PlacesToolbarDropIndicator {
   list-style-image: url(chrome://browser/skin/places/toolbarDropMarker.png);
 }
 
 toolbarbutton.bookmark-item[dragover="true"][open="true"] {
   -moz-appearance: none;
   background: Highlight !important;
