# HG changeset patch
# User Brian Grinstead <bgrinstead@mozilla.com>
# Parent  745f2d85212d7c4bc82240c5a43730d9ecd32125
Bug 1355324 - Create sidebar header switcher

diff --git a/browser/base/content/browser-sidebar.js b/browser/base/content/browser-sidebar.js
--- a/browser/base/content/browser-sidebar.js
+++ b/browser/base/content/browser-sidebar.js
@@ -26,30 +26,95 @@ var SidebarUI = {
   _title: null,
   _splitter: null,
 
   init() {
     this._box = document.getElementById("sidebar-box");
     this.browser = document.getElementById("sidebar");
     this._title = document.getElementById("sidebar-title");
     this._splitter = document.getElementById("sidebar-splitter");
+    this._switcher = document.getElementById("sidebar-switcher");
+    this._switcherPanel = document.getElementById("sidebarMenu-popup");
+
+    if (gPhotonStructure) {
+      this._switcher.hidden = false;
+      document.getElementById("sidebar-close").hidden = true;
+
+      this._switcher.addEventListener("click", () => {
+        this.toggleSwitcherPanel();
+      });
+    }
   },
 
   uninit() {
     let enumerator = Services.wm.getEnumerator(null);
     enumerator.getNext();
     if (!enumerator.hasMoreElements()) {
       document.persist("sidebar-box", "sidebarcommand");
       document.persist("sidebar-box", "width");
       document.persist("sidebar-box", "src");
       document.persist("sidebar-title", "value");
     }
   },
 
   /**
+   * Opens the switcher panel if it's closed, or closes it if it's open.
+   */
+  toggleSwitcherPanel() {
+    if (this._switcherPanel.state == "open") {
+      return this._switcherPanel.hidePopup();
+    } else if (this._switcherPanel.state == "closed") {
+      return this.showSwitcherPanel();
+    }
+  },
+
+  hideSwitcherPanel() {
+    return new Promise(resolve => {
+      this._switcherPanel.addEventListener("popuphidden", () => {
+        resolve();
+      }, {once: true});
+      this._switcherPanel.hidePopup();
+    });
+  },
+
+  showSwitcherPanel() {
+    this._ensureShortcutsShown();
+    return new Promise(resolve => {
+      if (this._switcherPanel.state == "open") {
+        resolve();
+        return;
+      }
+      this._switcherPanel.addEventListener("popuphidden", () => {
+        this._switcherPanel.hidden = true;
+      }, {once: true});
+      this._switcherPanel.hidden = false;
+      this._switcherPanel.openPopup(this._switcher);
+      this._switcherPanel.addEventListener("popupshown", () => {
+        resolve();
+      }, {once: true});
+    });
+  },
+
+  _addedShortcuts: false,
+  _ensureShortcutsShown() {
+    if (this._addedShortcuts) {
+      return;
+    }
+    this._addedShortcuts = true;
+    for (let button of this._switcherPanel.querySelectorAll("toolbarbutton[key]")) {
+      let keyId = button.getAttribute("key");
+      let key = document.getElementById(keyId);
+      if (!key) {
+        continue;
+      }
+      button.setAttribute("shortcut", ShortcutUtils.prettifyShortcut(key));
+    }
+  },
+
+  /**
    * Try and adopt the status of the sidebar from another window.
    * @param {Window} sourceWindow - Window to use as a source for sidebar status.
    * @return true if we adopted the state, or false if the caller should
    * initialize the state itself.
    */
   adoptFromWindow(sourceWindow) {
     // If the opener had a sidebar, open the same sidebar in our window.
     // The opener can be the hidden window too, if we're coming from the state
@@ -271,16 +336,18 @@ var SidebarUI = {
   /**
    * Hide the sidebar.
    */
   hide() {
     if (!this.isOpen) {
       return;
     }
 
+    this.hideSwitcherPanel();
+
     let commandID = this._box.getAttribute("sidebarcommand");
     let sidebarBroadcaster = document.getElementById(commandID);
 
     if (sidebarBroadcaster.getAttribute("checked") != "true") {
       return;
     }
 
     // Replace the document currently displayed in the sidebar with about:blank
diff --git a/browser/base/content/browser.xul b/browser/base/content/browser.xul
--- a/browser/base/content/browser.xul
+++ b/browser/base/content/browser.xul
@@ -1071,17 +1071,63 @@
 
   <deck id="content-deck" flex="1">
     <hbox flex="1" id="browser">
       <vbox id="browser-border-start" hidden="true" layer="true"/>
       <vbox id="sidebar-box" hidden="true" class="chromeclass-extrachrome">
         <sidebarheader id="sidebar-header" align="center">
           <label id="sidebar-title" persist="value" flex="1" crop="end" control="sidebar"/>
           <image id="sidebar-throbber"/>
-          <toolbarbutton class="close-icon tabbable" tooltiptext="&sidebarCloseButton.tooltip;" oncommand="SidebarUI.hide();"/>
+          <toolbarbutton id="sidebar-close" class="close-icon tabbable" tooltiptext="&sidebarCloseButton.tooltip;" oncommand="SidebarUI.hide();"/>
+          <toolbarbutton id="sidebar-switcher"
+                         class="chevron"
+                         tooltiptext="TODO"
+                         hidden="true"
+                         crop="end" />
+          <panel id="sidebarMenu-popup"
+                 class="cui-widget-panel"
+                 role="group"
+                 type="arrow"
+                 hidden="true"
+                 flip="slide"
+                 position="bottomcenter topright"
+                 noautofocus="true">
+            <panelmultiview id="sidebarMenu-multiView" mainViewId="sidebarMenu-mainView">
+              <panelview id="sidebarMenu-mainView" class="cui-widget-panelview PanelUI-subView">
+                <vbox class="panel-subview-body">
+                    <toolbarbutton id="sidebar-switcher-bookmarks"
+                                   class="subviewbutton subviewbutton-iconic"
+                                   key="viewBookmarksSidebarKb"
+                                   observes="viewBookmarksSidebar"
+                                   oncommand="SidebarUI.show('viewBookmarksSidebar');">
+                       <observes element="viewBookmarksSidebar" attribute="checked"/>
+                     </toolbarbutton>
+                    <toolbarbutton id="sidebar-switcher-history"
+                                   label="&historyButton.label;"
+                                   class="subviewbutton subviewbutton-iconic"
+                                   key="key_gotoHistory"
+                                   observes="viewHistorySidebar"
+                                   oncommand="SidebarUI.show('viewHistorySidebar');">
+                       <observes element="viewHistorySidebar" attribute="checked"/>
+                     </toolbarbutton>
+                    <toolbarbutton id="sidebar-switcher-tabs"
+                                   label="&syncedTabs.sidebar.label;"
+                                   class="subviewbutton subviewbutton-iconic"
+                                   observes="viewTabsSidebar"
+                                   oncommand="SidebarUI.show('viewTabsSidebar');">
+                       <observes element="viewTabsSidebar" attribute="checked"/>
+                     </toolbarbutton>
+                    <toolbarseparator/>
+                    <toolbarbutton label="&sidebarCloseButton.tooltip;"
+                                   class="subviewbutton"
+                                   oncommand="SidebarUI.hide()"/>
+                </vbox>
+              </panelview>
+            </panelmultiview>
+          </panel>
         </sidebarheader>
         <browser id="sidebar" flex="1" autoscroll="false" disablehistory="true" disablefullscreen="true"
                   style="min-width: 14em; width: 18em; max-width: 36em;" tooltip="aHTMLTooltip"/>
       </vbox>
 
       <splitter id="sidebar-splitter" class="chromeclass-extrachrome sidebar-splitter" hidden="true"/>
       <vbox id="appcontent" flex="1">
         <notificationbox id="high-priority-global-notificationbox" notificationside="top"/>
diff --git a/browser/themes/osx/browser.css b/browser/themes/osx/browser.css
--- a/browser/themes/osx/browser.css
+++ b/browser/themes/osx/browser.css
@@ -2334,16 +2334,29 @@ sidebarheader {
 
   .sidebar-title,
   #sidebar-title {
     color: #636363;
     font-weight: 500;
   }
 }
 
+#sidebarMenu-popup .subviewbutton {
+  min-width: 190px;
+}
+#sidebar-switcher-bookmarks {
+  list-style-image: url(chrome://browser/skin/sidebar/bookmark-16-outline.svg);
+}
+#sidebar-switcher-history {
+  list-style-image: url(chrome://browser/skin/sidebar/history-16.svg);
+}
+#sidebar-switcher-tabs {
+  list-style-image: url(chrome://browser/skin/sidebar/sync-16.svg);
+}
+
 
 /* ----- CONTENT ----- */
 
 .browserContainer > findbar {
   background: @scopeBarBackground@;
   border-top: @scopeBarSeparatorBorder@;
   color: -moz-DialogText;
   text-shadow: none;
diff --git a/browser/themes/shared/jar.inc.mn b/browser/themes/shared/jar.inc.mn
--- a/browser/themes/shared/jar.inc.mn
+++ b/browser/themes/shared/jar.inc.mn
@@ -43,16 +43,20 @@
   skin/classic/browser/customizableui/menuPanel-customizeFinish.png  (../shared/customizableui/menuPanel-customizeFinish.png)
   skin/classic/browser/customizableui/menuPanel-customizeFinish@2x.png  (../shared/customizableui/menuPanel-customizeFinish@2x.png)
   skin/classic/browser/customizableui/panelarrow-customizeTip.png  (../shared/customizableui/panelarrow-customizeTip.png)
   skin/classic/browser/customizableui/panelarrow-customizeTip@2x.png  (../shared/customizableui/panelarrow-customizeTip@2x.png)
   skin/classic/browser/customizableui/subView-arrow-back-inverted.png  (../shared/customizableui/subView-arrow-back-inverted.png)
   skin/classic/browser/customizableui/subView-arrow-back-inverted@2x.png  (../shared/customizableui/subView-arrow-back-inverted@2x.png)
   skin/classic/browser/customizableui/subView-arrow-back-inverted-rtl.png  (../shared/customizableui/subView-arrow-back-inverted-rtl.png)
   skin/classic/browser/customizableui/subView-arrow-back-inverted-rtl@2x.png  (../shared/customizableui/subView-arrow-back-inverted-rtl@2x.png)
+  skin/classic/browser/sidebar/arrowhead-down-16.svg           (../shared/sidebar/arrowhead-down-16.svg)
+  skin/classic/browser/sidebar/bookmark-16-outline.svg         (../shared/sidebar/bookmark-16-outline.svg)
+  skin/classic/browser/sidebar/history-16.svg                  (../shared/sidebar/history-16.svg)
+  skin/classic/browser/sidebar/sync-16.svg                     (../shared/sidebar/sync-16.svg)
   skin/classic/browser/customizableui/whimsy.png               (../shared/customizableui/whimsy.png)
   skin/classic/browser/customizableui/whimsy@2x.png            (../shared/customizableui/whimsy@2x.png)
   skin/classic/browser/downloads/contentAreaDownloadsView.css  (../shared/downloads/contentAreaDownloadsView.css)
   skin/classic/browser/downloads/download-blocked.svg          (../shared/downloads/download-blocked.svg)
   skin/classic/browser/downloads/download-summary.svg          (../shared/downloads/download-summary.svg)
   skin/classic/browser/drm-icon.svg                            (../shared/drm-icon.svg)
   skin/classic/browser/fullscreen/insecure.svg                 (../shared/fullscreen/insecure.svg)
   skin/classic/browser/fullscreen/secure.svg                   (../shared/fullscreen/secure.svg)
diff --git a/browser/themes/shared/sidebar/arrowhead-down-16.svg b/browser/themes/shared/sidebar/arrowhead-down-16.svg
new file mode 100644
--- /dev/null
+++ b/browser/themes/shared/sidebar/arrowhead-down-16.svg
@@ -0,0 +1,3 @@
+<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 16 16">
+  <path fill="context-fill" d="M8 12a1 1 0 0 1-.707-.293l-5-5a1 1 0 0 1 1.414-1.414L8 9.586l4.293-4.293a1 1 0 0 1 1.414 1.414l-5 5A1 1 0 0 1 8 12z"/>
+</svg>
diff --git a/browser/themes/shared/sidebar/bookmark-16-outline.svg b/browser/themes/shared/sidebar/bookmark-16-outline.svg
new file mode 100644
--- /dev/null
+++ b/browser/themes/shared/sidebar/bookmark-16-outline.svg
@@ -0,0 +1,3 @@
+<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 16 16">
+  <path fill="context-fill" d="M3.8 15.922a1.1 1.1 0 0 1-1.09-1.253l.609-4.36L.393 7.163a1.1 1.1 0 0 1 .616-1.833l4.08-.73L7.016.734a1.1 1.1 0 0 1 1.969 0L10.911 4.6 15 5.331a1.1 1.1 0 0 1 .611 1.833L12.68 10.31l.609 4.359a1.1 1.1 0 0 1-1.6 1.127L8 13.873 4.308 15.8a1.093 1.093 0 0 1-.508.122zm-.415-1.9zm9.228 0zM2.981 7.01l2.451 2.635-.5 3.572L8 11.618l3.067 1.6-.5-3.572 2.452-2.636-3.45-.616L8 3.244l-1.569 3.15zm11.659.29zm-13.278 0zm12.78-1.5zm-12.286 0z"/>
+</svg>
diff --git a/browser/themes/shared/sidebar/history-16.svg b/browser/themes/shared/sidebar/history-16.svg
new file mode 100644
--- /dev/null
+++ b/browser/themes/shared/sidebar/history-16.svg
@@ -0,0 +1,3 @@
+<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 16 16">
+  <path fill="context-fill" d="M8 0a8 8 0 1 0 8 8 8.009 8.009 0 0 0-8-8zm0 14a6 6 0 1 1 6-6 6.007 6.007 0 0 1-6 6zm3.5-6H8V4.5a.5.5 0 0 0-1 0v4a.5.5 0 0 0 .5.5h4a.5.5 0 0 0 0-1z"/>
+</svg>
diff --git a/browser/themes/shared/sidebar/sync-16.svg b/browser/themes/shared/sidebar/sync-16.svg
new file mode 100644
--- /dev/null
+++ b/browser/themes/shared/sidebar/sync-16.svg
@@ -0,0 +1,3 @@
+<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 16 16">
+  <path fill="context-fill" d="M14 1a1 1 0 0 0-1 1v1.146A6.948 6.948 0 0 0 1.227 6.307a1 1 0 1 0 1.94.484A4.983 4.983 0 0 1 8 3a4.919 4.919 0 0 1 3.967 2H10a1 1 0 0 0 0 2h4a1 1 0 0 0 1-1V2a1 1 0 0 0-1-1zm.046 7.481a1 1 0 0 0-1.213.728A4.983 4.983 0 0 1 8 13a4.919 4.919 0 0 1-3.967-2H6a1 1 0 0 0 0-2H2a1 1 0 0 0-1 1v4a1 1 0 0 0 2 0v-1.146a6.948 6.948 0 0 0 11.773-3.161 1 1 0 0 0-.727-1.212z"/>
+</svg>
