# HG changeset patch
# User Brian Grinstead <bgrinstead@mozilla.com>
# Parent  a477e80f03b61be9961bc61770a2b55cce139b91
Bug 1355324 - Create sidebar header switcher

diff --git a/browser/base/content/browser-menubar.inc b/browser/base/content/browser-menubar.inc
--- a/browser/base/content/browser-menubar.inc
+++ b/browser/base/content/browser-menubar.inc
@@ -207,24 +207,27 @@
                   </menupopup>
                 </menu>
                 <menu id="viewSidebarMenuMenu"
                       label="&viewSidebarMenu.label;"
                       accesskey="&viewSidebarMenu.accesskey;">
                   <menupopup id="viewSidebarMenu">
                     <menuitem id="menu_bookmarksSidebar"
                               key="viewBookmarksSidebarKb"
-                              observes="viewBookmarksSidebar"/>
+                              observes="viewBookmarksSidebar"
+                              oncommand="SidebarUI.toggle('viewBookmarksSidebar');"/>
                     <menuitem id="menu_historySidebar"
                               key="key_gotoHistory"
                               observes="viewHistorySidebar"
-                              label="&historyButton.label;"/>
+                              label="&historyButton.label;"
+                              oncommand="SidebarUI.toggle('viewHistorySidebar');"/>
                     <menuitem id="menu_tabsSidebar"
                               observes="viewTabsSidebar"
-                              label="&syncedTabs.sidebar.label;"/>
+                              label="&syncedTabs.sidebar.label;"
+                              oncommand="SidebarUI.toggle('viewTabsSidebar');"/>
                   </menupopup>
                 </menu>
                 <menuseparator/>
                 <menu id="viewFullZoomMenu" label="&fullZoom.label;"
                       accesskey="&fullZoom.accesskey;"
                       onpopupshowing="FullZoom.updateMenu();">
                   <menupopup>
                     <menuitem id="menu_zoomEnlarge"
diff --git a/browser/base/content/browser-sets.inc b/browser/base/content/browser-sets.inc
--- a/browser/base/content/browser-sets.inc
+++ b/browser/base/content/browser-sets.inc
@@ -117,26 +117,24 @@
              oncommand="PlacesCommandHook.showPlacesOrganizer('UnfiledBookmarks');"/>
     <command id="Browser:ShowAllHistory"
              oncommand="PlacesCommandHook.showPlacesOrganizer('History');"/>
   </commandset>
 
   <broadcasterset id="mainBroadcasterSet">
     <broadcaster id="Social:PageShareable" disabled="true"/>
     <broadcaster id="viewBookmarksSidebar" autoCheck="false" label="&bookmarksButton.label;"
-                 type="checkbox" group="sidebar" sidebarurl="chrome://browser/content/bookmarks/bookmarksPanel.xul"
-                 oncommand="SidebarUI.toggle('viewBookmarksSidebar');"/>
+                 type="checkbox" group="sidebar" sidebarurl="chrome://browser/content/bookmarks/bookmarksPanel.xul"/>
 
     <!-- for both places and non-places, the sidebar lives at
          chrome://browser/content/history/history-panel.xul so there are no
          problems when switching between versions -->
     <broadcaster id="viewHistorySidebar" autoCheck="false" sidebartitle="&historyButton.label;"
                  type="checkbox" group="sidebar"
-                 sidebarurl="chrome://browser/content/history/history-panel.xul"
-                 oncommand="SidebarUI.toggle('viewHistorySidebar');"/>
+                 sidebarurl="chrome://browser/content/history/history-panel.xul"/>
 
     <broadcaster id="viewWebPanelsSidebar" autoCheck="false"
                  type="checkbox" group="sidebar" sidebarurl="chrome://browser/content/web-panels.xul"
                  oncommand="SidebarUI.toggle('viewWebPanelsSidebar');"/>
 
     <broadcaster id="bookmarkThisPageBroadcaster"
                  label="&bookmarkThisPageCmd.label;"
                  bookmarklabel="&bookmarkThisPageCmd.label;"
@@ -172,18 +170,17 @@
     <broadcaster id="sync-status"/>
     <!-- broadcasters of the "hidden" attribute to reflect setup state for
          menus -->
     <broadcaster id="sync-setup-state"/>
     <broadcaster id="sync-syncnow-state" hidden="true"/>
     <broadcaster id="sync-reauth-state" hidden="true"/>
     <broadcaster id="viewTabsSidebar" autoCheck="false" sidebartitle="&syncedTabs.sidebar.label;"
                  type="checkbox" group="sidebar"
-                 sidebarurl="chrome://browser/content/syncedtabs/sidebar.xhtml"
-                 oncommand="SidebarUI.toggle('viewTabsSidebar');"/>
+                 sidebarurl="chrome://browser/content/syncedtabs/sidebar.xhtml"/>
     <broadcaster id="workOfflineMenuitemState"/>
 
     <broadcaster id="devtoolsMenuBroadcaster_PageSource"
                  label="&pageSourceCmd.label;"
                  key="key_viewSource"
                  command="View:PageSource">
       <observes element="canViewSource" attribute="disabled"/>
     </broadcaster>
diff --git a/browser/base/content/browser-sidebar.js b/browser/base/content/browser-sidebar.js
--- a/browser/base/content/browser-sidebar.js
+++ b/browser/base/content/browser-sidebar.js
@@ -26,30 +26,73 @@ var SidebarUI = {
   _title: null,
   _splitter: null,
 
   init() {
     this._box = document.getElementById("sidebar-box");
     this.browser = document.getElementById("sidebar");
     this._title = document.getElementById("sidebar-title");
     this._splitter = document.getElementById("sidebar-splitter");
+    this._switcher = document.getElementById("sidebar-switcher");
+    this._panel = document.getElementById("sidebarMenu-popup");
+
+    if (gPhotonStructure) {
+      this._switcher.hidden = false;
+      document.getElementById("sidebar-close").hidden = true;
+
+      this._switcher.addEventListener("click", () => {
+        this.toggleSwitcherPanel();
+      });
+    }
   },
 
   uninit() {
     let enumerator = Services.wm.getEnumerator(null);
     enumerator.getNext();
     if (!enumerator.hasMoreElements()) {
       document.persist("sidebar-box", "sidebarcommand");
       document.persist("sidebar-box", "width");
       document.persist("sidebar-box", "src");
       document.persist("sidebar-title", "value");
     }
   },
 
   /**
+   * Opens the switcher panel if it's closed, or closes it if it's open.
+   */
+  toggleSwitcherPanel() {
+    if (this._panel.state == "open") {
+      this._panel.hidePopup();
+    } else if (this._panel.state == "closed") {
+      this.showSwitcherPanel();
+    }
+  },
+
+  hideSwitcherPanel() {
+      this._panel.hidePopup();
+  },
+
+  showSwitcherPanel() {
+    return new Promise(resolve => {
+      if (this._panel.state == "open") {
+        resolve();
+        return;
+      }
+      this._panel.addEventListener("popuphidden", () => {
+        this._panel.hidden = true;
+      }, {once: true});
+      this._panel.hidden = false;
+      this._panel.openPopup(this._switcher);
+      this._panel.addEventListener("popupshown", () => {
+        resolve();
+      }, {once: true});
+    });
+  },
+
+  /**
    * Try and adopt the status of the sidebar from another window.
    * @param {Window} sourceWindow - Window to use as a source for sidebar status.
    * @return true if we adopted the state, or false if the caller should
    * initialize the state itself.
    */
   adoptFromWindow(sourceWindow) {
     // If the opener had a sidebar, open the same sidebar in our window.
     // The opener can be the hidden window too, if we're coming from the state
diff --git a/browser/base/content/browser.xul b/browser/base/content/browser.xul
--- a/browser/base/content/browser.xul
+++ b/browser/base/content/browser.xul
@@ -1071,17 +1071,56 @@
 
   <deck id="content-deck" flex="1">
     <hbox flex="1" id="browser">
       <vbox id="browser-border-start" hidden="true" layer="true"/>
       <vbox id="sidebar-box" hidden="true" class="chromeclass-extrachrome">
         <sidebarheader id="sidebar-header" align="center">
           <label id="sidebar-title" persist="value" flex="1" crop="end" control="sidebar"/>
           <image id="sidebar-throbber"/>
-          <toolbarbutton class="close-icon tabbable" tooltiptext="&sidebarCloseButton.tooltip;" oncommand="SidebarUI.hide();"/>
+          <toolbarbutton id="sidebar-switcher"
+                         class="chevron"
+                         tooltiptext="TODO"
+                         hidden="true"
+                         crop="end" />
+          <panel id="sidebarMenu-popup"
+                 class="cui-widget-panel"
+                 role="group"
+                 type="arrow"
+                 hidden="true"
+                 flip="slide"
+                 position="bottomcenter topright"
+                 noautofocus="true">
+            <panelmultiview id="sidebarMenu-multiView" mainViewId="sidebarMenu-mainView">
+              <panelview id="sidebarMenu-mainView" class="cui-widget-panelview PanelUI-subView">
+                <vbox class="panel-subview-body">
+                    <toolbarbutton id="sidebar-switcher-bookmarks"
+                                   checked="true"
+                                   class="subviewbutton"
+                                   observes="viewBookmarksSidebar"
+                                   oncommand="SidebarUI.show('viewBookmarksSidebar');"/>
+                    <toolbarbutton id="sidebar-switcher-history"
+                                   label="&historyButton.label;"
+                                   class="subviewbutton"
+                                   observes="viewHistorySidebar"
+                                   oncommand="SidebarUI.show('viewHistorySidebar');"/>
+                    <toolbarbutton id="sidebar-switcher-tabs"
+                                   label="&syncedTabs.sidebar.label;"
+                                   class="subviewbutton"
+                                   observes="viewTabsSidebar"
+                                   oncommand="SidebarUI.show('viewTabsSidebar');"/>
+                    <separator/>
+                    <toolbarbutton label="&sidebarCloseButton.tooltip;"
+                                   class="subviewbutton"
+                                   oncommand="SidebarUI.hide()"/>
+                </vbox>
+              </panelview>
+            </panelmultiview>
+          </panel>
+          <toolbarbutton id="sidebar-close" class="close-icon tabbable" tooltiptext="&sidebarCloseButton.tooltip;" oncommand="SidebarUI.hide();"/>
         </sidebarheader>
         <browser id="sidebar" flex="1" autoscroll="false" disablehistory="true" disablefullscreen="true"
                   style="min-width: 14em; width: 18em; max-width: 36em;" tooltip="aHTMLTooltip"/>
       </vbox>
 
       <splitter id="sidebar-splitter" class="chromeclass-extrachrome sidebar-splitter" hidden="true"/>
       <vbox id="appcontent" flex="1">
         <notificationbox id="high-priority-global-notificationbox" notificationside="top"/>
diff --git a/browser/components/customizableui/content/panelUI.inc.xul b/browser/components/customizableui/content/panelUI.inc.xul
--- a/browser/components/customizableui/content/panelUI.inc.xul
+++ b/browser/components/customizableui/content/panelUI.inc.xul
@@ -116,17 +116,18 @@
       <vbox class="panel-subview-body">
         <!-- this widget has 3 boxes in the body, but only 1 is ever visible -->
         <!-- When Sync is ready to sync -->
         <vbox id="PanelUI-remotetabs-main" observes="sync-syncnow-state">
           <vbox id="PanelUI-remotetabs-buttons">
             <toolbarbutton id="PanelUI-remotetabs-view-sidebar"
                            class="subviewbutton"
                            observes="viewTabsSidebar"
-                           label="&appMenuRemoteTabs.sidebar.label;"/>
+                           label="&appMenuRemoteTabs.sidebar.label;"
+                           oncommand="SidebarUI.toggle('viewTabsSidebar');"/>
             <toolbarbutton id="PanelUI-remotetabs-view-managedevices"
                            class="subviewbutton"
                            label="&appMenuRemoteTabs.managedevices.label;"
                            oncommand="gFxAccounts.openDevicesManagementPage('syncedtabs-menupanel');"/>
             <toolbarbutton id="PanelUI-remotetabs-syncnow"
                            observes="sync-status"
                            class="subviewbutton"
                            oncommand="gSyncUI.doSync();"
