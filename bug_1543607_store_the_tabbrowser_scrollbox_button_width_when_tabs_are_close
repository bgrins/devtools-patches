# HG changeset patch
# User Brian Grinstead <bgrinstead@mozilla.com>
# Date 1556555187 25200
#      Mon Apr 29 09:26:27 2019 -0700
# Node ID 824e60b396c63a23128d9eac4fa9c4e228cdef92
# Parent  420e18a75314b8123b515d8a93cbacd145ecb03c
Bug 1543607 - Store the tabbrowser scrollbox button width when tabs are closed with the mouse so it can be used on underflow to keep the close button under the mouse

The button is already hidden when underflow fires, so the clientWidth is 0. Instead,
store it during _lockTabSizing so we know how much space to fill when tabs are being closed
by the mouse, to allow the close button to remain underneath the mouse cursor.

Differential Revision: https://phabricator.services.mozilla.com/D29227

diff --git a/browser/base/content/tabbrowser.xml b/browser/base/content/tabbrowser.xml
--- a/browser/base/content/tabbrowser.xml
+++ b/browser/base/content/tabbrowser.xml
@@ -148,17 +148,17 @@
                 event.detail == 0 ||
                 !this.hasAttribute("overflow")) {
               return;
             }
 
             this.removeAttribute("overflow");
 
             if (this._lastTabClosedByMouse) {
-              this._expandSpacerBy(this.arrowScrollbox._scrollButtonDown.clientWidth);
+              this._expandSpacerBy(this._scrollButtonWidth);
             }
 
             for (let tab of Array.from(gBrowser._removingTabs)) {
               gBrowser.removeTab(tab);
             }
 
             this._positionPinnedTabs();
           }, true);
@@ -424,16 +424,17 @@
 
           var isEndTab = (aTab._tPos > tabs[tabs.length - 1]._tPos);
 
           if (!this._tabDefaultMaxWidth) {
             this._tabDefaultMaxWidth =
               parseFloat(window.getComputedStyle(aTab).maxWidth);
           }
           this._lastTabClosedByMouse = true;
+          this._scrollButtonWidth = this.arrowScrollbox._scrollButtonDown.clientWidth;
 
           if (this.getAttribute("overflow") == "true") {
             // Don't need to do anything if we're in overflow mode and aren't scrolled
             // all the way to the right, or if we're closing the last tab.
             if (isEndTab || !this.arrowScrollbox._scrollButtonDown.disabled) {
               return;
             }
             // If the tab has an owner that will become the active tab, the owner will
@@ -522,16 +523,17 @@
         <body><![CDATA[
           this._positionPinnedTabs();
           this._updateCloseButtons();
           this._handleTabSelect(true);
         ]]></body>
       </method>
 
       <field name="_lastNumPinned">0</field>
+      <field name="_scrollButtonWidth">0</field>
       <field name="_pinnedTabsLayoutCache">null</field>
       <method name="_positionPinnedTabs">
         <body><![CDATA[
           let numPinned = gBrowser._numPinnedTabs;
           let doPosition = this.getAttribute("overflow") == "true" &&
                            this._getVisibleTabs().length > numPinned &&
                            numPinned > 0;
 
