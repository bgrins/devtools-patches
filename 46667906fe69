
# HG changeset patch
# User Yura Zenevich <yzenevich@mozilla.com>
# Date 1467213496 14400
# Node ID 46667906fe695abe18054ad10a03a483b980a0dc
# Parent  b69a5bbb5e40bd426e35222baa600b481e50d265
Bug 1226877 - fixing keyboard navigation around hidden devtools panels/controls. r=bgrins

MozReview-Commit-ID: KJoE2R5fcWG

diff --git a/devtools/client/framework/sidebar.js b/devtools/client/framework/sidebar.js
--- a/devtools/client/framework/sidebar.js
+++ b/devtools/client/framework/sidebar.js
@@ -355,6 +355,7 @@
     let tab = this.getTab(id);
     if (tab) {
       this._tabbox.selectedTab = tab;
+      this.setVisibility();
     }
   },
 
@@ -419,6 +420,9 @@
 
     let previousTool = this._currentTool;
     this._currentTool = this.getCurrentTabID();
+
+    this.setVisibility();
+
     if (previousTool) {
       if (this._telemetry) {
         this._telemetry.toolClosed(previousTool);
@@ -451,6 +455,16 @@
   },
 
   /**
+   * Set visibility for sidebar panels.
+   */
+  setVisibility: function () {
+    let tabpanels = this._tabbox.tabpanels;
+    for (let panel of tabpanels.querySelectorAll("tabpanel")) {
+      panel.classList.toggle("selected", panel == tabpanels._selectedPanel);
+    }
+  },
+
+  /**
    * Toggle sidebar's visibility state.
    */
   toggle: function () {
diff --git a/devtools/client/framework/test/browser_new_activation_workflow.js b/devtools/client/framework/test/browser_new_activation_workflow.js
--- a/devtools/client/framework/test/browser_new_activation_workflow.js
+++ b/devtools/client/framework/test/browser_new_activation_workflow.js
@@ -31,8 +31,12 @@
   is(toolbox.currentToolId, "webconsole", "The web console is selected");
   ok(toolbox.isReady, "toolbox is ready");
 
+  testVisibility(true);
+
   selectAndCheckById("jsdebugger").then(function () {
+    testVisibility(false);
     selectAndCheckById("styleeditor").then(function () {
+      testVisibility(false);
       testToggle();
     });
   });
@@ -47,6 +51,13 @@
   });
 }
 
+function testVisibility(webconsoleVisible) {
+  ok(toolbox.webconsolePanel.hasAttribute("hidden") !== webconsoleVisible,
+    "Web console has correct visibility");
+  ok(toolbox.doc.getElementById("toolbox-deck").hasAttribute(
+    "hidden") === webconsoleVisible, "Web console has correct visibility");
+}
+
 function testToggle() {
   toolbox.once("destroyed", () => {
     // Cannot reuse a target after it's destroyed.
diff --git a/devtools/client/framework/test/browser_toolbox_sidebar.js b/devtools/client/framework/test/browser_toolbox_sidebar.js
--- a/devtools/client/framework/test/browser_toolbox_sidebar.js
+++ b/devtools/client/framework/test/browser_toolbox_sidebar.js
@@ -110,6 +110,8 @@
       is(tab.getAttribute("label"), label++, "Tab has the right title");
     }
 
+    testVisibility(panel, 0);
+
     is(label, 4, "Found the right amount of tabs.");
     is(panel.sidebar._tabbox.selectedPanel, panels[0], "First tab is selected");
     is(panel.sidebar.getCurrentTabID(), "tab1", "getCurrentTabID() is correct");
@@ -118,6 +120,7 @@
       ok(true, "received 'unselected' event");
       panel.sidebar.once("tab2-selected", function () {
         ok(true, "received 'selected' event");
+        testVisibility(panel, 1);
         tabs[1].focus();
         is(panel.sidebar._panelDoc.activeElement, tabs[1],
           "Focus is set to second tab");
@@ -133,6 +136,12 @@
     panel.sidebar.select("tab2");
   }
 
+  function testVisibility(panel, selected) {
+    [...panel.sidebar._tabbox.tabpanels.children].forEach((tabpanel, index) =>
+      is(tabpanel.classList.contains("selected"), selected === index,
+        `panel ${index} has correct visibility`));
+  }
+
   function testRemoval(panel) {
     panel.sidebar.once("tab-unregistered", function (event, id) {
       info(event);
diff --git a/devtools/client/framework/toolbox.js b/devtools/client/framework/toolbox.js
--- a/devtools/client/framework/toolbox.js
+++ b/devtools/client/framework/toolbox.js
@@ -632,16 +632,16 @@
     let openedConsolePanel = this.currentToolId === "webconsole";
 
     if (openedConsolePanel) {
-      deck.setAttribute("collapsed", "true");
+      deck.setAttribute("hidden", "true");
       splitter.setAttribute("hidden", "true");
-      webconsolePanel.removeAttribute("collapsed");
+      webconsolePanel.removeAttribute("hidden");
     } else {
-      deck.removeAttribute("collapsed");
+      deck.removeAttribute("hidden");
       if (this.splitConsole) {
-        webconsolePanel.removeAttribute("collapsed");
+        webconsolePanel.removeAttribute("hidden");
         splitter.removeAttribute("hidden");
       } else {
-        webconsolePanel.setAttribute("collapsed", "true");
+        webconsolePanel.setAttribute("hidden", "true");
         splitter.setAttribute("hidden", "true");
       }
     }
diff --git a/devtools/client/framework/toolbox.xul b/devtools/client/framework/toolbox.xul
--- a/devtools/client/framework/toolbox.xul
+++ b/devtools/client/framework/toolbox.xul
@@ -76,7 +76,7 @@
            panel itself is sized properly -->
       <box id="toolbox-deck" flex="1000" minheight="75" />
       <splitter id="toolbox-console-splitter" class="devtools-horizontal-splitter" hidden="true" />
-      <box minheight="75" flex="1" id="toolbox-panel-webconsole" collapsed="true" />
+      <box minheight="75" flex="1" id="toolbox-panel-webconsole" hidden="true" />
     </vbox>
     <tooltip id="aHTMLTooltip" page="true" />
   </vbox>
diff --git a/devtools/client/inspector/inspector.css b/devtools/client/inspector/inspector.css
--- a/devtools/client/inspector/inspector.css
+++ b/devtools/client/inspector/inspector.css
@@ -32,4 +32,12 @@
    * Override `-moz-user-focus:ignore;` from toolkit/content/minimal-xul.css
    */
   -moz-user-focus: normal;
-}
\ No newline at end of file
+}
+
+/**
+ * Controls that belong to tabpanels that are not selected are still keyboard
+ * accessible. Ensuring these tabpanels are not visible and thus non-reachable.
+ */
+tabpanel:not(.selected) {
+  visibility: hidden;
+}
diff --git a/devtools/client/netmonitor/netmonitor.css b/devtools/client/netmonitor/netmonitor.css
--- a/devtools/client/netmonitor/netmonitor.css
+++ b/devtools/client/netmonitor/netmonitor.css
@@ -7,6 +7,7 @@
   overflow: hidden;
 }
 
+#details-pane[pane-collapsed],
 #details-pane-toggle[disabled] {
   display: none;
 }
@@ -36,7 +37,6 @@
 @media (max-width: 700px) {
   #toolbar-spacer,
   #details-pane-toggle,
-  #details-pane[pane-collapsed],
   .requests-menu-waterfall,
   #requests-menu-network-summary-button > .toolbarbutton-text {
     display: none;
diff --git a/devtools/client/themes/toolbars.css b/devtools/client/themes/toolbars.css
--- a/devtools/client/themes/toolbars.css
+++ b/devtools/client/themes/toolbars.css
@@ -812,13 +812,12 @@
 }
 
 .toolbox-panel {
-  display: -moz-box;
-  -moz-box-flex: 1;
-  visibility: collapse;
+  display: none;
 }
 
 .toolbox-panel[selected] {
-  visibility: visible;
+  display: -moz-box;
+  -moz-box-flex: 1;
 }
 
 .devtools-tab {

