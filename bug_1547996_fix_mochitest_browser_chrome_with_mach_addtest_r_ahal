# HG changeset patch
# User Brian Grinstead <bgrinstead@mozilla.com>
# Date 1556636585 25200
#      Tue Apr 30 08:03:05 2019 -0700
# Node ID cbdacc1da916e0852717e514584046506c24de09
# Parent  90234f4c094dcc794df28fdd464793dfe065f943
Bug 1547996 - Fix mochitest-browser-chrome with mach addtest;r=ahal

Differential Revision: https://phabricator.services.mozilla.com/D29364

diff --git a/testing/addtest.py b/testing/addtest.py
--- a/testing/addtest.py
+++ b/testing/addtest.py
@@ -51,17 +51,17 @@ add_task(async function test_TODO() {
         if not os.path.isfile(manifest_file):
             print('Could not open manifest file {}'.format(manifest_file))
             return
         write_to_ini_file(manifest_file, filename)
 
 
 class MochitestCreator(Creator):
     templates = {
-        "mochitest-browser": "browser.template.txt",
+        "mochitest-browser-chrome": "browser.template.txt",
         "mochitest-plain": "plain%(doc)s.template.txt",
         "mochitest-chrome": "chrome%(doc)s.template.txt",
     }
 
     def _get_template_contents(self):
         mochitest_templates = os.path.abspath(
             os.path.join(os.path.dirname(__file__), 'mochitest', 'static')
         )
@@ -81,17 +81,17 @@ class MochitestCreator(Creator):
         with open(template_file) as f:
             return f.read()
 
     def update_manifest(self):
         # attempt to insert into the appropriate manifest
         guessed_ini = {
             "mochitest-plain": "mochitest.ini",
             "mochitest-chrome": "chrome.ini",
-            "mochitest-browser": "browser.ini"
+            "mochitest-browser-chrome": "browser.ini"
         }[self.suite]
         manifest_file = os.path.join(os.path.dirname(self.test), guessed_ini)
         filename = os.path.basename(self.test)
 
         if not os.path.isfile(manifest_file):
             print('Could not open manifest file {}'.format(manifest_file))
             return
 
@@ -303,10 +303,13 @@ def write_to_ini_file(manifest_file, fil
 
 
 TEST_CREATORS = {"mochitest": MochitestCreator,
                  "web-platform-tests": WebPlatformTestsCreator,
                  "xpcshell": XpcshellCreator}
 
 
 def creator_for_suite(suite):
-    base_suite = suite.rsplit("-", 1)[0]
+    if suite.split("-")[0] == "mochitest":
+        base_suite = "mochitest"
+    else:
+        base_suite = suite.rsplit("-", 1)[0]
     return TEST_CREATORS.get(base_suite)
diff --git a/testing/mach_commands.py b/testing/mach_commands.py
--- a/testing/mach_commands.py
+++ b/testing/mach_commands.py
@@ -78,17 +78,17 @@ def get_test_parser():
     parser.add_argument('extra_args', default=None, nargs=argparse.REMAINDER,
                         help="Extra arguments to pass to the underlying test command(s). "
                              "If an underlying command doesn't recognize the argument, it "
                              "will fail.")
     add_logging_group(parser)
     return parser
 
 
-ADD_TEST_SUPPORTED_SUITES = ['mochitest-chrome', 'mochitest-plain', 'mochitest-browser',
+ADD_TEST_SUPPORTED_SUITES = ['mochitest-chrome', 'mochitest-plain', 'mochitest-browser-chrome',
                              'web-platform-tests-testharness', 'web-platform-tests-reftest',
                              'xpcshell']
 ADD_TEST_SUPPORTED_DOCS = ['js', 'html', 'xhtml', 'xul']
 
 SUITE_SYNONYMS = {
     "wpt": "web-platform-tests-testharness",
     "wpt-testharness": "web-platform-tests-testharness",
     "wpt-reftest": "web-platform-tests-reftest"
@@ -262,17 +262,17 @@ class AddTest(MachCommandBase):
             if "/css/" in abs_test:
                 guessed_suite = "web-platform-tests-reftest"
         elif (filename.startswith("test_") and
               has_xpcshell_ini and
               self.guess_doc(abs_test) == "js"):
             guessed_suite = "xpcshell"
         else:
             if filename.startswith("browser_") and has_browser_ini:
-                guessed_suite = "mochitest-browser"
+                guessed_suite = "mochitest-browser-chrome"
             elif filename.startswith("test_"):
                 if has_chrome_ini and has_plain_ini:
                     err = ("Error: directory contains both a chrome.ini and mochitest.ini. "
                            "Please set --suite=mochitest-chrome or --suite=mochitest-plain.")
                 elif has_chrome_ini:
                     guessed_suite = "mochitest-chrome"
                 elif has_plain_ini:
                     guessed_suite = "mochitest-plain"
