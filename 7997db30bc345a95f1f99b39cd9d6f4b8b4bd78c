
# HG changeset patch
# User Brendan Dahl <bdahl@mozilla.com>
# Date 1540506328 25200
# Node ID 7997db30bc345a95f1f99b39cd9d6f4b8b4bd78c
# Parent  37d240a1d498bd1662e0f9d6053ee75ccdb90786
Bug XXX - Handle different event order when waiting for window to open. r=?

In browser.xhtml the focus and activate events can fire before the
DOMContentLoaded event.


diff --git a/testing/mochitest/BrowserTestUtils/BrowserTestUtils.jsm b/testing/mochitest/BrowserTestUtils/BrowserTestUtils.jsm
--- a/testing/mochitest/BrowserTestUtils/BrowserTestUtils.jsm
+++ b/testing/mochitest/BrowserTestUtils/BrowserTestUtils.jsm
@@ -573,31 +573,33 @@ var BrowserTestUtils = {
         if (topic != "domwindowopened") {
           return;
         }
 
         if (!anyWindow) {
           Services.ww.unregisterNotification(observe);
         }
 
+        // Add these event listeners now since they may fire before the
+        // DOMContentLoaded event down below.
+        let promises = [
+          TestUtils.topicObserved("browser-delayed-startup-finished",
+                                  subject => subject == win),
+          this.waitForEvent(win, "focus"),
+          this.waitForEvent(win, "activate"),
+        ];
+
         if (url) {
           await this.waitForEvent(win, "DOMContentLoaded");
 
           if (win.document.documentURI != AppConstants.BROWSER_CHROME_URL) {
             return;
           }
         }
 
-        let promises = [
-          TestUtils.topicObserved("browser-delayed-startup-finished",
-                                  subject => subject == win),
-          this.waitForEvent(win, "focus"),
-          this.waitForEvent(win, "activate"),
-        ];
-
         if (url) {
           let browser = win.gBrowser.selectedBrowser;
 
           // Retrieve the given browser's current process type.
           let process =
               browser.isRemoteBrowser ? Ci.nsIXULRuntime.PROCESS_TYPE_CONTENT
               : Ci.nsIXULRuntime.PROCESS_TYPE_DEFAULT;
           if (win.gMultiProcessBrowser &&

