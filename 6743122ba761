
# HG changeset patch
# User Yura Zenevich <yzenevich@mozilla.com>
# Date 1468256896 14400
# Node ID 6743122ba7614273d724c74f99695fe247f308fa
# Parent  214884d507ee369c1cf14edb26527c4f9a97bf48
Bug 1226877 - fixing keyboard navigation around hidden devtools panels/controls. r=bgrins

MozReview-Commit-ID: KJoE2R5fcWG

diff --git a/devtools/client/framework/test/browser_new_activation_workflow.js b/devtools/client/framework/test/browser_new_activation_workflow.js
--- a/devtools/client/framework/test/browser_new_activation_workflow.js
+++ b/devtools/client/framework/test/browser_new_activation_workflow.js
@@ -31,8 +31,12 @@
   is(toolbox.currentToolId, "webconsole", "The web console is selected");
   ok(toolbox.isReady, "toolbox is ready");
 
+  testVisibility(true);
+
   selectAndCheckById("jsdebugger").then(function () {
+    testVisibility(false);
     selectAndCheckById("styleeditor").then(function () {
+      testVisibility(false);
       testToggle();
     });
   });
@@ -47,6 +51,15 @@
   });
 }
 
+function testVisibility(webconsoleVisible) {
+  ok(toolbox.webconsolePanel.hasAttribute("hidden") !== webconsoleVisible,
+    "Web console has correct visibility");
+  ok(toolbox.doc.getElementById("toolbox-deck").hasAttribute(
+    "hidden") === webconsoleVisible, "Web console has correct visibility");
+  (webconsoleVisible ? is : isnot)(toolbox.doc.activeElement.id,
+    "toolbox-panel-iframe-webconsole", "Web console has correct focus state");
+}
+
 function testToggle() {
   toolbox.once("destroyed", () => {
     // Cannot reuse a target after it's destroyed.
diff --git a/devtools/client/framework/toolbox.js b/devtools/client/framework/toolbox.js
--- a/devtools/client/framework/toolbox.js
+++ b/devtools/client/framework/toolbox.js
@@ -632,16 +632,16 @@
     let openedConsolePanel = this.currentToolId === "webconsole";
 
     if (openedConsolePanel) {
-      deck.setAttribute("collapsed", "true");
+      deck.setAttribute("hidden", "true");
       splitter.setAttribute("hidden", "true");
-      webconsolePanel.removeAttribute("collapsed");
+      webconsolePanel.removeAttribute("hidden");
     } else {
-      deck.removeAttribute("collapsed");
+      deck.removeAttribute("hidden");
       if (this.splitConsole) {
-        webconsolePanel.removeAttribute("collapsed");
+        webconsolePanel.removeAttribute("hidden");
         splitter.removeAttribute("hidden");
       } else {
-        webconsolePanel.setAttribute("collapsed", "true");
+        webconsolePanel.setAttribute("hidden", "true");
         splitter.setAttribute("hidden", "true");
       }
     }
@@ -1415,6 +1415,9 @@
   focusConsoleInput: function () {
     let consolePanel = this.getPanel("webconsole");
     if (consolePanel) {
+      if (!this.isSplitConsoleFocused()) {
+        this.focusTool("webconsole");
+      }
       consolePanel.focusInput();
     }
   },
@@ -1467,6 +1470,11 @@
 
     if (this._lastFocusedElement) {
       this._lastFocusedElement.focus();
+    } else if (this.doc.activeElement) {
+      // Do not let the focus remain on a hidden frame, move it to the previous
+      // active frame in the deck.
+      Services.focus.moveFocus(this.win, this.doc.activeElement,
+        Services.focus.MOVEFOCUS_BACKWARD, 0);
     }
     return promise.resolve();
   },
diff --git a/devtools/client/framework/toolbox.xul b/devtools/client/framework/toolbox.xul
--- a/devtools/client/framework/toolbox.xul
+++ b/devtools/client/framework/toolbox.xul
@@ -76,7 +76,7 @@
            panel itself is sized properly -->
       <box id="toolbox-deck" flex="1000" minheight="75" />
       <splitter id="toolbox-console-splitter" class="devtools-horizontal-splitter" hidden="true" />
-      <box minheight="75" flex="1" id="toolbox-panel-webconsole" collapsed="true" />
+      <box minheight="75" flex="1" id="toolbox-panel-webconsole" hidden="true" />
     </vbox>
     <tooltip id="aHTMLTooltip" page="true" />
   </vbox>
diff --git a/devtools/client/netmonitor/netmonitor.css b/devtools/client/netmonitor/netmonitor.css
--- a/devtools/client/netmonitor/netmonitor.css
+++ b/devtools/client/netmonitor/netmonitor.css
@@ -7,6 +7,7 @@
   overflow: hidden;
 }
 
+#details-pane.pane-collapsed,
 #details-pane-toggle[disabled] {
   display: none;
 }
@@ -36,7 +37,6 @@
 @media (max-width: 700px) {
   #toolbar-spacer,
   #details-pane-toggle,
-  #details-pane.pane-collapsed,
   .requests-menu-waterfall,
   #requests-menu-network-summary-button > .toolbarbutton-text {
     display: none;
diff --git a/devtools/client/themes/toolbars.css b/devtools/client/themes/toolbars.css
--- a/devtools/client/themes/toolbars.css
+++ b/devtools/client/themes/toolbars.css
@@ -828,13 +828,12 @@
 }
 
 .toolbox-panel {
-  display: -moz-box;
-  -moz-box-flex: 1;
-  visibility: collapse;
+  display: none;
 }
 
 .toolbox-panel[selected] {
-  visibility: visible;
+  display: -moz-box;
+  -moz-box-flex: 1;
 }
 
 .devtools-tab {

