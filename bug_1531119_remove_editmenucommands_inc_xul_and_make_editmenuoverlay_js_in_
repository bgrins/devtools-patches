# HG changeset patch
# User Brian Grinstead <bgrinstead@mozilla.com>
# Date 1551305321 28800
#      Wed Feb 27 14:08:41 2019 -0800
# Node ID 1059ab44826d7bd3db731993abbd251e560f6ccd
# Parent  198cd4a81bf2afa7cc79360f90da7bc91218b76d
Bug 1531119 - Remove editMenuCommands.inc.xul and make editMenuOverlay.js in charge of constructing the relevant commandset DOM

This allows us to drop preprocessing and makes it simpler to add edit menu functionality to any type of document.

Differential Revision: https://phabricator.services.mozilla.com/D21446

diff --git a/browser/base/content/browser-sets.inc b/browser/base/content/browser-sets.inc
--- a/browser/base/content/browser-sets.inc
+++ b/browser/base/content/browser-sets.inc
@@ -34,18 +34,16 @@
     <command id="cmd_printPreview" oncommand="PrintUtils.printPreview(PrintPreviewListener);"/>
     <command id="cmd_close" oncommand="BrowserCloseTabOrWindow(event);"/>
     <command id="cmd_closeWindow" oncommand="BrowserTryToCloseWindow()"/>
     <command id="cmd_toggleMute" oncommand="gBrowser.toggleMuteAudioOnMultiSelectedTabs(gBrowser.selectedTab)"/>
     <command id="cmd_CustomizeToolbars" oncommand="gCustomizeMode.enter()"/>
     <command id="cmd_toggleOfflineStatus" oncommand="BrowserOffline.toggleOfflineStatus();"/>
     <command id="cmd_quitApplication" oncommand="goQuitApplication()"/>
 
-#include ../../../toolkit/content/editMenuCommands.inc.xul
-
     <command id="View:PageSource" oncommand="BrowserViewSource(window.gBrowser.selectedBrowser);"/>
     <command id="View:PageInfo" oncommand="BrowserPageInfo();"/>
     <command id="View:FullScreen" oncommand="BrowserFullScreen();"/>
     <command id="View:ReaderView" oncommand="ReaderParent.toggleReaderMode(event);"/>
     <command id="cmd_find" oncommand="gLazyFindCommand('onFindCommand')"/>
     <command id="cmd_findAgain" oncommand="gLazyFindCommand('onFindAgainCommand', false)"/>
     <command id="cmd_findPrevious" oncommand="gLazyFindCommand('onFindAgainCommand', true)"/>
 #ifdef XP_MACOSX
diff --git a/browser/base/content/global-scripts.inc b/browser/base/content/global-scripts.inc
--- a/browser/base/content/global-scripts.inc
+++ b/browser/base/content/global-scripts.inc
@@ -16,14 +16,15 @@
 xmlns="http://www.w3.org/1999/xhtml"
 #endif
 >
 var {Services} = ChromeUtils.import("resource://gre/modules/Services.jsm");
 
 Services.scriptloader.loadSubScript("chrome://browser/content/browser.js", this);
 Services.scriptloader.loadSubScript("chrome://browser/content/browser-places.js", this);
 Services.scriptloader.loadSubScript("chrome://global/content/globalOverlay.js", this);
+Services.scriptloader.loadSubScript("chrome://global/content/editMenuOverlay.js", this);
 Services.scriptloader.loadSubScript("chrome://browser/content/utilityOverlay.js", this);
 #ifdef XP_MACOSX
 Services.scriptloader.loadSubScript("chrome://global/content/macWindowMenu.js", this);
 #endif
 
 </script>
diff --git a/browser/base/content/webext-panels.xul b/browser/base/content/webext-panels.xul
--- a/browser/base/content/webext-panels.xul
+++ b/browser/base/content/webext-panels.xul
@@ -20,16 +20,17 @@
         xmlns:rdf="http://www.w3.org/1999/02/22-rdf-syntax-ns#"
         xmlns="http://www.mozilla.org/keymaster/gatekeeper/there.is.only.xul">
   <script type="application/javascript" src="chrome://global/content/contentAreaUtils.js"/>
   <script type="application/javascript" src="chrome://browser/content/browser.js"/>
   <script type="application/javascript" src="chrome://browser/content/browser-places.js"/>
   <script type="application/javascript" src="chrome://browser/content/webext-panels.js"/>
   <script type="application/javascript" src="chrome://global/content/globalOverlay.js"/>
   <script type="application/javascript" src="chrome://browser/content/utilityOverlay.js"/>
+  <script type="application/javascript" src="chrome://global/content/editMenuOverlay.js"/>
 
   <commandset id="mainCommandset">
     <command id="Browser:Back"
              oncommand="getPanelBrowser().webNavigation.goBack();"
              disabled="true"/>
     <command id="Browser:Forward"
              oncommand="getPanelBrowser().webNavigation.goForward();"
              disabled="true"/>
@@ -70,11 +71,9 @@
                  activateontab="true" position="after_start"
                  level="parent"
 #ifdef XP_WIN
                  consumeoutsideclicks="false" ignorekeys="shortcuts"
 #endif
         />
     </menulist>
   </popupset>
-
-#include ../../../toolkit/content/editMenuCommands.inc.xul
 </page>
diff --git a/browser/components/downloads/content/contentAreaDownloadsView.xul b/browser/components/downloads/content/contentAreaDownloadsView.xul
--- a/browser/components/downloads/content/contentAreaDownloadsView.xul
+++ b/browser/components/downloads/content/contentAreaDownloadsView.xul
@@ -25,18 +25,18 @@
   <script type="application/javascript"
           src="chrome://global/content/globalOverlay.js"/>
   <script type="application/javascript"
           src="chrome://browser/content/downloads/contentAreaDownloadsView.js"/>
   <script type="application/javascript"
           src="chrome://browser/content/downloads/allDownloadsView.js"/>
   <script type="application/javascript"
           src="chrome://global/content/contentAreaUtils.js"/>
-
-#include ../../../../toolkit/content/editMenuCommands.inc.xul
+  <script type="application/javascript"
+          src="chrome://global/content/editMenuOverlay.js"/>
 
 #include ../../../../toolkit/content/editMenuKeys.inc.xul
 #ifdef XP_MACOSX
   <keyset id="editMenuKeysExtra">
     <key id="key_delete2" keycode="VK_BACK" command="cmd_delete"/>
   </keyset>
 #endif
 
diff --git a/browser/components/places/content/bookmarksSidebar.xul b/browser/components/places/content/bookmarksSidebar.xul
--- a/browser/components/places/content/bookmarksSidebar.xul
+++ b/browser/components/places/content/bookmarksSidebar.xul
@@ -30,19 +30,20 @@
   <script type="application/javascript"
           src="chrome://global/content/globalOverlay.js"/>
   <script type="application/javascript"
           src="chrome://browser/content/utilityOverlay.js"/>
   <script type="application/javascript"
           src="chrome://browser/content/contentTheme.js"/>
   <script type="application/javascript"
           src="chrome://browser/content/places/places-tree.js"/>
+  <script type="application/javascript"
+          src="chrome://global/content/editMenuOverlay.js"/>
 
 #include placesCommands.inc.xul
-#include ../../../../toolkit/content/editMenuCommands.inc.xul
 #include placesContextMenu.inc.xul
 #include bookmarksHistoryTooltip.inc.xul
 
   <hbox id="sidebar-search-container" align="center">
     <textbox id="search-box" flex="1" type="search"
              placeholder="&bookmarksSearch.placeholder;"
              aria-controls="bookmarks-view"
              oncommand="searchBookmarks(this.value);"/>
diff --git a/browser/components/places/content/historySidebar.xul b/browser/components/places/content/historySidebar.xul
--- a/browser/components/places/content/historySidebar.xul
+++ b/browser/components/places/content/historySidebar.xul
@@ -30,18 +30,18 @@
   <script type="application/javascript"
           src="chrome://global/content/globalOverlay.js"/>
   <script type="application/javascript"
           src="chrome://browser/content/utilityOverlay.js"/>
   <script type="application/javascript"
           src="chrome://browser/content/contentTheme.js"/>
   <script type="application/javascript"
           src="chrome://browser/content/places/places-tree.js"/>
-
-#include ../../../../toolkit/content/editMenuCommands.inc.xul
+  <script type="application/javascript"
+          src="chrome://global/content/editMenuOverlay.js"/>
 
 #include placesCommands.inc.xul
 
 #include ../../../../toolkit/content/editMenuKeys.inc.xul
 #ifdef XP_MACOSX
   <keyset id="editMenuKeysExtra">
     <key id="key_delete2" keycode="VK_BACK" command="cmd_delete"/>
   </keyset>
diff --git a/browser/components/places/content/places.xul b/browser/components/places/content/places.xul
--- a/browser/components/places/content/places.xul
+++ b/browser/components/places/content/places.xul
@@ -39,16 +39,18 @@
         onunload="PlacesOrganizer.destroy();"
         width="&places.library.width;" height="&places.library.height;"
         screenX="10" screenY="10"
         toggletoolbar="true"
         persist="width height screenX screenY sizemode">
 
   <script type="application/javascript"
           src="chrome://browser/content/places/places.js"/>
+  <script type="application/javascript"
+          src="chrome://global/content/editMenuOverlay.js"/>
 #ifndef XP_MACOSX
   <!-- On Mac, this is included via macWindow.inc.xul -> global-scripts.inc -> browser.js -> defineLazyScriptGetter -->
   <script type="application/javascript"
           src="chrome://browser/content/places/editBookmark.js"/>
   <!-- On Mac, thes are included via macWindow.inc.xul -> global-scripts.inc -->
   <script type="application/javascript"
           src="chrome://global/content/globalOverlay.js"/>
   <script type="application/javascript"
@@ -57,17 +59,16 @@
 
   <stringbundleset id="placesStringSet">
     <stringbundle id="brandStrings" src="chrome://branding/locale/brand.properties"/>
   </stringbundleset>
 
 #ifdef XP_MACOSX
 #include ../../../base/content/macWindow.inc.xul
 #else
-#include ../../../../toolkit/content/editMenuCommands.inc.xul
 #include placesCommands.inc.xul
 #endif
 
   <!-- This must be included after macWindow.inc.xul to override DownloadsView -->
   <script type="application/javascript"
           src="chrome://browser/content/downloads/allDownloadsView.js"/>
   <script type="application/javascript"
           src="chrome://global/content/contentAreaUtils.js"/>
diff --git a/devtools/client/jar.mn b/devtools/client/jar.mn
--- a/devtools/client/jar.mn
+++ b/devtools/client/jar.mn
@@ -7,18 +7,18 @@ devtools.jar:
     content/shared/vendor/d3.js (shared/vendor/d3.js)
     content/shared/vendor/dagre-d3.js (shared/vendor/dagre-d3.js)
     content/shared/widgets/widgets.css (shared/widgets/widgets.css)
     content/shared/widgets/VariablesView.xul (shared/widgets/VariablesView.xul)
     content/webconsole/index.html (webconsole/index.html)
 *   content/scratchpad/index.xul (scratchpad/index.xul)
     content/shared/splitview.css (shared/splitview.css)
     content/shared/theme-switching.js (shared/theme-switching.js)
-*   content/styleeditor/index.xul (styleeditor/index.xul)
-*   content/storage/index.xul (storage/index.xul)
+    content/styleeditor/index.xul (styleeditor/index.xul)
+    content/storage/index.xul (storage/index.xul)
     content/inspector/markup/markup.xhtml (inspector/markup/markup.xhtml)
     content/shared/sourceeditor/codemirror/addon/dialog/dialog.css (shared/sourceeditor/codemirror/addon/dialog/dialog.css)
     content/shared/sourceeditor/codemirror/addon/hint/show-hint.js (shared/sourceeditor/codemirror/addon/hint/show-hint.js)
     content/shared/sourceeditor/codemirror/addon/tern/tern.js (shared/sourceeditor/codemirror/addon/tern/tern.js)
     content/shared/sourceeditor/codemirror/codemirror.bundle.js (shared/sourceeditor/codemirror/codemirror.bundle.js)
     content/shared/sourceeditor/codemirror/lib/codemirror.css (shared/sourceeditor/codemirror/lib/codemirror.css)
     content/shared/sourceeditor/codemirror/mozilla.css (shared/sourceeditor/codemirror/mozilla.css)
     content/shared/sourceeditor/codemirror/cmiframe.html (shared/sourceeditor/codemirror/cmiframe.html)
diff --git a/devtools/client/scratchpad/index.xul b/devtools/client/scratchpad/index.xul
--- a/devtools/client/scratchpad/index.xul
+++ b/devtools/client/scratchpad/index.xul
@@ -25,18 +25,17 @@
         screenX="4" screenY="4"
         width="640" height="480"
         persist="screenX screenY width height sizemode">
 
 <script type="application/javascript"
         src="chrome://devtools/content/shared/theme-switching.js"/>
 <script type="application/javascript" src="chrome://global/content/globalOverlay.js"/>
 <script type="application/javascript" src="resource://devtools/client/scratchpad/scratchpad.js"/>
-
-#include ../../../toolkit/content/editMenuCommands.inc.xul
+<script type="application/javascript" src="chrome://global/content/editMenuOverlay.js"/>
 
 <commandset id="sourceEditorCommands">
   <command id="cmd_find" oncommand=";"/>
   <command id="cmd_findAgain" oncommand=";"/>
   <command id="cmd_gotoLine" oncommand=";"/>
 </commandset>
 
 <commandset id="sp-commandset">
diff --git a/devtools/client/scratchpad/scratchpad.js b/devtools/client/scratchpad/scratchpad.js
--- a/devtools/client/scratchpad/scratchpad.js
+++ b/devtools/client/scratchpad/scratchpad.js
@@ -9,17 +9,16 @@
  *
  * Copied and relicensed from the Public Domain.
  * See bug 653934 for details.
  * https://bugzilla.mozilla.org/show_bug.cgi?id=653934
  */
 
 // Via index.xul
 /* import-globals-from ../../../toolkit/content/globalOverlay.js */
-// Via editMenuCommands.inc.xul
 /* import-globals-from ../../../toolkit/content/editMenuOverlay.js */
 
 "use strict";
 
 const SCRATCHPAD_CONTEXT_CONTENT = 1;
 const SCRATCHPAD_CONTEXT_BROWSER = 2;
 const BUTTON_POSITION_SAVE = 0;
 const BUTTON_POSITION_CANCEL = 1;
diff --git a/devtools/client/storage/index.xul b/devtools/client/storage/index.xul
--- a/devtools/client/storage/index.xul
+++ b/devtools/client/storage/index.xul
@@ -13,18 +13,17 @@
   %storageDTD;
 ]>
 
 <window xmlns="http://www.mozilla.org/keymaster/gatekeeper/there.is.only.xul">
 
   <script type="application/javascript"
           src="chrome://devtools/content/shared/theme-switching.js"/>
   <script type="text/javascript" src="chrome://global/content/globalOverlay.js"/>
-
-#include ../../../toolkit/content/editMenuCommands.inc.xul
+  <script type="application/javascript" src="chrome://global/content/editMenuOverlay.js"/>
 
   <popupset id="storagePopupSet">
     <menupopup id="storage-tree-popup">
       <menuitem id="storage-tree-popup-delete-all"
                 label="&storage.popupMenu.deleteAllLabel;"/>
       <menuitem id="storage-tree-popup-delete-all-session-cookies"
                 label="&storage.popupMenu.deleteAllSessionCookiesLabel;"/>
       <menuitem id="storage-tree-popup-delete"/>
diff --git a/devtools/client/styleeditor/index.xul b/devtools/client/styleeditor/index.xul
--- a/devtools/client/styleeditor/index.xul
+++ b/devtools/client/styleeditor/index.xul
@@ -24,16 +24,17 @@
 <window xmlns="http://www.mozilla.org/keymaster/gatekeeper/there.is.only.xul"
         xmlns:html="http://www.w3.org/1999/xhtml"
         id="style-editor-chrome-window">
 
   <script type="application/javascript"
           src="chrome://devtools/content/shared/theme-switching.js"/>
   <script type="application/javascript" src="chrome://global/content/globalOverlay.js"/>
   <script type="application/javascript" src="chrome://browser/content/utilityOverlay.js"/>
+  <script type="application/javascript" src="chrome://global/content/editMenuOverlay.js"/>
   <script type="application/javascript">
     function goUpdateSourceEditorMenuItems() {
       goUpdateGlobalEditMenuItems();
 
       ['cmd_undo', 'cmd_redo', 'cmd_cut', 'cmd_paste',
        'cmd_delete', 'cmd_find', 'cmd_findAgain'].forEach(goUpdateCommand);
     }
   </script>
@@ -81,18 +82,16 @@
                 accesskey="&showOriginalSources.accesskey;"/>
       <menuitem id="options-show-media"
                 type="checkbox"
                 label="&showMediaSidebar.label;"
                 accesskey="&showMediaSidebar.accesskey;"/>
     </menupopup>
   </popupset>
 
-#include ../../../toolkit/content/editMenuCommands.inc.xul
-
   <commandset id="sourceEditorCommands">
     <command id="cmd_gotoLine" oncommand="goDoCommand('cmd_gotoLine')"/>
     <command id="cmd_find" oncommand="goDoCommand('cmd_find')"/>
     <command id="cmd_findAgain" oncommand="goDoCommand('cmd_findAgain')"/>
   </commandset>
 
   <keyset id="sourceEditorKeys"/>
 
diff --git a/devtools/client/webide/content/jar.mn b/devtools/client/webide/content/jar.mn
--- a/devtools/client/webide/content/jar.mn
+++ b/devtools/client/webide/content/jar.mn
@@ -1,15 +1,15 @@
 # This Source Code Form is subject to the terms of the Mozilla Public
 # License, v. 2.0. If a copy of the MPL was not distributed with this
 # file, You can obtain one at http://mozilla.org/MPL/2.0/.
 
 webide.jar:
 %   content webide %content/
-*   content/webide.xul                (webide.xul)
+    content/webide.xul                (webide.xul)
     content/webide.js                 (webide.js)
     content/newapp.xul                (newapp.xul)
     content/newapp.js                 (newapp.js)
     content/details.xhtml             (details.xhtml)
     content/details.js                (details.js)
     content/addons.js                 (addons.js)
     content/addons.xhtml              (addons.xhtml)
     content/runtimedetails.js         (runtimedetails.js)
diff --git a/devtools/client/webide/content/webide.xul b/devtools/client/webide/content/webide.xul
--- a/devtools/client/webide/content/webide.xul
+++ b/devtools/client/webide/content/webide.xul
@@ -23,18 +23,17 @@
         screenX="4" screenY="4"
         width="800" height="600"
         persist="screenX screenY width height sizemode">
 
   <script type="application/javascript" src="chrome://global/content/globalOverlay.js"></script>
   <script type="application/javascript" src="project-panel.js"></script>
   <script type="application/javascript" src="runtime-panel.js"></script>
   <script type="application/javascript" src="webide.js"></script>
-
-#include ../../../../toolkit/content/editMenuCommands.inc.xul
+  <script type="application/javascript" src="chrome://global/content/editMenuOverlay.js"/>
 
   <commandset id="mainCommandSet">
     <commandset id="webideCommands">
       <command id="cmd_quit" oncommand="Cmds.quit()"/>
       <command id="cmd_newApp" oncommand="Cmds.newApp()" label="&projectMenu_newApp_label;"/>
       <command id="cmd_importPackagedApp" oncommand="Cmds.importPackagedApp()" label="&projectMenu_importPackagedApp_label;"/>
       <command id="cmd_importHostedApp" oncommand="Cmds.importHostedApp()" label="&projectMenu_importHostedApp_label;"/>
       <command id="cmd_showDevicePrefs" label="&runtimeMenu_showDevicePrefs_label;" oncommand="Cmds.showDevicePrefs()"/>
diff --git a/toolkit/content/editMenuCommands.inc.xul b/toolkit/content/editMenuCommands.inc.xul
deleted file mode 100644
--- a/toolkit/content/editMenuCommands.inc.xul
+++ /dev/null
@@ -1,21 +0,0 @@
-<script type="application/javascript" src="chrome://global/content/editMenuOverlay.js"
-#ifdef BROWSER_XHTML
-xmlns="http://www.w3.org/1999/xhtml"
-#endif
-/>
-<commandset id="editMenuCommands">
-  <commandset id="editMenuCommandSetAll" commandupdater="true" events="focus,select"
-              oncommandupdate="goUpdateGlobalEditMenuItems()"/>
-  <commandset id="editMenuCommandSetUndo" commandupdater="true" events="undo"
-              oncommandupdate="goUpdateUndoEditMenuItems()"/>
-  <commandset id="editMenuCommandSetPaste" commandupdater="true" events="clipboard"
-              oncommandupdate="goUpdatePasteMenuItems()"/>
-  <command id="cmd_undo" oncommand="goDoCommand('cmd_undo')"/>
-  <command id="cmd_redo" oncommand="goDoCommand('cmd_redo')"/>
-  <command id="cmd_cut" oncommand="goDoCommand('cmd_cut')"/>
-  <command id="cmd_copy" oncommand="goDoCommand('cmd_copy')"/>
-  <command id="cmd_paste" oncommand="goDoCommand('cmd_paste')"/>
-  <command id="cmd_delete" oncommand="goDoCommand('cmd_delete')"/>
-  <command id="cmd_selectAll" oncommand="goDoCommand('cmd_selectAll')"/>
-  <command id="cmd_switchTextDirection" oncommand="goDoCommand('cmd_switchTextDirection');"/>
-</commandset>
diff --git a/toolkit/content/editMenuOverlay.js b/toolkit/content/editMenuOverlay.js
--- a/toolkit/content/editMenuOverlay.js
+++ b/toolkit/content/editMenuOverlay.js
@@ -29,8 +29,31 @@ function goUpdateUndoEditMenuItems() {
   goUpdateCommand("cmd_undo");
   goUpdateCommand("cmd_redo");
 }
 
 // update menu items that depend on clipboard contents
 function goUpdatePasteMenuItems() {
   goUpdateCommand("cmd_paste");
 }
+
+// Inject the commandset here instead of relying on preprocessor to share this across documents.
+window.addEventListener("DOMContentLoaded", () => {
+  let container = document.querySelector("commandset") || document.documentElement;
+  container.appendChild(MozXULElement.parseXULToFragment(`
+    <commandset id="editMenuCommands">
+      <commandset id="editMenuCommandSetAll" commandupdater="true" events="focus,select"
+                  oncommandupdate="goUpdateGlobalEditMenuItems()"/>
+      <commandset id="editMenuCommandSetUndo" commandupdater="true" events="undo"
+                  oncommandupdate="goUpdateUndoEditMenuItems()"/>
+      <commandset id="editMenuCommandSetPaste" commandupdater="true" events="clipboard"
+                  oncommandupdate="goUpdatePasteMenuItems()"/>
+      <command id="cmd_undo" oncommand="goDoCommand('cmd_undo')"/>
+      <command id="cmd_redo" oncommand="goDoCommand('cmd_redo')"/>
+      <command id="cmd_cut" oncommand="goDoCommand('cmd_cut')"/>
+      <command id="cmd_copy" oncommand="goDoCommand('cmd_copy')"/>
+      <command id="cmd_paste" oncommand="goDoCommand('cmd_paste')"/>
+      <command id="cmd_delete" oncommand="goDoCommand('cmd_delete')"/>
+      <command id="cmd_selectAll" oncommand="goDoCommand('cmd_selectAll')"/>
+      <command id="cmd_switchTextDirection" oncommand="goDoCommand('cmd_switchTextDirection');"/>
+    </commandset>
+  `));
+}, { once: true });
