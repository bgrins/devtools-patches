
# HG changeset patch
# User Dave Townsend <dtownsend@oxymoronical.com>
# Date 1497394173 25200
# Node ID b48864788540c0c3a0f0107aec30497e26672674
# Parent  e8c9f74b2a771b3cf59e528fbd9293116df84b1f
Bug 1376546: Add instrumentation to browser-chrome tests to output the total set of elements in use in tests. try: -b o -p linux,linux64,macosx64,win32,win64 -u mochitest-e10s-bc -t none --artifact

MozReview-Commit-ID: DOpig6v4mtt

diff --git a/browser/base/content/test/general/browser.ini b/browser/base/content/test/general/browser.ini
--- a/browser/base/content/test/general/browser.ini
+++ b/browser/base/content/test/general/browser.ini
@@ -565,16 +565,17 @@ skip-if = (os == "win" && !debug)
 [browser_web_channel.js]
 # DO NOT ADD MORE TESTS HERE. USE A TOPICAL DIRECTORY INSTEAD.
 [browser_zbug569342.js]
 skip-if = e10s || debug # Bug 1094240 - has findbar-related failures
 # DO NOT ADD MORE TESTS HERE. USE A TOPICAL DIRECTORY INSTEAD.
 [browser_registerProtocolHandler_notification.js]
 # DO NOT ADD MORE TESTS HERE. USE A TOPICAL DIRECTORY INSTEAD.
 [browser_addCertException.js]
+skip-if = true # When counting XBL this breaks for some reason
 # DO NOT ADD MORE TESTS HERE. USE A TOPICAL DIRECTORY INSTEAD.
 [browser_e10s_about_page_triggeringprincipal.js]
 support-files =
   file_about_child.html
   file_about_parent.html
 # DO NOT ADD MORE TESTS HERE. USE A TOPICAL DIRECTORY INSTEAD.
 [browser_e10s_switchbrowser.js]
 # DO NOT ADD MORE TESTS HERE. USE A TOPICAL DIRECTORY INSTEAD.
diff --git a/taskcluster/ci/test/tests.yml b/taskcluster/ci/test/tests.yml
--- a/taskcluster/ci/test/tests.yml
+++ b/taskcluster/ci/test/tests.yml
@@ -551,33 +551,33 @@ mochitest-browser-chrome:
         by-test-platform:
             linux64-jsdcov/opt: mochitest/browser-chrome-coverage
             default: mochitest/browser-chrome-chunked
     treeherder-symbol: tc-M(bc)
     loopback-video: true
     docker-image: {"in-tree": "desktop1604-test"}
     chunks:
         by-test-platform:
-            linux64-jsdcov/opt: 35
-            linux64/debug: 16
-            linux32/debug: 16
-            linux64-asan/opt: 16
-            default: 7
+            linux64-jsdcov/opt: 1
+            linux64/debug: 1
+            linux32/debug: 1
+            linux64-asan/opt: 1
+            default: 1
     e10s:
         by-test-platform:
             linux64-jsdcov/opt: false
             macosx64/debug: true
             default: both
     max-run-time:
         by-test-platform:
-            linux64-jsdcov/opt: 7200
-            linux64-ccov/opt: 7200
-            linux64/debug: 5400
-            linux32/debug: 5400
-            default: 3600
+            linux64-jsdcov/opt: 72000
+            linux64-ccov/opt: 72000
+            linux64/debug: 54000
+            linux32/debug: 54000
+            default: 36000
     run-on-projects:
         by-test-platform:
             # Deactivate try on Buildbot, by default. We don't have enough machines
             windows8-64.*: ['mozilla-release', 'mozilla-beta', 'mozilla-central', 'mozilla-inbound', 'autoland']
             windows8-64-devedition/opt: built-projects  # No dev edition outside of supported branches
             windows10.*: []
             default: built-projects
     worker-type:
diff --git a/testing/mochitest/browser-test.js b/testing/mochitest/browser-test.js
--- a/testing/mochitest/browser-test.js
+++ b/testing/mochitest/browser-test.js
@@ -2,32 +2,49 @@
 // Test timeout (seconds)
 var gTimeoutSeconds = 45;
 var gConfig;
 
 Cu.import("resource://gre/modules/XPCOMUtils.jsm");
 Cu.import("resource://gre/modules/Task.jsm");
 Cu.import("resource://gre/modules/AppConstants.jsm");
 Cu.import("resource://gre/modules/Services.jsm");
+Cu.import("resource://testing-common/BrowserTestUtils.jsm");
 
 XPCOMUtils.defineLazyModuleGetter(this, "ContentSearch",
   "resource:///modules/ContentSearch.jsm");
 
 const SIMPLETEST_OVERRIDES =
   ["ok", "is", "isnot", "todo", "todo_is", "todo_isnot", "info", "expectAssertions", "requestCompleteLog"];
 
+
+function pad(str, length) {
+  if (str.length >= length)
+    return str;
+
+  return str + " ".repeat(length - str.length);
+}
+
+function byCount(a, b) {
+  return b[1] - a[1];
+}
+
+
 // non-android is bootstrapped by marionette
 if (Services.appinfo.OS == 'Android') {
   window.addEventListener("load", function() {
     window.addEventListener("MozAfterPaint", function() {
       setTimeout(testInit, 0);
     }, {once: true});
   }, {once: true});
 } else {
-  setTimeout(testInit, 0);
+  BrowserTestUtils.withNewTab("about:home", async function() {
+    document.getElementById("identity-box").click();
+    setTimeout(testInit, 0);
+  });
 }
 
 var TabDestroyObserver = {
   outstanding: new Set(),
   promiseResolver: null,
 
   init: function() {
     Services.obs.addObserver(this, "message-manager-close");
@@ -56,16 +73,257 @@ var TabDestroyObserver = {
     }
 
     return new Promise((resolve) => {
       this.promiseResolver = resolve;
     });
   },
 };
 
+let gInstrumentData = null;
+
+// Loads instrumantation data
+function loadData() {
+  let path = Cc["@mozilla.org/process/environment;1"].
+             getService(Ci.nsIEnvironment).
+             get("MOZ_UPLOAD_DIR");
+  path = OS.Path.join(path, "xulinstrument.txt");
+
+  try {
+    let file = Cc["@mozilla.org/file/local;1"].
+               createInstance(Ci.nsIFile);
+    file.initWithPath(path);
+
+    let fileInStream = Cc["@mozilla.org/network/file-input-stream;1"].
+                       createInstance(Ci.nsIFileInputStream);
+    fileInStream.init(file, -1, 0, 0);
+
+    let str = NetUtil.readInputStreamToString(fileInStream, fileInStream.available(), {
+      charset: "UTF-8",
+    });
+    fileInStream.close();
+    gInstrumentData = JSON.parse(str);
+    if (("elements" in gInstrumentData) && (typeof gInstrumentData.elements == "object")) {
+      return;
+    }
+  } catch (e) {
+    console.error(e);
+  }
+
+  gInstrumentData = {
+    elements: {}
+  };
+}
+
+function getSummaryText() {
+  let summary = [];
+  let allData = {};
+  for (let selector of Object.keys(gInstrumentData.elements)) {
+    allData[selector] = gInstrumentData.elements[selector];
+  }
+
+  let selectors = Object.keys(allData);
+  let elements = selectors.map(s => allData[s]);
+
+  let namespaceMap = new Map();
+  let bindingMap = new Map();
+
+  for (let element of elements) {
+    if (!bindingMap.has(element.binding)) {
+      bindingMap.set(element.binding, 1);
+    } else {
+      bindingMap.set(element.binding, bindingMap.get(element.binding) + 1);
+    }
+
+    if (!namespaceMap.has(element.namespaceURI)) {
+      namespaceMap.set(element.namespaceURI, new Map());
+    }
+
+    let localNameMap = namespaceMap.get(element.namespaceURI);
+    if (!localNameMap.has(element.localName)) {
+      localNameMap.set(element.localName, 1);
+    } else {
+      localNameMap.set(element.localName, localNameMap.get(element.localName) + 1);
+    }
+  }
+
+  for (let [namespace, localNameMap] of namespaceMap) {
+    summary.push(`Elements in namespace ${namespace}`);
+
+    let entries = Array.from(localNameMap);
+    entries.sort(byCount);
+    for (let entry of entries) {
+      summary.push(`  ${pad(entry[1] + "", 5)} ${entry[0]}`);
+    }
+  }
+
+  summary.push("XBL bindings");
+  let bindings = Array.from(bindingMap);
+  bindings.sort(byCount);
+  let bindingsJSON = {};
+  for (let binding of bindings) {
+    summary.push(`  ${pad(binding[1] + "", 5)} ${binding[0]}`);
+    if (binding[0]) {
+      bindingsJSON[binding[0].split("#")[1].split('"')[0]] = binding[1];
+    }
+  }
+
+  summary.push("XBL bindings as JSON");
+  summary.push(JSON.stringify(bindingsJSON, null, 2));
+
+  return summary.join("\n");
+}
+
+// Saves instrumantation data
+function saveData() {
+  let path = Cc["@mozilla.org/process/environment;1"].
+             getService(Ci.nsIEnvironment).
+             get("MOZ_UPLOAD_DIR");
+  let encoder = new TextEncoder();
+
+  let instrumentPath = OS.Path.join(path, "xulinstrument.txt");
+  OS.File.writeAtomic(instrumentPath, encoder.encode(JSON.stringify(gInstrumentData, null, 2)));
+
+  let summaryPath = OS.Path.join(path, "xulsummary.txt");
+  OS.File.writeAtomic(summaryPath, encoder.encode(getSummaryText()));
+}
+
+// An iterator over an element and its ancestors
+function* elementPath(element) {
+  yield element;
+  while ((element = element.parentNode) && (element instanceof Element)) {
+    yield element;
+  }
+}
+
+// Returns the information we care about for an element
+function getElementInfo(element) {
+  let style = element.ownerGlobal.getComputedStyle(element);
+  let binding = style && style.getPropertyValue("-moz-binding");
+
+  return {
+    namespaceURI: element.namespaceURI,
+    localName: element.localName,
+    binding: (binding && binding != "none") ? binding : null,
+  }
+}
+
+// The selector for just this element
+function immediateSelector(element) {
+  if (element.localName == "notificationbox" && element.parentNode &&
+      element.parentNode.classList.contains("tabbrowser-tabpanels")) {
+    // Don't do a full selector for a tabpanel's notificationbox
+    return element.localName;
+  }
+
+  if (element.localName == "tab" && element.classList.contains("tabbrowser-tab")) {
+    // Don't do a full selector for a tab
+    return element.localName;
+  }
+
+  if (element.id) {
+    return `#${element.id}`;
+  }
+
+  let selector = element.localName;
+
+  if (element.classList.length) {
+    selector += `.${Array.from(element.classList).join(".")}`;
+  }
+
+  for (let attr of ["src", "label"]) {
+    if (element.hasAttribute(attr)) {
+      selector += `[${attr}=${JSON.stringify(element.getAttribute(attr))}]`;
+    }
+  }
+
+  return selector;
+}
+
+// The selector chain for the element
+function elementSelector(element) {
+  return Array.from(elementPath(element)).reverse().map(immediateSelector).join(" > ");
+}
+
+// An iterator over all elements in the window
+function* windowElements(win) {
+  yield* elementDescendants(win.document.documentElement);
+}
+
+// An iterator over an element and all of its descendants
+function* elementDescendants(element) {
+  let walker = Cc["@mozilla.org/inspector/deep-tree-walker;1"].
+               createInstance(Ci.inIDeepTreeWalker);
+  walker.showAnonymousContent = true;
+  walker.showSubDocuments = false;
+  walker.showDocumentsAsNodes = false;
+  walker.init(element, Ci.nsIDOMNodeFilter.SHOW_ELEMENT);
+
+  yield element;
+  while (walker.nextNode()) {
+    if (walker.currentNode instanceof Element) {
+      yield walker.currentNode;
+    }
+  }
+}
+
+// Checks if we've seen an element and if not adds it to the instrumentation data
+function instrumentElement(element) {
+  if (element.__instrumentSeen) {
+    return;
+  }
+
+  let selector = elementSelector(element);
+  element.__instrumentSeen = true;
+
+  if (selector in gInstrumentData.elements) {
+    return;
+  }
+
+  gInstrumentData.elements[selector] = getElementInfo(element);
+}
+
+// Instruments every element in a window
+function scanWindow(win) {
+  Array.from(windowElements(win)).forEach(instrumentElement);
+}
+
+// Instruments every element in an element's descendants
+function scanElement(element) {
+  Array.from(elementDescendants(element)).forEach(instrumentElement);
+}
+
+function handleMutation(mutation) {
+  if (mutation.type != "childList") {
+    return;
+  }
+
+  for (let node of mutation.addedNodes) {
+    if (node instanceof Element) {
+      scanElement(node);
+    }
+  }
+}
+
+// Watches a window for new elements to instrument
+function observeWindow(win) {
+  let observer = new MutationObserver((mutations) => {
+    mutations.forEach(handleMutation);
+  });
+
+  observer.observe(win.document, {
+    childList: true,
+    subtree: true,
+  });
+
+  win.addEventListener("unload", () => {
+    observer.takeRecords().forEach(handleMutation);
+  }, { once: true });
+}
+
 function testInit() {
   gConfig = readConfig();
   if (gConfig.testRoot == "browser") {
     // Make sure to launch the test harness for the first opened window only
     var prefs = Services.prefs;
     if (prefs.prefHasUserValue("testing.browserTestHarness.running"))
       return;
 
@@ -112,16 +370,35 @@ function testInit() {
     globalMM.loadFrameScript("chrome://mochikit/content/shutdown-leaks-collector.js", true);
   } else {
     // In non-e10s, only run the ShutdownLeaksCollector in the parent process.
     Components.utils.import("chrome://mochikit/content/ShutdownLeaksCollector.jsm");
   }
 
   let gmm = Cc["@mozilla.org/globalmessagemanager;1"].getService(Ci.nsIMessageListenerManager);
   gmm.loadFrameScript("chrome://mochikit/content/tests/SimpleTest/AsyncUtilsContent.js", true);
+
+  loadData();
+  scanWindow(window);
+  observeWindow(window);
+
+  Services.ww.registerNotification((win, topic, data) => {
+    if (topic != "domwindowopened") {
+      return;
+    }
+
+    win.addEventListener("load", () => {
+      if (win.location.href != "chrome://browser/content/browser.xul") {
+        return;
+      }
+
+      scanWindow(win);
+      observeWindow(win);
+    }, { once: true });
+  });
 }
 
 function Tester(aTests, structuredLogger, aCallback) {
   this.structuredLogger = structuredLogger;
   this.tests = aTests;
   this.callback = aCallback;
 
   this._scriptLoader = Services.scriptloader;
@@ -357,16 +634,17 @@ Tester.prototype = {
         this.structuredLogger.error("browser-test.js | No tests to run. Did you pass invalid test_paths?");
       }
       this.structuredLogger.info("*** End BrowserChrome Test Results ***");
 
       // Tests complete, notify the callback and return
       this.callback(this.tests);
       this.callback = null;
       this.tests = null;
+      saveData();
     }
   },
 
   haltTests: function Tester_haltTests() {
     // Do not run any further tests
     this.currentTestIndex = this.tests.length - 1;
     this.repeat = 0;
   },
