# HG changeset patch
# User Gabriel Luong <gabriel.luong@gmail.com>
# Parent  ddd941d6460df47b7174a2af473335f7de6400d1
Bug 1120616 - Part 3: Adjust the styles in the computed view's filter style search r=bgrins

diff --git a/browser/devtools/styleinspector/computed-view.js b/browser/devtools/styleinspector/computed-view.js
--- a/browser/devtools/styleinspector/computed-view.js
+++ b/browser/devtools/styleinspector/computed-view.js
@@ -146,43 +146,47 @@
   // Create bound methods.
   this.focusWindow = this.focusWindow.bind(this);
   this._onContextMenu = this._onContextMenu.bind(this);
   this._contextMenuUpdate = this._contextMenuUpdate.bind(this);
   this._onSelectAll = this._onSelectAll.bind(this);
   this._onClick = this._onClick.bind(this);
   this._onCopy = this._onCopy.bind(this);
   this._onCopyColor = this._onCopyColor.bind(this);
+  this._onFilterStyles = this._onFilterStyles.bind(this);
+  this._onClearSearch = this._onClearSearch.bind(this);
+  this._onIncludeBrowserStyles = this._onIncludeBrowserStyles.bind(this);
 
-  this.styleDocument.addEventListener("copy", this._onCopy);
+  this.root = this.styleDocument.getElementById("root");
+  this.element = this.styleDocument.getElementById("propertyContainer");
+  this.searchField = this.styleDocument.getElementById("computedview-searchbox");
+  this.searchClearButton = this.styleDocument.getElementById("computedview-searchinput-clear");
+  this.includeBrowserStylesCheckbox = this.styleDocument.getElementById("browser-style-checkbox");
+
   this.styleDocument.addEventListener("mousedown", this.focusWindow);
-  this.styleDocument.addEventListener("contextmenu", this._onContextMenu);
-
-  // Nodes used in templating
-  this.root = this.styleDocument.getElementById("root");
-  this.templateRoot = this.styleDocument.getElementById("templateRoot");
-  this.element = this.styleDocument.getElementById("propertyContainer");
-
-  // Listen for click events
-  this.element.addEventListener("click", this._onClick, false);
+  this.element.addEventListener("click", this._onClick);
+  this.element.addEventListener("copy", this._onCopy);
+  this.element.addEventListener("contextmenu", this._onContextMenu);
+  this.searchField.addEventListener("input", this._onFilterStyles);
+  this.searchClearButton.addEventListener("click", this._onClearSearch);
+  this.includeBrowserStylesCheckbox.addEventListener("command",
+    this._onIncludeBrowserStyles);
 
   // No results text.
   this.noResults = this.styleDocument.getElementById("noResults");
 
   // Refresh panel when color unit changed.
   this._handlePrefChange = this._handlePrefChange.bind(this);
   gDevTools.on("pref-changed", this._handlePrefChange);
 
   // Refresh panel when pref for showing original sources changes
   this._updateSourceLinks = this._updateSourceLinks.bind(this);
   this._prefObserver = new PrefObserver("devtools.");
   this._prefObserver.on(PREF_ORIG_SOURCES, this._updateSourceLinks);
 
-  CssHtmlTree.processTemplate(this.templateRoot, this.root, this);
-
   // The element that we're inspecting, and the document that it comes from.
   this.viewedElement = null;
 
   this._buildContextMenu();
   this.createStyleViews();
 
   // Add the tooltips and highlightersoverlay
   this.tooltips = new overlays.TooltipsOverlay(this);
@@ -247,22 +251,16 @@
 
 CssHtmlTree.prototype = {
   // Cache the list of properties that match the selected element.
   _matchedProperties: null,
 
   // Used for cancelling timeouts in the style filter.
   _filterChangedTimeout: null,
 
-  // The search filter
-  searchField: null,
-
-  // Reference to the "Include browser styles" checkbox.
-  includeBrowserStylesCheckbox: null,
-
   // Holds the ID of the panelRefresh timeout.
   _panelRefreshTimeout: null,
 
   // Toggle for zebra striping
   _darkStripe: true,
 
   // Number of visible properties
   numVisibleProperties: 0,
@@ -491,58 +489,75 @@
       let deferred = promise.defer();
       this._refreshProcess = new UpdateProcess(this.styleWindow, this.propertyViews, {
         onItem: (aPropView) => {
           aPropView.refresh();
         },
         onDone: () => {
           this._refreshProcess = null;
           this.noResults.hidden = this.numVisibleProperties > 0;
+
+          if (this.searchField.value.length > 0 && !this.numVisibleProperties) {
+            this.searchField.classList.add("devtools-style-searchbox-no-match");
+          } else {
+            this.searchField.classList.remove("devtools-style-searchbox-no-match");
+          }
+
           this.inspector.emit("computed-view-refreshed");
           deferred.resolve(undefined);
         }
       });
       this._refreshProcess.schedule();
       return deferred.promise;
     }).then(null, (err) => console.error(err));
   },
 
   /**
-   * Called when the user enters a search term.
+   * Called when the user enters a search term in the filter stylesearch box.
    *
    * @param {Event} aEvent the DOM Event object.
    */
-  filterChanged: function CssHtmlTree_filterChanged(aEvent)
+  _onFilterStyles: function(aEvent)
   {
     let win = this.styleWindow;
 
     if (this._filterChangedTimeout) {
       win.clearTimeout(this._filterChangedTimeout);
     }
 
+    let filterTimeout = (this.searchField.value.length > 0)
+      ? FILTER_CHANGED_TIMEOUT : 0;
+    this.searchClearButton.style.display = (this.searchField.value.length > 0)
+      ? "block" : "none";
+
     this._filterChangedTimeout = win.setTimeout(() => {
+      if (this.searchField.value.length > 0) {
+        this.searchField.setAttribute("filled", true);
+      } else {
+        this.searchField.removeAttribute("filled");
+      }
+
       this.refreshPanel();
       this._filterChangeTimeout = null;
-    }, FILTER_CHANGED_TIMEOUT);
+    }, filterTimeout);
   },
 
   /**
    * The change event handler for the includeBrowserStyles checkbox.
    *
    * @param {Event} aEvent the DOM Event object.
    */
-  includeBrowserStylesChanged:
-  function CssHtmltree_includeBrowserStylesChanged(aEvent)
+  _onIncludeBrowserStyles: function(aEvent)
   {
     this.refreshSourceFilter();
     this.refreshPanel();
   },
 
   /**
-   * When includeBrowserStyles.checked is false we only display properties that
+   * When includeBrowserStylesCheckbox.checked is false we only display properties that
    * have matched selectors and have been included by the document or one of the
    * document's stylesheets. If .checked is false we display all properties
    * including those that come from UA stylesheets.
    */
   refreshSourceFilter: function CssHtmlTree_setSourceFilter()
   {
     this._matchedProperties = null;
     this._sourceFilter = this.includeBrowserStyles ?
@@ -808,42 +823,46 @@
    */
   _onToggleOrigSources: function()
   {
     let isEnabled = Services.prefs.getBoolPref(PREF_ORIG_SOURCES);
     Services.prefs.setBoolPref(PREF_ORIG_SOURCES, !isEnabled);
   },
 
   /**
+   * Called when the user clicks on the clear button in the filter style search
+   * box.
+   */
+  _onClearSearch: function() {
+    this.searchField.value = "";
+    this.searchField.focus();
+    this._onFilterStyles();
+  },
+
+  /**
    * Destructor for CssHtmlTree.
    */
   destroy: function CssHtmlTree_destroy()
   {
     this.viewedElement = null;
     this._outputParser = null;
 
-    // Remove event listeners
-    this.includeBrowserStylesCheckbox.removeEventListener("command",
-      this.includeBrowserStylesChanged);
-    this.searchField.removeEventListener("command", this.filterChanged);
     gDevTools.off("pref-changed", this._handlePrefChange);
 
     this._prefObserver.off(PREF_ORIG_SOURCES, this._updateSourceLinks);
     this._prefObserver.destroy();
 
     // Cancel tree construction
     if (this._createViewsProcess) {
       this._createViewsProcess.cancel();
     }
     if (this._refreshProcess) {
       this._refreshProcess.cancel();
     }
 
-    this.element.removeEventListener("click", this._onClick, false);
-
     // Remove context menu
     if (this._contextmenu) {
       // Destroy the Select All menuitem.
       this.menuitemCopy.removeEventListener("command", this._onCopy);
       this.menuitemCopy = null;
 
       // Destroy the Copy menuitem.
       this.menuitemSelectAll.removeEventListener("command", this._onSelectAll);
@@ -860,24 +879,32 @@
     }
 
     this.popupNode = null;
 
     this.tooltips.destroy();
     this.highlighters.destroy();
 
     // Remove bound listeners
-    this.styleDocument.removeEventListener("contextmenu", this._onContextMenu);
-    this.styleDocument.removeEventListener("copy", this._onCopy);
     this.styleDocument.removeEventListener("mousedown", this.focusWindow);
+    this.element.removeEventListener("click", this._onClick);
+    this.element.removeEventListener("copy", this._onCopy);
+    this.element.removeEventListener("contextmenu", this._onContextMenu);
+    this.searchField.removeEventListener("input", this._onFilterStyles);
+    this.searchClearButton.removeEventListener("click", this._onClearSearch);
+    this.includeBrowserStylesCheckbox.removeEventListener("command",
+      this.includeBrowserStylesChanged);
 
     // Nodes used in templating
     this.root = null;
     this.element = null;
     this.panel = null;
+    this.searchField = null;
+    this.searchClearButton = null;
+    this.includeBrowserStylesCheckbox = null;
 
     // The document in which we display the results (csshtmltree.xul).
     this.styleDocument = null;
 
     for (let propView of this.propertyViews)  {
       propView.destroy();
     }
 
@@ -999,18 +1026,20 @@
       return false;
     }
 
     if (!this.tree.includeBrowserStyles && !this.hasMatchedSelectors) {
       return false;
     }
 
     let searchTerm = this.tree.searchField.value.toLowerCase();
-    if (searchTerm && this.name.toLowerCase().indexOf(searchTerm) == -1 &&
-      this.value.toLowerCase().indexOf(searchTerm) == -1) {
+    let isValidSearchTerm = searchTerm.trim().length > 0;
+    if (isValidSearchTerm &&
+        this.name.toLowerCase().indexOf(searchTerm) == -1 &&
+        this.value.toLowerCase().indexOf(searchTerm) == -1) {
       return false;
     }
 
     return true;
   },
 
   /**
    * Returns the className that should be assigned to the propertyView.
diff --git a/browser/devtools/styleinspector/computedview.xhtml b/browser/devtools/styleinspector/computedview.xhtml
--- a/browser/devtools/styleinspector/computedview.xhtml
+++ b/browser/devtools/styleinspector/computedview.xhtml
@@ -44,50 +44,44 @@
           this.computedview.destroy();
         }
       }
     </script>
   </head>
 
   <body>
 
+    <div id="root" class="devtools-monospace">
+      <div class="devtools-toolbar">
+        <div class="devtools-searchbox">
+          <input id="computedview-searchbox"
+                 class="devtools-searchinput devtools-rule-searchbox"
+                 type="search" placeholder="&userStylesSearch;"/>
+          <button id="computedview-searchinput-clear" class="devtools-searchinput-clear"></button>
+        </div>
+        <xul:checkbox id="browser-style-checkbox"
+                      class="includebrowserstyles"
+                      checked="false" label="&browserStylesLabel;"/>
+      </div>
+    </div>
+
     <!-- The output from #templateProperty (below) is appended here. -->
     <div id="propertyContainer" class="devtools-monospace">
     </div>
 
     <!-- When no properties are found the following block is displayed. -->
     <div id="noResults" hidden="">
       &noPropertiesFound;
     </div>
 
-    <!-- The output from #templateRoot (below) is inserted here. -->
-    <div id="root" class="devtools-monospace"></div>
-
     <!--
     To visually debug the templates without running firefox, alter the display:none
     -->
     <div style="display:none;">
       <!--
-      templateRoot sits at the top of the window and contains the "include default
-      styles" checkbox. For data it needs an instance of CssHtmlTree.
-      -->
-      <div id="templateRoot">
-        <xul:hbox class="devtools-toolbar" flex="1" align="center">
-          <xul:checkbox class="includebrowserstyles"
-                        save="${includeBrowserStylesCheckbox}"
-                        oncommand="${includeBrowserStylesChanged}" checked="false"
-                        label="&browserStylesLabel;"/>
-          <xul:textbox class="devtools-searchinput" type="search" save="${searchField}"
-                      placeholder="&userStylesSearch;" flex="1"
-                      oncommand="${filterChanged}"/>
-        </xul:hbox>
-      </div>
-
-
-      <!--
       A templateMatchedSelectors sits inside each templateProperties showing the
       list of selectors that affect that property. Each needs data like this:
       {
         matchedSelectorViews: ..., // from cssHtmlTree.propertyViews[name].matchedSelectorViews
       }
       This is a template so the parent does not need to be a table, except that
       using a div as the parent causes the DOM to muck with the tr elements
       -->
diff --git a/browser/devtools/styleinspector/test/browser.ini b/browser/devtools/styleinspector/test/browser.ini
--- a/browser/devtools/styleinspector/test/browser.ini
+++ b/browser/devtools/styleinspector/test/browser.ini
@@ -33,16 +33,17 @@
 [browser_computedview_matched-selectors_01.js]
 [browser_computedview_matched-selectors_02.js]
 [browser_computedview_media-queries.js]
 [browser_computedview_no-results-placeholder.js]
 [browser_computedview_original-source-link.js]
 [browser_computedview_pseudo-element_01.js]
 [browser_computedview_refresh-on-style-change_01.js]
 [browser_computedview_search-filter.js]
+[browser_computedview_search-filter_clear.js]
 [browser_computedview_select-and-copy-styles.js]
 [browser_computedview_style-editor-link.js]
 [browser_ruleview_add-property-and-reselect.js]
 [browser_ruleview_add-property-cancel_01.js]
 [browser_ruleview_add-property-cancel_02.js]
 [browser_ruleview_add-property-cancel_03.js]
 [browser_ruleview_add-property_01.js]
 [browser_ruleview_add-property_02.js]
diff --git a/browser/devtools/styleinspector/test/browser_computedview_search-filter.js b/browser/devtools/styleinspector/test/browser_computedview_search-filter.js
--- a/browser/devtools/styleinspector/test/browser_computedview_search-filter.js
+++ b/browser/devtools/styleinspector/test/browser_computedview_search-filter.js
@@ -26,29 +26,29 @@
   yield testAddTextInFilter(inspector, view);
 });
 
 
 function* testToggleDefaultStyles(inspector, computedView) {
   info("checking \"Browser styles\" checkbox");
 
   let doc = computedView.styleDocument;
-  let checkbox = doc.querySelector(".includebrowserstyles");
+  let checkbox = computedView.includeBrowserStylesCheckbox;
   let onRefreshed = inspector.once("computed-view-refreshed");
   checkbox.click();
   yield onRefreshed;
 }
 
 function* testAddTextInFilter(inspector, computedView) {
   info("setting filter text to \"color\"");
 
   let doc = computedView.styleDocument;
-  let searchbar = doc.querySelector(".devtools-searchinput");
+  let searchField = computedView.searchField;
   let onRefreshed = inspector.once("computed-view-refreshed");
-  searchbar.focus();
+  searchField.focus();
 
   let win = computedView.styleWindow;
   EventUtils.synthesizeKey("c", {}, win);
   EventUtils.synthesizeKey("o", {}, win);
   EventUtils.synthesizeKey("l", {}, win);
   EventUtils.synthesizeKey("o", {}, win);
   EventUtils.synthesizeKey("r", {}, win);
 
diff --git a/browser/devtools/styleinspector/test/browser_computedview_search-filter_clear.js b/browser/devtools/styleinspector/test/browser_computedview_search-filter_clear.js
new file mode 100644
--- /dev/null
+++ b/browser/devtools/styleinspector/test/browser_computedview_search-filter_clear.js
@@ -0,0 +1,76 @@
+/* vim: set ft=javascript ts=2 et sw=2 tw=80: */
+/* Any copyright is dedicated to the Public Domain.
+ http://creativecommons.org/publicdomain/zero/1.0/ */
+
+"use strict";
+
+// Tests that the search filter clear button works properly.
+
+add_task(function*() {
+  yield addTab("data:text/html;charset=utf-8,default styles test");
+
+  info("Creating the test document");
+  content.document.body.innerHTML = '<style type="text/css"> ' +
+    '.matches {color: #F00;}</style>' +
+    '<span id="matches" class="matches">Some styled text</span>' +
+    '</div>';
+  content.document.title = "Style Inspector Search Filter Test";
+
+  info("Opening the computed-view");
+  let {toolbox, inspector, view} = yield openComputedView();
+
+  info("Selecting the test node");
+  yield selectNode("#matches", inspector);
+
+  yield testAddTextInFilter(inspector, view);
+  yield testClearSearchFilter(inspector, view);
+});
+
+function* testAddTextInFilter(inspector, computedView) {
+  info("setting filter text to \"color\"");
+
+  let doc = computedView.styleDocument;
+  let searchField = computedView.searchField;
+  let checkbox = computedView.includeBrowserStylesCheckbox;
+  let onRefreshed = inspector.once("computed-view-refreshed");
+
+  checkbox.click();
+  yield onRefreshed;
+
+  searchField.focus();
+
+  let win = computedView.styleWindow;
+  EventUtils.synthesizeKey("c", {}, win);
+  EventUtils.synthesizeKey("o", {}, win);
+  EventUtils.synthesizeKey("l", {}, win);
+  EventUtils.synthesizeKey("o", {}, win);
+  EventUtils.synthesizeKey("r", {}, win);
+
+  yield onRefreshed;
+
+  info("check that the correct properties are visible");
+
+  let propertyViews = computedView.propertyViews;
+  propertyViews.forEach(function(propView) {
+    let name = propView.name;
+    is(propView.visible, name.indexOf("color") > -1,
+      "span " + name + " property visibility check");
+  });
+}
+
+function* testClearSearchFilter(inspector, computedView) {
+  info("clearing the search filter");
+
+  let doc = computedView.styleDocument;
+  let win = computedView.styleWindow;
+  let searchField = computedView.searchField;
+  let searchClearButton = computedView.searchClearButton;
+  let onRefreshed = inspector.once("computed-view-refreshed");
+
+  EventUtils.synthesizeMouseAtCenter(searchClearButton, {}, win);
+
+  yield onRefreshed;
+
+  info("check the search filter is cleared");
+  ok(!searchField.value, "Search filter is cleared");
+}
diff --git a/browser/themes/shared/devtools/computedview.css b/browser/themes/shared/devtools/computedview.css
--- a/browser/themes/shared/devtools/computedview.css
+++ b/browser/themes/shared/devtools/computedview.css
@@ -148,16 +148,17 @@
 }
 
 .legendKey {
   margin: 0 5px;
 }
 
 #root .devtools-toolbar {
   width: 100%;
+  display: -moz-box;
 }
 
 .link {
   padding: 0 3px;
   cursor: pointer;
   float: right;
 }
 
diff --git a/browser/themes/shared/devtools/toolbars.inc.css b/browser/themes/shared/devtools/toolbars.inc.css
--- a/browser/themes/shared/devtools/toolbars.inc.css
+++ b/browser/themes/shared/devtools/toolbars.inc.css
@@ -40,20 +40,22 @@
 
 .devtools-toolbar {
   padding: 0 3px;
 }
 
 .devtools-toolbar checkbox {
   margin: 0 2px;
   padding: 0;
+  line-height: -moz-block-height;
 }
 .devtools-toolbar checkbox .checkbox-check {
   margin: 0;
   padding: 0;
+  vertical-align: bottom;
 }
 .devtools-toolbar checkbox .checkbox-label-box {
   border: none !important; /* overrides .checkbox-label-box from checkbox.css */
 }
 .devtools-toolbar checkbox .checkbox-label-box .checkbox-label {
   margin: 0 6px !important; /* overrides .checkbox-label from checkbox.css */
   padding: 0;
 }
