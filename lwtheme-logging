# HG changeset patch
# Parent 4c8242cb14781dcb1ea2482cef2e1ad9c3f22c04
# User Brian Grinstead <bgrinstead@mozilla.com>
tracking down a leak

diff --git a/browser/base/content/browser-devedition.js b/browser/base/content/browser-devedition.js
--- a/browser/base/content/browser-devedition.js
+++ b/browser/base/content/browser-devedition.js
@@ -74,34 +74,39 @@ let DevEdition = {
 
     let deveditionThemeEnabled = Services.prefs.getBoolPref(this._prefName) &&
       !lightweightThemeSelected && defaultThemeSelected;
 
     this._toggleStyleSheet(deveditionThemeEnabled);
   },
 
   _toggleStyleSheet: function(deveditionThemeEnabled) {
+    let {console} = Components.utils.import("resource://gre/modules/devtools/Console.jsm", {});
     if (deveditionThemeEnabled && !this.styleSheet) {
       let styleSheetAttr = `href="${this.styleSheetLocation}" type="text/css"`;
       let styleSheet = this.styleSheet = document.createProcessingInstruction(
         'xml-stylesheet', styleSheetAttr);
       this.styleSheet.addEventListener("load", function onLoad() {
         styleSheet.removeEventListener("load", onLoad);
+        console.log("XXXBrian Call to _positionPinnedTabs in cb");
         gBrowser.tabContainer._positionPinnedTabs();
         ToolbarIconColor.inferFromText();
       });
       document.insertBefore(this.styleSheet, document.documentElement);
     } else if (!deveditionThemeEnabled && this.styleSheet) {
       this.styleSheet.remove();
       this.styleSheet = null;
+      console.log("XXXBrian Call to _positionPinnedTabs outside of cb");
       gBrowser.tabContainer._positionPinnedTabs();
       ToolbarIconColor.inferFromText();
     }
   },
 
   uninit: function () {
+    let {console} = Components.utils.import("resource://gre/modules/devtools/Console.jsm", {});
     Services.prefs.removeObserver(this._lwThemePrefName, this);
     Services.prefs.removeObserver(this._prefName, this);
     Services.prefs.removeObserver(this._devtoolsThemePrefName, this);
+    console.log("XXXBrian Call to remove observer");
     Services.obs.removeObserver(this, "lightweight-theme-styling-update", false);
     this.styleSheet = null;
   }
 };
diff --git a/browser/base/content/test/general/browser_devedition.js b/browser/base/content/test/general/browser_devedition.js
--- a/browser/base/content/test/general/browser_devedition.js
+++ b/browser/base/content/test/general/browser_devedition.js
@@ -76,38 +76,38 @@ function dummyLightweightTheme(id) {
     headerURL: "http://lwttest.invalid/a.png",
     footerURL: "http://lwttest.invalid/b.png",
     textcolor: "red",
     accentcolor: "blue"
   };
 }
 
 function testLightweightThemePreview() {
-  let {LightweightThemeManager} = Components.utils.import("resource://gre/modules/LightweightThemeManager.jsm", {});
+  // let {LightweightThemeManager} = Components.utils.import("resource://gre/modules/LightweightThemeManager.jsm", {});
 
-  info ("Turning the pref on, then previewing lightweight themes");
-  Services.prefs.setBoolPref(PREF_DEVEDITION_THEME, true);
-  ok (DevEdition.styleSheet, "The devedition stylesheet is enabled.");
-  LightweightThemeManager.previewTheme(dummyLightweightTheme("preview0"));
-  ok (!DevEdition.styleSheet, "The devedition stylesheet is not enabled after a lightweight theme preview.");
-  LightweightThemeManager.previewTheme(dummyLightweightTheme("preview1"));
-  ok (!DevEdition.styleSheet, "The devedition stylesheet is not enabled after a second lightweight theme preview.");
-  LightweightThemeManager.resetPreview();
-  ok (DevEdition.styleSheet, "The devedition stylesheet is enabled again after resetting the preview.");
+  // info ("Turning the pref on, then previewing lightweight themes");
+  // Services.prefs.setBoolPref(PREF_DEVEDITION_THEME, true);
+  // ok (DevEdition.styleSheet, "The devedition stylesheet is enabled.");
+  // LightweightThemeManager.previewTheme(dummyLightweightTheme("preview0"));
+  // ok (!DevEdition.styleSheet, "The devedition stylesheet is not enabled after a lightweight theme preview.");
+  // LightweightThemeManager.previewTheme(dummyLightweightTheme("preview1"));
+  // ok (!DevEdition.styleSheet, "The devedition stylesheet is not enabled after a second lightweight theme preview.");
+  // LightweightThemeManager.resetPreview();
+  // ok (DevEdition.styleSheet, "The devedition stylesheet is enabled again after resetting the preview.");
 
-  info ("Turning the pref on, then previewing a theme, turning it off and resetting the preview");
-  Services.prefs.setBoolPref(PREF_DEVEDITION_THEME, true);
-  ok (DevEdition.styleSheet, "The devedition stylesheet is enabled.");
-  LightweightThemeManager.previewTheme(dummyLightweightTheme("preview2"));
-  ok (!DevEdition.styleSheet, "The devedition stylesheet is not enabled after a lightweight theme preview.");
-  Services.prefs.setBoolPref(PREF_DEVEDITION_THEME, false);
-  ok (!DevEdition.styleSheet, "The devedition stylesheet is not enabled after pref is turned off.");
-  LightweightThemeManager.resetPreview();
-  ok (!DevEdition.styleSheet, "The devedition stylesheet is still disabled after resetting the preview.");
+  // info ("Turning the pref on, then previewing a theme, turning it off and resetting the preview");
+  // Services.prefs.setBoolPref(PREF_DEVEDITION_THEME, true);
+  // ok (DevEdition.styleSheet, "The devedition stylesheet is enabled.");
+  // LightweightThemeManager.previewTheme(dummyLightweightTheme("preview2"));
+  // ok (!DevEdition.styleSheet, "The devedition stylesheet is not enabled after a lightweight theme preview.");
+  // Services.prefs.setBoolPref(PREF_DEVEDITION_THEME, false);
+  // ok (!DevEdition.styleSheet, "The devedition stylesheet is not enabled after pref is turned off.");
+  // LightweightThemeManager.resetPreview();
+  // ok (!DevEdition.styleSheet, "The devedition stylesheet is still disabled after resetting the preview.");
 
-  info ("Turning the pref on, then previewing the default theme, turning it off and resetting the preview");
-  Services.prefs.setBoolPref(PREF_DEVEDITION_THEME, true);
-  ok (DevEdition.styleSheet, "The devedition stylesheet is enabled.");
-  LightweightThemeManager.previewTheme(dummyLightweightTheme("{972ce4c6-7e08-4474-a285-3208198ce6fd}"));
-  ok (DevEdition.styleSheet, "The devedition stylesheet is still enabled after the default theme is applied.");
-  LightweightThemeManager.resetPreview();
-  ok (DevEdition.styleSheet, "The devedition stylesheet is still enabled after resetting the preview.");
+  // info ("Turning the pref on, then previewing the default theme, turning it off and resetting the preview");
+  // Services.prefs.setBoolPref(PREF_DEVEDITION_THEME, true);
+  // ok (DevEdition.styleSheet, "The devedition stylesheet is enabled.");
+  // LightweightThemeManager.previewTheme(dummyLightweightTheme("{972ce4c6-7e08-4474-a285-3208198ce6fd}"));
+  // ok (DevEdition.styleSheet, "The devedition stylesheet is still enabled after the default theme is applied.");
+  // LightweightThemeManager.resetPreview();
+  // ok (DevEdition.styleSheet, "The devedition stylesheet is still enabled after resetting the preview.");
 }
