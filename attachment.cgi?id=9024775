# HG changeset patch
# User Victor Porof <vporof@mozilla.com>
# Date 1541071118 -3600
#      Thu Nov 01 12:18:38 2018 +0100
# Node ID 89c7eca45f904fea4720dc272125223f18bd5ede
# Parent  05331fb8f5338974b913217bc67815df25a32e86
Bug 1503827 - Migrate the treebody binding into a custom element, r=bgrins

diff --git a/toolkit/content/customElements.js b/toolkit/content/customElements.js
--- a/toolkit/content/customElements.js
+++ b/toolkit/content/customElements.js
@@ -295,17 +295,18 @@ const isDummyDocument = document.documen
 if (!isDummyDocument) {
   for (let script of [
     "chrome://global/content/elements/general.js",
     "chrome://global/content/elements/notificationbox.js",
     "chrome://global/content/elements/progressmeter.js",
     "chrome://global/content/elements/radio.js",
     "chrome://global/content/elements/textbox.js",
     "chrome://global/content/elements/tabbox.js",
-    "chrome://global/content/elements/tree.js",
+    "chrome://global/content/elements/treecol.js",
+    "chrome://global/content/elements/treechildren.js",
   ]) {
     Services.scriptloader.loadSubScript(script, window);
   }
 
   for (let [tag, script] of [
     ["findbar", "chrome://global/content/elements/findbar.js"],
     ["stringbundle", "chrome://global/content/elements/stringbundle.js"],
     ["printpreview-toolbar", "chrome://global/content/printPreviewToolbar.js"],
diff --git a/toolkit/content/jar.mn b/toolkit/content/jar.mn
--- a/toolkit/content/jar.mn
+++ b/toolkit/content/jar.mn
@@ -99,14 +99,15 @@ toolkit.jar:
    content/global/elements/general.js          (widgets/general.js)
    content/global/elements/notificationbox.js  (widgets/notificationbox.js)
    content/global/elements/progressmeter.js    (widgets/progressmeter.js)
    content/global/elements/radio.js            (widgets/radio.js)
    content/global/elements/stringbundle.js     (widgets/stringbundle.js)
    content/global/elements/tabbox.js           (widgets/tabbox.js)
    content/global/elements/textbox.js          (widgets/textbox.js)
    content/global/elements/videocontrols.js    (widgets/videocontrols.js)
-   content/global/elements/tree.js             (widgets/tree.js)
+   content/global/elements/treecol.js          (widgets/treecol.js)
+   content/global/elements/treechildren.js     (widgets/treechildren.js)
 #ifdef XP_MACOSX
    content/global/macWindowMenu.js
 #endif
    content/global/gmp-sources/openh264.json    (gmp-sources/openh264.json)
    content/global/gmp-sources/widevinecdm.json (gmp-sources/widevinecdm.json)
diff --git a/toolkit/content/widgets/tree.xml b/toolkit/content/widgets/tree.xml
--- a/toolkit/content/widgets/tree.xml
+++ b/toolkit/content/widgets/tree.xml
@@ -967,167 +967,16 @@
           else if (event.detail == 0)
             tree.removeAttribute("hidevscroll");
           event.stopPropagation();
         ]]>
       </handler>
     </handlers>
   </binding>
 
-  <binding id="treebody" extends="chrome://global/content/bindings/general.xml#basecontrol">
-    <implementation>
-      <constructor>
-        if ("_ensureColumnOrder" in this.parentNode)
-          this.parentNode._ensureColumnOrder();
-      </constructor>
-
-      <field name="_lastSelectedRow">
-        -1
-      </field>
-    </implementation>
-    <handlers>
-      <!-- If there is no modifier key, we select on mousedown, not
-           click, so that drags work correctly. -->
-      <handler event="mousedown" clickcount="1">
-      <![CDATA[
-         if (this.parentNode.disabled)
-           return;
-         if (((!event.getModifierState("Accel") ||
-             !this.parentNode.pageUpOrDownMovesSelection) &&
-             !event.shiftKey && !event.metaKey) ||
-             this.parentNode.view.selection.single) {
-           var b = this.parentNode.treeBoxObject;
-           var cell = b.getCellAt(event.clientX, event.clientY);
-           var view = this.parentNode.view;
-
-           // save off the last selected row
-           this._lastSelectedRow = cell.row;
-
-           if (cell.row == -1)
-             return;
-
-           if (cell.childElt == "twisty")
-             return;
-
-           if (cell.col && event.button == 0) {
-             if (cell.col.cycler) {
-               view.cycleCell(cell.row, cell.col);
-               return;
-             } else if (cell.col.type == window.TreeColumn.TYPE_CHECKBOX) {
-               if (this.parentNode.editable && cell.col.editable &&
-                   view.isEditable(cell.row, cell.col)) {
-                 var value = view.getCellValue(cell.row, cell.col);
-                 value = value == "true" ? "false" : "true";
-                 view.setCellValue(cell.row, cell.col, value);
-                 return;
-               }
-             }
-           }
-
-           if (!view.selection.isSelected(cell.row)) {
-             view.selection.select(cell.row);
-             b.ensureRowIsVisible(cell.row);
-           }
-         }
-      ]]>
-      </handler>
-
-      <!-- On a click (up+down on the same item), deselect everything
-           except this item. -->
-      <handler event="click" button="0" clickcount="1">
-      <![CDATA[
-        if (this.parentNode.disabled)
-          return;
-        var b = this.parentNode.treeBoxObject;
-        var cell = b.getCellAt(event.clientX, event.clientY);
-        var view = this.parentNode.view;
-
-        if (cell.row == -1)
-          return;
-
-        if (cell.childElt == "twisty") {
-          if (view.selection.currentIndex >= 0 &&
-              view.isContainerOpen(cell.row)) {
-            var parentIndex = view.getParentIndex(view.selection.currentIndex);
-            while (parentIndex >= 0 && parentIndex != cell.row)
-              parentIndex = view.getParentIndex(parentIndex);
-            if (parentIndex == cell.row) {
-              var parentSelectable = true;
-              if (parentSelectable)
-                view.selection.select(parentIndex);
-            }
-          }
-          this.parentNode.changeOpenState(cell.row);
-          return;
-        }
-
-        if (!view.selection.single) {
-          var augment = event.getModifierState("Accel");
-          if (event.shiftKey) {
-            view.selection.rangedSelect(-1, cell.row, augment);
-            b.ensureRowIsVisible(cell.row);
-            return;
-          }
-          if (augment) {
-            view.selection.toggleSelect(cell.row);
-            b.ensureRowIsVisible(cell.row);
-            view.selection.currentIndex = cell.row;
-            return;
-          }
-        }
-
-        /* We want to deselect all the selected items except what was
-          clicked, UNLESS it was a right-click.  We have to do this
-          in click rather than mousedown so that you can drag a
-          selected group of items */
-
-        if (!cell.col) return;
-
-        // if the last row has changed in between the time we
-        // mousedown and the time we click, don't fire the select handler.
-        // see bug #92366
-        if (!cell.col.cycler && this._lastSelectedRow == cell.row &&
-            cell.col.type != window.TreeColumn.TYPE_CHECKBOX) {
-          view.selection.select(cell.row);
-          b.ensureRowIsVisible(cell.row);
-        }
-      ]]>
-      </handler>
-
-      <!-- double-click -->
-      <handler event="click" clickcount="2">
-      <![CDATA[
-        if (this.parentNode.disabled)
-          return;
-        var tbo = this.parentNode.treeBoxObject;
-        var view = this.parentNode.view;
-        var row = view.selection.currentIndex;
-
-        if (row == -1)
-          return;
-
-        var cell = tbo.getCellAt(event.clientX, event.clientY);
-
-        if (cell.childElt != "twisty") {
-          view.selection.currentColumn = cell.col;
-          this.parentNode.startEditing(row, cell.col);
-        }
-
-        if (this.parentNode._editingColumn || !view.isContainer(row))
-          return;
-
-        // Cyclers and twisties respond to single clicks, not double clicks
-        if (cell.col && !cell.col.cycler && cell.childElt != "twisty")
-          this.parentNode.changeOpenState(row);
-      ]]>
-      </handler>
-
-    </handlers>
-  </binding>
-
   <binding id="columnpicker" display="xul:button"
            extends="chrome://global/content/bindings/general.xml#basecontrol">
     <content>
       <xul:image class="tree-columnpicker-icon"/>
       <xul:menupopup anonid="popup">
         <xul:menuseparator anonid="menuseparator"/>
         <xul:menuitem anonid="menuitem" label="&restoreColumnOrder.label;"/>
       </xul:menupopup>
diff --git a/toolkit/content/widgets/treechildren.js b/toolkit/content/widgets/treechildren.js
new file mode 100644
--- /dev/null
+++ b/toolkit/content/widgets/treechildren.js
@@ -0,0 +1,165 @@
+/* This Source Code Form is subject to the terms of the Mozilla Public
+  * License, v. 2.0. If a copy of the MPL was not distributed with this
+  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */
+
+  "use strict";
+
+  // This is loaded into all XUL windows. Wrap in a block to prevent
+  // leaking to window scope.
+  {
+
+  class MozTreeChildren extends MozElements.BaseControl {
+    constructor() {
+      super();
+
+      /**
+       * If there is no modifier key, we select on mousedown, not
+       * click, so that drags work correctly.
+       */
+      this.addEventListener("mousedown", (event) => {
+        if (this.parentNode.disabled)
+          return;
+        if (((!event.getModifierState("Accel") ||
+              !this.parentNode.pageUpOrDownMovesSelection) &&
+            !event.shiftKey && !event.metaKey) ||
+          this.parentNode.view.selection.single) {
+          var b = this.parentNode.treeBoxObject;
+          var cell = b.getCellAt(event.clientX, event.clientY);
+          var view = this.parentNode.view;
+
+          // save off the last selected row
+          this._lastSelectedRow = cell.row;
+
+          if (cell.row == -1)
+            return;
+
+          if (cell.childElt == "twisty")
+            return;
+
+          if (cell.col && event.button == 0) {
+            if (cell.col.cycler) {
+              view.cycleCell(cell.row, cell.col);
+              return;
+            } else if (cell.col.type == window.TreeColumn.TYPE_CHECKBOX) {
+              if (this.parentNode.editable && cell.col.editable &&
+                view.isEditable(cell.row, cell.col)) {
+                var value = view.getCellValue(cell.row, cell.col);
+                value = value == "true" ? "false" : "true";
+                view.setCellValue(cell.row, cell.col, value);
+                return;
+              }
+            }
+          }
+
+          if (!view.selection.isSelected(cell.row)) {
+            view.selection.select(cell.row);
+            b.ensureRowIsVisible(cell.row);
+          }
+        }
+      });
+
+      /**
+       * On a click (up+down on the same item), deselect everything
+       * except this item.
+       */
+      this.addEventListener("click", (event) => {
+        if (event.button != 0) { return; }
+        if (this.parentNode.disabled)
+          return;
+        var b = this.parentNode.treeBoxObject;
+        var cell = b.getCellAt(event.clientX, event.clientY);
+        var view = this.parentNode.view;
+
+        if (cell.row == -1)
+          return;
+
+        if (cell.childElt == "twisty") {
+          if (view.selection.currentIndex >= 0 &&
+            view.isContainerOpen(cell.row)) {
+            var parentIndex = view.getParentIndex(view.selection.currentIndex);
+            while (parentIndex >= 0 && parentIndex != cell.row)
+              parentIndex = view.getParentIndex(parentIndex);
+            if (parentIndex == cell.row) {
+              var parentSelectable = true;
+              if (parentSelectable)
+                view.selection.select(parentIndex);
+            }
+          }
+          this.parentNode.changeOpenState(cell.row);
+          return;
+        }
+
+        if (!view.selection.single) {
+          var augment = event.getModifierState("Accel");
+          if (event.shiftKey) {
+            view.selection.rangedSelect(-1, cell.row, augment);
+            b.ensureRowIsVisible(cell.row);
+            return;
+          }
+          if (augment) {
+            view.selection.toggleSelect(cell.row);
+            b.ensureRowIsVisible(cell.row);
+            view.selection.currentIndex = cell.row;
+            return;
+          }
+        }
+
+        /* We want to deselect all the selected items except what was
+          clicked, UNLESS it was a right-click.  We have to do this
+          in click rather than mousedown so that you can drag a
+          selected group of items */
+
+        if (!cell.col) return;
+
+        // if the last row has changed in between the time we
+        // mousedown and the time we click, don't fire the select handler.
+        // see bug #92366
+        if (!cell.col.cycler && this._lastSelectedRow == cell.row &&
+          cell.col.type != window.TreeColumn.TYPE_CHECKBOX) {
+          view.selection.select(cell.row);
+          b.ensureRowIsVisible(cell.row);
+        }
+      });
+
+      /**
+       * double-click
+       */
+      this.addEventListener("dblclick", (event) => {
+        if (this.parentNode.disabled)
+          return;
+        var tbo = this.parentNode.treeBoxObject;
+        var view = this.parentNode.view;
+        var row = view.selection.currentIndex;
+
+        if (row == -1)
+          return;
+
+        var cell = tbo.getCellAt(event.clientX, event.clientY);
+
+        if (cell.childElt != "twisty") {
+          view.selection.currentColumn = cell.col;
+          this.parentNode.startEditing(row, cell.col);
+        }
+
+        if (this.parentNode._editingColumn || !view.isContainer(row))
+          return;
+
+        // Cyclers and twisties respond to single clicks, not double clicks
+        if (cell.col && !cell.col.cycler && cell.childElt != "twisty")
+          this.parentNode.changeOpenState(row);
+      });
+
+    }
+
+    connectedCallback() {
+      this._lastSelectedRow = -1;
+
+      if ("_ensureColumnOrder" in this.parentNode)
+        this.parentNode._ensureColumnOrder();
+
+    }
+  }
+
+  customElements.define("treechildren", MozTreeChildren);
+
+  }
diff --git a/toolkit/content/widgets/tree.js b/toolkit/content/widgets/treecol.js
rename from toolkit/content/widgets/tree.js
rename to toolkit/content/widgets/treecol.js
diff --git a/toolkit/content/xul.css b/toolkit/content/xul.css
--- a/toolkit/content/xul.css
+++ b/toolkit/content/xul.css
@@ -449,17 +449,16 @@ treecols {
 }
 
 treecol {
   -moz-box-ordinal-group: 2147483646;
 }
 
 tree > treechildren {
   display: -moz-box;
-  -moz-binding: url("chrome://global/content/bindings/tree.xml#treebody");
   -moz-user-select: none;
   -moz-box-flex: 1;
 }
 
 treerows {
   -moz-binding: url("chrome://global/content/bindings/tree.xml#treerows");
 }
 
