# HG changeset patch
# User Rob Campbell <rcampbell@mozilla.com>
# Date 1368462702 25200
# Node ID 1c5fddd64116afdb513313bed47fdefcec1eaf75
# Parent fd5133a30882d420161200ff9d260a197587b00d
Bug 862558 - Web Console should always be available / visible

diff --git a/browser/devtools/framework/toolbox.js b/browser/devtools/framework/toolbox.js
--- a/browser/devtools/framework/toolbox.js
+++ b/browser/devtools/framework/toolbox.js
@@ -42,17 +42,17 @@ loader.lazyGetter(this, "Requisition", (
   let {require} = Cu.import("resource://gre/modules/devtools/Require.jsm", {});
   Cu.import("resource://gre/modules/devtools/gcli.jsm", {});
   return require("gcli/cli").Requisition;
 });
 
 /**
  * A "Toolbox" is the component that holds all the tools for one specific
  * target. Visually, it's a document that includes the tools tabs and all
- * the iframes where the tool panels will be living in.
+ * the iframes where the tool panels reside.
  *
  * @param {object} target
  *        The object the toolbox is debugging.
  * @param {string} selectedTool
  *        Tool to select initially
  * @param {Toolbox.HostType} hostType
  *        Type of host that will host the toolbox (e.g. sidebar, window)
  */
@@ -403,19 +403,27 @@ Toolbox.prototype = {
       dockBox.appendChild(button);
     }
   },
 
   /**
    * Add tabs to the toolbox UI for registered tools
    */
   _buildTabs: function() {
-    for (let definition of gDevTools.getToolDefinitionArray()) {
+    let toolArray = gDevTools.getToolDefinitionArray().filter((def) => {
+      return true; //def.id != "webconsole";
+    });
+
+    for (let definition of toolArray) {
       this._buildTabForTool(definition);
     }
+
+    // // handle the Web Console differently.
+    // let webConsoleDefinition = gDevTools.getToolDefinitionMap().get("webconsole");
+    // this._buildWebConsole(webConsoleDefinition);
   },
 
   /**
    * Add buttons to the UI as specified in the devtools.window.toolbarSpec pref
    */
   _buildButtons: function() {
     if (!this.target.isLocalTab) {
       return;
@@ -567,26 +575,61 @@ Toolbox.prototype = {
     };
 
     iframe.addEventListener("DOMContentLoaded", onLoad, true);
     iframe.setAttribute("src", definition.url);
     return deferred.promise;
   },
 
   /**
+   * Build the WebConsole in a separate box. Because it's special.
+   * @param {string} consoleDefinition
+   *        the definition of the WebConsole tool.
+   */
+  _buildWebConsole: function TBOX_buildWebConsole(consoleDefinition) {
+    console.log("Brian");
+    if (!consoleDefinition.isTargetSupported(this._target)) {
+      return;
+    }
+
+    let id = consoleDefinition.id;
+
+    console.log("Brian2", id);
+    let button = this.doc.getElementById("toolbox-tab-" + id);
+    button.setAttribute("toolid", id);
+    button.setAttribute("tooltiptext", consoleDefinition.tooltip);
+    button.setAttribute("image", consoleDefinition.icon);
+
+    let key = this.doc.getElementById("toolbox-options-key");
+    key.addEventListener("command", function(toolId) {
+      this.toggleWebConsole("webconsole");
+    }.bind(this, id), true);
+
+    button.addEventListener("command", function () {
+      this.toggleWebConsole("webconsole");
+    }.bind(this));
+
+    this.doc.getElementById("toolbox-keyset").appendChild(key);
+  },
+
+  /**
    * Switch to the tool with the given id
    *
    * @param {string} id
    *        The id of the tool to switch to
    */
   selectTool: function(id) {
-    let selected = this.doc.querySelector(".devtools-tab[selected]");
-    if (selected) {
-      selected.removeAttribute("selected");
-    }
+
+    let selected = this.doc.querySelectorAll(".devtools-tab[selected]");
+    // for (button of sel)
+    Array.forEach(selected, (button) => {
+      if (button) { //} && button.getAttribute("toolid") != "webconsole") {
+        button.removeAttribute("selected");
+      }
+    });
 
     let tab = this.doc.getElementById("toolbox-tab-" + id);
     tab.setAttribute("selected", "true");
 
 
     if (this.currentToolId == id) {
       // re-focus tool to get key events again
       this.focusTool(id);
@@ -691,16 +734,83 @@ Toolbox.prototype = {
    *        The id of the tool to unhighlight
    */
   unhighlightTool: function(id) {
     let tab = this.doc.getElementById("toolbox-tab-" + id);
     tab && tab.classList.remove("highlighted");
   },
 
   /**
+   * Toggle the Web Console UI.
+   * XXX I hate these "toggle" methods. Should probably have an explicit
+   * show and hide pair.
+   */
+  toggleWebConsole: function TBOX_toggleWebConsole(id) {
+
+    console.log("HI!!");
+    let deferred = promise.defer();
+    let panel = this.doc.getElementById("toolbox-panel-" + id);
+    let button = this.doc.getElementById("toolbox-tab-" + id);
+    let splitter = this.doc.getElementById("toolbox-console-splitter");
+    let definition = gDevTools.getToolDefinitionMap().get(id);
+    panel.hidden = !panel.hidden;
+    splitter.hidden = !splitter.hidden;
+    if (panel.hidden) {
+      button.removeAttribute("selected");
+    } else {
+      button.setAttribute("selected", "true");
+    }
+
+    console.log("HI2!");
+    let iframe = this.doc.getElementById("toolbox-panel-iframe-" + id);
+    if (!iframe) {
+      iframe = this.doc.createElement("iframe");
+      iframe.className = "toolbox-panel-iframe";
+      iframe.id = "toolbox-panel-iframe-" + id;
+      iframe.setAttribute("flex", 1);
+      iframe.setAttribute("forceOwnRefreshDriver", "");
+      iframe.tooltip = "aHTMLTooltip";
+
+      let vbox = this.doc.getElementById("toolbox-panel-" + id);
+      vbox.appendChild(iframe);
+
+    console.log("HI3!", iframe);
+      let boundLoad = function() {
+        iframe.removeEventListener("DOMContentLoaded", boundLoad, true);
+
+    console.log("HI4!", iframe.contentWindow);
+        let built = definition.build(iframe.contentWindow, this);
+        promise.resolve(built).then(function(panel) {
+          this._toolPanels.set(id, panel);
+
+          this.emit(id + "-ready", panel);
+          this.emit("select", id);
+          this.emit(id + "-selected", panel);
+          gDevTools.emit(id + "-ready", this, panel);
+
+          deferred.resolve(panel);
+        }.bind(this));
+      }.bind(this);
+
+      iframe.addEventListener("DOMContentLoaded", boundLoad, true);
+      iframe.setAttribute("src", definition.url);
+    } else {
+      let panel = this._toolPanels.get(id);
+      // only emit 'select' event if the iframe has been loaded
+      if (panel) {
+        this.emit("select", id);
+        this.emit(id + "-selected", panel);
+        deferred.resolve(panel);
+      }
+    }
+
+    return deferred.promise;
+  },
+
+  /**
    * Raise the toolbox host.
    */
   raise: function() {
     this._host.raise();
   },
 
   /**
    * Refresh the host's title.
@@ -869,16 +979,18 @@ Toolbox.prototype = {
     if (typeof this._origAllowJavascript != "undefined") {
       let docShell = this._host.hostTab.linkedBrowser.docShell;
       docShell.allowJavascript = this._origAllowJavascript;
       this._origAllowJavascript = undefined;
     }
 
     let outstanding = [];
 
+    // this._toolPanels.delete("webconsole");
+    // let panels = this._toolPanels.filter((id) => { return id != "webconsole" });
     for (let [id, panel] of this._toolPanels) {
       try {
         outstanding.push(panel.destroy());
       } catch (e) {
         // We don't want to stop here if any panel fail to close.
         console.error(e);
       }
     }
diff --git a/browser/devtools/framework/toolbox.xul b/browser/devtools/framework/toolbox.xul
--- a/browser/devtools/framework/toolbox.xul
+++ b/browser/devtools/framework/toolbox.xul
@@ -54,25 +54,31 @@
 #ifdef XP_MACOSX
       <hbox id="toolbox-controls">
         <toolbarbutton id="toolbox-close"
                        class="devtools-closebutton"
                        tooltiptext="&toolboxCloseButton.tooltip;"/>
         <hbox id="toolbox-dock-buttons"/>
       </hbox>
 #endif
-      <hbox id="toolbox-tabs" flex="1">
-      </hbox>
+      <toolbarbutton id="toolbox-tab-webconsole"
+                     autocheck="false"
+                     class="command-button toolbox-tab devtools-tab"/>
+      <hbox id="toolbox-tabs" flex="1"/>
       <hbox id="toolbox-buttons" pack="end"/>
 #ifndef XP_MACOSX
       <vbox id="toolbox-controls-separator"/>
       <hbox id="toolbox-controls">
         <hbox id="toolbox-dock-buttons"/>
         <toolbarbutton id="toolbox-close"
                        class="devtools-closebutton"
                        tooltiptext="&toolboxCloseButton.tooltip;"/>
       </hbox>
 #endif
     </toolbar>
     <deck id="toolbox-deck" flex="1">
     </deck>
+    <splitter id="toolbox-console-splitter" class="devtools-horizontal-splitter" collapse="before" hidden="true"/>
+     <hbox id="toolbox-panel-webconsole" flex="1">
+        hi
+     </hbox>
   </notificationbox>
 </window>
