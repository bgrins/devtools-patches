# HG changeset patch
# User Brian Grinstead <bgrinstead@mozilla.com>
# Parent  ef8d16ae0d0d5d5dc09c7a0d2463bde16b31b174
Bug 1326937 - Provide HTML page when running new console frontend

diff --git a/devtools/client/definitions.js b/devtools/client/definitions.js
--- a/devtools/client/definitions.js
+++ b/devtools/client/definitions.js
@@ -97,17 +97,16 @@ Tools.inspector = {
 Tools.webConsole = {
   id: "webconsole",
   key: l10n("cmd.commandkey"),
   accesskey: l10n("webConsoleCmd.accesskey"),
   modifiers: Services.appinfo.OS == "Darwin" ? "accel,alt" : "accel,shift",
   ordinal: 2,
   icon: "chrome://devtools/skin/images/tool-webconsole.svg",
   invertIconForDarkTheme: true,
-  url: "chrome://devtools/content/webconsole/webconsole.xul",
   label: l10n("ToolboxTabWebconsole.label"),
   menuLabel: l10n("MenuWebconsole.label"),
   panelLabel: l10n("ToolboxWebConsole.panelLabel"),
   get tooltip() {
     return l10n("ToolboxWebconsole.tooltip2",
     (osString == "Darwin" ? "Cmd+Opt+" : "Ctrl+Shift+") + this.key);
   },
   inMenu: true,
@@ -127,16 +126,31 @@ Tools.webConsole = {
     return true;
   },
 
   build: function (iframeWindow, toolbox) {
     return new WebConsolePanel(iframeWindow, toolbox);
   }
 };
 
+function switchWebconsole() {
+  if (Services.prefs.getBoolPref("devtools.webconsole.new-frontend-enabled")) {
+    Tools.webConsole.url = "chrome://devtools/content/webconsole/webconsole.html";
+  } else {
+    Tools.webConsole.url = "chrome://devtools/content/webconsole/webconsole.xul";
+  }
+}
+switchWebconsole();
+
+Services.prefs.addObserver(
+  "devtools.devtools.webconsole.new-frontend-enabled",
+  { observe: switchWebconsole }
+);
+
+
 Tools.jsdebugger = {
   id: "jsdebugger",
   key: l10n("debuggerMenu.commandkey"),
   accesskey: l10n("debuggerMenu.accesskey"),
   modifiers: osString == "Darwin" ? "accel,alt" : "accel,shift",
   ordinal: 3,
   icon: "chrome://devtools/skin/images/tool-debugger.svg",
   invertIconForDarkTheme: true,
diff --git a/devtools/client/jar.mn b/devtools/client/jar.mn
--- a/devtools/client/jar.mn
+++ b/devtools/client/jar.mn
@@ -6,16 +6,17 @@ devtools.jar:
 %   content devtools %content/
     content/shared/vendor/d3.js (shared/vendor/d3.js)
     content/shared/vendor/dagre-d3.js (shared/vendor/dagre-d3.js)
     content/shared/widgets/widgets.css (shared/widgets/widgets.css)
     content/shared/widgets/VariablesView.xul (shared/widgets/VariablesView.xul)
     content/projecteditor/chrome/content/projecteditor.xul (projecteditor/chrome/content/projecteditor.xul)
     content/projecteditor/lib/helpers/readdir.js (projecteditor/lib/helpers/readdir.js)
     content/netmonitor/index.html (netmonitor/index.html)
+    content/webconsole/webconsole.xhtml (webconsole/webconsole.xhtml)
     content/webconsole/webconsole.xul (webconsole/webconsole.xul)
 *   content/scratchpad/scratchpad.xul (scratchpad/scratchpad.xul)
     content/scratchpad/scratchpad.js (scratchpad/scratchpad.js)
     content/shared/splitview.css (shared/splitview.css)
     content/shared/theme-switching.js (shared/theme-switching.js)
     content/shared/frame-script-utils.js (shared/frame-script-utils.js)
     content/styleeditor/styleeditor.xul (styleeditor/styleeditor.xul)
     content/storage/storage.xul (storage/storage.xul)
diff --git a/devtools/client/webconsole/webconsole.xhtml b/devtools/client/webconsole/webconsole.xhtml
new file mode 100644
--- /dev/null
+++ b/devtools/client/webconsole/webconsole.xhtml
@@ -0,0 +1,63 @@
+<!-- This Source Code Form is subject to the terms of the Mozilla Public
+   - License, v. 2.0. If a copy of the MPL was not distributed with this
+   - file, You can obtain one at http://mozilla.org/MPL/2.0/. -->
+<!DOCTYPE html>
+<html dir="">
+  <head>
+    <link rel="stylesheet" href="chrome://devtools/content/shared/widgets/widgets.css"/>
+    <link rel="stylesheet" href="chrome://devtools/skin/widgets.css"/>
+    <link rel="stylesheet" href="chrome://devtools/skin/netmonitor.css"/>
+    <script src="chrome://devtools/content/shared/theme-switching.js"></script>
+  </head>
+  <body class="theme-sidebar" role="application">
+    <div id="mount"></div>
+    <script>
+      "use strict";
+
+      const { BrowserLoader } = Components.utils.import("resource://devtools/client/shared/browser-loader.js", {});
+      const require = window.windowRequire = BrowserLoader({
+        baseURI: "resource://devtools/client/webconsole/",
+        window,
+      }).require;
+
+      const EventEmitter = require("devtools/shared/event-emitter");
+      const { createFactory } = require("devtools/client/shared/vendor/react");
+      const { render, unmountComponentAtNode } = require("devtools/client/shared/vendor/react-dom");
+      const Provider = createFactory(require("devtools/client/shared/vendor/react-redux").Provider);
+      const { bindActionCreators } = require("devtools/client/shared/vendor/redux");
+      const React = require("devtools/client/shared/vendor/react");
+      const ReactDOM = require("devtools/client/shared/vendor/react-dom");
+      const FrameView = this.React.createFactory(require("devtools/client/shared/components/frame"));
+      const StackTraceView = this.React.createFactory(require("devtools/client/shared/components/stack-trace");
+
+
+
+      // const { configureStore } = require("./src/utils/create-store");
+      // const store = window.gStore = configureStore();
+      // const actions = bindActionCreators(require("./src/actions/index"), store.dispatch);
+      // const { NetMonitorController } = require("./src/netmonitor-controller");
+
+      // Inject EventEmitter into global window.
+      EventEmitter.decorate(window);
+
+      window.Netmonitor = {
+        bootstrap({ toolbox }) {
+          this.mount = document.querySelector("#mount");
+          const App = createFactory(require("./src/components/app"));
+          render(Provider({ store }, App()), this.mount);
+          return NetMonitorController.startupNetMonitor({
+            tabConnection: {
+              tabTarget: toolbox.target,
+            },
+            toolbox,
+          }, actions);
+        },
+
+        destroy() {
+          unmountComponentAtNode(this.mount);
+          return NetMonitorController.shutdownNetMonitor();
+        }
+      };
+    </script>
+  </body>
+</html>
