# HG changeset patch
# User Jan Keromnes <janx@linux.com>

Bug 1150717 - Implement "Copy URL Parameters" context menu item. r=bgrins

diff --git a/browser/devtools/netmonitor/netmonitor-view.js b/browser/devtools/netmonitor/netmonitor-view.js
index 9dfef04..b6ba4a3 100644
--- a/browser/devtools/netmonitor/netmonitor-view.js
+++ b/browser/devtools/netmonitor/netmonitor-view.js
@@ -559,16 +559,24 @@ RequestsMenuView.prototype = Heritage.extend(WidgetMethods, {
    * Copy the request url from the currently selected item.
    */
   copyUrl: function() {
     let selected = this.selectedItem.attachment;
     clipboardHelper.copyString(selected.url, document);
   },
 
   /**
+   * Copy the request url query string from the currently selected item.
+   */
+  copyUrlParams: function() {
+    let selected = this.selectedItem.attachment;
+    clipboardHelper.copyString(nsIURL(selected.url).query, document);
+  },
+
+  /**
    * Copy a cURL command from the currently selected item.
    */
   copyAsCurl: function() {
     let selected = this.selectedItem.attachment;
 
     Task.spawn(function*() {
       // Create a sanitized object for the Curl command generator.
       let data = {
@@ -1792,16 +1800,19 @@ RequestsMenuView.prototype = Heritage.extend(WidgetMethods, {
 
     let resendElement = $("#request-menu-context-resend");
     resendElement.hidden = !NetMonitorController.supportsCustomRequest ||
       !selectedItem || selectedItem.attachment.isCustom;
 
     let copyUrlElement = $("#request-menu-context-copy-url");
     copyUrlElement.hidden = !selectedItem;
 
+    let copyUrlParamsElement = $("#request-menu-context-copy-url-params");
+    copyUrlParamsElement.hidden = !selectedItem || !nsIURL(selectedItem.attachment.url).query;
+
     let copyAsCurlElement = $("#request-menu-context-copy-as-curl");
     copyAsCurlElement.hidden = !selectedItem || !selectedItem.attachment.responseContent;
 
     let copyResponse = $("#request-menu-context-copy-response");
     copyResponse.hidden = !selectedItem ||
       !selectedItem.attachment.responseContent ||
       !selectedItem.attachment.responseContent.content.text ||
       selectedItem.attachment.responseContent.content.text.length === 0;
diff --git a/browser/devtools/netmonitor/netmonitor.xul b/browser/devtools/netmonitor/netmonitor.xul
index f7f1fe5..42bdab9 100644
--- a/browser/devtools/netmonitor/netmonitor.xul
+++ b/browser/devtools/netmonitor/netmonitor.xul
@@ -26,16 +26,20 @@
   <popupset id="networkPopupSet">
     <menupopup id="network-request-popup">
       <menuitem id="request-menu-context-newtab"
                 label="&netmonitorUI.context.newTab;"
                 accesskey="&netmonitorUI.context.newTab.accesskey;"/>
       <menuitem id="request-menu-context-copy-url"
                 label="&netmonitorUI.context.copyUrl;"
                 accesskey="&netmonitorUI.context.copyUrl.accesskey;"/>
+      <menuitem id="request-menu-context-copy-url-params"
+                label="&netmonitorUI.context.copyUrlParams;"
+                accesskey="&netmonitorUI.context.copyUrlParams.accesskey;"
+                oncommand="NetMonitorView.RequestsMenu.copyUrlParams();"/>
       <menuitem id="request-menu-context-copy-as-curl"
                 label="&netmonitorUI.context.copyAsCurl;"
                 oncommand="NetMonitorView.RequestsMenu.copyAsCurl();"/>
       <menuitem id="request-menu-context-copy-response"
                 label="&netmonitorUI.context.copyResponse;"
                 accesskey="&netmonitorUI.context.copyResponse.accesskey;"/>
       <menuitem id="request-menu-context-copy-image-as-data-uri"
                 label="&netmonitorUI.context.copyImageAsDataUri;"
diff --git a/browser/devtools/netmonitor/test/browser.ini b/browser/devtools/netmonitor/test/browser.ini
index e78e679..cf78287 100644
--- a/browser/devtools/netmonitor/test/browser.ini
+++ b/browser/devtools/netmonitor/test/browser.ini
@@ -47,16 +47,17 @@ skip-if= buildapp == 'mulet'
 [browser_net_charts-06.js]
 [browser_net_charts-07.js]
 [browser_net_clear.js]
 [browser_net_complex-params.js]
 [browser_net_content-type.js]
 [browser_net_curl-utils.js]
 [browser_net_copy_image_as_data_uri.js]
 [browser_net_copy_url.js]
+[browser_net_copy_params.js]
 [browser_net_copy_response.js]
 [browser_net_copy_headers.js]
 [browser_net_copy_as_curl.js]
 skip-if = e10s # Bug 1091596
 [browser_net_cyrillic-01.js]
 [browser_net_cyrillic-02.js]
 [browser_net_details-no-duplicated-content.js]
 [browser_net_filter-01.js]
diff --git a/browser/devtools/netmonitor/test/browser_net_copy_params.js b/browser/devtools/netmonitor/test/browser_net_copy_params.js
new file mode 100644
index 0000000..400eb03
--- /dev/null
+++ b/browser/devtools/netmonitor/test/browser_net_copy_params.js
@@ -0,0 +1,52 @@
+/* Any copyright is dedicated to the Public Domain.
+   http://creativecommons.org/publicdomain/zero/1.0/ */
+
+/**
+ * Tests whether copying a request item's parameters works.
+ */
+
+function test() {
+  initNetMonitor(PARAMS_URL).then(([aTab, aDebuggee, aMonitor]) => {
+    info("Starting test... ");
+
+    let { document, L10N, EVENTS, Editor, NetMonitorView } = aMonitor.panelWin;
+    let { RequestsMenu, NetworkDetails } = NetMonitorView;
+
+    RequestsMenu.lazyUpdate = false;
+
+    Task.spawn(function () {
+      yield waitForNetworkEvents(aMonitor, 0, 6);
+
+      RequestsMenu.selectedItem = RequestsMenu.getItemAtIndex(0);
+      yield testCopyUrlParams('a');
+
+      RequestsMenu.selectedItem = RequestsMenu.getItemAtIndex(1);
+      yield testCopyUrlParams('a=b');
+
+      RequestsMenu.selectedItem = RequestsMenu.getItemAtIndex(2);
+      yield testCopyUrlParams('a=b');
+
+      RequestsMenu.selectedItem = RequestsMenu.getItemAtIndex(3);
+      yield testCopyUrlParams('a');
+
+      RequestsMenu.selectedItem = RequestsMenu.getItemAtIndex(4);
+      yield testCopyUrlParams('a=b');
+
+      RequestsMenu.selectedItem = RequestsMenu.getItemAtIndex(5);
+      yield testCopyUrlParams('a=b');
+
+      yield teardown(aMonitor);
+      finish();
+    });
+
+    function testCopyUrlParams(aQueryString) {
+      RequestsMenu.copyUrlParams();
+
+      is(SpecialPowers.getClipboardData("text/unicode"), aQueryString,
+        "The url query string copied from the selected item is correct.");
+    }
+
+    aDebuggee.performRequests();
+  });
+}
+
diff --git a/browser/locales/en-US/chrome/browser/devtools/netmonitor.dtd b/browser/locales/en-US/chrome/browser/devtools/netmonitor.dtd
index c496b72..0adc285 100644
--- a/browser/locales/en-US/chrome/browser/devtools/netmonitor.dtd
+++ b/browser/locales/en-US/chrome/browser/devtools/netmonitor.dtd
@@ -259,16 +259,24 @@
 <!-- LOCALIZATION NOTE (netmonitorUI.context.copyUrl): This is the label displayed
   -  on the context menu that copies the selected request's url -->
 <!ENTITY netmonitorUI.context.copyUrl     "Copy URL">
 
 <!-- LOCALIZATION NOTE (netmonitorUI.context.copyUrl.accesskey): This is the access key
   -  for the Copy URL menu item displayed in the context menu for a request -->
 <!ENTITY netmonitorUI.context.copyUrl.accesskey "C">
 
+<!-- LOCALIZATION NOTE (netmonitorUI.context.copyUrlParams): This is the label displayed
+  -  on the context menu that copies the selected request's url parameters -->
+<!ENTITY netmonitorUI.context.copyUrlParams     "Copy URL Parameters">
+
+<!-- LOCALIZATION NOTE (netmonitorUI.context.copyUrlParams.accesskey): This is the access key
+  -  for the Copy URL Parameters menu item displayed in the context menu for a request -->
+<!ENTITY netmonitorUI.context.copyUrlParams.accesskey "P">
+
 <!-- LOCALIZATION NOTE (netmonitorUI.context.copyAsCurl): This is the label displayed
   -  on the context menu that copies the selected request as a cURL command.
   -  The capitalization is part of the official name and should be used throughout all languages.
   -  http://en.wikipedia.org/wiki/CURL -->
 <!ENTITY netmonitorUI.context.copyAsCurl    "Copy as cURL">
 
 <!-- LOCALIZATION NOTE (netmonitorUI.context.copyImageAsDataUri): This is the label displayed
   -  on the context menu that copies the selected image as data uri -->
