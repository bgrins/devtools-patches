# HG changeset patch
# Parent 6175ae0cde08f2bfad54ef59b356e727aaf78227
# User Paul Rouget <paul@mozilla.com>
Bug 987089 - Land Itchpad in browser/devtools.  Part 2 - integrate with webide;r=jryans

diff --git a/browser/devtools/webide/content/webide.js b/browser/devtools/webide/content/webide.js
--- a/browser/devtools/webide/content/webide.js
+++ b/browser/devtools/webide/content/webide.js
@@ -9,16 +9,17 @@ const Ci = Components.interfaces;
 Cu.import("resource:///modules/devtools/gDevTools.jsm");
 
 const {devtools} = Cu.import("resource://gre/modules/devtools/Loader.jsm", {});
 const {require} = devtools;
 const {Services} = Cu.import("resource://gre/modules/Services.jsm");
 const {AppProjects} = require("devtools/app-manager/app-projects");
 const {Connection} = require("devtools/client/connection-manager");
 const {AppManager} = require("devtools/app-manager");
+const Itchpad = require("itchpad/itchpad");
 
 const Strings = Services.strings.createBundle("chrome://webide/content/webide.properties");
 
 const HTML = "http://www.w3.org/1999/xhtml";
 
 window.addEventListener("load", function onLoad() {
   window.removeEventListener("load", onLoad);
   UI.init();
@@ -256,32 +257,75 @@ let UI = {
       imageNode.removeAttribute("src");
     } else {
       buttonNode.classList.remove("no-project");
       labelNode.setAttribute("value", project.name);
       imageNode.setAttribute("src", project.icon);
     }
   },
 
-  // details.xhtml
+  // Itchpad & details screen
+
+  getItchpad: function() {
+    if (this.itchpad) {
+      return this.itchpad.loaded;
+    }
+
+    let itchpadIframe = document.querySelector("#itchpad");
+    this.itchpad = Itchpad.Itchpad(itchpadIframe);
+    this.itchpad.on("onEditorSave", (editor, resource) => {
+      AppManager.validateProject(AppManager.selectedProject);
+    });
+    return this.itchpad.loaded;
+  },
+
+  isItchpadEnabled: function() {
+    return Services.prefs.getBoolPref("devtools.webide.showItchpad");
+  },
 
   openProject: function() {
-    let details = document.querySelector("#details");
+    let detailsIframe = document.querySelector("#details");
+    let itchpadIframe = document.querySelector("#itchpad");
+
     let project = AppManager.selectedProject;
 
+    // Nothing to show
+
     if (!project) {
-      details.setAttribute("hidden", "true");
+      detailsIframe.setAttribute("hidden", "true");
+      itchpadIframe.setAttribute("hidden", "true");
+      document.commandDispatcher.focusedElement = document.documentElement;
       return;
     }
 
+    // Show only the details screen
+
+    if (project.type != "packaged" || !this.isItchpadEnabled()) {
+      detailsIframe.removeAttribute("hidden");
+      itchpadIframe.setAttribute("hidden", "true");
+      document.commandDispatcher.focusedElement = document.documentElement;
+      return;
+    }
+
+    // Show Itchpad
+
+    detailsIframe.setAttribute("hidden", "true");
+    itchpadIframe.removeAttribute("hidden");
+
+    this.getItchpad().then((itchpad) => {
+      itchpad.setProjectToAppPath(project.location, {
+        name: project.name,
+        iconUrl: project.icon,
+        projectOverviewURL: "chrome://webide/content/details.xhtml"
+      });
+    }, UI.console.error);
+
     if (project.location) {
       Services.prefs.setCharPref("devtools.webide.lastprojectlocation", project.location);
     }
-
-    details.removeAttribute("hidden");
   },
 
   /********** COMMANDS **********/
 
   updateCommands: function() {
 
     if (document.querySelector("window").classList.contains("busy")) {
       document.querySelector("#cmd_newApp").setAttribute("disabled", "true");
@@ -725,11 +769,12 @@ let Cmds = {
     }
   },
 
   removeProject: function() {
     AppManager.removeSelectedProject();
   },
 
   toggleEditors: function() {
-    // Toggle Itchpad
+    Services.prefs.setBoolPref("devtools.webide.showItchpad", !UI.isItchpadEnabled());
+    UI.openProject();
   },
 }
diff --git a/browser/devtools/webide/content/webide.xul b/browser/devtools/webide/content/webide.xul
--- a/browser/devtools/webide/content/webide.xul
+++ b/browser/devtools/webide/content/webide.xul
@@ -145,16 +145,17 @@
         </vbox>
       </vbox>
     </panel>
 
   </popupset>
 
   <vbox flex="1" id="body">
     <iframe id="details" flex="1" hidden="true" src="details.xhtml"/>
+    <iframe id="itchpad" flex="1" hidden="true"/>
   </vbox>
 
   <splitter hidden="true" class="devtools-horizontal-splitter" orient="vertical"/>
 
   <!-- toolbox iframe will be inserted here -->
 
   <html:div id="logs-container">
     <html:pre id="logs"></html:pre>
diff --git a/browser/devtools/webide/webide-prefs.js b/browser/devtools/webide/webide-prefs.js
--- a/browser/devtools/webide/webide-prefs.js
+++ b/browser/devtools/webide/webide-prefs.js
@@ -1,6 +1,7 @@
 # -*- Mode: JavaScript; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 2 -*-
 # This Source Code Form is subject to the terms of the Mozilla Public
 # License, v. 2.0. If a copy of the MPL was not distributed with this
 # file, You can obtain one at http://mozilla.org/MPL/2.0/.
 
+pref("devtools.webide.showItchpad", true);
 pref("devtools.webide.templatesURL", "http://fixme/");
