# HG changeset patch
# User Brian Grinstead <bgrinstead@mozilla.com>
# Date 1540415513 25200
#      Wed Oct 24 14:11:53 2018 -0700
# Node ID f0dcc8f39bce72c745c6bc3d5f8015af1e646d64
# Parent  ff3ed362e82fae365afc440ccc3b662bcfcd0435
Bug 1501845 - Load customElements.js inside migration.xul to fix migration UI when running with commandline;r=paolo

This is another case of a document getting loaded before MainProcessSingleton,
similar to profile manager. There's another wrinkle here, though. The migration
UI can also be loaded _after_ startup (through Bookmarks manager), which is
actually the primary way this UI is surfaced. So we need to also handle customElements.js
getting loaded twice into the same window to avoid attempting to redefine everything.

Differential Revision: https://phabricator.services.mozilla.com/D9713

diff --git a/browser/components/migration/content/migration.xul b/browser/components/migration/content/migration.xul
--- a/browser/components/migration/content/migration.xul
+++ b/browser/components/migration/content/migration.xul
@@ -13,16 +13,17 @@
         title="&migrationWizard.title;"
         onload="MigrationWizard.init()"
         onunload="MigrationWizard.uninit()"
         style="width: 40em;"
         buttons="accept,cancel"
         branded="true"
         onwizardcancel="return MigrationWizard.onWizardCancel();">
 
+  <script type="application/javascript" src="chrome://global/content/customElements.js"/>
   <script type="application/javascript" src="chrome://browser/content/migration/migration.js"/>
 
   <wizardpage id="importSource" pageid="importSource" next="selectProfile"
               label="&importSource.title;"
               onpageadvanced="return MigrationWizard.onImportSourcePageAdvanced();">
 #ifdef XP_WIN
     <description id="importAll" control="importSourceGroup">&importFrom.label;</description>
 #else
diff --git a/toolkit/content/customElements.js b/toolkit/content/customElements.js
--- a/toolkit/content/customElements.js
+++ b/toolkit/content/customElements.js
@@ -3,17 +3,24 @@
  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */
 
 /* globals MozQueryInterface */
 
 "use strict";
 
 // This is loaded into chrome windows with the subscript loader. Wrap in
 // a block to prevent accidentally leaking globals onto `window`.
-{
+(() => {
+
+// Handle customElements.js being loaded as a script in addition to the subscriptLoader
+// from MainProcessSingleton, to handle pages that can open both before and after
+// MainProcessSingleton starts. See Bug 1501845.
+if (window.MozXULElement) {
+  return;
+}
 
 ChromeUtils.import("resource://gre/modules/Services.jsm");
 ChromeUtils.import("resource://gre/modules/AppConstants.jsm");
 
 // The listener of DOMContentLoaded must be set on window, rather than
 // document, because the window can go away before the event is fired.
 // In that case, we don't want to initialize anything, otherwise we
 // may be leaking things because they will never be destroyed after.
@@ -261,9 +268,9 @@ if (!isDummyDocument) {
     ["printpreview-toolbar", "chrome://global/content/printPreviewToolbar.js"],
     ["editor", "chrome://global/content/elements/editor.js"],
   ]) {
     customElements.setElementCreationCallback(tag, () => {
       Services.scriptloader.loadSubScript(script, window);
     });
   }
 }
-}
+})();
