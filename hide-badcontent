# HG changeset patch
# User Brian Grinstead <bgrinstead@mozilla.com>
# Parent  1c6df58616257675c80e743c7161bbb33155e458
Bug 1186925 - Convert tests using bad-content notification to use gIdentityHandle

diff --git a/browser/base/content/browser.js b/browser/base/content/browser.js
--- a/browser/base/content/browser.js
+++ b/browser/base/content/browser.js
@@ -6699,16 +6699,21 @@ var gIdentityHandler = {
     delete this._permissionsContainer;
     return this._permissionsContainer = document.getElementById("identity-popup-permissions");
   },
   get _permissionList () {
     delete this._permissionList;
     return this._permissionList = document.getElementById("identity-popup-permission-list");
   },
 
+  get isMixedContentBlocked() {
+    console.log("Checking isMixedContentBlocked", this._secState, this._secState == "active-blocked");
+    return this._secState == "active-blocked";
+  },
+
   /**
    * Rebuild cache of the elements that may or may not exist depending
    * on whether there's a location bar.
    */
   _cacheElements : function() {
     delete this._identityBox;
     delete this._identityIcons;
     delete this._identityIconLabel;
diff --git a/browser/base/content/test/general/browser.ini b/browser/base/content/test/general/browser.ini
--- a/browser/base/content/test/general/browser.ini
+++ b/browser/base/content/test/general/browser.ini
@@ -254,22 +254,25 @@ skip-if = os == "mac" # Bug 1102331 - do
 [browser_bug734076.js]
 [browser_bug735471.js]
 [browser_bug749738.js]
 [browser_bug763468_perwindowpb.js]
 [browser_bug767836_perwindowpb.js]
 [browser_bug783614.js]
 [browser_bug817947.js]
 [browser_bug822367.js]
+tags = mcb
 [browser_bug832435.js]
 [browser_bug839103.js]
 [browser_bug880101.js]
 [browser_bug882977.js]
 [browser_bug902156.js]
+tags = mcb
 [browser_bug906190.js]
+tags = mcb
 skip-if = buildapp == "mulet" || e10s # Bug 1093642 - test manipulates content and relies on content focus
 [browser_mixedContentFromOnunload.js]
 [browser_bug970746.js]
 [browser_bug1015721.js]
 skip-if = os == 'win' || e10s # Bug 1159268 - Need a content-process safe version of synthesizeWheel
 [browser_bug1064280_changeUrlInPinnedTab.js]
 [browser_bug1070778.js]
 [browser_canonizeURL.js]
@@ -323,16 +326,17 @@ skip-if = toolkit == "windows" # Disable
 skip-if = os == "linux" # Linux: Intermittent failures, bug 917535
 [browser_locationBarExternalLoad.js]
 [browser_menuButtonFitts.js]
 skip-if = os != "win" # The Fitts Law menu button is only supported on Windows (bug 969376)
 [browser_middleMouse_noJSPaste.js]
 [browser_minimize.js]
 skip-if = e10s # Bug 1100664 - test directly access content docShells (TypeError: gBrowser.docShell is null)
 [browser_mixedcontent_securityflags.js]
+tags = mcb
 [browser_notification_tab_switching.js]
 skip-if = buildapp == 'mulet' || e10s # Bug 1100662 - content access causing uncaught exception - Error: cannot ipc non-cpow object at chrome://mochitests/content/browser/browser/base/content/test/general/browser_notification_tab_switching.js:32 (or in RemoteAddonsChild.jsm)
 [browser_offlineQuotaNotification.js]
 skip-if = buildapp == 'mulet' || e10s # Bug 1093603 - test breaks with PopupNotifications.panel.firstElementChild is null
 [browser_overflowScroll.js]
 [browser_pageInfo.js]
 skip-if = buildapp == 'mulet'
 [browser_page_style_menu.js]
@@ -481,24 +485,26 @@ skip-if = e10s # Bug 1094240 - has findb
 [browser_no_mcb_on_http_site.js]
 [browser_bug1104165-switchtab-decodeuri.js]
 [browser_bug1003461-switchtab-override.js]
 [browser_bug1024133-switchtab-override-keynav.js]
 [browser_bug1025195_switchToTabHavingURI_aOpenParams.js]
 [browser_addCertException.js]
 skip-if = e10s # Bug 1100687 - test directly manipulates content (content.document.getElementById)
 [browser_bug1045809.js]
+tags = mcb
 [browser_e10s_switchbrowser.js]
 [browser_e10s_about_process.js]
 [browser_e10s_chrome_process.js]
 [browser_e10s_javascript.js]
 [browser_blockHPKP.js]
 tags = psm
 skip-if = e10s # bug 1100687 - test directly manipulates content (content.document.getElementById)
 [browser_mcb_redirect.js]
+tags = mcb
 [browser_windowactivation.js]
 [browser_contextmenu_childprocess.js]
 [browser_bug963945.js]
 [browser_readerMode.js]
 support-files =
   readerModeArticle.html
 [browser_readerMode_hidden_nodes.js]
 support-files =
diff --git a/browser/base/content/test/general/browser_bug1045809.js b/browser/base/content/test/general/browser_bug1045809.js
--- a/browser/base/content/test/general/browser_bug1045809.js
+++ b/browser/base/content/test/general/browser_bug1045809.js
@@ -30,48 +30,39 @@ add_task(function* () {
   yield* test2(gBrowser.getBrowserForTab(tab));
 
   // Test 3: mixed content must be blocked again
   yield promiseTabLoadEvent(tab);
   yield* test3(gBrowser.getBrowserForTab(tab));
 });
 
 function* test1(gTestBrowser) {
-  var notification =
-    PopupNotifications.getNotification("bad-content", gTestBrowser);
-  isnot(notification, null, "Mixed Content Doorhanger did appear in Test1");
-  yield promiseNotificationShown(notification);
-  isnot(PopupNotifications.panel.firstChild.isMixedContentBlocked, 0,
+  let {gIdentityHandler} = gTestBrowser.ownerGlobal;
+  ok(gIdentityHandler.isMixedContentBlocked,
     "Mixed Content is being blocked in Test1");
 
   var x = content.document.getElementsByTagName('iframe')[0].contentDocument.getElementById('mixedContentContainer');
   is(x, null, "Mixed Content is NOT to be found in Test1");
 
   // Disable Mixed Content Protection for the page (and reload)
-  PopupNotifications.panel.firstChild.disableMixedContentProtection();
+  gIdentityHandler.disableMixedContentProtection();
 }
 
 function* test2(gTestBrowser) {
-  var notification =
-    PopupNotifications.getNotification("bad-content", gTestBrowser);
-  isnot(notification, null, "Mixed Content Doorhanger did appear in Test2");
-  yield promiseNotificationShown(notification);
-  is(PopupNotifications.panel.firstChild.isMixedContentBlocked, 0,
+  let {gIdentityHandler} = gTestBrowser.ownerGlobal;
+  ok(!gIdentityHandler.isMixedContentBlocked,
     "Mixed Content is NOT being blocked in Test2");
 
   var x = content.document.getElementsByTagName('iframe')[0].contentDocument.getElementById('mixedContentContainer');
   isnot(x, null, "Mixed Content is to be found in Test2");
 
   // Re-enable Mixed Content Protection for the page (and reload)
-  PopupNotifications.panel.firstChild.enableMixedContentProtection();
+  gIdentityHandler.enableMixedContentProtection();
 }
 
 function* test3(gTestBrowser) {
-  var notification =
-    PopupNotifications.getNotification("bad-content", gTestBrowser);
-  isnot(notification, null, "Mixed Content Doorhanger did appear in Test3");
-  yield promiseNotificationShown(notification);
-  isnot(PopupNotifications.panel.firstChild.isMixedContentBlocked, 0,
+  let {gIdentityHandler} = gTestBrowser.ownerGlobal;
+  ok(gIdentityHandler.isMixedContentBlocked,
     "Mixed Content is being blocked in Test3");
 
   var x = content.document.getElementsByTagName('iframe')[0].contentDocument.getElementById('mixedContentContainer');
   is(x, null, "Mixed Content is NOT to be found in Test3");
 }
diff --git a/browser/base/content/test/general/browser_bug822367.js b/browser/base/content/test/general/browser_bug822367.js
--- a/browser/base/content/test/general/browser_bug822367.js
+++ b/browser/base/content/test/general/browser_bug822367.js
@@ -45,21 +45,20 @@ function test() {
   var url = gHttpTestRoot + "file_bug822367_1.html";
   gTestBrowser.contentWindow.location = url;
 }
 
 // Mixed Script Test
 function MixedTest1A() {
   gTestBrowser.removeEventListener("load", MixedTest1A, true);
   gTestBrowser.addEventListener("load", MixedTest1B, true);
-  var notification = PopupNotifications.getNotification("bad-content", gTestBrowser);
-  ok(notification, "Mixed Content Doorhanger did appear");
-  notification.reshow();
-  ok(PopupNotifications.panel.firstChild.isMixedContentBlocked, "OK: Mixed Content is being blocked");
-  PopupNotifications.panel.firstChild.disableMixedContentProtection();
+
+  let {gIdentityHandler} = gTestBrowser.ownerGlobal;
+  ok(gIdentityHandler.isMixedContentBlocked, "OK: Mixed Content is being blocked");
+  gIdentityHandler.disableMixedContentProtection();
 }
 function MixedTest1B() {
   waitForCondition(function() content.document.getElementById('p1').innerHTML == "hello", MixedTest1C, "Waited too long for mixed script to run in Test 1");
 }
 function MixedTest1C() {
   ok(content.document.getElementById('p1').innerHTML == "hello","Mixed script didn't load in Test 1");
   gTestBrowser.removeEventListener("load", MixedTest1B, true);
   MixedTest2();
@@ -68,36 +67,35 @@ function MixedTest1C() {
 //Mixed Display Test - Doorhanger should not appear
 function MixedTest2() {
   gTestBrowser.addEventListener("load", MixedTest2A, true);
   var url = gHttpTestRoot2 + "file_bug822367_2.html";
   gTestBrowser.contentWindow.location = url;
 }
 
 function MixedTest2A() {
-  var notification = PopupNotifications.getNotification("bad-content", gTestBrowser);
-  ok(!notification, "Mixed Content Doorhanger did not appear for mixed display content!");
+  let {gIdentityHandler} = gTestBrowser.ownerGlobal;
+  ok(!gIdentityHandler.isMixedContentBlocked, "OK: Mixed Content did not appear for mixed display content");
   MixedTest3();
 }
 
 // Mixed Script and Display Test - User Override should cause both the script and the image to load.
 function MixedTest3() {
   gTestBrowser.removeEventListener("load", MixedTest2A, true);
   gTestBrowser.addEventListener("load", MixedTest3A, true);
   var url = gHttpTestRoot + "file_bug822367_3.html";
   gTestBrowser.contentWindow.location = url;
 }
 function MixedTest3A() {
   gTestBrowser.removeEventListener("load", MixedTest3A, true);
   gTestBrowser.addEventListener("load", MixedTest3B, true);
-  var notification = PopupNotifications.getNotification("bad-content", gTestBrowser);
-  ok(notification, "Mixed Content Doorhanger did appear for test 3");
-  notification.reshow();
-  ok(PopupNotifications.panel.firstChild.isMixedContentBlocked, "OK: Mixed Content is being blocked in test 3");
-  PopupNotifications.panel.firstChild.disableMixedContentProtection();
+
+  let {gIdentityHandler} = gTestBrowser.ownerGlobal;
+  ok(gIdentityHandler.isMixedContentBlocked, "OK: Mixed Content is being blocked in test 3");
+  gIdentityHandler.disableMixedContentProtection();
 }
 function MixedTest3B() {
   waitForCondition(function() content.document.getElementById('p1').innerHTML == "hello", MixedTest3C, "Waited too long for mixed script to run in Test 3");
 }
 function MixedTest3C() {
   waitForCondition(function() content.document.getElementById('p2').innerHTML == "bye", MixedTest3D, "Waited too long for mixed image to load in Test 3");
 }
 function MixedTest3D() {
@@ -111,32 +109,29 @@ function MixedTest4() {
   gTestBrowser.removeEventListener("load", MixedTest3B, true);
   gTestBrowser.addEventListener("load", MixedTest4A, true);
   var url = gHttpTestRoot2 + "file_bug822367_4.html";
   gTestBrowser.contentWindow.location = url;
 }
 function MixedTest4A() {
   gTestBrowser.removeEventListener("load", MixedTest4A, true);
   gTestBrowser.addEventListener("load", MixedTest4B, true);
-  var notification = PopupNotifications.getNotification("bad-content", gTestBrowser);
-  ok(notification, "Mixed Content Doorhanger did appear for Test 4");
-  notification.reshow();
-  ok(PopupNotifications.panel.firstChild.isMixedContentBlocked, "OK: Mixed Content is being blocked in Test 4");
-  PopupNotifications.panel.firstChild.disableMixedContentProtection();
+
+  let {gIdentityHandler} = gTestBrowser.ownerGlobal;
+  ok(gIdentityHandler.isMixedContentBlocked, "OK: Mixed Content is being blocked in Test 4");
+  gIdentityHandler.disableMixedContentProtection();
 }
 function MixedTest4B() {
   waitForCondition(function() content.document.location == gHttpTestRoot + "file_bug822367_4B.html", MixedTest4C, "Waited too long for mixed script to run in Test 4");
 }
 function MixedTest4C() {
   ok(content.document.location == gHttpTestRoot + "file_bug822367_4B.html", "Location didn't change in test 4");
-  var notification = PopupNotifications.getNotification("bad-content", gTestBrowser);
-  ok(notification, "Mixed Content Doorhanger did appear after location change in Test 4");
-  notification.reshow();
-  ok(PopupNotifications.panel.firstChild.isMixedContentBlocked, "OK: Mixed Content is being blocked in test 4");
-  notification.remove();
+
+  let {gIdentityHandler} = gTestBrowser.ownerGlobal;
+  ok(gIdentityHandler.isMixedContentBlocked, "OK: Mixed Content is being blocked in test 4");
   waitForCondition(function() content.document.getElementById('p1').innerHTML == "", MixedTest4D, "Mixed script loaded in test 4 after location change!");
 }
 function MixedTest4D() {
   ok(content.document.getElementById('p1').innerHTML == "","p1.innerHTML changed; mixed script loaded after location change in Test 4");
   MixedTest5();
 }
 
 // Mixed script attempts to load in a document.open()
@@ -144,21 +139,20 @@ function MixedTest5() {
   gTestBrowser.removeEventListener("load", MixedTest4B, true);
   gTestBrowser.addEventListener("load", MixedTest5A, true);
   var url = gHttpTestRoot + "file_bug822367_5.html";
   gTestBrowser.contentWindow.location = url;
 }
 function MixedTest5A() {
   gTestBrowser.removeEventListener("load", MixedTest5A, true);
   gTestBrowser.addEventListener("load", MixedTest5B, true);
-  var notification = PopupNotifications.getNotification("bad-content", gTestBrowser);
-  ok(notification, "Mixed Content Doorhanger did appear for Test 5");
-  notification.reshow();
-  ok(PopupNotifications.panel.firstChild.isMixedContentBlocked, "OK: Mixed Content is being blocked in Test 5");
-  PopupNotifications.panel.firstChild.disableMixedContentProtection();
+
+  let {gIdentityHandler} = gTestBrowser.ownerGlobal;
+  ok(gIdentityHandler.isMixedContentBlocked, "OK: Mixed Content is being blocked in Test 5");
+  gIdentityHandler.disableMixedContentProtection();
 }
 function MixedTest5B() {
   waitForCondition(function() content.document.getElementById('p1').innerHTML == "hello", MixedTest5C, "Waited too long for mixed script to run in Test 5");
 }
 function MixedTest5C() {
   ok(content.document.getElementById('p1').innerHTML == "hello","Mixed script didn't load in Test 5");
   MixedTest6();
 }
@@ -167,26 +161,25 @@ function MixedTest5C() {
 function MixedTest6() {
   gTestBrowser.removeEventListener("load", MixedTest5B, true);
   gTestBrowser.addEventListener("load", MixedTest6A, true);
   var url = gHttpTestRoot2 + "file_bug822367_6.html";
   gTestBrowser.contentWindow.location = url;
 }
 function MixedTest6A() {
   gTestBrowser.removeEventListener("load", MixedTest6A, true);
-  waitForCondition(function() PopupNotifications.getNotification("bad-content", gTestBrowser), MixedTest6B, "waited too long for doorhanger");
+  let {gIdentityHandler} = gTestBrowser.ownerGlobal;
+  waitForCondition(() => gIdentityHandler.isMixedContentBlocked, MixedTest6B, "waited too long for doorhanger");
 }
 
 function MixedTest6B() {
-  var notification = PopupNotifications.getNotification("bad-content", gTestBrowser);
-  ok(notification, "Mixed Content Doorhanger did appear for Test 6");
   gTestBrowser.addEventListener("load", MixedTest6C, true);
-  notification.reshow();
-  ok(PopupNotifications.panel.firstChild.isMixedContentBlocked, "OK: Mixed Content is being blocked in Test 6");
-  PopupNotifications.panel.firstChild.disableMixedContentProtection();
+  let {gIdentityHandler} = gTestBrowser.ownerGlobal;
+  ok(gIdentityHandler.isMixedContentBlocked, "OK: Mixed Content is being blocked in Test 6");
+  gIdentityHandler.disableMixedContentProtection();
 }
 
 function MixedTest6C() {
   gTestBrowser.removeEventListener("load", MixedTest6C, true);
   waitForCondition(function() {
     try {
       return content.document.getElementById('f1').contentDocument.getElementById('p1').innerHTML == "hello";
     } catch (e) {
diff --git a/browser/base/content/test/general/browser_bug902156.js b/browser/base/content/test/general/browser_bug902156.js
--- a/browser/base/content/test/general/browser_bug902156.js
+++ b/browser/base/content/test/general/browser_bug902156.js
@@ -45,24 +45,21 @@ function cleanUpAfterTests() {
 //------------------------ Test 1 ------------------------------
 
 function test1A() {
   // Removing EventListener because we have to register a new
   // one once the page is loaded with mixed content blocker disabled
   gTestBrowser.removeEventListener("load", test1A, true);
   gTestBrowser.addEventListener("load", test1B, true);
 
-  var notification = PopupNotifications.getNotification("bad-content", gTestBrowser);
-  ok(notification, "OK: Mixed Content Doorhanger did appear in Test1A!");
-  notification.reshow();
-  ok(PopupNotifications.panel.firstChild.isMixedContentBlocked, "OK: Mixed Content is being blocked in Test1A!");
+  let {gIdentityHandler} = gTestBrowser.ownerGlobal;
+  ok(gIdentityHandler.isMixedContentBlocked, "OK: Mixed Content is being blocked in Test1A!");
 
   // Disable Mixed Content Protection for the page (and reload)
-  PopupNotifications.panel.firstChild.disableMixedContentProtection();
-  notification.remove();
+  gIdentityHandler.disableMixedContentProtection();
 }
 
 function test1B() {
   var expected = "Mixed Content Blocker disabled";
   waitForCondition(
     function() content.document.getElementById('mctestdiv').innerHTML == expected,
     test1C, "Error: Waited too long for mixed script to run in Test 1B");
 }
@@ -80,21 +77,18 @@ function test1C() {
   gTestBrowser.contentWindow.location = url;
 }
 
 function test1D() {
   gTestBrowser.removeEventListener("load", test1D, true);
 
   // The Doorhanger should appear but isMixedContentBlocked should be NOT true,
   // because our decision of disabling the mixed content blocker is persistent.
-  var notification = PopupNotifications.getNotification("bad-content", gTestBrowser);
-  ok(notification, "OK: Mixed Content Doorhanger did appear in Test1D!");
-  notification.reshow();
-  ok(!PopupNotifications.panel.firstChild.isMixedContentBlocked, "OK: Mixed Content is NOT being blocked in Test1D!");
-  notification.remove();
+  let {gIdentityHandler} = gTestBrowser.ownerGlobal;
+  ok(!gIdentityHandler.isMixedContentBlocked, "OK: Mixed Content is NOT being blocked in Test1D!");
 
   var actual = content.document.getElementById('mctestdiv').innerHTML;
   is(actual, "Mixed Content Blocker disabled", "OK: Executed mixed script in Test 1D");
 
   // move on to Test 2
   test2();
 }
 
@@ -107,24 +101,21 @@ function test2() {
 }
 
 function test2A() {
   // Removing EventListener because we have to register a new
   // one once the page is loaded with mixed content blocker disabled
   gTestBrowser.removeEventListener("load", test2A, true);
   gTestBrowser.addEventListener("load", test2B, true);
 
-  var notification = PopupNotifications.getNotification("bad-content", gTestBrowser);
-  ok(notification, "OK: Mixed Content Doorhanger did appear in Test 2A!");
-  notification.reshow();
-  ok(PopupNotifications.panel.firstChild.isMixedContentBlocked, "OK: Mixed Content is being blocked in Test 2A!");
+  let {gIdentityHandler} = gTestBrowser.ownerGlobal;
+  ok(gIdentityHandler.isMixedContentBlocked, "OK: Mixed Content is being blocked in Test 2A!");
 
   // Disable Mixed Content Protection for the page (and reload)
-  PopupNotifications.panel.firstChild.disableMixedContentProtection();
-  notification.remove();
+  gIdentityHandler.disableMixedContentProtection();
 }
 
 function test2B() {
   var expected = "Mixed Content Blocker disabled";
   waitForCondition(
     function() content.document.getElementById('mctestdiv').innerHTML == expected,
     test2C, "Error: Waited too long for mixed script to run in Test 2B");
 }
@@ -143,21 +134,18 @@ function test2C() {
   mctestlink.click();
 }
 
 function test2D() {
   gTestBrowser.removeEventListener("load", test2D, true);
 
   // The Doorhanger should appear but isMixedContentBlocked should be NOT true,
   // because our decision of disabling the mixed content blocker is persistent.
-  var notification = PopupNotifications.getNotification("bad-content", gTestBrowser);
-  ok(notification, "OK: Mixed Content Doorhanger did appear in Test2D!");
-  notification.reshow();
-  ok(!PopupNotifications.panel.firstChild.isMixedContentBlocked, "OK: Mixed Content is NOT being blocked");
-  notification.remove();
+  let {gIdentityHandler} = gTestBrowser.ownerGlobal;
+  ok(!gIdentityHandler.isMixedContentBlocked, "OK: Mixed Content is NOT being blocked");
 
   var actual = content.document.getElementById('mctestdiv').innerHTML;
   is(actual, "Mixed Content Blocker disabled", "OK: Executed mixed script in Test 2D");
 
   // move on to Test 3
   test3();
 }
 
@@ -169,21 +157,18 @@ function test3() {
   gTestBrowser.contentWindow.location = url;
 }
 
 function test3A() {
   // Removing EventListener because we have to register a new
   // one once the page is loaded with mixed content blocker disabled
   gTestBrowser.removeEventListener("load", test3A, true);
 
-  var notification = PopupNotifications.getNotification("bad-content", gTestBrowser);
-  ok(notification, "OK: Mixed Content Doorhanger did appear in Test 3A!");
-  notification.reshow();
-  ok(PopupNotifications.panel.firstChild.isMixedContentBlocked, "OK: Mixed Content is being blocked in Test 3A");
-  notification.remove();
+  let {gIdentityHandler} = gTestBrowser.ownerGlobal;
+  ok(gIdentityHandler.isMixedContentBlocked, "OK: Mixed Content is being blocked in Test 3A");
 
   // We are done with tests, clean up
   cleanUpAfterTests();
 }
 
 //------------------------------------------------------
 
 function test() {
diff --git a/browser/base/content/test/general/browser_bug906190.js b/browser/base/content/test/general/browser_bug906190.js
--- a/browser/base/content/test/general/browser_bug906190.js
+++ b/browser/base/content/test/general/browser_bug906190.js
@@ -138,25 +138,23 @@ function waitForSomeTabToLoad(callback) 
       callback();
     }
   }, true);
 }
 
 function checkPopUpNotification() {
   waitForSomeTabToLoad(reloadedTabAfterDisablingMCB);
 
-  var notification = PopupNotifications.getNotification("bad-content", gTestWin.gBrowser.selectedBrowser);
-  ok(notification, "OK: Mixed Content Doorhanger did appear in " + curTestName + "!");
-  promiseNotificationShown(notification).then(function() {
-    ok(gTestWin.PopupNotifications.panel.firstChild.isMixedContentBlocked, "OK: Mixed Content is being blocked in " + curTestName + "!");
+  let {gIdentityHandler} = gTestWin.gBrowser.ownerGlobal;
+  // promiseNotificationShown(notification).then(function() {
+    ok(gIdentityHandler.isMixedContentBlocked, "OK: Mixed Content is being blocked in " + curTestName + "!");
 
     // Disable Mixed Content Protection for the page (and reload page)
-    gTestWin.PopupNotifications.panel.firstChild.disableMixedContentProtection();
-    notification.remove();
-  });
+    gIdentityHandler.disableMixedContentProtection();
+  // });
 }
 
 function reloadedTabAfterDisablingMCB() {
   var expected = "Mixed Content Blocker disabled";
   waitForCondition(
     function() gTestWin.content.document.getElementById('mctestdiv').innerHTML == expected,
     makeSureMCBisDisabled, "Error: Waited too long for mixed script to run in " + curTestName + "!");
 }
@@ -187,28 +185,26 @@ function test1() {
   EventUtils.synthesizeMouseAtCenter(targetElt, { button: 1 }, gTestWin.content);
 }
 
 function test1A() {
   gTestWin.gBrowser.selectTabAtIndex(2);
 
   // The Doorhanger should appear but isMixedContentBlocked should be >> NOT << true,
   // because our decision of disabling the mixed content blocker is persistent across tabs.
-  var notification = PopupNotifications.getNotification("bad-content", gTestWin.gBrowser.selectedBrowser);
-  ok(notification, "OK: Mixed Content Doorhanger did appear in Test 1A!");
-  promiseNotificationShown(notification).then(function() {
-    ok(!gTestWin.PopupNotifications.panel.firstChild.isMixedContentBlocked, "OK: Mixed Content is NOT being blocked in Test 1A!");
-    notification.remove();
+  let {gIdentityHandler} = gTestWin.gBrowser.ownerGlobal;
+  // waitForCondition(() => gIdentityHandler.isMixedContentBlocked, function() {
+    ok(!gIdentityHandler.isMixedContentBlocked, "OK: Mixed Content is NOT being blocked in Test 1A!");
 
     var actual = gTestWin.content.document.getElementById('mctestdiv').innerHTML;
     is(actual, "Mixed Content Blocker disabled", "OK: Executed mixed script in Test 1A");
 
     gTestWin.gBrowser.removeCurrentTab();
     test1B();
-  });
+  // }, "waited too long for doorhanger");
 }
 
 function test1B() {
   curContextMenu = function (e) { contextMenuOpenHandler(e, test1C) };
   gTestWin.document.addEventListener("popupshown", curContextMenu, false);
 
   // simulating |RIGHT-CLICK -> OPEN LINK IN TAB|
   let targetElt = gTestWin.content.document.getElementById("Test1");
@@ -216,33 +212,31 @@ function test1B() {
   EventUtils.synthesizeMouseAtCenter(targetElt, { type : "contextmenu", button : 2 } , gTestWin.content);
 }
 
 function test1C() {
   gTestWin.gBrowser.selectTabAtIndex(2);
 
   // The Doorhanger should appear but isMixedContentBlocked should be >> NOT << true,
   // because our decision of disabling the mixed content blocker is persistent across tabs.
-  var notification = PopupNotifications.getNotification("bad-content", gTestWin.gBrowser.selectedBrowser);
-  ok(notification, "OK: Mixed Content Doorhanger did appear in Test 1C!");
-  promiseNotificationShown(notification).then(function() {
-    ok(!gTestWin.PopupNotifications.panel.firstChild.isMixedContentBlocked, "OK: Mixed Content is NOT being blocked in Test 1C!");
-    notification.remove();
+  let {gIdentityHandler} = gTestWin.gBrowser.ownerGlobal;
+  // promiseNotificationShown(notification).then(function() {
+    ok(!gIdentityHandler.isMixedContentBlocked, "OK: Mixed Content is NOT being blocked in Test 1C!");
 
     var actual = gTestWin.content.document.getElementById('mctestdiv').innerHTML;
     is(actual, "Mixed Content Blocker disabled", "OK: Executed mixed script in Test 1C");
 
     // remove tabs
     gTestWin.gBrowser.removeTab(gTestWin.gBrowser.tabs[2], {animate: false});
     gTestWin.gBrowser.removeTab(gTestWin.gBrowser.tabs[1], {animate: false});
     gTestWin.gBrowser.selectTabAtIndex(0);
 
     var childTabLink = gHttpTestRoot2 + "file_bug906190_2.html";
     setUpTest("Test2", "linkForTest2", test2, childTabLink);
-  });
+  // });
 }
 
 //------------------------ Test 2 ------------------------------
 
 function test2() {
   curClickHandler = function (e) { clickHandler(e, test2A) };
   gTestWin.gBrowser.addEventListener("click", curClickHandler, true);
 
@@ -251,28 +245,26 @@ function test2() {
   EventUtils.synthesizeMouseAtCenter(targetElt, { button: 1 }, gTestWin.content);
 }
 
 function test2A() {
   gTestWin.gBrowser.selectTabAtIndex(2);
 
   // The Doorhanger should appear and isMixedContentBlocked should be >> TRUE <<,
   // because our decision of disabling the mixed content blocker should only persist if pages are from the same domain.
-  var notification = PopupNotifications.getNotification("bad-content", gTestWin.gBrowser.selectedBrowser);
-  ok(notification, "OK: Mixed Content Doorhanger did appear in Test 2A!");
-  promiseNotificationShown(notification).then(function() {
-    ok(gTestWin.PopupNotifications.panel.firstChild.isMixedContentBlocked, "OK: Mixed Content is being blocked in Test 2A!");
-    notification.remove();
+  let {gIdentityHandler} = gTestWin.gBrowser.ownerGlobal;
+  // promiseNotificationShown(notification).then(function() {
+    ok(gIdentityHandler.isMixedContentBlocked, "OK: Mixed Content is being blocked in Test 2A!");
 
     var actual = gTestWin.content.document.getElementById('mctestdiv').innerHTML;
     is(actual, "Mixed Content Blocker enabled", "OK: Blocked mixed script in Test 2A");
 
     gTestWin.gBrowser.removeCurrentTab();
     test2B();
-  });
+  // });
 }
 
 function test2B() {
   curContextMenu = function (e) { contextMenuOpenHandler(e, test2C) };
   gTestWin.document.addEventListener("popupshown", curContextMenu, false);
 
   // simulating |RIGHT-CLICK -> OPEN LINK IN TAB|
   let targetElt = gTestWin.content.document.getElementById("Test2");
@@ -280,34 +272,32 @@ function test2B() {
   EventUtils.synthesizeMouseAtCenter(targetElt, { type : "contextmenu", button : 2 } , gTestWin.content);
 }
 
 function test2C() {
   gTestWin.gBrowser.selectTabAtIndex(2);
 
   // The Doorhanger should appear and isMixedContentBlocked should be >> TRUE <<,
   // because our decision of disabling the mixed content blocker should only persist if pages are from the same domain.
-  var notification = PopupNotifications.getNotification("bad-content", gTestWin.gBrowser.selectedBrowser);
-  ok(notification, "OK: Mixed Content Doorhanger did appear in Test 2C!");
-  promiseNotificationShown(notification).then(function() {
-    ok(gTestWin.PopupNotifications.panel.firstChild.isMixedContentBlocked, "OK: Mixed Content is being blocked in Test 2C!");
-    notification.remove();
+  let {gIdentityHandler} = gTestWin.gBrowser.ownerGlobal;
+  // promiseNotificationShown(notification).then(function() {
+    ok(gIdentityHandler.isMixedContentBlocked, "OK: Mixed Content is being blocked in Test 2C!");
 
     var actual = gTestWin.content.document.getElementById('mctestdiv').innerHTML;
     is(actual, "Mixed Content Blocker enabled", "OK: Blocked mixed script in Test 2C");
 
     // remove tabs
     gTestWin.gBrowser.removeTab(gTestWin.gBrowser.tabs[2], {animate: false});
     gTestWin.gBrowser.removeTab(gTestWin.gBrowser.tabs[1], {animate: false});
     gTestWin.gBrowser.selectTabAtIndex(0);
 
     // file_bug906190_3_4.html redirects to page test1.example.com/* using meta-refresh
     var childTabLink = gHttpTestRoot1 + "file_bug906190_3_4.html";
     setUpTest("Test3", "linkForTest3", test3, childTabLink);
-  });
+  // });
 }
 
 //------------------------ Test 3 ------------------------------
 
 function test3() {
   curClickHandler = function (e) { clickHandler(e, test3A) };
   gTestWin.gBrowser.addEventListener("click", curClickHandler, true);
   // simulating |CTRL-CLICK|
@@ -319,29 +309,27 @@ function test3A() {
   // we need this indirection because the page is reloaded caused by meta-refresh
   waitForSomeTabToLoad(test3B);
 }
 
 function test3B() {
   gTestWin.gBrowser.selectTabAtIndex(2);
 
   // The Doorhanger should appear but isMixedContentBlocked should be >> NOT << true!
-  var notification = PopupNotifications.getNotification("bad-content", gTestWin.gBrowser.selectedBrowser);
-  ok(notification, "OK: Mixed Content Doorhanger did appear in Test 3B!");
-  promiseNotificationShown(notification).then(function() {
-    ok(!gTestWin.PopupNotifications.panel.firstChild.isMixedContentBlocked, "OK: Mixed Content is NOT being blocked in Test 3B!");
-    notification.remove();
+  let {gIdentityHandler} = gTestWin.gBrowser.ownerGlobal;
+  // promiseNotificationShown(notification).then(function() {
+    ok(!gIdentityHandler.isMixedContentBlocked, "OK: Mixed Content is NOT being blocked in Test 3B!");
 
     var actual = gTestWin.content.document.getElementById('mctestdiv').innerHTML;
     is(actual, "Mixed Content Blocker disabled", "OK: Executed mixed script in Test 3B");
 
     // remove tabs
     gTestWin.gBrowser.removeCurrentTab();
     test3C();
-  });
+  // });
 }
 
 function test3C() {
   curContextMenu = function (e) { contextMenuOpenHandler(e, test3D) };
   gTestWin.document.addEventListener("popupshown", curContextMenu, false);
 
   // simulating |RIGHT-CLICK -> OPEN LINK IN TAB|
   let targetElt = gTestWin.content.document.getElementById("Test3");
@@ -352,33 +340,31 @@ function test3D() {
   // we need this indirection because the page is reloaded caused by meta-refresh
   waitForSomeTabToLoad(test3E);
 }
 
 function test3E() {
   gTestWin.gBrowser.selectTabAtIndex(2);
 
   // The Doorhanger should appear but isMixedContentBlocked should be >> NOT << true!
-  var notification = PopupNotifications.getNotification("bad-content", gTestWin.gBrowser.selectedBrowser);
-  ok(notification, "OK: Mixed Content Doorhanger did appear in Test 3E!");
-  promiseNotificationShown(notification).then(function() {
-    ok(!gTestWin.PopupNotifications.panel.firstChild.isMixedContentBlocked, "OK: Mixed Content is NOT being blocked in Test 3E!");
-    notification.remove();
+  let {gIdentityHandler} = gTestWin.gBrowser.ownerGlobal;
+  // promiseNotificationShown(notification).then(function() {
+    ok(!gIdentityHandler.isMixedContentBlocked, "OK: Mixed Content is NOT being blocked in Test 3E!");
 
     var actual = gTestWin.content.document.getElementById('mctestdiv').innerHTML;
     is(actual, "Mixed Content Blocker disabled", "OK: Executed mixed script in Test 3E");
 
     // remove tabs
     gTestWin.gBrowser.removeTab(gTestWin.gBrowser.tabs[2], {animate: false});
     gTestWin.gBrowser.removeTab(gTestWin.gBrowser.tabs[1], {animate: false});
     gTestWin.gBrowser.selectTabAtIndex(0);
 
     var childTabLink = gHttpTestRoot1 + "file_bug906190_3_4.html";
     setUpTest("Test4", "linkForTest4", test4, childTabLink);
-  });
+  // });
 }
 
 //------------------------ Test 4 ------------------------------
 
 function test4() {
   curClickHandler = function (e) { clickHandler(e, test4A) };
   gTestWin.gBrowser.addEventListener("click", curClickHandler, true);
 
@@ -391,29 +377,27 @@ function test4A() {
   // we need this indirection because the page is reloaded caused by meta-refresh
   waitForSomeTabToLoad(test4B);
 }
 
 function test4B() {
   gTestWin.gBrowser.selectTabAtIndex(2);
 
   // The Doorhanger should appear and isMixedContentBlocked should be >> TRUE <<
-  var notification = PopupNotifications.getNotification("bad-content", gTestWin.gBrowser.selectedBrowser);
-  ok(notification, "OK: Mixed Content Doorhanger did appear in Test 4B!");
-  promiseNotificationShown(notification).then(function() {
-    ok(gTestWin.PopupNotifications.panel.firstChild.isMixedContentBlocked, "OK: Mixed Content is being blocked in Test 4B!");
-    notification.remove();
+  let {gIdentityHandler} = gTestWin.gBrowser.ownerGlobal;
+  // promiseNotificationShown(notification).then(function() {
+    ok(gIdentityHandler.isMixedContentBlocked, "OK: Mixed Content is being blocked in Test 4B!");
 
     var actual = gTestWin.content.document.getElementById('mctestdiv').innerHTML;
     is(actual, "Mixed Content Blocker enabled", "OK: Blocked mixed script in Test 4B");
 
     // remove tabs
     gTestWin.gBrowser.removeCurrentTab();
     test4C();
-  });
+  // });
 }
 
 function test4C() {
   curContextMenu = function (e) { contextMenuOpenHandler(e, test4D) };
   gTestWin.document.addEventListener("popupshown", curContextMenu, false);
 
   // simulating |RIGHT-CLICK -> OPEN LINK IN TAB|
   let targetElt = gTestWin.content.document.getElementById("Test4");
@@ -424,34 +408,32 @@ function test4D() {
   // we need this indirection because the page is reloaded caused by meta-refresh
   waitForSomeTabToLoad(test4E);
 }
 
 function test4E() {
   gTestWin.gBrowser.selectTabAtIndex(2);
 
   // The Doorhanger should appear and isMixedContentBlocked should be >> TRUE <<
-  var notification = PopupNotifications.getNotification("bad-content", gTestWin.gBrowser.selectedBrowser);
-  ok(notification, "OK: Mixed Content Doorhanger did appear in Test 4E!");
-  promiseNotificationShown(notification).then(function() {
-    ok(gTestWin.PopupNotifications.panel.firstChild.isMixedContentBlocked, "OK: Mixed Content is being blocked in Test 4E!");
-    notification.remove();
+  let {gIdentityHandler} = gTestWin.gBrowser.ownerGlobal;
+  // promiseNotificationShown(notification).then(function() {
+    ok(gIdentityHandler.isMixedContentBlocked, "OK: Mixed Content is being blocked in Test 4E!");
 
     var actual = gTestWin.content.document.getElementById('mctestdiv').innerHTML;
     is(actual, "Mixed Content Blocker enabled", "OK: Blocked mixed script in Test 4E");
 
     // remove tabs
     gTestWin.gBrowser.removeTab(gTestWin.gBrowser.tabs[2], {animate: false});
     gTestWin.gBrowser.removeTab(gTestWin.gBrowser.tabs[1], {animate: false});
     gTestWin.gBrowser.selectTabAtIndex(0);
 
     // the sjs files returns a 302 redirect- note, same origins
     var childTabLink = gHttpTestRoot1 + "file_bug906190.sjs";
     setUpTest("Test5", "linkForTest5", test5, childTabLink);
-  });
+  // });
 }
 
 //------------------------ Test 5 ------------------------------
 
 function test5() {
   curClickHandler = function (e) { clickHandler(e, test5A) };
   gTestWin.gBrowser.addEventListener("click", curClickHandler, true);
 
@@ -460,64 +442,63 @@ function test5() {
   EventUtils.synthesizeMouseAtCenter(targetElt, { button: 1 }, gTestWin.content);
 }
 
 function test5A() {
   gTestWin.gBrowser.selectTabAtIndex(2);
 
   // The Doorhanger should appear but isMixedContentBlocked should be >> NOT << true
   // Currently it is >> TRUE << - see follow up bug 914860
-  var notification = PopupNotifications.getNotification("bad-content", gTestWin.gBrowser.selectedBrowser);
-  ok(notification, "OK: Mixed Content Doorhanger did appear in Test 5A!");
-  promiseNotificationShown(notification).then(function() {
-    todo(!gTestWin.PopupNotifications.panel.firstChild.isMixedContentBlocked, "OK: Mixed Content is NOT being blocked in Test 5A!");
-    notification.remove();
+  let {gIdentityHandler} = gTestWin.gBrowser.ownerGlobal;
+  // promiseNotificationShown(notification).then(function() {
+    todo(!gIdentityHandler.isMixedContentBlocked, "OK: Mixed Content is NOT being blocked in Test 5A!");
 
     var actual = gTestWin.content.document.getElementById('mctestdiv').innerHTML;
     todo_is(actual, "Mixed Content Blocker disabled", "OK: Executed mixed script in Test 5A!");
 
     // remove tabs
     gTestWin.gBrowser.removeCurrentTab();
     test5B();
-  });
+  // });
 }
 
 function test5B() {
   curContextMenu = function (e) { contextMenuOpenHandler(e, test5C) };
   gTestWin.document.addEventListener("popupshown", curContextMenu, false);
 
   // simulating |RIGHT-CLICK -> OPEN LINK IN TAB|
   let targetElt = gTestWin.content.document.getElementById("Test5");
   EventUtils.synthesizeMouseAtCenter(targetElt, { type : "contextmenu", button : 2 } , gTestWin.content);
 }
 
 function test5C() {
   // move the tab again
   gTestWin.gBrowser.selectTabAtIndex(2);
 
+  let {gIdentityHandler} = gTestWin.gBrowser.ownerGlobal;
+
   // The Doorhanger should appear but isMixedContentBlocked should be >> NOT << true
   // Currently it is >> TRUE << - see follow up bug 914860
-  var notification = PopupNotifications.getNotification("bad-content", gTestWin.gBrowser.selectedBrowser);
-  ok(notification, "OK: Mixed Content Doorhanger did appear in Test 5C!");
-  promiseNotificationShown(notification).then(function() {
-    todo(!gTestWin.PopupNotifications.panel.firstChild.isMixedContentBlocked, "OK: Mixed Content is NOT being blocked in Test 5C!");
-    notification.remove();
+  // promiseNotificationShown(notification).then(function() {
+  // setTimeout(() => {
+    todo(!gIdentityHandler.isMixedContentBlocked, "OK: Mixed Content is NOT being blocked in Test 5C!");
 
     var actual = gTestWin.content.document.getElementById('mctestdiv').innerHTML;
     todo_is(actual, "Mixed Content Blocker disabled", "OK: Executed mixed script in Test 5C!");
 
     // remove tabs
     gTestWin.gBrowser.removeTab(gTestWin.gBrowser.tabs[2], {animate: false});
     gTestWin.gBrowser.removeTab(gTestWin.gBrowser.tabs[1], {animate: false});
     gTestWin.gBrowser.selectTabAtIndex(0);
 
     // the sjs files returns a 302 redirect - note, different origins
     var childTabLink = gHttpTestRoot2 + "file_bug906190.sjs";
     setUpTest("Test6", "linkForTest6", test6, childTabLink);
-  });
+  // // });
+  // }, 10000)
 }
 
 //------------------------ Test 6 ------------------------------
 
 function test6() {
   curClickHandler = function (e) { clickHandler(e, test6A) };
   gTestWin.gBrowser.addEventListener("click", curClickHandler, true);
 
@@ -525,56 +506,52 @@ function test6() {
   let targetElt = gTestWin.content.document.getElementById("Test6");
   EventUtils.synthesizeMouseAtCenter(targetElt, { button: 1 }, gTestWin.content);
 }
 
 function test6A() {
   gTestWin.gBrowser.selectTabAtIndex(2);
 
   // The Doorhanger should appear and isMixedContentBlocked should be >> TRUE <<
-  var notification = PopupNotifications.getNotification("bad-content", gTestWin.gBrowser.selectedBrowser);
-  ok(notification, "OK: Mixed Content Doorhanger did appear in Test 6A!");
-  promiseNotificationShown(notification).then(function() {
-    ok(gTestWin.PopupNotifications.panel.firstChild.isMixedContentBlocked, "OK: Mixed Content is being blocked in Test 6A!");
-    notification.remove();
+  let {gIdentityHandler} = gTestWin.gBrowser.ownerGlobal;
+  // promiseNotificationShown(notification).then(function() {
+    ok(gIdentityHandler.isMixedContentBlocked, "OK: Mixed Content is being blocked in Test 6A!");
 
     var actual = gTestWin.content.document.getElementById('mctestdiv').innerHTML;
     is(actual, "Mixed Content Blocker enabled", "OK: Blocked mixed script in Test 6A");
 
     // done
     gTestWin.gBrowser.removeCurrentTab();
     test6B();
-  });
+  // });
 }
 
 function test6B() {
   curContextMenu = function (e) { contextMenuOpenHandler(e, test6C) };
   gTestWin.document.addEventListener("popupshown", curContextMenu, false);
 
   // simulating |RIGHT-CLICK -> OPEN LINK IN TAB|
   let targetElt = gTestWin.content.document.getElementById("Test6");
   EventUtils.synthesizeMouseAtCenter(targetElt, { type : "contextmenu", button : 2 } , gTestWin.content);
 }
 
 function test6C() {
   gTestWin.gBrowser.selectTabAtIndex(2);
 
   // The Doorhanger should appear and isMixedContentBlocked should be >> TRUE <<
-  var notification = PopupNotifications.getNotification("bad-content", gTestWin.gBrowser.selectedBrowser);
-  ok(notification, "OK: Mixed Content Doorhanger did appear in Test 6C!");
-  promiseNotificationShown(notification).then(function() {
-    ok(gTestWin.PopupNotifications.panel.firstChild.isMixedContentBlocked, "OK: Mixed Content is being blocked in Test 6C!");
-    notification.remove();
+  let {gIdentityHandler} = gTestWin.gBrowser.ownerGlobal;
+  // promiseNotificationShown(notification).then(function() {
+    ok(gIdentityHandler.isMixedContentBlocked, "OK: Mixed Content is being blocked in Test 6C!");
 
     var actual = gTestWin.content.document.getElementById('mctestdiv').innerHTML;
     is(actual, "Mixed Content Blocker enabled", "OK: Blocked mixed script in Test 6C");
 
     gTestWin.close();
     finish();
-  });
+  // });
 }
 
 //------------------------ SETUP ------------------------------
 
 function setupTestBrowserWindow() {
   // Inject links in content.
   let doc = gTestWin.content.document;
   let mainDiv = doc.createElement("div");
diff --git a/browser/base/content/test/general/browser_mcb_redirect.js b/browser/base/content/test/general/browser_mcb_redirect.js
--- a/browser/base/content/test/general/browser_mcb_redirect.js
+++ b/browser/base/content/test/general/browser_mcb_redirect.js
@@ -95,47 +95,47 @@ function waitForCondition(condition, nex
   var moveOn = function() {
     clearInterval(interval); nextTest();
   };
 }
 
 //------------------------ Test 1 ------------------------------
 
 function test1() {
-  gTestBrowser.addEventListener("load", checkPopUpNotificationsForTest1, true);
+  gTestBrowser.addEventListener("load", checkUIForTest1, true);
   var url = gHttpsTestRoot + "test_mcb_redirect.html"
   gTestBrowser.contentWindow.location = url;
 }
 
-function checkPopUpNotificationsForTest1() {
-  gTestBrowser.removeEventListener("load", checkPopUpNotificationsForTest1, true);
+function checkUIForTest1() {
+  gTestBrowser.removeEventListener("load", checkUIForTest1, true);
 
-  var notification = PopupNotifications.getNotification("bad-content", gTestBrowser.selectedBrowser);
-  ok(notification, "OK: Mixed Content Doorhanger appeared in Test1!");
+  let {gIdentityHandler} = gTestBrowser.ownerGlobal;
+  ok(gIdentityHandler.isMixedContentBlocked, "OK: Mixed Content blocked in Test1!");
 
   var expected = "script blocked";
   waitForCondition(
     function() content.document.getElementById('mctestdiv').innerHTML == expected,
     test2, "Error: Waited too long for status in Test 1!",
     "OK: Expected result in innerHTML for Test1!");
 }
 
 //------------------------ Test 2 ------------------------------
 
 function test2() {
-  gTestBrowser.addEventListener("load", checkPopUpNotificationsForTest2, true);
+  gTestBrowser.addEventListener("load", checkUIForTest2, true);
   var url = gHttpTestRoot + "test_mcb_redirect.html"
   gTestBrowser.contentWindow.location = url;
 }
 
-function checkPopUpNotificationsForTest2() {
-  gTestBrowser.removeEventListener("load", checkPopUpNotificationsForTest2, true);
+function checkUIForTest2() {
+  gTestBrowser.removeEventListener("load", checkUIForTest2, true);
 
-  var notification = PopupNotifications.getNotification("bad-content", gTestBrowser.selectedBrowser);
-  ok(!notification, "OK: Mixed Content Doorhanger did not appear in 2!");
+  let {gIdentityHandler} = gTestBrowser.ownerGlobal;
+  ok(!gIdentityHandler.isMixedContentBlocked, "OK: Mixed Content not blocked in Test2!");
 
   var expected = "script executed";
   waitForCondition(
     function() content.document.getElementById('mctestdiv').innerHTML == expected,
     test3, "Error: Waited too long for status in Test 2!",
     "OK: Expected result in innerHTML for Test2!");
 }
 
diff --git a/browser/base/content/test/general/browser_mixedcontent_securityflags.js b/browser/base/content/test/general/browser_mixedcontent_securityflags.js
--- a/browser/base/content/test/general/browser_mixedcontent_securityflags.js
+++ b/browser/base/content/test/general/browser_mixedcontent_securityflags.js
@@ -34,41 +34,43 @@ function blockMixedContentTest()
     overrideMCB();
   }, true);
 }
 
 function overrideMCB()
 {
   // test mixed content flags on load (reload)
   gTestBrowser.addEventListener("load", mixedContentOverrideTest, true);
-  var notification = PopupNotifications.getNotification("bad-content", gTestBrowser);
-  ok(notification, "Mixed Content Doorhanger should appear");
-  notification.reshow();
-  ok(PopupNotifications.panel.firstChild.isMixedContentBlocked, "OK: Mixed Content is being blocked");
+
+  let {gIdentityHandler} = gTestBrowser.ownerGlobal;
+  ok(gIdentityHandler.isMixedContentBlocked, "OK: Mixed Content is being blocked");
 
   // Make sure the notification has no mixedblockdisabled attribute
-  ok(!PopupNotifications.panel.firstChild.hasAttribute("mixedblockdisabled"),
-    "Doorhanger must have no mixedblockdisabled attribute");
+  gIdentityHandler._identityBox.click();
+  is(gIdentityHandler._identityPopup.getAttribute("secstate"), "active-blocked",
+    "Popup attribute is correct");
+  gIdentityHandler._identityPopup.hidden = true;
+
   // Click on the doorhanger to allow mixed content (and reload page)
-  PopupNotifications.panel.firstChild.disableMixedContentProtection();
+  gIdentityHandler.disableMixedContentProtection();
   notification.remove();
 }
 
 function mixedContentOverrideTest()
 {
   gTestBrowser.removeEventListener("load", mixedContentOverrideTest, true);
 
   is(gTestBrowser.docShell.hasMixedDisplayContentLoaded, true, "hasMixedDisplayContentLoaded flag has not been set");
   is(gTestBrowser.docShell.hasMixedActiveContentLoaded, true, "hasMixedActiveContentLoaded flag has not been set");
   is(gTestBrowser.docShell.hasMixedDisplayContentBlocked, false, "second hasMixedDisplayContentBlocked flag has been set");
   is(gTestBrowser.docShell.hasMixedActiveContentBlocked, false, "second hasMixedActiveContentBlocked flag has been set");
 
-  let notification = PopupNotifications.getNotification("bad-content", gTestBrowser);
-  ok(notification, "Mixed Content Doorhanger should appear");
-  notification.reshow();
+  let {gIdentityHandler} = gTestBrowser.ownerGlobal;
 
   // Make sure the notification has the mixedblockdisabled attribute set to true
-  is(PopupNotifications.panel.firstChild.getAttribute("mixedblockdisabled"), "true",
-    "Doorhanger must have [mixedblockdisabled='true'] attribute");
+  gIdentityHandler._identityBox.click();
+  is(gIdentityHandler._identityPopup.getAttribute("secstate"), "active-loaded",
+    "Popup attribute is correct");
+  gIdentityHandler._identityPopup.hidden = true;
 
   gBrowser.removeCurrentTab();
   finish();
 }
